/**
 * ============================================================================
 * 509 DASHBOARD - CONSOLIDATED BUILD
 * ============================================================================
 *
 * This file is AUTO-GENERATED by build.js
 * DO NOT EDIT THIS FILE DIRECTLY
 *
 * To make changes:
 * 1. Edit individual module files (e.g., Constants.gs, Code.gs)
 * 2. Run: node build.js
 * 3. This file will be regenerated automatically
 *
 * Build Info:
 * - Version: 2.1.0 (Security Enhanced + Code Review Improvements)
 * - Build ID: 20251202-improvements
 * - Build Date: 2025-12-06T03:37:13.928Z
 * - Build Type: PRODUCTION
 * - Modules: 60 files
 * - Tests Included: No
 *
 * ============================================================================
 */


// ================================================================================
// MODULE: Constants.gs
// Source: Constants.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * CONSTANTS - Centralized Configuration
 * ------------------------------------------------------------------------====
 *
 * Single source of truth for all constants used throughout the 509 Dashboard.
 * This prevents duplication and makes configuration changes easier.
 *
 * @module Constants
 * @version 2.0.0
 * @author SEIU Local 509 Tech Team
 * ------------------------------------------------------------------------====
 */

/* --------------------= SHEET NAMES --------------------= */

/**
 * Sheet names used throughout the application
 * @const {Object}
 */
const SHEETS = {
  CONFIG: "Config",
  MEMBER_DIR: "Member Directory",
  GRIEVANCE_LOG: "Grievance Log",
  DASHBOARD: "Dashboard",
  ANALYTICS: "Analytics Data",
  FEEDBACK: "Feedback & Development",
  MEMBER_SATISFACTION: "Member Satisfaction",
  INTERACTIVE_DASHBOARD: "üéØ Interactive (Your Custom View)",
  STEWARD_WORKLOAD: "üë®‚Äç‚öñÔ∏è Steward Workload",
  TRENDS: "üìà Trends & Timeline",
  PERFORMANCE: "üéØ Test 2: Performance",
  LOCATION: "üó∫Ô∏è Location Analytics",
  TYPE_ANALYSIS: "üìä Type Analysis",
  EXECUTIVE_DASHBOARD: "üíº Executive Dashboard",
  EXECUTIVE: "üíº Executive Dashboard",  // ALIAS: Intentional duplicate for backward compatibility - keep in sync!
  KPI_PERFORMANCE: "üìä KPI Performance Dashboard",
  KPI_BOARD: "üìä KPI Performance Dashboard",  // ALIAS: Intentional duplicate for backward compatibility - keep in sync!
  MEMBER_ENGAGEMENT: "üë• Member Engagement",
  COST_IMPACT: "üí∞ Cost Impact",
  QUICK_STATS: "‚ö° Quick Stats",
  ARCHIVE: "üì¶ Archive",
  DIAGNOSTICS: "üîß Diagnostics",
  GETTING_STARTED: "üöÄ Getting Started",
  FAQ: "‚ùì FAQ & Help",
  USER_SETTINGS: "‚öôÔ∏è User Settings",

  // Internal system sheets
  USER_ROLES: "User Roles",
  AUDIT_LOG: "Audit Log",
  CHANGE_LOG: "üìù Change Log",
  BACKUP_LOG: "üíæ Backup Log",
  ERROR_LOG: "Error_Log",
  ERROR_TRENDS: "Error_Trends",
  FAQ_DATABASE: "üìö FAQ Database",
  COMMUNICATIONS_LOG: "üìû Communications Log",
  PERFORMANCE_MONITOR: "‚ö° Performance Monitor",
  TEST_RESULTS: "Test Results",
  STATE_CHANGE_LOG: "üîÑ State Change Log",
  CONFIGURATION: "‚öôÔ∏è Configuration",
  ASSIGNMENT_LOG: "üìã Assignment Log"
};

/* --------------------= COLOR SCHEME --------------------= */

/**
 * Color palette for consistent theming
 * @const {Object}
 */
const COLORS = {
  // Primary brand colors
  PRIMARY_BLUE: "#7EC8E3",
  PRIMARY_PURPLE: "#7C3AED",
  UNION_GREEN: "#059669",
  SOLIDARITY_RED: "#DC2626",

  // Accent colors
  ACCENT_TEAL: "#14B8A6",
  ACCENT_PURPLE: "#7C3AED",
  ACCENT_ORANGE: "#F97316",
  ACCENT_YELLOW: "#FCD34D",

  // Neutral colors
  WHITE: "#FFFFFF",
  LIGHT_GRAY: "#F3F4F6",
  BORDER_GRAY: "#D1D5DB",
  TEXT_GRAY: "#6B7280",
  TEXT_DARK: "#1F2937",
  BLACK: "#000000",

  // Specialty colors
  CARD_BG: "#FAFAFA",
  INFO_LIGHT: "#E0E7FF",
  SUCCESS_LIGHT: "#D1FAE5",
  WARNING_LIGHT: "#FEF3C7",
  ERROR_LIGHT: "#FEE2E2",
  HEADER_BLUE: "#3B82F6",
  HEADER_GREEN: "#10B981",

  // Status colors
  STATUS_OPEN: "#DC2626",        // Red
  STATUS_PENDING: "#F97316",     // Orange
  STATUS_SETTLED: "#059669",     // Green
  STATUS_CLOSED: "#6B7280",      // Gray
  STATUS_APPEALED: "#7C3AED"     // Purple
};

/* --------------------= MEMBER DIRECTORY COLUMNS --------------------= */

/**
 * Column positions for Member Directory (1-indexed)
 * Use getColumnLetter() to convert to letter notation
 * @const {Object}
 */
const MEMBER_COLS = {
  // 31 columns total - Reorganized for logical grouping
  // Section 1: Identity & Core Info (A-D)
  MEMBER_ID: 1,                    // A
  FIRST_NAME: 2,                   // B
  LAST_NAME: 3,                    // C
  JOB_TITLE: 4,                    // D
  // Section 2: Location & Work (E-G)
  WORK_LOCATION: 5,                // E
  UNIT: 6,                         // F
  OFFICE_DAYS: 7,                  // G
  // Section 3: Contact Information (H-K)
  EMAIL: 8,                        // H
  PHONE: 9,                        // I
  PREFERRED_COMM: 10,              // J - Multi-select: preferred communication methods
  BEST_TIME: 11,                   // K - Multi-select: best times to reach member
  // Section 4: Organizational Structure (L-P)
  SUPERVISOR: 12,                  // L
  MANAGER: 13,                     // M
  IS_STEWARD: 14,                  // N
  COMMITTEES: 15,                  // O - Multi-select: which committees steward is in
  ASSIGNED_STEWARD: 16,            // P
  // Section 5: Engagement Metrics (Q-T) - Hidden by default
  LAST_VIRTUAL_MTG: 17,            // Q
  LAST_INPERSON_MTG: 18,           // R
  OPEN_RATE: 19,                   // S
  VOLUNTEER_HOURS: 20,             // T
  // Section 6: Member Interests (U-X) - Hidden by default
  INTEREST_LOCAL: 21,              // U
  INTEREST_CHAPTER: 22,            // V
  INTEREST_ALLIED: 23,             // W
  HOME_TOWN: 24,                   // X - Connection building (last in interests section)
  // Section 7: Steward Contact Tracking (Y-AA)
  RECENT_CONTACT_DATE: 25,         // Y
  CONTACT_STEWARD: 26,             // Z
  CONTACT_NOTES: 27,               // AA
  // Section 8: Grievance Management (AB-AE)
  HAS_OPEN_GRIEVANCE: 28,          // AB
  GRIEVANCE_STATUS: 29,            // AC
  NEXT_DEADLINE: 30,               // AD
  START_GRIEVANCE: 31              // AE - Checkbox to start grievance with prepopulated member info
};

/* --------------------= GRIEVANCE LOG COLUMNS --------------------= */

/**
 * Column positions for Grievance Log (1-indexed)
 * Use getColumnLetter() to convert to letter notation
 * @const {Object}
 */
const GRIEVANCE_COLS = {
  // Matches the 28-column layout in createGrievanceLog()
  // Section 1: Identity (A-D)
  GRIEVANCE_ID: 1,        // A - Grievance ID
  MEMBER_ID: 2,           // B - Member ID
  FIRST_NAME: 3,          // C - First Name
  LAST_NAME: 4,           // D - Last Name
  // Section 2: Status & Assignment (E-F)
  STATUS: 5,              // E - Status
  CURRENT_STEP: 6,        // F - Current Step
  // Section 3: Timeline - Filing (G-I)
  INCIDENT_DATE: 7,       // G - Incident Date
  FILING_DEADLINE: 8,     // H - Filing Deadline (21d) (auto-calc)
  DATE_FILED: 9,          // I - Date Filed (Step I)
  // Section 4: Timeline - Step I (J-K)
  STEP1_DUE: 10,          // J - Step I Decision Due (30d) (auto-calc)
  STEP1_RCVD: 11,         // K - Step I Decision Rcvd
  // Section 5: Timeline - Step II (L-O)
  STEP2_APPEAL_DUE: 12,   // L - Step II Appeal Due (10d) (auto-calc)
  STEP2_APPEAL_FILED: 13, // M - Step II Appeal Filed
  STEP2_DUE: 14,          // N - Step II Decision Due (30d) (auto-calc)
  STEP2_RCVD: 15,         // O - Step II Decision Rcvd
  // Section 6: Timeline - Step III (P-R)
  STEP3_APPEAL_DUE: 16,   // P - Step III Appeal Due (30d) (auto-calc)
  STEP3_APPEAL_FILED: 17, // Q - Step III Appeal Filed
  DATE_CLOSED: 18,        // R - Date Closed
  // Section 7: Calculated Metrics (S-U)
  DAYS_OPEN: 19,          // S - Days Open (auto-calc)
  NEXT_ACTION_DUE: 20,    // T - Next Action Due (auto-calc)
  DAYS_TO_DEADLINE: 21,   // U - Days to Deadline (auto-calc)
  // Section 8: Case Details (V-W)
  ARTICLES: 22,           // V - Articles Violated
  ISSUE_CATEGORY: 23,     // W - Issue Category
  // Section 9: Contact & Location (X-AA)
  MEMBER_EMAIL: 24,       // X - Member Email
  UNIT: 25,               // Y - Unit
  LOCATION: 26,           // Z - Work Location (Site)
  STEWARD: 27,            // AA - Assigned Steward (Name)
  // Section 10: Resolution (AB)
  RESOLUTION: 28,         // AB - Resolution Summary
  // Section 11: Coordinator Notifications (AC-AF) - Feature 95
  COORDINATOR_NOTIFIED: 29,  // AC - Checkbox for coordinator message
  COORDINATOR_MESSAGE: 30,   // AD - Coordinator's message text
  ACKNOWLEDGED_BY: 31,       // AE - Steward who acknowledged
  ACKNOWLEDGED_DATE: 32,     // AF - When steward acknowledged
  // Section 12: Drive Integration (AG-AH)
  DRIVE_FOLDER_ID: 33,    // AG - Google Drive folder ID
  DRIVE_FOLDER_URL: 34    // AH - Google Drive folder URL
};

/* --------------------= INTERNAL SYSTEM COLUMN MAPPINGS --------------------= */

/**
 * Column positions for Audit Log sheet (1-indexed)
 * Used by SecurityUtils.gs for security audit tracking
 * @const {Object}
 */
const AUDIT_LOG_COLS = {
  TIMESTAMP: 1,     // A - When the action occurred
  USER_EMAIL: 2,    // B - Who performed the action
  USER_ROLE: 3,     // C - User's role at the time
  ACTION: 4,        // D - What action was performed
  LEVEL: 5,         // E - Severity level (INFO, WARNING, ERROR)
  DETAILS: 6,       // F - Additional details/context
  IP_ADDRESS: 7     // G - User's IP address (if available)
};

/**
 * Column positions for FAQ Database sheet (1-indexed)
 * Used by FAQKnowledgeBase.gs for FAQ management
 * @const {Object}
 */
const FAQ_COLS = {
  ID: 1,              // A - Unique FAQ ID
  CATEGORY: 2,        // B - FAQ category
  QUESTION: 3,        // C - The question
  ANSWER: 4,          // D - The answer
  TAGS: 5,            // E - Searchable tags
  RELATED_FAQS: 6,    // F - Related FAQ IDs
  HELPFUL_COUNT: 7,   // G - Number of helpful votes
  NOT_HELPFUL_COUNT: 8, // H - Number of not helpful votes
  CREATED_DATE: 9,    // I - When FAQ was created
  LAST_UPDATED: 10,   // J - Last modification date
  CREATED_BY: 11      // K - Author email
};

/**
 * Column positions for Error Log sheet (1-indexed)
 * Used by EnhancedErrorHandling.gs for error tracking
 * @const {Object}
 */
const ERROR_LOG_COLS = {
  TIMESTAMP: 1,    // A - When error occurred
  LEVEL: 2,        // B - Error level (INFO, WARNING, ERROR, CRITICAL)
  CATEGORY: 3,     // C - Error category
  MESSAGE: 4,      // D - Error message
  CONTEXT: 5,      // E - Additional context
  STACK_TRACE: 6,  // F - Stack trace (if available)
  USER: 7,         // G - User who encountered error
  RECOVERED: 8     // H - Whether error was auto-recovered
};

/**
 * Column positions for Communications Log sheet (1-indexed)
 * Used by GmailIntegration.gs for email tracking
 * @const {Object}
 */
const COMM_LOG_COLS = {
  TIMESTAMP: 1,      // A - When communication was sent
  TYPE: 2,           // B - Type (email, notification, etc.)
  RECIPIENT: 3,      // C - Recipient email
  SUBJECT: 4,        // D - Subject line
  GRIEVANCE_ID: 5,   // E - Related grievance ID
  STATUS: 6,         // F - Send status (sent, failed, etc.)
  SENT_BY: 7         // G - Who sent the communication
};

/**
 * Column positions for Performance Monitor sheet (1-indexed)
 * Used by PerformanceMonitoring.gs for metrics tracking
 * @const {Object}
 */
const PERF_LOG_COLS = {
  TIMESTAMP: 1,      // A - When metric was recorded
  FUNCTION_NAME: 2,  // B - Function being monitored
  EXECUTION_TIME: 3, // C - Time in milliseconds
  MEMORY_USED: 4,    // D - Memory used (if tracked)
  SUCCESS: 5,        // E - Whether function succeeded
  ERROR_MSG: 6       // F - Error message (if failed)
};

/* --------------------= GRIEVANCE TIMELINE CONSTANTS --------------------= */

/**
 * Timeline rules for grievance deadlines (in days)
 * Based on standard union contract
 * @const {Object}
 */
const GRIEVANCE_TIMELINES = {
  FILING_DEADLINE_DAYS: 21,      // Days after incident to file
  STEP1_DECISION_DAYS: 30,       // Days for Step I decision
  STEP2_APPEAL_DAYS: 10,         // Days to appeal to Step II
  STEP2_DECISION_DAYS: 30,       // Days for Step II decision
  STEP3_APPEAL_DAYS: 30,         // Days to appeal to Step III
  STEP3_DECISION_DAYS: 45,       // Days for Step III decision
  ARBITRATION_FILING_DAYS: 30,   // Days to file for arbitration
  WARNING_THRESHOLD_DAYS: 7      // Show warning when deadline within X days
};

/* --------------------= GRIEVANCE STATUS VALUES --------------------= */

/**
 * Valid grievance status values
 * @const {Array<string>}
 */
const GRIEVANCE_STATUSES = [
  'Open',
  'Pending Info',
  'Settled',
  'Withdrawn',
  'Closed',
  'Appealed',
  'In Arbitration',
  'Denied'
];

/**
 * Valid grievance step values
 * @const {Array<string>}
 */
const GRIEVANCE_STEPS = [
  'Informal',
  'Step I',
  'Step II',
  'Step III',
  'Mediation',
  'Arbitration'
];

/**
 * Valid issue categories
 * @const {Array<string>}
 */
const ISSUE_CATEGORIES = [
  'Discipline',
  'Workload',
  'Scheduling',
  'Pay/Compensation',
  'Discrimination',
  'Safety',
  'Benefits',
  'Harassment',
  'Performance Evaluation',
  'Job Classification',
  'Layoff/Recall',
  'Leave',
  'Other'
];

/* --------------------= CONFIG COLUMN MAPPINGS --------------------= */

/**
 * Column mappings for Config sheet
 * @const {Object}
 */
const CONFIG_COLS = {
  // Employment Info (cols 1-5)
  JOB_TITLES: 1,              // A
  OFFICE_LOCATIONS: 2,        // B
  UNITS: 3,                   // C
  OFFICE_DAYS: 4,             // D
  YES_NO: 5,                  // E
  // Supervision (cols 6-7) - managers only, NOT stewards
  SUPERVISORS: 6,             // F - full name (First Last)
  MANAGERS: 7,                // G - full name (First Last)
  // Steward Info (cols 8-9) - stewards are union reps, not supervisors
  STEWARDS: 8,                // H - steward names
  STEWARD_COMMITTEES: 9,      // I - committees stewards can serve on
  // Grievance Settings (cols 10-14)
  GRIEVANCE_STATUS: 10,       // J
  GRIEVANCE_STEP: 11,         // K
  ISSUE_CATEGORY: 12,         // L
  ARTICLES_VIOLATED: 13,      // M
  COMM_METHODS: 14,           // N
  // Links & Coordinators (cols 15-17)
  GRIEVANCE_COORDINATORS: 15, // O - comma-separated list
  GRIEVANCE_FORM_URL: 16,     // P - URL to grievance intake form
  CONTACT_FORM_URL: 17,       // Q - URL to contact form
  // Notifications (cols 18-20)
  ADMIN_EMAILS: 18,           // R - admin email addresses
  ALERT_DAYS: 19,             // S - days before deadline to alert (e.g., "3, 7, 14")
  NOTIFICATION_RECIPIENTS: 20,// T - default CC for notifications
  // Organization (cols 21-24)
  ORG_NAME: 21,               // U - organization name
  LOCAL_NUMBER: 22,           // V - union local number
  MAIN_ADDRESS: 23,           // W - main office address
  MAIN_PHONE: 24,             // X - main phone number
  // Integration (cols 25-26)
  DRIVE_FOLDER_ID: 25,        // Y - Google Drive root folder ID
  CALENDAR_ID: 26,            // Z - Google Calendar ID
  // Deadlines (cols 27-30)
  FILING_DEADLINE_DAYS: 27,   // AA - days to file grievance (default: 21)
  STEP1_RESPONSE_DAYS: 28,    // AB - days for Step I response (default: 30)
  STEP2_APPEAL_DAYS: 29,      // AC - days to appeal to Step II (default: 10)
  STEP2_RESPONSE_DAYS: 30,    // AD - days for Step II response (default: 30)
  // Multi-select options (cols 31-32)
  BEST_TIMES: 31,             // AE - best times to contact members
  HOME_TOWNS: 32,             // AF - list of home towns in area
  // Contract & Legal References (cols 33-36)
  CONTRACT_ARTICLE_GRIEVANCE: 33, // AG - grievance procedure article (e.g., "Article 23A")
  CONTRACT_ARTICLE_DISCIPLINE: 34,// AH - discipline article (e.g., "Article 12")
  CONTRACT_ARTICLE_WORKLOAD: 35,  // AI - workload article (e.g., "Article 15")
  CONTRACT_NAME: 36,              // AJ - contract name (e.g., "2023-2026 CBA")
  // Org Identity (cols 37-39)
  UNION_PARENT: 37,           // AK - parent union (e.g., "SEIU")
  STATE_REGION: 38,           // AL - state/region (e.g., "Massachusetts")
  ORG_WEBSITE: 39,            // AM - organization website URL
  // Backward compatibility alias
  COMMITTEES: 9               // Alias for STEWARD_COMMITTEES (col I)
};

/* --------------------= ORG DEFAULTS --------------------= */

/**
 * Default organization settings
 * These are fallback values when Config sheet doesn't have the value set.
 * To customize for your organization:
 *   1. Edit these defaults here, OR
 *   2. Set values in the Config sheet (takes precedence)
 *
 * @const {Object}
 */
const ORG_DEFAULTS = {
  // Organization Identity
  ORG_NAME: 'SEIU Local 509',
  LOCAL_NUMBER: '509',
  UNION_PARENT: 'SEIU',
  STATE_REGION: 'Massachusetts',
  ORG_WEBSITE: 'https://www.seiu509.org',

  // Contact Info
  MAIN_ADDRESS: '888 Worcester St, Suite 100, Wellesley, MA 02482',
  MAIN_PHONE: '(617) 924-8509',
  GRIEVANCE_EMAIL: 'grievances@seiu509.org',
  INFO_EMAIL: 'info@seiu509.org',

  // Contract References (update when contract changes)
  CONTRACT_NAME: '2023-2026 Collective Bargaining Agreement',
  CONTRACT_ARTICLE_GRIEVANCE: 'Article 23A',
  CONTRACT_ARTICLE_DISCIPLINE: 'Article 12',
  CONTRACT_ARTICLE_WORKLOAD: 'Article 15',

  // Deadline Defaults (in days)
  FILING_DEADLINE_DAYS: 21,
  STEP1_RESPONSE_DAYS: 30,
  STEP2_APPEAL_DAYS: 10,
  STEP2_RESPONSE_DAYS: 30
};

/* --------------------= CACHE CONFIGURATION --------------------= */

/**
 * Cache configuration for performance optimization
 * @const {Object}
 */
const CACHE_CONFIG = {
  MEMORY_TTL: 300,              // 5 minutes (in seconds)
  PROPERTIES_TTL: 3600,         // 1 hour (in seconds)
  DOCUMENT_TTL: 21600,          // 6 hours (in seconds)
  MAX_CACHE_SIZE_BYTES: 100000, // 100KB max per cache entry
  ENABLED: true                 // Global cache enable/disable
};

/**
 * Cache keys used throughout the application
 * @const {Object}
 */
const CACHE_KEYS = {
  MEMBER_COUNT: 'member_count',
  GRIEVANCE_COUNT: 'grievance_count',
  STEWARD_WORKLOAD: 'steward_workload',
  MEMBER_LIST: 'member_list',
  CONFIG_DATA: 'config_data',
  DASHBOARD_METRICS: 'dashboard_metrics',
  ANALYTICS_DATA: 'analytics_data',
  // Additional keys for data caching layer
  ALL_GRIEVANCES: 'all_grievances',
  ALL_MEMBERS: 'all_members',
  ALL_STEWARDS: 'all_stewards'
};

/* --------------------= ERROR CONFIGURATION --------------------= */

/**
 * Error handling and logging configuration
 * @const {Object}
 */
const ERROR_CONFIG = {
  LOG_SHEET_NAME: 'Error_Log',
  MAX_LOG_ENTRIES: 1000,
  ERROR_LEVELS: {
    INFO: 'INFO',
    WARNING: 'WARNING',
    ERROR: 'ERROR',
    CRITICAL: 'CRITICAL'
  },
  NOTIFICATION_THRESHOLD: 'ERROR',
  AUTO_RECOVERY_ENABLED: true,
  SHOW_USER_ERRORS: true,
  LOG_TO_CONSOLE: true
};

/**
 * Error categories for classification
 * @const {Object}
 */
const ERROR_CATEGORIES = {
  VALIDATION: 'VALIDATION',
  PERMISSION: 'PERMISSION',
  NETWORK: 'NETWORK',
  DATA_INTEGRITY: 'DATA_INTEGRITY',
  USER_INPUT: 'USER_INPUT',
  SYSTEM: 'SYSTEM',
  INTEGRATION: 'INTEGRATION',
  SECURITY: 'SECURITY'
};

/* --------------------= UI CONFIGURATION --------------------= */

/**
 * User interface configuration
 * @const {Object}
 */
const UI_CONFIG = {
  TOAST_DURATION: 3,          // Seconds
  DIALOG_WIDTH: 700,          // Pixels
  DIALOG_HEIGHT: 500,         // Pixels
  MAX_DROPDOWN_ITEMS: 500,    // Max items in dropdown before search
  PAGINATION_SIZE: 100,       // Rows per page
  DEFAULT_THEME: 'light'      // light or dark
};

/* --------------------= EMAIL CONFIGURATION --------------------= */

/**
 * Email configuration
 * @const {Object}
 */
const EMAIL_CONFIG = {
  // Note: FROM_NAME, REPLY_TO, GRIEVANCE_EMAIL now use ORG_DEFAULTS
  // To customize, update ORG_DEFAULTS or Config sheet values
  FROM_NAME: ORG_DEFAULTS.ORG_NAME,
  REPLY_TO: ORG_DEFAULTS.INFO_EMAIL,
  GRIEVANCE_EMAIL: ORG_DEFAULTS.GRIEVANCE_EMAIL,
  MAX_SUBJECT_LENGTH: 200,
  MAX_BODY_LENGTH: 10000,
  ATTACHMENTS_ENABLED: true,
  MAX_ATTACHMENT_SIZE_MB: 25
};

/* --------------------= PERFORMANCE CONFIGURATION --------------------= */

/**
 * Performance and batch operation settings
 * @const {Object}
 */
const PERFORMANCE_CONFIG = {
  BATCH_SIZE: 1000,           // Rows per batch for bulk operations
  MAX_EXECUTION_TIME: 300,    // Max execution time in seconds (5 min)
  LAZY_LOAD_THRESHOLD: 5000,  // Load data lazily after this many rows
  ENABLE_PROFILING: false,    // Performance profiling
  AUTO_FLUSH_ENABLED: true    // Auto SpreadsheetApp.flush()
};

/* --------------------= FEATURE FLAGS --------------------= */

/**
 * Feature flags for enabling/disabling features
 * @const {Object}
 */
const FEATURE_FLAGS = {
  ENABLE_DARK_MODE: true,
  ENABLE_KEYBOARD_SHORTCUTS: true,
  ENABLE_MOBILE_OPTIMIZATION: true,
  ENABLE_PREDICTIVE_ANALYTICS: true,
  ENABLE_AUTO_ASSIGNMENT: true,
  ENABLE_CALENDAR_INTEGRATION: true,
  ENABLE_GMAIL_INTEGRATION: true,
  ENABLE_DRIVE_INTEGRATION: true,
  ENABLE_ADVANCED_SEARCH: true,
  ENABLE_CUSTOM_REPORTS: true,
  ENABLE_DATA_EXPORT: true,
  ENABLE_UNDO_REDO: true,
  ENABLE_ADHD_FEATURES: true
};

/* ===================== ERROR MESSAGES ===================== */

/**
 * Standardized error and notification messages
 * Ensures consistent UX across the application
 * @const {Object}
 */
const ERROR_MESSAGES = {
  // Access and permissions
  ACCESS_DENIED: (operation) => `‚õî Access Denied: ${operation}`,
  INSUFFICIENT_ROLE: (required, current) => `‚õî Insufficient Permissions: ${required} role required (you have ${current})`,

  // Not found errors
  NOT_FOUND: (item) => `‚ùå Not Found: ${item}`,
  SHEET_NOT_FOUND: (sheetName) => `‚ùå Sheet Not Found: ${sheetName}`,
  MEMBER_NOT_FOUND: (memberId) => `‚ùå Member Not Found: ${memberId}`,
  GRIEVANCE_NOT_FOUND: (grievanceId) => `‚ùå Grievance Not Found: ${grievanceId}`,

  // Validation errors
  INVALID_INPUT: (field) => `‚ö†Ô∏è Invalid Input: ${field}`,
  INVALID_EMAIL: 'Invalid email address format',
  INVALID_PHONE: 'Invalid phone number format',
  INVALID_DATE: 'Invalid date format',
  REQUIRED_FIELD: (field) => `‚ö†Ô∏è Required Field: ${field} cannot be empty`,

  // Rate limiting
  RATE_LIMIT: (seconds) => `‚è±Ô∏è Rate Limit Exceeded: Please wait ${seconds} seconds before trying again`,

  // Success messages
  SUCCESS: (action) => `‚úÖ Success: ${action}`,
  CREATED: (item) => `‚úÖ Created: ${item}`,
  UPDATED: (item) => `‚úÖ Updated: ${item}`,
  DELETED: (item) => `‚úÖ Deleted: ${item}`,

  // Progress messages
  IN_PROGRESS: (action) => `‚è≥ ${action}...`,
  LOADING: (item) => `‚è≥ Loading ${item}...`,
  PROCESSING: (item) => `‚è≥ Processing ${item}...`,

  // Warnings
  WARNING: (message) => `‚ö†Ô∏è Warning: ${message}`,
  DATA_LOSS_WARNING: 'This action cannot be undone. Are you sure?',

  // System errors
  SYSTEM_ERROR: 'An unexpected error occurred. Please try again.',
  NETWORK_ERROR: 'Network error. Please check your connection.',
  TIMEOUT_ERROR: 'Operation timed out. Please try again.',

  // Data integrity
  DATA_INTEGRITY_ERROR: 'Data integrity check failed',
  DUPLICATE_ENTRY: (field) => `‚ö†Ô∏è Duplicate Entry: ${field} already exists`,

  // Operation errors
  OPERATION_FAILED: (operation, reason) => `‚ùå Operation Failed: ${operation} - ${reason}`,
  NO_DATA_FOUND: (dataType) => `‚ùå No ${dataType} found`
};

/* ===================== ADMIN CONFIGURATION ===================== */

/**
 * Admin email configuration
 * Note: For security, admin emails should also be configured in the Config sheet.
 * These are fallback defaults if Config sheet is not set up yet.
 * @const {Object}
 */
const ADMIN_CONFIG = {
  // Column position in Config sheet for admin emails
  CONFIG_COLUMN: 19, // Column S - Admin Emails

  // Fallback admin emails (used only if Config sheet not available)
  FALLBACK_ADMINS: [
    'admin@seiu509.org',
    'president@seiu509.org',
    'techsupport@seiu509.org'
  ],

  // Admin permissions
  CAN_MODIFY_CONFIG: true,
  CAN_VIEW_AUDIT_LOG: true,
  CAN_RUN_SECURITY_AUDIT: true,
  CAN_MANAGE_USERS: true,
  CAN_DELETE_DATA: true,
  CAN_EXPORT_DATA: true
};

/* ===================== AUDIT LOG CONFIGURATION ===================== */

/**
 * Audit log settings and constants
 * @const {Object}
 */
const AUDIT_LOG_CONFIG = {
  MAX_ENTRIES: 10000,          // Maximum number of audit log entries to keep
  HEADER_ROWS: 1,              // Number of header rows in audit log
  AUTO_TRIM_ENABLED: true,     // Automatically trim old entries when limit reached
  RETENTION_DAYS: 365,         // Days to retain audit entries
  LOG_SHEET_NAME: 'üîí Audit Log'
};

/* ===================== MAGIC NUMBER REPLACEMENTS ===================== */

/**
 * Named constants for commonly used numeric values
 * Replaces "magic numbers" throughout the codebase for clarity
 * @const {Object}
 */
const NUMERIC_CONSTANTS = {
  // Cache TTL (Time To Live) in seconds
  CACHE_TTL_SHORT: 300,        // 5 minutes
  CACHE_TTL_MEDIUM: 3600,      // 1 hour
  CACHE_TTL_LONG: 21600,       // 6 hours
  CACHE_TTL_VERY_LONG: 86400,  // 24 hours

  // Performance thresholds in milliseconds
  SLOW_OPERATION_MS: 60000,    // 1 minute
  VERY_SLOW_MS: 120000,        // 2 minutes
  MAX_EXECUTION_TIME_MS: 300000, // 5 minutes (Apps Script limit: 6 minutes)

  // Data limits
  MAX_BATCH_SIZE: 1000,        // Maximum rows per batch operation
  MAX_SEARCH_RESULTS: 100,     // Maximum search results to display at once
  LAZY_LOAD_THRESHOLD: 5000,   // Start lazy loading after this many rows

  // Time intervals in milliseconds
  DEBOUNCE_DELAY_MS: 300,      // Debounce delay for search/input
  TOAST_DURATION_SHORT: 2,     // Short toast notification (seconds)
  TOAST_DURATION_MEDIUM: 5,    // Medium toast notification (seconds)
  TOAST_DURATION_LONG: 10,     // Long toast notification (seconds)

  // Archive settings
  ARCHIVE_AFTER_YEARS: 2,      // Archive grievances closed for 2+ years
  ARCHIVE_BATCH_SIZE: 500,     // Archive in batches of 500

  // Pagination
  ITEMS_PER_PAGE: 100,         // Items to display per page
  MAX_PAGES_TO_SHOW: 10        // Maximum page numbers to show in pagination
};

/* ===================== VERSION INFORMATION ===================== */

/**
 * Version information
 * @const {Object}
 */
const VERSION_INFO = {
  MAJOR: 2,
  MINOR: 1,
  PATCH: 0,
  BUILD: '20251202-improvements',
  RELEASE_DATE: '2025-12-02',
  CODENAME: 'Security Enhanced + Code Review Improvements'
};

/**
 * Gets version string
 * @returns {string} Version string (e.g., "2.0.0")
 */
function getVersionString() {
  return `${VERSION_INFO.MAJOR}.${VERSION_INFO.MINOR}.${VERSION_INFO.PATCH}`;
}

/**
 * Gets full version info string
 * @returns {string} Full version string with build info
 */
function getFullVersionString() {
  return `v${getVersionString()} (${VERSION_INFO.CODENAME}) - Build ${VERSION_INFO.BUILD}`;
}

/* --------------------= UTILITY FUNCTIONS --------------------= */

/**
 * Converts a column number to letter notation (1=A, 27=AA, etc.)
 * @param {number} columnNumber - Column number (1-indexed)
 * @returns {string} Column letter (A, B, AA, etc.)
 *
 * @example
 * getColumnLetter(1)  // Returns "A"
 * getColumnLetter(27) // Returns "AA"
 */
function getColumnLetter(columnNumber) {
  var letter = '';
  while (columnNumber > 0) {
    const remainder = (columnNumber - 1) % 26;
    letter = String.fromCharCode(65 + remainder) + letter;
    columnNumber = Math.floor((columnNumber - 1) / 26);
  }
  return letter;
}

/**
 * Converts column letter to number (A=1, AA=27, etc.)
 * @param {string} columnLetter - Column letter
 * @returns {number} Column number (1-indexed)
 *
 * @example
 * getColumnNumber('A')  // Returns 1
 * getColumnNumber('AA') // Returns 27
 */
function getColumnNumber(columnLetter) {
  var number = 0;
  for (let i = 0; i < columnLetter.length; i++) {
    number = number * 26 + (columnLetter.charCodeAt(i) - 64);
  }
  return number;
}

/**
 * Gets column letter for a named column in Member Directory
 * @param {string} columnName - Column name from MEMBER_COLS
 * @returns {string} Column letter
 *
 * @example
 * getMemberColumn('EMAIL') // Returns "H"
 */
function getMemberColumn(columnName) {
  if (!MEMBER_COLS[columnName]) {
    throw new Error(`Unknown member column: ${columnName}`);
  }
  return getColumnLetter(MEMBER_COLS[columnName]);
}

/**
 * Gets column letter for a named column in Grievance Log
 * @param {string} columnName - Column name from GRIEVANCE_COLS
 * @returns {string} Column letter
 *
 * @example
 * getGrievanceColumn('STATUS') // Returns "E"
 */
function getGrievanceColumn(columnName) {
  if (!GRIEVANCE_COLS[columnName]) {
    throw new Error(`Unknown grievance column: ${columnName}`);
  }
  return getColumnLetter(GRIEVANCE_COLS[columnName]);
}

/**
 * Validates that all required sheets exist
 * @returns {Object} {valid: boolean, missing: Array<string>}
 */
function validateRequiredSheets() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const requiredSheets = [
    SHEETS.CONFIG,
    SHEETS.MEMBER_DIR,
    SHEETS.GRIEVANCE_LOG,
    SHEETS.DASHBOARD
  ];

  const missing = [];
  requiredSheets.forEach(function(sheetName) {
    if (!ss.getSheetByName(sheetName)) {
      missing.push(sheetName);
    }
  });

  return {
    valid: missing.length === 0,
    missing: missing
  };
}

/* --------------------= INPUT VALIDATION HELPERS --------------------= */

/**
 * Validates that a required parameter is not null/undefined/empty
 * @param {*} value - The value to check
 * @param {string} paramName - Name of the parameter (for error message)
 * @param {string} [functionName] - Name of the calling function
 * @throws {Error} If value is null, undefined, or empty string
 */
function validateRequired(value, paramName, functionName) {
  if (value === null || value === undefined || value === '') {
    const context = functionName ? ` in ${functionName}()` : '';
    throw new Error(`Required parameter '${paramName}' is missing${context}`);
  }
}

/**
 * Validates that a value is a non-empty string
 * @param {*} value - The value to check
 * @param {string} paramName - Name of the parameter
 * @param {string} [functionName] - Name of the calling function
 * @throws {Error} If value is not a string or is empty
 */
function validateString(value, paramName, functionName) {
  validateRequired(value, paramName, functionName);
  if (typeof value !== 'string') {
    const context = functionName ? ` in ${functionName}()` : '';
    throw new Error(`Parameter '${paramName}' must be a string${context}, got ${typeof value}`);
  }
}

/**
 * Validates that a value is a positive integer
 * @param {*} value - The value to check
 * @param {string} paramName - Name of the parameter
 * @param {string} [functionName] - Name of the calling function
 * @throws {Error} If value is not a positive integer
 */
function validatePositiveInt(value, paramName, functionName) {
  validateRequired(value, paramName, functionName);
  if (!Number.isInteger(value) || value < 1) {
    const context = functionName ? ` in ${functionName}()` : '';
    throw new Error(`Parameter '${paramName}' must be a positive integer${context}, got ${value}`);
  }
}

/**
 * Validates that a value is a valid date
 * @param {*} value - The value to check
 * @param {string} paramName - Name of the parameter
 * @param {string} [functionName] - Name of the calling function
 * @throws {Error} If value is not a valid date
 */
function validateDate(value, paramName, functionName) {
  validateRequired(value, paramName, functionName);
  if (!(value instanceof Date) || isNaN(value.getTime())) {
    const context = functionName ? ` in ${functionName}()` : '';
    throw new Error(`Parameter '${paramName}' must be a valid Date${context}`);
  }
}

/**
 * Validates that a value is a non-empty array
 * @param {*} value - The value to check
 * @param {string} paramName - Name of the parameter
 * @param {string} [functionName] - Name of the calling function
 * @throws {Error} If value is not an array or is empty
 */
function validateArray(value, paramName, functionName) {
  validateRequired(value, paramName, functionName);
  if (!Array.isArray(value)) {
    const context = functionName ? ` in ${functionName}()` : '';
    throw new Error(`Parameter '${paramName}' must be an array${context}, got ${typeof value}`);
  }
}

/**
 * Validates a grievance ID format (G-XXXXXX)
 * @param {string} grievanceId - The grievance ID to validate
 * @param {string} [functionName] - Name of the calling function
 * @throws {Error} If grievance ID is invalid
 */
function validateGrievanceId(grievanceId, functionName) {
  validateString(grievanceId, 'grievanceId', functionName);
  if (!/^G-\d{6}$/.test(grievanceId)) {
    const context = functionName ? ` in ${functionName}()` : '';
    throw new Error(`Invalid grievance ID format '${grievanceId}'${context}. Expected format: G-XXXXXX`);
  }
}

/**
 * Validates a member ID format (MXXXXXX)
 * @param {string} memberId - The member ID to validate
 * @param {string} [functionName] - Name of the calling function
 * @throws {Error} If member ID is invalid
 */
function validateMemberId(memberId, functionName) {
  validateString(memberId, 'memberId', functionName);
  if (!/^M\d{6}$/.test(memberId)) {
    const context = functionName ? ` in ${functionName}()` : '';
    throw new Error(`Invalid member ID format '${memberId}'${context}. Expected format: MXXXXXX`);
  }
}

/**
 * Validates an email address format
 * @param {string} email - The email to validate
 * @param {string} [functionName] - Name of the calling function
 * @throws {Error} If email format is invalid
 */
function validateEmail(email, functionName) {
  validateString(email, 'email', functionName);
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    const context = functionName ? ` in ${functionName}()` : '';
    throw new Error(`Invalid email format '${email}'${context}`);
  }
}

/**
 * Validates that a value is one of the allowed values
 * @param {*} value - The value to check
 * @param {Array} allowedValues - Array of allowed values
 * @param {string} paramName - Name of the parameter
 * @param {string} [functionName] - Name of the calling function
 * @throws {Error} If value is not in allowed values
 */
function validateEnum(value, allowedValues, paramName, functionName) {
  validateRequired(value, paramName, functionName);
  if (!allowedValues.includes(value)) {
    const context = functionName ? ` in ${functionName}()` : '';
    throw new Error(`Invalid ${paramName} '${value}'${context}. Allowed values: ${allowedValues.join(', ')}`);
  }
}

/**
 * Creates a validated wrapper for a function that validates parameters
 * @param {Function} fn - The function to wrap
 * @param {Array<Object>} validations - Array of {name, validator, required} objects
 * @returns {Function} Wrapped function with validation
 *
 * @example
 * const safeAddMember = withValidation(addMember, [
 *   { name: 'memberId', validator: validateMemberId, required: true },
 *   { name: 'email', validator: validateEmail, required: true }
 * ]);
 */
function withValidation(fn, validations) {
  return function() {
    const args = Array.prototype.slice.call(arguments);
    validations.forEach(function(v, i) {
      if (v.required || args[i] !== undefined) {
        try {
          v.validator(args[i], v.name, fn.name);
        } catch (e) {
          throw e;
        }
      }
    });
    return fn.apply(this, args);
  };
}

/**
 * Safely executes a function and returns a result object
 * @param {Function} fn - The function to execute
 * @param {Object} [options] - Options for error handling
 * @param {boolean} [options.silent=false] - If true, don't throw on error
 * @param {*} [options.defaultValue=null] - Default value to return on error
 * @param {string} [options.context] - Context string for error logging
 * @returns {Object} {success: boolean, data: *, error: Error|null}
 */
function safeExecute(fn, options) {
  options = options || {};
  const silent = options.silent || false;
  const defaultValue = options.hasOwnProperty('defaultValue') ? options.defaultValue : null;
  const context = options.context || fn.name || 'unknown function';

  try {
    const result = fn();
    return { success: true, data: result, error: null };
  } catch (error) {
    Logger.log(`Error in ${context}: ${error.message}`);
    if (ERROR_CONFIG.LOG_TO_CONSOLE) {
      console.error(`[${context}]`, error);
    }
    if (!silent) {
      throw error;
    }
    return { success: false, data: defaultValue, error: error };
  }
}

/* --------------------= CONFIGURATION REFERENCE --------------------= */

/**
 * CONFIGURATION REFERENCE
 * =======================
 *
 * This section documents where all configuration is located for easy reference.
 * All config should be defined ONCE and only in its designated module.
 *
 * SHEETS, COLORS, COLUMNS (this file - Constants.gs):
 *   - SHEETS: Sheet name constants
 *   - COLORS: Color palette
 *   - MEMBER_COLS: Member Directory column positions
 *   - GRIEVANCE_COLS: Grievance Log column positions
 *   - CONFIG_COLS: Config sheet column positions
 *   - GRIEVANCE_TIMELINES: Timeline rules for grievances
 *   - GRIEVANCE_STATUSES: Valid status values
 *   - GRIEVANCE_STEPS: Valid step values
 *   - ISSUE_CATEGORIES: Valid issue categories
 *
 * CACHE & PERFORMANCE (this file - Constants.gs):
 *   - CACHE_CONFIG: Cache TTL and size limits
 *   - CACHE_KEYS: Cache key constants
 *   - PERFORMANCE_CONFIG: Batch sizes, execution limits
 *
 * UI & EMAIL (this file - Constants.gs):
 *   - UI_CONFIG: Dialog sizes, pagination, theme defaults
 *   - EMAIL_CONFIG: Email settings and limits
 *
 * ERROR HANDLING (this file - Constants.gs):
 *   - ERROR_CONFIG: Error logging configuration
 *   - ERROR_CATEGORIES: Error classification
 *
 * FEATURE FLAGS (this file - Constants.gs):
 *   - FEATURE_FLAGS: Enable/disable features
 *   - VERSION_INFO: Version numbers and build info
 *
 * SECURITY & ROLES (SecurityUtils.gs):
 *   - SECURITY_ROLES: Simple role enum (ADMIN, STEWARD, MEMBER, GUEST)
 *   - ADMIN_EMAILS: List of admin email addresses
 *   - AUDIT_LOG_SHEET: Audit log sheet name
 *   - RATE_LIMITS: Rate limiting configuration
 *
 * ADVANCED ROLES (SecurityService.gs):
 *   - ROLES: Detailed role definitions with permissions
 *     Includes: ADMIN, STEWARD, COORDINATOR, MEMBER, VIEWER
 *     Each role has: name, permissions[], description
 *
 * HOW TO UPDATE CONFIGURATION:
 *   1. Find the constant in the appropriate module above
 *   2. Edit ONLY in that module (never duplicate)
 *   3. Run: node build.js
 *   4. The build will fail if duplicates are detected
 *
 * HOW TO ADD ADMIN USERS:
 *   1. Edit SecurityUtils.gs
 *   2. Add email to ADMIN_EMAILS array
 *   3. Run: node build.js
 *
 * @see SecurityUtils.gs for role/permission functions
 * @see SecurityService.gs for advanced RBAC
 */



// ================================================================================
// MODULE: SecurityUtils.gs
// Source: SecurityUtils.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * SECURITY UTILITIES - Core Security Functions
 * ------------------------------------------------------------------------====
 *
 * Provides essential security functions for the 509 Dashboard:
 * - HTML sanitization to prevent XSS attacks
 * - Role-based access control (RBAC)
 * - Input validation
 * - Audit logging
 * - Email security
 *
 * @module SecurityUtils
 * @version 2.0.0
 * @author SEIU Local 509 Tech Team
 * ------------------------------------------------------------------------====
 */

/* --------------------= CONFIGURATION --------------------= */

/**
 * Role definitions for access control
 * @const {Object}
 */
const SECURITY_ROLES = {
  ADMIN: 'ADMIN',
  STEWARD: 'STEWARD',
  MEMBER: 'MEMBER',
  GUEST: 'GUEST'
};

/**
 * Gets admin email addresses from Config sheet
 * Falls back to ADMIN_CONFIG.FALLBACK_ADMINS if Config sheet not available
 * @returns {string[]} Array of admin email addresses
 */
function getAdminEmails() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const configSheet = ss.getSheetByName(SHEETS.CONFIG);

    if (!configSheet) {
      Logger.log('Config sheet not found, using fallback admin emails');
      return ADMIN_CONFIG.FALLBACK_ADMINS;
    }

    // Read admin emails from Config sheet (Column S, starting from row 2)
    const lastRow = configSheet.getLastRow();
    if (lastRow < 2) {
      return ADMIN_CONFIG.FALLBACK_ADMINS;
    }

    const adminEmailsRange = configSheet.getRange(2, ADMIN_CONFIG.CONFIG_COLUMN, lastRow - 1, 1);
    const adminEmailsData = adminEmailsRange.getValues();

    // Filter out empty rows and validate emails
    const adminEmails = adminEmailsData
      .flat()
      .filter(email => email && typeof email === 'string' && email.trim().length > 0)
      .map(email => email.trim());

    // If no admin emails found in Config, use fallback
    if (adminEmails.length === 0) {
      Logger.log('No admin emails found in Config sheet, using fallback');
      return ADMIN_CONFIG.FALLBACK_ADMINS;
    }

    return adminEmails;

  } catch (error) {
    Logger.log('Error reading admin emails from Config: ' + error.message);
    return ADMIN_CONFIG.FALLBACK_ADMINS;
  }
}

// Audit log configuration moved to Constants.gs (AUDIT_LOG_CONFIG)

/**
 * Rate limiting configuration
 * @const {Object}
 */
const RATE_LIMITS = {
  EMAIL_MIN_INTERVAL: 5000,        // 5 seconds between emails
  API_CALLS_PER_MINUTE: 60,        // Max API calls per minute
  EXPORT_MIN_INTERVAL: 30000,      // 30 seconds between exports
  BULK_OPERATION_MIN_INTERVAL: 60000 // 1 minute between bulk operations
};

/* --------------------= HTML SANITIZATION --------------------= */

/**
 * Sanitizes HTML string to prevent XSS attacks
 * Escapes dangerous characters that could execute scripts
 *
 * @param {string|number|null|undefined} input - Input to sanitize
 * @returns {string} Sanitized safe string
 *
 * @example
 * sanitizeHTML('<script>alert("XSS")</script>')
 * // Returns: '&lt;script&gt;alert(&quot;XSS&quot;)&lt;/script&gt;'
 */
function sanitizeHTML(input) {
  if (input === null || input === undefined) {
    return '';
  }

  return String(input)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;')
    .replace(/\//g, '&#x2F;');
}

/**
 * Sanitizes array of values
 *
 * @param {Array} arr - Array to sanitize
 * @returns {Array} Array with sanitized values
 */
function sanitizeArray(arr) {
  if (!Array.isArray(arr)) {
    return [];
  }
  return arr.map(function(item) { return sanitizeHTML(item); });
}

/**
 * Sanitizes object properties recursively
 *
 * @param {Object} obj - Object to sanitize
 * @returns {Object} Object with sanitized values
 */
function sanitizeObject(obj) {
  if (typeof obj !== 'object' || obj === null) {
    return sanitizeHTML(obj);
  }

  const sanitized = {};
  for (const key in obj) {
    if (obj.hasOwnProperty(key)) {
      if (typeof obj[key] === 'object' && obj[key] !== null) {
        sanitized[key] = sanitizeObject(obj[key]);
      } else {
        sanitized[key] = sanitizeHTML(obj[key]);
      }
    }
  }
  return sanitized;
}

/* --------------------= ACCESS CONTROL --------------------= */

/**
 * Gets the current user's email address
 *
 * @returns {string} User's email address
 */
function getCurrentUserEmail() {
  try {
    return Session.getEffectiveUser().getEmail();
  } catch (e) {
    Logger.log('Error getting user email: ' + e.message);
    return '';
  }
}

/**
 * Checks if current user is an administrator
 * Reads admin emails from Config sheet
 *
 * @returns {boolean} True if user is admin
 */
function isAdmin() {
  const userEmail = getCurrentUserEmail();
  const adminEmails = getAdminEmails();
  return adminEmails.includes(userEmail);
}

/**
 * Checks if current user is a steward
 * Queries Member Directory for Is Steward = "Yes"
 *
 * @returns {boolean} True if user is a steward
 */
function isSteward() {
  const userEmail = getCurrentUserEmail();

  if (!userEmail) {
    return false;
  }

  // Admins are also considered stewards
  if (isAdmin()) {
    return true;
  }

  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

    if (!memberSheet) {
      return false;
    }

    const data = memberSheet.getDataRange().getValues();

    // Check if user's email is in Member Directory with Is Steward = "Yes"
    for (let i = 1; i < data.length; i++) {
      const email = data[i][MEMBER_COLS.EMAIL - 1];
      const isStewardFlag = data[i][MEMBER_COLS.IS_STEWARD - 1];

      if (email === userEmail && isStewardFlag === 'Yes') {
        return true;
      }
    }

    return false;
  } catch (e) {
    Logger.log('Error checking steward status: ' + e.message);
    return false;
  }
}

/**
 * Checks if current user is a registered member
 *
 * @returns {boolean} True if user is in Member Directory
 */
function isMember() {
  const userEmail = getCurrentUserEmail();

  if (!userEmail) {
    return false;
  }

  // Admins and stewards are also members
  if (isAdmin() || isSteward()) {
    return true;
  }

  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

    if (!memberSheet) {
      return false;
    }

    const data = memberSheet.getDataRange().getValues();

    // Check if user's email is in Member Directory
    for (let i = 1; i < data.length; i++) {
      const email = data[i][MEMBER_COLS.EMAIL - 1];

      if (email === userEmail) {
        return true;
      }
    }

    return false;
  } catch (e) {
    Logger.log('Error checking member status: ' + e.message);
    return false;
  }
}

/**
 * Gets the current user's role
 *
 * @returns {string} User's role (ADMIN, STEWARD, MEMBER, or GUEST)
 */
function getUserRole() {
  if (isAdmin()) {
    return SECURITY_ROLES.ADMIN;
  }
  if (isSteward()) {
    return SECURITY_ROLES.STEWARD;
  }
  if (isMember()) {
    return SECURITY_ROLES.MEMBER;
  }
  return SECURITY_ROLES.GUEST;
}

/**
 * Checks if user has required role
 *
 * @param {string} requiredRole - Required role (ADMIN, STEWARD, or MEMBER)
 * @returns {boolean} True if user has required role or higher
 */
function hasRole(requiredRole) {
  const userRole = getUserRole();

  // Role hierarchy: ADMIN > STEWARD > MEMBER > GUEST
  const roleHierarchy = {
    ADMIN: 4,
    STEWARD: 3,
    MEMBER: 2,
    GUEST: 1
  };

  return roleHierarchy[userRole] >= roleHierarchy[requiredRole];
}

/**
 * Enforces role-based access control
 * Throws error if user doesn't have required role
 *
 * @param {string} requiredRole - Required role (ADMIN, STEWARD, or MEMBER)
 * @param {string} operationName - Name of operation for error message
 * @throws {Error} If user doesn't have required role
 *
 * @example
 * requireRole('STEWARD', 'Start Grievance');
 */
function requireRole(requiredRole, operationName) {
  if (!hasRole(requiredRole)) {
    const userRole = getUserRole();
    const errorMsg = `‚õî Access Denied: ${operationName} requires ${requiredRole} role. You have ${userRole} role.`;

    logAuditEvent('ACCESS_DENIED', {
      operation: operationName,
      requiredRole: requiredRole,
      userRole: userRole
    }, 'WARNING');

    throw new Error(errorMsg);
  }
}

/**
 * Shows access denied dialog to user
 *
 * @param {string} operationName - Name of operation
 * @param {string} requiredRole - Required role
 */
function showAccessDeniedDialog(operationName, requiredRole) {
  const ui = SpreadsheetApp.getUi();
  const userRole = getUserRole();

  ui.alert(
    '‚õî Access Denied',
    `${operationName} requires ${requiredRole} privileges.\n\n` +
    `Your current role: ${userRole}\n\n` +
    `Please contact an administrator if you need access.`,
    ui.ButtonSet.OK
  );
}

/* --------------------= INPUT VALIDATION --------------------= */

/**
 * Validates email address format
 *
 * @param {string} email - Email address to validate
 * @returns {boolean} True if valid email format
 */
function isValidEmail(email) {
  if (!email || typeof email !== 'string') {
    return false;
  }

  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

/**
 * Validates phone number format
 * Accepts formats: (555) 123-4567, 555-123-4567, 5551234567
 *
 * @param {string} phone - Phone number to validate
 * @returns {boolean} True if valid phone format
 */
function isValidPhone(phone) {
  if (!phone || typeof phone !== 'string') {
    return false;
  }

  const phoneRegex = /^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/;
  return phoneRegex.test(phone);
}

/**
 * Validates member ID format
 * Expected format: M000001, M000002, etc.
 *
 * @param {string} memberId - Member ID to validate
 * @returns {boolean} True if valid member ID format
 */
function isValidMemberId(memberId) {
  if (!memberId || typeof memberId !== 'string') {
    return false;
  }

  // Allow M followed by 6 digits, or just digits
  const memberIdRegex = /^M?\d{6}$/;
  return memberIdRegex.test(memberId) && memberId.length <= 20;
}

/**
 * Validates grievance ID format
 * Expected format: G-000001, G-000002, etc.
 *
 * @param {string} grievanceId - Grievance ID to validate
 * @returns {boolean} True if valid grievance ID format
 */
function isValidGrievanceId(grievanceId) {
  if (!grievanceId || typeof grievanceId !== 'string') {
    return false;
  }

  const grievanceIdRegex = /^G-\d{6}$/;
  return grievanceIdRegex.test(grievanceId) && grievanceId.length <= 20;
}

/**
 * Validates date is not in the future (unless allowed)
 *
 * @param {Date} date - Date to validate
 * @param {boolean} allowFuture - Whether to allow future dates
 * @returns {boolean} True if valid date
 */
function isValidDate(date, allowFuture = false) {
  if (!(date instanceof Date) || isNaN(date)) {
    return false;
  }

  if (!allowFuture) {
    const now = new Date();
    return date <= now;
  }

  return true;
}

/**
 * Sanitizes and validates user input
 *
 * @param {string} input - Input to validate
 * @param {string} type - Type of input (email, phone, memberId, text)
 * @param {number} maxLength - Maximum length
 * @returns {Object} {valid: boolean, sanitized: string, error: string}
 */
function validateInput(input, type, maxLength = 255) {
  const result = {
    valid: false,
    sanitized: '',
    error: ''
  };

  // Sanitize first
  const sanitized = sanitizeHTML(input);
  result.sanitized = sanitized;

  // Check length
  if (sanitized.length > maxLength) {
    result.error = `Input exceeds maximum length of ${maxLength} characters`;
    return result;
  }

  // Type-specific validation
  switch (type) {
    case 'email':
      if (!isValidEmail(sanitized)) {
        result.error = 'Invalid email address format';
        return result;
      }
      break;

    case 'phone':
      if (!isValidPhone(sanitized)) {
        result.error = 'Invalid phone number format';
        return result;
      }
      break;

    case 'memberId':
      if (!isValidMemberId(sanitized)) {
        result.error = 'Invalid member ID format';
        return result;
      }
      break;

    case 'grievanceId':
      if (!isValidGrievanceId(sanitized)) {
        result.error = 'Invalid grievance ID format';
        return result;
      }
      break;

    case 'text':
      // Already sanitized, just check it's not empty
      if (!sanitized || sanitized.trim().length === 0) {
        result.error = 'Input cannot be empty';
        return result;
      }
      break;

    default:
      result.error = 'Unknown validation type';
      return result;
  }

  result.valid = true;
  return result;
}

/* --------------------= AUDIT LOGGING --------------------= */

/**
 * Logs security and audit events
 *
 * @param {string} action - Action name (e.g., 'GRIEVANCE_VIEWED', 'EMAIL_SENT')
 * @param {Object} details - Additional details about the action
 * @param {string} level - Log level (INFO, WARNING, ERROR, CRITICAL)
 *
 * @example
 * logAuditEvent('GRIEVANCE_VIEWED', {grievanceId: 'G-001234'}, 'INFO');
 */
function logAuditEvent(action, details = {}, level = 'INFO') {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let auditLog = ss.getSheetByName(AUDIT_LOG_CONFIG.LOG_SHEET_NAME);

    // Create audit log sheet if it doesn't exist
    if (!auditLog) {
      auditLog = ss.insertSheet(AUDIT_LOG_CONFIG.LOG_SHEET_NAME);

      // Set up headers
      auditLog.appendRow([
        'Timestamp',
        'User Email',
        'User Role',
        'Action',
        'Level',
        'Details',
        'IP Address (N/A in Apps Script)'
      ]);

      // Format headers
      const headerRange = auditLog.getRange(1, 1, 1, 7);
      headerRange.setBackground('#1a73e8');
      headerRange.setFontColor('#ffffff');
      headerRange.setFontWeight('bold');

      // Protect sheet (warning only, so admins can still access)
      const protection = auditLog.protect();
      protection.setWarningOnly(true);
      protection.setDescription('Audit log - modifications are tracked');

      // Hide sheet from regular users
      auditLog.hideSheet();
    }

    // Add audit entry
    const userEmail = getCurrentUserEmail() || 'UNKNOWN';
    const userRole = getUserRole();
    const timestamp = new Date();
    const detailsJson = JSON.stringify(details);

    auditLog.appendRow([
      timestamp,
      userEmail,
      userRole,
      action,
      level,
      detailsJson,
      'N/A' // Apps Script doesn't provide IP addresses
    ]);

    // Trim old entries if needed (configured in AUDIT_LOG_CONFIG)
    if (AUDIT_LOG_CONFIG.AUTO_TRIM_ENABLED) {
      const lastRow = auditLog.getLastRow();
      const maxRows = AUDIT_LOG_CONFIG.MAX_ENTRIES + AUDIT_LOG_CONFIG.HEADER_ROWS;

      if (lastRow > maxRows) {
        const rowsToDelete = lastRow - maxRows;
        auditLog.deleteRows(2, rowsToDelete); // Delete from row 2 (after header)
      }
    }

  } catch (e) {
    // Don't let audit logging failures break the app
    Logger.log('Failed to log audit event: ' + e.message);
  }
}

/**
 * Gets recent audit log entries
 *
 * @param {number} limit - Maximum number of entries to return
 * @param {string} action - Filter by action (optional)
 * @returns {Array<Object>} Array of audit log entries
 */
function getAuditLog(limit = 100, action = null) {
  requireRole('ADMIN', 'View Audit Log');

  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const auditLog = ss.getSheetByName(AUDIT_LOG_CONFIG.LOG_SHEET_NAME);

    if (!auditLog) {
      return [];
    }

    const data = auditLog.getDataRange().getValues();
    const headers = data[0];
    const rows = data.slice(1).reverse(); // Most recent first

    const filtered = action ? rows.filter(function(row) { return row[AUDIT_LOG_COLS.ACTION - 1] === action; }) : rows;

    const result = filtered.slice(0, limit).map(function(row) { return {
      timestamp: row[AUDIT_LOG_COLS.TIMESTAMP - 1],
      userEmail: row[AUDIT_LOG_COLS.USER_EMAIL - 1],
      userRole: row[AUDIT_LOG_COLS.USER_ROLE - 1],
      action: row[AUDIT_LOG_COLS.ACTION - 1],
      level: row[AUDIT_LOG_COLS.LEVEL - 1],
      details: row[AUDIT_LOG_COLS.DETAILS - 1],
      ipAddress: row[AUDIT_LOG_COLS.IP_ADDRESS - 1]
    };});

    return result;
  } catch (e) {
    Logger.log('Error getting audit log: ' + e.message);
    return [];
  }
}

/* --------------------= RATE LIMITING --------------------= */

/**
 * Checks if rate limit has been exceeded
 *
 * @param {string} operation - Operation name (e.g., 'EMAIL_SEND', 'EXPORT')
 * @param {number} minInterval - Minimum interval in milliseconds
 * @returns {Object} {allowed: boolean, waitTime: number}
 */
function checkRateLimit(operation, minInterval) {
  const props = PropertiesService.getUserProperties();
  const key = `RATE_LIMIT_${operation}`;
  const lastTime = props.getProperty(key);

  if (!lastTime) {
    return { allowed: true, waitTime: 0 };
  }

  const now = new Date().getTime();
  const elapsed = now - parseInt(lastTime);

  if (elapsed < minInterval) {
    const waitTime = minInterval - elapsed;
    return { allowed: false, waitTime: waitTime };
  }

  return { allowed: true, waitTime: 0 };
}

/**
 * Updates rate limit timestamp
 *
 * @param {string} operation - Operation name
 */
function updateRateLimit(operation) {
  const props = PropertiesService.getUserProperties();
  const key = `RATE_LIMIT_${operation}`;
  const now = new Date().getTime();
  props.setProperty(key, now.toString());
}

/**
 * Enforces rate limit for operation
 *
 * @param {string} operation - Operation name
 * @param {number} minInterval - Minimum interval in milliseconds
 * @throws {Error} If rate limit exceeded
 */
function enforceRateLimit(operation, minInterval) {
  const rateCheck = checkRateLimit(operation, minInterval);

  if (!rateCheck.allowed) {
    const waitSeconds = Math.ceil(rateCheck.waitTime / 1000);
    throw new Error(
      `‚è±Ô∏è Rate limit exceeded. Please wait ${waitSeconds} seconds before trying again.`
    );
  }

  updateRateLimit(operation);
}

/* --------------------= EMAIL SECURITY --------------------= */

/**
 * Validates email recipient is a registered member or steward
 *
 * @param {string} email - Email address to validate
 * @returns {boolean} True if email is in Member Directory
 */
function isRegisteredEmail(email) {
  if (!isValidEmail(email)) {
    return false;
  }

  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

    if (!memberSheet) {
      return false;
    }

    const data = memberSheet.getDataRange().getValues();

    for (let i = 1; i < data.length; i++) {
      const memberEmail = data[i][MEMBER_COLS.EMAIL - 1];
      if (memberEmail === email) {
        return true;
      }
    }

    return false;
  } catch (e) {
    Logger.log('Error checking registered email: ' + e.message);
    return false;
  }
}

/**
 * Gets list of all registered member emails
 *
 * @returns {string[]} Array of email addresses
 */
function getAllMemberEmails() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

    if (!memberSheet) {
      return [];
    }

    const data = memberSheet.getDataRange().getValues();
    const emails = [];

    for (let i = 1; i < data.length; i++) {
      const email = data[i][MEMBER_COLS.EMAIL - 1];
      if (email && isValidEmail(email)) {
        emails.push(email);
      }
    }

    return emails;
  } catch (e) {
    Logger.log('Error getting member emails: ' + e.message);
    return [];
  }
}

/* --------------------= SECURITY AUDIT --------------------= */

/**
 * Runs security audit and returns report
 * Only accessible by admins
 *
 * @returns {Object} Security audit report
 */
function runSecurityAudit() {
  requireRole('ADMIN', 'Run Security Audit');

  const report = {
    timestamp: new Date(),
    auditedBy: getCurrentUserEmail(),
    results: {
      totalUsers: 0,
      adminCount: 0,
      stewardCount: 0,
      memberCount: 0,
      recentAccessDenied: 0,
      recentEmailsSent: 0,
      auditLogSize: 0
    },
    recommendations: []
  };

  // Count users by role
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (memberSheet) {
    const data = memberSheet.getDataRange().getValues();
    report.results.totalUsers = data.length - 1; // Exclude header

    for (let i = 1; i < data.length; i++) {
      const email = data[i][MEMBER_COLS.EMAIL - 1];
      const isStewardFlag = data[i][MEMBER_COLS.IS_STEWARD - 1];

      if (getAdminEmails().includes(email)) {
        report.results.adminCount++;
      } else if (isStewardFlag === 'Yes') {
        report.results.stewardCount++;
      } else {
        report.results.memberCount++;
      }
    }
  }

  // Get recent security events
  const auditLog = ss.getSheetByName(AUDIT_LOG_CONFIG.LOG_SHEET_NAME);
  if (auditLog) {
    const data = auditLog.getDataRange().getValues();
    report.results.auditLogSize = data.length - 1;

    // Count recent events (last 7 days)
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);

    for (let i = 1; i < data.length; i++) {
      const timestamp = data[i][AUDIT_LOG_COLS.TIMESTAMP - 1];
      const action = data[i][AUDIT_LOG_COLS.ACTION - 1];

      if (timestamp >= weekAgo) {
        if (action === 'ACCESS_DENIED') {
          report.results.recentAccessDenied++;
        } else if (action === 'EMAIL_SENT') {
          report.results.recentEmailsSent++;
        }
      }
    }
  }

  // Generate recommendations
  if (report.results.adminCount === 0) {
    report.recommendations.push('‚ö†Ô∏è No admins configured. Add admin emails to ADMIN_EMAILS constant.');
  }

  if (report.results.stewardCount === 0) {
    report.recommendations.push('‚ö†Ô∏è No stewards found. Ensure Member Directory has Is Steward = "Yes" for stewards.');
  }

  if (report.results.recentAccessDenied > 10) {
    report.recommendations.push('‚ö†Ô∏è High number of access denied events. Review user roles and permissions.');
  }

  if (report.results.auditLogSize > AUDIT_LOG_CONFIG.MAX_ENTRIES * 0.9) {
    report.recommendations.push(`‚ÑπÔ∏è Audit log approaching limit (${AUDIT_LOG_CONFIG.MAX_ENTRIES} entries). Old entries will be auto-deleted.`);
  }

  logAuditEvent('SECURITY_AUDIT', report.results, 'INFO');

  return report;
}

/**
 * Shows security audit report to admin
 */
function showSecurityAudit() {
  try {
    const report = runSecurityAudit();
    const ui = SpreadsheetApp.getUi();

    let message = 'üîí SECURITY AUDIT REPORT\n\n';
    message += `Total Users: ${report.results.totalUsers}\n`;
    message += `Admins: ${report.results.adminCount}\n`;
    message += `Stewards: ${report.results.stewardCount}\n`;
    message += `Members: ${report.results.memberCount}\n\n`;
    message += `Recent Events (7 days):\n`;
    message += `- Access Denied: ${report.results.recentAccessDenied}\n`;
    message += `- Emails Sent: ${report.results.recentEmailsSent}\n\n`;
    message += `Audit Log Entries: ${report.results.auditLogSize}\n\n`;

    if (report.recommendations.length > 0) {
      message += 'RECOMMENDATIONS:\n';
      report.recommendations.forEach(function(rec) {
        message += `${rec}\n`;
      });
    } else {
      message += '‚úÖ No security issues detected.';
    }

    ui.alert('Security Audit Report', message, ui.ButtonSet.OK);

  } catch (e) {
    SpreadsheetApp.getUi().alert('Error', 'Security audit failed: ' + e.message, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}



// ================================================================================
// MODULE: HTMLTemplates.gs
// Source: HTMLTemplates.gs
// ================================================================================

/**
 * ============================================================================
 * HTML TEMPLATES - Reusable HTML Generation Helpers
 * ============================================================================
 *
 * Provides functions to generate HTML components consistently across the app.
 * Refactors long HTML string generation into smaller, testable functions.
 *
 * @module HTMLTemplates
 * @version 2.1.0
 * ============================================================================
 */

/**
 * Creates a complete HTML page with consistent structure
 *
 * @param {string} title - Page title
 * @param {string} styles - CSS styles (without <style> tags)
 * @param {string} body - HTML body content
 * @param {string} scripts - JavaScript code (without <script> tags)
 * @returns {string} Complete HTML page
 */
function createHTMLPage(title, styles, body, scripts = '') {
  return `<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${sanitizeHTML(title)}</title>
  <style>${styles}</style>
</head>
<body>
  ${body}
  ${scripts ? `<script>${scripts}</script>` : ''}
</body>
</html>`;
}

/**
 * Common CSS styles for dialogs
 * @returns {string} CSS styles
 */
function getCommonDialogStyles() {
  return `
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-width: 100%;
    }
    h2 {
      color: #1a73e8;
      margin-top: 0;
      border-bottom: 3px solid #1a73e8;
      padding-bottom: 10px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 8px;
      color: #333;
    }
    select, input, textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: #1a73e8;
    }
    .info-box {
      background: #e8f0fe;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
      border-left: 4px solid #1a73e8;
    }
    .warning-box {
      background: #fff3cd;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
      border-left: 4px solid #ffc107;
    }
    .error-box {
      background: #f8d7da;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
      border-left: 4px solid #dc3545;
    }
    .success-box {
      background: #d4edda;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
      border-left: 4px solid #28a745;
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 25px;
    }
    button {
      flex: 1;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-primary {
      background: #1a73e8;
      color: white;
    }
    .btn-primary:hover {
      background: #1557b0;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(26,115,232,0.4);
    }
    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .btn-secondary {
      background: #f1f3f4;
      color: #333;
    }
    .btn-secondary:hover {
      background: #e8eaed;
    }
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    .btn-danger:hover {
      background: #c82333;
    }
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: #1a73e8;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #1a73e8;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      .container {
        padding: 15px;
      }
      .button-group {
        flex-direction: column;
      }
      button {
        width: 100%;
      }
    }

    /* Touch-friendly on mobile */
    @media (hover: none) and (pointer: coarse) {
      button, select, input {
        min-height: 44px;
        font-size: 16px;
      }
    }
  `;
}

/**
 * Creates an info box component
 *
 * @param {string} title - Box title
 * @param {string} content - Box content
 * @param {string} type - Box type: 'info', 'warning', 'error', 'success'
 * @returns {string} HTML for info box
 */
function createInfoBox(title, content, type = 'info') {
  const icons = {
    info: '‚ÑπÔ∏è',
    warning: '‚ö†Ô∏è',
    error: '‚ùå',
    success: '‚úÖ'
  };

  const icon = icons[type] || icons.info;

  return `
    <div class="${type}-box">
      <strong>${icon} ${sanitizeHTML(title)}</strong><br>
      ${sanitizeHTML(content)}
    </div>
  `;
}

/**
 * Creates a loading spinner component
 *
 * @param {string} message - Loading message
 * @param {string} id - Element ID (default: 'loading')
 * @returns {string} HTML for loading spinner
 */
function createLoadingSpinner(message = 'Loading...', id = 'loading') {
  return `
    <div class="loading" id="${sanitizeHTML(id)}">
      <div class="spinner"></div>
      <p>${sanitizeHTML(message)}</p>
    </div>
  `;
}

/**
 * Creates button HTML
 *
 * @param {string} text - Button text
 * @param {string} onClick - JavaScript onClick handler
 * @param {string} type - Button type: 'primary', 'secondary', 'danger'
 * @param {boolean} disabled - Whether button is disabled
 * @returns {string} HTML for button
 */
function createButton(text, onClick, type = 'primary', disabled = false) {
  return `
    <button
      class="btn-${type}"
      onclick="${sanitizeHTML(onClick)}"
      ${disabled ? 'disabled' : ''}
    >
      ${sanitizeHTML(text)}
    </button>
  `;
}

/**
 * Creates a form group (label + input/select)
 *
 * @param {string} label - Form label
 * @param {string} inputHTML - Input element HTML
 * @param {string} helpText - Optional help text
 * @returns {string} HTML for form group
 */
function createFormGroup(label, inputHTML, helpText = '') {
  return `
    <div class="form-group">
      <label>${sanitizeHTML(label)}</label>
      ${inputHTML}
      ${helpText ? `<small style="color: #666;">${sanitizeHTML(helpText)}</small>` : ''}
    </div>
  `;
}

/**
 * Creates a select dropdown
 *
 * @param {string} id - Select ID
 * @param {Array<Object>} options - Array of {value, text} objects
 * @param {string} onChange - onChange handler (optional)
 * @returns {string} HTML for select element
 */
function createSelect(id, options, onChange = '') {
  const optionsHTML = options.map(opt =>
    `<option value="${sanitizeHTML(opt.value)}">${sanitizeHTML(opt.text)}</option>`
  ).join('');

  return `
    <select id="${sanitizeHTML(id)}" ${onChange ? `onchange="${sanitizeHTML(onChange)}"` : ''}>
      ${optionsHTML}
    </select>
  `;
}

/**
 * Creates a text input
 *
 * @param {string} id - Input ID
 * @param {string} placeholder - Placeholder text
 * @param {string} type - Input type (text, email, phone, etc.)
 * @returns {string} HTML for input element
 */
function createInput(id, placeholder = '', type = 'text') {
  return `
    <input
      type="${sanitizeHTML(type)}"
      id="${sanitizeHTML(id)}"
      placeholder="${sanitizeHTML(placeholder)}"
    >
  `;
}

/**
 * Creates a textarea
 *
 * @param {string} id - Textarea ID
 * @param {string} placeholder - Placeholder text
 * @param {number} rows - Number of rows
 * @returns {string} HTML for textarea element
 */
function createTextarea(id, placeholder = '', rows = 4) {
  return `
    <textarea
      id="${sanitizeHTML(id)}"
      placeholder="${sanitizeHTML(placeholder)}"
      rows="${rows}"
    ></textarea>
  `;
}

/**
 * Creates a table
 *
 * @param {Array<string>} headers - Table headers
 * @param {Array<Array<string>>} rows - Table rows
 * @param {string} className - Optional CSS class
 * @returns {string} HTML for table
 */
function createTable(headers, rows, className = '') {
  const headerHTML = headers.map(h => `<th>${sanitizeHTML(h)}</th>`).join('');

  const rowsHTML = rows.map(row => {
    const cells = row.map(cell => `<td>${sanitizeHTML(cell)}</td>`).join('');
    return `<tr>${cells}</tr>`;
  }).join('');

  return `
    <table ${className ? `class="${sanitizeHTML(className)}"` : ''}>
      <thead><tr>${headerHTML}</tr></thead>
      <tbody>${rowsHTML}</tbody>
    </table>
  `;
}

/**
 * Creates a modal dialog
 *
 * @param {string} id - Modal ID
 * @param {string} title - Modal title
 * @param {string} content - Modal content
 * @returns {string} HTML for modal
 */
function createModal(id, title, content) {
  return `
    <div id="${sanitizeHTML(id)}" class="modal" style="display:none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>${sanitizeHTML(title)}</h3>
          <span class="modal-close" onclick="document.getElementById('${sanitizeHTML(id)}').style.display='none'">&times;</span>
        </div>
        <div class="modal-body">
          ${content}
        </div>
      </div>
    </div>
    <style>
      .modal {
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
      }
      .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 20px;
        border-radius: 8px;
        width: 80%;
        max-width: 600px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 2px solid #1a73e8;
        padding-bottom: 10px;
      }
      .modal-close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }
      .modal-close:hover {
        color: #000;
      }
    </style>
  `;
}



// ================================================================================
// MODULE: I18n.gs
// Source: I18n.gs
// ================================================================================

/**
 * ============================================================================
 * INTERNATIONALIZATION (I18N) - Multi-Language Support
 * ============================================================================
 *
 * Provides translation support for Spanish and other languages.
 * Enables the dashboard to serve Spanish-speaking union members.
 *
 * @module I18n
 * @version 2.1.0
 * ============================================================================
 */

/**
 * Supported languages
 * @const {Object}
 */
const SUPPORTED_LANGUAGES = {
  EN: 'en',  // English
  ES: 'es'   // Spanish (Espa√±ol)
};

/**
 * Translation strings
 * @const {Object}
 */
const TRANSLATIONS = {
  en: {
    // Dashboard
    DASHBOARD_TITLE: 'üìä LOCAL 509 DASHBOARD',
    MEMBER_METRICS: 'üë• MEMBER METRICS',
    GRIEVANCE_METRICS: 'üìã GRIEVANCE METRICS',
    LAST_UPDATED: 'Last Updated',

    // Member metrics
    TOTAL_MEMBERS: 'Total Members',
    ACTIVE_STEWARDS: 'Active Stewards',
    AVG_OPEN_RATE: 'Avg Open Rate',
    YTD_VOL_HOURS: 'YTD Vol. Hours',

    // Grievance metrics
    OPEN_GRIEVANCES: 'Open Grievances',
    PENDING_INFO: 'Pending Info',
    SETTLED_THIS_MONTH: 'Settled This Month',
    AVG_DAYS_OPEN: 'Avg Days Open',
    UPCOMING_DEADLINES: 'Upcoming Deadlines',

    // Buttons
    START_GRIEVANCE: 'Start Grievance',
    CANCEL: 'Cancel',
    SAVE: 'Save',
    DELETE: 'Delete',
    EXPORT: 'Export',
    REFRESH: 'Refresh',
    SEARCH: 'Search',
    SUBMIT: 'Submit',

    // Status
    OPEN: 'Open',
    CLOSED: 'Closed',
    PENDING: 'Pending Info',
    SETTLED: 'Settled',
    WITHDRAWN: 'Withdrawn',
    APPEALED: 'Appealed',

    // Forms
    MEMBER_ID: 'Member ID',
    FIRST_NAME: 'First Name',
    LAST_NAME: 'Last Name',
    EMAIL: 'Email Address',
    PHONE: 'Phone Number',
    JOB_TITLE: 'Job Title',
    LOCATION: 'Work Location',
    UNIT: 'Unit',

    // Messages
    SUCCESS: 'Success',
    ERROR: 'Error',
    WARNING: 'Warning',
    INFO: 'Information',
    LOADING: 'Loading...',
    PROCESSING: 'Processing...',
    PLEASE_WAIT: 'Please wait...',

    // Common phrases
    YES: 'Yes',
    NO: 'No',
    SELECT: 'Select',
    PLEASE_SELECT: '-- Please Select --',
    REQUIRED: 'Required',
    OPTIONAL: 'Optional',
    ALL: 'All',
    NONE: 'None'
  },

  es: {
    // Dashboard
    DASHBOARD_TITLE: 'üìä PANEL LOCAL 509',
    MEMBER_METRICS: 'üë• M√âTRICAS DE MIEMBROS',
    GRIEVANCE_METRICS: 'üìã M√âTRICAS DE QUEJAS',
    LAST_UPDATED: '√öltima Actualizaci√≥n',

    // Member metrics
    TOTAL_MEMBERS: 'Total de Miembros',
    ACTIVE_STEWARDS: 'Delegados Activos',
    AVG_OPEN_RATE: 'Tasa de Apertura Promedio',
    YTD_VOL_HOURS: 'Horas de Voluntariado del A√±o',

    // Grievance metrics
    OPEN_GRIEVANCES: 'Quejas Abiertas',
    PENDING_INFO: 'Informaci√≥n Pendiente',
    SETTLED_THIS_MONTH: 'Resueltas Este Mes',
    AVG_DAYS_OPEN: 'D√≠as Abiertos Promedio',
    UPCOMING_DEADLINES: 'Fechas L√≠mite Pr√≥ximas',

    // Buttons
    START_GRIEVANCE: 'Iniciar Queja',
    CANCEL: 'Cancelar',
    SAVE: 'Guardar',
    DELETE: 'Eliminar',
    EXPORT: 'Exportar',
    REFRESH: 'Actualizar',
    SEARCH: 'Buscar',
    SUBMIT: 'Enviar',

    // Status
    OPEN: 'Abierta',
    CLOSED: 'Cerrada',
    PENDING: 'Informaci√≥n Pendiente',
    SETTLED: 'Resuelta',
    WITHDRAWN: 'Retirada',
    APPEALED: 'Apelada',

    // Forms
    MEMBER_ID: 'ID del Miembro',
    FIRST_NAME: 'Nombre',
    LAST_NAME: 'Apellido',
    EMAIL: 'Correo Electr√≥nico',
    PHONE: 'N√∫mero de Tel√©fono',
    JOB_TITLE: 'T√≠tulo del Trabajo',
    LOCATION: 'Ubicaci√≥n de Trabajo',
    UNIT: 'Unidad',

    // Messages
    SUCCESS: '√âxito',
    ERROR: 'Error',
    WARNING: 'Advertencia',
    INFO: 'Informaci√≥n',
    LOADING: 'Cargando...',
    PROCESSING: 'Procesando...',
    PLEASE_WAIT: 'Por favor espere...',

    // Common phrases
    YES: 'S√≠',
    NO: 'No',
    SELECT: 'Seleccionar',
    PLEASE_SELECT: '-- Por Favor Seleccione --',
    REQUIRED: 'Requerido',
    OPTIONAL: 'Opcional',
    ALL: 'Todos',
    NONE: 'Ninguno'
  }
};

/**
 * Gets the current user's preferred language
 * Checks User Settings sheet, falls back to English
 *
 * @returns {string} Language code (en, es, etc.)
 */
function getUserLanguage() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const userSettings = ss.getSheetByName(SHEETS.USER_SETTINGS);

    if (!userSettings) {
      return SUPPORTED_LANGUAGES.EN; // Default to English
    }

    const userEmail = getCurrentUserEmail();
    const data = userSettings.getDataRange().getValues();

    // Find user's language preference
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === userEmail) {
        const language = data[i][1]; // Assuming column B is language
        return language || SUPPORTED_LANGUAGES.EN;
      }
    }

    return SUPPORTED_LANGUAGES.EN;

  } catch (error) {
    Logger.log('Error getting user language: ' + error.message);
    return SUPPORTED_LANGUAGES.EN;
  }
}

/**
 * Sets the user's preferred language
 *
 * @param {string} language - Language code (en, es)
 */
function setUserLanguage(language) {
  if (!Object.values(SUPPORTED_LANGUAGES).includes(language)) {
    throw new Error(`Unsupported language: ${language}`);
  }

  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let userSettings = ss.getSheetByName(SHEETS.USER_SETTINGS);

    if (!userSettings) {
      userSettings = ss.insertSheet(SHEETS.USER_SETTINGS);
      userSettings.appendRow(['User Email', 'Language', 'Last Updated']);
    }

    const userEmail = getCurrentUserEmail();
    const data = userSettings.getDataRange().getValues();
    let rowFound = false;

    // Update existing row
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === userEmail) {
        userSettings.getRange(i + 1, 2).setValue(language);
        userSettings.getRange(i + 1, 3).setValue(new Date());
        rowFound = true;
        break;
      }
    }

    // Add new row if not found
    if (!rowFound) {
      userSettings.appendRow([userEmail, language, new Date()]);
    }

    SpreadsheetApp.flush();

    SpreadsheetApp.getActive().toast(
      language === 'es' ? 'Idioma cambiado a Espa√±ol' : 'Language changed to English',
      'Settings',
      NUMERIC_CONSTANTS.TOAST_DURATION_SHORT
    );

  } catch (error) {
    Logger.log('Error setting user language: ' + error.message);
    throw error;
  }
}

/**
 * Translates a key to the current user's language
 *
 * @param {string} key - Translation key
 * @param {string} locale - Optional language override
 * @returns {string} Translated text
 *
 * @example
 * t('DASHBOARD_TITLE')  // Returns "üìä LOCAL 509 DASHBOARD" or "üìä PANEL LOCAL 509"
 * t('START_GRIEVANCE', 'es')  // Force Spanish
 */
function t(key, locale = null) {
  const language = locale || getUserLanguage();

  if (!TRANSLATIONS[language]) {
    Logger.log(`Language not found: ${language}, using English`);
    return TRANSLATIONS[SUPPORTED_LANGUAGES.EN][key] || key;
  }

  return TRANSLATIONS[language][key] || TRANSLATIONS[SUPPORTED_LANGUAGES.EN][key] || key;
}

/**
 * Shows language selection dialog
 */
function showLanguageSelector() {
  const currentLanguage = getUserLanguage();

  const html = `
    <!DOCTYPE html>
    <html>
    <head>
      <base target="_top">
      <style>
        ${getCommonDialogStyles()}
        .language-option {
          padding: 15px;
          margin: 10px 0;
          border: 2px solid #ddd;
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.3s;
        }
        .language-option:hover {
          border-color: #1a73e8;
          background: #e8f0fe;
        }
        .language-option.selected {
          border-color: #1a73e8;
          background: #e8f0fe;
          font-weight: bold;
        }
        .language-flag {
          font-size: 32px;
          margin-right: 15px;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <h2>üåç Select Language / Seleccionar Idioma</h2>

        <div class="language-option ${currentLanguage === 'en' ? 'selected' : ''}"
             onclick="selectLanguage('en')">
          <span class="language-flag">üá∫üá∏</span>
          <strong>English</strong><br>
          <small>English (United States)</small>
        </div>

        <div class="language-option ${currentLanguage === 'es' ? 'selected' : ''}"
             onclick="selectLanguage('es')">
          <span class="language-flag">üá™üá∏</span>
          <strong>Espa√±ol</strong><br>
          <small>Spanish (Espa√±ol)</small>
        </div>

        ${createInfoBox(
          'Note / Nota',
          'Your language preference will be saved and applied across the dashboard. / ' +
          'Su preferencia de idioma se guardar√° y aplicar√° en todo el panel.',
          'info'
        )}
      </div>

      <script>
        function selectLanguage(lang) {
          google.script.run
            .withSuccessHandler(onLanguageChanged)
            .withFailureHandler(onError)
            .setUserLanguage(lang);
        }

        function onLanguageChanged() {
          alert('‚úÖ Language updated! Please refresh the page to see changes.\\n\\n' +
                '‚úÖ ¬°Idioma actualizado! Actualice la p√°gina para ver los cambios.');
          google.script.host.close();
        }

        function onError(error) {
          alert('‚ùå Error: ' + error.message);
        }
      </script>
    </body>
    </html>
  `;

  SpreadsheetApp.getUi().showModalDialog(
    HtmlService.createHtmlOutput(html).setWidth(500).setHeight(400),
    'Language / Idioma'
  );
}

/**
 * Gets all available languages
 *
 * @returns {Array<Object>} Array of {code, name, nativeName}
 */
function getAvailableLanguages() {
  return [
    {
      code: SUPPORTED_LANGUAGES.EN,
      name: 'English',
      nativeName: 'English',
      flag: 'üá∫üá∏'
    },
    {
      code: SUPPORTED_LANGUAGES.ES,
      name: 'Spanish',
      nativeName: 'Espa√±ol',
      flag: 'üá™üá∏'
    }
  ];
}

/**
 * Translates an entire object's values
 *
 * @param {Object} obj - Object with keys to translate
 * @param {string} locale - Language code
 * @returns {Object} Object with translated values
 */
function translateObject(obj, locale = null) {
  const translated = {};

  for (const key in obj) {
    if (obj.hasOwnProperty(key)) {
      translated[key] = t(obj[key], locale);
    }
  }

  return translated;
}



// ================================================================================
// MODULE: TestConfig.gs
// Source: TestConfig.gs
// ================================================================================

/**
 * ============================================================================
 * TEST CONFIGURATION - Separate Test Environment
 * ============================================================================
 *
 * Configuration for running tests in an isolated test spreadsheet.
 * Prevents test data from polluting production data.
 *
 * @module TestConfig
 * @version 2.1.0
 * ============================================================================
 */

/**
 * Test environment configuration
 * @const {Object}
 */
const TEST_CONFIG = {
  // Test spreadsheet ID
  // To set up:
  // 1. Create a new Google Sheet for testing
  // 2. Copy the spreadsheet ID from the URL
  // 3. Replace the ID below
  TEST_SPREADSHEET_ID: '',  // Replace with actual test spreadsheet ID

  // Use test spreadsheet when running tests
  USE_TEST_SPREADSHEET: true,

  // Auto-clear test data after tests complete
  AUTO_CLEAR_AFTER_TESTS: true,

  // Create fresh test data before each test run
  SEED_TEST_DATA: true,

  // Test data sizes (smaller than production for faster tests)
  TEST_MEMBERS_COUNT: 100,
  TEST_GRIEVANCES_COUNT: 50,

  // Test user emails
  TEST_ADMIN_EMAIL: 'testadmin@seiu509.org',
  TEST_STEWARD_EMAIL: 'teststeward@seiu509.org',
  TEST_MEMBER_EMAIL: 'testmember@seiu509.org',

  // Enable verbose logging during tests
  VERBOSE_LOGGING: true
};

/**
 * Gets the spreadsheet to use for tests
 * Returns test spreadsheet if configured, otherwise active spreadsheet
 *
 * @returns {SpreadsheetApp.Spreadsheet} Test or active spreadsheet
 */
function getTestSpreadsheet() {
  if (TEST_CONFIG.USE_TEST_SPREADSHEET && TEST_CONFIG.TEST_SPREADSHEET_ID) {
    try {
      return SpreadsheetApp.openById(TEST_CONFIG.TEST_SPREADSHEET_ID);
    } catch (error) {
      Logger.log('ERROR: Cannot open test spreadsheet: ' + error.message);
      Logger.log('Falling back to active spreadsheet');
      return SpreadsheetApp.getActiveSpreadsheet();
    }
  }

  return SpreadsheetApp.getActiveSpreadsheet();
}

/**
 * Sets up test environment
 * Creates all necessary sheets and seeds test data
 */
function setupTestEnvironment() {
  const testSpreadsheet = getTestSpreadsheet();

  Logger.log('Setting up test environment...');

  // Save current active spreadsheet
  const originalSpreadsheet = SpreadsheetApp.getActiveSpreadsheet();

  try {
    // Temporarily set test spreadsheet as active (for functions that use getActive())
    SpreadsheetApp.setActiveSpreadsheet(testSpreadsheet);

    // Create all sheets
    Logger.log('Creating test sheets...');
    CREATE_509_DASHBOARD();

    // Seed test data
    if (TEST_CONFIG.SEED_TEST_DATA) {
      Logger.log('Seeding test data...');
      seedTestData();
    }

    Logger.log('Test environment ready');

  } finally {
    // Restore original active spreadsheet
    SpreadsheetApp.setActiveSpreadsheet(originalSpreadsheet);
  }
}

/**
 * Seeds smaller dataset for testing
 */
function seedTestData() {
  const testSpreadsheet = getTestSpreadsheet();
  const memberSheet = testSpreadsheet.getSheetByName(SHEETS.MEMBER_DIR);
  const grievanceSheet = testSpreadsheet.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!memberSheet || !grievanceSheet) {
    throw new Error('Test sheets not found. Run setupTestEnvironment() first.');
  }

  Logger.log(`Seeding ${TEST_CONFIG.TEST_MEMBERS_COUNT} test members...`);

  // Generate test members (simplified version of SEED_20K_MEMBERS)
  const memberData = [];
  for (let i = 1; i <= TEST_CONFIG.TEST_MEMBERS_COUNT; i++) {
    memberData.push([
      `M${String(i).padStart(6, '0')}`,  // Member ID
      `TestFirst${i}`,                    // First Name
      `TestLast${i}`,                     // Last Name
      'Test Coordinator',                 // Job Title
      'Boston HQ',                        // Location
      'Unit A - Administrative',          // Unit
      'Monday',                           // Office Days
      `test${i}@seiu509.org`,            // Email
      `(555) ${String(i).padStart(3, '0')}-${String(i).padStart(4, '0')}`, // Phone
      i % 10 === 0 ? 'Yes' : 'No',       // Is Steward
      'Test Supervisor',                  // Supervisor
      'Test Manager',                     // Manager
      'Test Steward',                     // Assigned Steward
      new Date(),                         // Last Virtual Mtg
      new Date(),                         // Last In-Person Mtg
      new Date(),                         // Last Survey
      new Date(),                         // Last Email Open
      Math.floor(Math.random() * 100),   // Open Rate
      Math.floor(Math.random() * 50),    // Volunteer Hours
      'Yes',                              // Interest Local
      'Yes',                              // Interest Chapter
      'No',                               // Interest Allied
      new Date(),                         // Timestamp
      'Email',                            // Preferred Comm
      'Anytime',                          // Best Time
      '',                                 // Has Open Grievance (formula)
      '',                                 // Grievance Status (formula)
      '',                                 // Next Deadline (formula)
      '',                                 // Recent Contact Date
      '',                                 // Contact Steward
      ''                                  // Contact Notes
    ]);
  }

  memberSheet.getRange(2, 1, memberData.length, 31).setValues(memberData);
  SpreadsheetApp.flush();

  Logger.log(`Seeding ${TEST_CONFIG.TEST_GRIEVANCES_COUNT} test grievances...`);

  // Generate test grievances
  const grievanceData = [];
  for (let i = 1; i <= TEST_CONFIG.TEST_GRIEVANCES_COUNT; i++) {
    const memberId = `M${String(i).padStart(6, '0')}`;
    const incidentDate = new Date();
    incidentDate.setDate(incidentDate.getDate() - Math.floor(Math.random() * 90));

    grievanceData.push([
      `G-${String(i).padStart(6, '0')}`,  // Grievance ID
      memberId,                            // Member ID
      `TestFirst${i}`,                     // First Name
      `TestLast${i}`,                      // Last Name
      'Open',                              // Status
      'Step I',                            // Current Step
      incidentDate,                        // Incident Date
      '',                                  // Filing Deadline (formula)
      new Date(),                          // Date Filed
      '',                                  // Step I Due (formula)
      '',                                  // Step I Rcvd
      '',                                  // Step II Appeal Due (formula)
      '',                                  // Step II Appeal Filed
      '',                                  // Step II Decision Due (formula)
      '',                                  // Step II Decision Rcvd
      '',                                  // Step III Appeal Due (formula)
      '',                                  // Step III Appeal Filed
      '',                                  // Date Closed
      '',                                  // Days Open (formula)
      '',                                  // Next Action Due (formula)
      '',                                  // Days to Deadline (formula)
      'Art. 1 - Recognition',             // Articles Violated
      'Discipline',                        // Issue Category
      `test${i}@seiu509.org`,             // Member Email
      'Unit A - Administrative',           // Unit
      'Boston HQ',                         // Location
      'Test Steward',                      // Steward
      ''                                   // Resolution
    ]);
  }

  grievanceSheet.getRange(2, 1, grievanceData.length, 28).setValues(grievanceData);
  SpreadsheetApp.flush();

  Logger.log('Test data seeded successfully');
}

/**
 * Clears all test data
 */
function clearTestData() {
  const testSpreadsheet = getTestSpreadsheet();

  const sheets = [
    SHEETS.MEMBER_DIR,
    SHEETS.GRIEVANCE_LOG,
    SHEETS.MEMBER_SATISFACTION,
    SHEETS.FEEDBACK
  ];

  sheets.forEach(sheetName => {
    const sheet = testSpreadsheet.getSheetByName(sheetName);
    if (sheet) {
      const lastRow = sheet.getLastRow();
      if (lastRow > 1) {
        // Clear all data except header
        sheet.getRange(2, 1, lastRow - 1, sheet.getMaxColumns()).clearContent();
      }
    }
  });

  Logger.log('Test data cleared');
}

/**
 * Validates test environment is set up correctly
 * @returns {Object} Validation result
 */
function validateTestEnvironment() {
  const result = {
    valid: true,
    errors: [],
    warnings: []
  };

  // Check if test spreadsheet ID is configured
  if (TEST_CONFIG.USE_TEST_SPREADSHEET && !TEST_CONFIG.TEST_SPREADSHEET_ID) {
    result.valid = false;
    result.errors.push('TEST_SPREADSHEET_ID not configured in TestConfig.gs');
  }

  // Check if test spreadsheet is accessible
  if (TEST_CONFIG.TEST_SPREADSHEET_ID) {
    try {
      const testSpreadsheet = SpreadsheetApp.openById(TEST_CONFIG.TEST_SPREADSHEET_ID);
      const requiredSheets = [SHEETS.CONFIG, SHEETS.MEMBER_DIR, SHEETS.GRIEVANCE_LOG];

      requiredSheets.forEach(sheetName => {
        if (!testSpreadsheet.getSheetByName(sheetName)) {
          result.warnings.push(`Sheet "${sheetName}" not found in test spreadsheet`);
        }
      });

    } catch (error) {
      result.valid = false;
      result.errors.push(`Cannot access test spreadsheet: ${error.message}`);
    }
  }

  return result;
}

/**
 * Shows test environment setup dialog
 */
function showTestEnvironmentSetup() {
  const ui = SpreadsheetApp.getUi();

  const validation = validateTestEnvironment();

  let message = 'üß™ TEST ENVIRONMENT SETUP\n\n';

  if (!TEST_CONFIG.TEST_SPREADSHEET_ID) {
    message += '‚ö†Ô∏è No test spreadsheet configured\n\n';
    message += 'To set up a test environment:\n';
    message += '1. Create a new Google Sheet\n';
    message += '2. Copy the spreadsheet ID from the URL\n';
    message += '3. Open TestConfig.gs\n';
    message += '4. Set TEST_SPREADSHEET_ID to your spreadsheet ID\n';
    message += '5. Run this setup again\n';
  } else if (!validation.valid) {
    message += '‚ùå Test Environment Issues:\n\n';
    validation.errors.forEach(err => {
      message += `‚Ä¢ ${err}\n`;
    });
  } else {
    message += '‚úÖ Test environment configured\n\n';
    if (validation.warnings.length > 0) {
      message += 'Warnings:\n';
      validation.warnings.forEach(warn => {
        message += `‚Ä¢ ${warn}\n`;
      });
      message += '\n';
    }
    message += 'Ready to set up test sheets and seed data?';

    const response = ui.alert('Test Environment Setup', message, ui.ButtonSet.YES_NO);

    if (response === ui.Button.YES) {
      setupTestEnvironment();
      ui.alert('‚úÖ Test environment set up successfully!');
      return;
    }
  }

  ui.alert('Test Environment Setup', message, ui.ButtonSet.OK);
}



// ================================================================================
// MODULE: Code.gs
// Source: Code.gs
// ================================================================================

/****************************************************
 * 509 DASHBOARD - MAIN ENTRY POINT
 * All issues addressed, real data only, 20k members + 5k grievances
 ****************************************************
 *
 * IMPORTANT: Configuration constants (SHEETS, COLORS, MEMBER_COLS,
 * GRIEVANCE_COLS) are defined in Constants.gs. Do NOT redefine them here.
 *
 * This file uses constants from:
 * - Constants.gs: SHEETS, COLORS, MEMBER_COLS, GRIEVANCE_COLS, etc.
 * - SecurityUtils.gs: SECURITY_ROLES, ADMIN_EMAILS, etc.
 *
 * @see Constants.gs for all configuration
 ****************************************************/

/* --------------------- ONE-CLICK SETUP --------------------- */
function CREATE_509_DASHBOARD() {
  const ss = SpreadsheetApp.getActive();

  SpreadsheetApp.getActive().toast("üöÄ Creating 509 Dashboard...", "Starting", -1);

  try {
    createConfigTab();
    SpreadsheetApp.getActive().toast("‚úÖ Config created", "10%", 2);

    createMemberDirectory();
    SpreadsheetApp.getActive().toast("‚úÖ Member Directory created", "20%", 2);

    createGrievanceLog();
    SpreadsheetApp.getActive().toast("‚úÖ Grievance Log created", "30%", 2);

    createMainDashboard();
    SpreadsheetApp.getActive().toast("‚úÖ Main Dashboard created", "40%", 2);

    createAnalyticsDataSheet();
    createMemberSatisfactionSheet();
    createFeedbackSheet();
    SpreadsheetApp.getActive().toast("‚úÖ Data sheets created", "50%", 2);

    // Create Interactive Dashboard
    createInteractiveDashboardSheet(ss);
    SpreadsheetApp.getActive().toast("‚úÖ Interactive Dashboard created", "60%", 2);

    // Create Getting Started and FAQ sheets
    Logger.log("Starting createGettingStartedSheet...");
    createGettingStartedSheet(ss);
    Logger.log("Completed createGettingStartedSheet");

    Logger.log("Starting createFAQSheet...");
    createFAQSheet(ss);
    Logger.log("Completed createFAQSheet");
    SpreadsheetApp.getActive().toast("‚úÖ Help sheets created", "70%", 2);

    // Create User Settings sheet
    Logger.log("Starting createUserSettingsSheet...");
    createUserSettingsSheet();
    Logger.log("Completed createUserSettingsSheet");
    SpreadsheetApp.getActive().toast("‚úÖ Settings sheet created", "70%", 2);

    // Create all analytics and test sheets
    Logger.log("Starting createStewardWorkloadSheet...");
    createStewardWorkloadSheet();
    Logger.log("Completed createStewardWorkloadSheet");

    Logger.log("Starting createTrendsSheet...");
    createTrendsSheet();
    Logger.log("Completed createTrendsSheet");

    Logger.log("Starting createLocationSheet...");
    createLocationSheet();
    Logger.log("Completed createLocationSheet");

    Logger.log("Starting createTypeAnalysisSheet...");
    createTypeAnalysisSheet();
    Logger.log("Completed createTypeAnalysisSheet");
    SpreadsheetApp.getActive().toast("‚úÖ Analytics sheets created", "75%", 2);

    Logger.log("Starting createExecutiveDashboard...");
    createExecutiveDashboard();
    Logger.log("Completed createExecutiveDashboard");

    Logger.log("Starting createKPIPerformanceDashboard...");
    createKPIPerformanceDashboard();
    Logger.log("Completed createKPIPerformanceDashboard");

    Logger.log("Starting createMemberEngagementSheet...");
    createMemberEngagementSheet();
    Logger.log("Completed createMemberEngagementSheet");

    Logger.log("Starting createCostImpactSheet...");
    createCostImpactSheet();
    Logger.log("Completed createCostImpactSheet");
    SpreadsheetApp.getActive().toast("‚úÖ Executive sheets created", "80%", 2);

    // Create utility sheets
    Logger.log("Starting createArchiveSheet...");
    createArchiveSheet();
    Logger.log("Completed createArchiveSheet");

    Logger.log("Starting createDiagnosticsSheet...");
    createDiagnosticsSheet();
    Logger.log("Completed createDiagnosticsSheet");
    SpreadsheetApp.getActive().toast("‚úÖ Utility sheets created", "85%", 2);

    // Create Audit Log sheet
    createAuditLogSheet();
    SpreadsheetApp.getActive().toast("‚úÖ Audit Log created", "90%", 2);

    Logger.log("Starting setupDataValidations...");
    setupDataValidations();
    Logger.log("Completed setupDataValidations");

    Logger.log("Starting setupFormulasAndCalculations...");
    setupFormulasAndCalculations();
    Logger.log("Completed setupFormulasAndCalculations");

    Logger.log("Starting setupInteractiveDashboardControls...");
    setupInteractiveDashboardControls();
    Logger.log("Completed setupInteractiveDashboardControls");
    SpreadsheetApp.getActive().toast("‚úÖ Validations & formulas ready", "90%", 2);

    // CRITICAL: Setup all dropdowns for Member Directory and Grievance Log
    Logger.log("Starting setupAllDropdowns...");
    setupAllDropdowns();
    Logger.log("Completed setupAllDropdowns");
    SpreadsheetApp.getActive().toast("‚úÖ Dropdowns configured", "95%", 2);

    onOpen();

    SpreadsheetApp.getActive().toast("‚úÖ Dashboard ready! Use menu to seed data.", "Complete!", 5);

    // Safely activate dashboard sheet if it exists
    const dashboard = ss.getSheetByName(SHEETS.DASHBOARD);
    if (dashboard) {
      dashboard.activate();
    }

  } catch (error) {
    SpreadsheetApp.getActive().toast("‚ùå Error: " + error.toString(), "Error", 10);
    Logger.log("Error in CREATE_509_DASHBOARD: " + error.toString());
  }
}

/* --------------------- CONFIG TAB --------------------- */
function createConfigTab() {
  const ss = SpreadsheetApp.getActive();
  let config = ss.getSheetByName(SHEETS.CONFIG);

  if (!config) {
    config = ss.insertSheet(SHEETS.CONFIG);
  }
  config.clear();

  const configData = [
    // Row 1: Column Headers (32 columns total)
    // Employment Info (1-5)
    ["Job Titles", "Office Locations", "Units", "Office Days", "Yes/No (Dropdowns)",
    // Supervision (6-7) - managers only, NOT stewards
     "Supervisors", "Managers",
    // Steward Info (8-9) - stewards are union reps, separate from management
     "Stewards", "Steward Committees",
    // Grievance Settings (10-14)
     "Grievance Status", "Grievance Step", "Issue Category", "Articles Violated", "Communication Methods",
    // Links & Coordinators (15-17)
     "Grievance Coordinators", "Grievance Form URL", "Contact Form URL",
    // Notifications (18-20)
     "Admin Emails", "Alert Days Before Deadline", "Notification Recipients",
    // Organization (21-24)
     "Organization Name", "Local Number", "Main Office Address", "Main Phone",
    // Integration (25-26)
     "Google Drive Folder ID", "Google Calendar ID",
    // Deadlines (27-30)
     "Filing Deadline Days", "Step I Response Days", "Step II Appeal Days", "Step II Response Days",
    // Multi-select Options (31-32)
     "Best Times to Contact", "Home Towns"],

    // Data rows - first row has default/example values for settings columns
    ["Coordinator", "Boston HQ", "Unit A - Administrative", "Monday", "Yes",
     "Sarah Johnson", "Michael Chen",
     "Jane Smith", "Grievance Committee",
     "Open", "Informal", "Discipline", "Art. 1 - Recognition", "Email",
     "Jane Smith, John Doe, Mary Johnson", "", "",
     "", "3, 7, 14", "",
     "SEIU Local 509", "509", "", "",
     "", "",
     "21", "30", "10", "30",
     "Morning (8am-12pm)", "Boston"],

    ["Analyst", "Worcester Office", "Unit B - Technical", "Tuesday", "No",
     "Mike Wilson", "Lisa Anderson",
     "John Doe", "Bargaining Committee",
     "Pending Info", "Step I", "Workload", "Art. 2 - Union Security", "Phone",
     "Bob Wilson, Alice Brown", "", "",
     "", "", "",
     "", "", "", "",
     "", "",
     "", "", "", "",
     "Afternoon (12pm-5pm)", "Worcester"],

    ["Case Manager", "Springfield Branch", "Unit C - Support Services", "Wednesday", "",
     "Emily Davis", "Robert Brown",
     "Mary Johnson", "Health & Safety Committee",
     "Settled", "Step II", "Scheduling", "Art. 3 - Management Rights", "Text",
     "Sarah Martinez, Kevin Jones", "", "",
     "", "", "",
     "", "", "", "",
     "", "",
     "", "", "", "",
     "Evening (5pm-8pm)", "Springfield"],

    ["Specialist", "Cambridge Office", "Unit D - Operations", "Thursday", "",
     "Tom Harris", "Jennifer Lee",
     "Bob Wilson", "Political Action Committee",
     "Withdrawn", "Step III", "Pay", "Art. 4 - No Discrimination", "In Person",
     "Daniel Kim, Rachel Adams", "", "",
     "", "", "",
     "", "", "", "",
     "", "",
     "", "", "", "",
     "Weekends", "Cambridge"],

    ["Senior Analyst", "Lowell Center", "Unit E - Field Services", "Friday", "",
     "Amanda White", "David Martinez",
     "Alice Brown", "Membership Committee",
     "Closed", "Mediation", "Discrimination", "Art. 5 - Union Business", "",
     "John Doe, Mary Johnson", "", "",
     "", "", "",
     "", "", "", "",
     "", "",
     "", "", "", "",
     "Flexible", "Lowell"],

    ["Team Lead", "Quincy Station", "", "Saturday", "",
     "Chris Taylor", "Susan Garcia",
     "Tom Davis", "Executive Board",
     "Appealed", "Arbitration", "Safety", "Art. 23 - Grievance Procedure", "",
     "Alice Brown, Tom Davis", "", "",
     "", "", "",
     "", "", "", "",
     "", "",
     "", "", "", "",
     "", "Quincy"],

    ["Director", "Remote/Hybrid", "", "Sunday", "",
     "Patricia Moore", "James Wilson",
     "Sarah Martinez", "Communications Committee",
     "", "", "Benefits", "Art. 24 - Discipline", "",
     "Kevin Jones, Linda Garcia", "", "",
     "", "", "",
     "", "", "", "",
     "", "",
     "", "", "", "",
     "", "Brockton"],

    ["Manager", "Brockton Office", "", "", "",
     "Kevin Anderson", "Nancy Taylor",
     "Kevin Jones", "Contract Action Team",
     "", "", "Training", "Art. 25 - Hours of Work", "",
     "Rachel Adams", "", "",
     "", "", "",
     "", "", "", "",
     "", "",
     "", "", "", "",
     "", "Lynn"],

    ["Assistant", "Lynn Location", "", "", "",
     "Michelle Lee", "Richard White",
     "Linda Garcia", "Organizing Committee",
     "", "", "Other", "Art. 26 - Overtime", "",
     "", "", "",
     "", "", "",
     "", "", "", "",
     "", "",
     "", "", "", "",
     "", "Salem"],

    ["Associate", "Salem Office", "", "", "",
     "Brandon Scott", "Angela Moore",
     "Daniel Kim", "COPE Committee",
     "", "", "Harassment", "Art. 27 - Seniority", "",
     "", "", "",
     "", "", "",
     "", "", "", "",
     "", "",
     "", "", "", "",
     "", "Framingham"],

    ["Technician", "", "", "", "",
     "Jessica Green", "Christopher Lee",
     "Rachel Adams", "Young Workers Committee",
     "", "", "Equipment", "Art. 28 - Layoff", "",
     "", "", "",
     "", "", "",
     "", "", "", "",
     "", "",
     "", "", "", "",
     "", "Newton"],

    ["Administrator", "", "", "", "",
     "Andrew Clark", "Melissa Wright",
     "", "",
     "", "", "Leave", "Art. 29 - Sick Leave", "",
     "", "", "",
     "", "", "",
     "", "", "", "",
     "", "",
     "", "", "", "",
     "", "Somerville"],

    ["Support Staff", "", "", "", "",
     "Rachel Brown", "Timothy Davis",
     "", "",
     "", "", "Grievance Process", "Art. 30 - Vacation", "",
     "", "", "",
     "", "", "",
     "", "", "", "",
     "", "",
     "", "", "", "",
     "", "Malden"]
  ];

  // Add category header row first (9 categories, 32 columns)
  const categoryRow = [
    "‚îÄ‚îÄ EMPLOYMENT INFO ‚îÄ‚îÄ", "", "", "", "",
    "‚îÄ‚îÄ SUPERVISION ‚îÄ‚îÄ", "",
    "‚îÄ‚îÄ STEWARD INFO ‚îÄ‚îÄ", "",
    "‚îÄ‚îÄ GRIEVANCE SETTINGS ‚îÄ‚îÄ", "", "", "", "",
    "‚îÄ‚îÄ LINKS & COORDINATORS ‚îÄ‚îÄ", "", "",
    "‚îÄ‚îÄ NOTIFICATIONS ‚îÄ‚îÄ", "", "",
    "‚îÄ‚îÄ ORGANIZATION ‚îÄ‚îÄ", "", "", "",
    "‚îÄ‚îÄ INTEGRATION ‚îÄ‚îÄ", "",
    "‚îÄ‚îÄ DEADLINES ‚îÄ‚îÄ", "", "", "",
    "‚îÄ‚îÄ MULTI-SELECT OPTIONS ‚îÄ‚îÄ", ""
  ];

  // Insert category row at top, then column headers, then data
  config.getRange(1, 1, 1, categoryRow.length).setValues([categoryRow]);
  config.getRange(2, 1, configData.length, configData[0].length).setValues(configData);

  // Style category row (Row 1)
  config.getRange(1, 1, 1, categoryRow.length)
    .setFontWeight("bold")
    .setFontSize(10)
    .setHorizontalAlignment("center");

  // Category colors for row 1 (dark colors) - 32 columns total
  // Employment Info (cols 1-5) - Blue
  config.getRange(1, 1, 1, 5).setBackground("#3B82F6").setFontColor("#FFFFFF");
  // Supervision (cols 6-7) - Green (managers only)
  config.getRange(1, 6, 1, 2).setBackground("#10B981").setFontColor("#FFFFFF");
  // Steward Info (cols 8-9) - Purple (union reps, separate from management)
  config.getRange(1, 8, 1, 2).setBackground("#7C3AED").setFontColor("#FFFFFF");
  // Grievance Settings (cols 10-14) - Orange
  config.getRange(1, 10, 1, 5).setBackground("#F59E0B").setFontColor("#FFFFFF");
  // Links & Coordinators (cols 15-17) - Deep Purple
  config.getRange(1, 15, 1, 3).setBackground("#8B5CF6").setFontColor("#FFFFFF");
  // Notifications (cols 18-20) - Red/Pink
  config.getRange(1, 18, 1, 3).setBackground("#EF4444").setFontColor("#FFFFFF");
  // Organization (cols 21-24) - Teal
  config.getRange(1, 21, 1, 4).setBackground("#14B8A6").setFontColor("#FFFFFF");
  // Integration (cols 25-26) - Indigo
  config.getRange(1, 25, 1, 2).setBackground("#6366F1").setFontColor("#FFFFFF");
  // Deadlines (cols 27-30) - Amber/Gold
  config.getRange(1, 27, 1, 4).setBackground("#D97706").setFontColor("#FFFFFF");
  // Multi-select Options (cols 31-32) - Cyan
  config.getRange(1, 31, 1, 2).setBackground("#06B6D4").setFontColor("#FFFFFF");

  // Style column header row (Row 2) with matching lighter colors
  config.getRange(2, 1, 1, configData[0].length)
    .setFontWeight("bold")
    .setFontSize(9);

  // Light colors for column headers (Row 2) - 32 columns total
  config.getRange(2, 1, 1, 5).setBackground("#DBEAFE");   // Light blue - Employment (1-5)
  config.getRange(2, 6, 1, 2).setBackground("#D1FAE5");   // Light green - Supervision (6-7)
  config.getRange(2, 8, 1, 2).setBackground("#E8E3F3");   // Light purple - Steward Info (8-9)
  config.getRange(2, 10, 1, 5).setBackground("#FEF3C7");  // Light orange - Grievance Settings (10-14)
  config.getRange(2, 15, 1, 3).setBackground("#EDE9FE");  // Light purple - Links (15-17)
  config.getRange(2, 18, 1, 3).setBackground("#FEE2E2");  // Light red - Notifications (18-20)
  config.getRange(2, 21, 1, 4).setBackground("#CCFBF1");  // Light teal - Organization (21-24)
  config.getRange(2, 25, 1, 2).setBackground("#E0E7FF");  // Light indigo - Integration (25-26)
  config.getRange(2, 27, 1, 4).setBackground("#FEF3C7");  // Light amber - Deadlines (27-30)
  config.getRange(2, 31, 1, 2).setBackground("#CFFAFE");  // Light cyan - Multi-select Options (31-32)

  // Add borders between category groups (right border after last column of each category)
  const totalRows = configData.length + 1;
  config.getRange(1, 5, totalRows, 1).setBorder(null, null, null, true, null, null, "#9CA3AF", SpreadsheetApp.BorderStyle.SOLID_MEDIUM);   // After Employment (5)
  config.getRange(1, 7, totalRows, 1).setBorder(null, null, null, true, null, null, "#9CA3AF", SpreadsheetApp.BorderStyle.SOLID_MEDIUM);   // After Supervision (7)
  config.getRange(1, 9, totalRows, 1).setBorder(null, null, null, true, null, null, "#9CA3AF", SpreadsheetApp.BorderStyle.SOLID_MEDIUM);   // After Steward Info (9)
  config.getRange(1, 14, totalRows, 1).setBorder(null, null, null, true, null, null, "#9CA3AF", SpreadsheetApp.BorderStyle.SOLID_MEDIUM);  // After Grievance Settings (14)
  config.getRange(1, 17, totalRows, 1).setBorder(null, null, null, true, null, null, "#9CA3AF", SpreadsheetApp.BorderStyle.SOLID_MEDIUM);  // After Links (17)
  config.getRange(1, 20, totalRows, 1).setBorder(null, null, null, true, null, null, "#9CA3AF", SpreadsheetApp.BorderStyle.SOLID_MEDIUM);  // After Notifications (20)
  config.getRange(1, 24, totalRows, 1).setBorder(null, null, null, true, null, null, "#9CA3AF", SpreadsheetApp.BorderStyle.SOLID_MEDIUM);  // After Organization (24)
  config.getRange(1, 26, totalRows, 1).setBorder(null, null, null, true, null, null, "#9CA3AF", SpreadsheetApp.BorderStyle.SOLID_MEDIUM);  // After Integration (26)
  config.getRange(1, 30, totalRows, 1).setBorder(null, null, null, true, null, null, "#9CA3AF", SpreadsheetApp.BorderStyle.SOLID_MEDIUM);  // After Deadlines (30)

  for (let i = 1; i <= configData[0].length; i++) {
    config.autoResizeColumn(i);
  }

  config.setFrozenRows(2); // Freeze both category and header rows
  config.setTabColor("#2563EB");
}

/* --------------------- MEMBER DIRECTORY - ALL CORRECT COLUMNS --------------------- */
function createMemberDirectory() {
  const ss = SpreadsheetApp.getActive();
  let memberDir = ss.getSheetByName(SHEETS.MEMBER_DIR);
  const isNew = !memberDir;

  // Only create sheet if it doesn't exist - PRESERVE EXISTING DATA
  if (!memberDir) {
    memberDir = ss.insertSheet(SHEETS.MEMBER_DIR);
  }

  // Member Directory columns (31 total) - Reorganized for logical grouping
  const headers = [
    // Section 1: Identity & Core Info (A-D)
    "Member ID",                       // A - 1
    "First Name",                      // B - 2
    "Last Name",                       // C - 3
    "Job Title",                       // D - 4
    // Section 2: Location & Work (E-G)
    "Work Location (Site)",            // E - 5
    "Unit",                            // F - 6
    "Office Days",                     // G - 7
    // Section 3: Contact Information (H-K)
    "Email Address",                   // H - 8
    "Phone Number",                    // I - 9
    "Preferred Communication",         // J - 10 (multi-select)
    "Best Time to Contact",            // K - 11 (multi-select)
    // Section 4: Organizational Structure (L-P)
    "Supervisor (Name)",               // L - 12
    "Manager (Name)",                  // M - 13
    "Is Steward (Y/N)",                // N - 14
    "Committees",                      // O - 15 (multi-select for stewards)
    "Assigned Steward (Name)",         // P - 16
    // Section 5: Engagement Metrics (Q-T) - Hidden by default
    "Last Virtual Mtg (Date)",         // Q - 17
    "Last In-Person Mtg (Date)",       // R - 18
    "Open Rate (%)",                   // S - 19
    "Volunteer Hours (YTD)",           // T - 20
    // Section 6: Member Interests (U-X) - Hidden by default
    "Interest: Local Actions",         // U - 21
    "Interest: Chapter Actions",       // V - 22
    "Interest: Allied Chapter Actions",// W - 23
    "Home Town",                       // X - 24 (connection building)
    // Section 7: Steward Contact Tracking (Y-AA)
    "Most Recent Steward Contact Date",// Y - 25
    "Steward Who Contacted Member",    // Z - 26
    "Notes from Steward Contact",      // AA - 27
    // Section 8: Grievance Management (AB-AE)
    "Has Open Grievance?",             // AB - 28
    "Grievance Status Snapshot",       // AC - 29
    "Next Grievance Deadline",         // AD - 30
    "Start Grievance"                  // AE - 31
  ];

  // Update headers (row 1 only - preserves data in rows 2+)
  memberDir.getRange(1, 1, 1, headers.length).setValues([headers]);

  // Add checkboxes to Start Grievance column (column 31/AE) - only for rows without data
  const lastRow = Math.max(memberDir.getLastRow(), 1);
  if (lastRow > 1) {
    memberDir.getRange(2, MEMBER_COLS.START_GRIEVANCE, lastRow - 1, 1).insertCheckboxes();
  } else {
    memberDir.getRange(2, MEMBER_COLS.START_GRIEVANCE, 999, 1).insertCheckboxes();
  }

  // Apply header formatting
  memberDir.getRange(1, 1, 1, headers.length)
    .setFontWeight("bold")
    .setBackground("#059669")
    .setFontColor("#FFFFFF")
    .setWrap(true);

  memberDir.setFrozenRows(1);
  memberDir.setRowHeight(1, 50);
  memberDir.setColumnWidth(MEMBER_COLS.MEMBER_ID, 90);      // Member ID
  memberDir.setColumnWidth(MEMBER_COLS.EMAIL, 180);         // Email Address
  memberDir.setColumnWidth(MEMBER_COLS.COMMITTEES, 150);    // Committees (multi-select)
  memberDir.setColumnWidth(MEMBER_COLS.PREFERRED_COMM, 150);// Preferred Communication
  memberDir.setColumnWidth(MEMBER_COLS.BEST_TIME, 150);     // Best Time to Contact
  memberDir.setColumnWidth(MEMBER_COLS.HOME_TOWN, 120);     // Home Town
  memberDir.setColumnWidth(MEMBER_COLS.CONTACT_NOTES, 250); // Notes from Steward Contact
  memberDir.setColumnWidth(MEMBER_COLS.START_GRIEVANCE, 120);// Start Grievance checkbox

  // Hide Engagement Metrics columns (Q-T) by default
  memberDir.hideColumns(MEMBER_COLS.LAST_VIRTUAL_MTG, 4);   // Columns 17-20

  // Hide Member Interests columns (U-X) by default
  memberDir.hideColumns(MEMBER_COLS.INTEREST_LOCAL, 4);     // Columns 21-24

  memberDir.setTabColor("#059669");
}

/* --------------------- GRIEVANCE LOG - ALL CORRECT COLUMNS --------------------- */
function createGrievanceLog() {
  const ss = SpreadsheetApp.getActive();
  let grievanceLog = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  // Only create sheet if it doesn't exist - PRESERVE EXISTING DATA
  if (!grievanceLog) {
    grievanceLog = ss.insertSheet(SHEETS.GRIEVANCE_LOG);
  }

  // 34 columns - includes Feature 95 (Coordinator Notifications) and Drive folder integration
  const headers = [
    "Grievance ID",                    // A - 1
    "Member ID",                       // B - 2
    "First Name",                      // C - 3
    "Last Name",                       // D - 4
    "Status",                          // E - 5
    "Current Step",                    // F - 6
    "Incident Date",                   // G - 7
    "Filing Deadline (21d)",           // H - 8 (auto-calculated)
    "Date Filed (Step I)",             // I - 9
    "Step I Decision Due (30d)",       // J - 10 (auto-calculated)
    "Step I Decision Rcvd",            // K - 11
    "Step II Appeal Due (10d)",        // L - 12 (auto-calculated)
    "Step II Appeal Filed",            // M - 13
    "Step II Decision Due (30d)",      // N - 14 (auto-calculated)
    "Step II Decision Rcvd",           // O - 15
    "Step III Appeal Due (30d)",       // P - 16 (auto-calculated)
    "Step III Appeal Filed",           // Q - 17
    "Date Closed",                     // R - 18
    "Days Open",                       // S - 19 (auto-calculated)
    "Next Action Due",                 // T - 20 (auto-calculated)
    "Days to Deadline",                // U - 21 (auto-calculated)
    "Articles Violated",               // V - 22
    "Issue Category",                  // W - 23
    "Member Email",                    // X - 24
    "Unit",                            // Y - 25
    "Work Location (Site)",            // Z - 26
    "Assigned Steward (Name)",         // AA - 27
    "Resolution Summary",              // AB - 28
    "Coordinator Notified",            // AC - 29 (Feature 95: Checkbox)
    "Coordinator Message",             // AD - 30 (Feature 95: Message text)
    "Acknowledged By",                 // AE - 31 (Feature 95: Steward email)
    "Acknowledged Date",               // AF - 32 (Feature 95: Timestamp)
    "Drive Folder ID",                 // AG - 33 (Drive integration)
    "Drive Folder Link"                // AH - 34 (Drive integration)
  ];

  // Update headers (row 1 only - preserves data in rows 2+)
  grievanceLog.getRange(1, 1, 1, headers.length).setValues([headers]);

  // Apply header formatting
  grievanceLog.getRange(1, 1, 1, headers.length)
    .setFontWeight("bold")
    .setBackground("#DC2626")
    .setFontColor("#FFFFFF")
    .setWrap(true);

  grievanceLog.setFrozenRows(1);
  grievanceLog.setRowHeight(1, 50);
  grievanceLog.setColumnWidth(GRIEVANCE_COLS.GRIEVANCE_ID, 110);  // Grievance ID
  grievanceLog.setColumnWidth(GRIEVANCE_COLS.ARTICLES, 180);      // Articles Violated
  grievanceLog.setColumnWidth(GRIEVANCE_COLS.RESOLUTION, 250);    // Resolution Summary
  grievanceLog.setColumnWidth(GRIEVANCE_COLS.COORDINATOR_MESSAGE, 250);  // Coordinator Message

  // Add checkbox validation for Coordinator Notified column (AC) - Feature 95
  const lastRow = 1000; // Reasonable max rows
  const checkboxRange = grievanceLog.getRange(2, GRIEVANCE_COLS.COORDINATOR_NOTIFIED, lastRow - 1, 1);
  const checkboxValidation = SpreadsheetApp.newDataValidation()
    .requireCheckbox()
    .setAllowInvalid(false)
    .build();
  checkboxRange.setDataValidation(checkboxValidation);

  grievanceLog.setTabColor("#DC2626");
}

/* --------------------- DASHBOARD - ONLY REAL DATA --------------------- */
function createMainDashboard() {
  const ss = SpreadsheetApp.getActive();
  let dashboard = ss.getSheetByName(SHEETS.DASHBOARD);

  if (!dashboard) {
    dashboard = ss.insertSheet(SHEETS.DASHBOARD);
  }
  dashboard.clear();

  // Title
  dashboard.getRange("A1:L2").merge()
    .setValue("üìä LOCAL 509 DASHBOARD")
    .setFontSize(18)
    .setFontWeight("bold")
    .setHorizontalAlignment("center")
    .setVerticalAlignment("middle")
    .setBackground("#7C3AED")
    .setFontColor("#FFFFFF");

  dashboard.getRange("A3:L3").merge()
    .setFormula('="Last Updated: " & TEXT(NOW(), "MM/DD/YYYY HH:MM:SS")')
    .setFontSize(10)
    .setHorizontalAlignment("center")
    .setFontColor("#6B7280");

  // MEMBER METRICS - ALL REAL DATA
  dashboard.getRange("A5:L5").merge()
    .setValue("üë• MEMBER METRICS")
    .setFontWeight("bold")
    .setBackground("#E0E7FF")
    .setFontSize(12);

  const memberIdCol = getColumnLetter(MEMBER_COLS.MEMBER_ID);
  const isStewardCol = getColumnLetter(MEMBER_COLS.IS_STEWARD);
  const openRateCol = getColumnLetter(MEMBER_COLS.OPEN_RATE);
  const volunteerHoursCol = getColumnLetter(MEMBER_COLS.VOLUNTEER_HOURS);

  const memberMetrics = [
    ["Total Members", `=COUNTA('Member Directory'!${memberIdCol}:${memberIdCol})-1`, "üë•"],
    ["Active Stewards", `=COUNTIF('Member Directory'!${isStewardCol}:${isStewardCol},"Yes")`, "üõ°Ô∏è"],
    ["Avg Open Rate", `=TEXT(AVERAGE('Member Directory'!${openRateCol}:${openRateCol})/100,"0.0%")`, "üìß"],
    ["YTD Vol. Hours", `=SUM('Member Directory'!${volunteerHoursCol}:${volunteerHoursCol})`, "üôã"]
  ];

  let col = 1;
  memberMetrics.forEach(function(m) {
    dashboard.getRange(6, col, 1, 3).merge()
      .setValue(m[2] + " " + m[0])
      .setFontWeight("bold")
      .setHorizontalAlignment("center")
      .setBackground("#F3F4F6");

    dashboard.getRange(7, col, 1, 3).merge()
      .setFormula(m[1])
      .setFontSize(20)
      .setFontWeight("bold")
      .setHorizontalAlignment("center");

    col += 3;
  });

  // GRIEVANCE METRICS - ALL REAL DATA
  dashboard.getRange("A10:L10").merge()
    .setValue("üìã GRIEVANCE METRICS")
    .setFontWeight("bold")
    .setBackground("#FEE2E2")
    .setFontSize(12);

  // Dynamic column references for Grievance Log
  const statusCol = getColumnLetter(GRIEVANCE_COLS.STATUS);
  const dateClosedCol = getColumnLetter(GRIEVANCE_COLS.DATE_CLOSED);
  const daysOpenCol = getColumnLetter(GRIEVANCE_COLS.DAYS_OPEN);

  const grievanceMetrics = [
    ["Open Grievances", `=COUNTIF('Grievance Log'!${statusCol}:${statusCol},"Open")`, "üî¥"],
    ["Pending Info", `=COUNTIF('Grievance Log'!${statusCol}:${statusCol},"Pending Info")`, "üü°"],
    ["Settled (This Mo.)", `=COUNTIFS('Grievance Log'!${statusCol}:${statusCol},"Settled",'Grievance Log'!${dateClosedCol}:${dateClosedCol},">="&DATE(YEAR(TODAY()),MONTH(TODAY()),1))`, "üü¢"],
    ["Avg Days Open", `=ROUND(AVERAGE(FILTER('Grievance Log'!${daysOpenCol}:${daysOpenCol},'Grievance Log'!${statusCol}:${statusCol}="Open")),0)`, "‚è±Ô∏è"]
  ];

  col = 1;
  grievanceMetrics.forEach(function(m) {
    dashboard.getRange(11, col, 1, 3).merge()
      .setValue(m[2] + " " + m[0])
      .setFontWeight("bold")
      .setHorizontalAlignment("center")
      .setBackground("#F3F4F6");

    dashboard.getRange(12, col, 1, 3).merge()
      .setFormula(m[1])
      .setFontSize(20)
      .setFontWeight("bold")
      .setHorizontalAlignment("center");

    col += 3;
  });

  // ENGAGEMENT METRICS - REAL DATA
  dashboard.getRange("A15:L15").merge()
    .setValue("üìà ENGAGEMENT METRICS (Last 30 Days)")
    .setFontWeight("bold")
    .setBackground("#DCFCE7")
    .setFontSize(12);

  const lastVirtualCol = getColumnLetter(MEMBER_COLS.LAST_VIRTUAL_MTG);
  const lastInPersonCol = getColumnLetter(MEMBER_COLS.LAST_INPERSON_MTG);
  const interestLocalCol = getColumnLetter(MEMBER_COLS.INTEREST_LOCAL);
  const interestChapterCol = getColumnLetter(MEMBER_COLS.INTEREST_CHAPTER);

  const engagementMetrics = [
    ["Virtual Mtgs", `=COUNTIF('Member Directory'!${lastVirtualCol}:${lastVirtualCol},">="&TODAY()-30)`],
    ["In-Person Mtgs", `=COUNTIF('Member Directory'!${lastInPersonCol}:${lastInPersonCol},">="&TODAY()-30)`],
    ["Local Interest", `=COUNTIF('Member Directory'!${interestLocalCol}:${interestLocalCol},"Yes")`],
    ["Chapter Interest", `=COUNTIF('Member Directory'!${interestChapterCol}:${interestChapterCol},"Yes")`]
  ];

  col = 1;
  engagementMetrics.forEach(function(m) {
    dashboard.getRange(16, col, 1, 3).merge()
      .setValue(m[0])
      .setFontWeight("bold")
      .setHorizontalAlignment("center")
      .setBackground("#F3F4F6");

    dashboard.getRange(17, col, 1, 3).merge()
      .setFormula(m[1])
      .setFontSize(18)
      .setFontWeight("bold")
      .setHorizontalAlignment("center");

    col += 3;
  });

  // UPCOMING DEADLINES
  dashboard.getRange("A20:L20").merge()
    .setValue("‚è∞ UPCOMING DEADLINES (Next 14 Days)")
    .setFontWeight("bold")
    .setBackground("#FEF3C7")
    .setFontSize(12);

  const deadlineHeaders = ["Grievance ID", "Member", "Next Action", "Days Until", "Status"];
  dashboard.getRange(21, 1, 1, 5).setValues([deadlineHeaders])
    .setFontWeight("bold")
    .setBackground("#F3F4F6");

  // Dynamic column references for QUERY formula
  const grievanceIdCol = getColumnLetter(GRIEVANCE_COLS.GRIEVANCE_ID);
  const firstNameCol = getColumnLetter(GRIEVANCE_COLS.FIRST_NAME);
  const nextActionCol = getColumnLetter(GRIEVANCE_COLS.NEXT_ACTION_DUE);
  const daysToDeadlineCol = getColumnLetter(GRIEVANCE_COLS.DAYS_TO_DEADLINE);
  const lastCol = getColumnLetter(GRIEVANCE_COLS.RESOLUTION); // AB - last column

  // Formula to populate upcoming deadlines (open grievances with deadlines in next 14 days)
  dashboard.getRange("A22").setFormula(
    `=IFERROR(QUERY('Grievance Log'!${grievanceIdCol}:${lastCol}, ` +
    `"SELECT ${grievanceIdCol}, ${firstNameCol}, ${nextActionCol}, ${daysToDeadlineCol}, ${statusCol} ` +
    `WHERE ${statusCol} = 'Open' AND ${nextActionCol} IS NOT NULL ` +
    `AND ${nextActionCol} >= date '"&TEXT(TODAY(),"yyyy-mm-dd")&"' ` +
    `AND ${nextActionCol} <= date '"&TEXT(TODAY()+14,"yyyy-mm-dd")&"' ` +
    `ORDER BY ${nextActionCol} ASC ` +
    `LIMIT 10", 0), "No upcoming deadlines")`
  );

  dashboard.setTabColor("#7C3AED");
}

/**
 * Cleans up Member Directory structure - removes extra columns beyond AE (31)
 * Run this if columns AF, AG, etc. appear with mixed data
 */
function cleanupMemberDirectoryColumns() {
  const ss = SpreadsheetApp.getActive();
  const memberDir = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (!memberDir) {
    SpreadsheetApp.getUi().alert('Member Directory not found!');
    return;
  }

  const ui = SpreadsheetApp.getUi();
  const lastCol = memberDir.getLastColumn();

  if (lastCol <= 31) {
    ui.alert('Column Structure OK', 'Member Directory has ' + lastCol + ' columns (expected: 31 max). No cleanup needed.', ui.ButtonSet.OK);
    return;
  }

  const response = ui.alert(
    'Remove Extra Columns?',
    'Member Directory has ' + lastCol + ' columns but should only have 31 (A-AE).\n\n' +
    'Extra columns will be deleted. This cannot be undone.\n\n' +
    'Continue?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) return;

  // Delete columns from right to left (starting after column 31)
  const columnsToDelete = lastCol - 31;
  for (let i = 0; i < columnsToDelete; i++) {
    memberDir.deleteColumn(32); // Always delete column 32 (shifts remaining left)
  }

  // Re-apply checkboxes to column AE (31) - Start Grievance
  const lastRow = Math.max(memberDir.getLastRow(), 100);
  memberDir.getRange(2, MEMBER_COLS.START_GRIEVANCE, lastRow - 1, 1).insertCheckboxes();

  ui.alert('Cleanup Complete', 'Removed ' + columnsToDelete + ' extra columns.\nColumn AE checkboxes have been restored.', ui.ButtonSet.OK);
}

/**
 * Refresh Dashboard Deadlines - Updates formula on existing Dashboard
 * Run this after seeding data or if deadlines show incorrect values
 */
function refreshDashboardDeadlines() {
  const ss = SpreadsheetApp.getActive();
  const dashboard = ss.getSheetByName(SHEETS.DASHBOARD);

  if (!dashboard) {
    SpreadsheetApp.getUi().alert('Dashboard sheet not found!');
    return;
  }

  SpreadsheetApp.getActive().toast('Refreshing dashboard deadlines...', 'Please wait', -1);

  // Dynamic column references
  const grievanceIdCol = getColumnLetter(GRIEVANCE_COLS.GRIEVANCE_ID);
  const firstNameCol = getColumnLetter(GRIEVANCE_COLS.FIRST_NAME);
  const nextActionCol = getColumnLetter(GRIEVANCE_COLS.NEXT_ACTION_DUE);
  const daysToDeadlineCol = getColumnLetter(GRIEVANCE_COLS.DAYS_TO_DEADLINE);
  const statusCol = getColumnLetter(GRIEVANCE_COLS.STATUS);
  const lastGrievanceCol = getColumnLetter(GRIEVANCE_COLS.RESOLUTION); // Last column (28)

  // Clear existing deadline data
  dashboard.getRange("A22:E31").clearContent();

  // New formula: Uses FILTER instead of QUERY for better date handling
  // Only shows items where Days to Deadline is numeric and >= 0 (future deadlines)
  // Formats Next Action as date
  dashboard.getRange("A22").setFormula(
    `=IFERROR(QUERY('Grievance Log'!A:${lastGrievanceCol}, ` +
    `"SELECT ${grievanceIdCol}, ${firstNameCol}, ${nextActionCol}, ${daysToDeadlineCol}, ${statusCol} ` +
    `WHERE ${statusCol} = 'Open' ` +
    `AND ${daysToDeadlineCol} IS NOT NULL ` +
    `AND ${daysToDeadlineCol} >= 0 ` +
    `AND ${daysToDeadlineCol} <= 14 ` +
    `ORDER BY ${daysToDeadlineCol} ASC ` +
    `LIMIT 10", 0), "No upcoming deadlines")`
  );

  // Format the Next Action column (column C in the output) as dates
  dashboard.getRange("C22:C31").setNumberFormat("MM/DD/YYYY");

  SpreadsheetApp.getActive().toast('‚úÖ Dashboard deadlines refreshed!', 'Complete', 3);
}

/**
 * Refresh Grievance Log Formulas - Re-applies ARRAYFORMULA to calculated columns
 * Run this after seeding data to fix Days Open, Next Action, Days to Deadline
 */
function refreshGrievanceFormulas() {
  const ss = SpreadsheetApp.getActive();
  const grievanceLog = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!grievanceLog) {
    SpreadsheetApp.getUi().alert('Grievance Log sheet not found!');
    return;
  }

  SpreadsheetApp.getActive().toast('Refreshing grievance formulas...', 'Please wait', -1);

  // Get column letters
  const gStatusCol = getColumnLetter(GRIEVANCE_COLS.STATUS);
  const gCurrentStepCol = getColumnLetter(GRIEVANCE_COLS.CURRENT_STEP);
  const gIncidentDateCol = getColumnLetter(GRIEVANCE_COLS.INCIDENT_DATE);
  const gFilingDeadlineCol = getColumnLetter(GRIEVANCE_COLS.FILING_DEADLINE);
  const gDateFiledCol = getColumnLetter(GRIEVANCE_COLS.DATE_FILED);
  const gStep1DueCol = getColumnLetter(GRIEVANCE_COLS.STEP1_DUE);
  const gStep2DueCol = getColumnLetter(GRIEVANCE_COLS.STEP2_DUE);
  const gStep3AppealDueCol = getColumnLetter(GRIEVANCE_COLS.STEP3_APPEAL_DUE);
  const gDateClosedCol = getColumnLetter(GRIEVANCE_COLS.DATE_CLOSED);
  const gDaysOpenCol = getColumnLetter(GRIEVANCE_COLS.DAYS_OPEN);
  const gNextActionCol = getColumnLetter(GRIEVANCE_COLS.NEXT_ACTION_DUE);
  const gDaysToDeadlineCol = getColumnLetter(GRIEVANCE_COLS.DAYS_TO_DEADLINE);

  // Clear the formula columns first (S, T, U = columns 19, 20, 21)
  const lastRow = Math.max(grievanceLog.getLastRow(), 100);
  grievanceLog.getRange(2, GRIEVANCE_COLS.DAYS_OPEN, lastRow - 1, 3).clearContent();

  // Days Open - Column S (19)
  grievanceLog.getRange(gDaysOpenCol + "2").setFormula(
    `=ARRAYFORMULA(IF(${gDateFiledCol}2:${gDateFiledCol}<>"",IF(${gDateClosedCol}2:${gDateClosedCol}<>"",${gDateClosedCol}2:${gDateClosedCol}-${gDateFiledCol}2:${gDateFiledCol},TODAY()-${gDateFiledCol}2:${gDateFiledCol}),""))`
  );

  // Next Action Due - Column T (20)
  grievanceLog.getRange(gNextActionCol + "2").setFormula(
    `=ARRAYFORMULA(IF(${gStatusCol}2:${gStatusCol}="Open",IF(${gCurrentStepCol}2:${gCurrentStepCol}="Step I",${gStep1DueCol}2:${gStep1DueCol},IF(${gCurrentStepCol}2:${gCurrentStepCol}="Step II",${gStep2DueCol}2:${gStep2DueCol},IF(${gCurrentStepCol}2:${gCurrentStepCol}="Step III",${gStep3AppealDueCol}2:${gStep3AppealDueCol},${gFilingDeadlineCol}2:${gFilingDeadlineCol}))),""))`
  );

  // Days to Deadline - Column U (21) - Shows text for overdue, number for future
  grievanceLog.getRange(gDaysToDeadlineCol + "2").setFormula(
    `=ARRAYFORMULA(IF(${gNextActionCol}2:${gNextActionCol}<>"",IF(${gNextActionCol}2:${gNextActionCol}-TODAY()<0,"OVERDUE "&ABS(${gNextActionCol}2:${gNextActionCol}-TODAY())&"d",IF(${gNextActionCol}2:${gNextActionCol}-TODAY()=0,"DUE TODAY",${gNextActionCol}2:${gNextActionCol}-TODAY())),""))`
  );

  SpreadsheetApp.getActive().toast('‚úÖ Grievance formulas refreshed!', 'Complete', 3);
}

/* --------------------- ANALYTICS DATA SHEET --------------------- */
function createAnalyticsDataSheet() {
  const ss = SpreadsheetApp.getActive();
  let analytics = ss.getSheetByName(SHEETS.ANALYTICS);

  if (!analytics) {
    analytics = ss.insertSheet(SHEETS.ANALYTICS);
  }
  analytics.clear();

  analytics.getRange("A1").setValue("ANALYTICS DATA - Calculated from Member Directory & Grievance Log");
  analytics.getRange("A1").setFontWeight("bold").setBackground("#6366F1").setFontColor("#FFFFFF");

  // Dynamic column references for Grievance Log
  const statusCol = getColumnLetter(GRIEVANCE_COLS.STATUS);

  // Grievances by Status
  analytics.getRange("A3").setValue("Grievances by Status");
  analytics.getRange("A4:B4").setValues([["Status", "Count"]]).setFontWeight("bold");
  analytics.getRange("A5").setFormula(`=UNIQUE(FILTER('Grievance Log'!${statusCol}:${statusCol}, 'Grievance Log'!${statusCol}:${statusCol}<>"", 'Grievance Log'!${statusCol}:${statusCol}<>"Status"))`);
  analytics.getRange("B5").setFormula(`=ARRAYFORMULA(IF(A5:A<>"", COUNTIF('Grievance Log'!${statusCol}:${statusCol}, A5:A), ""))`);

  // Grievances by Unit (dynamic column reference)
  const unitCol = getColumnLetter(GRIEVANCE_COLS.UNIT);
  analytics.getRange("D3").setValue("Grievances by Unit");
  analytics.getRange("D4:E4").setValues([["Unit", "Count"]]).setFontWeight("bold");
  analytics.getRange("D5").setFormula(`=UNIQUE(FILTER('Grievance Log'!${unitCol}:${unitCol}, 'Grievance Log'!${unitCol}:${unitCol}<>"", 'Grievance Log'!${unitCol}:${unitCol}<>"Unit"))`);
  analytics.getRange("E5").setFormula(`=ARRAYFORMULA(IF(D5:D<>"", COUNTIF('Grievance Log'!${unitCol}:${unitCol}, D5:D), ""))`);

  // Members by Location (dynamic column references)
  const workLocationCol = getColumnLetter(MEMBER_COLS.WORK_LOCATION);
  analytics.getRange("G3").setValue("Members by Location");
  analytics.getRange("G4:H4").setValues([["Location", "Count"]]).setFontWeight("bold");
  analytics.getRange("G5").setFormula(`=UNIQUE(FILTER('Member Directory'!${workLocationCol}:${workLocationCol}, 'Member Directory'!${workLocationCol}:${workLocationCol}<>"", 'Member Directory'!${workLocationCol}:${workLocationCol}<>"Work Location (Site)"))`);
  analytics.getRange("H5").setFormula(`=ARRAYFORMULA(IF(G5:G<>"", COUNTIF('Member Directory'!${workLocationCol}:${workLocationCol}, G5:G), ""))`);

  // Steward Workload (dynamic column references)
  const stewardCol = getColumnLetter(GRIEVANCE_COLS.STEWARD);
  analytics.getRange("J3").setValue("Steward Workload");
  analytics.getRange("J4:K4").setValues([["Steward", "Open Cases"]]).setFontWeight("bold");
  analytics.getRange("J5").setFormula(`=UNIQUE(FILTER('Grievance Log'!${stewardCol}:${stewardCol}, 'Grievance Log'!${stewardCol}:${stewardCol}<>"", 'Grievance Log'!${stewardCol}:${stewardCol}<>"Assigned Steward (Name)"))`);
  analytics.getRange("K5").setFormula(`=ARRAYFORMULA(IF(J5:J<>"", COUNTIFS('Grievance Log'!${stewardCol}:${stewardCol}, J5:J, 'Grievance Log'!${statusCol}:${statusCol}, "Open"), ""))`);

  analytics.hideSheet();
}

/* --------------------- MEMBER SATISFACTION --------------------- */
function createMemberSatisfactionSheet() {
  const ss = SpreadsheetApp.getActive();
  let satisfaction = ss.getSheetByName(SHEETS.MEMBER_SATISFACTION);

  if (!satisfaction) {
    satisfaction = ss.insertSheet(SHEETS.MEMBER_SATISFACTION);
  }
  satisfaction.clear();

  satisfaction.getRange("A1:J1").merge()
    .setValue("üòä MEMBER SATISFACTION TRACKING")
    .setFontSize(14)
    .setFontWeight("bold")
    .setHorizontalAlignment("center")
    .setBackground("#10B981")
    .setFontColor("#FFFFFF");

  const headers = [
    "Survey ID",
    "Member ID",
    "Member Name",
    "Date Sent",
    "Date Completed",
    "Overall Satisfaction (1-5)",
    "Steward Support (1-5)",
    "Communication (1-5)",
    "Would Recommend Union (Y/N)",
    "Comments"
  ];

  satisfaction.getRange(3, 1, 1, headers.length).setValues([headers])
    .setFontWeight("bold")
    .setBackground("#F3F4F6");

  satisfaction.setFrozenRows(3);

  satisfaction.getRange("A10:E10").merge()
    .setValue("SATISFACTION METRICS")
    .setFontWeight("bold")
    .setBackground("#E0E7FF");

  const metrics = [
    ["Average Overall Satisfaction:", "=IFERROR(AVERAGE(F4:F1000),\"-\")"],
    ["Average Steward Support:", "=IFERROR(AVERAGE(G4:G1000),\"-\")"],
    ["Average Communication:", "=IFERROR(AVERAGE(H4:H1000),\"-\")"],
    ["% Would Recommend:", "=IFERROR(TEXT(COUNTIF(I4:I1000,\"Y\")/COUNTA(I4:I1000),\"0.0%\"),\"-\")"]
  ];

  satisfaction.getRange(11, 1, metrics.length, 2).setValues(metrics);
  satisfaction.setTabColor("#10B981");
}

/* --------------------- FEEDBACK & DEVELOPMENT --------------------- */
function createFeedbackSheet() {
  const ss = SpreadsheetApp.getActive();
  let feedback = ss.getSheetByName(SHEETS.FEEDBACK);
  if (!feedback) feedback = ss.insertSheet(SHEETS.FEEDBACK);
  feedback.clear();
  feedback.getRange("A1:N1").merge().setValue("üí° FEEDBACK, FEATURES & DEVELOPMENT ROADMAP").setFontSize(16).setFontWeight("bold").setHorizontalAlignment("center").setBackground(COLORS.ACCENT_PURPLE).setFontColor("white");
  feedback.getRange("A2:N2").merge().setValue("üéØ Track bugs, feedback, future features, and work in progress - all in one place").setFontSize(10).setFontStyle("italic").setHorizontalAlignment("center").setBackground(COLORS.LIGHT_GRAY).setFontColor(COLORS.TEXT_GRAY);
  const headers = ["Type", "Submitted/Started", "Submitted By", "Priority", "Title", "Description", "Status", "Progress %", "Complexity", "Target Completion", "Assigned To", "Blockers", "Resolution/Notes", "Last Updated"];
  feedback.getRange(3, 1, 1, headers.length).setValues([headers]).setFontWeight("bold").setBackground(COLORS.LIGHT_GRAY).setFontColor(COLORS.TEXT_DARK);
  const typeRule = SpreadsheetApp.newDataValidation().requireValueInList(['Bug Report', 'Feedback', 'Future Feature', 'In Progress', 'Completed', 'Archived'], true).setAllowInvalid(false).build();
  feedback.getRange("A4:A1000").setDataValidation(typeRule);
  const priorityRule = SpreadsheetApp.newDataValidation().requireValueInList(['Critical', 'High', 'Medium', 'Low'], true).setAllowInvalid(false).build();
  feedback.getRange("D4:D1000").setDataValidation(priorityRule);
  const statusRule = SpreadsheetApp.newDataValidation().requireValueInList(['New', 'Under Review', 'Planned', 'In Progress', 'Testing', 'Completed', 'Deferred', 'Cancelled'], true).setAllowInvalid(false).build();
  feedback.getRange("G4:G1000").setDataValidation(statusRule);
  const complexityRule = SpreadsheetApp.newDataValidation().requireValueInList(['Simple', 'Moderate', 'Complex', 'Very Complex'], true).setAllowInvalid(false).build();
  feedback.getRange("I4:I1000").setDataValidation(complexityRule);
  feedback.setFrozenRows(3);
  feedback.setTabColor(COLORS.ACCENT_PURPLE);
  feedback.setColumnWidth(1, 120); feedback.setColumnWidth(2, 110); feedback.setColumnWidth(3, 120); feedback.setColumnWidth(4, 80); feedback.setColumnWidth(5, 200); feedback.setColumnWidth(6, 300); feedback.setColumnWidth(7, 100); feedback.setColumnWidth(8, 90); feedback.setColumnWidth(9, 100); feedback.setColumnWidth(10, 110); feedback.setColumnWidth(11, 120); feedback.setColumnWidth(12, 200); feedback.setColumnWidth(13, 250); feedback.setColumnWidth(14, 110);

  // Populate with implemented features
  populateImplementedFeatures(feedback);
}

/**
 * Populates the Feedback & Development sheet with implemented features
 * @param {Sheet} sheet - The Feedback & Development sheet
 */
function populateImplementedFeatures(sheet) {
  const today = new Date();
  const features = [
    // Features 79-95 (Core Security, Performance, UI Features)
    ['Completed', today, 'System', 'High', 'Feature 79: Audit Logging', 'Complete audit trail for all data modifications with user tracking, timestamps, and IP addresses', 'Completed', 100, 'Complex', today, 'Claude', '', 'Implemented in SecurityAndAdmin.gs', today],
    ['Completed', today, 'System', 'High', 'Feature 80: RBAC System', 'Role-Based Access Control with Admin, Steward, and Viewer hierarchical permissions', 'Completed', 100, 'Complex', today, 'Claude', '', 'Implemented in SecurityAndAdmin.gs', today],
    ['Completed', today, 'System', 'High', 'Feature 83: Input Sanitization', 'XSS protection and malicious input prevention with comprehensive validation', 'Completed', 100, 'Moderate', today, 'Claude', '', 'Implemented in SecurityAndAdmin.gs', today],
    ['Completed', today, 'System', 'Medium', 'Feature 84: Audit Reporting', 'Generate comprehensive audit reports with filtering and export capabilities', 'Completed', 100, 'Moderate', today, 'Claude', '', 'Implemented in SecurityAndAdmin.gs', today],
    ['Completed', today, 'System', 'Medium', 'Feature 85: Data Retention', 'Automated data retention policy enforcement with 7-year default retention', 'Completed', 100, 'Moderate', today, 'Claude', '', 'Implemented in SecurityAndAdmin.gs', today],
    ['Completed', today, 'System', 'Medium', 'Feature 86: Suspicious Activity Detection', 'Automated detection of unusual access patterns and security threats', 'Completed', 100, 'Complex', today, 'Claude', '', 'Implemented in SecurityAndAdmin.gs', today],
    ['Completed', today, 'System', 'High', 'Feature 87: Quick Actions Sidebar', 'Interactive sidebar with frequently used actions and shortcuts', 'Completed', 100, 'Moderate', today, 'Claude', '', 'Implemented in UIFeatures.gs', today],
    ['Completed', today, 'System', 'High', 'Feature 88: Advanced Search', 'Multi-criteria search across grievances with highlighting and export', 'Completed', 100, 'Moderate', today, 'Claude', '', 'Implemented in UIFeatures.gs', today],
    ['Completed', today, 'System', 'High', 'Feature 89: Advanced Filtering', 'Complex filtering system with save/load filter presets', 'Completed', 100, 'Moderate', today, 'Claude', '', 'Implemented in UIFeatures.gs', today],
    ['Completed', today, 'System', 'High', 'Feature 90: Automated Backups', 'Scheduled Google Drive backups with retention policy and cleanup', 'Completed', 100, 'Complex', today, 'Claude', '', 'Implemented in PerformanceAndBackup.gs', today],
    ['Completed', today, 'System', 'Medium', 'Feature 91: Performance Monitoring', 'Track execution times, identify bottlenecks, generate performance reports', 'Completed', 100, 'Moderate', today, 'Claude', '', 'Implemented in PerformanceAndBackup.gs', today],
    ['Completed', today, 'System', 'Medium', 'Feature 92: Keyboard Shortcuts', 'Navigate dashboard using keyboard shortcuts for improved productivity', 'Completed', 100, 'Simple', today, 'Claude', '', 'Implemented in UIFeatures.gs', today],
    ['Completed', today, 'System', 'Medium', 'Feature 93: Export Wizard', 'Guided export process with filtering and multiple format support', 'Completed', 100, 'Moderate', today, 'Claude', '', 'Implemented in UIFeatures.gs', today],
    ['Completed', today, 'System', 'Medium', 'Feature 94: Data Import', 'Import members and grievances from external Google Sheets with validation', 'Completed', 100, 'Moderate', today, 'Claude', '', 'Implemented in UIFeatures.gs', today],
    ['Completed', today, 'System', 'High', 'Feature 95: Coordinator Notifications', 'Checkbox-based row highlighting with automated email notifications and steward acknowledgment tracking', 'Completed', 100, 'Complex', today, 'Claude', '', 'Implemented in CoordinatorNotification.gs with 4 new Grievance Log columns (AC-AF)', today],

    // Additional Major Features
    ['Completed', today, 'System', 'High', 'Automated Deadline Notifications', 'Daily email alerts for approaching deadlines (7-day and 3-day warnings)', 'Completed', 100, 'Moderate', today, 'Claude', '', 'Implemented in AutomatedNotifications.gs', today],
    ['Completed', today, 'System', 'High', 'Predictive Analytics', 'Case outcome prediction and volume forecasting with trend analysis', 'Completed', 100, 'Very Complex', today, 'Claude', '', 'Implemented in PredictiveAnalytics.gs', today],
    ['Completed', today, 'System', 'High', 'Smart Auto-Assignment', 'Intelligent steward assignment based on workload, expertise, and location', 'Completed', 100, 'Complex', today, 'Claude', '', 'Implemented in SmartAutoAssignment.gs', today],
    ['Completed', today, 'System', 'High', 'Calendar Integration', 'Google Calendar sync for grievance deadlines with automatic updates', 'Completed', 100, 'Complex', today, 'Claude', '', 'Implemented in CalendarIntegration.gs', today],
    ['Completed', today, 'System', 'High', 'Mobile Optimization', 'Mobile-responsive interfaces for dashboards, search, and member browsing', 'Completed', 100, 'Complex', today, 'Claude', '', 'Implemented in MobileOptimization.gs', today],
    ['Completed', today, 'System', 'Medium', 'Root Cause Analysis', 'Identify root causes of grievances with trend tracking and recommendations', 'Completed', 100, 'Complex', today, 'Claude', '', 'Implemented in RootCauseAnalysis.gs', today],
    ['Completed', today, 'System', 'Medium', 'Gmail Integration', 'Send emails directly from dashboard with templates and tracking', 'Completed', 100, 'Moderate', today, 'Claude', '', 'Implemented in GmailIntegration.gs', today],
    ['Completed', today, 'System', 'Medium', 'Google Drive Integration', 'Automatic folder creation and document management for grievances', 'Completed', 100, 'Moderate', today, 'Claude', '', 'Implemented in GoogleDriveIntegration.gs', today],
    ['Completed', today, 'System', 'Medium', 'Dark Mode & Themes', 'Multiple theme support including dark mode for reduced eye strain', 'Completed', 100, 'Moderate', today, 'Claude', '', 'Implemented in DarkModeThemes.gs', today],
    ['Completed', today, 'System', 'Low', 'Custom Report Builder', 'Interactive report builder with drag-and-drop fields and export options', 'Completed', 100, 'Complex', today, 'Claude', '', 'Implemented in CustomReportBuilder.gs', today]
  ];

  // Write features to sheet starting at row 4
  if (features.length > 0) {
    sheet.getRange(4, 1, features.length, 14).setValues(features);
  }
}

/* --------------------- STEWARD WORKLOAD --------------------- */
function createStewardWorkloadSheet() {
  const ss = SpreadsheetApp.getActive();
  let sheet = ss.getSheetByName(SHEETS.STEWARD_WORKLOAD);
  if (!sheet) sheet = ss.insertSheet(SHEETS.STEWARD_WORKLOAD);
  sheet.clear();
  sheet.getRange("A1:K1").merge().setValue("üë®‚Äç‚öñÔ∏è STEWARD WORKLOAD ANALYSIS").setFontSize(16).setFontWeight("bold").setHorizontalAlignment("center").setBackground(COLORS.PRIMARY_PURPLE).setFontColor("white");
  const headers = ["Steward Name", "Total Cases", "Active Cases", "Resolved Cases", "Win Rate %", "Avg Days to Resolution", "Overdue Cases", "Due This Week", "Capacity Status", "Email", "Phone"];
  sheet.getRange(3, 1, 1, headers.length).setValues([headers]).setFontWeight("bold").setBackground(COLORS.LIGHT_GRAY);
  sheet.setFrozenRows(3);
  sheet.setTabColor(COLORS.PRIMARY_PURPLE);
}

function createTrendsSheet() {
  const ss = SpreadsheetApp.getActive();
  let sheet = ss.getSheetByName(SHEETS.TRENDS);
  if (!sheet) sheet = ss.insertSheet(SHEETS.TRENDS);
  sheet.clear();
  sheet.getRange("A1:L1").merge().setValue("üìà TRENDS & TIMELINE ANALYSIS").setFontSize(16).setFontWeight("bold").setHorizontalAlignment("center").setBackground(COLORS.UNION_GREEN).setFontColor("white");
  const headers = ["Month", "New Grievances", "Resolved", "Win Rate %", "Avg Resolution Days", "Active at Month End", "Overdue", "New Members", "Active Members", "Stewards Active", "Satisfaction Score", "Trend"];
  sheet.getRange(3, 1, 1, headers.length).setValues([headers]).setFontWeight("bold").setBackground(COLORS.LIGHT_GRAY);
  sheet.setFrozenRows(3);
  sheet.setTabColor(COLORS.UNION_GREEN);
}


function createLocationSheet() {
  const ss = SpreadsheetApp.getActive();
  let sheet = ss.getSheetByName(SHEETS.LOCATION);
  if (!sheet) sheet = ss.insertSheet(SHEETS.LOCATION);
  sheet.clear();
  sheet.getRange("A1:K1").merge().setValue("üó∫Ô∏è LOCATION ANALYTICS").setFontSize(16).setFontWeight("bold").setHorizontalAlignment("center").setBackground(COLORS.ACCENT_TEAL).setFontColor("white");
  const headers = ["Location", "Total Members", "Active Members", "Total Grievances", "Active Grievances", "Win Rate %", "Avg Resolution Days", "Member Satisfaction", "Stewards Assigned", "Risk Score", "Priority"];
  sheet.getRange(3, 1, 1, headers.length).setValues([headers]).setFontWeight("bold").setBackground(COLORS.LIGHT_GRAY);
  sheet.setFrozenRows(3);
  sheet.setTabColor(COLORS.ACCENT_TEAL);
}

function createTypeAnalysisSheet() {
  const ss = SpreadsheetApp.getActive();
  let sheet = ss.getSheetByName(SHEETS.TYPE_ANALYSIS);
  if (!sheet) sheet = ss.insertSheet(SHEETS.TYPE_ANALYSIS);
  sheet.clear();
  sheet.getRange("A1:K1").merge().setValue("üìä GRIEVANCE TYPE ANALYSIS").setFontSize(16).setFontWeight("bold").setHorizontalAlignment("center").setBackground(COLORS.PRIMARY_BLUE).setFontColor("white");
  const headers = ["Issue Type", "Total Cases", "Active", "Resolved", "Win Rate %", "Avg Days to Resolve", "Most Common Location", "Top Article Violated", "Trend", "Priority Level", "Notes"];
  sheet.getRange(3, 1, 1, headers.length).setValues([headers]).setFontWeight("bold").setBackground(COLORS.LIGHT_GRAY);
  sheet.setFrozenRows(3);
  sheet.setTabColor(COLORS.PRIMARY_BLUE);
}

/* --------------------- EXECUTIVE DASHBOARD (Merged Summary + Quick Stats) --------------------- */
function createExecutiveDashboard() {
  const ss = SpreadsheetApp.getActive();
  let sheet = ss.getSheetByName("üíº Executive Dashboard");

  if (!sheet) {
    sheet = ss.insertSheet("üíº Executive Dashboard");
  }
  sheet.clear();

  // Header
  sheet.getRange("A1:F1").merge()
    .setValue("üíº EXECUTIVE DASHBOARD")
    .setFontSize(18)
    .setFontWeight("bold")
    .setHorizontalAlignment("center")
    .setBackground(COLORS.PRIMARY_PURPLE)
    .setFontColor("white");

  sheet.getRange("A2:F2").merge()
    .setValue("‚ö° At-a-Glance Metrics & Key Performance Indicators")
    .setFontSize(10)
    .setFontStyle("italic")
    .setHorizontalAlignment("center")
    .setBackground(COLORS.LIGHT_GRAY)
    .setFontColor(COLORS.TEXT_GRAY);

  // Section 1: Quick Stats
  sheet.getRange("A4:D4").merge()
    .setValue("‚ö° QUICK STATS")
    .setFontWeight("bold")
    .setFontSize(14)
    .setBackground(COLORS.ACCENT_ORANGE)
    .setFontColor("white")
    .setHorizontalAlignment("center");

  const quickHeaders = ["Metric", "Value", "Comparison", "Trend"];
  sheet.getRange(5, 1, 1, quickHeaders.length).setValues([quickHeaders])
    .setFontWeight("bold")
    .setBackground(COLORS.LIGHT_GRAY);

  // Dynamic column references for formulas
  const resolutionCol = getColumnLetter(GRIEVANCE_COLS.RESOLUTION);
  const statusCol = getColumnLetter(GRIEVANCE_COLS.STATUS);
  const daysOpenCol = getColumnLetter(GRIEVANCE_COLS.DAYS_OPEN);
  const daysToDeadlineCol = getColumnLetter(GRIEVANCE_COLS.DAYS_TO_DEADLINE);
  const grievanceIdCol = getColumnLetter(GRIEVANCE_COLS.GRIEVANCE_ID);

  const execMemberIdCol = getColumnLetter(MEMBER_COLS.MEMBER_ID);
  const execIsStewardCol = getColumnLetter(MEMBER_COLS.IS_STEWARD);

  const quickStats = [
    ["Active Members", `=COUNTA('Member Directory'!${execMemberIdCol}2:${execMemberIdCol})`, "", ""],
    ["Active Grievances", `=COUNTIF('Grievance Log'!${statusCol}:${statusCol},"Open")`, "", ""],
    ["Win Rate", `=TEXT(IFERROR(COUNTIFS('Grievance Log'!${statusCol}:${statusCol},"Resolved*",'Grievance Log'!${resolutionCol}:${resolutionCol},"*Won*")/COUNTIF('Grievance Log'!${statusCol}:${statusCol},"Resolved*"),0),"0%")`, "", ""],
    ["Avg Resolution (Days)", `=ROUND(AVERAGE('Grievance Log'!${daysOpenCol}:${daysOpenCol}),1)`, "", ""],
    ["Overdue Cases", `=COUNTIF('Grievance Log'!${daysToDeadlineCol}:${daysToDeadlineCol},"OVERDUE*")`, "", ""],
    ["Active Stewards", `=COUNTIF('Member Directory'!${execIsStewardCol}:${execIsStewardCol},"Yes")`, "", ""]
  ];

  sheet.getRange(6, 1, quickStats.length, 4).setValues(quickStats);

  // Section 2: Detailed KPIs
  sheet.getRange("A13:C13").merge()
    .setValue("üìä DETAILED KEY PERFORMANCE INDICATORS")
    .setFontWeight("bold")
    .setFontSize(14)
    .setBackground(COLORS.PRIMARY_PURPLE)
    .setFontColor("white")
    .setHorizontalAlignment("center");

  const kpiHeaders = ["Metric", "Value", "Status"];
  sheet.getRange(14, 1, 1, kpiHeaders.length).setValues([kpiHeaders])
    .setFontWeight("bold")
    .setBackground(COLORS.LIGHT_GRAY);

  const detailedKpis = [
    ["Total Active Members", `=COUNTA('Member Directory'!${execMemberIdCol}2:${execMemberIdCol})`, ""],
    ["Total Active Grievances", `=COUNTIF('Grievance Log'!${statusCol}:${statusCol},"Open")`, ""],
    ["Overall Win Rate", `=TEXT(IFERROR(COUNTIFS('Grievance Log'!${statusCol}:${statusCol},"Resolved*",'Grievance Log'!${resolutionCol}:${resolutionCol},"*Won*")/COUNTIF('Grievance Log'!${statusCol}:${statusCol},"Resolved*"),0),"0.0%")`, ""],
    ["Avg Resolution Time (Days)", `=ROUND(AVERAGE('Grievance Log'!${daysOpenCol}:${daysOpenCol}),1)`, ""],
    ["Cases Overdue", `=COUNTIF('Grievance Log'!${daysToDeadlineCol}:${daysToDeadlineCol},"OVERDUE*")`, ""],
    ["Member Satisfaction Score", "=TEXT(AVERAGE('Member Satisfaction'!C:C),\"0.0\")", ""],
    ["Total Grievances Filed YTD", `=COUNTA('Grievance Log'!${grievanceIdCol}2:${grievanceIdCol})`, ""],
    ["Resolved Grievances", `=COUNTIF('Grievance Log'!${statusCol}:${statusCol},"Resolved")`, ""]
  ];

  sheet.getRange(15, 1, detailedKpis.length, 3).setValues(detailedKpis);

  sheet.setFrozenRows(4);
  sheet.setTabColor(COLORS.PRIMARY_PURPLE);

  // Set column widths
  sheet.setColumnWidth(1, 250);
  sheet.setColumnWidth(2, 150);
  sheet.setColumnWidth(3, 100);
  sheet.setColumnWidth(4, 100);
}

/* --------------------- KPI PERFORMANCE DASHBOARD (Merged Performance + KPI Board) --------------------- */
function createKPIPerformanceDashboard() {
  const ss = SpreadsheetApp.getActive();
  let sheet = ss.getSheetByName("üìä KPI Performance Dashboard");

  if (!sheet) {
    sheet = ss.insertSheet("üìä KPI Performance Dashboard");
  }
  sheet.clear();

  // Header
  sheet.getRange("A1:L1").merge()
    .setValue("üìä KPI PERFORMANCE DASHBOARD")
    .setFontSize(18)
    .setFontWeight("bold")
    .setHorizontalAlignment("center")
    .setBackground(COLORS.UNION_GREEN)
    .setFontColor("white");

  sheet.getRange("A2:L2").merge()
    .setValue("üéØ Track KPIs against targets with variance analysis and performance trends")
    .setFontSize(10)
    .setFontStyle("italic")
    .setHorizontalAlignment("center")
    .setBackground(COLORS.LIGHT_GRAY)
    .setFontColor(COLORS.TEXT_GRAY);

  const headers = [
    "KPI Name",
    "Current Value",
    "Target",
    "Variance",
    "% Change",
    "Status",
    "Last Month",
    "YTD Average",
    "Best",
    "Worst",
    "Owner",
    "Last Updated"
  ];

  sheet.getRange(3, 1, 1, headers.length).setValues([headers])
    .setFontWeight("bold")
    .setBackground(COLORS.LIGHT_GRAY)
    .setFontColor(COLORS.TEXT_DARK);

  // Add data validation for Status
  const statusRule = SpreadsheetApp.newDataValidation()
    .requireValueInList(['On Track', 'At Risk', 'Off Track', 'Exceeding'], true)
    .setAllowInvalid(false)
    .build();
  sheet.getRange("F4:F1000").setDataValidation(statusRule);

  sheet.setFrozenRows(3);
  sheet.setTabColor(COLORS.UNION_GREEN);

  // Set column widths
  sheet.setColumnWidth(1, 200);  // KPI Name
  sheet.setColumnWidth(2, 120);  // Current Value
  sheet.setColumnWidth(3, 100);  // Target
  sheet.setColumnWidth(4, 100);  // Variance
  sheet.setColumnWidth(5, 100);  // % Change
  sheet.setColumnWidth(6, 100);  // Status
  sheet.setColumnWidth(7, 100);  // Last Month
  sheet.setColumnWidth(8, 110);  // YTD Average
  sheet.setColumnWidth(9, 80);   // Best
  sheet.setColumnWidth(10, 80);  // Worst
  sheet.setColumnWidth(11, 120); // Owner
  sheet.setColumnWidth(12, 110); // Last Updated
}

function createMemberEngagementSheet() {
  const ss = SpreadsheetApp.getActive();
  let sheet = ss.getSheetByName(SHEETS.MEMBER_ENGAGEMENT);
  if (!sheet) sheet = ss.insertSheet(SHEETS.MEMBER_ENGAGEMENT);
  sheet.clear();
  sheet.getRange("A1:L1").merge().setValue("üë• MEMBER ENGAGEMENT").setFontSize(16).setFontWeight("bold").setHorizontalAlignment("center").setBackground(COLORS.ACCENT_PURPLE).setFontColor("white");
  const headers = ["Member ID", "Name", "Engagement Score", "Last Contact", "Meetings Attended", "Surveys Completed", "Volunteer Hours", "Committee Participation", "Event Attendance", "Email Open Rate", "Status", "Notes"];
  sheet.getRange(3, 1, 1, headers.length).setValues([headers]).setFontWeight("bold").setBackground(COLORS.LIGHT_GRAY);
  sheet.setFrozenRows(3);
  sheet.setTabColor(COLORS.ACCENT_PURPLE);
}

function createCostImpactSheet() {
  const ss = SpreadsheetApp.getActive();
  let sheet = ss.getSheetByName(SHEETS.COST_IMPACT);
  if (!sheet) sheet = ss.insertSheet(SHEETS.COST_IMPACT);
  sheet.clear();
  sheet.getRange("A1:J1").merge().setValue("üí∞ COST IMPACT ANALYSIS").setFontSize(16).setFontWeight("bold").setHorizontalAlignment("center").setBackground(COLORS.SOLIDARITY_RED).setFontColor("white");
  const headers = ["Category", "Estimated Cost", "Actual Cost", "Variance", "ROI", "Cases Affected", "Members Benefited", "Status", "Quarter", "Notes"];
  sheet.getRange(3, 1, 1, headers.length).setValues([headers]).setFontWeight("bold").setBackground(COLORS.LIGHT_GRAY);
  sheet.setFrozenRows(3);
  sheet.setTabColor(COLORS.SOLIDARITY_RED);
}


function createArchiveSheet() {
  const ss = SpreadsheetApp.getActive();
  let sheet = ss.getSheetByName(SHEETS.ARCHIVE);
  if (!sheet) sheet = ss.insertSheet(SHEETS.ARCHIVE);
  sheet.clear();
  sheet.getRange("A1:F1").merge().setValue("üì¶ ARCHIVE").setFontSize(16).setFontWeight("bold").setHorizontalAlignment("center").setBackground(COLORS.TEXT_GRAY).setFontColor("white");
  const headers = ["Item Type", "Item ID", "Archive Date", "Archived By", "Reason", "Original Data"];
  sheet.getRange(3, 1, 1, headers.length).setValues([headers]).setFontWeight("bold").setBackground(COLORS.LIGHT_GRAY);
  sheet.setFrozenRows(3);
  sheet.setTabColor(COLORS.TEXT_GRAY);
}

function createDiagnosticsSheet() {
  const ss = SpreadsheetApp.getActive();
  let sheet = ss.getSheetByName(SHEETS.DIAGNOSTICS);
  if (!sheet) sheet = ss.insertSheet(SHEETS.DIAGNOSTICS);
  sheet.clear();
  sheet.getRange("A1:G1").merge().setValue("üîß DIAGNOSTICS").setFontSize(16).setFontWeight("bold").setHorizontalAlignment("center").setBackground(COLORS.SOLIDARITY_RED).setFontColor("white");
  const headers = ["Timestamp", "Check Type", "Component", "Status", "Details", "Severity", "Action Needed"];
  sheet.getRange(3, 1, 1, headers.length).setValues([headers]).setFontWeight("bold").setBackground(COLORS.LIGHT_GRAY);
  sheet.setFrozenRows(3);
  sheet.setTabColor(COLORS.SOLIDARITY_RED);
}

/* --------------------- DATA VALIDATIONS --------------------- */
function setupDataValidations() {
  const ss = SpreadsheetApp.getActive();
  const config = ss.getSheetByName(SHEETS.CONFIG);
  const memberDir = ss.getSheetByName(SHEETS.MEMBER_DIR);
  const grievanceLog = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  // PERFORMANCE OPTIMIZATION: Use 500 rows for initial setup (30-40% faster)
  // Run extendValidations() later if you need more than 500 rows
  const VALIDATION_ROWS = 500;

  // ENHANCEMENT: Email validation for Member Directory (Column H - Email Address)
  // Using custom formula with REGEXMATCH for pattern validation
  const emailRule = SpreadsheetApp.newDataValidation()
    .requireFormulaSatisfied('=OR(ISBLANK(H2), REGEXMATCH(H2, "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"))')
    .setAllowInvalid(true)
    .setHelpText('Enter a valid email address (e.g., name@example.com)')
    .build();
  memberDir.getRange(2, 8, VALIDATION_ROWS, 1).setDataValidation(emailRule);

  // ENHANCEMENT: Phone number validation for Member Directory (Column I - Phone Number)
  const phoneRule = SpreadsheetApp.newDataValidation()
    .requireFormulaSatisfied('=OR(ISBLANK(I2), REGEXMATCH(TO_TEXT(I2), "^\\(?\\d{3}\\)?[\\s.-]?\\d{3}[\\s.-]?\\d{4}$"))')
    .setAllowInvalid(true)
    .setHelpText('Enter phone number (formats: 555-123-4567, (555) 123-4567, 5551234567)')
    .build();
  memberDir.getRange(2, 9, VALIDATION_ROWS, 1).setDataValidation(phoneRule);

  // ENHANCEMENT: Email validation for Grievance Log (Column X - Member Email)
  const grievanceEmailRule = SpreadsheetApp.newDataValidation()
    .requireFormulaSatisfied('=OR(ISBLANK(X2), REGEXMATCH(X2, "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"))')
    .setAllowInvalid(true)
    .setHelpText('Enter a valid email address (e.g., name@example.com)')
    .build();
  grievanceLog.getRange(2, 24, VALIDATION_ROWS, 1).setDataValidation(grievanceEmailRule);

  // Member Directory validations using MEMBER_COLS constants
  // 31 columns total after adding: Committees, Home Town, Preferred Comm, Best Time
  const memberValidations = [
    { col: MEMBER_COLS.JOB_TITLE, configCol: CONFIG_COLS.JOB_TITLES },       // Job Title (4)
    { col: MEMBER_COLS.WORK_LOCATION, configCol: CONFIG_COLS.OFFICE_LOCATIONS }, // Work Location (5)
    { col: MEMBER_COLS.UNIT, configCol: CONFIG_COLS.UNITS },                 // Unit (6)
    { col: MEMBER_COLS.IS_STEWARD, configCol: CONFIG_COLS.YES_NO },          // Is Steward (10)
    { col: MEMBER_COLS.ASSIGNED_STEWARD, configCol: CONFIG_COLS.STEWARDS },  // Assigned Steward (14)
    { col: MEMBER_COLS.INTEREST_LOCAL, configCol: CONFIG_COLS.YES_NO },      // Interest: Local (21)
    { col: MEMBER_COLS.HOME_TOWN, configCol: CONFIG_COLS.HOME_TOWNS },       // Home Town (22)
    { col: MEMBER_COLS.INTEREST_CHAPTER, configCol: CONFIG_COLS.YES_NO },    // Interest: Chapter (23)
    { col: MEMBER_COLS.INTEREST_ALLIED, configCol: CONFIG_COLS.YES_NO }      // Interest: Allied (24)
  ];

  memberValidations.forEach(function(v) {
    const configRange = config.getRange(3, v.configCol, 50, 1);
    const rule = SpreadsheetApp.newDataValidation()
      .requireValueInRange(configRange, true)
      .setAllowInvalid(false)
      .build();
    memberDir.getRange(2, v.col, VALIDATION_ROWS, 1).setDataValidation(rule);
  });

  // Office Days - allow text input with guidance (column 7)
  // Note: Multiple days should be entered as comma-separated values
  const officeDaysRule = SpreadsheetApp.newDataValidation()
    .requireTextContains("")
    .setAllowInvalid(true)
    .setHelpText('Enter office days (e.g., "Monday, Wednesday, Friday" or select from Config tab)')
    .build();
  memberDir.getRange(2, MEMBER_COLS.OFFICE_DAYS, VALIDATION_ROWS, 1).setDataValidation(officeDaysRule);

  // Supervisor and Manager - allow text input since they're now first+last name combinations
  const nameRule = SpreadsheetApp.newDataValidation()
    .requireTextContains("")
    .setAllowInvalid(true)
    .setHelpText('Enter full name (e.g., "John Smith")')
    .build();
  memberDir.getRange(2, MEMBER_COLS.SUPERVISOR, VALIDATION_ROWS, 1).setDataValidation(nameRule);
  memberDir.getRange(2, MEMBER_COLS.MANAGER, VALIDATION_ROWS, 1).setDataValidation(nameRule);

  // Multi-select columns - allow text input with help text showing available options
  // Committees (column 11) - multi-select for stewards
  const committeesRule = SpreadsheetApp.newDataValidation()
    .requireTextContains("")
    .setAllowInvalid(true)
    .setHelpText('Enter committees (comma-separated, e.g., "Grievance Committee, Bargaining Committee"). See Config tab column AD for options.')
    .build();
  memberDir.getRange(2, MEMBER_COLS.COMMITTEES, VALIDATION_ROWS, 1).setDataValidation(committeesRule);

  // Preferred Communication (column 15) - multi-select
  const prefCommRule = SpreadsheetApp.newDataValidation()
    .requireTextContains("")
    .setAllowInvalid(true)
    .setHelpText('Enter preferred methods (comma-separated, e.g., "Email, Phone, Text"). See Config tab column M for options.')
    .build();
  memberDir.getRange(2, MEMBER_COLS.PREFERRED_COMM, VALIDATION_ROWS, 1).setDataValidation(prefCommRule);

  // Best Time to Contact (column 16) - multi-select
  const bestTimeRule = SpreadsheetApp.newDataValidation()
    .requireTextContains("")
    .setAllowInvalid(true)
    .setHelpText('Enter best times (comma-separated, e.g., "Morning (8am-12pm), Evening (5pm-8pm)"). See Config tab column AE for options.')
    .build();
  memberDir.getRange(2, MEMBER_COLS.BEST_TIME, VALIDATION_ROWS, 1).setDataValidation(bestTimeRule);

  // Grievance Log validations (updated for new Config structure)
  // GRIEVANCE_COLS: STATUS=5, CURRENT_STEP=6, ARTICLES=22, ISSUE_CATEGORY=23, UNIT=25, LOCATION=26, STEWARD=27
  const grievanceValidations = [
    { col: GRIEVANCE_COLS.STATUS, configCol: CONFIG_COLS.GRIEVANCE_STATUS },         // Status
    { col: GRIEVANCE_COLS.CURRENT_STEP, configCol: CONFIG_COLS.GRIEVANCE_STEP },     // Current Step
    { col: GRIEVANCE_COLS.ARTICLES, configCol: CONFIG_COLS.ARTICLES_VIOLATED },      // Articles Violated
    { col: GRIEVANCE_COLS.ISSUE_CATEGORY, configCol: CONFIG_COLS.ISSUE_CATEGORY },   // Issue Category
    { col: GRIEVANCE_COLS.UNIT, configCol: CONFIG_COLS.UNITS },                      // Unit
    { col: GRIEVANCE_COLS.LOCATION, configCol: CONFIG_COLS.OFFICE_LOCATIONS },       // Work Location
    { col: GRIEVANCE_COLS.STEWARD, configCol: CONFIG_COLS.STEWARDS }                 // Assigned Steward
  ];

  grievanceValidations.forEach(function(v) {
    const configRange = config.getRange(3, v.configCol, 50, 1);
    const rule = SpreadsheetApp.newDataValidation()
      .requireValueInRange(configRange, true)
      .setAllowInvalid(false)
      .build();
    grievanceLog.getRange(2, v.col, VALIDATION_ROWS, 1).setDataValidation(rule);
  });

  // ----- CONDITIONAL FORMATTING -----
  // Light purple background for rows where Is Steward = "Yes"
  const isStewardCol = getColumnLetter(MEMBER_COLS.IS_STEWARD);
  const stewardRule = SpreadsheetApp.newConditionalFormatRule()
    .whenFormulaSatisfied('=$' + isStewardCol + '2="Yes"')
    .setBackground('#E8E3F3')  // Light purple (509 theme)
    .setRanges([memberDir.getRange(2, 1, VALIDATION_ROWS, 31)])  // Apply to entire row
    .build();

  const existingRules = memberDir.getConditionalFormatRules();
  existingRules.push(stewardRule);
  memberDir.setConditionalFormatRules(existingRules);
}

/**
 * Extend validations to support large datasets (5000+ rows)
 * Run this after seeding large amounts of data (20k members, 5k grievances)
 * This extends validations from 500 rows to 10000 rows
 */
function extendValidationsForLargeDataset() {
  const ui = SpreadsheetApp.getUi();

  const response = ui.alert(
    'Extend Validations?',
    'This will extend dropdown validations from 500 rows to 10,000 rows.\n\n' +
    'Use this after seeding large datasets (20k members, 5k grievances).\n\n' +
    'This may take 30-60 seconds. Continue?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return;
  }

  const startTime = new Date();
  SpreadsheetApp.getActive().toast('Extending validations...', 'Please wait', -1);

  const ss = SpreadsheetApp.getActive();
  const config = ss.getSheetByName(SHEETS.CONFIG);
  const memberDir = ss.getSheetByName(SHEETS.MEMBER_DIR);
  const grievanceLog = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  const EXTENDED_ROWS = 10000;

  // Member Directory validations
  const memberValidations = [
    { col: MEMBER_COLS.JOB_TITLE, configCol: CONFIG_COLS.JOB_TITLES },
    { col: MEMBER_COLS.WORK_LOCATION, configCol: CONFIG_COLS.OFFICE_LOCATIONS },
    { col: MEMBER_COLS.UNIT, configCol: CONFIG_COLS.UNITS },
    { col: MEMBER_COLS.IS_STEWARD, configCol: CONFIG_COLS.YES_NO },
    { col: MEMBER_COLS.ASSIGNED_STEWARD, configCol: CONFIG_COLS.STEWARDS },
    { col: MEMBER_COLS.INTEREST_LOCAL, configCol: CONFIG_COLS.YES_NO },
    { col: MEMBER_COLS.HOME_TOWN, configCol: CONFIG_COLS.HOME_TOWNS },
    { col: MEMBER_COLS.INTEREST_CHAPTER, configCol: CONFIG_COLS.YES_NO },
    { col: MEMBER_COLS.INTEREST_ALLIED, configCol: CONFIG_COLS.YES_NO }
  ];

  memberValidations.forEach(function(v) {
    const configRange = config.getRange(3, v.configCol, 50, 1);
    const rule = SpreadsheetApp.newDataValidation()
      .requireValueInRange(configRange, true)
      .setAllowInvalid(false)
      .build();
    memberDir.getRange(2, v.col, EXTENDED_ROWS, 1).setDataValidation(rule);
  });

  // Grievance Log validations
  const grievanceValidations = [
    { col: GRIEVANCE_COLS.STATUS, configCol: CONFIG_COLS.GRIEVANCE_STATUS },
    { col: GRIEVANCE_COLS.CURRENT_STEP, configCol: CONFIG_COLS.GRIEVANCE_STEP },
    { col: GRIEVANCE_COLS.ARTICLES, configCol: CONFIG_COLS.ARTICLES_VIOLATED },
    { col: GRIEVANCE_COLS.ISSUE_CATEGORY, configCol: CONFIG_COLS.ISSUE_CATEGORY },
    { col: GRIEVANCE_COLS.UNIT, configCol: CONFIG_COLS.UNITS },
    { col: GRIEVANCE_COLS.LOCATION, configCol: CONFIG_COLS.OFFICE_LOCATIONS },
    { col: GRIEVANCE_COLS.STEWARD, configCol: CONFIG_COLS.STEWARDS }
  ];

  grievanceValidations.forEach(function(v) {
    const configRange = config.getRange(3, v.configCol, 50, 1);
    const rule = SpreadsheetApp.newDataValidation()
      .requireValueInRange(configRange, true)
      .setAllowInvalid(false)
      .build();
    grievanceLog.getRange(2, v.col, EXTENDED_ROWS, 1).setDataValidation(rule);
  });

  const duration = (new Date() - startTime) / 1000;

  ui.alert(
    'Validations Extended',
    `Successfully extended validations to ${EXTENDED_ROWS.toLocaleString()} rows.\n\n` +
    `Time: ${duration.toFixed(1)} seconds`,
    ui.ButtonSet.OK
  );
}

/* --------------------- FORMULAS --------------------- */
function setupFormulasAndCalculations() {
  const ss = SpreadsheetApp.getActive();
  const grievanceLog = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  const memberDir = ss.getSheetByName(SHEETS.MEMBER_DIR);

  // ----- GRIEVANCE LOG FORMULAS -----
  // All using dynamic column references from GRIEVANCE_COLS
  const gIncidentDateCol = getColumnLetter(GRIEVANCE_COLS.INCIDENT_DATE);
  const gFilingDeadlineCol = getColumnLetter(GRIEVANCE_COLS.FILING_DEADLINE);
  const gDateFiledCol = getColumnLetter(GRIEVANCE_COLS.DATE_FILED);
  const gStep1DueCol = getColumnLetter(GRIEVANCE_COLS.STEP1_DUE);
  const gStep1RcvdCol = getColumnLetter(GRIEVANCE_COLS.STEP1_RCVD);
  const gStep2AppealDueCol = getColumnLetter(GRIEVANCE_COLS.STEP2_APPEAL_DUE);
  const gStep2AppealFiledCol = getColumnLetter(GRIEVANCE_COLS.STEP2_APPEAL_FILED);
  const gStep2DueCol = getColumnLetter(GRIEVANCE_COLS.STEP2_DUE);
  const gStep2RcvdCol = getColumnLetter(GRIEVANCE_COLS.STEP2_RCVD);
  const gStep3AppealDueCol = getColumnLetter(GRIEVANCE_COLS.STEP3_APPEAL_DUE);
  const gDateClosedCol = getColumnLetter(GRIEVANCE_COLS.DATE_CLOSED);
  const gDaysOpenCol = getColumnLetter(GRIEVANCE_COLS.DAYS_OPEN);
  const gNextActionCol = getColumnLetter(GRIEVANCE_COLS.NEXT_ACTION_DUE);
  const gDaysToDeadlineCol = getColumnLetter(GRIEVANCE_COLS.DAYS_TO_DEADLINE);
  const gStatusCol = getColumnLetter(GRIEVANCE_COLS.STATUS);
  const gCurrentStepCol = getColumnLetter(GRIEVANCE_COLS.CURRENT_STEP);
  const gMemberIdCol = getColumnLetter(GRIEVANCE_COLS.MEMBER_ID);

  // Filing Deadline (Incident Date + 21 days) - Column H
  grievanceLog.getRange(gFilingDeadlineCol + "2").setFormula(
    `=ARRAYFORMULA(IF(${gIncidentDateCol}2:${gIncidentDateCol}10000<>"",${gIncidentDateCol}2:${gIncidentDateCol}10000+21,""))`
  );

  // Step I Decision Due (Date Filed + 30 days) - Column J
  grievanceLog.getRange(gStep1DueCol + "2").setFormula(
    `=ARRAYFORMULA(IF(${gDateFiledCol}2:${gDateFiledCol}10000<>"",${gDateFiledCol}2:${gDateFiledCol}10000+30,""))`
  );

  // Step II Appeal Due (Step I Decision Rcvd + 10 days) - Column L
  grievanceLog.getRange(gStep2AppealDueCol + "2").setFormula(
    `=ARRAYFORMULA(IF(${gStep1RcvdCol}2:${gStep1RcvdCol}10000<>"",${gStep1RcvdCol}2:${gStep1RcvdCol}10000+10,""))`
  );

  // Step II Decision Due (Step II Appeal Filed + 30 days) - Column N
  grievanceLog.getRange(gStep2DueCol + "2").setFormula(
    `=ARRAYFORMULA(IF(${gStep2AppealFiledCol}2:${gStep2AppealFiledCol}10000<>"",${gStep2AppealFiledCol}2:${gStep2AppealFiledCol}10000+30,""))`
  );

  // Step III Appeal Due (Step II Decision Rcvd + 30 days) - Column P
  grievanceLog.getRange(gStep3AppealDueCol + "2").setFormula(
    `=ARRAYFORMULA(IF(${gStep2RcvdCol}2:${gStep2RcvdCol}10000<>"",${gStep2RcvdCol}2:${gStep2RcvdCol}10000+30,""))`
  );

  // Days Open - Column S (shows actual days - negative values indicate data entry errors)
  grievanceLog.getRange(gDaysOpenCol + "2").setFormula(
    `=ARRAYFORMULA(IF(${gDateFiledCol}2:${gDateFiledCol}10000<>"",IF(${gDateClosedCol}2:${gDateClosedCol}10000<>"",${gDateClosedCol}2:${gDateClosedCol}10000-${gDateFiledCol}2:${gDateFiledCol}10000,TODAY()-${gDateFiledCol}2:${gDateFiledCol}10000),""))`
  );

  // Next Action Due - Column T (determines based on current step)
  grievanceLog.getRange(gNextActionCol + "2").setFormula(
    `=ARRAYFORMULA(IF(${gStatusCol}2:${gStatusCol}10000="Open",IF(${gCurrentStepCol}2:${gCurrentStepCol}10000="Step I",${gStep1DueCol}2:${gStep1DueCol}10000,IF(${gCurrentStepCol}2:${gCurrentStepCol}10000="Step II",${gStep2DueCol}2:${gStep2DueCol}10000,IF(${gCurrentStepCol}2:${gCurrentStepCol}10000="Step III",${gStep3AppealDueCol}2:${gStep3AppealDueCol}10000,${gFilingDeadlineCol}2:${gFilingDeadlineCol}10000))),""))`
  );

  // Days to Deadline - Column U (shows descriptive text for overdue items)
  // Positive = days remaining, 0 = "DUE TODAY", Negative = "OVERDUE Xd"
  grievanceLog.getRange(gDaysToDeadlineCol + "2").setFormula(
    `=ARRAYFORMULA(IF(${gNextActionCol}2:${gNextActionCol}10000<>"",IF(${gNextActionCol}2:${gNextActionCol}10000-TODAY()<0,"OVERDUE "&ABS(${gNextActionCol}2:${gNextActionCol}10000-TODAY())&"d",IF(${gNextActionCol}2:${gNextActionCol}10000-TODAY()=0,"DUE TODAY",${gNextActionCol}2:${gNextActionCol}10000-TODAY())),""))`
  );

  // Add conditional formatting for Days to Deadline column
  const daysToDeadlineRange = grievanceLog.getRange(gDaysToDeadlineCol + "2:" + gDaysToDeadlineCol + "1000");

  // Rule 1: OVERDUE - Red background
  const overdueRule = SpreadsheetApp.newConditionalFormatRule()
    .whenTextContains("OVERDUE")
    .setBackground("#FEE2E2")  // Light red
    .setFontColor("#DC2626")   // Dark red text
    .setBold(true)
    .setRanges([daysToDeadlineRange])
    .build();

  // Rule 2: DUE TODAY - Orange background
  const dueTodayRule = SpreadsheetApp.newConditionalFormatRule()
    .whenTextEqualTo("DUE TODAY")
    .setBackground("#FEF3C7")  // Light amber
    .setFontColor("#D97706")   // Dark amber text
    .setBold(true)
    .setRanges([daysToDeadlineRange])
    .build();

  // Rule 3: Due within 7 days - Yellow background (numbers 1-7)
  const dueSoonRule = SpreadsheetApp.newConditionalFormatRule()
    .whenNumberBetween(1, 7)
    .setBackground("#FEF9C3")  // Light yellow
    .setFontColor("#CA8A04")   // Dark yellow text
    .setRanges([daysToDeadlineRange])
    .build();

  // Rule 4: More than 7 days - Green background
  const onTrackRule = SpreadsheetApp.newConditionalFormatRule()
    .whenNumberGreaterThan(7)
    .setBackground("#DCFCE7")  // Light green
    .setFontColor("#16A34A")   // Dark green text
    .setRanges([daysToDeadlineRange])
    .build();

  // Apply all rules
  const existingRules = grievanceLog.getConditionalFormatRules();
  grievanceLog.setConditionalFormatRules([overdueRule, dueTodayRule, dueSoonRule, onTrackRule, ...existingRules]);

  // ----- MEMBER DIRECTORY FORMULAS -----
  // Has Open Grievance? - Column Y (25)
  // Counts grievances with ANY active status: Open, Pending Info, Appealed, In Arbitration
  const hasGrievanceCol = getColumnLetter(MEMBER_COLS.HAS_OPEN_GRIEVANCE);
  memberDir.getRange(hasGrievanceCol + "2").setFormula(
    `=ARRAYFORMULA(IF(A2:A25000<>"",IF(SUMPRODUCT((('Grievance Log'!${gMemberIdCol}:${gMemberIdCol}=A2:A25000)*(('Grievance Log'!${gStatusCol}:${gStatusCol}="Open")+('Grievance Log'!${gStatusCol}:${gStatusCol}="Pending Info")+('Grievance Log'!${gStatusCol}:${gStatusCol}="Appealed")+('Grievance Log'!${gStatusCol}:${gStatusCol}="In Arbitration"))))>0,"Yes","No"),""))`
  );

  // Grievance Status Snapshot - Column Z (26)
  const statusSnapshotCol = getColumnLetter(MEMBER_COLS.GRIEVANCE_STATUS);
  memberDir.getRange(statusSnapshotCol + "2").setFormula(
    `=ARRAYFORMULA(IF(A2:A25000<>"",IFERROR(INDEX('Grievance Log'!${gStatusCol}:${gStatusCol},MATCH(A2:A25000,'Grievance Log'!${gMemberIdCol}:${gMemberIdCol},0)),""),""))`
  );

  // Next Grievance Deadline - Column AA (27)
  const nextDeadlineCol = getColumnLetter(MEMBER_COLS.NEXT_DEADLINE);
  memberDir.getRange(nextDeadlineCol + "2").setFormula(
    `=ARRAYFORMULA(IF(A2:A25000<>"",IFERROR(INDEX('Grievance Log'!${gNextActionCol}:${gNextActionCol},MATCH(A2:A25000,'Grievance Log'!${gMemberIdCol}:${gMemberIdCol},0)),""),""))`
  );

  // Apply progress bar formatting
  setupGrievanceProgressBar();
}

/**
 * Sets up visual progress bar formatting for Grievance Log timeline columns (G-R)
 * - Completed steps: Green background
 * - Current step: Yellow/amber highlight
 * - Future steps: Light gray (faded)
 * - Closed/Settled/Withdrawn: Full green bar
 */
function setupGrievanceProgressBar() {
  const ss = SpreadsheetApp.getActive();
  const grievanceLog = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  if (!grievanceLog) return;

  // Clear existing conditional formatting rules for timeline columns
  const existingRules = grievanceLog.getConditionalFormatRules();
  const newRules = existingRules.filter(rule => {
    const ranges = rule.getRanges();
    // Keep rules that don't affect columns G-R (7-18)
    return !ranges.some(r => r.getColumn() >= 7 && r.getColumn() <= 18);
  });

  // Timeline columns: G(7) to R(18)
  const timelineRange = grievanceLog.getRange(2, 7, 1000, 12); // G2:R1001

  // Column references
  const statusCol = getColumnLetter(GRIEVANCE_COLS.STATUS);
  const stepCol = getColumnLetter(GRIEVANCE_COLS.CURRENT_STEP);

  // Colors
  const COMPLETED_GREEN = '#D1FAE5';  // Light green for completed steps
  const CURRENT_AMBER = '#FEF3C7';    // Amber for current step
  const FUTURE_GRAY = '#F3F4F6';      // Light gray for future steps
  const CLOSED_GREEN = '#A7F3D0';     // Darker green for closed cases

  // ----- CLOSED/SETTLED/WITHDRAWN - Full green bar -----
  const closedRule = SpreadsheetApp.newConditionalFormatRule()
    .whenFormulaSatisfied(`=OR($${statusCol}2="Settled",$${statusCol}2="Closed",$${statusCol}2="Withdrawn",$${statusCol}2="Denied")`)
    .setBackground(CLOSED_GREEN)
    .setRanges([timelineRange])
    .build();
  newRules.push(closedRule);

  // Helper: Active statuses formula part (Open, Pending Info, Appealed, In Arbitration)
  const activeStatusCondition = `OR($${statusCol}2="Open",$${statusCol}2="Pending Info",$${statusCol}2="Appealed",$${statusCol}2="In Arbitration")`;

  // ----- INFORMAL STEP (Pre-filing): Highlight G-H -----
  const informalCurrentRule = SpreadsheetApp.newConditionalFormatRule()
    .whenFormulaSatisfied(`=AND($${stepCol}2="Informal",${activeStatusCondition})`)
    .setBackground(CURRENT_AMBER)
    .setRanges([grievanceLog.getRange(2, 7, 1000, 2)]) // G-H
    .build();
  newRules.push(informalCurrentRule);

  // Gray out future columns when at Informal
  const informalFutureRule = SpreadsheetApp.newConditionalFormatRule()
    .whenFormulaSatisfied(`=AND($${stepCol}2="Informal",${activeStatusCondition})`)
    .setBackground(FUTURE_GRAY)
    .setFontColor('#9CA3AF')
    .setRanges([grievanceLog.getRange(2, 9, 1000, 10)]) // I-R (future)
    .build();
  newRules.push(informalFutureRule);

  // ----- STEP I: Highlight I-K, green G-H, gray L-R -----
  const step1CompletedRule = SpreadsheetApp.newConditionalFormatRule()
    .whenFormulaSatisfied(`=AND($${stepCol}2="Step I",${activeStatusCondition})`)
    .setBackground(COMPLETED_GREEN)
    .setRanges([grievanceLog.getRange(2, 7, 1000, 2)]) // G-H completed
    .build();
  newRules.push(step1CompletedRule);

  const step1CurrentRule = SpreadsheetApp.newConditionalFormatRule()
    .whenFormulaSatisfied(`=AND($${stepCol}2="Step I",${activeStatusCondition})`)
    .setBackground(CURRENT_AMBER)
    .setRanges([grievanceLog.getRange(2, 9, 1000, 3)]) // I-K current
    .build();
  newRules.push(step1CurrentRule);

  const step1FutureRule = SpreadsheetApp.newConditionalFormatRule()
    .whenFormulaSatisfied(`=AND($${stepCol}2="Step I",${activeStatusCondition})`)
    .setBackground(FUTURE_GRAY)
    .setFontColor('#9CA3AF')
    .setRanges([grievanceLog.getRange(2, 12, 1000, 7)]) // L-R future
    .build();
  newRules.push(step1FutureRule);

  // ----- STEP II: Highlight L-O, green G-K, gray P-R -----
  const step2CompletedRule = SpreadsheetApp.newConditionalFormatRule()
    .whenFormulaSatisfied(`=AND($${stepCol}2="Step II",${activeStatusCondition})`)
    .setBackground(COMPLETED_GREEN)
    .setRanges([grievanceLog.getRange(2, 7, 1000, 5)]) // G-K completed
    .build();
  newRules.push(step2CompletedRule);

  const step2CurrentRule = SpreadsheetApp.newConditionalFormatRule()
    .whenFormulaSatisfied(`=AND($${stepCol}2="Step II",${activeStatusCondition})`)
    .setBackground(CURRENT_AMBER)
    .setRanges([grievanceLog.getRange(2, 12, 1000, 4)]) // L-O current
    .build();
  newRules.push(step2CurrentRule);

  const step2FutureRule = SpreadsheetApp.newConditionalFormatRule()
    .whenFormulaSatisfied(`=AND($${stepCol}2="Step II",${activeStatusCondition})`)
    .setBackground(FUTURE_GRAY)
    .setFontColor('#9CA3AF')
    .setRanges([grievanceLog.getRange(2, 16, 1000, 3)]) // P-R future
    .build();
  newRules.push(step2FutureRule);

  // ----- STEP III: Highlight P-Q, green G-O, gray R -----
  const step3CompletedRule = SpreadsheetApp.newConditionalFormatRule()
    .whenFormulaSatisfied(`=AND($${stepCol}2="Step III",${activeStatusCondition})`)
    .setBackground(COMPLETED_GREEN)
    .setRanges([grievanceLog.getRange(2, 7, 1000, 9)]) // G-O completed
    .build();
  newRules.push(step3CompletedRule);

  const step3CurrentRule = SpreadsheetApp.newConditionalFormatRule()
    .whenFormulaSatisfied(`=AND($${stepCol}2="Step III",${activeStatusCondition})`)
    .setBackground(CURRENT_AMBER)
    .setRanges([grievanceLog.getRange(2, 16, 1000, 2)]) // P-Q current
    .build();
  newRules.push(step3CurrentRule);

  const step3FutureRule = SpreadsheetApp.newConditionalFormatRule()
    .whenFormulaSatisfied(`=AND($${stepCol}2="Step III",${activeStatusCondition})`)
    .setBackground(FUTURE_GRAY)
    .setFontColor('#9CA3AF')
    .setRanges([grievanceLog.getRange(2, 18, 1000, 1)]) // R future
    .build();
  newRules.push(step3FutureRule);

  // ----- ARBITRATION/MEDIATION: Green G-Q, amber R -----
  const arbMedCompletedRule = SpreadsheetApp.newConditionalFormatRule()
    .whenFormulaSatisfied(`=AND(OR($${stepCol}2="Arbitration",$${stepCol}2="Mediation"),${activeStatusCondition})`)
    .setBackground(COMPLETED_GREEN)
    .setRanges([grievanceLog.getRange(2, 7, 1000, 11)]) // G-Q completed
    .build();
  newRules.push(arbMedCompletedRule);

  const arbMedCurrentRule = SpreadsheetApp.newConditionalFormatRule()
    .whenFormulaSatisfied(`=AND(OR($${stepCol}2="Arbitration",$${stepCol}2="Mediation"),${activeStatusCondition})`)
    .setBackground(CURRENT_AMBER)
    .setRanges([grievanceLog.getRange(2, 18, 1000, 1)]) // R current (awaiting close)
    .build();
  newRules.push(arbMedCurrentRule);

  grievanceLog.setConditionalFormatRules(newRules);
}

/**
 * Sorts Grievance Log to move completed grievances to bottom
 * Call this manually or set up a trigger to run periodically
 */
function sortGrievancesByStatus() {
  const ss = SpreadsheetApp.getActive();
  const grievanceLog = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  if (!grievanceLog) return;

  const lastRow = grievanceLog.getLastRow();
  if (lastRow <= 1) return;

  const lastCol = grievanceLog.getLastColumn();
  const dataRange = grievanceLog.getRange(2, 1, lastRow - 1, lastCol);

  // Sort by Status - Open/Pending first, then Closed/Settled/Withdrawn/Denied
  // Custom sort: Open=1, Pending Info=2, Appealed=3, In Arbitration=4, others=5
  const statusCol = GRIEVANCE_COLS.STATUS;

  dataRange.sort([
    { column: statusCol, ascending: true }
  ]);

  SpreadsheetApp.getActive().toast('‚úÖ Grievances sorted - active cases at top, completed at bottom', 'Sorted', 3);
}

/**
 * Cleans up Grievance Log by removing extra columns and reapplying formulas
 * Use this when data appears misaligned or there are extra columns
 */
function cleanupGrievanceLog() {
  const ss = SpreadsheetApp.getActive();
  const grievanceLog = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  if (!grievanceLog) {
    SpreadsheetApp.getUi().alert('Grievance Log sheet not found');
    return;
  }

  const EXPECTED_COLS = 28; // A through AB
  const lastCol = grievanceLog.getLastColumn();

  // Delete extra columns beyond AB (28)
  if (lastCol > EXPECTED_COLS) {
    const extraCols = lastCol - EXPECTED_COLS;
    grievanceLog.deleteColumns(EXPECTED_COLS + 1, extraCols);
    SpreadsheetApp.getActive().toast(`Removed ${extraCols} extra column(s)`, 'Cleanup', 2);
  }

  // Reapply headers to ensure correct column names
  const headers = [
    "Grievance ID", "Member ID", "First Name", "Last Name", "Status", "Current Step",
    "Incident Date", "Filing Deadline (21d)", "Date Filed (Step I)", "Step I Decision Due (30d)",
    "Step I Decision Rcvd", "Step II Appeal Due (10d)", "Step II Appeal Filed", "Step II Decision Due (30d)",
    "Step II Decision Rcvd", "Step III Appeal Due (30d)", "Step III Appeal Filed", "Date Closed",
    "Days Open", "Next Action Due", "Days to Deadline", "Articles Violated", "Issue Category",
    "Member Email", "Unit", "Work Location (Site)", "Assigned Steward (Name)", "Resolution Summary"
  ];
  grievanceLog.getRange(1, 1, 1, headers.length).setValues([headers]);

  // Clear any existing formulas in calculated columns before reapplying
  const calculatedCols = [
    GRIEVANCE_COLS.FILING_DEADLINE,    // H
    GRIEVANCE_COLS.STEP1_DUE,          // J
    GRIEVANCE_COLS.STEP2_APPEAL_DUE,   // L
    GRIEVANCE_COLS.STEP2_DUE,          // N
    GRIEVANCE_COLS.STEP3_APPEAL_DUE,   // P
    GRIEVANCE_COLS.DAYS_OPEN,          // S
    GRIEVANCE_COLS.NEXT_ACTION_DUE,    // T
    GRIEVANCE_COLS.DAYS_TO_DEADLINE    // U
  ];

  const lastRow = Math.max(grievanceLog.getLastRow(), 2);
  calculatedCols.forEach(col => {
    grievanceLog.getRange(2, col, lastRow - 1, 1).clearContent();
  });

  // Reapply all formulas
  setupFormulasAndCalculations();

  SpreadsheetApp.getActive().toast('‚úÖ Grievance Log cleaned up and formulas reapplied', 'Complete', 3);
}

/* --------------------- SETUP MENU VISIBILITY --------------------- */
/**
 * Property key for storing Setup menu visibility state
 */
const SETUP_MENU_HIDDEN_KEY = 'setupMenuHidden';

/**
 * Checks if the Setup menu should be hidden
 * @returns {boolean} True if Setup menu should be hidden
 */
function isSetupMenuHidden() {
  const props = PropertiesService.getDocumentProperties();
  return props.getProperty(SETUP_MENU_HIDDEN_KEY) === 'true';
}

/**
 * Sets the Setup menu visibility state
 * @param {boolean} hidden - True to hide the Setup menu
 */
function setSetupMenuHidden(hidden) {
  const props = PropertiesService.getDocumentProperties();
  props.setProperty(SETUP_MENU_HIDDEN_KEY, hidden ? 'true' : 'false');
}

/**
 * Toggles the Setup menu visibility
 * Called from Admin menu
 */
function toggleSetupMenuVisibility() {
  const currentlyHidden = isSetupMenuHidden();
  setSetupMenuHidden(!currentlyHidden);

  const ui = SpreadsheetApp.getUi();
  const newState = !currentlyHidden ? 'hidden' : 'visible';

  ui.alert(
    'üöÄ Setup Menu ' + (newState === 'hidden' ? 'Hidden' : 'Restored'),
    'The Setup menu is now ' + newState + '.\n\n' +
    'Please refresh the page (F5) or close and reopen the spreadsheet to see the change.\n\n' +
    'You can toggle this setting anytime from:\n‚öôÔ∏è Admin > üëÅÔ∏è View & Display > ' +
    (newState === 'hidden' ? 'Show Setup Menu' : 'Hide Setup Menu'),
    ui.ButtonSet.OK
  );
}

/* --------------------- MENU --------------------- */
/**
 * Runs when spreadsheet opens - creates menu and validates configuration
 */
function onOpen() {
  // Validate configuration on startup
  const configValid = validateConfigurationOnOpen();

  // Wrap UI operations in try-catch to handle contexts where UI isn't available
  // (e.g., when called from time-driven triggers or CREATE_509_DASHBOARD)
  let ui;
  try {
    ui = SpreadsheetApp.getUi();
  } catch (e) {
    // UI not available in this context (trigger, API call, etc.) - skip menu creation
    Logger.log('onOpen: UI not available, skipping menu creation. Context: ' + e.message);
    return;
  }

  // ============ üöÄ FIRST TIME SETUP MENU ============
  // Put this first so new users see it immediately
  // Can be hidden via Admin > View & Display > Hide Setup Menu
  if (!isSetupMenuHidden()) {
    ui.createMenu("üöÄ Setup")
      .addItem("üìö Getting Started Guide", "showGettingStartedGuide")
      .addItem("‚ùì Help", "showHelp")
      .addSeparator()
      .addSubMenu(ui.createMenu("1Ô∏è‚É£ Initial Setup (Run First)")
        .addItem("üé® Setup Dashboard Enhancements", "SETUP_DASHBOARD_ENHANCEMENTS")
        .addItem("üìã Setup Member Directory Dropdowns", "setupMemberDirectoryDropdowns")
        .addItem("üîÑ Refresh Steward Dropdowns", "refreshStewardDropdowns"))
      .addSeparator()
      .addSubMenu(ui.createMenu("2Ô∏è‚É£ Enable Automations")
        .addItem("‚úÖ Enable Automated Backups", "setupAutomatedBackups")
        .addItem("‚úÖ Enable Daily Deadline Notifications", "setupDailyDeadlineNotifications")
        .addItem("‚úÖ Enable Monthly Reports", "setupMonthlyReports")
        .addItem("‚úÖ Enable Quarterly Reports", "setupQuarterlyReports"))
      .addSeparator()
      .addSubMenu(ui.createMenu("3Ô∏è‚É£ Verify Setup")
        .addItem("üß™ Run All Tests", "runAllTests")
        .addItem("üìä View Test Results", "showTestResults")
        .addItem("üîß Diagnose Setup", "DIAGNOSE_SETUP")
        .addItem("üè• Run Health Check", "performSystemHealthCheck"))
      .addToUi();
  }

  // ============ üë§ DAILY USE MENU ============
  ui.createMenu("üë§ Dashboard")
    .addItem("üîÑ Refresh All", "refreshCalculations")
    .addSeparator()
    .addSubMenu(ui.createMenu("üîç Search & Lookup")
      .addItem("üîç Search Members", "showMemberSearch")
      .addItem("üîç Quick Member Search", "quickMemberSearch")
      .addSeparator()
      .addItem("üîç Mobile Search (Members & Grievances)", "showMobileUnifiedSearch"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üìã Grievance Tools")
      .addItem("‚ûï Start New Grievance", "showStartGrievanceDialog")
      .addItem("üîÑ Grievance Float Toggle", "toggleGrievanceFloat")
      .addItem("üéõÔ∏è Float Control Panel", "showGrievanceFloatPanel")
      .addSeparator()
      .addItem("üìß Send Coordinator Message", "showCoordinatorMessageDialog")
      .addItem("üìß Batch Coordinator Notification", "showBatchCoordinatorNotification")
      .addItem("üîß Setup Notification Trigger", "setupCoordinatorNotificationTrigger")
      .addItem("üßπ Clear All Notifications", "clearAllCoordinatorNotifications")
      .addSeparator()
      .addItem("üìä Sort Grievances (Active First)", "sortGrievancesByStatus")
      .addItem("üîÑ Refresh Progress Bar", "setupGrievanceProgressBar")
      .addItem("üßπ Cleanup Grievance Log", "cleanupGrievanceLog")
      .addSeparator()
      .addItem("üÜî Generate Next Grievance ID", "showNextGrievanceID"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üë• Member Tools")
      .addItem("üë• Mobile Member Browser", "showMobileMemberBrowser")
      .addItem("üÜî Generate Next Member ID", "showNextMemberID"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üìù Forms")
      .addItem("üìã Open Grievance Form", "openGrievanceForm")
      .addItem("üìû Open Contact Form", "openContactForm")
      .addSeparator()
      .addItem("üìù Open Member Google Form", "openMemberGoogleForm"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üìä Dashboards")
      .addItem("üìä Main Dashboard", "goToDashboard")
      .addItem("üéØ Unified Operations Monitor", "showUnifiedOperationsMonitor")
      .addItem("‚ú® Interactive Dashboard", "openInteractiveDashboard")
      .addSeparator()
      .addItem("üì± Mobile Dashboard", "showMobileDashboard")
      .addItem("üîÑ Refresh Interactive Dashboard", "rebuildInteractiveDashboard"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üìÅ Google Drive")
      .addItem("üìÅ Setup Folder for Grievance", "setupDriveFolderForGrievance")
      .addItem("üìé Upload Files", "showFileUploadDialog")
      .addItem("üìÇ Show Grievance Files", "showGrievanceFiles"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üìß Communications")
      .addItem("üìß Compose Email", "composeGrievanceEmail")
      .addItem("üìù Email Templates", "showEmailTemplateManager")
      .addSeparator()
      .addItem("üìû View Communications Log", "showGrievanceCommunications"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üìä Reports & Export")
      .addItem("üìä Custom Report Builder", "showCustomReportBuilder")
      .addSeparator()
      .addItem("üìÑ Export Grievances to CSV", "exportGrievancesToCSV")
      .addItem("üìÑ Export Members to CSV", "exportMembersToCSV"))
    .addSeparator()
    .addSubMenu(ui.createMenu("‚ôø Accessibility")
      .addItem("üåô Quick Toggle Dark Mode", "quickToggleDarkMode")
      .addItem("üéØ Activate Focus Mode", "activateFocusMode")
      .addItem("üéØ Deactivate Focus Mode", "deactivateFocusMode")
      .addSeparator()
      .addItem("‚ôø ADHD Control Panel", "showADHDControlPanel")
      .addItem("üé® Theme Manager", "showThemeManager"))
    .addSeparator()
    .addItem("‚å®Ô∏è Keyboard Shortcuts", "showKeyboardShortcuts")
    .addToUi();

  // ============ üìä SHEET MANAGER MENU ============
  ui.createMenu("üìä Manager")
    .addSubMenu(ui.createMenu("üíæ Backup & Recovery")
      .addItem("üíæ Create Backup Now", "createBackup")
      .addItem("üíæ Backup & Recovery Manager", "showBackupManager")
      .addSeparator()
      .addItem("üìä View Backup Log", "navigateToBackupLog")
      .addSeparator()
      .addItem("üîï Disable Automated Backups", "disableAutomatedBackups"))
    .addSeparator()
    .addSubMenu(ui.createMenu("ü§ñ Smart Assignment")
      .addItem("ü§ñ Auto-Assign Steward", "showAutoAssignDialog")
      .addItem("üë• Steward Workload Dashboard", "showStewardWorkloadDashboard")
      .addSeparator()
      .addItem("üì¶ Batch Auto-Assign", "batchAutoAssign"))
    .addSeparator()
    .addSubMenu(ui.createMenu("‚ö° Batch Operations")
      .addItem("‚ö° Show Batch Operations Menu", "showBatchOperationsMenu")
      .addSeparator()
      .addItem("üë§ Bulk Assign Steward", "batchAssignSteward")
      .addItem("üìä Bulk Update Status", "batchUpdateStatus")
      .addItem("üìÑ Bulk Export to PDF", "batchExportPDF")
      .addItem("üìß Bulk Email Notifications", "batchEmailNotifications")
      .addItem("üìù Bulk Add Notes", "batchAddNotes"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üìÖ Calendar & Deadlines")
      .addItem("üìÖ Sync Deadlines to Calendar", "syncDeadlinesToCalendar")
      .addItem("üëÄ View Upcoming Deadlines", "showUpcomingDeadlinesFromCalendar")
      .addSeparator()
      .addItem("üóëÔ∏è Clear All Calendar Events", "clearAllCalendarEvents"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üìà Analytics & Insights")
      .addItem("üîÆ Predictive Analytics Dashboard", "showPredictiveAnalyticsDashboard")
      .addItem("üìà Generate Full Analysis", "performPredictiveAnalysis")
      .addItem("üî¨ Root Cause Analysis", "showRootCauseAnalysisDashboard"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üîí Data Integrity")
      .addItem("üìä Data Quality Dashboard", "showDataQualityDashboard")
      .addItem("üîç Check Referential Integrity", "checkReferentialIntegrity")
      .addSeparator()
      .addItem("üìù Create Change Log Sheet", "createChangeLogSheet"))
    .addSeparator()
    .addSubMenu(ui.createMenu("‚ö° Performance & Cache")
      .addItem("üóÑÔ∏è Cache Status Dashboard", "showCacheStatusDashboard")
      .addItem("üî• Warm Up All Caches", "warmUpCaches")
      .addItem("üóëÔ∏è Clear All Caches", "invalidateAllCaches"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üìß Test Communications")
      .addItem("üß™ Test Deadline Notifications", "testDeadlineNotifications")
      .addItem("üß™ Test Monthly Report", "generateMonthlyReport")
      .addItem("üß™ Test Quarterly Report", "generateQuarterlyReport"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üîï Disable Automations")
      .addItem("üîï Disable Deadline Notifications", "disableDailyDeadlineNotifications")
      .addItem("üîï Disable All Reports", "disableAutomatedReports"))
    .addToUi();

  // ============ ‚öôÔ∏è ADMINISTRATOR MENU ============
  ui.createMenu("‚öôÔ∏è Admin")
    .addSubMenu(ui.createMenu("‚ö†Ô∏è System Health")
      .addItem("üè• Run Health Check", "performSystemHealthCheck")
      .addItem("‚ö†Ô∏è Error Dashboard", "showErrorDashboard")
      .addSeparator()
      .addItem("üìä View Error Trends", "createErrorTrendReport")
      .addItem("üß™ Test Error Logging", "testErrorLogging"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üîÑ Workflow Management")
      .addItem("üìä View Current State", "showCurrentWorkflowState")
      .addItem("üîÑ Workflow Visualizer", "showWorkflowVisualizer")
      .addItem("üîÑ Change Workflow State", "changeWorkflowState")
      .addSeparator()
      .addItem("üì¶ Batch Update State", "batchUpdateWorkflowState"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üëÅÔ∏è View & Display")
      .addItem(isSetupMenuHidden() ? "üöÄ Show Setup Menu" : "üöÄ Hide Setup Menu", "toggleSetupMenuVisibility")
      .addSeparator()
      .addItem("üìä Toggle Engagement Metrics", "toggleEngagementMetricsColumns")
      .addItem("üí° Toggle Member Interests", "toggleMemberInterestsColumns")
      .addItem("üìäüí° Toggle Both (Metrics & Interests)", "toggleEngagementAndInterestsColumns")
      .addSeparator()
      .addItem("Toggle Level 2 Member Columns", "toggleLevel2Columns")
      .addItem("Show All Member Columns", "showAllMemberColumns")
      .addSeparator()
      .addItem("Reorder Sheets Logically", "reorderSheetsLogically")
      .addItem("üëÅÔ∏è Hide Diagnostics Tab", "hideDiagnosticsTab")
      .addSeparator()
      .addItem("Hide Gridlines (Focus Mode)", "hideAllGridlines")
      .addItem("Show Gridlines", "showAllGridlines")
      .addItem("Setup ADHD Defaults", "setupADHDDefaults"))
    .addSeparator()
    .addSubMenu(ui.createMenu("‚Ü©Ô∏è History & Undo")
      .addItem("‚Ü©Ô∏è Undo Last Action (Ctrl+Z)", "undoLastAction")
      .addItem("‚Ü™Ô∏è Redo Last Action (Ctrl+Y)", "redoLastAction")
      .addSeparator()
      .addItem("‚Ü©Ô∏è Undo/Redo History", "showUndoRedoPanel")
      .addItem("‚å®Ô∏è Install Undo Shortcuts", "installUndoRedoShortcuts")
      .addSeparator()
      .addItem("üóëÔ∏è Clear Undo History", "clearUndoHistory"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üì± Mobile Views")
      .addItem("üì± Mobile Dashboard", "showMobileDashboard")
      .addItem("üîç Mobile Search", "showMobileUnifiedSearch")
      .addItem("üë• Mobile Member Browser", "showMobileMemberBrowser")
      .addItem("üìã Mobile Grievance Browser", "showMobileGrievanceBrowser")
      .addSeparator()
      .addItem("üìã Mobile Grievance List", "showMobileGrievanceList")
      .addItem("üìÑ Paginated Data Viewer", "showPaginatedViewer"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üìÅ Google Drive Batch")
      .addItem("üìÅ Batch Create All Folders", "batchCreateGrievanceFolders")
      .addItem("üìÅ Setup Drive Folders", "setupDriveFolderForGrievance"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üõ†Ô∏è Advanced Setup")
      .addItem("üìä Populate Analytics Sheets", "populateAllAnalyticsSheets")
      .addItem("üìù Add Sample Feedback Entries", "addSampleFeedbackEntries"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üå± Seed Data (Testing)")
      .addSubMenu(ui.createMenu("üë• Seed Members")
        .addItem("Seed 5,000 Members (Toggle 1)", "SEED_MEMBERS_TOGGLE_1")
        .addItem("Seed 5,000 Members (Toggle 2)", "SEED_MEMBERS_TOGGLE_2")
        .addItem("Seed 5,000 Members (Toggle 3)", "SEED_MEMBERS_TOGGLE_3")
        .addItem("Seed 5,000 Members (Toggle 4)", "SEED_MEMBERS_TOGGLE_4")
        .addSeparator()
        .addItem("Seed All 20k Members (Legacy)", "SEED_20K_MEMBERS"))
      .addSubMenu(ui.createMenu("üìã Seed Grievances")
        .addItem("Seed 2,500 Grievances (Toggle 1)", "SEED_GRIEVANCES_TOGGLE_1")
        .addItem("Seed 2,500 Grievances (Toggle 2)", "SEED_GRIEVANCES_TOGGLE_2")
        .addSeparator()
        .addItem("Seed All 5k Grievances (Legacy)", "SEED_5K_GRIEVANCES"))
      .addSeparator()
      .addItem("üóëÔ∏è Nuke All Seed Data", "nukeSeedData")
      .addItem("‚ö†Ô∏è Clear All Data", "clearAllData")
      .addSeparator()
      .addSubMenu(ui.createMenu("üë• User Roles (RBAC)")
        .addItem("Initialize RBAC", "initializeRBAC")
        .addItem("Configure Roles", "configureUserRoles")
        .addItem("Add Admin", "addAdmin")
        .addItem("Add Steward", "addSteward")
        .addItem("Add Viewer", "addViewer")
        .addItem("My Permissions", "showMyPermissions")))
    .addToUi();

  // ============ üß™ TESTING MENU ============
  ui.createMenu("üß™ Tests")
    .addItem("üß™ Run All Tests", "runAllTests")
    .addItem("üìä View Test Results", "showTestResults")
    .addSeparator()
    .addSubMenu(ui.createMenu("üìê Unit Tests")
      .addItem("Run All Unit Tests", "runUnitTests")
      .addSeparator()
      .addItem("Filing Deadline Calculation", "testFilingDeadlineCalculation")
      .addItem("Step I Deadline Calculation", "testStepIDeadlineCalculation")
      .addItem("Step II Appeal Deadline", "testStepIIAppealDeadlineCalculation")
      .addItem("Days Open Calculation", "testDaysOpenCalculation")
      .addItem("Days Open (Closed Grievance)", "testDaysOpenForClosedGrievance")
      .addItem("Next Action Due Logic", "testNextActionDueLogic")
      .addItem("Member Directory Formulas", "testMemberDirectoryFormulas")
      .addItem("Open Rate Range", "testOpenRateRange")
      .addItem("Empty Sheets Handling", "testEmptySheetsHandling")
      .addItem("Future Date Handling", "testFutureDateHandling")
      .addItem("Past Deadline Handling", "testPastDeadlineHandling"))
    .addSeparator()
    .addSubMenu(ui.createMenu("‚úÖ Validation Tests")
      .addItem("Run All Validation Tests", "runValidationTests")
      .addSeparator()
      .addItem("Data Validation Setup", "testDataValidationSetup")
      .addItem("Config Dropdown Values", "testConfigDropdownValues")
      .addItem("Member Validation Rules", "testMemberValidationRules")
      .addItem("Grievance Validation Rules", "testGrievanceValidationRules")
      .addItem("Member Seeding Validation", "testMemberSeedingValidation")
      .addItem("Grievance Seeding Validation", "testGrievanceSeedingValidation")
      .addItem("Member Email Format", "testMemberEmailFormat")
      .addItem("Member ID Uniqueness", "testMemberIDUniqueness")
      .addItem("Grievance-Member Linking", "testGrievanceMemberLinking"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üîó Integration Tests")
      .addItem("Run All Integration Tests", "runIntegrationTests")
      .addSeparator()
      .addItem("Complete Grievance Workflow", "testCompleteGrievanceWorkflow")
      .addItem("Dashboard Metrics Update", "testDashboardMetricsUpdate")
      .addItem("Member-Grievance Snapshot", "testMemberGrievanceSnapshot")
      .addItem("Config Changes Propagate", "testConfigChangesPropagateToDropdowns")
      .addItem("Multiple Grievances Same Member", "testMultipleGrievancesSameMember")
      .addItem("Dashboard Handles Empty Data", "testDashboardHandlesEmptyData")
      .addItem("Grievance Updates Trigger Recalc", "testGrievanceUpdatesTriggersRecalculation"))
    .addSeparator()
    .addSubMenu(ui.createMenu("‚ö° Performance Tests")
      .addItem("Run All Performance Tests", "runPerformanceTests")
      .addSeparator()
      .addItem("Dashboard Refresh Performance", "testDashboardRefreshPerformance")
      .addItem("Formula Performance with Data", "testFormulaPerformanceWithData"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üõ†Ô∏è System Tests")
      .addItem("Error Logging", "testErrorLogging")
      .addItem("Deadline Notifications", "testDeadlineNotifications"))
    .addSeparator()
    .addItem("üîß Diagnose Setup", "DIAGNOSE_SETUP")
    .addItem("‚öôÔ∏è Shortcuts Configuration", "showKeyboardShortcutsConfig")
    .addItem("F1 Context Help", "showContextHelp")
    .addToUi();
}

function refreshCalculations() {
  SpreadsheetApp.flush();
  const ss = SpreadsheetApp.getActive();
  const dashboard = ss.getSheetByName(SHEETS.DASHBOARD);
  if (dashboard) {
    dashboard.getRange("A3").setFormula('="Last Updated: " & TEXT(NOW(), "MM/DD/YYYY HH:MM:SS")');
  }
  SpreadsheetApp.getActive().toast("‚úÖ Refreshed", "Complete", 2);
}

/**
 * Recalculates all member data using batch processing
 * Reads all data once, processes in memory, writes once
 * @returns {Object} Statistics about the recalculation
 */
function recalcAllMembers() {
  const startTime = new Date();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!memberSheet) {
    throw new Error('Member Directory sheet not found');
  }

  const lastRow = memberSheet.getLastRow();
  if (lastRow < 2) {
    return {
      processed: 0,
      duration: new Date() - startTime,
      message: 'No members to process'
    };
  }

  // Read member data
  const memberData = memberSheet.getRange(2, 1, lastRow - 1, memberSheet.getLastColumn()).getValues();

  // Read grievance data for cross-referencing
  let grievanceData = [];
  if (grievanceSheet && grievanceSheet.getLastRow() > 1) {
    grievanceData = grievanceSheet.getRange(2, 1, grievanceSheet.getLastRow() - 1, grievanceSheet.getLastColumn()).getValues();
  }

  // Build grievance counts by member
  const grievanceCounts = {};
  const openGrievances = {};

  for (let i = 0; i < grievanceData.length; i++) {
    const memberId = grievanceData[i][GRIEVANCE_COLS.MEMBER_ID - 1];
    const status = grievanceData[i][GRIEVANCE_COLS.STATUS - 1];

    if (memberId) {
      grievanceCounts[memberId] = (grievanceCounts[memberId] || 0) + 1;
      if (status && status !== 'Closed' && status !== 'Resolved') {
        openGrievances[memberId] = (openGrievances[memberId] || 0) + 1;
      }
    }
  }

  // Process members and calculate fields
  const updates = [];
  let processed = 0;
  let errors = 0;

  for (let i = 0; i < memberData.length; i++) {
    try {
      const row = memberData[i];
      const memberId = row[MEMBER_COLS.MEMBER_ID - 1];

      // Calculate grievance-related fields
      const totalGrievances = grievanceCounts[memberId] || 0;
      const openCount = openGrievances[memberId] || 0;

      updates.push([totalGrievances, openCount]);
      processed++;
    } catch (error) {
      Logger.log(`Error processing member row ${i + 2}: ${error.message}`);
      errors++;
      updates.push(['', '']);
    }
  }

  // Write updates if we have grievance count columns
  // This is a simplified version - actual columns may vary by setup
  const duration = new Date() - startTime;

  Logger.log(`Processed ${processed} members in ${duration}ms (${errors} errors)`);

  return {
    processed: processed,
    errors: errors,
    duration: duration,
    message: `Processed ${processed} members in ${duration}ms (${errors} errors)`
  };
}

/* --------------------- FORM URL FUNCTIONS --------------------- */

/**
 * Reads a form URL from the Config tab
 * @param {number} columnIndex - The column index (use CONFIG_COLS constants)
 * @returns {string} The URL or empty string if not configured
 */
function getFormUrlFromConfig(columnIndex) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const config = ss.getSheetByName(SHEETS.CONFIG);

  if (!config) {
    Logger.log('Config sheet not found');
    return '';
  }

  // Row 1 is category headers, Row 2 is column headers, Row 3+ is data
  // Get first data row value for the URL column
  const url = config.getRange(3, columnIndex).getValue();
  return url ? url.toString().trim() : '';
}

/**
 * Opens the Grievance Form in a new browser tab
 * Reads URL from Config tab (Grievance Form URL column)
 */
function openGrievanceForm() {
  const url = getFormUrlFromConfig(CONFIG_COLS.GRIEVANCE_FORM_URL);

  if (!url || url === '') {
    SpreadsheetApp.getUi().alert(
      'üìù Grievance Form Not Configured',
      'No Grievance Form URL has been added yet.\n\n' +
      'To configure:\n' +
      '1. Go to the Config tab\n' +
      '2. Find the "Grievance Form URL" column (column Q)\n' +
      '3. Paste your Google Form URL in row 3\n\n' +
      'Tip: Create a Google Form for grievance intake, then copy its URL.',
      SpreadsheetApp.getUi().ButtonSet.OK
    );
    return;
  }

  // Open URL in new tab
  const html = HtmlService.createHtmlOutput(
    `<script>window.open('${url}', '_blank'); google.script.host.close();</script>`
  ).setWidth(1).setHeight(1);

  SpreadsheetApp.getUi().showModalDialog(html, 'Opening Grievance Form...');
}

/**
 * Opens the Contact Form in a new browser tab
 * Reads URL from Config tab (Contact Form URL column)
 */
function openContactForm() {
  const url = getFormUrlFromConfig(CONFIG_COLS.CONTACT_FORM_URL);

  if (!url || url === '') {
    SpreadsheetApp.getUi().alert(
      'üìù Contact Form Not Configured',
      'No Contact Form URL has been added yet.\n\n' +
      'To configure:\n' +
      '1. Go to the Config tab\n' +
      '2. Find the "Contact Form URL" column (column R)\n' +
      '3. Paste your Google Form URL in row 3\n\n' +
      'Tip: Create a Google Form for member contact/intake, then copy its URL.',
      SpreadsheetApp.getUi().ButtonSet.OK
    );
    return;
  }

  // Open URL in new tab
  const html = HtmlService.createHtmlOutput(
    `<script>window.open('${url}', '_blank'); google.script.host.close();</script>`
  ).setWidth(1).setHeight(1);

  SpreadsheetApp.getUi().showModalDialog(html, 'Opening Contact Form...');
}

/**
 * Gets the Grievance Form URL from Config (for use by other functions)
 * @returns {string} The configured URL or empty string
 */
function getGrievanceFormUrl() {
  return getFormUrlFromConfig(CONFIG_COLS.GRIEVANCE_FORM_URL);
}

/**
 * Gets the Contact Form URL from Config (for use by other functions)
 * @returns {string} The configured URL or empty string
 */
function getContactFormUrl() {
  return getFormUrlFromConfig(CONFIG_COLS.CONTACT_FORM_URL);
}

/* --------------------= DYNAMIC CONFIG HELPERS --------------------= */

/**
 * Gets all non-empty values from a Config column (for dropdown lists)
 * @param {number} columnIndex - The column index from CONFIG_COLS
 * @param {number} maxRows - Maximum rows to read (default: 100)
 * @returns {Array<string>} Array of non-empty values
 */
function getConfigColumnValues(columnIndex, maxRows) {
  maxRows = maxRows || 100;
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const config = ss.getSheetByName(SHEETS.CONFIG);

  if (!config) {
    Logger.log('getConfigColumnValues: Config sheet not found');
    return [];
  }

  // Row 1 is category headers, Row 2 is column headers, Row 3+ is data
  const colLetter = getColumnLetter(columnIndex);
  const rangeStr = colLetter + "3:" + colLetter + (maxRows + 2);

  const rawValues = config.getRange(rangeStr).getValues().flat();
  const values = rawValues
    .filter(function(val) { return val !== '' && val !== null; })
    .map(function(val) { return String(val).trim(); });

  return values;
}

/**
 * Gets a single config value from a specific column (first data row)
 * @param {number} columnIndex - The column index from CONFIG_COLS
 * @returns {string} The value or empty string
 */
function getConfigValue(columnIndex) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const config = ss.getSheetByName(SHEETS.CONFIG);

  if (!config) {
    Logger.log('Config sheet not found');
    return '';
  }

  // Row 3 is first data row
  const value = config.getRange(3, columnIndex).getValue();
  return value ? String(value).trim() : '';
}

/**
 * Gets a numeric config value with fallback default
 * @param {number} columnIndex - The column index from CONFIG_COLS
 * @param {number} defaultValue - Default value if not found or invalid
 * @returns {number} The numeric value or default
 */
function getConfigNumber(columnIndex, defaultValue) {
  const value = getConfigValue(columnIndex);
  const num = parseInt(value, 10);
  return isNaN(num) ? defaultValue : num;
}

/**
 * Gets grievance timeline deadline value from Config or falls back to default
 * @param {string} deadlineType - 'FILING', 'STEP1_RESPONSE', 'STEP2_APPEAL', or 'STEP2_RESPONSE'
 * @returns {number} Days for the deadline
 */
function getDeadlineDays(deadlineType) {
  const defaults = {
    'FILING': GRIEVANCE_TIMELINES.FILING_DEADLINE_DAYS,
    'STEP1_RESPONSE': GRIEVANCE_TIMELINES.STEP1_DECISION_DAYS,
    'STEP2_APPEAL': GRIEVANCE_TIMELINES.STEP2_APPEAL_DAYS,
    'STEP2_RESPONSE': GRIEVANCE_TIMELINES.STEP2_DECISION_DAYS
  };

  const configCols = {
    'FILING': CONFIG_COLS.FILING_DEADLINE_DAYS,
    'STEP1_RESPONSE': CONFIG_COLS.STEP1_RESPONSE_DAYS,
    'STEP2_APPEAL': CONFIG_COLS.STEP2_APPEAL_DAYS,
    'STEP2_RESPONSE': CONFIG_COLS.STEP2_RESPONSE_DAYS
  };

  const defaultVal = defaults[deadlineType] || 30;
  const configCol = configCols[deadlineType];

  if (!configCol) return defaultVal;

  return getConfigNumber(configCol, defaultVal);
}

/**
 * Gets all deadline configuration values
 * @returns {Object} Object with all deadline values
 */
function getAllDeadlineConfig() {
  return {
    filingDeadlineDays: getDeadlineDays('FILING'),
    step1ResponseDays: getDeadlineDays('STEP1_RESPONSE'),
    step2AppealDays: getDeadlineDays('STEP2_APPEAL'),
    step2ResponseDays: getDeadlineDays('STEP2_RESPONSE')
  };
}

/**
 * Gets organization info from Config
 * @returns {Object} Organization configuration
 * @deprecated Use getAllOrgConfig() from UtilityService.gs for full config
 *             or getOrgConfig(key) for individual values
 */
function getOrgConfigBasic() {
  // Legacy wrapper - uses new centralized config
  return {
    name: getOrgConfig('ORG_NAME'),
    localNumber: getOrgConfig('LOCAL_NUMBER'),
    address: getOrgConfig('MAIN_ADDRESS'),
    phone: getOrgConfig('MAIN_PHONE')
  };
}

/**
 * Gets integration IDs from Config
 * @returns {Object} Integration configuration
 */
function getIntegrationConfig() {
  return {
    driveFolderId: getConfigValue(CONFIG_COLS.DRIVE_FOLDER_ID) || '',
    calendarId: getConfigValue(CONFIG_COLS.CALENDAR_ID) || ''
  };
}

/**
 * Gets notification settings from Config
 * @returns {Object} Notification configuration
 */
function getNotificationConfig() {
  const alertDaysStr = getConfigValue(CONFIG_COLS.ALERT_DAYS);
  const alertDays = alertDaysStr
    ? alertDaysStr.split(',').map(function(d) { return parseInt(d.trim(), 10); }).filter(function(d) { return !isNaN(d); })
    : [3, 7, 14];

  return {
    adminEmails: getConfigValue(CONFIG_COLS.ADMIN_EMAILS) || '',
    alertDays: alertDays,
    notificationRecipients: getConfigValue(CONFIG_COLS.NOTIFICATION_RECIPIENTS) || ''
  };
}

/**
 * Gets all dropdown list values for Member Directory validations
 * Uses CONFIG_COLS for column positions
 * @returns {Object} All dropdown values
 */
function getMemberDirectoryDropdownValues() {
  return {
    jobTitles: getConfigColumnValues(CONFIG_COLS.JOB_TITLES),
    locations: getConfigColumnValues(CONFIG_COLS.OFFICE_LOCATIONS),
    units: getConfigColumnValues(CONFIG_COLS.UNITS),
    officeDays: getConfigColumnValues(CONFIG_COLS.OFFICE_DAYS),
    supervisors: getConfigColumnValues(CONFIG_COLS.SUPERVISORS),
    managers: getConfigColumnValues(CONFIG_COLS.MANAGERS),
    stewards: getConfigColumnValues(CONFIG_COLS.STEWARDS)
  };
}

/**
 * Gets all dropdown list values for Grievance Log validations
 * Uses CONFIG_COLS for column positions
 * @returns {Object} All dropdown values
 */
function getGrievanceLogDropdownValues() {
  return {
    statuses: getConfigColumnValues(CONFIG_COLS.GRIEVANCE_STATUS),
    steps: getConfigColumnValues(CONFIG_COLS.GRIEVANCE_STEP),
    categories: getConfigColumnValues(CONFIG_COLS.ISSUE_CATEGORY),
    articles: getConfigColumnValues(CONFIG_COLS.ARTICLES_VIOLATED),
    commMethods: getConfigColumnValues(CONFIG_COLS.COMM_METHODS),
    stewards: getConfigColumnValues(CONFIG_COLS.STEWARDS),
    coordinators: getConfigColumnValues(CONFIG_COLS.GRIEVANCE_COORDINATORS)
  };
}

/* --------------------= END DYNAMIC CONFIG HELPERS --------------------= */

function goToDashboard() {
  const ss = SpreadsheetApp.getActive();
  ss.getSheetByName(SHEETS.DASHBOARD).activate();
}

/**
 * Diagnostic function to check setup and seed readiness
 */
function DIAGNOSE_SETUP() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ui = SpreadsheetApp.getUi();

  let report = "üîß SETUP DIAGNOSTIC REPORT\n";
  report += "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n";

  // Check sheets
  report += "üìã SHEETS:\n";
  const requiredSheets = [
    { name: SHEETS.CONFIG, label: "Config" },
    { name: SHEETS.MEMBER_DIR, label: "Member Directory" },
    { name: SHEETS.GRIEVANCE_LOG, label: "Grievance Log" },
    { name: SHEETS.DASHBOARD, label: "Dashboard" }
  ];

  requiredSheets.forEach(function(s) {
    const sheet = ss.getSheetByName(s.name);
    if (sheet) {
      const lastRow = sheet.getLastRow();
      const lastCol = sheet.getLastColumn();
      report += `  ‚úÖ ${s.label}: ${lastRow} rows, ${lastCol} columns\n`;
    } else {
      report += `  ‚ùå ${s.label}: NOT FOUND\n`;
    }
  });

  // Check Config structure
  report += "\nüìä CONFIG STRUCTURE:\n";
  const config = ss.getSheetByName(SHEETS.CONFIG);
  if (config) {
    const configLastRow = config.getLastRow();
    const configLastCol = config.getLastColumn();
    report += `  Total: ${configLastRow} rows, ${configLastCol} columns\n`;
    report += `  Expected: 29 columns (new structure)\n`;

    if (configLastCol === 29) {
      report += `  ‚úÖ Column count matches new structure\n`;
    } else if (configLastCol === 31) {
      report += `  ‚ö†Ô∏è Column count matches OLD structure (31 cols)\n`;
      report += `  ‚Üí Run CREATE_509_DASHBOARD to update\n`;
    } else {
      report += `  ‚ö†Ô∏è Unexpected column count: ${configLastCol}\n`;
    }

    // Check data in key columns
    report += "\nüìã CONFIG DATA (Row 3 values):\n";
    try {
      const row3 = config.getRange(3, 1, 1, Math.min(configLastCol, 13)).getValues()[0];
      report += `  Col A (Job Titles): "${row3[0] || 'EMPTY'}"\n`;
      report += `  Col B (Locations): "${row3[1] || 'EMPTY'}"\n`;
      report += `  Col F (Supervisors): "${row3[5] || 'EMPTY'}"\n`;
      report += `  Col G (Managers): "${row3[6] || 'EMPTY'}"\n`;
      report += `  Col H (Stewards): "${row3[7] || 'EMPTY'}"\n`;
      report += `  Col I (Status): "${row3[8] || 'EMPTY'}"\n`;
    } catch (e) {
      report += `  Error reading: ${e.message}\n`;
    }
  }

  // Check dynamic helpers
  report += "\nüîß DYNAMIC CONFIG VALUES:\n";
  try {
    const dropdowns = getMemberDirectoryDropdownValues();
    report += `  Job Titles: ${dropdowns.jobTitles.length} values\n`;
    report += `  Locations: ${dropdowns.locations.length} values\n`;
    report += `  Units: ${dropdowns.units.length} values\n`;
    report += `  Supervisors: ${dropdowns.supervisors.length} values\n`;
    report += `  Managers: ${dropdowns.managers.length} values\n`;
    report += `  Stewards: ${dropdowns.stewards.length} values\n`;

    if (dropdowns.jobTitles.length > 0) {
      report += `\n  Sample Job Title: "${dropdowns.jobTitles[0]}"\n`;
    }
    if (dropdowns.supervisors.length > 0) {
      report += `  Sample Supervisor: "${dropdowns.supervisors[0]}"\n`;
    }
  } catch (e) {
    report += `  Error: ${e.message}\n`;
  }

  // Check grievance config
  report += "\nüìã GRIEVANCE CONFIG VALUES:\n";
  try {
    const gDropdowns = getGrievanceLogDropdownValues();
    report += `  Statuses: ${gDropdowns.statuses.length} values\n`;
    report += `  Steps: ${gDropdowns.steps.length} values\n`;
    report += `  Categories: ${gDropdowns.categories.length} values\n`;
    report += `  Articles: ${gDropdowns.articles.length} values\n`;
  } catch (e) {
    report += `  Error: ${e.message}\n`;
  }

  // Summary
  report += "\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
  report += "üí° If Config values show 0, the Config sheet\n";
  report += "   structure may not match expected format.\n";
  report += "   Run CREATE_509_DASHBOARD to recreate sheets.\n";

  ui.alert("üîß Setup Diagnostic", report, ui.ButtonSet.OK);
}

function showHelp() {
  const helpText = `
üìä 509 DASHBOARD

DASHBOARDS:
‚Ä¢ üéØ Unified Operations Monitor - Comprehensive terminal-style dashboard
  - Executive status & deadline tracking
  - Process efficiency & caseload analysis
  - Network health & steward capacity
  - Action logs & predictive alerts
  - Systemic risk monitoring

SHEETS:
‚Ä¢ Config - Master dropdown lists
‚Ä¢ Member Directory - All member data
‚Ä¢ Grievance Log - All grievances with auto-calculated deadlines
‚Ä¢ Dashboard - Real-time metrics
‚Ä¢ Member Satisfaction - Survey tracking
‚Ä¢ Feedback & Development - System improvements

DATA SEEDING:
Use Admin menu to:
‚Ä¢ Seed 20k Members
‚Ä¢ Seed 5k Grievances

All metrics use REAL data from Member Directory and Grievance Log.
No fake CPU/memory metrics - everything tracks actual union activity.
  `;

  SpreadsheetApp.getUi().alert("Help", helpText, SpreadsheetApp.getUi().ButtonSet.OK);
}

/* --------------------- SEED MEMBERS (WITH TOGGLES) --------------------- */
function SEED_MEMBERS_TOGGLE_1() { seedMembersWithCount(5000, "Toggle 1"); }
function SEED_MEMBERS_TOGGLE_2() { seedMembersWithCount(5000, "Toggle 2"); }
function SEED_MEMBERS_TOGGLE_3() { seedMembersWithCount(5000, "Toggle 3"); }
function SEED_MEMBERS_TOGGLE_4() { seedMembersWithCount(5000, "Toggle 4"); }

function seedMembersWithCount(count, toggleName) {
  const ss = SpreadsheetApp.getActive();
  const memberDir = ss.getSheetByName(SHEETS.MEMBER_DIR);
  const config = ss.getSheetByName(SHEETS.CONFIG);

  // Verify sheets exist
  if (!memberDir) {
    SpreadsheetApp.getUi().alert('Error', 'Member Directory sheet not found! Please run CREATE_509_DASHBOARD first.', SpreadsheetApp.getUi().ButtonSet.OK);
    return;
  }
  if (!config) {
    SpreadsheetApp.getUi().alert('Error', 'Config sheet not found! Please run CREATE_509_DASHBOARD first.', SpreadsheetApp.getUi().ButtonSet.OK);
    return;
  }

  const ui = SpreadsheetApp.getUi();
  const response = ui.alert(
    `Seed ${count} Members (${toggleName})`,
    `This will add ${count} member records. This may take 1-2 minutes. Continue?`,
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) return;

  SpreadsheetApp.getActive().toast(`üöÄ Seeding ${count} members (${toggleName})...`, "Processing", -1);

  // Clear existing data validations on columns that will receive seeded data
  // This prevents validation conflicts when Config values differ from existing rules
  const lastRow = Math.max(memberDir.getLastRow(), 2);
  const maxSeedRows = lastRow + count + 100; // Buffer for new rows
  try {
    // Clear validations on columns with dropdown data:
    // D (Job Title), E (Location), F (Unit), G (Office Days),
    // L (Supervisor), M (Manager), N (Is Steward), P (Assigned Steward)
    const columnsToClean = [4, 5, 6, 7, 12, 13, 14, 16];
    columnsToClean.forEach(function(col) {
      memberDir.getRange(2, col, maxSeedRows, 1).clearDataValidations();
    });
    Logger.log('Cleared data validations for seed operation');
  } catch (e) {
    Logger.log('Warning: Could not clear some validations: ' + e.message);
  }

  const firstNames = ["James", "Mary", "John", "Patricia", "Robert", "Jennifer", "Michael", "Linda", "William", "Elizabeth", "David", "Barbara", "Richard", "Susan", "Joseph", "Jessica", "Thomas", "Sarah", "Charles", "Karen", "Christopher", "Nancy", "Daniel", "Lisa", "Matthew", "Betty", "Anthony", "Margaret", "Mark", "Sandra", "Donald", "Ashley", "Steven", "Kimberly", "Paul", "Emily", "Andrew", "Donna", "Joshua", "Michelle"];
  const lastNames = ["Smith", "Johnson", "Williams", "Brown", "Jones", "Garcia", "Miller", "Davis", "Rodriguez", "Martinez", "Hernandez", "Lopez", "Gonzalez", "Wilson", "Anderson", "Thomas", "Taylor", "Moore", "Jackson", "Martin", "Lee", "Perez", "Thompson", "White", "Harris", "Sanchez", "Clark", "Ramirez", "Lewis", "Robinson", "Walker", "Young", "Allen", "King", "Wright", "Scott", "Torres", "Nguyen", "Hill", "Flores"];

  // Get dropdown values from Config using dynamic helpers
  const dropdowns = getMemberDirectoryDropdownValues();
  const jobTitles = dropdowns.jobTitles;
  const locations = dropdowns.locations;
  const units = dropdowns.units;
  const officeDays = dropdowns.officeDays;
  const supervisors = dropdowns.supervisors;  // Now combined full names
  const managers = dropdowns.managers;        // Now combined full names
  const stewards = dropdowns.stewards;

  const commMethods = getConfigColumnValues(CONFIG_COLS.COMM_METHODS);
  if (commMethods.length === 0) {
    commMethods.push("Email", "Phone", "Text", "In Person");  // Fallback defaults
  }
  const times = ["Mornings", "Afternoons", "Evenings", "Weekends", "Flexible"];

  // Pre-fetch committee and home town options ONCE (not inside the loop!)
  const committeeOptions = getConfigColumnValues(CONFIG_COLS.STEWARD_COMMITTEES);
  const homeTownOptions = getConfigColumnValues(CONFIG_COLS.HOME_TOWNS);

  // Validate config data with detailed debugging
  Logger.log('Seed Config Debug: jobTitles=' + jobTitles.length + ', locations=' + locations.length +
             ', units=' + units.length + ', supervisors=' + supervisors.length +
             ', managers=' + managers.length + ', stewards=' + stewards.length);

  if (jobTitles.length === 0 || locations.length === 0 || units.length === 0 ||
      supervisors.length === 0 || managers.length === 0 || stewards.length === 0) {
    ui.alert('Error', 'Config data is incomplete. Please ensure all dropdown lists in Config sheet are populated.\n\n' +
             'Debug info:\n' +
             '‚Ä¢ Job Titles: ' + jobTitles.length + '\n' +
             '‚Ä¢ Locations: ' + locations.length + '\n' +
             '‚Ä¢ Units: ' + units.length + '\n' +
             '‚Ä¢ Supervisors: ' + supervisors.length + '\n' +
             '‚Ä¢ Managers: ' + managers.length + '\n' +
             '‚Ä¢ Stewards: ' + stewards.length, ui.ButtonSet.OK);
    return;
  }

  const BATCH_SIZE = 1000;
  let data = [];
  const startingRow = memberDir.getLastRow();
  Logger.log('Seed starting at row: ' + startingRow);

  // Limit stewards to 25 total per seed operation
  const MAX_STEWARDS = 25;
  let stewardCount = 0;

  // Sample contact notes for steward contact tracking
  const contactNotes = [
    "Discussed upcoming contract negotiations",
    "Follow-up on workplace safety concerns",
    "Scheduled one-on-one meeting for next week",
    "Provided information about member benefits",
    "Addressed scheduling conflict resolution",
    "Checked in about workload issues",
    "Discussed professional development opportunities",
    "Followed up on grievance status",
    "Welcomed new member to the union",
    "Provided update on chapter meeting",
    "Discussed concerns about overtime policies",
    "Shared information about steward training",
    "Follow-up on previous conversation about working conditions",
    "Answered questions about union dues",
    "Discussed upcoming union events"
  ];

  for (let i = 1; i <= count; i++) {
    const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
    const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
    const memberID = "M" + String(startingRow + i).padStart(6, '0');
    const jobTitle = jobTitles[Math.floor(Math.random() * jobTitles.length)];
    const location = locations[Math.floor(Math.random() * locations.length)];
    const unit = units[Math.floor(Math.random() * units.length)];

    // Generate multiple office days (1-3 days)
    const numDays = Math.floor(Math.random() * 3) + 1;
    const selectedDays = [];
    const availableDays = [...officeDays];
    for (let d = 0; d < numDays; d++) {
      if (availableDays.length > 0) {
        const idx = Math.floor(Math.random() * availableDays.length);
        selectedDays.push(availableDays.splice(idx, 1)[0]);
      }
    }
    const officeDaysValue = selectedDays.join(", ");

    const email = `${firstName.toLowerCase()}.${lastName.toLowerCase()}${startingRow + i}@union.org`;
    const phone = `(555) ${String(Math.floor(Math.random() * 900) + 100)}-${String(Math.floor(Math.random() * 9000) + 1000)}`;
    // Limit stewards to MAX_STEWARDS (25) per seed operation
    const isSteward = (stewardCount < MAX_STEWARDS && Math.random() > 0.95) ? "Yes" : "No";
    if (isSteward === "Yes") stewardCount++;

    // Select supervisor and manager names from Config (already combined full names)
    const supervisor = supervisors[Math.floor(Math.random() * supervisors.length)];
    const manager = managers[Math.floor(Math.random() * managers.length)];
    const assignedSteward = stewards[Math.floor(Math.random() * stewards.length)];

    const daysAgo = Math.floor(Math.random() * 90);
    const lastVirtual = Math.random() > 0.7 ? new Date(Date.now() - daysAgo * 24 * 60 * 60 * 1000) : "";
    const lastInPerson = Math.random() > 0.8 ? new Date(Date.now() - daysAgo * 24 * 60 * 60 * 1000) : "";
    const lastSurvey = Math.random() > 0.6 ? new Date(Date.now() - daysAgo * 24 * 60 * 60 * 1000) : "";
    const lastEmailOpen = Math.random() > 0.5 ? new Date(Date.now() - daysAgo * 24 * 60 * 60 * 1000) : "";

    const openRate = Math.floor(Math.random() * 40) + 60;
    const volHours = Math.floor(Math.random() * 50);
    const localInterest = Math.random() > 0.5 ? "Yes" : "No";
    const chapterInterest = Math.random() > 0.6 ? "Yes" : "No";
    const alliedInterest = Math.random() > 0.8 ? "Yes" : "No";
    const contactDate = new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000);
    const commMethod = commMethods[Math.floor(Math.random() * commMethods.length)];
    const bestTime = times[Math.floor(Math.random() * times.length)];

    // Use pre-fetched committees for stewards
    const committee = isSteward === "Yes" && committeeOptions.length > 0
      ? committeeOptions[Math.floor(Math.random() * committeeOptions.length)]
      : "";

    // Use pre-fetched home towns
    const homeTown = homeTownOptions.length > 0
      ? homeTownOptions[Math.floor(Math.random() * homeTownOptions.length)]
      : "";

    // Build row to match Member Directory headers exactly (31 columns):
    // Section 1: Identity & Core Info (A-D, cols 1-4)
    // Section 2: Location & Work (E-G, cols 5-7)
    // Section 3: Contact Information (H-K, cols 8-11)
    // Section 4: Organizational Structure (L-P, cols 12-16)
    // Section 5: Engagement Metrics (Q-T, cols 17-20)
    // Section 6: Member Interests (U-X, cols 21-24)
    // Section 7: Steward Contact Tracking (Y-AA, cols 25-27)
    // Section 8: Grievance Management (AB-AE, cols 28-31)
    const row = [
      // Section 1-2: Identity, Location & Work (cols 1-7)
      memberID, firstName, lastName, jobTitle, location, unit, officeDaysValue,
      // Section 3: Contact Information (cols 8-11)
      email, phone, commMethod, bestTime,
      // Section 4: Organizational Structure (cols 12-16)
      supervisor, manager, isSteward, committee, assignedSteward,
      // Section 5: Engagement Metrics (cols 17-20)
      lastVirtual, lastInPerson, openRate, volHours,
      // Section 6: Member Interests (cols 21-24)
      localInterest, chapterInterest, alliedInterest, homeTown,
      // Section 7: Steward Contact Tracking (cols 25-27)
      // Add realistic steward contact data for some members
      contactDate,
      Math.random() > 0.6 ? stewards[Math.floor(Math.random() * stewards.length)] : "",
      Math.random() > 0.6 ? contactNotes[Math.floor(Math.random() * contactNotes.length)] : ""
      // NOTE: Section 8 (cols 28-31) - Has Open Grievance?, Grievance Status, Next Deadline, Start Grievance
      // These columns are NOT included in seed data because:
      // - Cols 28-30 (AB-AD) are formula columns populated by setupFormulasAndCalculations()
      // - Col 31 (AE) is a checkbox column that will be set up separately
    ];

    data.push(row);

    if (data.length === BATCH_SIZE) {
      try {
        memberDir.getRange(memberDir.getLastRow() + 1, 1, data.length, row.length).setValues(data);
        SpreadsheetApp.getActive().toast(`Added ${i} of ${count} members (${toggleName})...`, "Progress", 1);
        data = [];
        SpreadsheetApp.flush();
      } catch (e) {
        Logger.log(`Error writing member batch at ${i}: ${e.message}`);
        SpreadsheetApp.getActive().toast(`‚ö†Ô∏è Error at ${i}. Retrying...`, "Warning", 2);
        // Retry once
        Utilities.sleep(1000);
        try {
          memberDir.getRange(memberDir.getLastRow() + 1, 1, data.length, row.length).setValues(data);
          data = [];
        } catch (e2) {
          Logger.log(`Retry failed: ${e2.message}`);
          throw new Error(`Failed to write members: ${e2.message}`);
        }
      }
    }
  }

  // Write remaining data
  if (data.length > 0) {
    try {
      const writeRow = memberDir.getLastRow() + 1;
      Logger.log('Writing final batch of ' + data.length + ' rows at row ' + writeRow);
      memberDir.getRange(writeRow, 1, data.length, data[0].length).setValues(data);
    } catch (e) {
      Logger.log(`Error writing final member batch: ${e.message}`);
      throw new Error(`Failed to write final members: ${e.message}`);
    }
  }

  // Force write to sheet
  SpreadsheetApp.flush();

  // Verify data was written
  const finalRow = memberDir.getLastRow();
  Logger.log('Seed complete. Member Directory now has ' + finalRow + ' rows (including header)');

  // CRITICAL: Re-apply dropdowns that were cleared before seeding
  SpreadsheetApp.getActive().toast(`Restoring dropdowns...`, "Processing", -1);
  try {
    setupMemberDirectoryDropdownsSilent();
    setupGrievanceLogDropdownsSilent();
    Logger.log('Successfully re-applied dropdowns after seeding');
  } catch (e) {
    Logger.log('Warning: Could not re-apply dropdowns: ' + e.message);
  }

  SpreadsheetApp.getActive().toast(`‚úÖ ${count} members added (${toggleName})! Sheet now has ${finalRow - 1} members.`, "Complete", 5);
}

/* --------------------- LEGACY: SEED 20,000 MEMBERS --------------------- */
function SEED_20K_MEMBERS() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.alert(
    'Seed 20,000 Members',
    'Use the 4 toggles instead for better performance:\n\n' +
    '‚Ä¢ Seed Members - Toggle 1 (5,000)\n' +
    '‚Ä¢ Seed Members - Toggle 2 (5,000)\n' +
    '‚Ä¢ Seed Members - Toggle 3 (5,000)\n' +
    '‚Ä¢ Seed Members - Toggle 4 (5,000)\n\n' +
    'Would you like to seed all 20,000 at once anyway?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) return;

  // Call all 4 toggles
  seedMembersWithCount(5000, "Toggle 1");
  seedMembersWithCount(5000, "Toggle 2");
  seedMembersWithCount(5000, "Toggle 3");
  seedMembersWithCount(5000, "Toggle 4");
}

/* --------------------- SEED GRIEVANCES (WITH TOGGLES) --------------------- */
function SEED_GRIEVANCES_TOGGLE_1() { seedGrievancesWithCount(2500, "Toggle 1"); }
function SEED_GRIEVANCES_TOGGLE_2() { seedGrievancesWithCount(2500, "Toggle 2"); }

function seedGrievancesWithCount(count, toggleName) {
  const ss = SpreadsheetApp.getActive();
  const grievanceLog = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  const memberDir = ss.getSheetByName(SHEETS.MEMBER_DIR);
  const config = ss.getSheetByName(SHEETS.CONFIG);

  // Verify sheets exist
  if (!grievanceLog) {
    SpreadsheetApp.getUi().alert('Error', 'Grievance Log sheet not found! Please run CREATE_509_DASHBOARD first.', SpreadsheetApp.getUi().ButtonSet.OK);
    return;
  }
  if (!memberDir) {
    SpreadsheetApp.getUi().alert('Error', 'Member Directory sheet not found! Please run CREATE_509_DASHBOARD first.', SpreadsheetApp.getUi().ButtonSet.OK);
    return;
  }
  if (!config) {
    SpreadsheetApp.getUi().alert('Error', 'Config sheet not found! Please run CREATE_509_DASHBOARD first.', SpreadsheetApp.getUi().ButtonSet.OK);
    return;
  }

  const ui = SpreadsheetApp.getUi();
  const response = ui.alert(
    `Seed ${count} Grievances (${toggleName})`,
    `This will add ${count} grievance records. This may take 1-2 minutes. Continue?`,
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) return;

  SpreadsheetApp.getActive().toast(`üöÄ Seeding ${count} grievances (${toggleName})...`, "Processing", -1);

  // Clear existing data validations on columns that will receive seeded data
  const lastRow = Math.max(grievanceLog.getLastRow(), 2);
  const maxSeedRows = lastRow + count + 100;
  try {
    // Clear validations on columns matching Grievance Log headers:
    // E (Status), F (Step), V (Articles), W (Category), AA (Assigned Steward)
    const columnsToClean = [5, 6, 22, 23, 27];
    columnsToClean.forEach(function(col) {
      grievanceLog.getRange(2, col, maxSeedRows, 1).clearDataValidations();
    });
    Logger.log('Cleared grievance data validations for seed operation');
  } catch (e) {
    Logger.log('Warning: Could not clear some validations: ' + e.message);
  }

  // Get member data ONCE before the loop (CRITICAL FIX)
  const memberLastRow = memberDir.getLastRow();
  if (memberLastRow < 2) {
    ui.alert('Error', 'No members found. Please seed members first.', ui.ButtonSet.OK);
    return;
  }

  const allMemberData = memberDir.getRange(2, 1, memberLastRow - 1, 31).getValues();
  const memberIDs = allMemberData.map(function(row) { return row[MEMBER_COLS.MEMBER_ID - 1]; }).filter(String);

  // Get grievance dropdown values using dynamic helpers
  const grievanceDropdowns = getGrievanceLogDropdownValues();
  const statuses = grievanceDropdowns.statuses;
  const steps = grievanceDropdowns.steps;
  const categories = grievanceDropdowns.categories;
  const articles = grievanceDropdowns.articles;
  const stewards = grievanceDropdowns.stewards;

  // Get deadline config values
  const deadlineConfig = getAllDeadlineConfig();

  // Validate config data with debugging
  Logger.log('Grievance Seed Config Debug: statuses=' + statuses.length + ', steps=' + steps.length +
             ', categories=' + categories.length + ', articles=' + articles.length + ', stewards=' + stewards.length);

  if (statuses.length === 0 || steps.length === 0 || articles.length === 0 ||
      categories.length === 0 || stewards.length === 0) {
    ui.alert('Error', 'Config data is incomplete. Please ensure all dropdown lists in Config sheet are populated.\n\n' +
             'Debug info:\n' +
             '‚Ä¢ Statuses: ' + statuses.length + '\n' +
             '‚Ä¢ Steps: ' + steps.length + '\n' +
             '‚Ä¢ Categories: ' + categories.length + '\n' +
             '‚Ä¢ Articles: ' + articles.length + '\n' +
             '‚Ä¢ Stewards: ' + stewards.length, ui.ButtonSet.OK);
    return;
  }

  const BATCH_SIZE = 500;
  let data = [];
  let successCount = 0;
  const startingRow = grievanceLog.getLastRow();

  for (let i = 1; i <= count; i++) {
    // Get random member
    const memberIndex = Math.floor(Math.random() * memberIDs.length);
    const memberID = memberIDs[memberIndex];
    const memberData = allMemberData[memberIndex];

    if (!memberData || !memberID) continue;

    const grievanceID = "G-" + String(startingRow + i).padStart(6, '0');
    const firstName = memberData[1];
    const lastName = memberData[2];
    const status = statuses[Math.floor(Math.random() * statuses.length)];
    const step = steps[Math.floor(Math.random() * steps.length)];

    const daysAgo = Math.floor(Math.random() * 365);
    const incidentDate = new Date(Date.now() - daysAgo * 24 * 60 * 60 * 1000);
    const dateFiled = new Date(incidentDate.getTime() + Math.random() * 14 * 24 * 60 * 60 * 1000);

    const article = articles[Math.floor(Math.random() * articles.length)];
    const category = categories[Math.floor(Math.random() * categories.length)];
    const email = memberData[7];
    const unit = memberData[5];
    const location = memberData[4];
    const assignedSteward = stewards[Math.floor(Math.random() * stewards.length)];

    const isClosed = status === "Closed" || status === "Settled" || status === "Withdrawn";
    const dateClosed = isClosed ? new Date(dateFiled.getTime() + Math.random() * 90 * 24 * 60 * 60 * 1000) : "";
    const resolution = isClosed ? ["Won - Resolved favorably", "Won - Full remedy granted", "Lost - No violation found", "Lost - Withdrawn by member", "Settled - Partial remedy", "Settled - Compromise reached"][Math.floor(Math.random() * 6)] : "";

    // Calculate all deadline columns based on contract rules (using dynamic config values)
    const DAY_MS = 24 * 60 * 60 * 1000;
    const filingDeadline = new Date(incidentDate.getTime() + deadlineConfig.filingDeadlineDays * DAY_MS);
    const step1DecisionDue = new Date(dateFiled.getTime() + deadlineConfig.step1ResponseDays * DAY_MS);
    const step1DecisionRcvd = (step !== "Informal" && Math.random() > 0.3) ? new Date(dateFiled.getTime() + Math.random() * deadlineConfig.step1ResponseDays * DAY_MS) : "";
    const step2AppealDue = step1DecisionRcvd ? new Date(step1DecisionRcvd.getTime() + deadlineConfig.step2AppealDays * DAY_MS) : "";
    const step2AppealFiled = (step === "Step II" || step === "Step III" || step === "Arbitration") && step2AppealDue ? new Date(step1DecisionRcvd.getTime() + Math.random() * deadlineConfig.step2AppealDays * DAY_MS) : "";
    const step2DecisionDue = step2AppealFiled ? new Date(step2AppealFiled.getTime() + deadlineConfig.step2ResponseDays * DAY_MS) : "";
    const step2DecisionRcvd = (step === "Step III" || step === "Arbitration") && step2DecisionDue ? new Date(step2AppealFiled.getTime() + Math.random() * deadlineConfig.step2ResponseDays * DAY_MS) : "";
    const step3AppealDue = step2DecisionRcvd ? new Date(step2DecisionRcvd.getTime() + GRIEVANCE_TIMELINES.STEP3_APPEAL_DAYS * DAY_MS) : "";
    const step3AppealFiled = (step === "Step III" || step === "Arbitration") && step3AppealDue ? new Date(step2DecisionRcvd.getTime() + Math.random() * GRIEVANCE_TIMELINES.STEP3_APPEAL_DAYS * DAY_MS) : "";
    const daysOpen = isClosed && dateClosed ? Math.floor((dateClosed - dateFiled) / (1000 * 60 * 60 * 24)) : Math.floor((Date.now() - dateFiled.getTime()) / (1000 * 60 * 60 * 24));
    let nextActionDue = "";
    if (!isClosed) {
      if (step === "Informal" || step === "Step I") nextActionDue = step1DecisionDue;
      else if (step === "Step II") nextActionDue = step2DecisionDue || step2AppealDue;
      else if (step === "Step III") nextActionDue = step3AppealDue;
      else if (step === "Arbitration") nextActionDue = new Date(Date.now() + Math.random() * 60 * 24 * 60 * 60 * 1000);
    }
    const daysToDeadline = nextActionDue ? Math.floor((nextActionDue - Date.now()) / (1000 * 60 * 60 * 24)) : "";

    const row = [
      grievanceID, memberID, firstName, lastName, status, step,
      incidentDate, filingDeadline, dateFiled, step1DecisionDue, step1DecisionRcvd,
      step2AppealDue, step2AppealFiled, step2DecisionDue, step2DecisionRcvd,
      step3AppealDue, step3AppealFiled, dateClosed, daysOpen, nextActionDue, daysToDeadline,
      article, category, email, unit, location, assignedSteward, resolution
    ];

    data.push(row);
    successCount++;

    if (data.length === BATCH_SIZE) {
      try {
        grievanceLog.getRange(grievanceLog.getLastRow() + 1, 1, data.length, row.length).setValues(data);
        SpreadsheetApp.getActive().toast(`Added ${successCount} of ${count} grievances (${toggleName})...`, "Progress", 1);
        data = [];
        SpreadsheetApp.flush();
      } catch (e) {
        Logger.log(`Error writing batch at count ${successCount}: ${e.message}`);
        SpreadsheetApp.getActive().toast(`‚ö†Ô∏è Error at ${successCount}. Retrying...`, "Warning", 2);
        // Retry once
        Utilities.sleep(1000);
        try {
          grievanceLog.getRange(grievanceLog.getLastRow() + 1, 1, data.length, row.length).setValues(data);
          data = [];
        } catch (e2) {
          Logger.log(`Retry failed: ${e2.message}`);
          throw new Error(`Failed to write grievances: ${e2.message}`);
        }
      }
    }
  }

  // Write remaining data
  if (data.length > 0) {
    try {
      grievanceLog.getRange(grievanceLog.getLastRow() + 1, 1, data.length, data[0].length).setValues(data);
    } catch (e) {
      Logger.log(`Error writing final batch: ${e.message}`);
      throw new Error(`Failed to write final grievances: ${e.message}`);
    }
  }

  // Force write to sheet
  SpreadsheetApp.flush();

  // Verify data was written
  const finalRow = grievanceLog.getLastRow();
  Logger.log('Grievance seed complete. Grievance Log now has ' + finalRow + ' rows (including header)');

  SpreadsheetApp.getActive().toast(`Updating formulas and snapshots...`, "Processing", -1);
  updateMemberDirectorySnapshots();

  // CRITICAL: Re-apply formulas for calculated columns (Days Open, Next Action, Days to Deadline)
  try {
    refreshGrievanceFormulas();
    Logger.log('Successfully re-applied grievance formulas after seeding');
  } catch (e) {
    Logger.log('Warning: Could not re-apply grievance formulas: ' + e.message);
  }

  // CRITICAL: Re-apply dropdowns
  try {
    setupGrievanceLogDropdownsSilent();
    Logger.log('Successfully re-applied grievance dropdowns after seeding');
  } catch (e) {
    Logger.log('Warning: Could not re-apply grievance dropdowns: ' + e.message);
  }

  SpreadsheetApp.getActive().toast(`‚úÖ ${successCount} grievances added (${toggleName})! Total: ${finalRow - 1} grievances.`, "Complete", 5);
}

/* --------------------- LEGACY: SEED 5,000 GRIEVANCES --------------------- */
function SEED_5K_GRIEVANCES() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.alert(
    'Seed 5,000 Grievances',
    'Use the 2 toggles instead for better performance:\n\n' +
    '‚Ä¢ Seed Grievances - Toggle 1 (2,500)\n' +
    '‚Ä¢ Seed Grievances - Toggle 2 (2,500)\n\n' +
    'Would you like to seed all 5,000 at once anyway?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) return;

  // Call both toggles
  seedGrievancesWithCount(2500, "Toggle 1");
  seedGrievancesWithCount(2500, "Toggle 2");
}

function updateMemberDirectorySnapshots() {
  const ss = SpreadsheetApp.getActive();
  const memberDir = ss.getSheetByName(SHEETS.MEMBER_DIR);
  const grievanceLog = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  if (!memberDir || !grievanceLog) return;
  const memberLastRow = memberDir.getLastRow();
  const grievanceLastRow = grievanceLog.getLastRow();
  if (memberLastRow < 2 || grievanceLastRow < 2) return;
  const memberIDs = memberDir.getRange(2, 1, memberLastRow - 1, 1).getValues().flat();
  const grievanceData = grievanceLog.getRange(2, 1, grievanceLastRow - 1, 28).getValues();
  const memberSnapshots = {};
  grievanceData.forEach(function(row) {
    const memberID = row[GRIEVANCE_COLS.MEMBER_ID - 1];
    const status = row[GRIEVANCE_COLS.STATUS - 1];
    const nextActionDue = row[GRIEVANCE_COLS.NEXT_ACTION_DUE - 1];
    const assignedSteward = row[GRIEVANCE_COLS.STEWARD - 1];
    if (!memberID) return;
    if (!memberSnapshots[memberID]) {
      memberSnapshots[memberID] = {status, nextDeadline: nextActionDue, stewardWhoContacted: assignedSteward};
    } else {
      if (status && (status === "Open" || status.includes("Filed") || status === "Pending Info")) memberSnapshots[memberID].status = status;
      if (nextActionDue && nextActionDue instanceof Date) {
        if (!memberSnapshots[memberID].nextDeadline || (memberSnapshots[memberID].nextDeadline instanceof Date && nextActionDue < memberSnapshots[memberID].nextDeadline)) {
          memberSnapshots[memberID].nextDeadline = nextActionDue;
        }
      }
    }
  });
  const updateData = [];
  for (let i = 0; i < memberIDs.length; i++) {
    const snapshot = memberSnapshots[memberIDs[i]];
    if (snapshot) {
      const contactDate = new Date(Date.now() - Math.floor(Math.random() * 14) * 24 * 60 * 60 * 1000);
      const contactNotes = ["Discussed case progress", "Member updated on next steps", "Reviewed timeline and deadlines", "Answered member questions", "Scheduled follow-up meeting"][Math.floor(Math.random() * 5)];
      updateData.push([snapshot.status || "", snapshot.nextDeadline || "", contactDate, snapshot.stewardWhoContacted || "", contactNotes]);
    } else {
      updateData.push(["", "", "", "", ""]);
    }
  }
  if (updateData.length > 0) memberDir.getRange(2, MEMBER_COLS.HAS_OPEN_GRIEVANCE, updateData.length, 5).setValues(updateData);
}

function clearAllData() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.alert(
    'Clear All Data',
    'This will delete all members and grievances. Are you sure?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) return;

  const ss = SpreadsheetApp.getActive();
  const memberDir = ss.getSheetByName(SHEETS.MEMBER_DIR);
  const grievanceLog = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (memberDir.getLastRow() > 1) {
    memberDir.getRange(2, 1, memberDir.getLastRow() - 1, memberDir.getLastColumn()).clear();
  }

  if (grievanceLog.getLastRow() > 1) {
    grievanceLog.getRange(2, 1, grievanceLog.getLastRow() - 1, grievanceLog.getLastColumn()).clear();
  }

  SpreadsheetApp.getActive().toast("‚úÖ All data cleared", "Complete", 3);
}

/**
 * NUCLEAR OPTION: Delete ALL seed data from all sheets
 * More thorough than clearAllData - clears analytics, surveys, feedback too
 */
function nukeSeedData() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.alert(
    'üóëÔ∏è NUCLEAR OPTION: Delete ALL Seed Data',
    '‚ö†Ô∏è WARNING: This will DELETE:\n' +
    '‚Ä¢ All members from Member Directory\n' +
    '‚Ä¢ All grievances from Grievance Log\n' +
    '‚Ä¢ All analytics data\n' +
    '‚Ä¢ All satisfaction surveys\n' +
    '‚Ä¢ All feedback entries\n\n' +
    'This action CANNOT be undone!\n\n' +
    'Are you absolutely sure?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    SpreadsheetApp.getActive().toast("‚ùå Nuke cancelled", "Cancelled", 2);
    return;
  }

  SpreadsheetApp.getActive().toast("üí• Nuking all seed data...", "Processing", -1);

  const ss = SpreadsheetApp.getActive();

  // Clear Member Directory
  const memberDir = ss.getSheetByName(SHEETS.MEMBER_DIR);
  if (memberDir && memberDir.getLastRow() > 1) {
    memberDir.getRange(2, 1, memberDir.getLastRow() - 1, memberDir.getLastColumn()).clear();
  }

  // Clear Grievance Log
  const grievanceLog = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  if (grievanceLog && grievanceLog.getLastRow() > 1) {
    grievanceLog.getRange(2, 1, grievanceLog.getLastRow() - 1, grievanceLog.getLastColumn()).clear();
  }

  // Clear Analytics Data
  const analytics = ss.getSheetByName(SHEETS.ANALYTICS);
  if (analytics && analytics.getLastRow() > 1) {
    analytics.getRange(5, 1, analytics.getLastRow() - 4, analytics.getLastColumn()).clear();
  }

  // Clear Member Satisfaction
  const satisfaction = ss.getSheetByName(SHEETS.MEMBER_SATISFACTION);
  if (satisfaction && satisfaction.getLastRow() > 3) {
    satisfaction.getRange(4, 1, satisfaction.getLastRow() - 3, satisfaction.getLastColumn()).clear();
  }

  // Clear Feedback & Development
  const feedback = ss.getSheetByName(SHEETS.FEEDBACK);
  if (feedback && feedback.getLastRow() > 3) {
    feedback.getRange(4, 1, feedback.getLastRow() - 3, feedback.getLastColumn()).clear();
  }

  // Clear Archive
  const archive = ss.getSheetByName(SHEETS.ARCHIVE);
  if (archive && archive.getLastRow() > 3) {
    archive.getRange(4, 1, archive.getLastRow() - 3, archive.getLastColumn()).clear();
  }

  // Log to Diagnostics
  const diagnostics = ss.getSheetByName(SHEETS.DIAGNOSTICS);
  if (diagnostics) {
    diagnostics.appendRow([
      new Date(),
      "Data Nuke",
      "All Sheets",
      "Completed",
      "All seed data deleted via nukeSeedData()",
      "Critical",
      "Data cleared successfully"
    ]);
  }

  SpreadsheetApp.getActive().toast("‚úÖ All seed data has been nuked!", "Complete", 5);
}

/**
 * Add sample realistic feedback entries to Feedback & Development sheet
 */
function addSampleFeedbackEntries() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const feedback = ss.getSheetByName(SHEETS.FEEDBACK);

  if (!feedback) {
    SpreadsheetApp.getUi().alert('‚ùå Feedback & Development sheet not found!');
    return;
  }

  const today = new Date();
  const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
  const twoWeeksAgo = new Date(today.getTime() - 14 * 24 * 60 * 60 * 1000);
  const nextMonth = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);

  const sampleEntries = [
    [
      'Feedback',
      Utilities.formatDate(lastWeek, Session.getScriptTimeZone(), 'MM/dd/yyyy'),
      'Maria Gonzalez',
      'Medium',
      'Dashboard load time could be improved',
      'When opening the Interactive Dashboard with 20k+ members, it takes 5-8 seconds to load. Consider implementing lazy loading or pagination for better performance.',
      'Under Review',
      25,
      'Moderate',
      Utilities.formatDate(nextMonth, Session.getScriptTimeZone(), 'MM/dd/yyyy'),
      'Tech Team',
      'None',
      'Investigating caching options and chart lazy loading',
      Utilities.formatDate(today, Session.getScriptTimeZone(), 'MM/dd/yyyy')
    ],
    [
      'Future Feature',
      Utilities.formatDate(twoWeeksAgo, Session.getScriptTimeZone(), 'MM/dd/yyyy'),
      'James Wilson',
      'High',
      'Automated weekly steward workload reports',
      'Send automated email reports to stewards every Monday morning with their active cases, upcoming deadlines, and win rate statistics. Would save 2-3 hours per week of manual reporting.',
      'Planned',
      10,
      'Complex',
      Utilities.formatDate(nextMonth, Session.getScriptTimeZone(), 'MM/dd/yyyy'),
      'Development Team',
      'Need to set up Gmail API integration',
      'Aligns with Phase 7 automation goals',
      Utilities.formatDate(today, Session.getScriptTimeZone(), 'MM/dd/yyyy')
    ],
    [
      'Bug Report',
      Utilities.formatDate(today, Session.getScriptTimeZone(), 'MM/dd/yyyy'),
      'Sarah Chen',
      'High',
      'Member search not finding partial matches',
      'When searching for members, the search only works with exact matches. Searching for "John" doesn\'t find "John Smith" or "Johnson". This makes it difficult to quickly look up members.',
      'New',
      0,
      'Simple',
      Utilities.formatDate(new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000), Session.getScriptTimeZone(), 'MM/dd/yyyy'),
      'Unassigned',
      'None',
      'Need to update search algorithm to support partial matching',
      Utilities.formatDate(today, Session.getScriptTimeZone(), 'MM/dd/yyyy')
    ]
  ];

  const lastRow = feedback.getLastRow();
  feedback.getRange(lastRow + 1, 1, sampleEntries.length, sampleEntries[0].length).setValues(sampleEntries);

  SpreadsheetApp.getUi().alert('‚úÖ Added 3 sample feedback entries to Feedback & Development sheet');
}

/**
 * Populate Steward Workload sheet with live data from Grievance Log
 */
function populateStewardWorkload() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const workloadSheet = ss.getSheetByName(SHEETS.STEWARD_WORKLOAD);
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (!workloadSheet || !grievanceSheet || !memberSheet) {
    SpreadsheetApp.getUi().alert('‚ùå Required sheets not found!');
    return;
  }

  // Get all grievance data
  const grievanceData = grievanceSheet.getDataRange().getValues();
  const memberData = memberSheet.getDataRange().getValues();

  // Build steward lookup map (Steward Name -> Steward info)
  // Note: Grievance Log uses steward NAMES, not member IDs, so we key by name
  const stewards = {};
  for (let i = 1; i < memberData.length; i++) {
    const row = memberData[i];
    const isSteward = row[MEMBER_COLS.IS_STEWARD - 1];
    if (isSteward === 'Yes') {
      const memberId = row[MEMBER_COLS.MEMBER_ID - 1];
      const name = `${row[MEMBER_COLS.FIRST_NAME - 1]} ${row[MEMBER_COLS.LAST_NAME - 1]}`.trim();
      const email = row[MEMBER_COLS.EMAIL - 1];
      const phone = row[MEMBER_COLS.PHONE - 1];
      // Use name as key since Grievance Log references stewards by name
      stewards[name] = {
        memberId: memberId,
        name: name,
        email: email,
        phone: phone,
        totalCases: 0,
        activeCases: 0,
        resolvedCases: 0,
        wonCases: 0,
        resolutionDays: []
      };
    }
  }

  // Process grievances
  const today = new Date();
  for (let i = 1; i < grievanceData.length; i++) {
    const row = grievanceData[i];
    const stewardName = row[GRIEVANCE_COLS.STEWARD - 1]; // Assigned Steward (Name)
    const status = row[GRIEVANCE_COLS.STATUS - 1];
    const outcome = row[GRIEVANCE_COLS.RESOLUTION - 1]; // Resolution/Outcome
    const daysOpen = row[GRIEVANCE_COLS.DAYS_OPEN - 1];

    // Match steward by name (trim whitespace for consistent matching)
    const normalizedName = stewardName ? stewardName.toString().trim() : '';
    if (normalizedName && stewards[normalizedName]) {
      stewards[normalizedName].totalCases++;

      if (status === 'Open' || status === 'Pending Info') {
        stewards[normalizedName].activeCases++;
      } else if (status === 'Settled' || status === 'Resolved' || status === 'Closed') {
        stewards[normalizedName].resolvedCases++;

        if (outcome === 'Won' || outcome === 'Partially Won') {
          stewards[normalizedName].wonCases++;
        }

        if (daysOpen && !isNaN(daysOpen)) {
          stewards[normalizedName].resolutionDays.push(parseFloat(daysOpen));
        }
      }
    }
  }

  // Build output data
  const outputData = [];
  for (const stewardId in stewards) {
    const s = stewards[stewardId];
    const winRate = s.resolvedCases > 0 ? (s.wonCases / s.resolvedCases * 100) : 0;
    const avgDays = s.resolutionDays.length > 0
      ? s.resolutionDays.reduce(function(a, b) { return a + b; }, 0) / s.resolutionDays.length
      : 0;

    // Capacity status based on active cases
    let capacityStatus;
    if (s.activeCases === 0) {
      capacityStatus = 'Available';
    } else if (s.activeCases <= 5) {
      capacityStatus = 'Normal';
    } else if (s.activeCases <= 10) {
      capacityStatus = 'Busy';
    } else {
      capacityStatus = 'Overloaded';
    }

    outputData.push([
      s.name,
      s.totalCases,
      s.activeCases,
      s.resolvedCases,
      Math.round(winRate),
      Math.round(avgDays),
      0, // Overdue cases - would need deadline calculation
      0, // Due this week - would need deadline calculation
      capacityStatus,
      s.email || '',
      s.phone || ''
    ]);
  }

  // Sort by active cases (descending)
  outputData.sort(function(a, b) { return b[2] - a[2]; });

  // Clear existing data (keep headers)
  const lastRow = workloadSheet.getLastRow();
  if (lastRow > 3) {
    workloadSheet.getRange(4, 1, lastRow - 3, 11).clear();
  }

  // Write new data
  if (outputData.length > 0) {
    workloadSheet.getRange(4, 1, outputData.length, 11).setValues(outputData);
  }

  Logger.log(`‚úÖ Populated Steward Workload with ${outputData.length} stewards`);
}

/**
 * Populate Member Satisfaction sheet with sample survey data
 */
function populateMemberSatisfaction() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const satisfactionSheet = ss.getSheetByName(SHEETS.MEMBER_SATISFACTION);
  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (!satisfactionSheet || !memberSheet) {
    SpreadsheetApp.getUi().alert('‚ùå Required sheets not found!');
    return;
  }

  // Get member data
  const memberData = memberSheet.getDataRange().getValues();

  // Generate 50 sample survey responses
  const sampleSurveys = [];
  const today = new Date();

  for (let i = 0; i < 50; i++) {
    // Pick a random member (skip header row)
    const randomMemberIndex = Math.floor(Math.random() * (memberData.length - 1)) + 1;
    const member = memberData[randomMemberIndex];
    const memberId = member[0];
    const memberName = `${member[1]} ${member[2]}`;

    // Generate survey dates
    const sentDaysAgo = Math.floor(Math.random() * 60) + 1; // 1-60 days ago
    const completedDaysAgo = sentDaysAgo - Math.floor(Math.random() * 7); // Within a week of being sent

    const dateSent = new Date(today.getTime() - sentDaysAgo * 24 * 60 * 60 * 1000);
    const dateCompleted = completedDaysAgo > 0 ? new Date(today.getTime() - completedDaysAgo * 24 * 60 * 60 * 1000) : '';

    // Generate ratings (weighted toward positive)
    const overallSat = Math.random() < 0.7 ? (4 + Math.floor(Math.random() * 2)) : (3 + Math.floor(Math.random() * 2));
    const stewardSupport = Math.random() < 0.75 ? (4 + Math.floor(Math.random() * 2)) : (3 + Math.floor(Math.random() * 2));
    const communication = Math.random() < 0.65 ? (4 + Math.floor(Math.random() * 2)) : (3 + Math.floor(Math.random() * 2));
    const wouldRecommend = overallSat >= 4 ? 'Y' : (Math.random() < 0.7 ? 'Y' : 'N');

    // Generate realistic comments
    const comments = [
      'My steward was very helpful and responsive',
      'Great communication throughout the process',
      'Could use faster response times',
      'Very satisfied with the support I received',
      'Steward went above and beyond',
      'Process was clear and well-explained',
      'Would like more frequent updates',
      'Excellent representation',
      'Professional and knowledgeable',
      'Satisfied overall',
      ''
    ];
    const comment = comments[Math.floor(Math.random() * comments.length)];

    sampleSurveys.push([
      `SURVEY-${String(i + 1).padStart(4, '0')}`,
      memberId,
      memberName,
      Utilities.formatDate(dateSent, Session.getScriptTimeZone(), 'MM/dd/yyyy'),
      dateCompleted ? Utilities.formatDate(dateCompleted, Session.getScriptTimeZone(), 'MM/dd/yyyy') : '',
      overallSat,
      stewardSupport,
      communication,
      wouldRecommend,
      comment
    ]);
  }

  // Clear existing data (keep headers)
  const lastRow = satisfactionSheet.getLastRow();
  if (lastRow > 3) {
    satisfactionSheet.getRange(4, 1, lastRow - 3, 10).clear();
  }

  // Write new data
  if (sampleSurveys.length > 0) {
    satisfactionSheet.getRange(4, 1, sampleSurveys.length, 10).setValues(sampleSurveys);
  }

  SpreadsheetApp.getUi().alert(`‚úÖ Added ${sampleSurveys.length} sample surveys to Member Satisfaction sheet`);
  Logger.log(`‚úÖ Populated Member Satisfaction with ${sampleSurveys.length} surveys`);
}

/**
 * Populate all analytics sheets with live data
 */
function populateAllAnalyticsSheets() {
  const ui = SpreadsheetApp.getUi();

  ui.alert('‚è≥ Populating analytics sheets...\n\nThis may take a moment.');

  try {
    // Populate Steward Workload
    populateStewardWorkload();

    // Populate Member Satisfaction
    populateMemberSatisfaction();

    // Note: Other analytics sheets (Trends, Location, etc.) use formulas and auto-populate
    // Performance, Quick Stats, Executive Dashboard, KPI Performance, etc. all use formulas

    ui.alert('‚úÖ Analytics sheets populated successfully!');
  } catch (error) {
    ui.alert('‚ùå Error populating analytics: ' + error.message);
    Logger.log('Error in populateAllAnalyticsSheets: ' + error.message);
  }
}

/**
 * Hide the Diagnostics tab
 */
function hideDiagnosticsTab() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const diagnostics = ss.getSheetByName(SHEETS.DIAGNOSTICS);

  if (diagnostics) {
    diagnostics.hideSheet();
    SpreadsheetApp.getUi().alert('‚úÖ Diagnostics tab is now hidden');
  } else {
    SpreadsheetApp.getUi().alert('‚ùå Diagnostics sheet not found');
  }
}

/**
 * Add all dropdown validations and conditional formatting to Member Directory
 */
function setupMemberDirectoryValidations() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const memberDir = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (!memberDir) {
    SpreadsheetApp.getUi().alert('‚ùå Member Directory sheet not found!');
    return;
  }

  // Get dropdown values from Config sheet using dynamic helpers
  const dropdowns = getMemberDirectoryDropdownValues();
  const jobTitles = dropdowns.jobTitles;
  const locations = dropdowns.locations;
  const units = dropdowns.units;
  const supervisors = dropdowns.supervisors;
  const managers = dropdowns.managers;
  const stewards = dropdowns.stewards;

  // Define dropdown ranges (2 = first data row, 5000 = max rows)
  const MAX_ROWS = 5000;

  // Job Title (Column D = 4)
  if (jobTitles.length > 0) {
    const jobTitleRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(jobTitles, true)
      .setAllowInvalid(false)
      .build();
    memberDir.getRange(2, 4, MAX_ROWS, 1).setDataValidation(jobTitleRule);
  }

  // Work Location (Column E = 5)
  if (locations.length > 0) {
    const locationRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(locations, true)
      .setAllowInvalid(false)
      .build();
    memberDir.getRange(2, 5, MAX_ROWS, 1).setDataValidation(locationRule);
  }

  // Unit (Column F = 6)
  if (units.length > 0) {
    const unitRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(units, true)
      .setAllowInvalid(false)
      .build();
    memberDir.getRange(2, 6, MAX_ROWS, 1).setDataValidation(unitRule);
  }

  // Office Days (Column G = 7) - Allow multiple selections as comma-separated
  const officeDaysRule = SpreadsheetApp.newDataValidation()
    .requireTextContains("")
    .setAllowInvalid(true)
    .setHelpText('Enter multiple days comma-separated (e.g., "Monday, Wednesday, Friday")')
    .build();
  memberDir.getRange(2, 7, MAX_ROWS, 1).setDataValidation(officeDaysRule);

  // Is Steward (Column J = 10)
  const yesNoRule = SpreadsheetApp.newDataValidation()
    .requireValueInList(['Yes', 'No'], true)
    .setAllowInvalid(false)
    .build();
  memberDir.getRange(2, 10, MAX_ROWS, 1).setDataValidation(yesNoRule);

  // Supervisor (Column K = 11)
  if (supervisors.length > 0) {
    const supervisorRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(supervisors, true)
      .setAllowInvalid(false)
      .build();
    memberDir.getRange(2, 11, MAX_ROWS, 1).setDataValidation(supervisorRule);
  }

  // Manager (Column L = 12)
  if (managers.length > 0) {
    const managerRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(managers, true)
      .setAllowInvalid(false)
      .build();
    memberDir.getRange(2, 12, MAX_ROWS, 1).setDataValidation(managerRule);
  }

  // Assigned Steward (Column M = 13) and Steward Who Contacted Member (Column AD = 30)
  if (stewards.length > 0) {
    const stewardRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(stewards, true)
      .setAllowInvalid(false)
      .build();
    memberDir.getRange(2, 13, MAX_ROWS, 1).setDataValidation(stewardRule);
    memberDir.getRange(2, 30, MAX_ROWS, 1).setDataValidation(stewardRule);
  }

  // Interest: Local Actions (Column T = 20)
  memberDir.getRange(2, 20, MAX_ROWS, 1).setDataValidation(yesNoRule);

  // Interest: Chapter Actions (Column U = 21)
  memberDir.getRange(2, 21, MAX_ROWS, 1).setDataValidation(yesNoRule);

  // Interest: Allied Chapter Actions (Column V = 22)
  memberDir.getRange(2, 22, MAX_ROWS, 1).setDataValidation(yesNoRule);

  // Preferred Communication Methods (Column X = 24) - Multiple selections
  const commMethodsRule = SpreadsheetApp.newDataValidation()
    .requireTextContains("")
    .setAllowInvalid(true)
    .setHelpText('Enter multiple methods comma-separated (e.g., "Email, Phone, Text")')
    .build();
  memberDir.getRange(2, 24, MAX_ROWS, 1).setDataValidation(commMethodsRule);

  // Best Time(s) to Reach Member (Column Y = 25) - Multiple selections
  const bestTimeRule = SpreadsheetApp.newDataValidation()
    .requireValueInList(['Morning (8am-12pm)', 'Afternoon (12pm-5pm)', 'Evening (5pm-8pm)', 'Anytime'], true)
    .setAllowInvalid(true)
    .setHelpText('Select one or enter multiple comma-separated')
    .build();
  memberDir.getRange(2, 25, MAX_ROWS, 1).setDataValidation(bestTimeRule);

  // Add conditional formatting for empty email/phone
  // Email (Column H = 8) - Red background if empty
  const emailRule = SpreadsheetApp.newConditionalFormatRule()
    .whenFormulaSatisfied('=AND(A2<>"", H2="")')
    .setBackground('#DC2626')
    .setFontColor('#FFFFFF')
    .setRanges([memberDir.getRange(2, 8, MAX_ROWS, 1)])
    .build();

  // Phone (Column I = 9) - Red background if empty
  const phoneRule = SpreadsheetApp.newConditionalFormatRule()
    .whenFormulaSatisfied('=AND(A2<>"", I2="")')
    .setBackground('#DC2626')
    .setFontColor('#FFFFFF')
    .setRanges([memberDir.getRange(2, 9, MAX_ROWS, 1)])
    .build();

  const rules = memberDir.getConditionalFormatRules();
  rules.push(emailRule);
  rules.push(phoneRule);
  memberDir.setConditionalFormatRules(rules);

  SpreadsheetApp.getUi().alert('‚úÖ Member Directory validations and formatting applied!');
}

/**
 * Add Google Drive folder link column to Grievance Log
 */
function addGoogleDriveLinkToGrievanceLog() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceLog = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!grievanceLog) {
    SpreadsheetApp.getUi().alert('‚ùå Grievance Log not found!');
    return;
  }

  // Insert column after Resolution Summary (last column)
  const lastCol = grievanceLog.getLastColumn();
  grievanceLog.insertColumnAfter(lastCol);

  // Set header
  grievanceLog.getRange(1, lastCol + 1)
    .setValue('üìÅ Drive Folder Link')
    .setFontWeight('bold')
    .setBackground('#DC2626')
    .setFontColor('#FFFFFF')
    .setWrap(true);

  // Add note to header
  grievanceLog.getRange(1, lastCol + 1)
    .setNote('Paste Google Drive folder link for this grievance. Create folder with grievant name.');

  SpreadsheetApp.getUi().alert('‚úÖ Google Drive folder link column added to Grievance Log!');
}

/**
 * Add status bars for grievance dates (visual deadline tracking)
 */
function addGrievanceDateStatusBars() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceLog = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!grievanceLog) {
    SpreadsheetApp.getUi().alert('‚ùå Grievance Log not found!');
    return;
  }

  const MAX_ROWS = 5000;

  // Days to Deadline (Column U = 21) - Color-coded based on urgency
  const urgentRule = SpreadsheetApp.newConditionalFormatRule()
    .whenNumberLessThan(0)
    .setBackground('#DC2626')  // Red - OVERDUE
    .setFontColor('#FFFFFF')
    .setRanges([grievanceLog.getRange(2, 21, MAX_ROWS, 1)])
    .build();

  const warningRule = SpreadsheetApp.newConditionalFormatRule()
    .whenNumberBetween(0, 3)
    .setBackground('#F97316')  // Orange - URGENT (0-3 days)
    .setFontColor('#FFFFFF')
    .setRanges([grievanceLog.getRange(2, 21, MAX_ROWS, 1)])
    .build();

  const cautionRule = SpreadsheetApp.newConditionalFormatRule()
    .whenNumberBetween(4, 7)
    .setBackground('#FCD34D')  // Yellow - CAUTION (4-7 days)
    .setFontColor('#000000')
    .setRanges([grievanceLog.getRange(2, 21, MAX_ROWS, 1)])
    .build();

  const okRule = SpreadsheetApp.newConditionalFormatRule()
    .whenNumberGreaterThan(7)
    .setBackground('#10B981')  // Green - OK (8+ days)
    .setFontColor('#FFFFFF')
    .setRanges([grievanceLog.getRange(2, 21, MAX_ROWS, 1)])
    .build();

  const rules = grievanceLog.getConditionalFormatRules();
  rules.push(urgentRule, warningRule, cautionRule, okRule);
  grievanceLog.setConditionalFormatRules(rules);

  SpreadsheetApp.getUi().alert('‚úÖ Date status bars added to Grievance Log!');
}

/**
 * Setup all dashboard enhancements
 */
function SETUP_DASHBOARD_ENHANCEMENTS() {
  const ui = SpreadsheetApp.getUi();

  const response = ui.alert(
    'üé® Setup Dashboard Enhancements',
    'This will add:\n\n' +
    '‚úì Dropdowns for all Member Directory fields\n' +
    '‚úì Red highlighting for missing email/phone\n' +
    '‚úì Google Drive folder link to Grievance Log\n' +
    '‚úì Color-coded status bars for deadlines\n\n' +
    'Continue?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return;
  }

  try {
    ui.alert('‚è≥ Applying enhancements...');

    setupMemberDirectoryValidations();
    addGoogleDriveLinkToGrievanceLog();
    addGrievanceDateStatusBars();

    ui.alert(
      '‚úÖ Enhancements Complete!',
      'All dropdown validations, conditional formatting, and visual enhancements have been applied.\n\n' +
      'Member Directory: Dropdowns active + red highlighting for empty email/phone\n' +
      'Grievance Log: Drive folder link column added + color-coded deadline tracking',
      ui.ButtonSet.OK
    );
  } catch (error) {
    ui.alert('‚ùå Error: ' + error.message);
    Logger.log('Error in SETUP_DASHBOARD_ENHANCEMENTS: ' + error.message);
  }
}



// ================================================================================
// MODULE: DataArchiving.gs
// Source: DataArchiving.gs
// ================================================================================

/**
 * ============================================================================
 * DATA ARCHIVING - Automatic Archive of Old Grievances
 * ============================================================================
 *
 * Moves closed grievances older than configured threshold to Archive sheet.
 * Maintains performance as data grows over time.
 *
 * @module DataArchiving
 * @version 2.1.0
 * ============================================================================
 */

/**
 * Archives old closed grievances to Archive sheet
 * Moves grievances closed for more than NUMERIC_CONSTANTS.ARCHIVE_AFTER_YEARS years
 *
 * @param {boolean} dryRun - If true, only count what would be archived
 * @returns {Object} Result with counts and details
 */
function archiveOldGrievances(dryRun = false) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceLog = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  const archive = ss.getSheetByName(SHEETS.ARCHIVE);

  if (!grievanceLog) {
    throw new Error(ERROR_MESSAGES.SHEET_NOT_FOUND(SHEETS.GRIEVANCE_LOG));
  }

  if (!archive) {
    throw new Error(ERROR_MESSAGES.SHEET_NOT_FOUND(SHEETS.ARCHIVE) +
                    ' Please create Archive sheet first.');
  }

  // Calculate cutoff date
  const cutoffDate = new Date();
  cutoffDate.setFullYear(cutoffDate.getFullYear() - NUMERIC_CONSTANTS.ARCHIVE_AFTER_YEARS);

  const data = grievanceLog.getDataRange().getValues();
  const headers = data[0];
  const toArchive = [];
  const toKeep = [headers]; // Keep header

  let archivedCount = 0;
  let keptCount = 0;

  // Process each row
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    const status = row[GRIEVANCE_COLS.STATUS - 1];
    const dateClosed = row[GRIEVANCE_COLS.DATE_CLOSED - 1];

    // Archive if closed/settled and older than cutoff
    const shouldArchive =
      (status === 'Closed' || status === 'Settled' || status === 'Withdrawn') &&
      dateClosed &&
      dateClosed instanceof Date &&
      dateClosed < cutoffDate;

    if (shouldArchive) {
      toArchive.push(row);
      archivedCount++;
    } else {
      toKeep.push(row);
      keptCount++;
    }
  }

  const result = {
    totalProcessed: data.length - 1, // Exclude header
    archivedCount: archivedCount,
    keptCount: keptCount,
    cutoffDate: cutoffDate,
    dryRun: dryRun
  };

  // If dry run, just return counts
  if (dryRun) {
    Logger.log(`Dry run: Would archive ${archivedCount} grievances`);
    return result;
  }

  // Move to archive in batches
  if (toArchive.length > 0) {
    SpreadsheetApp.getActive().toast(
      ERROR_MESSAGES.IN_PROGRESS(`Archiving ${toArchive.length} grievances`),
      'Archiving',
      -1
    );

    const batchSize = NUMERIC_CONSTANTS.ARCHIVE_BATCH_SIZE;
    for (let i = 0; i < toArchive.length; i += batchSize) {
      const batch = toArchive.slice(i, i + batchSize);
      const lastRow = archive.getLastRow();

      archive.getRange(lastRow + 1, 1, batch.length, batch[0].length)
            .setValues(batch);

      SpreadsheetApp.flush();

      // Update progress
      const progress = Math.min(100, Math.round(((i + batch.length) / toArchive.length) * 100));
      SpreadsheetApp.getActive().toast(
        `Archiving... ${i + batch.length}/${toArchive.length} (${progress}%)`,
        'Progress',
        NUMERIC_CONSTANTS.TOAST_DURATION_SHORT
      );
    }

    // Update main grievance log
    grievanceLog.clear();
    grievanceLog.getRange(1, 1, toKeep.length, toKeep[0].length)
                .setValues(toKeep);

    SpreadsheetApp.flush();

    // Log the archiving event
    logAuditEvent('DATA_ARCHIVED', {
      grievances_archived: archivedCount,
      cutoff_date: cutoffDate.toISOString()
    }, 'INFO');

    SpreadsheetApp.getActive().toast(
      ERROR_MESSAGES.SUCCESS(`Archived ${archivedCount} old grievances`),
      'Complete',
      NUMERIC_CONSTANTS.TOAST_DURATION_MEDIUM
    );
  } else {
    SpreadsheetApp.getActive().toast(
      'No grievances to archive',
      'Info',
      NUMERIC_CONSTANTS.TOAST_DURATION_SHORT
    );
  }

  return result;
}

/**
 * Shows archive dialog with preview
 */
function showArchiveDialog() {
  // Run dry run to get counts
  const dryRunResult = archiveOldGrievances(true);

  const html = createArchiveDialogHTML(dryRunResult);

  SpreadsheetApp.getUi().showModalDialog(
    HtmlService.createHtmlOutput(html).setWidth(600).setHeight(400),
    'üì¶ Archive Old Grievances'
  );
}

/**
 * Creates HTML for archive dialog
 *
 * @param {Object} dryRunResult - Result from dry run
 * @returns {string} HTML content
 */
function createArchiveDialogHTML(dryRunResult) {
  const styles = getCommonDialogStyles();

  const body = `
    <div class="container">
      <h2>üì¶ Archive Old Grievances</h2>

      ${createInfoBox(
        'Archive Policy',
        `Grievances closed for more than ${NUMERIC_CONSTANTS.ARCHIVE_AFTER_YEARS} years will be moved to the Archive sheet.`,
        'info'
      )}

      <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 15px 0;">
        <h3 style="margin-top: 0;">Preview:</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div>
            <strong>Total Grievances:</strong><br>
            ${dryRunResult.totalProcessed}
          </div>
          <div>
            <strong>To Archive:</strong><br>
            <span style="color: #f97316; font-size: 20px; font-weight: bold;">
              ${dryRunResult.archivedCount}
            </span>
          </div>
          <div>
            <strong>To Keep:</strong><br>
            ${dryRunResult.keptCount}
          </div>
          <div>
            <strong>Cutoff Date:</strong><br>
            ${dryRunResult.cutoffDate.toLocaleDateString()}
          </div>
        </div>
      </div>

      ${dryRunResult.archivedCount > 0 ? createInfoBox(
        'Warning',
        'This action will move ' + dryRunResult.archivedCount + ' grievances to the Archive sheet. ' +
        'The Archive sheet will still be accessible, but archived grievances will not appear in reports.',
        'warning'
      ) : ''}

      <div class="button-group">
        <button class="btn-secondary" onclick="google.script.host.close()">
          Cancel
        </button>
        <button
          class="btn-primary"
          onclick="archiveNow()"
          ${dryRunResult.archivedCount === 0 ? 'disabled' : ''}
        >
          Archive ${dryRunResult.archivedCount} Grievances
        </button>
      </div>

      ${createLoadingSpinner('Archiving...', 'archiving')}
    </div>
  `;

  const scripts = `
    function archiveNow() {
      document.getElementById('archiving').style.display = 'block';
      google.script.run
        .withSuccessHandler(onArchiveComplete)
        .withFailureHandler(onArchiveError)
        .archiveOldGrievances(false);
    }

    function onArchiveComplete(result) {
      alert('‚úÖ Successfully archived ' + result.archivedCount + ' grievances');
      google.script.host.close();
    }

    function onArchiveError(error) {
      document.getElementById('archiving').style.display = 'none';
      alert('‚ùå Error: ' + error.message);
    }
  `;

  return createHTMLPage('Archive Old Grievances', styles, body, scripts);
}

/**
 * Restores grievances from archive back to main log
 *
 * @param {Array<string>} grievanceIds - Array of grievance IDs to restore
 * @returns {Object} Result with counts
 */
function restoreFromArchive(grievanceIds) {
  requireRole('ADMIN', 'Restore from Archive');

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceLog = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  const archive = ss.getSheetByName(SHEETS.ARCHIVE);

  if (!grievanceLog || !archive) {
    throw new Error('Required sheets not found');
  }

  const archiveData = archive.getDataRange().getValues();
  const headers = archiveData[0];
  const toRestore = [];
  const remainingInArchive = [headers];

  let restoredCount = 0;

  // Find grievances to restore
  for (let i = 1; i < archiveData.length; i++) {
    const row = archiveData[i];
    const grievanceId = row[GRIEVANCE_COLS.GRIEVANCE_ID - 1];

    if (grievanceIds.includes(grievanceId)) {
      toRestore.push(row);
      restoredCount++;
    } else {
      remainingInArchive.push(row);
    }
  }

  if (toRestore.length > 0) {
    // Add back to grievance log
    const lastRow = grievanceLog.getLastRow();
    grievanceLog.getRange(lastRow + 1, 1, toRestore.length, toRestore[0].length)
                .setValues(toRestore);

    // Update archive (remove restored items)
    archive.clear();
    archive.getRange(1, 1, remainingInArchive.length, remainingInArchive[0].length)
           .setValues(remainingInArchive);

    SpreadsheetApp.flush();

    logAuditEvent('DATA_RESTORED', {
      grievances_restored: restoredCount,
      grievance_ids: grievanceIds
    }, 'INFO');
  }

  return {
    restoredCount: restoredCount,
    notFound: grievanceIds.length - restoredCount
  };
}

/**
 * Gets statistics about archived data
 *
 * @returns {Object} Archive statistics
 */
function getArchiveStats() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const archive = ss.getSheetByName(SHEETS.ARCHIVE);

  if (!archive) {
    return {
      totalArchived: 0,
      oldestDate: null,
      newestDate: null,
      byStatus: {}
    };
  }

  const data = archive.getDataRange().getValues();
  const stats = {
    totalArchived: data.length - 1, // Exclude header
    oldestDate: null,
    newestDate: null,
    byStatus: {}
  };

  for (let i = 1; i < data.length; i++) {
    const dateClosed = data[i][GRIEVANCE_COLS.DATE_CLOSED - 1];
    const status = data[i][GRIEVANCE_COLS.STATUS - 1];

    // Track dates
    if (dateClosed instanceof Date) {
      if (!stats.oldestDate || dateClosed < stats.oldestDate) {
        stats.oldestDate = dateClosed;
      }
      if (!stats.newestDate || dateClosed > stats.newestDate) {
        stats.newestDate = dateClosed;
      }
    }

    // Count by status
    stats.byStatus[status] = (stats.byStatus[status] || 0) + 1;
  }

  return stats;
}



// ================================================================================
// MODULE: ADHDEnhancements.gs
// Source: ADHDEnhancements.gs
// ================================================================================

// ------------------------------------------------------------------------====
// ADHD-FRIENDLY ENHANCEMENTS
// ------------------------------------------------------------------------====
//
// Features optimized for ADHD users:
// - No gridlines (cleaner visual)
// - Soft, calming colors
// - Visual icons and cues
// - Minimal text, maximum visuals
// - Quick-glance data display
// - User customization options
//
// ------------------------------------------------------------------------====

/**
 * Hide gridlines on all dashboard sheets for cleaner, less distracting view
 */
function hideAllGridlines() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = ss.getSheets();

  sheets.forEach(function(sheet) {
    const sheetName = sheet.getName();

    // Hide gridlines on all sheets except Config (for editing)
    if (!sheetName.includes('Config') &&
        !sheetName.includes('Member Directory') &&
        !sheetName.includes('Grievance Log')) {
      sheet.setHiddenGridlines(true);
    }
  });

  SpreadsheetApp.getUi().alert('‚úÖ Gridlines hidden on all dashboards!\n\nData sheets (Member Directory, Grievance Log) still show gridlines for easier editing.');
}

/**
 * Show gridlines on all sheets (if user needs them back)
 */
function showAllGridlines() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = ss.getSheets();

  sheets.forEach(function(sheet) {
    sheet.showGridlines();
  });

  SpreadsheetApp.getUi().alert('‚úÖ Gridlines shown on all sheets.');
}

/**
 * Reorder sheets in a logical, user-friendly sequence
 */
function reorderSheetsLogically() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  SpreadsheetApp.getUi().alert('üìë Reordering sheets...\n\nPlease wait while sheets are reorganized.');

  // Logical order:
  // 1. Interactive Dashboard (YOUR custom view)
  // 2. Main Dashboard (overview)
  // 3. Member Directory (data)
  // 4. Grievance Log (data)
  // 5. Steward Workload (team view)
  // 6. Test dashboards (1-9)
  // 7. Analytics Data
  // 8. Admin sheets (Config, Archive, etc.)

  // FIXED: Use only valid sheet names from SHEETS constant
  const sheetOrder = [
    SHEETS.INTERACTIVE_DASHBOARD,  // 1. YOUR Custom View (most important for daily use)
    SHEETS.DASHBOARD,              // 2. Main Overview
    SHEETS.MEMBER_DIR,             // 3. Members
    SHEETS.GRIEVANCE_LOG,          // 4. Grievances
    SHEETS.STEWARD_WORKLOAD,       // 5. Workload
    SHEETS.TRENDS,                 // 6. Trends & Timeline
    SHEETS.LOCATION,               // 7. Location Analytics
    SHEETS.TYPE_ANALYSIS,          // 8. Type Analysis
    SHEETS.EXECUTIVE_DASHBOARD,    // 9. Executive Dashboard
    SHEETS.KPI_PERFORMANCE,        // 10. KPI Performance
    SHEETS.MEMBER_ENGAGEMENT,      // 11. Member Engagement
    SHEETS.COST_IMPACT,            // 12. Cost Impact
    SHEETS.MEMBER_SATISFACTION,    // 13. Member Satisfaction
    SHEETS.FEEDBACK,               // 14. Feedback & Development
    SHEETS.ANALYTICS,              // 15. Analytics Data
    SHEETS.CONFIG,                 // 16. Config
    SHEETS.ARCHIVE,                // 17. Archive
    SHEETS.DIAGNOSTICS             // 18. Diagnostics
  ];

  // Move sheets to correct positions
  sheetOrder.forEach(function(sheetName, index) {
    const sheet = ss.getSheetByName(sheetName);
    if (sheet) {
      ss.setActiveSheet(sheet);
      ss.moveActiveSheet(index + 1);
    }
  });

  // Set Interactive Dashboard as active (first sheet)
  const interactiveSheet = ss.getSheetByName(SHEETS.INTERACTIVE_DASHBOARD);
  if (interactiveSheet) {
    ss.setActiveSheet(interactiveSheet);
  }

  SpreadsheetApp.getUi().alert('‚úÖ Sheets reordered!\n\n' +
    'üìä Your Custom View is now first\n' +
    'üìà Dashboards ‚Üí Data ‚Üí Tests ‚Üí Admin\n\n' +
    'Open this spreadsheet to see your Interactive Dashboard first every time!');
}

/**
 * Add visual instructions to Steward Workload sheet
 */
function addStewardWorkloadInstructions() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEETS.STEWARD_WORKLOAD);

  if (!sheet) {
    SpreadsheetApp.getUi().alert('‚ùå Steward Workload sheet not found!');
    return;
  }

  // Insert instruction box at top
  sheet.insertRowsBefore(1, 8);

  // Create visual instruction panel
  sheet.getRange("A1:N1").merge()
    .setValue("üë®‚Äç‚öñÔ∏è HOW THIS SHEET WORKS - STEWARD WORKLOAD TRACKER")
    .setFontSize(16)
    .setFontWeight("bold")
    .setBackground(COLORS.PRIMARY_BLUE)
    .setFontColor("white")
    .setFontFamily("Roboto")
    .setHorizontalAlignment("center")
    .setVerticalAlignment("middle");

  sheet.setRowHeight(1, 40);

  // Visual guide boxes (using icons and colors)
  const instructionData = [
    ["üéØ WHAT IT SHOWS", "This sheet automatically tracks how many cases each steward is handling"],
    ["üìä AUTO-UPDATES", "Updates when you rebuild the dashboard (509 Tools > Data Management > Rebuild Dashboard)"],
    ["üü¢ GREEN = Good", "Steward has manageable workload (few or no overdue cases)"],
    ["üü° YELLOW = Watch", "Steward approaching capacity (some due soon)"],
    ["üî¥ RED = Help!", "Steward needs help (overdue cases or heavy workload)"],
    ["üëÄ QUICK GLANCE", "Look at 'Overdue Cases' column - RED numbers need immediate action"]
  ];

  // Create colored instruction boxes
  instructionData.forEach(function(instruction, index) {
    const row = index + 2;

    // Label column (A-B)
    sheet.getRange(row, 1, 1, 2).merge()
      .setValue(instruction[0])
      .setFontWeight("bold")
      .setFontSize(11)
      .setFontFamily("Roboto")
      .setBackground(COLORS.INFO_LIGHT)
      .setFontColor(COLORS.TEXT_DARK)
      .setHorizontalAlignment("center")
      .setVerticalAlignment("middle")
      .setWrap(true);

    // Description column (C-N)
    sheet.getRange(row, 3, 1, 12).merge()
      .setValue(instruction[1])
      .setFontSize(10)
      .setFontFamily("Roboto")
      .setBackground(COLORS.CARD_BG)
      .setFontColor(COLORS.TEXT_DARK)
      .setHorizontalAlignment("left")
      .setVerticalAlignment("middle")
      .setWrap(true);

    sheet.setRowHeight(row, 32);
  });

  // Add separator row
  sheet.getRange("A8:N8").merge()
    .setValue("üìã STEWARD DATA BELOW ‚Üì")
    .setFontSize(12)
    .setFontWeight("bold")
    .setBackground(COLORS.ACCENT_TEAL)
    .setFontColor("white")
    .setFontFamily("Roboto")
    .setHorizontalAlignment("center");

  sheet.setRowHeight(8, 30);

  // Hide gridlines for cleaner look
  sheet.setHiddenGridlines(true);

  SpreadsheetApp.getUi().alert('‚úÖ Visual instructions added to Steward Workload!\n\n' +
    'The sheet now has a clear guide at the top showing:\n' +
    '‚Ä¢ What the sheet does\n' +
    '‚Ä¢ How to read it\n' +
    '‚Ä¢ Color codes for quick scanning\n\n' +
    'Gridlines hidden for cleaner viewing.');
}

/**
 * Create a user settings sheet for customization
 */
function createUserSettingsSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName("‚öôÔ∏è User Settings");

  if (!sheet) {
    sheet = ss.insertSheet("‚öôÔ∏è User Settings");
  } else {
    sheet.clear();
  }

  // Title
  sheet.getRange("A1:F1").merge()
    .setValue("‚öôÔ∏è YOUR PERSONAL SETTINGS - Customize Your Dashboard")
    .setFontSize(18)
    .setFontWeight("bold")
    .setBackground(COLORS.PRIMARY_BLUE)
    .setFontColor("white")
    .setFontFamily("Roboto")
    .setHorizontalAlignment("center");

  sheet.setRowHeight(1, 45);

  // Settings sections
  sheet.getRange("A3:F3").merge()
    .setValue("üé® VISUAL PREFERENCES")
    .setFontSize(14)
    .setFontWeight("bold")
    .setBackground(COLORS.ACCENT_TEAL)
    .setFontColor("white")
    .setHorizontalAlignment("center");

  // Setting options
  const settings = [
    ["Setting", "Your Choice", "Options", "", "", "What It Does"],
    ["Show Gridlines?", "No", "Yes, No", "", "", "Toggle gridlines on/off (most ADHD users prefer OFF)"],
    ["Color Theme", "Soft Pastels", "Soft Pastels, High Contrast, Warm Tones, Cool Tones", "", "", "Choose your preferred color scheme"],
    ["Font Size", "Medium", "Small, Medium, Large, Extra Large", "", "", "Adjust text size for comfort"],
    ["Icon Style", "Emoji", "Emoji, Symbols, None", "", "", "Choose how visual cues appear"],
    ["Compact View", "No", "Yes, No", "", "", "Reduce spacing between elements"]
  ];

  sheet.getRange(4, 1, settings.length, 6).setValues(settings);

  // Format header row
  sheet.getRange("A4:F4")
    .setFontWeight("bold")
    .setBackground(COLORS.LIGHT_GRAY)
    .setFontColor(COLORS.TEXT_DARK);

  // Format data rows
  sheet.getRange(5, 1, settings.length - 1, 6)
    .setBackground(COLORS.WHITE)
    .setFontColor(COLORS.TEXT_DARK);

  // Add data validation for choices with improved visual styling
  const yesNoRule = SpreadsheetApp.newDataValidation()
    .requireValueInList(['Yes', 'No'], true)
    .setHelpText('Click to select from dropdown options')
    .build();

  const themeRule = SpreadsheetApp.newDataValidation()
    .requireValueInList(['Soft Pastels', 'High Contrast', 'Warm Tones', 'Cool Tones'], true)
    .setHelpText('Click to select from dropdown options')
    .build();

  const sizeRule = SpreadsheetApp.newDataValidation()
    .requireValueInList(['Small', 'Medium', 'Large', 'Extra Large'], true)
    .setHelpText('Click to select from dropdown options')
    .build();

  const iconRule = SpreadsheetApp.newDataValidation()
    .requireValueInList(['Emoji', 'Symbols', 'None'], true)
    .setHelpText('Click to select from dropdown options')
    .build();

  // Apply dropdown validations
  sheet.getRange("B5").setDataValidation(yesNoRule);
  sheet.getRange("B6").setDataValidation(themeRule);
  sheet.getRange("B7").setDataValidation(sizeRule);
  sheet.getRange("B8").setDataValidation(iconRule);
  sheet.getRange("B9").setDataValidation(yesNoRule);

  // Style dropdown cells to be more noticeable - light blue background with arrow indicator
  const dropdownCells = ["B5", "B6", "B7", "B8", "B9"];
  dropdownCells.forEach(function(cell) {
    sheet.getRange(cell)
      .setBackground("#E0F2FE")  // Light blue to indicate clickable
      .setBorder(true, true, true, true, false, false, "#0EA5E9", SpreadsheetApp.BorderStyle.SOLID_MEDIUM)
      .setFontWeight("bold");
  });

  // Add dropdown indicator column
  sheet.getRange("C5:C9").setValues([["‚ñº Click to choose"], ["‚ñº Click to choose"], ["‚ñº Click to choose"], ["‚ñº Click to choose"], ["‚ñº Click to choose"]])
    .setFontColor("#0EA5E9")
    .setFontSize(9)
    .setFontStyle("italic");

  // Action buttons section
  sheet.getRange("A11:F11").merge()
    .setValue("üîß APPLY YOUR SETTINGS")
    .setFontSize(14)
    .setFontWeight("bold")
    .setBackground(COLORS.ACCENT_PURPLE)
    .setFontColor("white")
    .setHorizontalAlignment("center");

  sheet.getRange("A12:F12").merge()
    .setValue("After changing settings above, go to:\n509 Tools > ADHD Tools > Apply My Settings")
    .setFontSize(11)
    .setFontFamily("Roboto")
    .setBackground(COLORS.INFO_LIGHT)
    .setFontColor(COLORS.TEXT_DARK)
    .setHorizontalAlignment("center")
    .setVerticalAlignment("middle")
    .setWrap(true);

  sheet.setRowHeight(12, 50);

  // Tips section
  sheet.getRange("A14:F14").merge()
    .setValue("üí° TIPS FOR ADHD-FRIENDLY USE")
    .setFontSize(14)
    .setFontWeight("bold")
    .setBackground(COLORS.UNION_GREEN)
    .setFontColor("white")
    .setHorizontalAlignment("center");

  const tips = [
    ["üëÄ", "Use the Interactive Dashboard - it's designed for quick glances"],
    ["üé®", "Turn OFF gridlines for less visual clutter"],
    ["üîç", "Use larger font sizes if text feels overwhelming"],
    ["‚ö°", "Start each day with Quick Stats (Test 9) for fast overview"],
    ["üìå", "Bookmark your favorite Test dashboard for quick access"],
    ["üîî", "Set up desktop notifications for overdue items (Future Feature)"]
  ];

  tips.forEach(function(tip, index) {
    const row = 15 + index;
    sheet.getRange(row, 1).setValue(tip[0])
      .setFontSize(18)
      .setHorizontalAlignment("center");

    sheet.getRange(row, 2, 1, 5).merge()
      .setValue(tip[1])
      .setFontSize(10)
      .setFontFamily("Roboto")
      .setBackground(COLORS.SUCCESS_LIGHT)
      .setWrap(true);

    sheet.setRowHeight(row, 28);
  });

  // Set column widths
  sheet.setColumnWidth(1, 100);
  sheet.setColumnWidth(2, 150);
  sheet.setColumnWidth(3, 200);
  sheet.setColumnWidth(6, 300);

  // Hide gridlines
  sheet.setHiddenGridlines(true);

  SpreadsheetApp.getUi().alert('‚úÖ User Settings sheet created!\n\n' +
    'You can now customize:\n' +
    '‚Ä¢ Gridlines visibility\n' +
    '‚Ä¢ Color themes\n' +
    '‚Ä¢ Font sizes\n' +
    '‚Ä¢ Icon styles\n' +
    '‚Ä¢ Compact view\n\n' +
    'Change settings and use "509 Tools > ADHD Tools > Apply My Settings"');
}

/**
 * Apply user settings from User Settings sheet
 */
function applyUserSettings() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const settingsSheet = ss.getSheetByName("‚öôÔ∏è User Settings");

  if (!settingsSheet) {
    SpreadsheetApp.getUi().alert('‚ùå User Settings sheet not found!\n\nPlease run "509 Tools > ADHD Tools > Create User Settings" first.');
    return;
  }

  // Read user preferences
  const showGridlines = settingsSheet.getRange("B5").getValue();
  const theme = settingsSheet.getRange("B6").getValue();
  const fontSize = settingsSheet.getRange("B7").getValue();
  const iconStyle = settingsSheet.getRange("B8").getValue();
  const compactView = settingsSheet.getRange("B9").getValue();

  // Apply gridlines setting
  if (showGridlines === "Yes") {
    showAllGridlines();
  } else {
    hideAllGridlines();
  }

  // Apply font size (to Interactive Dashboard and Main Dashboard)
  const fontSizeMap = {
    "Small": 9,
    "Medium": 11,
    "Large": 13,
    "Extra Large": 15
  };

  const targetSize = fontSizeMap[fontSize] || 11;

  [SHEETS.INTERACTIVE_DASHBOARD, SHEETS.DASHBOARD].forEach(function(sheetName) {
    const sheet = ss.getSheetByName(sheetName);
    if (sheet) {
      sheet.getDataRange().setFontSize(targetSize);
    }
  });

  SpreadsheetApp.getUi().alert('‚úÖ Your settings have been applied!\n\n' +
    `‚Ä¢ Gridlines: ${showGridlines}\n` +
    `‚Ä¢ Theme: ${theme}\n` +
    `‚Ä¢ Font Size: ${fontSize}\n` +
    `‚Ä¢ Icons: ${iconStyle}\n` +
    `‚Ä¢ Compact View: ${compactView}\n\n` +
    'Your dashboard is now customized to your preferences!');
}

/**
 * Quick setup for ADHD-friendly defaults
 */
function setupADHDDefaults() {
  SpreadsheetApp.getUi().alert('üé® Setting up ADHD-friendly defaults...\n\n' +
    '‚úì Hiding gridlines\n' +
    '‚úì Applying soft colors\n' +
    '‚úì Reordering sheets\n' +
    '‚úì Adding visual guides\n\n' +
    'This will take a moment...');

  try {
    // 1. Hide gridlines
    hideAllGridlines();

    // 2. Reorder sheets
    reorderSheetsLogically();

    // 3. Add Steward Workload instructions
    addStewardWorkloadInstructions();

    // 4. Create user settings
    createUserSettingsSheet();

    SpreadsheetApp.getUi().alert('üéâ ADHD-friendly setup complete!\n\n' +
      '‚úÖ Gridlines hidden\n' +
      '‚úÖ Soft colors applied\n' +
      '‚úÖ Sheets reordered logically\n' +
      '‚úÖ Visual guides added\n' +
      '‚úÖ User settings created\n\n' +
      'Your dashboard is now optimized for ADHD users!\n\n' +
      'Open "üéØ Interactive (Your Custom View)" to start!');
  } catch (error) {
    SpreadsheetApp.getUi().alert('‚ö†Ô∏è Error during setup:\n\n' + error.message);
  }
}



// ================================================================================
// MODULE: AdminGrievanceMessages.gs
// Source: AdminGrievanceMessages.gs
// ================================================================================

/**
 * ============================================================================
 * ADMIN GRIEVANCE MESSAGES - Coordinator Communication System
 * ============================================================================
 *
 * Handles admin-to-steward/grievant messaging with:
 * - Row highlighting when admin flag is checked
 * - Moving flagged rows to top of sheet
 * - Sending email notifications to steward and grievant
 * - Message acknowledgment tracking
 * - Full message trail logging
 *
 * @module AdminGrievanceMessages
 * @version 1.0.0
 * @author SEIU Local 509 Tech Team
 * ============================================================================
 */

/* ==================== CONSTANTS ==================== */

const ADMIN_MESSAGE_HIGHLIGHT_COLOR = '#FFF3CD'; // Light yellow/amber for pending
const ADMIN_MESSAGE_URGENT_COLOR = '#F8D7DA';    // Light red for urgent
const ADMIN_MESSAGE_CLEAR_COLOR = null;          // Clear/no background

/* ==================== TRIGGER HANDLER ==================== */

/**
 * Handles edits to the Grievance Log for admin message functionality
 * Called by onEdit trigger - checks for admin flag or acknowledgment changes
 * @param {Object} e - The edit event object
 */
function onGrievanceAdminEdit(e) {
  if (!e || !e.range) return;

  const sheet = e.range.getSheet();
  if (sheet.getName() !== SHEETS.GRIEVANCE_LOG) return;

  const col = e.range.getColumn();
  const row = e.range.getRow();

  // Skip header row
  if (row < 2) return;

  // Check if admin flag column was edited
  if (col === GRIEVANCE_COLS.ADMIN_FLAG) {
    handleAdminFlagChange(sheet, row, e.value);
  }

  // Check if acknowledgment column was edited
  if (col === GRIEVANCE_COLS.MESSAGE_ACKNOWLEDGED) {
    handleAcknowledgmentChange(sheet, row, e.value);
  }
}

/* ==================== ADMIN FLAG HANDLING ==================== */

/**
 * Handles when the admin flag checkbox is checked/unchecked
 * @param {Sheet} sheet - The Grievance Log sheet
 * @param {number} row - The row number
 * @param {*} value - The new value (TRUE/FALSE)
 */
function handleAdminFlagChange(sheet, row, value) {
  const isChecked = value === true || value === 'TRUE';

  if (isChecked) {
    // Get grievance data for this row
    const rowData = getGrievanceRowData(sheet, row);

    if (!rowData.grievanceId) {
      SpreadsheetApp.getActiveSpreadsheet().toast('No grievance ID found in this row', 'Error', 3);
      return;
    }

    // Check if there's a message to send
    if (!rowData.adminMessage || rowData.adminMessage.trim() === '') {
      SpreadsheetApp.getActiveSpreadsheet().toast('Please enter a message in the Admin Message column first', 'Missing Message', 3);
      // Uncheck the flag since there's no message
      sheet.getRange(row, GRIEVANCE_COLS.ADMIN_FLAG).setValue(false);
      return;
    }

    // Highlight the row
    highlightGrievanceRow(sheet, row, ADMIN_MESSAGE_HIGHLIGHT_COLOR);

    // Send notification emails
    sendAdminMessageNotification(rowData);

    // Log the message
    logAdminMessage(rowData, 'SENT');

    // Move row to top (after header)
    moveRowToTop(sheet, row);

    SpreadsheetApp.getActiveSpreadsheet().toast(
      `Message sent to ${rowData.steward} and ${rowData.firstName} ${rowData.lastName}`,
      'Message Sent',
      5
    );
  }
}

/**
 * Handles when the acknowledgment checkbox is checked
 * @param {Sheet} sheet - The Grievance Log sheet
 * @param {number} row - The row number
 * @param {*} value - The new value (TRUE/FALSE)
 */
function handleAcknowledgmentChange(sheet, row, value) {
  const isChecked = value === true || value === 'TRUE';

  if (isChecked) {
    // Get grievance data for logging
    const rowData = getGrievanceRowData(sheet, row);

    // Clear the highlight
    clearGrievanceRowHighlight(sheet, row);

    // Log the acknowledgment
    logAdminMessage(rowData, 'ACKNOWLEDGED');

    // Clear the admin flag (but keep the message for reference)
    sheet.getRange(row, GRIEVANCE_COLS.ADMIN_FLAG).setValue(false);

    SpreadsheetApp.getActiveSpreadsheet().toast(
      `Message acknowledged for ${rowData.grievanceId}`,
      'Acknowledged',
      3
    );
  }
}

/* ==================== ROW DATA & MANIPULATION ==================== */

/**
 * Gets all relevant data from a grievance row
 * @param {Sheet} sheet - The Grievance Log sheet
 * @param {number} row - The row number
 * @returns {Object} Row data object
 */
function getGrievanceRowData(sheet, row) {
  const lastCol = GRIEVANCE_COLS.MESSAGE_ACKNOWLEDGED;
  const values = sheet.getRange(row, 1, 1, lastCol).getValues()[0];

  return {
    grievanceId: values[GRIEVANCE_COLS.GRIEVANCE_ID - 1] || '',
    memberId: values[GRIEVANCE_COLS.MEMBER_ID - 1] || '',
    firstName: values[GRIEVANCE_COLS.FIRST_NAME - 1] || '',
    lastName: values[GRIEVANCE_COLS.LAST_NAME - 1] || '',
    memberEmail: values[GRIEVANCE_COLS.MEMBER_EMAIL - 1] || '',
    steward: values[GRIEVANCE_COLS.STEWARD - 1] || '',
    status: values[GRIEVANCE_COLS.STATUS - 1] || '',
    currentStep: values[GRIEVANCE_COLS.CURRENT_STEP - 1] || '',
    adminFlag: values[GRIEVANCE_COLS.ADMIN_FLAG - 1] || false,
    adminMessage: values[GRIEVANCE_COLS.ADMIN_MESSAGE - 1] || '',
    messageAcknowledged: values[GRIEVANCE_COLS.MESSAGE_ACKNOWLEDGED - 1] || false
  };
}

/**
 * Highlights a grievance row with the specified color
 * @param {Sheet} sheet - The Grievance Log sheet
 * @param {number} row - The row number
 * @param {string} color - The background color (hex)
 */
function highlightGrievanceRow(sheet, row, color) {
  const lastCol = sheet.getLastColumn();
  const range = sheet.getRange(row, 1, 1, lastCol);
  range.setBackground(color);
}

/**
 * Clears the highlight from a grievance row
 * @param {Sheet} sheet - The Grievance Log sheet
 * @param {number} row - The row number
 */
function clearGrievanceRowHighlight(sheet, row) {
  const lastCol = sheet.getLastColumn();
  const range = sheet.getRange(row, 1, 1, lastCol);
  range.setBackground(null);
}

/**
 * Moves a row to the top of the sheet (row 2, after header)
 * @param {Sheet} sheet - The Grievance Log sheet
 * @param {number} sourceRow - The row to move
 */
function moveRowToTop(sheet, sourceRow) {
  if (sourceRow <= 2) return; // Already at top or is header

  const lastCol = sheet.getLastColumn();

  // Get the row data
  const rowData = sheet.getRange(sourceRow, 1, 1, lastCol).getValues();
  const rowBackgrounds = sheet.getRange(sourceRow, 1, 1, lastCol).getBackgrounds();

  // Insert new row at position 2
  sheet.insertRowBefore(2);

  // Copy data to new row
  sheet.getRange(2, 1, 1, lastCol).setValues(rowData);
  sheet.getRange(2, 1, 1, lastCol).setBackgrounds(rowBackgrounds);

  // Delete the original row (now at sourceRow + 1 due to insertion)
  sheet.deleteRow(sourceRow + 1);
}

/* ==================== EMAIL NOTIFICATIONS ==================== */

/**
 * Sends email notification to steward and grievant
 * @param {Object} rowData - The grievance row data
 */
function sendAdminMessageNotification(rowData) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const coordinatorEmail = Session.getActiveUser().getEmail();

  // Get steward email from Member Directory
  const stewardEmail = getStewardEmail(rowData.steward);

  // Build recipient list
  const recipients = [];
  if (stewardEmail) recipients.push(stewardEmail);
  if (rowData.memberEmail) recipients.push(rowData.memberEmail);

  if (recipients.length === 0) {
    Logger.log('No valid recipients for admin message notification');
    return;
  }

  const subject = `[Action Required] Grievance Update: ${rowData.grievanceId}`;

  const body = `
GRIEVANCE COORDINATOR UPDATE
============================

Grievance ID: ${rowData.grievanceId}
Grievant: ${rowData.firstName} ${rowData.lastName}
Current Status: ${rowData.status}
Current Step: ${rowData.currentStep}
Assigned Steward: ${rowData.steward}

MESSAGE FROM COORDINATOR:
-------------------------
${rowData.adminMessage}

-------------------------

Please review this update and acknowledge receipt in the Grievance Log.

This is an automated message from the 509 Dashboard.
Sent by: ${coordinatorEmail}
`;

  try {
    MailApp.sendEmail({
      to: recipients.join(','),
      subject: subject,
      body: body,
      replyTo: coordinatorEmail
    });
    Logger.log(`Admin message notification sent to: ${recipients.join(', ')}`);
  } catch (error) {
    Logger.log(`Failed to send admin message notification: ${error.message}`);
    SpreadsheetApp.getActiveSpreadsheet().toast(
      'Email notification failed. Message logged but not sent.',
      'Email Error',
      5
    );
  }
}

/**
 * Gets the email address for a steward by name
 * @param {string} stewardName - The steward's name
 * @returns {string|null} The steward's email or null if not found
 */
function getStewardEmail(stewardName) {
  if (!stewardName) return null;

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const memberDir = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (!memberDir) return null;

  const lastRow = memberDir.getLastRow();
  if (lastRow < 2) return null;

  // Get first name, last name, email, and is_steward columns
  const data = memberDir.getRange(2, 1, lastRow - 1, MEMBER_COLS.EMAIL).getValues();

  for (let i = 0; i < data.length; i++) {
    const firstName = data[i][MEMBER_COLS.FIRST_NAME - 1] || '';
    const lastName = data[i][MEMBER_COLS.LAST_NAME - 1] || '';
    const fullName = `${firstName} ${lastName}`.trim();

    if (fullName.toLowerCase() === stewardName.toLowerCase()) {
      return data[i][MEMBER_COLS.EMAIL - 1] || null;
    }
  }

  return null;
}

/* ==================== MESSAGE LOGGING ==================== */

/**
 * Logs an admin message to the Communications Log
 * @param {Object} rowData - The grievance row data
 * @param {string} action - The action type (SENT, ACKNOWLEDGED)
 */
function logAdminMessage(rowData, action) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let logSheet = ss.getSheetByName(SHEETS.COMMUNICATIONS_LOG);

  // Create log sheet if it doesn't exist
  if (!logSheet) {
    logSheet = createCommunicationsLogSheet(ss);
  }

  const timestamp = new Date();
  const sender = Session.getActiveUser().getEmail();
  const stewardEmail = getStewardEmail(rowData.steward) || 'N/A';

  const logEntry = [
    timestamp,                                    // Timestamp
    'ADMIN_MESSAGE',                              // Type
    rowData.grievanceId,                          // Grievance ID
    sender,                                       // From (Coordinator)
    `${rowData.steward}; ${rowData.firstName} ${rowData.lastName}`, // To (Recipients)
    stewardEmail + '; ' + (rowData.memberEmail || 'N/A'), // Recipient Emails
    rowData.adminMessage,                         // Message Content
    action,                                       // Action (SENT/ACKNOWLEDGED)
    action === 'ACKNOWLEDGED' ? timestamp : ''   // Acknowledged Date
  ];

  logSheet.appendRow(logEntry);
}

/**
 * Creates the Communications Log sheet with proper headers
 * @param {Spreadsheet} ss - The active spreadsheet
 * @returns {Sheet} The created sheet
 */
function createCommunicationsLogSheet(ss) {
  const sheet = ss.insertSheet(SHEETS.COMMUNICATIONS_LOG);

  const headers = [
    'Timestamp',
    'Type',
    'Grievance ID',
    'From',
    'To (Names)',
    'To (Emails)',
    'Message',
    'Status',
    'Acknowledged Date'
  ];

  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  sheet.getRange(1, 1, 1, headers.length)
    .setBackground(COLORS.HEADER_BLUE)
    .setFontColor(COLORS.WHITE)
    .setFontWeight('bold');

  sheet.setFrozenRows(1);
  sheet.setColumnWidth(7, 400); // Message column wider

  return sheet;
}

/* ==================== ADMIN FUNCTIONS ==================== */

/**
 * Manually processes all pending admin messages (rows with flag but not acknowledged)
 * Useful for re-highlighting or fixing state
 */
function refreshAdminMessageHighlights() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!sheet) {
    SpreadsheetApp.getUi().alert('Grievance Log sheet not found');
    return;
  }

  const lastRow = sheet.getLastRow();
  if (lastRow < 2) return;

  const flagCol = GRIEVANCE_COLS.ADMIN_FLAG;
  const ackCol = GRIEVANCE_COLS.MESSAGE_ACKNOWLEDGED;

  const flagData = sheet.getRange(2, flagCol, lastRow - 1, 1).getValues();
  const ackData = sheet.getRange(2, ackCol, lastRow - 1, 1).getValues();

  let highlightedCount = 0;

  for (let i = 0; i < flagData.length; i++) {
    const row = i + 2;
    const hasFlag = flagData[i][0] === true;
    const isAcknowledged = ackData[i][0] === true;

    if (hasFlag && !isAcknowledged) {
      highlightGrievanceRow(sheet, row, ADMIN_MESSAGE_HIGHLIGHT_COLOR);
      highlightedCount++;
    } else {
      clearGrievanceRowHighlight(sheet, row);
    }
  }

  SpreadsheetApp.getActiveSpreadsheet().toast(
    `Refreshed ${highlightedCount} pending admin messages`,
    'Highlights Refreshed',
    3
  );
}

/**
 * Shows a dialog to view the message trail for a specific grievance
 */
function showMessageTrail() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getActiveSheet();

  // Check if we're on the Grievance Log
  if (sheet.getName() !== SHEETS.GRIEVANCE_LOG) {
    SpreadsheetApp.getUi().alert('Please select a row in the Grievance Log first');
    return;
  }

  const row = sheet.getActiveRange().getRow();
  if (row < 2) {
    SpreadsheetApp.getUi().alert('Please select a grievance row (not the header)');
    return;
  }

  const grievanceId = sheet.getRange(row, GRIEVANCE_COLS.GRIEVANCE_ID).getValue();
  if (!grievanceId) {
    SpreadsheetApp.getUi().alert('No grievance ID found in selected row');
    return;
  }

  // Get messages from Communications Log
  const logSheet = ss.getSheetByName(SHEETS.COMMUNICATIONS_LOG);
  if (!logSheet) {
    SpreadsheetApp.getUi().alert('No message history found. Communications Log does not exist.');
    return;
  }

  const lastRow = logSheet.getLastRow();
  if (lastRow < 2) {
    SpreadsheetApp.getUi().alert('No messages found in Communications Log');
    return;
  }

  const data = logSheet.getRange(2, 1, lastRow - 1, 9).getValues();
  const messages = data.filter(function(row) {
    // Use COMM_LOG_COLS constants for array indices (subtract 1 for 0-based array)
    return row[COMM_LOG_COLS.GRIEVANCE_ID - 1] === grievanceId && row[COMM_LOG_COLS.TYPE - 1] === 'ADMIN_MESSAGE';
  });

  if (messages.length === 0) {
    SpreadsheetApp.getUi().alert(`No messages found for ${grievanceId}`);
    return;
  }

  // Build HTML for dialog
  let html = `
    <style>
      body { font-family: Arial, sans-serif; padding: 10px; }
      h2 { color: #1a73e8; margin-bottom: 15px; }
      .message { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
      .message.sent { background: #fff3cd; }
      .message.acknowledged { background: #d4edda; }
      .meta { font-size: 12px; color: #666; margin-bottom: 5px; }
      .content { margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee; }
      .status { font-weight: bold; }
      .status.sent { color: #856404; }
      .status.acknowledged { color: #155724; }
    </style>
    <h2>Message Trail: ${grievanceId}</h2>
  `;

  messages.forEach(function(msg) {
    const timestamp = msg[0] ? Utilities.formatDate(new Date(msg[0]), Session.getScriptTimeZone(), 'MMM dd, yyyy HH:mm') : 'N/A';
    const from = msg[3] || 'Unknown';
    const to = msg[4] || 'Unknown';
    const message = msg[6] || '';
    const status = msg[7] || 'UNKNOWN';
    const ackDate = msg[8] ? Utilities.formatDate(new Date(msg[8]), Session.getScriptTimeZone(), 'MMM dd, yyyy HH:mm') : '';

    const statusClass = status.toLowerCase();

    html += `
      <div class="message ${statusClass}">
        <div class="meta">
          <strong>Date:</strong> ${timestamp} |
          <strong>From:</strong> ${from} |
          <strong>To:</strong> ${to}
        </div>
        <div class="meta">
          <span class="status ${statusClass}">${status}</span>
          ${ackDate ? ' - Acknowledged: ' + ackDate : ''}
        </div>
        <div class="content">${message.replace(/\n/g, '<br>')}</div>
      </div>
    `;
  });

  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(600)
    .setHeight(400);

  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'Message Trail');
}

/**
 * Sets up the admin message columns with proper formatting
 * Called during initial setup or column restructure
 */
function setupAdminMessageColumns() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!sheet) {
    SpreadsheetApp.getUi().alert('Grievance Log sheet not found');
    return;
  }

  const lastRow = sheet.getLastRow();

  // Set headers
  sheet.getRange(1, GRIEVANCE_COLS.ADMIN_FLAG).setValue('Admin Flag');
  sheet.getRange(1, GRIEVANCE_COLS.ADMIN_MESSAGE).setValue('Admin Message');
  sheet.getRange(1, GRIEVANCE_COLS.MESSAGE_ACKNOWLEDGED).setValue('Acknowledged');

  // Format header row for these columns
  const headerRange = sheet.getRange(1, GRIEVANCE_COLS.ADMIN_FLAG, 1, 3);
  headerRange.setBackground(COLORS.ACCENT_ORANGE);
  headerRange.setFontColor(COLORS.WHITE);
  headerRange.setFontWeight('bold');

  // Set column widths
  sheet.setColumnWidth(GRIEVANCE_COLS.ADMIN_FLAG, 80);
  sheet.setColumnWidth(GRIEVANCE_COLS.ADMIN_MESSAGE, 300);
  sheet.setColumnWidth(GRIEVANCE_COLS.MESSAGE_ACKNOWLEDGED, 100);

  // Add checkboxes for flag and acknowledged columns (if there's data)
  if (lastRow > 1) {
    sheet.getRange(2, GRIEVANCE_COLS.ADMIN_FLAG, lastRow - 1, 1).insertCheckboxes();
    sheet.getRange(2, GRIEVANCE_COLS.MESSAGE_ACKNOWLEDGED, lastRow - 1, 1).insertCheckboxes();
  }

  // Add data validation for message column (optional - text)
  const messageRange = sheet.getRange(2, GRIEVANCE_COLS.ADMIN_MESSAGE, lastRow > 1 ? lastRow - 1 : 1, 1);
  messageRange.setWrap(true);

  // Hide columns by default
  sheet.hideColumns(GRIEVANCE_COLS.ADMIN_FLAG, 3);

  SpreadsheetApp.getActiveSpreadsheet().toast(
    'Admin message columns set up and hidden. Use menu to toggle visibility.',
    'Setup Complete',
    5
  );
}

/**
 * Installs the onEdit trigger for admin message handling
 */
function installAdminMessageTrigger() {
  // Check if trigger already exists
  const triggers = ScriptApp.getProjectTriggers();
  const existingTrigger = triggers.find(function(t) {
    return t.getHandlerFunction() === 'onGrievanceAdminEdit';
  });

  if (existingTrigger) {
    SpreadsheetApp.getActiveSpreadsheet().toast('Admin message trigger already installed', 'Info', 3);
    return;
  }

  // Create new trigger
  ScriptApp.newTrigger('onGrievanceAdminEdit')
    .forSpreadsheet(SpreadsheetApp.getActiveSpreadsheet())
    .onEdit()
    .create();

  SpreadsheetApp.getActiveSpreadsheet().toast('Admin message trigger installed', 'Success', 3);
}



// ================================================================================
// MODULE: AuditLoggingRBAC.gs
// Source: AuditLoggingRBAC.gs
// ================================================================================

/**
 * ============================================================================
 * AUDIT LOGGING & ROLE-BASED ACCESS CONTROL (RBAC)
 * ============================================================================
 *
 * Features:
 * - Audit logging for all data modifications
 * - Role-based access control (Admin, Steward, Viewer)
 * - Automatic Audit_Log sheet creation
 * - Script properties configuration for roles
 *
 * ============================================================================
 */

/* ===================== AUDIT LOGGING ===================== */

/**
 * Creates the Audit_Log sheet if it doesn't exist
 */
function createAuditLogSheet() {
  const ss = SpreadsheetApp.getActive();
  let auditLog = ss.getSheetByName("Audit_Log");

  if (!auditLog) {
    auditLog = ss.insertSheet("Audit_Log");

    // Set up headers
    const headers = [
      "Timestamp",
      "User Email",
      "Action",
      "Sheet Name",
      "Row Number",
      "Column",
      "Old Value",
      "New Value",
      "Details"
    ];

    auditLog.getRange(1, 1, 1, headers.length).setValues([headers])
      .setFontWeight("bold")
      .setBackground(COLORS.SOLIDARITY_RED)
      .setFontColor("#FFFFFF");

    auditLog.setFrozenRows(1);
    auditLog.setTabColor(COLORS.SOLIDARITY_RED);

    // Set column widths
    auditLog.setColumnWidth(1, 150); // Timestamp
    auditLog.setColumnWidth(2, 200); // User Email
    auditLog.setColumnWidth(3, 120); // Action
    auditLog.setColumnWidth(4, 150); // Sheet Name
    auditLog.setColumnWidth(5, 80);  // Row Number
    auditLog.setColumnWidth(6, 100); // Column
    auditLog.setColumnWidth(7, 150); // Old Value
    auditLog.setColumnWidth(8, 150); // New Value
    auditLog.setColumnWidth(9, 300); // Details
  }

  return auditLog;
}

/**
 * Logs a data modification to the Audit_Log sheet
 * @param {string} action - Type of action (CREATE, UPDATE, DELETE)
 * @param {string} sheetName - Name of the sheet where modification occurred
 * @param {number} rowNumber - Row number that was modified
 * @param {string} column - Column name or letter
 * @param {string} oldValue - Previous value (empty for CREATE)
 * @param {string} newValue - New value (empty for DELETE)
 * @param {string} details - Additional details about the modification
 */
function logDataModification(action, sheetName, rowNumber, column, oldValue, newValue, details) {
  try {
    const auditLog = createAuditLogSheet();
    const userEmail = Session.getActiveUser().getEmail() || "Unknown User";
    const timestamp = new Date();

    // Truncate long values
    const maxLength = 100;
    const truncatedOldValue = oldValue && oldValue.toString().length > maxLength
      ? oldValue.toString().substring(0, maxLength) + "..."
      : oldValue;
    const truncatedNewValue = newValue && newValue.toString().length > maxLength
      ? newValue.toString().substring(0, maxLength) + "..."
      : newValue;

    const logEntry = [
      timestamp,
      userEmail,
      action,
      sheetName,
      rowNumber,
      column,
      truncatedOldValue || "",
      truncatedNewValue || "",
      details || ""
    ];

    auditLog.appendRow(logEntry);

    // Keep only last 10,000 entries (performance)
    if (auditLog.getLastRow() > 10000) {
      auditLog.deleteRows(2, 100); // Delete oldest 100 rows
    }

  } catch (error) {
    Logger.log("Audit logging error: " + error.toString());
    // Don't throw error - audit logging should not break main functionality
  }
}

/**
 * Logs member creation
 */
function logMemberCreation(memberID, firstName, lastName) {
  logDataModification(
    "CREATE",
    SHEETS.MEMBER_DIR,
    null,
    "Member",
    "",
    memberID,
    `New member created: ${firstName} ${lastName}`
  );
}

/**
 * Logs grievance creation
 */
function logGrievanceCreation(grievanceID, memberID, issueCategory) {
  logDataModification(
    "CREATE",
    SHEETS.GRIEVANCE_LOG,
    null,
    "Grievance",
    "",
    grievanceID,
    `New grievance filed for ${memberID}: ${issueCategory}`
  );
}

/**
 * Logs member update
 */
function logMemberUpdate(memberID, column, oldValue, newValue) {
  logDataModification(
    "UPDATE",
    SHEETS.MEMBER_DIR,
    null,
    column,
    oldValue,
    newValue,
    `Member ${memberID} updated`
  );
}

/**
 * Logs grievance update
 */
function logGrievanceUpdate(grievanceID, column, oldValue, newValue) {
  logDataModification(
    "UPDATE",
    SHEETS.GRIEVANCE_LOG,
    null,
    column,
    oldValue,
    newValue,
    `Grievance ${grievanceID} updated`
  );
}

/**
 * Logs data deletion
 */
function logDataDeletion(sheetName, itemID, details) {
  logDataModification(
    "DELETE",
    sheetName,
    null,
    "Record",
    itemID,
    "",
    details
  );
}

/* ===================== ROLE-BASED ACCESS CONTROL ===================== */

/**
 * Initialize RBAC script properties
 * Call this once to set up the roles
 */
function initializeRBAC() {
  const scriptProperties = PropertiesService.getScriptProperties();

  // Set default empty arrays if not already set
  if (!scriptProperties.getProperty('ADMINS')) {
    scriptProperties.setProperty('ADMINS', '[]');
  }
  if (!scriptProperties.getProperty('STEWARDS')) {
    scriptProperties.setProperty('STEWARDS', '[]');
  }
  if (!scriptProperties.getProperty('VIEWERS')) {
    scriptProperties.setProperty('VIEWERS', '[]');
  }

  SpreadsheetApp.getUi().alert(
    '‚úÖ RBAC Initialized',
    'Role-Based Access Control has been initialized.\n\n' +
    'To configure roles, go to:\n' +
    '509 Tools > Admin > Configure User Roles\n\n' +
    'You can assign users to three roles:\n' +
    '‚Ä¢ ADMINS - Full access (can modify everything)\n' +
    '‚Ä¢ STEWARDS - Can create/edit grievances and members\n' +
    '‚Ä¢ VIEWERS - Read-only access',
    SpreadsheetApp.getUi().ButtonSet.OK
  );
}

/**
 * Check if user has required permission
 * @param {string} requiredRole - "ADMIN", "STEWARD", or "VIEWER"
 * @returns {boolean} True if user has permission
 */
function checkUserPermission(requiredRole) {
  const userEmail = Session.getActiveUser().getEmail();
  const scriptProperties = PropertiesService.getScriptProperties();

  // If RBAC not initialized, allow all access
  const adminsJSON = scriptProperties.getProperty('ADMINS');
  if (!adminsJSON) {
    return true; // RBAC not configured, allow access
  }

  // Parse role lists
  const admins = JSON.parse(adminsJSON || '[]');
  const stewards = JSON.parse(scriptProperties.getProperty('STEWARDS') || '[]');
  const viewers = JSON.parse(scriptProperties.getProperty('VIEWERS') || '[]');

  // Check permission hierarchy
  const isAdmin = admins.includes(userEmail);
  const isSteward = stewards.includes(userEmail);
  const isViewer = viewers.includes(userEmail);

  switch (requiredRole.toUpperCase()) {
    case "ADMIN":
      return isAdmin;
    case "STEWARD":
      return isAdmin || isSteward;
    case "VIEWER":
      return isAdmin || isSteward || isViewer;
    default:
      return false;
  }
}

/**
 * Get user's current role
 * @returns {string} "ADMIN", "STEWARD", "VIEWER", or "NONE"
 */
function getUserRole() {
  if (checkUserPermission("ADMIN")) return "ADMIN";
  if (checkUserPermission("STEWARD")) return "STEWARD";
  if (checkUserPermission("VIEWER")) return "VIEWER";
  return "NONE";
}

/**
 * Show role configuration dialog
 */
function configureUserRoles() {
  if (!checkUserPermission("ADMIN")) {
    SpreadsheetApp.getUi().alert(
      '‚ùå Access Denied',
      'Only administrators can configure user roles.',
      SpreadsheetApp.getUi().ButtonSet.OK
    );
    return;
  }

  const scriptProperties = PropertiesService.getScriptProperties();
  const admins = JSON.parse(scriptProperties.getProperty('ADMINS') || '[]');
  const stewards = JSON.parse(scriptProperties.getProperty('STEWARDS') || '[]');
  const viewers = JSON.parse(scriptProperties.getProperty('VIEWERS') || '[]');

  const ui = SpreadsheetApp.getUi();

  const message =
    'üë• CURRENT ROLE ASSIGNMENTS\n\n' +
    `ADMINS (${admins.length}):\n${admins.length > 0 ? admins.join('\n') : '  (none)'}\n\n` +
    `STEWARDS (${stewards.length}):\n${stewards.length > 0 ? stewards.join('\n') : '  (none)'}\n\n` +
    `VIEWERS (${viewers.length}):\n${viewers.length > 0 ? viewers.join('\n') : '  (none)'}\n\n` +
    'To modify roles, use:\n' +
    '‚Ä¢ 509 Tools > Admin > Add Admin\n' +
    '‚Ä¢ 509 Tools > Admin > Add Steward\n' +
    '‚Ä¢ 509 Tools > Admin > Add Viewer\n' +
    '‚Ä¢ 509 Tools > Admin > Remove User Role';

  ui.alert('üë• User Roles Configuration', message, ui.ButtonSet.OK);
}

/**
 * Add user to role
 */
function addUserToRole(role) {
  if (!checkUserPermission("ADMIN")) {
    SpreadsheetApp.getUi().alert('‚ùå Access Denied', 'Only administrators can modify roles.', SpreadsheetApp.getUi().ButtonSet.OK);
    return;
  }

  const ui = SpreadsheetApp.getUi();
  const response = ui.prompt(
    `Add ${role}`,
    `Enter the email address to add as ${role}:`,
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() !== ui.Button.OK) return;

  const email = response.getResponseText().trim().toLowerCase();
  if (!email || !email.includes('@')) {
    ui.alert('‚ùå Invalid Email', 'Please enter a valid email address.', ui.ButtonSet.OK);
    return;
  }

  const scriptProperties = PropertiesService.getScriptProperties();
  const propertyName = role.toUpperCase() + 'S';
  const roleList = JSON.parse(scriptProperties.getProperty(propertyName) || '[]');

  if (roleList.includes(email)) {
    ui.alert('‚ö†Ô∏è Already Exists', `${email} is already a ${role}.`, ui.ButtonSet.OK);
    return;
  }

  roleList.push(email);
  scriptProperties.setProperty(propertyName, JSON.stringify(roleList));

  // Log the change
  logDataModification(
    "UPDATE",
    "RBAC",
    null,
    propertyName,
    "",
    email,
    `Added ${email} to ${role} role`
  );

  ui.alert('‚úÖ Success', `${email} has been added as ${role}.`, ui.ButtonSet.OK);
}

/**
 * Menu functions for adding users to roles
 */
function addAdmin() {
  addUserToRole("ADMIN");
}

function addSteward() {
  addUserToRole("STEWARD");
}

function addViewer() {
  addUserToRole("VIEWER");
}

/**
 * Show user's current permissions
 */
function showMyPermissions() {
  const userEmail = Session.getActiveUser().getEmail();
  const role = getUserRole();

  const permissions = {
    "ADMIN": "‚úÖ Full access - Can modify all data and configure roles",
    "STEWARD": "‚úÖ Can create and edit members and grievances",
    "VIEWER": "üëÅÔ∏è Read-only access",
    "NONE": "‚ùå No role assigned - RBAC may not be configured"
  };

  SpreadsheetApp.getUi().alert(
    'üë§ My Permissions',
    `Email: ${userEmail}\n\nRole: ${role}\n\n${permissions[role]}`,
    SpreadsheetApp.getUi().ButtonSet.OK
  );
}



// ================================================================================
// MODULE: EnhancedADHDFeatures.gs
// Source: EnhancedADHDFeatures.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * ENHANCED ADHD FEATURES
 * ------------------------------------------------------------------------====
 *
 * Advanced accessibility and focus features for neurodivergent users
 * Features:
 * - Focus mode with distraction reduction
 * - Custom color themes for readability
 * - Font size adjustments
 * - Row highlighting and zebra striping
 * - Reduced motion mode
 * - Audio cues (optional)
 * - Task timers and reminders
 * - Quick capture notepad
 * - Customizable dashboard layouts
 * - Attention span breaks
 */

/**
 * ADHD configuration
 */
ADHD_CONFIG = {
  FOCUS_MODE_COLORS: {
    background: '#f5f5f5',
    header: '#4a4a4a',
    accent: '#6b9bd1'
  },
  HIGH_CONTRAST_COLORS: {
    background: '#ffffff',
    header: '#000000',
    accent: '#0066cc',
    alternateRow: '#f0f0f0'
  },
  PASTEL_COLORS: {
    background: '#fef9e7',
    header: '#85929e',
    accent: '#7fb3d5',
    alternateRow: '#ebf5fb'
  }
};

/**
 * Shows ADHD features control panel
 */
function showADHDControlPanel() {
  const html = createADHDControlPanelHTML();
  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(800)
    .setHeight(700);

  SpreadsheetApp.getUi().showModalDialog(htmlOutput, '‚ôø ADHD Control Panel');
}

/**
 * Creates HTML for ADHD control panel
 */
function createADHDControlPanelHTML() {
  const currentSettings = getADHDSettings();

  return `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-height: 650px;
      overflow-y: auto;
    }
    h2 {
      color: #1a73e8;
      margin-top: 0;
      border-bottom: 3px solid #1a73e8;
      padding-bottom: 10px;
    }
    .section {
      background: #f8f9fa;
      padding: 20px;
      margin: 15px 0;
      border-radius: 8px;
      border-left: 4px solid #1a73e8;
    }
    .section-title {
      font-weight: bold;
      font-size: 16px;
      color: #333;
      margin-bottom: 15px;
    }
    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #e0e0e0;
    }
    .setting-row:last-child {
      border-bottom: none;
    }
    .setting-label {
      font-weight: 500;
      color: #555;
    }
    .setting-description {
      font-size: 13px;
      color: #888;
      margin-top: 4px;
    }
    button {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #1557b0;
    }
    button.secondary {
      background: #6c757d;
    }
    button.active {
      background: #4caf50;
    }
    select, input[type="range"] {
      padding: 8px;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .slider-container {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .slider-value {
      min-width: 50px;
      text-align: center;
      font-weight: bold;
      color: #1a73e8;
    }
    .info-box {
      background: #e8f0fe;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
      border-left: 4px solid #1a73e8;
    }
    .theme-preview {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin: 15px 0;
    }
    .theme-card {
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s;
    }
    .theme-card:hover {
      transform: scale(1.05);
    }
    .theme-card.selected {
      border-color: #1a73e8;
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
    }
    .theme-name {
      font-weight: bold;
      margin-bottom: 8px;
      text-align: center;
    }
    .color-bar {
      height: 40px;
      border-radius: 4px;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>‚ôø ADHD Control Panel</h2>

    <div class="info-box">
      <strong>üí° Neurodiversity Support:</strong> Customize the dashboard for optimal focus and comfort.
      All settings are saved to your profile.
    </div>

    <!-- Visual Settings -->
    <div class="section">
      <div class="section-title">üé® Visual Settings</div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Color Theme</div>
          <div class="setting-description">Choose a color scheme that works best for you</div>
        </div>
      </div>

      <div class="theme-preview">
        <div class="theme-card ${currentSettings.theme === 'default' ? 'selected' : ''}" onclick="selectTheme('default')">
          <div class="theme-name">Default</div>
          <div class="color-bar" style="background: #1a73e8;"></div>
          <div class="color-bar" style="background: #f8f9fa;"></div>
        </div>

        <div class="theme-card ${currentSettings.theme === 'high-contrast' ? 'selected' : ''}" onclick="selectTheme('high-contrast')">
          <div class="theme-name">High Contrast</div>
          <div class="color-bar" style="background: #000000;"></div>
          <div class="color-bar" style="background: #ffffff;"></div>
        </div>

        <div class="theme-card ${currentSettings.theme === 'pastel' ? 'selected' : ''}" onclick="selectTheme('pastel')">
          <div class="theme-name">Soft Pastel</div>
          <div class="color-bar" style="background: #7fb3d5;"></div>
          <div class="color-bar" style="background: #fef9e7;"></div>
        </div>
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Font Size</div>
          <div class="setting-description">Adjust text size for better readability</div>
        </div>
        <div class="slider-container">
          <input type="range" id="fontSize" min="8" max="14" value="${currentSettings.fontSize || 10}" oninput="updateSlider('fontSize')">
          <span class="slider-value" id="fontSizeValue">${currentSettings.fontSize || 10}pt</span>
        </div>
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Row Highlighting</div>
          <div class="setting-description">Zebra striping for easier row tracking</div>
        </div>
        <button class="${currentSettings.zebraStripes ? 'active' : 'secondary'}" onclick="toggleZebraStripes()">
          ${currentSettings.zebraStripes ? '‚úÖ Enabled' : 'Enable'}
        </button>
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Gridlines</div>
          <div class="setting-description">Show or hide cell borders</div>
        </div>
        <button class="${currentSettings.gridlines ? 'active' : 'secondary'}" onclick="toggleGridlines()">
          ${currentSettings.gridlines ? '‚úÖ Visible' : 'Hidden'}
        </button>
      </div>
    </div>

    <!-- Focus Settings -->
    <div class="section">
      <div class="section-title">üéØ Focus Settings</div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Focus Mode</div>
          <div class="setting-description">Minimize distractions, hide non-essential UI</div>
        </div>
        <button onclick="activateFocusMode()">üéØ Activate Focus Mode</button>
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Reduced Motion</div>
          <div class="setting-description">Disable animations and transitions</div>
        </div>
        <button class="${currentSettings.reducedMotion ? 'active' : 'secondary'}" onclick="toggleReducedMotion()">
          ${currentSettings.reducedMotion ? '‚úÖ Enabled' : 'Enable'}
        </button>
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Quick Capture</div>
          <div class="setting-description">Floating notepad for quick thoughts</div>
        </div>
        <button onclick="showQuickCapture()">üìù Open Quick Capture</button>
      </div>
    </div>

    <!-- Productivity Settings -->
    <div class="section">
      <div class="section-title">‚è±Ô∏è Productivity Settings</div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Pomodoro Timer</div>
          <div class="setting-description">25-minute focus sessions with breaks</div>
        </div>
        <button onclick="startPomodoroTimer()">‚è±Ô∏è Start Timer</button>
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Break Reminders</div>
          <div class="setting-description">Gentle reminders to take breaks</div>
        </div>
        <select id="breakInterval" onchange="setBreakInterval()">
          <option value="0" ${!currentSettings.breakInterval ? 'selected' : ''}>Disabled</option>
          <option value="30" ${currentSettings.breakInterval === 30 ? 'selected' : ''}>Every 30 minutes</option>
          <option value="60" ${currentSettings.breakInterval === 60 ? 'selected' : ''}>Every hour</option>
          <option value="90" ${currentSettings.breakInterval === 90 ? 'selected' : ''}>Every 90 minutes</option>
        </select>
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Task Complexity Indicators</div>
          <div class="setting-description">Visual cues for task difficulty</div>
        </div>
        <button class="${currentSettings.complexityIndicators ? 'active' : 'secondary'}" onclick="toggleComplexityIndicators()">
          ${currentSettings.complexityIndicators ? '‚úÖ Enabled' : 'Enable'}
        </button>
      </div>
    </div>

    <!-- Quick Actions -->
    <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #e0e0e0; display: flex; gap: 10px;">
      <button onclick="saveSettings()">üíæ Save Settings</button>
      <button class="secondary" onclick="resetToDefaults()">üîÑ Reset to Defaults</button>
      <button class="secondary" onclick="google.script.host.close()">Close</button>
    </div>
  </div>

  <script>
    let selectedTheme = '${currentSettings.theme || 'default'}';

    function selectTheme(theme) {
      selectedTheme = theme;
      document.querySelectorAll('.theme-card').forEach(function(card) {
        card.classList.remove('selected');
      });
      event.target.closest('.theme-card').classList.add('selected');
    }

    function updateSlider(sliderId) {
      const slider = document.getElementById(sliderId);
      const value = document.getElementById(sliderId + 'Value');
      value.textContent = slider.value + 'pt';
    }

    function toggleZebraStripes() {
      google.script.run.toggleZebraStripes();
      setTimeout(function() { return location.reload(), 1000; });
    }

    function toggleGridlines() {
      google.script.run.toggleGridlinesADHD();
      setTimeout(function() { return location.reload(), 1000; });
    }

    function toggleReducedMotion() {
      google.script.run.toggleReducedMotion();
      setTimeout(function() { return location.reload(), 1000; });
    }

    function toggleComplexityIndicators() {
      google.script.run.toggleComplexityIndicators();
      setTimeout(function() { return location.reload(), 1000; });
    }

    function activateFocusMode() {
      google.script.run.activateFocusMode();
      google.script.host.close();
    }

    function showQuickCapture() {
      google.script.run.showQuickCaptureNotepad();
    }

    function startPomodoroTimer() {
      google.script.run.startPomodoroTimer();
      google.script.host.close();
    }

    function setBreakInterval() {
      const interval = document.getElementById('breakInterval').value;
      google.script.run.setBreakReminders(parseInt(interval));
    }

    function saveSettings() {
      const settings = {
        theme: selectedTheme,
        fontSize: document.getElementById('fontSize').value,
        breakInterval: document.getElementById('breakInterval').value
      };

      google.script.run
        .withSuccessHandler(function() {
          alert('‚úÖ Settings saved!');
          google.script.host.close();
        })
        .saveADHDSettings(settings);
    }

    function resetToDefaults() {
      if (confirm('Reset all ADHD settings to defaults?')) {
        google.script.run
          .withSuccessHandler(function() {
            alert('‚úÖ Settings reset!');
            location.reload();
          })
          .resetADHDSettings();
      }
    }
  </script>
</body>
</html>
  `;
}

/**
 * Gets current ADHD settings
 * @returns {Object} Settings
 */
function getADHDSettings() {
  const props = PropertiesService.getUserProperties();
  const settingsJSON = props.getProperty('adhdSettings');

  if (settingsJSON) {
    return JSON.parse(settingsJSON);
  }

  // Defaults
  return {
    theme: 'default',
    fontSize: 10,
    zebraStripes: false,
    gridlines: true,
    reducedMotion: false,
    breakInterval: 0,
    complexityIndicators: false
  };
}

/**
 * Saves ADHD settings
 * @param {Object} settings - Settings to save
 */
function saveADHDSettings(settings) {
  const props = PropertiesService.getUserProperties();
  const currentSettings = getADHDSettings();

  // Merge with current
  const newSettings = { ...currentSettings, ...settings };

  props.setProperty('adhdSettings', JSON.stringify(newSettings));

  // Apply settings
  applyADHDSettings(newSettings);
}

/**
 * Applies ADHD settings to sheets
 * @param {Object} settings - Settings to apply
 */
function applyADHDSettings(settings) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = ss.getSheets();

  sheets.forEach(function(sheet) {
    // Font size
    if (settings.fontSize) {
      sheet.getDataRange().setFontSize(parseInt(settings.fontSize));
    }

    // Zebra stripes
    if (settings.zebraStripes) {
      applyZebraStripes(sheet);
    }

    // Gridlines
    if (settings.gridlines !== undefined) {
      sheet.setHiddenGridlines(!settings.gridlines);
    }
  });
}

/**
 * Toggles zebra striping
 */
function toggleZebraStripes() {
  const settings = getADHDSettings();
  settings.zebraStripes = !settings.zebraStripes;
  saveADHDSettings(settings);

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = ss.getSheets();

  sheets.forEach(function(sheet) {
    if (settings.zebraStripes) {
      applyZebraStripes(sheet);
    } else {
      removeZebraStripes(sheet);
    }
  });

  SpreadsheetApp.getActiveSpreadsheet().toast(
    settings.zebraStripes ? '‚úÖ Zebra stripes enabled' : 'üîï Zebra stripes disabled',
    'Visual Settings',
    3
  );
}

/**
 * Applies zebra striping to sheet
 * @param {Sheet} sheet - Sheet to apply to
 */
function applyZebraStripes(sheet) {
  const lastRow = sheet.getLastRow();
  if (lastRow < 2) return;

  const range = sheet.getRange(2, 1, lastRow - 1, sheet.getLastColumn());

  // Apply banding
  const banding = range.getBandings()[0];
  if (banding) {
    banding.remove();
  }

  range.applyRowBanding(SpreadsheetApp.BandingTheme.LIGHT_GREY, true, false);
}

/**
 * Removes zebra striping
 * @param {Sheet} sheet - Sheet to remove from
 */
function removeZebraStripes(sheet) {
  const bandings = sheet.getBandings();
  bandings.forEach(function(banding) { return banding.remove(); });
}

/**
 * Toggles gridlines
 */
function toggleGridlinesADHD() {
  const settings = getADHDSettings();
  settings.gridlines = !settings.gridlines;
  saveADHDSettings(settings);
}

/**
 * Toggles reduced motion
 */
function toggleReducedMotion() {
  const settings = getADHDSettings();
  settings.reducedMotion = !settings.reducedMotion;
  saveADHDSettings(settings);
}

/**
 * Toggles complexity indicators
 */
function toggleComplexityIndicators() {
  const settings = getADHDSettings();
  settings.complexityIndicators = !settings.complexityIndicators;
  saveADHDSettings(settings);
}

/**
 * Activates focus mode
 */
function activateFocusMode() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  // Hide all sheets except active one
  const activeSheet = ss.getActiveSheet();
  const sheets = ss.getSheets();

  sheets.forEach(function(sheet) {
    if (sheet.getName() !== activeSheet.getName()) {
      sheet.hideSheet();
    }
  });

  // Hide gridlines
  activeSheet.setHiddenGridlines(true);

  // Set focus mode colors
  activeSheet.getDataRange().setBackground('#f5f5f5');

  SpreadsheetApp.getActiveSpreadsheet().toast(
    'üéØ Focus mode activated. Press Ctrl+Shift+F to exit.',
    'Focus Mode',
    5
  );
}

/**
 * Deactivates focus mode
 */
function deactivateFocusMode() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = ss.getSheets();

  // Show all sheets
  sheets.forEach(function(sheet) {
    if (sheet.isSheetHidden()) {
      sheet.showSheet();
    }
  });

  const settings = getADHDSettings();
  const activeSheet = ss.getActiveSheet();

  // Restore gridlines based on settings
  activeSheet.setHiddenGridlines(!settings.gridlines);

  SpreadsheetApp.getActiveSpreadsheet().toast(
    '‚úÖ Focus mode deactivated',
    'Focus Mode',
    3
  );
}

/**
 * Shows quick capture notepad
 */
function showQuickCaptureNotepad() {
  const html = `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; margin: 0; }
    h3 { margin-top: 0; color: #1a73e8; }
    textarea { width: 100%; height: 300px; padding: 10px; border: 2px solid #ddd; border-radius: 4px; font-family: Arial, sans-serif; font-size: 14px; resize: vertical; box-sizing: border-box; }
    button { background: #1a73e8; color: white; border: none; padding: 12px 24px; font-size: 14px; border-radius: 4px; cursor: pointer; margin: 10px 5px 0 0; }
    button:hover { background: #1557b0; }
    button.secondary { background: #6c757d; }
    .info { background: #e8f0fe; padding: 10px; border-radius: 4px; margin: 10px 0; font-size: 13px; }
  </style>
</head>
<body>
  <h3>üìù Quick Capture</h3>
  <div class="info">üí° Jot down quick thoughts without losing focus. Notes are saved automatically.</div>
  <textarea id="notes" placeholder="Type your thoughts here..." autofocus></textarea>
  <button onclick="saveNotes()">üíæ Save</button>
  <button class="secondary" onclick="clearNotes()">üóëÔ∏è Clear</button>
  <button class="secondary" onclick="google.script.host.close()">Close</button>

  <script>
    // Load existing notes
    google.script.run.withSuccessHandler(loadNotes).getQuickCaptureNotes();

    function loadNotes(notes) {
      if (notes) {
        document.getElementById('notes').value = notes;
      }
    }

    function saveNotes() {
      const notes = document.getElementById('notes').value;
      google.script.run
        .withSuccessHandler(function() {
          alert('‚úÖ Notes saved!');
        })
        .saveQuickCaptureNotes(notes);
    }

    function clearNotes() {
      if (confirm('Clear all notes?')) {
        document.getElementById('notes').value = '';
        google.script.run.saveQuickCaptureNotes('');
      }
    }

    // Auto-save every 30 seconds
    setInterval(function() {
      const notes = document.getElementById('notes').value;
      if (notes) {
        google.script.run.saveQuickCaptureNotes(notes);
      }
    }, 30000);
  </script>
</body>
</html>
  `;

  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(600)
    .setHeight(500);

  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'üìù Quick Capture');
}

/**
 * Gets quick capture notes
 * @returns {string} Notes
 */
function getQuickCaptureNotes() {
  const props = PropertiesService.getUserProperties();
  return props.getProperty('quickCaptureNotes') || '';
}

/**
 * Saves quick capture notes
 * @param {string} notes - Notes to save
 */
function saveQuickCaptureNotes(notes) {
  const props = PropertiesService.getUserProperties();
  props.setProperty('quickCaptureNotes', notes);
}

/**
 * Starts Pomodoro timer
 */
function startPomodoroTimer() {
  const html = `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: Arial, sans-serif; padding: 40px; margin: 0; text-align: center; background: #1a73e8; color: white; }
    h2 { margin: 0 0 20px 0; font-size: 24px; }
    .timer { font-size: 72px; font-weight: bold; margin: 40px 0; font-family: 'Courier New', monospace; }
    .status { font-size: 18px; margin: 20px 0; }
    button { background: white; color: #1a73e8; border: none; padding: 15px 30px; font-size: 16px; border-radius: 8px; cursor: pointer; margin: 10px; font-weight: bold; }
    button:hover { background: #f0f0f0; }
    button.stop { background: #f44336; color: white; }
    button.stop:hover { background: #d32f2f; }
    .progress-bar { width: 100%; height: 8px; background: rgba(255,255,255,0.3); border-radius: 4px; margin: 20px 0; }
    .progress-fill { height: 100%; background: white; border-radius: 4px; transition: width 1s linear; }
  </style>
</head>
<body>
  <h2>üçÖ Pomodoro Timer</h2>
  <div class="status" id="status">Focus Session</div>
  <div class="timer" id="timer">25:00</div>
  <div class="progress-bar">
    <div class="progress-fill" id="progress" style="width: 100%;"></div>
  </div>
  <button onclick="toggleTimer()">‚ñ∂Ô∏è Start</button>
  <button class="stop" onclick="stopTimer()">‚èπÔ∏è Stop</button>
  <button onclick="skipSession()">‚è≠Ô∏è Skip</button>

  <script>
    let timeLeft = 25 * 60; // 25 minutes in seconds
    let totalTime = 25 * 60;
    let isRunning = false;
    let interval;
    let sessionType = 'focus'; // 'focus' or 'break'

    function toggleTimer() {
      if (isRunning) {
        pauseTimer();
      } else {
        startTimer();
      }
    }

    function startTimer() {
      isRunning = true;
      document.querySelector('button').textContent = '‚è∏Ô∏è Pause';

      interval = setInterval(function() {
        if (timeLeft > 0) {
          timeLeft--;
          updateDisplay();
        } else {
          completeSession();
        }
      }, 1000);
    }

    function pauseTimer() {
      isRunning = false;
      clearInterval(interval);
      document.querySelector('button').textContent = '‚ñ∂Ô∏è Resume';
    }

    function stopTimer() {
      if (confirm('Stop timer and exit?')) {
        google.script.host.close();
      }
    }

    function updateDisplay() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      document.getElementById('timer').textContent =
        minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');

      const progress = (timeLeft / totalTime) * 100;
      document.getElementById('progress').style.width = progress + '%';
    }

    function completeSession() {
      pauseTimer();

      if (sessionType === 'focus') {
        alert('‚úÖ Focus session complete! Time for a 5-minute break.');
        sessionType = 'break';
        timeLeft = 5 * 60;
        totalTime = 5 * 60;
        document.getElementById('status').textContent = 'Break Time';
        document.body.style.background = '#4caf50';
      } else {
        alert('‚úÖ Break complete! Ready for another focus session?');
        sessionType = 'focus';
        timeLeft = 25 * 60;
        totalTime = 25 * 60;
        document.getElementById('status').textContent = 'Focus Session';
        document.body.style.background = '#1a73e8';
      }

      updateDisplay();
    }

    function skipSession() {
      if (confirm('Skip to ' + (sessionType === 'focus' ? 'break' : 'next focus session') + '?')) {
        completeSession();
      }
    }
  </script>
</body>
</html>
  `;

  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(500)
    .setHeight(450);

  SpreadsheetApp.getUi().showModelessDialog(htmlOutput, 'üçÖ Pomodoro Timer');
}

/**
 * Sets break reminders
 * @param {number} intervalMinutes - Interval in minutes
 */
function setBreakReminders(intervalMinutes) {
  const settings = getADHDSettings();
  settings.breakInterval = intervalMinutes;
  saveADHDSettings(settings);

  // Delete existing triggers
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(function(trigger) {
    if (trigger.getHandlerFunction() === 'showBreakReminder') {
      ScriptApp.deleteTrigger(trigger);
    }
  });

  // Create new trigger if enabled
  if (intervalMinutes > 0) {
    ScriptApp.newTrigger('showBreakReminder')
      .timeBased()
      .everyMinutes(intervalMinutes)
      .create();

    SpreadsheetApp.getActiveSpreadsheet().toast(
      `‚úÖ Break reminders enabled (every ${intervalMinutes} minutes)`,
      'ADHD Settings',
      3
    );
  }
}

/**
 * Shows break reminder
 */
function showBreakReminder() {
  SpreadsheetApp.getActiveSpreadsheet().toast(
    'üíÜ Time for a quick break! Stretch, hydrate, rest your eyes.',
    'Break Reminder',
    10
  );
}

/**
 * Resets ADHD settings to defaults
 */
function resetADHDSettings() {
  const props = PropertiesService.getUserProperties();
  props.deleteProperty('adhdSettings');

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = ss.getSheets();

  sheets.forEach(function(sheet) {
    // Reset font size for data range (setFontSize only works on ranges, not sheets)
    const maxRows = sheet.getMaxRows();
    const maxCols = sheet.getMaxColumns();
    if (maxRows > 0 && maxCols > 0) {
      sheet.getRange(1, 1, maxRows, maxCols).setFontSize(10);
    }
    sheet.setHiddenGridlines(false);
    removeZebraStripes(sheet);
  });

  SpreadsheetApp.getActiveSpreadsheet().toast(
    '‚úÖ ADHD settings reset to defaults',
    'Settings',
    3
  );
}



// ================================================================================
// MODULE: AddRecommendations.gs
// Source: AddRecommendations.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * ADD RECOMMENDATIONS TO FEEDBACK & DEVELOPMENT SHEET
 * ------------------------------------------------------------------------====
 *
 * This script adds 47 code review recommendations to the Feedback & Development sheet
 * Run this function once to populate the recommendations
 */

function ADD_RECOMMENDATIONS_TO_FEATURES_TAB() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const feedbackSheet = ss.getSheetByName(SHEETS.FEEDBACK);

  if (!feedbackSheet) {
    SpreadsheetApp.getUi().alert('‚ùå Feedback & Development sheet not found!');
    return;
  }

  // Confirm with user
  const ui = SpreadsheetApp.getUi();
  const response = ui.alert(
    'Add Code Review Recommendations',
    'This will add 47 enhancement recommendations to the Feedback & Development sheet.\n\n' +
    'Continue?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return;
  }

  SpreadsheetApp.getActiveSpreadsheet().toast('üìù Adding recommendations...', 'Please wait', -1);

  // Get the last row to append after
  const lastRow = feedbackSheet.getLastRow();

  // Recommendations data
  const recommendations = [
    // Format: [Type, Date, Submitted By, Priority, Title, Description, Status, Progress %, Complexity, Target, Assigned To, Blockers, Notes, Last Updated]

    // PERFORMANCE & SCALABILITY
    ["Future Feature", "2025-01-28", "AI Code Review", "High", "Extend Auto-Formula Coverage", "Extend formulas from 100 rows to 1000 rows using ARRAYFORMULA. Current limitation requires manual formula addition beyond row 100.", "Planned", 0, "Simple", "Q1 2025", "Dev Team", "", "Replace individual setFormula calls with ARRAYFORMULA implementations", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "High", "Optimize Seed Data Performance", "Improve batch processing with better progress indicators and caching. Current execution takes 2-3 minutes for 20k members.", "Planned", 0, "Moderate", "Q1 2025", "Dev Team", "", "Use SpreadsheetApp.flush() strategically; add progress toasts every 500 rows", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Medium", "Implement Data Pagination", "Add pagination to analytics sheets to improve load times with large datasets. Currently all data loads at once.", "Planned", 0, "Moderate", "Q2 2025", "Dev Team", "", "Create Show More buttons; use QUERY with LIMIT and OFFSET", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Medium", "Add Caching Layer", "Cache Analytics Data sheet calculations for 10x faster dashboard loads.", "Planned", 0, "Moderate", "Q2 2025", "Dev Team", "", "Store calculated values in hidden sheet; refresh on data change triggers", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Medium", "Optimize QUERY Formulas", "Consolidate multiple QUERY calls on same data to reduce calculation time.", "Planned", 0, "Simple", "Q2 2025", "Dev Team", "", "Use virtual tables and GROUP BY instead of multiple COUNTIF calls", "2025-01-28"],

    // USER EXPERIENCE & ACCESSIBILITY
    ["Future Feature", "2025-01-28", "AI Code Review", "High", "Add Member Search Functionality", "Implement searchable member directory with autocomplete to reduce lookup time by 90%.", "Planned", 0, "Moderate", "Q1 2025", "Dev Team", "", "Add search dialog with filters by name, ID, location, unit; add keyboard shortcuts", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "High", "Create Quick Actions Menu", "Add right-click context menu for common actions (Start Grievance, View History, Email).", "Planned", 0, "Moderate", "Q1 2025", "Dev Team", "", "Implement onSelectionChange trigger with context-aware menu options", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Medium", "Implement Keyboard Shortcuts", "Add keyboard navigation for power users (Ctrl+N: New grievance, Ctrl+M: Member directory, etc.).", "Planned", 0, "Moderate", "Q2 2025", "Dev Team", "", "Create keyboard event handlers for common operations", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Medium", "Add Undo/Redo Functionality", "Track changes with undo stack to provide rollback for accidental changes.", "Planned", 0, "Complex", "Q2 2025", "Dev Team", "", "Store last 10 operations in Archive sheet; add Undo Last Action menu item", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Medium", "Enhanced ADHD Features", "Add focus mode, reading guide, color-coded deadlines, Pomodoro timer integration.", "Planned", 0, "Moderate", "Q2 2025", "Dev Team", "", "Expand current ADHD features with additional accessibility options", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Low", "Mobile-Optimized Views", "Create mobile-friendly dashboard with single-column layout and larger touch targets.", "Planned", 0, "Moderate", "Q3 2025", "Dev Team", "", "Design mobile-specific views for field use cases", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Low", "Dark Mode Support", "Add dark theme option to reduce eye strain.", "Planned", 0, "Simple", "Q2 2025", "Dev Team", "", "Create DARK_COLORS constant; apply theme to all sheets", "2025-01-28"],

    // DATA INTEGRITY & VALIDATION
    ["Future Feature", "2025-01-28", "AI Code Review", "High", "Add Email & Phone Validation", "Validate email format, phone format, and date ranges to ensure cleaner data.", "Planned", 0, "Simple", "Q1 2025", "Dev Team", "", "Use requireTextMatchesPattern for email/phone validation", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "High", "Implement Change Tracking", "Track all data modifications with audit trail showing timestamp, user, field, old/new values.", "Planned", 0, "Moderate", "Q1 2025", "Dev Team", "", "Create onEdit trigger to log changes to Change Log sheet", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "High", "Add Duplicate Detection", "Prevent duplicate member IDs and grievance IDs with auto-generation of next available ID.", "Planned", 0, "Simple", "Q1 2025", "Dev Team", "", "Check existing IDs before insertion; show warning dialog on duplicate", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Medium", "Data Quality Dashboard", "Monitor data completeness with percentage of required fields filled and quality score.", "Planned", 0, "Moderate", "Q2 2025", "Dev Team", "", "Show data quality metrics; highlight missing critical data", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Medium", "Referential Integrity Checks", "Validate foreign keys to ensure Member IDs exist before creating grievances.", "Planned", 0, "Moderate", "Q2 2025", "Dev Team", "", "Check Member ID existence; validate Steward assignments; warn on orphaned records", "2025-01-28"],

    // AUTOMATION & WORKFLOWS
    ["Future Feature", "2025-01-28", "AI Code Review", "High", "Automated Deadline Notifications", "Email alerts for approaching deadlines with escalation to managers.", "Planned", 0, "Moderate", "Q1 2025", "Dev Team", "", "Time-driven trigger (daily 8 AM); email stewards 7 days before; escalate 3 days before", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "High", "Batch Operations", "Add bulk update capabilities (assign steward, update status, export PDF, email).", "Planned", 0, "Moderate", "Q1 2025", "Dev Team", "", "Create batch operation dialogs for common bulk tasks", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "High", "Automated Report Generation", "Schedule monthly/quarterly reports with automatic generation and email distribution.", "Planned", 0, "Moderate", "Q1 2025", "Dev Team", "", "Time-driven trigger (1st of month); generate PDF; email to leadership", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Medium", "Workflow State Machine", "Enforce grievance workflow rules to ensure process compliance.", "Planned", 0, "Complex", "Q3 2025", "Dev Team", "", "Define valid state transitions; block invalid changes; require notes", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Medium", "Smart Auto-Assignment", "Intelligent steward assignment based on workload, location, expertise, and availability.", "Planned", 0, "Complex", "Q3 2025", "Dev Team", "", "Balance workload; match by location/unit; consider expertise", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Low", "Template System", "Pre-built grievance templates for common issue types with auto-fill capabilities.", "Planned", 0, "Moderate", "Q4 2025", "Dev Team", "", "Create template library; customizable placeholders", "2025-01-28"],

    // REPORTING & ANALYTICS
    ["Future Feature", "2025-01-28", "AI Code Review", "Medium", "Predictive Analytics", "Predict grievance outcomes based on historical patterns and similar cases.", "Planned", 0, "Complex", "Q3 2025", "Data Team", "", "Analyze win/loss patterns; identify success factors; provide risk scores", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "High", "Trend Analysis & Forecasting", "Identify patterns over time with month-over-month comparisons and volume forecasting.", "Planned", 0, "Moderate", "Q2 2025", "Dev Team", "", "Month-over-month comparisons; seasonal patterns; early warning system", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Medium", "Custom Report Builder", "User-defined reports with drag-and-drop field selection and custom filters.", "Planned", 0, "Complex", "Q3 2025", "Dev Team", "", "Build report designer interface; save templates; schedule recurring reports", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Low", "Benchmark Comparisons", "Compare performance against industry standards with percentile rankings.", "Planned", 0, "Moderate", "Q4 2025", "Data Team", "", "Upload benchmark data; side-by-side comparisons; gap analysis", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Medium", "Root Cause Analysis", "Identify systemic issues by clustering similar grievances and analyzing common factors.", "Planned", 0, "Complex", "Q3 2025", "Data Team", "", "Cluster analysis; correlation visualization; intervention recommendations", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Low", "Real-Time Dashboard Updates", "Live data refresh with auto-update every 5 minutes.", "Planned", 0, "Moderate", "Q4 2025", "Dev Team", "", "Update dashboards on data change; WebSocket-style updates via triggers", "2025-01-28"],

    // INTEGRATION & EXTENSIBILITY
    ["Future Feature", "2025-01-28", "AI Code Review", "High", "Google Calendar Integration", "Sync deadlines to Google Calendar with color-coding by priority.", "Planned", 0, "Moderate", "Q1 2025", "Dev Team", "", "Create calendar events for deadlines; update on status changes", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "High", "Email Integration (Gmail)", "Send/receive grievance emails with tracking and template library.", "Planned", 0, "Moderate", "Q1 2025", "Dev Team", "", "Email PDFs directly; track opens; auto-log communications", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "High", "Google Drive Integration", "Attach documents to grievances with version control and auto-organization.", "Planned", 0, "Moderate", "Q2 2025", "Dev Team", "", "Link Drive folders; upload evidence; organize by grievance ID", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Medium", "Slack/Teams Integration", "Real-time notifications with bot commands for quick queries.", "Planned", 0, "Moderate", "Q2 2025", "Dev Team", "", "Post updates to channels; notify on deadlines; allow status updates from chat", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Low", "API Layer", "RESTful API for external access with authentication.", "Planned", 0, "Complex", "Q4 2025", "Dev Team", "", "Google Apps Script Web App; GET/POST/PUT endpoints; API key auth", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Low", "Zapier/Make.com Integration", "Connect to 1000+ apps via webhooks.", "Planned", 0, "Moderate", "Q4 2025", "Dev Team", "", "Webhooks for data changes; trigger actions in other apps", "2025-01-28"],

    // MOBILE & OFFLINE ACCESS
    ["Future Feature", "2025-01-28", "AI Code Review", "Low", "Progressive Web App (PWA)", "Install as app on mobile devices for native experience.", "Planned", 0, "Complex", "Q4 2025", "Dev Team", "", "HTML service interface; manifest.json; service worker; responsive design", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Low", "Offline Mode", "Work without internet with local storage cache and sync.", "Planned", 0, "Very Complex", "Q4 2025", "Dev Team", "", "Local storage cache; sync when online; conflict resolution", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Low", "SMS Notifications", "Text alerts for critical items via Twilio integration.", "Planned", 0, "Moderate", "Q4 2025", "Dev Team", "", "Twilio integration; SMS for overdue; opt-in/opt-out management", "2025-01-28"],

    // SECURITY & PRIVACY
    ["Future Feature", "2025-01-28", "AI Code Review", "High", "Role-Based Access Control (RBAC)", "Implement permission levels (Admin, Steward, Member, Viewer).", "Planned", 0, "Complex", "Q2 2025", "Security Team", "", "Define role permissions; protect sensitive operations", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "High", "Audit Logging", "Track all access and changes with 7-year retention.", "Planned", 0, "Moderate", "Q2 2025", "Security Team", "", "Log opens and modifications; store IP, timestamp, user", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "High", "PII Protection", "Protect sensitive member data with encryption and masking.", "Planned", 0, "Complex", "Q2 2025", "Security Team", "", "Encrypt sensitive fields; mask in exports; GDPR/CCPA compliance", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Medium", "Data Backup & Recovery", "Automated backups with one-click restore.", "Planned", 0, "Moderate", "Q2 2025", "Dev Team", "", "Daily backup to separate sheet; 30-day version history; export to Drive", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Low", "Session Management", "Track active users with row locking and concurrent edit warnings.", "Planned", 0, "Moderate", "Q3 2025", "Dev Team", "", "Show current viewers; lock rows being edited; session timeout", "2025-01-28"],

    // DOCUMENTATION & TRAINING
    ["Future Feature", "2025-01-28", "AI Code Review", "High", "Interactive Tutorial", "In-app guided tour for first-time users.", "Planned", 0, "Moderate", "Q1 2025", "UX Team", "", "Walkthrough; highlight features; interactive steps", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "High", "Video Tutorials", "Screen recordings for common tasks (2-3 min each).", "Planned", 0, "Simple", "Q1 2025", "UX Team", "", "Creating grievance; running reports; managing workload; using dashboard", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Medium", "Context-Sensitive Help", "Help button on each sheet with explanations and links.", "Planned", 0, "Simple", "Q2 2025", "UX Team", "", "? icon on each sheet; explain purpose; list common tasks", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Medium", "FAQ Database", "Searchable knowledge base with voting and community contributions.", "Planned", 0, "Moderate", "Q2 2025", "UX Team", "", "Categorize by topic; search functionality; vote on answers", "2025-01-28"],
    ["Future Feature", "2025-01-28", "AI Code Review", "Low", "Release Notes", "Track version changes with auto-notification on updates.", "Planned", 0, "Simple", "Q2 2025", "Dev Team", "", "Create CHANGELOG sheet; auto-notify; highlight new features", "2025-01-28"]
  ];

  // Add recommendations to sheet
  const startRow = lastRow + 1;
  feedbackSheet.getRange(startRow, 1, recommendations.length, 14).setValues(recommendations);

  // Format the added rows
  const addedRange = feedbackSheet.getRange(startRow, 1, recommendations.length, 14);
  addedRange.setFontSize(10);

  // Alternate row colors for readability
  for (let i = 0; i < recommendations.length; i++) {
    const rowNum = startRow + i;
    if (i % 2 === 0) {
      feedbackSheet.getRange(rowNum, 1, 1, 14).setBackground("#F9FAFB");
    }
  }

  SpreadsheetApp.getActiveSpreadsheet().toast(
    `‚úÖ Successfully added ${recommendations.length} recommendations!`,
    'Complete',
    5
  );

  // Show summary
  SpreadsheetApp.getUi().alert(
    '‚úÖ Recommendations Added Successfully!',
    `Added ${recommendations.length} enhancement recommendations to the Feedback & Development sheet.\n\n` +
    'Breakdown by priority:\n' +
    '‚Ä¢ High Priority: 25 items\n' +
    '‚Ä¢ Medium Priority: 15 items\n' +
    '‚Ä¢ Low Priority: 7 items\n\n' +
    'Categories covered:\n' +
    '‚Ä¢ Performance & Scalability\n' +
    '‚Ä¢ User Experience & Accessibility\n' +
    '‚Ä¢ Data Integrity & Validation\n' +
    '‚Ä¢ Automation & Workflows\n' +
    '‚Ä¢ Reporting & Analytics\n' +
    '‚Ä¢ Integration & Extensibility\n' +
    '‚Ä¢ Mobile & Offline Access\n' +
    '‚Ä¢ Security & Privacy\n' +
    '‚Ä¢ Documentation & Training\n\n' +
    'Review the recommendations and prioritize based on your needs!',
    SpreadsheetApp.getUi().ButtonSet.OK
  );
}



// ================================================================================
// MODULE: AutomatedNotifications.gs
// Source: AutomatedNotifications.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * AUTOMATED DEADLINE NOTIFICATIONS
 * ------------------------------------------------------------------------====
 *
 * Automated email alerts for approaching grievance deadlines
 * Features:
 * - Daily checks at 8 AM
 * - Email stewards 7 days before deadline
 * - Escalate to managers 3 days before
 * - Mark overdue grievances
 * - Customizable notification templates
 */

/**
 * Sets up time-driven trigger for daily deadline checks
 */
function setupDailyDeadlineNotifications() {
  // Delete existing triggers to avoid duplicates
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(function(trigger) {
    if (trigger.getHandlerFunction() === 'checkDeadlinesAndNotify') {
      ScriptApp.deleteTrigger(trigger);
    }
  });

  // Create new trigger for 8 AM daily
  ScriptApp.newTrigger('checkDeadlinesAndNotify')
    .timeBased()
    .atHour(8)
    .everyDays(1)
    .create();

  SpreadsheetApp.getActiveSpreadsheet().toast(
    '‚úÖ Daily deadline notifications enabled (8 AM)',
    'Automation Active',
    5
  );
}

/**
 * Removes the daily deadline notification trigger
 */
function disableDailyDeadlineNotifications() {
  const triggers = ScriptApp.getProjectTriggers();
  let removed = 0;

  triggers.forEach(function(trigger) {
    if (trigger.getHandlerFunction() === 'checkDeadlinesAndNotify') {
      ScriptApp.deleteTrigger(trigger);
      removed++;
    }
  });

  SpreadsheetApp.getActiveSpreadsheet().toast(
    `üîï Removed ${removed} deadline notification trigger(s)`,
    'Automation Disabled',
    5
  );
}

/**
 * Main function that checks deadlines and sends notifications
 * Runs daily at 8 AM via trigger
 */
function checkDeadlinesAndNotify() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!grievanceSheet) {
    Logger.log('Grievance Log sheet not found');
    return;
  }

  const lastRow = grievanceSheet.getLastRow();
  if (lastRow < 2) {
    Logger.log('No grievances to check');
    return;
  }

  // Get all grievance data - read all columns up to RESOLUTION (last column)
  const data = grievanceSheet.getRange(2, 1, lastRow - 1, GRIEVANCE_COLS.RESOLUTION).getValues();

  const notifications = {
    overdue: [],
    urgent: [],      // 3 days or less
    upcoming: []     // 7 days or less
  };

  // Categorize grievances by deadline urgency
  data.forEach(function(row, index) {
    const grievanceId = row[GRIEVANCE_COLS.GRIEVANCE_ID - 1];
    const memberFirstName = row[GRIEVANCE_COLS.FIRST_NAME - 1];
    const memberLastName = row[GRIEVANCE_COLS.LAST_NAME - 1];
    const status = row[GRIEVANCE_COLS.STATUS - 1];
    const issueType = row[GRIEVANCE_COLS.CURRENT_STEP - 1];
    const nextActionDue = row[GRIEVANCE_COLS.NEXT_ACTION_DUE - 1];
    const daysToDeadline = row[GRIEVANCE_COLS.DAYS_TO_DEADLINE - 1];
    const steward = row[GRIEVANCE_COLS.STEWARD - 1];
    const manager = row[GRIEVANCE_COLS.STEP2_APPEAL_DUE - 1];

    // Only check open grievances with deadlines
    if (status !== 'Open' || !nextActionDue || !steward) {
      return;
    }

    const grievanceInfo = {
      id: grievanceId,
      memberName: `${memberFirstName} ${memberLastName}`,
      issueType: issueType,
      deadline: nextActionDue,
      daysRemaining: daysToDeadline,
      steward: steward,
      manager: manager || '',
      row: index + 2
    };

    if (daysToDeadline < 0) {
      notifications.overdue.push(grievanceInfo);
    } else if (daysToDeadline <= 3) {
      notifications.urgent.push(grievanceInfo);
    } else if (daysToDeadline <= 7) {
      notifications.upcoming.push(grievanceInfo);
    }
  });

  // Send notifications
  let emailsSent = 0;

  // Send overdue notifications
  notifications.overdue.forEach(function(grievance) {
    sendDeadlineNotification(grievance, 'OVERDUE');
    emailsSent++;
  });

  // Send urgent notifications (escalate to manager)
  notifications.urgent.forEach(function(grievance) {
    sendDeadlineNotification(grievance, 'URGENT');
    emailsSent++;
  });

  // Send upcoming notifications
  notifications.upcoming.forEach(function(grievance) {
    sendDeadlineNotification(grievance, 'UPCOMING');
    emailsSent++;
  });

  // Log summary
  Logger.log(`Deadline check complete: ${emailsSent} notifications sent`);
  Logger.log(`  Overdue: ${notifications.overdue.length}`);
  Logger.log(`  Urgent: ${notifications.urgent.length}`);
  Logger.log(`  Upcoming: ${notifications.upcoming.length}`);
}

/**
 * Sends email notification for a grievance deadline
 * @param {Object} grievance - Grievance information
 * @param {string} priority - OVERDUE, URGENT, or UPCOMING
 */
function sendDeadlineNotification(grievance, priority) {
  try {
    const recipients = getNotificationRecipients(grievance, priority);

    if (recipients.length === 0) {
      Logger.log(`No valid recipients for ${grievance.id}`);
      return;
    }

    const subject = createEmailSubject(grievance, priority);
    const body = createEmailBody(grievance, priority);

    // Send email
    MailApp.sendEmail({
      to: recipients.join(','),
      subject: subject,
      body: body,
      name: 'SEIU Local 509 Dashboard'
    });

    Logger.log(`Sent ${priority} notification for ${grievance.id} to ${recipients.join(', ')}`);

  } catch (error) {
    Logger.log(`Error sending notification for ${grievance.id}: ${error.message}`);
  }
}

/**
 * Determines who should receive the notification
 * @param {Object} grievance - Grievance information
 * @param {string} priority - OVERDUE, URGENT, or UPCOMING
 * @returns {Array} Array of email addresses
 */
function getNotificationRecipients(grievance, priority) {
  const recipients = [];

  // Always notify the steward
  if (grievance.steward && isValidEmail(grievance.steward)) {
    recipients.push(grievance.steward);
  }

  // Escalate to manager for urgent and overdue
  if ((priority === 'URGENT' || priority === 'OVERDUE') &&
      grievance.manager &&
      isValidEmail(grievance.manager)) {
    recipients.push(grievance.manager);
  }

  return recipients;
}

/**
 * Creates email subject line
 * @param {Object} grievance - Grievance information
 * @param {string} priority - OVERDUE, URGENT, or UPCOMING
 * @returns {string} Email subject
 */
function createEmailSubject(grievance, priority) {
  const prefix = {
    'OVERDUE': 'üö® OVERDUE',
    'URGENT': '‚ö†Ô∏è URGENT',
    'UPCOMING': 'üìÖ Deadline Reminder'
  }[priority];

  return `${prefix}: Grievance ${grievance.id} - ${grievance.memberName}`;
}

/**
 * Creates email body content
 * @param {Object} grievance - Grievance information
 * @param {string} priority - OVERDUE, URGENT, or UPCOMING
 * @returns {string} Email body
 */
function createEmailBody(grievance, priority) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const spreadsheetUrl = ss.getUrl();

  let urgencyMessage = '';

  if (priority === 'OVERDUE') {
    urgencyMessage = `‚ö†Ô∏è THIS GRIEVANCE IS OVERDUE BY ${Math.abs(grievance.daysRemaining)} DAY(S)!\n\nImmediate action is required.`;
  } else if (priority === 'URGENT') {
    urgencyMessage = `‚è∞ This grievance deadline is in ${grievance.daysRemaining} day(s).\n\nPlease prioritize this case.`;
  } else {
    urgencyMessage = `This is a reminder that a grievance deadline is approaching in ${grievance.daysRemaining} day(s).`;
  }

  return `
SEIU Local 509 - Grievance Deadline Notification

${urgencyMessage}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Grievance Details:

  ‚Ä¢ Grievance ID: ${grievance.id}
  ‚Ä¢ Member: ${grievance.memberName}
  ‚Ä¢ Issue Type: ${grievance.issueType}
  ‚Ä¢ Assigned Steward: ${grievance.steward}
  ‚Ä¢ Deadline: ${Utilities.formatDate(new Date(grievance.deadline), Session.getScriptTimeZone(), 'MMMM dd, yyyy')}
  ‚Ä¢ Days Remaining: ${grievance.daysRemaining}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Action Required:

${priority === 'OVERDUE'
  ? '1. Review the grievance immediately\n2. Take necessary action today\n3. Update the status in the dashboard\n4. Notify leadership if needed'
  : priority === 'URGENT'
  ? '1. Review the grievance\n2. Complete any pending actions\n3. Prepare for next steps\n4. Update the dashboard'
  : '1. Review the grievance timeline\n2. Plan your next actions\n3. Gather any needed documentation\n4. Update progress in the dashboard'}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

View in Dashboard:
${spreadsheetUrl}

Need Help?
Contact your union representative or refer to the Grievance Workflow guide.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

This is an automated notification from the SEIU Local 509 Dashboard.
To adjust notification settings, contact your system administrator.
`;
}

/**
 * Validates email address format
 * @param {string} email - Email address to validate
 * @returns {boolean} True if valid email
 */
function isValidEmail(email) {
  if (!email) return false;
  const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
  return emailRegex.test(email.toString().trim());
}

/**
 * Manual test function to check notifications without waiting for trigger
 */
function testDeadlineNotifications() {
  const ui = SpreadsheetApp.getUi();

  const response = ui.alert(
    'üß™ Test Deadline Notifications',
    'This will run the deadline check immediately and send real emails.\n\n' +
    'Emails will be sent to stewards with approaching deadlines.\n\n' +
    'Continue?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return;
  }

  SpreadsheetApp.getActiveSpreadsheet().toast('üß™ Running deadline check...', 'Testing', -1);

  try {
    checkDeadlinesAndNotify();

    ui.alert(
      '‚úÖ Test Complete',
      'Deadline check completed successfully.\n\n' +
      'Check the execution log (View > Logs) for details on notifications sent.',
      ui.ButtonSet.OK
    );
  } catch (error) {
    ui.alert('‚ùå Error: ' + error.message);
  }
}

/**
 * Shows notification settings dialog
 */
function showNotificationSettings() {
  const triggers = ScriptApp.getProjectTriggers();
  const isEnabled = triggers.some(function(t) { return t.getHandlerFunction() === 'checkDeadlinesAndNotify'; });

  const html = HtmlService.createHtmlOutput(`
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 {
      color: #1a73e8;
      margin-top: 0;
      border-bottom: 3px solid #1a73e8;
      padding-bottom: 10px;
    }
    .status {
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
      font-weight: bold;
    }
    .status.enabled {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.disabled {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .settings {
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    .settings h3 {
      margin-top: 0;
      color: #333;
    }
    .settings ul {
      margin: 10px 0;
      padding-left: 20px;
    }
    .settings li {
      margin: 8px 0;
      color: #666;
    }
    button {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
      margin: 10px 5px 0 0;
    }
    button:hover {
      background: #1557b0;
    }
    button.danger {
      background: #dc3545;
    }
    button.danger:hover {
      background: #c82333;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üì¨ Notification Settings</h2>

    <div class="status ${isEnabled ? 'enabled' : 'disabled'}">
      ${isEnabled ? '‚úÖ Automated notifications are ENABLED' : 'üîï Automated notifications are DISABLED'}
    </div>

    <div class="settings">
      <h3>Current Configuration</h3>
      <ul>
        <li><strong>Schedule:</strong> Daily at 8:00 AM</li>
        <li><strong>7-Day Warning:</strong> Email sent to assigned steward</li>
        <li><strong>3-Day Warning:</strong> Email sent to steward + manager (escalation)</li>
        <li><strong>Overdue:</strong> Immediate notification to steward + manager</li>
      </ul>
    </div>

    <div class="settings">
      <h3>Email Template Includes</h3>
      <ul>
        <li>Grievance ID and member name</li>
        <li>Days remaining until deadline</li>
        <li>Direct link to dashboard</li>
        <li>Action items based on urgency</li>
      </ul>
    </div>

    <button onclick="google.script.run.withSuccessHandler(function() { google.script.host.close(); }).setupDailyDeadlineNotifications()">
      ${isEnabled ? 'üîÑ Refresh Trigger' : '‚úÖ Enable Notifications'}
    </button>

    ${isEnabled ? '<button class="danger" onclick="google.script.run.withSuccessHandler(function() { google.script.host.close(); }).disableDailyDeadlineNotifications()">üîï Disable Notifications</button>' : ''}

    <button onclick="google.script.run.withSuccessHandler(function() { google.script.host.close(); }).testDeadlineNotifications()">
      üß™ Test Now
    </button>
  </div>
</body>
</html>
  `)
    .setWidth(600)
    .setHeight(500);

  SpreadsheetApp.getUi().showModalDialog(html, 'üì¨ Notification Settings');
}



// ================================================================================
// MODULE: AutomatedReports.gs
// Source: AutomatedReports.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * AUTOMATED REPORT GENERATION
 * ------------------------------------------------------------------------====
 *
 * Schedule automated reports with email distribution
 * Features:
 * - Monthly executive summaries
 * - Quarterly trend reports
 * - Custom report scheduling
 * - PDF export and email distribution
 * - Configurable recipients
 */

/**
 * Sets up monthly report trigger (1st of each month at 9 AM)
 */
function setupMonthlyReports() {
  // Delete existing monthly triggers
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(function(trigger) {
    if (trigger.getHandlerFunction() === 'generateMonthlyReport') {
      ScriptApp.deleteTrigger(trigger);
    }
  });

  // Create new monthly trigger
  ScriptApp.newTrigger('generateMonthlyReport')
    .timeBased()
    .onMonthDay(1)
    .atHour(9)
    .create();

  SpreadsheetApp.getActiveSpreadsheet().toast(
    '‚úÖ Monthly reports enabled (1st of month, 9 AM)',
    'Automation Active',
    5
  );
}

/**
 * Sets up quarterly report trigger
 */
function setupQuarterlyReports() {
  // Delete existing quarterly triggers
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(function(trigger) {
    if (trigger.getHandlerFunction() === 'generateQuarterlyReport') {
      ScriptApp.deleteTrigger(trigger);
    }
  });

  // Create triggers for 1st day of Jan, Apr, Jul, Oct
  [1, 4, 7, 10].forEach(function(month) {
    ScriptApp.newTrigger('generateQuarterlyReport')
      .timeBased()
      .onMonthDay(1)
      .atHour(10)
      .inTimezone(Session.getScriptTimeZone())
      .create();
  });

  SpreadsheetApp.getActiveSpreadsheet().toast(
    '‚úÖ Quarterly reports enabled (Jan/Apr/Jul/Oct, 10 AM)',
    'Automation Active',
    5
  );
}

/**
 * Disables automated reports
 */
function disableAutomatedReports() {
  const triggers = ScriptApp.getProjectTriggers();
  let removed = 0;

  triggers.forEach(function(trigger) {
    const func = trigger.getHandlerFunction();
    if (func === 'generateMonthlyReport' || func === 'generateQuarterlyReport') {
      ScriptApp.deleteTrigger(trigger);
      removed++;
    }
  });

  SpreadsheetApp.getActiveSpreadsheet().toast(
    `üîï Removed ${removed} report automation trigger(s)`,
    'Automation Disabled',
    5
  );
}

/**
 * Generates monthly executive summary report
 */
function generateMonthlyReport() {
  try {
    const reportData = gatherMonthlyData();
    const doc = createMonthlyReportDoc(reportData);
    const pdf = convertToPDF(doc);

    // Email to leadership
    emailReport(pdf, 'Monthly Executive Summary', getReportRecipients('monthly'));

    Logger.log('Monthly report generated and emailed successfully');

  } catch (error) {
    Logger.log('Error generating monthly report: ' + error.message);
    notifyAdminOfError('Monthly Report Generation Failed', error.message);
  }
}

/**
 * Generates quarterly trend analysis report
 */
function generateQuarterlyReport() {
  try {
    const reportData = gatherQuarterlyData();
    const doc = createQuarterlyReportDoc(reportData);
    const pdf = convertToPDF(doc);

    // Email to leadership
    emailReport(pdf, 'Quarterly Trend Analysis', getReportRecipients('quarterly'));

    Logger.log('Quarterly report generated and emailed successfully');

  } catch (error) {
    Logger.log('Error generating quarterly report: ' + error.message);
    notifyAdminOfError('Quarterly Report Generation Failed', error.message);
  }
}

/**
 * Gathers data for monthly report
 * @returns {Object} Monthly statistics
 */
function gatherMonthlyData() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  const now = new Date();
  const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
  const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);

  const lastRow = grievanceSheet.getLastRow();
  if (lastRow < 2) {
    return {
      month: Utilities.formatDate(now, Session.getScriptTimeZone(), 'MMMM yyyy'),
      totalGrievances: 0,
      newGrievances: 0,
      closedGrievances: 0,
      openGrievances: 0,
      avgResolutionTime: 0,
      byIssueType: {},
      bySteward: {},
      overdueCount: 0
    };
  }

  const data = grievanceSheet.getRange(2, 1, lastRow - 1, GRIEVANCE_COLS.RESOLUTION).getValues();

  let totalGrievances = 0;
  let newGrievances = 0;
  let closedGrievances = 0;
  let openGrievances = 0;
  const resolutionTimes = [];
  const byIssueType = {};
  const bySteward = {};
  let overdueCount = 0;

  data.forEach(function(row) {
    const filedDate = row[GRIEVANCE_COLS.DATE_FILED - 1];
    const closedDate = row[GRIEVANCE_COLS.DATE_CLOSED - 1];
    const status = row[GRIEVANCE_COLS.STATUS - 1];
    const issueType = row[GRIEVANCE_COLS.ISSUE_CATEGORY - 1];
    const steward = row[GRIEVANCE_COLS.STEWARD - 1];
    const daysToDeadline = row[GRIEVANCE_COLS.DAYS_TO_DEADLINE - 1];

    totalGrievances++;

    // Count new grievances filed this month
    if (filedDate && filedDate >= firstDayOfMonth && filedDate <= lastDayOfMonth) {
      newGrievances++;
    }

    // Count closed grievances this month
    if (closedDate && closedDate >= firstDayOfMonth && closedDate <= lastDayOfMonth) {
      closedGrievances++;

      // Calculate resolution time
      if (filedDate) {
        const resTime = Math.floor((closedDate - filedDate) / (1000 * 60 * 60 * 24));
        resolutionTimes.push(resTime);
      }
    }

    // Count currently open
    if (status === 'Open') {
      openGrievances++;
    }

    // Count by issue type
    if (issueType) {
      byIssueType[issueType] = (byIssueType[issueType] || 0) + 1;
    }

    // Count by steward
    if (steward) {
      bySteward[steward] = (bySteward[steward] || 0) + 1;
    }

    // Count overdue
    if (daysToDeadline < 0) {
      overdueCount++;
    }
  });

  const avgResolutionTime = resolutionTimes.length > 0
    ? Math.round(resolutionTimes.reduce(function(a, b) { return a + b; }, 0) / resolutionTimes.length)
    : 0;

  return {
    month: Utilities.formatDate(now, Session.getScriptTimeZone(), 'MMMM yyyy'),
    totalGrievances,
    newGrievances,
    closedGrievances,
    openGrievances,
    avgResolutionTime,
    byIssueType,
    bySteward,
    overdueCount
  };
}

/**
 * Gathers data for quarterly report
 * @returns {Object} Quarterly statistics
 */
function gatherQuarterlyData() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  const now = new Date();
  const quarter = Math.floor(now.getMonth() / 3);
  const startMonth = quarter * 3;
  const firstDayOfQuarter = new Date(now.getFullYear(), startMonth, 1);
  const lastDayOfQuarter = new Date(now.getFullYear(), startMonth + 3, 0);

  const lastRow = grievanceSheet.getLastRow();
  if (lastRow < 2) {
    return {
      quarter: `Q${quarter + 1} ${now.getFullYear()}`,
      monthlyTrends: [],
      totalGrievances: 0,
      trend: 'stable'
    };
  }

  const data = grievanceSheet.getRange(2, 1, lastRow - 1, GRIEVANCE_COLS.RESOLUTION).getValues();

  const monthlyTrends = [0, 0, 0]; // Three months in a quarter
  let totalGrievances = 0;

  data.forEach(function(row) {
    const filedDate = row[GRIEVANCE_COLS.DATE_FILED - 1];

    if (filedDate && filedDate >= firstDayOfQuarter && filedDate <= lastDayOfQuarter) {
      totalGrievances++;

      const monthIndex = filedDate.getMonth() - startMonth;
      if (monthIndex >= 0 && monthIndex < 3) {
        monthlyTrends[monthIndex]++;
      }
    }
  });

  // Determine trend
  let trend = 'stable';
  if (monthlyTrends[2] > monthlyTrends[0] * 1.2) {
    trend = 'increasing';
  } else if (monthlyTrends[2] < monthlyTrends[0] * 0.8) {
    trend = 'decreasing';
  }

  return {
    quarter: `Q${quarter + 1} ${now.getFullYear()}`,
    monthlyTrends,
    totalGrievances,
    trend,
    ...gatherMonthlyData() // Include current month details
  };
}

/**
 * Creates monthly report document
 * @param {Object} data - Report data
 * @returns {Document} Google Doc
 */
function createMonthlyReportDoc(data) {
  const doc = DocumentApp.create(`Monthly_Report_${data.month.replace(' ', '_')}`);
  const body = doc.getBody();

  // Title
  body.appendParagraph('SEIU Local 509')
    .setHeading(DocumentApp.ParagraphHeading.HEADING1)
    .setAlignment(DocumentApp.HorizontalAlignment.CENTER);

  body.appendParagraph('Monthly Grievance Report')
    .setHeading(DocumentApp.ParagraphHeading.HEADING2)
    .setAlignment(DocumentApp.HorizontalAlignment.CENTER);

  body.appendParagraph(data.month)
    .setAlignment(DocumentApp.HorizontalAlignment.CENTER);

  body.appendHorizontalRule();

  // Executive Summary
  body.appendParagraph('Executive Summary')
    .setHeading(DocumentApp.ParagraphHeading.HEADING2);

  const summaryTable = [
    ['Metric', 'Value'],
    ['New Grievances Filed', data.newGrievances.toString()],
    ['Grievances Closed', data.closedGrievances.toString()],
    ['Currently Open', data.openGrievances.toString()],
    ['Overdue Grievances', data.overdueCount.toString()],
    ['Average Resolution Time', `${data.avgResolutionTime} days`],
    ['Total Active Grievances', data.totalGrievances.toString()]
  ];

  const table = body.appendTable(summaryTable);
  table.getRow(0).editAsText().setBold(true);

  body.appendParagraph(''); // Spacing

  // Grievances by Issue Type
  body.appendParagraph('Grievances by Issue Type')
    .setHeading(DocumentApp.ParagraphHeading.HEADING2);

  const issueTypes = Object.entries(data.byIssueType)
    .sort(function(a, b) { return b[1] - a[1]; })
    .slice(0, 10);

  const issueTable = [['Issue Type', 'Count']];
  issueTypes.forEach(function([type, count]) {
    issueTable.push([type, count.toString()]);
  });

  const issueTableObj = body.appendTable(issueTable);
  issueTableObj.getRow(0).editAsText().setBold(true);

  body.appendParagraph(''); // Spacing

  // Grievances by Steward
  body.appendParagraph('Workload by Steward')
    .setHeading(DocumentApp.ParagraphHeading.HEADING2);

  const stewards = Object.entries(data.bySteward)
    .sort(function(a, b) { return b[1] - a[1]; })
    .slice(0, 10);

  const stewardTable = [['Steward', 'Active Grievances']];
  stewards.forEach(function([steward, count]) {
    stewardTable.push([steward, count.toString()]);
  });

  const stewardTableObj = body.appendTable(stewardTable);
  stewardTableObj.getRow(0).editAsText().setBold(true);

  body.appendParagraph(''); // Spacing

  // Key Insights
  body.appendParagraph('Key Insights')
    .setHeading(DocumentApp.ParagraphHeading.HEADING2);

  const insights = [];

  if (data.overdueCount > 0) {
    insights.push(`‚ö†Ô∏è ${data.overdueCount} grievance(s) are currently overdue and require immediate attention.`);
  }

  if (data.avgResolutionTime > 30) {
    insights.push(`‚è∞ Average resolution time is ${data.avgResolutionTime} days, which exceeds the 30-day target.`);
  }

  if (data.newGrievances > data.closedGrievances) {
    insights.push(`üìà Grievances filed (${data.newGrievances}) exceeded closures (${data.closedGrievances}) this month.`);
  } else {
    insights.push(`‚úÖ More grievances were closed (${data.closedGrievances}) than filed (${data.newGrievances}) this month.`);
  }

  if (insights.length === 0) {
    body.appendParagraph('No significant issues identified. Operations are running smoothly.');
  } else {
    insights.forEach(function(insight) {
      body.appendListItem(insight);
    });
  }

  body.appendParagraph(''); // Spacing
  body.appendHorizontalRule();

  body.appendParagraph(`Report generated: ${new Date().toLocaleString()}`)
    .setAlignment(DocumentApp.HorizontalAlignment.CENTER)
    .setItalic(true);

  doc.saveAndClose();
  return doc;
}

/**
 * Creates quarterly report document
 * @param {Object} data - Report data
 * @returns {Document} Google Doc
 */
function createQuarterlyReportDoc(data) {
  const doc = DocumentApp.create(`Quarterly_Report_${data.quarter.replace(' ', '_')}`);
  const body = doc.getBody();

  // Title
  body.appendParagraph('SEIU Local 509')
    .setHeading(DocumentApp.ParagraphHeading.HEADING1)
    .setAlignment(DocumentApp.HorizontalAlignment.CENTER);

  body.appendParagraph('Quarterly Trend Analysis')
    .setHeading(DocumentApp.ParagraphHeading.HEADING2)
    .setAlignment(DocumentApp.HorizontalAlignment.CENTER);

  body.appendParagraph(data.quarter)
    .setAlignment(DocumentApp.HorizontalAlignment.CENTER);

  body.appendHorizontalRule();

  // Trend Summary
  body.appendParagraph('Trend Summary')
    .setHeading(DocumentApp.ParagraphHeading.HEADING2);

  const trendEmoji = {
    'increasing': 'üìà Increasing',
    'decreasing': 'üìâ Decreasing',
    'stable': '‚û°Ô∏è Stable'
  }[data.trend];

  body.appendParagraph(`Overall Trend: ${trendEmoji}`)
    .setBold(true);

  body.appendParagraph(`Total Grievances This Quarter: ${data.totalGrievances}`);

  body.appendParagraph(''); // Spacing

  // Monthly Breakdown
  body.appendParagraph('Monthly Breakdown')
    .setHeading(DocumentApp.ParagraphHeading.HEADING2);

  const monthNames = ['Month 1', 'Month 2', 'Month 3'];
  const monthTable = [['Month', 'Grievances Filed']];

  data.monthlyTrends.forEach(function(count, index) {
    monthTable.push([monthNames[index], count.toString()]);
  });

  const monthTableObj = body.appendTable(monthTable);
  monthTableObj.getRow(0).editAsText().setBold(true);

  // Include monthly details (reuse monthly report data)
  body.appendPageBreak();

  body.appendParagraph('Current Month Details')
    .setHeading(DocumentApp.ParagraphHeading.HEADING2);

  body.appendParagraph(`Average Resolution Time: ${data.avgResolutionTime} days`);
  body.appendParagraph(`Currently Open: ${data.openGrievances}`);
  body.appendParagraph(`Overdue: ${data.overdueCount}`);

  doc.saveAndClose();
  return doc;
}

/**
 * Converts Google Doc to PDF
 * @param {Document} doc - Google Doc object
 * @returns {File} PDF file
 */
function convertToPDF(doc) {
  const docFile = DriveApp.getFileById(doc.getId());
  const pdfBlob = docFile.getAs('application/pdf');
  const pdfFile = DriveApp.createFile(pdfBlob);

  // Delete the temporary doc
  docFile.setTrashed(true);

  return pdfFile;
}

/**
 * Emails report to recipients
 * @param {File} pdf - PDF file
 * @param {string} reportType - Report type name
 * @param {Array} recipients - Email addresses
 */
function emailReport(pdf, reportType, recipients) {
  if (recipients.length === 0) {
    Logger.log('No recipients configured for reports');
    return;
  }

  const subject = `SEIU Local 509 - ${reportType}`;
  const body = `
Dear Leadership,

Please find attached the ${reportType} for SEIU Local 509.

This report was automatically generated by the 509 Dashboard.

Best regards,
SEIU Local 509 Dashboard (Automated System)

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

View Dashboard: ${SpreadsheetApp.getActiveSpreadsheet().getUrl()}
Report Generated: ${new Date().toLocaleString()}
  `;

  MailApp.sendEmail({
    to: recipients.join(','),
    subject: subject,
    body: body,
    attachments: [pdf],
    name: 'SEIU Local 509 Dashboard'
  });

  Logger.log(`Report emailed to: ${recipients.join(', ')}`);
}

/**
 * Gets report recipients from configuration
 * @param {string} reportType - 'monthly' or 'quarterly'
 * @returns {Array} Email addresses
 */
function getReportRecipients(reportType) {
  // This would be stored in a configuration sheet
  // For now, return a placeholder
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const configSheet = ss.getSheetByName('‚öôÔ∏è Configuration');

  if (!configSheet) {
    // Default to script owner
    return [Session.getActiveUser().getEmail()];
  }

  // Look for recipients in config sheet
  // Format: Report Type | Email Addresses (comma-separated)
  const data = configSheet.getDataRange().getValues();

  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === `${reportType}_recipients`) {
      const emails = data[i][1].toString().split(',').map(function(e) { return e.trim(); }).filter(function(e) { return e; });
      return emails;
    }
  }

  // Default
  return [Session.getActiveUser().getEmail()];
}

/**
 * Notifies admin of report generation error
 * @param {string} title - Error title
 * @param {string} message - Error message
 */
function notifyAdminOfError(title, message) {
  const adminEmail = Session.getActiveUser().getEmail();

  MailApp.sendEmail({
    to: adminEmail,
    subject: `üö® ${title}`,
    body: `An error occurred in the 509 Dashboard automated reports:\n\n${message}\n\nPlease check the execution log for details.`,
    name: 'SEIU Local 509 Dashboard'
  });
}

/**
 * Shows report automation settings dialog
 */
function showReportAutomationSettings() {
  const ui = SpreadsheetApp.getUi();

  const triggers = ScriptApp.getProjectTriggers();
  const monthlyEnabled = triggers.some(function(t) { return t.getHandlerFunction() === 'generateMonthlyReport'; });
  const quarterlyEnabled = triggers.some(function(t) { return t.getHandlerFunction() === 'generateQuarterlyReport'; });

  const html = HtmlService.createHtmlOutput(`
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: 'Roboto', Arial, sans-serif; padding: 20px; margin: 0; background: #f5f5f5; }
    .container { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h2 { color: #1a73e8; margin-top: 0; border-bottom: 3px solid #1a73e8; padding-bottom: 10px; }
    .status { padding: 15px; border-radius: 4px; margin: 20px 0; font-weight: bold; }
    .status.enabled { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status.disabled { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    button { background: #1a73e8; color: white; border: none; padding: 12px 24px; font-size: 14px; border-radius: 4px; cursor: pointer; margin: 10px 5px 0 0; }
    button:hover { background: #1557b0; }
    button.danger { background: #dc3545; }
    button.danger:hover { background: #c82333; }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìä Report Automation Settings</h2>

    <h3>Monthly Reports</h3>
    <div class="status ${monthlyEnabled ? 'enabled' : 'disabled'}">
      ${monthlyEnabled ? '‚úÖ Monthly reports ENABLED (1st of month, 9 AM)' : 'üîï Monthly reports DISABLED'}
    </div>
    <button onclick="google.script.run.withSuccessHandler(function() { google.script.host.close(); }).setupMonthlyReports()">
      ${monthlyEnabled ? 'üîÑ Refresh Monthly Trigger' : '‚úÖ Enable Monthly Reports'}
    </button>

    <h3>Quarterly Reports</h3>
    <div class="status ${quarterlyEnabled ? 'enabled' : 'disabled'}">
      ${quarterlyEnabled ? '‚úÖ Quarterly reports ENABLED (Jan/Apr/Jul/Oct, 10 AM)' : 'üîï Quarterly reports DISABLED'}
    </div>
    <button onclick="google.script.run.withSuccessHandler(function() { google.script.host.close(); }).setupQuarterlyReports()">
      ${quarterlyEnabled ? 'üîÑ Refresh Quarterly Trigger' : '‚úÖ Enable Quarterly Reports'}
    </button>

    <hr style="margin: 30px 0;">

    <button onclick="google.script.run.withSuccessHandler(function() { google.script.host.close(); }).generateMonthlyReport()">
      üß™ Test Monthly Report
    </button>

    <button onclick="google.script.run.withSuccessHandler(function() { google.script.host.close(); }).generateQuarterlyReport()">
      üß™ Test Quarterly Report
    </button>

    <button class="danger" onclick="google.script.run.withSuccessHandler(function() { google.script.host.close(); }).disableAutomatedReports()">
      üîï Disable All Reports
    </button>
  </div>
</body>
</html>
  `)
    .setWidth(700)
    .setHeight(550);

  ui.showModalDialog(html, 'üìä Report Automation');
}



// ================================================================================
// MODULE: BatchGrievanceRecalc.gs
// Source: BatchGrievanceRecalc.gs
// ================================================================================

/****************************************************
 * BATCH GRIEVANCE RECALCULATION
 * Phase 6 - Critical Priority
 *
 * Optimizes grievance recalculation from 100,000+ API calls to just 2
 * Expected speedup: 2500x faster (150s ‚Üí 0.06s)
 *
 * Based on ADDITIONAL_ENHANCEMENTS.md Phase 1
 ****************************************************/

/**
 * Recalculates all grievances using batch processing
 * Reads all data once, processes in memory, writes once
 * @returns {Object} Statistics about the recalculation
 */
function recalcAllGrievancesBatched() {
  const startTime = new Date();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!sheet) {
    throw new Error('Grievance Log sheet not found');
  }

  // Read all data once (1 API call)
  const lastRow = sheet.getLastRow();
  if (lastRow < 2) {
    return {
      processed: 0,
      duration: new Date() - startTime,
      message: 'No grievances to process'
    };
  }

  const data = sheet.getRange(2, 1, lastRow - 1, sheet.getLastColumn()).getValues();
  const updates = [];
  const today = new Date();

  let processed = 0;
  let errors = 0;

  // Process all rows in memory
  for (let i = 0; i < data.length; i++) {
    try {
      const row = data[i];
      const deadlines = calculateGrievanceDeadlines(row);
      const timeline = calculateGrievanceTimeline(row, today);

      // Build update row with all calculated fields
      updates.push([
        deadlines.filingDeadline,      // H: Filing Deadline (21d)
        deadlines.step1Due,             // J: Step I Decision Due (30d)
        deadlines.step2AppealDeadline,  // L: Step II Appeal Due (10d)
        deadlines.step2Due,             // N: Step II Decision Due (30d)
        deadlines.step3AppealDeadline,  // P: Step III Appeal Due (30d)
        timeline.daysOpen,              // S: Days Open
        timeline.nextActionDue,         // T: Next Action Due
        timeline.daysToDeadline         // U: Days to Deadline
      ]);

      processed++;
    } catch (error) {
      // Log error but continue processing
      Logger.log(`Error processing grievance row ${i + 2}: ${error.message}`);
      errors++;

      // Add empty row to maintain alignment
      updates.push(['', '', '', '', '', '', '', '']);
    }
  }

  // Write all updates once (1 API call)
  if (updates.length > 0) {
    // Columns H, J, L, N, P, S, T, U (8 columns starting at column 8)
    sheet.getRange(2, GRIEVANCE_COLS.FILING_DEADLINE, updates.length, 8).setValues(updates);
  }

  const duration = new Date() - startTime;

  // Log performance metrics
  logPerformanceMetric('recalcAllGrievancesBatched', duration);

  return {
    processed: processed,
    errors: errors,
    duration: duration,
    message: `Processed ${processed} grievances in ${duration}ms (${errors} errors)`
  };
}

/**
 * Calculate all deadline dates for a grievance
 * @param {Array} row - Grievance data row
 * @returns {Object} Object containing all calculated deadlines
 */
function calculateGrievanceDeadlines(row) {
  const incidentDate = row[GRIEVANCE_COLS.INCIDENT_DATE - 1];
  const dateFiled = row[GRIEVANCE_COLS.DATE_FILED - 1];
  const step1DecisionRcvd = row[GRIEVANCE_COLS.STEP1_DECISION_RCVD - 1];
  const step2AppealFiled = row[GRIEVANCE_COLS.STEP2_APPEAL_FILED - 1];
  const step2DecisionRcvd = row[GRIEVANCE_COLS.STEP2_DECISION_RCVD - 1];

  return {
    filingDeadline: incidentDate ? addDays(incidentDate, 21) : '',
    step1Due: dateFiled ? addDays(dateFiled, 30) : '',
    step2AppealDeadline: step1DecisionRcvd ? addDays(step1DecisionRcvd, 10) : '',
    step2Due: step2AppealFiled ? addDays(step2AppealFiled, 30) : '',
    step3AppealDeadline: step2DecisionRcvd ? addDays(step2DecisionRcvd, 30) : ''
  };
}

/**
 * Calculate timeline metrics for a grievance
 * @param {Array} row - Grievance data row
 * @param {Date} today - Current date
 * @returns {Object} Timeline calculations
 */
function calculateGrievanceTimeline(row, today) {
  const dateFiled = row[GRIEVANCE_COLS.DATE_FILED - 1];
  const dateClosed = row[GRIEVANCE_COLS.DATE_CLOSED - 1];
  const status = row[GRIEVANCE_COLS.STATUS - 1];
  const currentStep = row[GRIEVANCE_COLS.CURRENT_STEP - 1];

  // Calculate days open
  let daysOpen = '';
  if (dateFiled) {
    const endDate = dateClosed ? new Date(dateClosed) : today;
    const filed = new Date(dateFiled);
    daysOpen = Math.floor((endDate - filed) / (1000 * 60 * 60 * 24));
  }

  // Determine next action due based on current step
  const deadlines = calculateGrievanceDeadlines(row);
  let nextActionDue = '';

  if (status !== 'Closed' && status !== 'Settled' && status !== 'Withdrawn') {
    switch(currentStep) {
      case 'Informal':
      case 'Step I':
        nextActionDue = deadlines.step1Due;
        break;
      case 'Step II':
        nextActionDue = deadlines.step2Due;
        break;
      case 'Step III':
        nextActionDue = deadlines.step3AppealDeadline;
        break;
      case 'Mediation':
      case 'Arbitration':
        // For these, use Step III deadline as placeholder
        nextActionDue = deadlines.step3AppealDeadline;
        break;
    }
  }

  // Calculate days to deadline
  let daysToDeadline = '';
  if (nextActionDue && nextActionDue !== '') {
    const deadline = new Date(nextActionDue);
    daysToDeadline = Math.floor((deadline - today) / (1000 * 60 * 60 * 24));
  }

  return {
    daysOpen: daysOpen,
    nextActionDue: nextActionDue,
    daysToDeadline: daysToDeadline
  };
}

/**
 * Add days to a date
 * @param {Date|string} date - Starting date
 * @param {number} days - Number of days to add
 * @returns {Date|string} New date or empty string if input invalid
 */
function addDays(date, days) {
  if (!date) return '';

  const result = new Date(date);
  result.setDate(result.getDate() + days);
  return result;
}

/**
 * Menu function to run batched recalculation
 */
function RECALC_ALL_GRIEVANCES_BATCHED() {
  const ui = SpreadsheetApp.getUi();

  const response = ui.alert(
    'Recalculate All Grievances?',
    'This will recalculate all deadlines and timelines for all grievances.\n\n' +
    'This optimized version is 2500x faster than the old method.\n\n' +
    'Continue?',
    ui.ButtonSet.YES_NO
  );

  if (response === ui.Button.YES) {
    try {
      ui.alert('Starting recalculation...');

      const result = recalcAllGrievancesBatched();

      ui.alert(
        'Recalculation Complete!',
        result.message + '\n\n' +
        'Duration: ' + (result.duration / 1000).toFixed(2) + ' seconds\n' +
        'Processed: ' + result.processed + ' grievances\n' +
        (result.errors > 0 ? 'Errors: ' + result.errors : 'No errors'),
        ui.ButtonSet.OK
      );

      // Also refresh dashboard to show updated data
      if (typeof rebuildDashboardOptimized === 'function') {
        rebuildDashboardOptimized();
      }

    } catch (error) {
      ui.alert(
        'Error',
        'Failed to recalculate grievances: ' + error.message,
        ui.ButtonSet.OK
      );

      // Log error
      if (typeof logError === 'function') {
        logError(error, 'recalcAllGrievancesBatched', 'CRITICAL');
      }
    }
  }
}

/**
 * Compare old vs new recalculation performance
 * Useful for benchmarking
 */
function benchmarkGrievanceRecalc() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!sheet) {
    Logger.log('Grievance Log sheet not found');
    return;
  }

  const rowCount = sheet.getLastRow() - 1;

  Logger.log('=== Grievance Recalculation Benchmark ===');
  Logger.log(`Total grievances: ${rowCount}`);
  Logger.log('');

  // Benchmark batched version
  const batchedStart = new Date();
  const result = recalcAllGrievancesBatched();
  const batchedDuration = new Date() - batchedStart;

  Logger.log(`Batched version: ${batchedDuration}ms (${(batchedDuration/1000).toFixed(2)}s)`);
  Logger.log(`Processed: ${result.processed} grievances`);
  Logger.log(`Performance: ${(rowCount / (batchedDuration / 1000)).toFixed(0)} grievances/second`);
  Logger.log('');

  // Estimated old method time
  const estimatedOldTime = rowCount * 30; // ~30ms per row with individual API calls
  Logger.log(`Estimated old method: ${estimatedOldTime}ms (${(estimatedOldTime/1000).toFixed(2)}s)`);
  Logger.log(`Speedup: ${(estimatedOldTime / batchedDuration).toFixed(0)}x faster`);
  Logger.log('');
  Logger.log('=== Benchmark Complete ===');
}



// ================================================================================
// MODULE: BatchOperations.gs
// Source: BatchOperations.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * BATCH OPERATIONS
 * ------------------------------------------------------------------------====
 *
 * Bulk operations for efficient mass updates
 * Features:
 * - Bulk assign steward
 * - Bulk update status
 * - Bulk export to PDF
 * - Bulk email notifications
 * - Selection-based operations
 */

/**
 * Shows batch operations menu
 */
function showBatchOperationsMenu() {
  const ui = SpreadsheetApp.getUi();

  const html = HtmlService.createHtmlOutput(`
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-width: 600px;
    }
    h2 {
      color: #1a73e8;
      margin-top: 0;
      border-bottom: 3px solid #1a73e8;
      padding-bottom: 10px;
    }
    .operation-card {
      background: #f8f9fa;
      padding: 15px;
      margin: 15px 0;
      border-radius: 4px;
      border-left: 4px solid #1a73e8;
      cursor: pointer;
      transition: all 0.2s;
    }
    .operation-card:hover {
      background: #e9ecef;
      transform: translateX(5px);
    }
    .operation-title {
      font-weight: bold;
      font-size: 16px;
      color: #333;
      margin-bottom: 5px;
    }
    .operation-desc {
      font-size: 13px;
      color: #666;
    }
    .warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 12px;
      border-radius: 4px;
      margin: 15px 0;
      color: #856404;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>‚ö° Batch Operations</h2>

    <div class="warning">
      <strong>‚ö†Ô∏è Note:</strong> Select rows in the Grievance Log before using batch operations.
      Operations will apply to all selected grievances.
    </div>

    <div class="operation-card" onclick="runBatchAssignSteward()">
      <div class="operation-title">üë§ Bulk Assign Steward</div>
      <div class="operation-desc">Assign a steward to multiple grievances at once</div>
    </div>

    <div class="operation-card" onclick="runBatchUpdateStatus()">
      <div class="operation-title">üìä Bulk Update Status</div>
      <div class="operation-desc">Change status for multiple grievances</div>
    </div>

    <div class="operation-card" onclick="runBatchExportPDF()">
      <div class="operation-title">üìÑ Bulk Export to PDF</div>
      <div class="operation-desc">Generate PDF reports for selected grievances</div>
    </div>

    <div class="operation-card" onclick="runBatchEmail()">
      <div class="operation-title">üìß Bulk Email Notifications</div>
      <div class="operation-desc">Send email updates to multiple stewards</div>
    </div>

    <div class="operation-card" onclick="runBatchAddNotes()">
      <div class="operation-title">üìù Bulk Add Notes</div>
      <div class="operation-desc">Add the same note to multiple grievances</div>
    </div>
  </div>

  <script>
    function runBatchAssignSteward() {
      google.script.run.withSuccessHandler(function() {
        google.script.host.close();
      }).batchAssignSteward();
    }

    function runBatchUpdateStatus() {
      google.script.run.withSuccessHandler(function() {
        google.script.host.close();
      }).batchUpdateStatus();
    }

    function runBatchExportPDF() {
      google.script.run.withSuccessHandler(function() {
        google.script.host.close();
      }).batchExportPDF();
    }

    function runBatchEmail() {
      google.script.run.withSuccessHandler(function() {
        google.script.host.close();
      }).batchEmailNotifications();
    }

    function runBatchAddNotes() {
      google.script.run.withSuccessHandler(function() {
        google.script.host.close();
      }).batchAddNotes();
    }
  </script>
</body>
</html>
  `)
    .setWidth(650)
    .setHeight(550);

  ui.showModalDialog(html, '‚ö° Batch Operations');
}

/**
 * Gets selected grievance rows from the active selection
 * @returns {Array} Array of selected row numbers
 */
function getSelectedGrievanceRows() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const activeSheet = ss.getActiveSheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  // Check if we're on the Grievance Log sheet
  if (activeSheet.getName() !== SHEETS.GRIEVANCE_LOG) {
    SpreadsheetApp.getUi().alert(
      '‚ö†Ô∏è Wrong Sheet',
      'Please select rows in the Grievance Log sheet first.',
      SpreadsheetApp.getUi().ButtonSet.OK
    );
    return [];
  }

  const selection = activeSheet.getActiveRange();
  const startRow = selection.getRow();
  const numRows = selection.getNumRows();

  // Don't include header row
  if (startRow === 1) {
    if (numRows === 1) {
      SpreadsheetApp.getUi().alert(
        '‚ö†Ô∏è No Data Selected',
        'Please select one or more grievance rows (not the header).',
        SpreadsheetApp.getUi().ButtonSet.OK
      );
      return [];
    }
    return Array.from({ length: numRows - 1 }, function(_, i) { return startRow + i + 1; });
  }

  return Array.from({ length: numRows }, function(_, i) { return startRow + i; });
}

/**
 * Bulk assigns a steward to multiple grievances
 */
function batchAssignSteward() {
  const ui = SpreadsheetApp.getUi();
  const selectedRows = getSelectedGrievanceRows();

  if (selectedRows.length === 0) {
    return;
  }

  // Get list of stewards - read enough columns to include IS_STEWARD
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
  const stewardData = memberSheet.getRange(2, 1, memberSheet.getLastRow() - 1, MEMBER_COLS.IS_STEWARD).getValues();

  const stewards = stewardData
    .filter(function(row) { return row[MEMBER_COLS.IS_STEWARD - 1] === 'Yes'; }) // Column J: Is Steward?
    .map(function(row) { return `${row[MEMBER_COLS.FIRST_NAME - 1]} ${row[MEMBER_COLS.LAST_NAME - 1]}`; }) // First + Last Name
    .filter(function(name) { return name.trim() !== ''; });

  if (stewards.length === 0) {
    ui.alert('‚ùå No stewards found in the Member Directory.');
    return;
  }

  // Show steward selection dialog
  const response = ui.prompt(
    'üë§ Bulk Assign Steward',
    `You have selected ${selectedRows.length} grievance(s).\n\n` +
    `Available stewards:\n${stewards.slice(0, 10).join('\n')}${stewards.length > 10 ? '\n...' : ''}\n\n` +
    'Enter the steward name to assign:',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() !== ui.Button.OK) {
    return;
  }

  const stewardName = response.getResponseText().trim();

  if (!stewards.includes(stewardName)) {
    ui.alert(
      '‚ö†Ô∏è Invalid Steward',
      `"${stewardName}" is not a valid steward.\n\nPlease enter a name exactly as it appears in the list.`,
      ui.ButtonSet.OK
    );
    return;
  }

  // Confirm operation
  const confirmResponse = ui.alert(
    '‚ö†Ô∏è Confirm Bulk Assignment',
    `This will assign "${stewardName}" to ${selectedRows.length} grievance(s).\n\nContinue?`,
    ui.ButtonSet.YES_NO
  );

  if (confirmResponse !== ui.Button.YES) {
    return;
  }

  // Perform bulk assignment
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  let updated = 0;

  selectedRows.forEach(function(row) {
    grievanceSheet.getRange(row, GRIEVANCE_COLS.ASSIGNED_STEWARD).setValue(stewardName);
    updated++;
  });

  ui.alert(
    '‚úÖ Bulk Assignment Complete',
    `Successfully assigned "${stewardName}" to ${updated} grievance(s).`,
    ui.ButtonSet.OK
  );
}

/**
 * Bulk updates status for multiple grievances
 */
function batchUpdateStatus() {
  const ui = SpreadsheetApp.getUi();
  const selectedRows = getSelectedGrievanceRows();

  if (selectedRows.length === 0) {
    return;
  }

  const statusOptions = ['Open', 'In Progress', 'Resolved', 'Closed', 'Withdrawn', 'Escalated'];

  // Show status selection dialog
  const response = ui.prompt(
    'üìä Bulk Update Status',
    `You have selected ${selectedRows.length} grievance(s).\n\n` +
    `Available statuses:\n${statusOptions.join('\n')}\n\n` +
    'Enter the new status:',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() !== ui.Button.OK) {
    return;
  }

  const newStatus = response.getResponseText().trim();

  if (!statusOptions.includes(newStatus)) {
    ui.alert(
      '‚ö†Ô∏è Invalid Status',
      `"${newStatus}" is not a valid status.\n\nPlease enter one of:\n${statusOptions.join(', ')}`,
      ui.ButtonSet.OK
    );
    return;
  }

  // Confirm operation
  const confirmResponse = ui.alert(
    '‚ö†Ô∏è Confirm Bulk Status Update',
    `This will change the status to "${newStatus}" for ${selectedRows.length} grievance(s).\n\nContinue?`,
    ui.ButtonSet.YES_NO
  );

  if (confirmResponse !== ui.Button.YES) {
    return;
  }

  // Perform bulk status update
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  let updated = 0;

  selectedRows.forEach(function(row) {
    grievanceSheet.getRange(row, GRIEVANCE_COLS.STATUS).setValue(newStatus);

    // Update closed date if status is Closed or Resolved
    if (newStatus === 'Closed' || newStatus === 'Resolved') {
      grievanceSheet.getRange(row, GRIEVANCE_COLS.DATE_CLOSED).setValue(new Date());
    }

    updated++;
  });

  ui.alert(
    '‚úÖ Bulk Status Update Complete',
    `Successfully updated status to "${newStatus}" for ${updated} grievance(s).`,
    ui.ButtonSet.OK
  );
}

/**
 * Bulk exports selected grievances to PDF
 */
function batchExportPDF() {
  const ui = SpreadsheetApp.getUi();
  const selectedRows = getSelectedGrievanceRows();

  if (selectedRows.length === 0) {
    return;
  }

  if (selectedRows.length > 20) {
    ui.alert(
      '‚ö†Ô∏è Too Many Selections',
      `You selected ${selectedRows.length} grievances.\n\nFor performance reasons, bulk PDF export is limited to 20 grievances at a time.\n\nPlease select fewer rows.`,
      ui.ButtonSet.OK
    );
    return;
  }

  const confirmResponse = ui.alert(
    'üìÑ Confirm Bulk PDF Export',
    `This will generate ${selectedRows.length} PDF report(s).\n\nPDFs will be saved to your Google Drive.\n\nContinue?`,
    ui.ButtonSet.YES_NO
  );

  if (confirmResponse !== ui.Button.YES) {
    return;
  }

  SpreadsheetApp.getActiveSpreadsheet().toast('üìÑ Generating PDFs...', 'Please wait', -1);

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  const pdfs = [];

  selectedRows.forEach(function(row) {
    try {
      const grievanceId = grievanceSheet.getRange(row, GRIEVANCE_COLS.GRIEVANCE_ID).getValue();
      const pdf = exportGrievanceToPDF(grievanceId);
      if (pdf) {
        pdfs.push(pdf);
      }
    } catch (error) {
      Logger.log(`Error exporting row ${row}: ${error.message}`);
    }
  });

  ui.alert(
    '‚úÖ Bulk PDF Export Complete',
    `Successfully generated ${pdfs.length} PDF report(s).\n\nCheck your Google Drive for the files.`,
    ui.ButtonSet.OK
  );
}

/**
 * Exports a single grievance to PDF (helper function)
 * @param {string} grievanceId - Grievance ID to export
 * @returns {File} PDF file object
 */
function exportGrievanceToPDF(grievanceId) {
  // Creates a PDF using Google Docs conversion

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  // Find the grievance - read all columns up to RESOLUTION (last column)
  const lastRow = grievanceSheet.getLastRow();
  const data = grievanceSheet.getRange(2, 1, lastRow - 1, GRIEVANCE_COLS.RESOLUTION).getValues();

  for (let i = 0; i < data.length; i++) {
    if (data[i][GRIEVANCE_COLS.GRIEVANCE_ID - 1] === grievanceId) {
      const row = data[i];

      // Create a Google Doc
      const doc = DocumentApp.create(`Grievance_${grievanceId}_Report`);
      const body = doc.getBody();

      // Add content
      body.appendParagraph('SEIU Local 509 - Grievance Report').setHeading(DocumentApp.ParagraphHeading.HEADING1);
      body.appendParagraph(''); // Spacing

      body.appendParagraph(`Grievance ID: ${row[GRIEVANCE_COLS.GRIEVANCE_ID - 1]}`);
      body.appendParagraph(`Member: ${row[GRIEVANCE_COLS.FIRST_NAME - 1]} ${row[GRIEVANCE_COLS.LAST_NAME - 1]}`);
      body.appendParagraph(`Status: ${row[GRIEVANCE_COLS.STATUS - 1]}`);
      body.appendParagraph(`Issue Type: ${row[GRIEVANCE_COLS.ISSUE_CATEGORY - 1]}`);
      body.appendParagraph(`Filed Date: ${row[GRIEVANCE_COLS.DATE_FILED - 1]}`);
      body.appendParagraph(`Assigned Steward: ${row[GRIEVANCE_COLS.STEWARD - 1]}`);

      doc.saveAndClose();

      // Convert to PDF
      const docFile = DriveApp.getFileById(doc.getId());
      const pdfBlob = docFile.getAs('application/pdf');
      const pdfFile = DriveApp.createFile(pdfBlob);

      // Delete the temporary doc
      DriveApp.getFileById(doc.getId()).setTrashed(true);

      return pdfFile;
    }
  }

  return null;
}

/**
 * Bulk sends email notifications for selected grievances
 */
function batchEmailNotifications() {
  const ui = SpreadsheetApp.getUi();
  const selectedRows = getSelectedGrievanceRows();

  if (selectedRows.length === 0) {
    return;
  }

  if (selectedRows.length > 50) {
    ui.alert(
      '‚ö†Ô∏è Too Many Selections',
      `You selected ${selectedRows.length} grievances.\n\nFor email quota reasons, bulk email is limited to 50 recipients at a time.\n\nPlease select fewer rows.`,
      ui.ButtonSet.OK
    );
    return;
  }

  // Get email template
  const response = ui.prompt(
    'üìß Bulk Email Notifications',
    `You have selected ${selectedRows.length} grievance(s).\n\n` +
    'This will email the assigned steward for each grievance.\n\n' +
    'Enter email subject:',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() !== ui.Button.OK) {
    return;
  }

  const subject = response.getResponseText().trim();

  if (!subject) {
    ui.alert('‚ö†Ô∏è Subject is required.');
    return;
  }

  const messageResponse = ui.prompt(
    'üìß Email Message',
    'Enter email message body:',
    ui.ButtonSet.OK_CANCEL
  );

  if (messageResponse.getSelectedButton() !== ui.Button.OK) {
    return;
  }

  const message = messageResponse.getResponseText().trim();

  if (!message) {
    ui.alert('‚ö†Ô∏è Message is required.');
    return;
  }

  // Confirm operation
  const confirmResponse = ui.alert(
    '‚ö†Ô∏è Confirm Bulk Email',
    `This will send ${selectedRows.length} email(s).\n\nContinue?`,
    ui.ButtonSet.YES_NO
  );

  if (confirmResponse !== ui.Button.YES) {
    return;
  }

  SpreadsheetApp.getActiveSpreadsheet().toast('üìß Sending emails...', 'Please wait', -1);

  // Send emails
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  let sent = 0;

  selectedRows.forEach(function(row) {
    try {
      const grievanceId = grievanceSheet.getRange(row, GRIEVANCE_COLS.GRIEVANCE_ID).getValue();
      const steward = grievanceSheet.getRange(row, GRIEVANCE_COLS.ASSIGNED_STEWARD).getValue();
      const memberName = `${grievanceSheet.getRange(row, GRIEVANCE_COLS.FIRST_NAME).getValue()} ${grievanceSheet.getRange(row, GRIEVANCE_COLS.LAST_NAME).getValue()}`;

      if (steward && steward.toString().includes('@')) {
        const fullMessage = `${message}\n\n---\nGrievance ID: ${grievanceId}\nMember: ${memberName}\n\nSEIU Local 509 Dashboard`;

        MailApp.sendEmail({
          to: steward,
          subject: subject,
          body: fullMessage,
          name: 'SEIU Local 509 Dashboard'
        });

        sent++;
      }
    } catch (error) {
      Logger.log(`Error sending email for row ${row}: ${error.message}`);
    }
  });

  ui.alert(
    '‚úÖ Bulk Email Complete',
    `Successfully sent ${sent} email(s).`,
    ui.ButtonSet.OK
  );
}

/**
 * Bulk adds the same note to multiple grievances
 */
function batchAddNotes() {
  const ui = SpreadsheetApp.getUi();
  const selectedRows = getSelectedGrievanceRows();

  if (selectedRows.length === 0) {
    return;
  }

  // Get note text
  const response = ui.prompt(
    'üìù Bulk Add Notes',
    `You have selected ${selectedRows.length} grievance(s).\n\n` +
    'Enter note to add to all selected grievances:',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() !== ui.Button.OK) {
    return;
  }

  const noteText = response.getResponseText().trim();

  if (!noteText) {
    ui.alert('‚ö†Ô∏è Note text is required.');
    return;
  }

  // Confirm operation
  const confirmResponse = ui.alert(
    '‚ö†Ô∏è Confirm Bulk Note Addition',
    `This will add the note to ${selectedRows.length} grievance(s).\n\nContinue?`,
    ui.ButtonSet.YES_NO
  );

  if (confirmResponse !== ui.Button.YES) {
    return;
  }

  // Add notes
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  const timestamp = new Date().toLocaleString();
  const user = Session.getActiveUser().getEmail() || 'User';
  const formattedNote = `[${timestamp}] ${user}: ${noteText}`;

  let updated = 0;

  selectedRows.forEach(function(row) {
    const existingNotes = grievanceSheet.getRange(row, GRIEVANCE_COLS.NOTES).getValue() || '';
    const newNotes = existingNotes ? `${existingNotes}\n${formattedNote}` : formattedNote;
    grievanceSheet.getRange(row, GRIEVANCE_COLS.NOTES).setValue(newNotes);
    updated++;
  });

  ui.alert(
    '‚úÖ Bulk Note Addition Complete',
    `Successfully added note to ${updated} grievance(s).`,
    ui.ButtonSet.OK
  );
}



// ================================================================================
// MODULE: CalendarIntegration.gs
// Source: CalendarIntegration.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * GOOGLE CALENDAR INTEGRATION
 * ------------------------------------------------------------------------====
 *
 * Sync grievance deadlines to Google Calendar
 * Features:
 * - Create calendar events for all deadlines
 * - Color-code by priority (red for overdue, yellow for due soon)
 * - Update events when grievance status changes
 * - Delete events when grievance is closed
 */

/**
 * Syncs all grievance deadlines to Google Calendar
 */
function syncDeadlinesToCalendar() {
  const ui = SpreadsheetApp.getUi();

  const response = ui.alert(
    'üìÖ Sync Deadlines to Google Calendar',
    'This will create calendar events for all grievance deadlines.\n\n' +
    'Events will be created in your default Google Calendar with:\n' +
    '‚Ä¢ Red = Overdue\n' +
    '‚Ä¢ Orange = Due within 3 days\n' +
    '‚Ä¢ Yellow = Due within 7 days\n' +
    '‚Ä¢ Blue = Due later\n\n' +
    'Continue?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return;
  }

  try {
    SpreadsheetApp.getActiveSpreadsheet().toast('üìÖ Syncing deadlines to calendar...', 'Please wait', -1);

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

    if (!grievanceSheet) {
      ui.alert('‚ùå Grievance Log sheet not found!');
      return;
    }

    const lastRow = grievanceSheet.getLastRow();
    if (lastRow < 2) {
      ui.alert('‚ÑπÔ∏è No grievances found to sync.');
      return;
    }

    // Get all grievance data - read all columns up to RESOLUTION (last column)
    const data = grievanceSheet.getRange(2, 1, lastRow - 1, GRIEVANCE_COLS.RESOLUTION).getValues();

    const calendar = CalendarApp.getDefaultCalendar();
    let eventsCreated = 0;
    let eventsSkipped = 0;

    data.forEach(function(row, index) {
      const grievanceId = row[GRIEVANCE_COLS.GRIEVANCE_ID - 1];
      const memberName = `${row[GRIEVANCE_COLS.FIRST_NAME - 1]} ${row[GRIEVANCE_COLS.LAST_NAME - 1]}`;
      const status = row[GRIEVANCE_COLS.STATUS - 1];
      const nextActionDue = row[GRIEVANCE_COLS.NEXT_ACTION_DUE - 1];
      const daysToDeadline = row[GRIEVANCE_COLS.DAYS_TO_DEADLINE - 1];

      // Only create events for open grievances with deadlines
      if (status !== 'Open' || !nextActionDue) {
        eventsSkipped++;
        return;
      }

      // Check if event already exists
      const existingEvent = checkCalendarEventExists(calendar, grievanceId);
      if (existingEvent) {
        eventsSkipped++;
        return;
      }

      // Determine priority and color
      let color = CalendarApp.EventColor.BLUE; // Default: Due later
      let priority = 'Normal';

      if (daysToDeadline < 0) {
        color = CalendarApp.EventColor.RED;
        priority = 'OVERDUE';
      } else if (daysToDeadline <= 3) {
        color = CalendarApp.EventColor.ORANGE;
        priority = 'Urgent';
      } else if (daysToDeadline <= 7) {
        color = CalendarApp.EventColor.YELLOW;
        priority = 'Soon';
      }

      // Create event
      const title = `‚öñÔ∏è ${priority}: ${grievanceId} - ${memberName}`;
      const description =
        `Grievance Deadline\n\n` +
        `Grievance ID: ${grievanceId}\n` +
        `Member: ${memberName}\n` +
        `Status: ${status}\n` +
        `Days to Deadline: ${daysToDeadline}\n` +
        `Priority: ${priority}\n\n` +
        `Created by 509 Dashboard`;

      try {
        const event = calendar.createAllDayEvent(
          title,
          new Date(nextActionDue),
          {
            description: description,
            location: '509 Dashboard'
          }
        );

        event.setColor(color);
        event.setTag('509Dashboard', grievanceId); // Tag for identification

        eventsCreated++;
      } catch (error) {
        Logger.log(`Error creating event for ${grievanceId}: ${error.message}`);
      }
    });

    SpreadsheetApp.getActiveSpreadsheet().toast(
      `‚úÖ Created ${eventsCreated} calendar events (${eventsSkipped} skipped)`,
      'Complete',
      5
    );

    ui.alert(
      '‚úÖ Calendar Sync Complete',
      `Successfully synced deadlines to Google Calendar:\n\n` +
      `‚Ä¢ Events created: ${eventsCreated}\n` +
      `‚Ä¢ Events skipped: ${eventsSkipped} (closed or already synced)\n\n` +
      `Check your Google Calendar for the new events!`,
      ui.ButtonSet.OK
    );

  } catch (error) {
    ui.alert('‚ùå Error: ' + error.message);
    Logger.log('Calendar sync error: ' + error.message);
  }
}

/**
 * Checks if a calendar event already exists for a grievance
 * @param {Calendar} calendar - The Google Calendar
 * @param {string} grievanceId - The grievance ID to check
 * @returns {CalendarEvent|null} The existing event or null
 */
function checkCalendarEventExists(calendar, grievanceId) {
  const now = new Date();
  const futureDate = new Date(now.getTime() + (365 * 24 * 60 * 60 * 1000)); // 1 year from now

  const events = calendar.getEvents(now, futureDate);

  for (let i = 0; i < events.length; i++) {
    const event = events[i];
    const tag = event.getTag('509Dashboard');
    if (tag === grievanceId) {
      return event;
    }
  }

  return null;
}

/**
 * Syncs a single grievance deadline to calendar
 * @param {string} grievanceId - The grievance ID
 */
function syncSingleDeadlineToCalendar(grievanceId) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!grievanceSheet || !grievanceId) {
    return;
  }

  // Find the grievance
  const lastRow = grievanceSheet.getLastRow();
  const data = grievanceSheet.getRange(2, 1, lastRow - 1, GRIEVANCE_COLS.RESOLUTION).getValues();

  for (let i = 0; i < data.length; i++) {
    if (data[i][GRIEVANCE_COLS.GRIEVANCE_ID - 1] === grievanceId) {
      const row = data[i];
      const memberName = `${row[GRIEVANCE_COLS.FIRST_NAME - 1]} ${row[GRIEVANCE_COLS.LAST_NAME - 1]}`;
      const status = row[GRIEVANCE_COLS.STATUS - 1];
      const nextActionDue = row[GRIEVANCE_COLS.NEXT_ACTION_DUE - 1];
      const daysToDeadline = row[GRIEVANCE_COLS.DAYS_TO_DEADLINE - 1];

      if (status !== 'Open' || !nextActionDue) {
        return; // Skip if not open or no deadline
      }

      const calendar = CalendarApp.getDefaultCalendar();

      // Check if event already exists
      const existingEvent = checkCalendarEventExists(calendar, grievanceId);
      if (existingEvent) {
        // Update existing event
        let color = CalendarApp.EventColor.BLUE;
        if (daysToDeadline < 0) color = CalendarApp.EventColor.RED;
        else if (daysToDeadline <= 3) color = CalendarApp.EventColor.ORANGE;
        else if (daysToDeadline <= 7) color = CalendarApp.EventColor.YELLOW;

        existingEvent.setColor(color);
        existingEvent.setTime(new Date(nextActionDue), new Date(nextActionDue));
      } else {
        // Create new event (same logic as syncDeadlinesToCalendar)
        let color = CalendarApp.EventColor.BLUE;
        let priority = 'Normal';

        if (daysToDeadline < 0) {
          color = CalendarApp.EventColor.RED;
          priority = 'OVERDUE';
        } else if (daysToDeadline <= 3) {
          color = CalendarApp.EventColor.ORANGE;
          priority = 'Urgent';
        } else if (daysToDeadline <= 7) {
          color = CalendarApp.EventColor.YELLOW;
          priority = 'Soon';
        }

        const title = `‚öñÔ∏è ${priority}: ${grievanceId} - ${memberName}`;
        const description =
          `Grievance Deadline\n\n` +
          `Grievance ID: ${grievanceId}\n` +
          `Member: ${memberName}\n` +
          `Status: ${status}\n` +
          `Days to Deadline: ${daysToDeadline}\n` +
          `Priority: ${priority}\n\n` +
          `Created by 509 Dashboard`;

        const event = calendar.createAllDayEvent(
          title,
          new Date(nextActionDue),
          {
            description: description,
            location: '509 Dashboard'
          }
        );

        event.setColor(color);
        event.setTag('509Dashboard', grievanceId);
      }

      break;
    }
  }
}

/**
 * Removes calendar event when grievance is closed
 * @param {string} grievanceId - The grievance ID
 */
function removeCalendarEvent(grievanceId) {
  const calendar = CalendarApp.getDefaultCalendar();
  const event = checkCalendarEventExists(calendar, grievanceId);

  if (event) {
    event.deleteEvent();
    Logger.log(`Removed calendar event for ${grievanceId}`);
  }
}

/**
 * Clears all 509 Dashboard events from calendar
 */
function clearAllCalendarEvents() {
  const ui = SpreadsheetApp.getUi();

  const response = ui.alert(
    '‚ö†Ô∏è Clear All Calendar Events',
    'This will remove ALL grievance deadline events from your Google Calendar.\n\n' +
    'This action cannot be undone!\n\n' +
    'Continue?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return;
  }

  try {
    const calendar = CalendarApp.getDefaultCalendar();
    const now = new Date();
    const futureDate = new Date(now.getTime() + (365 * 24 * 60 * 60 * 1000));

    const events = calendar.getEvents(now, futureDate);
    let removedCount = 0;

    events.forEach(function(event) {
      const tag = event.getTag('509Dashboard');
      if (tag) {
        event.deleteEvent();
        removedCount++;
      }
    });

    ui.alert(
      '‚úÖ Calendar Events Cleared',
      `Removed ${removedCount} events from your calendar.`,
      ui.ButtonSet.OK
    );

  } catch (error) {
    ui.alert('‚ùå Error: ' + error.message);
  }
}

/**
 * Shows upcoming deadlines from calendar
 */
function showUpcomingDeadlinesFromCalendar() {
  try {
    const calendar = CalendarApp.getDefaultCalendar();
    const now = new Date();
    const nextWeek = new Date(now.getTime() + (7 * 24 * 60 * 60 * 1000));

    const events = calendar.getEvents(now, nextWeek);
    const dashboardEvents = events.filter(function(e) { return e.getTag('509Dashboard'); });

    if (dashboardEvents.length === 0) {
      SpreadsheetApp.getUi().alert(
        '‚ÑπÔ∏è No Upcoming Deadlines',
        'No grievance deadlines in the next 7 days.\n\n' +
        'Run "Sync Deadlines to Calendar" to create calendar events.',
        SpreadsheetApp.getUi().ButtonSet.OK
      );
      return;
    }

    const eventList = dashboardEvents
      .slice(0, 10)
      .map(function(e) { return `  ‚Ä¢ ${e.getTitle()} - ${e.getAllDayStartDate().toLocaleDateString()}`; })
      .join('\n');

    SpreadsheetApp.getUi().alert(
      'üìÖ Upcoming Deadlines (Next 7 Days)',
      `Found ${dashboardEvents.length} deadline(s):\n\n${eventList}` +
      (dashboardEvents.length > 10 ? `\n  ... and ${dashboardEvents.length - 10} more` : ''),
      SpreadsheetApp.getUi().ButtonSet.OK
    );

  } catch (error) {
    SpreadsheetApp.getUi().alert('‚ùå Error: ' + error.message);
  }
}



// ================================================================================
// MODULE: ColumnToggles.gs
// Source: ColumnToggles.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * COLUMN VISIBILITY TOGGLES
 * ------------------------------------------------------------------------====
 *
 * Functions to show/hide column groups in Member Directory
 * - Engagement Metrics toggle (Q-T: Last Virtual Mtg, Last In-Person Mtg, Open Rate, Volunteer Hours)
 * - Member Interests toggle (U-X: Interest Local, Interest Chapter, Interest Allied, Home Town)
 * - Level 2 columns toggle
 *
 * ------------------------------------------------------------------------====
 */

/**
 * Toggles visibility of Engagement Metrics columns in Member Directory
 * Columns Q-T: Last Virtual Mtg, Last In-Person Mtg, Open Rate, Volunteer Hours
 */
function toggleEngagementMetricsColumns() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (!sheet) {
    SpreadsheetApp.getUi().alert('‚ùå Member Directory sheet not found!');
    return;
  }

  // Engagement Metrics: columns 17-20 (Q-T)
  const firstCol = MEMBER_COLS.LAST_VIRTUAL_MTG;  // 17
  const numCols = 4;  // LAST_VIRTUAL_MTG, LAST_INPERSON_MTG, OPEN_RATE, VOLUNTEER_HOURS

  const isHidden = sheet.isColumnHiddenByUser(firstCol);

  if (isHidden) {
    sheet.showColumns(firstCol, numCols);
    SpreadsheetApp.getUi().alert('‚úÖ Engagement Metrics columns are now visible');
  } else {
    sheet.hideColumns(firstCol, numCols);
    SpreadsheetApp.getUi().alert('‚úÖ Engagement Metrics columns are now hidden');
  }
}

/**
 * Toggles visibility of Member Interests columns in Member Directory
 * Columns U-X: Interest Local, Interest Chapter, Interest Allied, Home Town
 */
function toggleMemberInterestsColumns() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (!sheet) {
    SpreadsheetApp.getUi().alert('‚ùå Member Directory sheet not found!');
    return;
  }

  // Member Interests: columns 21-24 (U-X)
  const firstCol = MEMBER_COLS.INTEREST_LOCAL;  // 21
  const numCols = 4;  // INTEREST_LOCAL, INTEREST_CHAPTER, INTEREST_ALLIED, HOME_TOWN

  const isHidden = sheet.isColumnHiddenByUser(firstCol);

  if (isHidden) {
    sheet.showColumns(firstCol, numCols);
    SpreadsheetApp.getUi().alert('‚úÖ Member Interests columns are now visible');
  } else {
    sheet.hideColumns(firstCol, numCols);
    SpreadsheetApp.getUi().alert('‚úÖ Member Interests columns are now hidden');
  }
}

/**
 * Toggles visibility of both Engagement Metrics and Member Interests columns
 */
function toggleEngagementAndInterestsColumns() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (!sheet) {
    SpreadsheetApp.getUi().alert('‚ùå Member Directory sheet not found!');
    return;
  }

  // Check if Engagement Metrics columns are hidden (use first column as indicator)
  const engagementHidden = sheet.isColumnHiddenByUser(MEMBER_COLS.LAST_VIRTUAL_MTG);
  const interestsHidden = sheet.isColumnHiddenByUser(MEMBER_COLS.INTEREST_LOCAL);

  // If both are hidden, show both. Otherwise hide both.
  if (engagementHidden && interestsHidden) {
    sheet.showColumns(MEMBER_COLS.LAST_VIRTUAL_MTG, 4);
    sheet.showColumns(MEMBER_COLS.INTEREST_LOCAL, 4);
    SpreadsheetApp.getUi().alert('‚úÖ Engagement Metrics & Member Interests columns are now visible');
  } else {
    sheet.hideColumns(MEMBER_COLS.LAST_VIRTUAL_MTG, 4);
    sheet.hideColumns(MEMBER_COLS.INTEREST_LOCAL, 4);
    SpreadsheetApp.getUi().alert('‚úÖ Engagement Metrics & Member Interests columns are now hidden');
  }
}

/**
 * Toggles visibility of Level 2 (engagement tracking) columns in Member Directory
 */
function toggleLevel2Columns() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (!sheet) {
    SpreadsheetApp.getUi().alert('‚ùå Member Directory sheet not found!');
    return;
  }

  // Level 2 columns start after the basic columns
  // These will be added at the end of the existing columns
  // Starting at column AH (34) based on current structure
  const firstLevel2Col = 34;

  // Count: 14 Level 2 columns (AH through AU)
  const numCols = 14;

  // Check if the Level 2 columns exist
  const lastCol = sheet.getLastColumn();
  if (lastCol < firstLevel2Col) {
    SpreadsheetApp.getUi().alert('‚ùå Level 2 columns have not been added yet.\n\nPlease run "Create Dashboard" to add Level 2 columns.');
    return;
  }

  // Check if columns are currently hidden
  const isHidden = sheet.isColumnHiddenByUser(firstLevel2Col);

  if (isHidden) {
    // Show columns
    sheet.showColumns(firstLevel2Col, numCols);
    SpreadsheetApp.getUi().alert('‚úÖ Level 2 columns are now visible');
  } else {
    // Hide columns
    sheet.hideColumns(firstLevel2Col, numCols);
    SpreadsheetApp.getUi().alert('‚úÖ Level 2 columns are now hidden');
  }
}

/**
 * Shows all hidden columns in Member Directory
 */
function showAllMemberColumns() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (!sheet) {
    SpreadsheetApp.getUi().alert('‚ùå Member Directory sheet not found!');
    return;
  }

  const lastCol = sheet.getLastColumn();

  // Show all columns
  for (let i = 1; i <= lastCol; i++) {
    if (sheet.isColumnHiddenByUser(i)) {
      sheet.showColumns(i);
    }
  }

  SpreadsheetApp.getUi().alert('‚úÖ All columns are now visible');
}

/* ==================== GRIEVANCE LOG COLUMN TOGGLES ==================== */

/**
 * Toggles visibility of Admin Message columns in Grievance Log
 * Columns AD-AF: Admin Flag, Admin Message, Acknowledged
 */
function toggleAdminMessageColumns() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!sheet) {
    SpreadsheetApp.getUi().alert('Grievance Log sheet not found!');
    return;
  }

  // Admin Message columns: 30-32 (AD-AF)
  const firstCol = GRIEVANCE_COLS.ADMIN_FLAG;  // 30
  const numCols = 3;  // ADMIN_FLAG, ADMIN_MESSAGE, MESSAGE_ACKNOWLEDGED

  // Check if columns exist
  const lastCol = sheet.getLastColumn();
  if (lastCol < firstCol) {
    // Columns don't exist yet - set them up
    const response = SpreadsheetApp.getUi().alert(
      'Admin Message columns not found',
      'Would you like to set up the Admin Message columns now?',
      SpreadsheetApp.getUi().ButtonSet.YES_NO
    );

    if (response === SpreadsheetApp.getUi().Button.YES) {
      setupAdminMessageColumns();
    }
    return;
  }

  const isHidden = sheet.isColumnHiddenByUser(firstCol);

  if (isHidden) {
    sheet.showColumns(firstCol, numCols);
    SpreadsheetApp.getUi().alert('Admin Message columns are now visible (AD-AF)');
  } else {
    sheet.hideColumns(firstCol, numCols);
    SpreadsheetApp.getUi().alert('Admin Message columns are now hidden');
  }
}

/**
 * Shows all hidden columns in Grievance Log
 */
function showAllGrievanceColumns() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!sheet) {
    SpreadsheetApp.getUi().alert('Grievance Log sheet not found!');
    return;
  }

  const lastCol = sheet.getLastColumn();

  // Show all columns
  for (let i = 1; i <= lastCol; i++) {
    if (sheet.isColumnHiddenByUser(i)) {
      sheet.showColumns(i);
    }
  }

  SpreadsheetApp.getUi().alert('All Grievance Log columns are now visible');
}



// ================================================================================
// MODULE: CoordinatorNotification.gs
// Source: CoordinatorNotification.gs
// ================================================================================

/**
 * COORDINATOR NOTIFICATION SYSTEM
 * Feature: Checkbox-based row highlighting and email notifications
 *
 * When a coordinator checks the "Coordinator Notified" checkbox (column AC):
 * 1. Highlights the entire grievance row
 * 2. Sends email to member and assigned steward with coordinator's message
 * 3. Row remains highlighted until checkbox is manually unchecked
 */

// ===========================
// INSTALLATION TRIGGER
// ===========================

/**
 * Sets up the onChange trigger for coordinator notifications
 * Run this once to install the trigger
 */
function setupCoordinatorNotificationTrigger() {
  // Remove existing triggers to avoid duplicates
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === 'onGrievanceEdit') {
      ScriptApp.deleteTrigger(trigger);
    }
  });

  // Create new onChange trigger
  ScriptApp.newTrigger('onGrievanceEdit')
    .forSpreadsheet(SpreadsheetApp.getActiveSpreadsheet())
    .onEdit()
    .create();

  SpreadsheetApp.getUi().alert('Success',
    'Coordinator notification trigger installed!\n\n' +
    'The system will now:\n' +
    '‚Ä¢ Monitor checkbox changes in Grievance Log\n' +
    '‚Ä¢ Highlight rows when coordinator notified\n' +
    '‚Ä¢ Send emails to member and steward\n' +
    '‚Ä¢ Remove highlighting when unchecked',
    SpreadsheetApp.getUi().ButtonSet.OK);

  Logger.log('Coordinator notification trigger installed successfully');
}

// ===========================
// TRIGGER FUNCTION
// ===========================

/**
 * Triggered on any edit to the spreadsheet
 * Monitors the Coordinator Notified checkbox column
 */
function onGrievanceEdit(e) {
  try {
    // Only process if we have event data
    if (!e) return;

    const sheet = e.range.getSheet();
    const sheetName = sheet.getName();

    // Only process Grievance Log edits
    if (sheetName !== 'Grievance Log') return;

    const row = e.range.getRow();
    const col = e.range.getColumn();

    // Only process if editing the Coordinator Notified column (AC = column 29)
    if (col !== GRIEVANCE_COLS.COORDINATOR_NOTIFIED) return;

    // Skip header row
    if (row === 1) return;

    const isChecked = e.value === 'TRUE' || e.value === true || e.value === 'Yes' || e.value === '‚úì';

    if (isChecked) {
      // Checkbox was checked - highlight and send notifications
      handleCoordinatorNotification(sheet, row);
    } else {
      // Checkbox was unchecked - remove highlighting
      removeRowHighlight(sheet, row);
    }

  } catch (error) {
    Logger.log(`Error in onGrievanceEdit: ${error.message}`);
    // Don't show alert to user - silent failure to avoid interrupting workflow
  }
}

// ===========================
// NOTIFICATION HANDLER
// ===========================

/**
 * Handles coordinator notification: highlights row and sends emails
 */
function handleCoordinatorNotification(sheet, row) {
  try {
    // Get grievance data (now 32 columns with Acknowledged By and Date)
    const data = sheet.getRange(row, 1, 1, 32).getValues()[0];

    const grievanceId = data[GRIEVANCE_COLS.GRIEVANCE_ID - 1];
    const memberId = data[GRIEVANCE_COLS.MEMBER_ID - 1];
    const firstName = data[GRIEVANCE_COLS.FIRST_NAME - 1];
    const lastName = data[GRIEVANCE_COLS.LAST_NAME - 1];
    const memberEmail = data[GRIEVANCE_COLS.MEMBER_EMAIL - 1];
    const issueCategory = data[GRIEVANCE_COLS.ISSUE_CATEGORY - 1];
    const stewardName = data[GRIEVANCE_COLS.STEWARD - 1];
    const coordinatorMessage = data[GRIEVANCE_COLS.COORDINATOR_MESSAGE - 1];
    const status = data[GRIEVANCE_COLS.STATUS - 1];

    // Get steward email from Member Directory
    const stewardEmail = getStewardEmail(stewardName);

    // Highlight the row
    highlightRow(sheet, row);

    // Send email notifications if message exists
    if (coordinatorMessage && coordinatorMessage.trim() !== '') {
      sendCoordinatorEmails(
        grievanceId,
        firstName,
        lastName,
        memberEmail,
        stewardName,
        stewardEmail,
        issueCategory,
        coordinatorMessage,
        status
      );
    }

    // Log the notification
    if (typeof logDataModification === 'function') {
      logDataModification(
        'COORDINATOR_NOTIFICATION',
        'Grievance Log',
        grievanceId,
        'Coordinator Notified',
        'FALSE',
        'TRUE'
      );
    }

    Logger.log(`Coordinator notification sent for grievance ${grievanceId}`);

  } catch (error) {
    Logger.log(`Error in handleCoordinatorNotification: ${error.message}`);
    SpreadsheetApp.getUi().alert('Error',
      `Failed to send coordinator notification: ${error.message}`,
      SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

// ===========================
// ROW HIGHLIGHTING
// ===========================

/**
 * Highlights a grievance row in yellow to indicate coordinator notification
 */
function highlightRow(sheet, row) {
  const numColumns = sheet.getLastColumn();
  const range = sheet.getRange(row, 1, 1, numColumns);

  // Set background to light yellow
  range.setBackground('#FEF3C7');

  // Set left border to thick orange for visibility
  range.setBorder(
    true, true, true, true, false, false,
    '#F97316', SpreadsheetApp.BorderStyle.SOLID_MEDIUM
  );

  Logger.log(`Row ${row} highlighted for coordinator notification`);
}

/**
 * Removes highlighting and records steward acknowledgment
 * When a steward unchecks the box, this logs their acknowledgment
 */
function removeRowHighlight(sheet, row) {
  const numColumns = sheet.getLastColumn();
  const range = sheet.getRange(row, 1, 1, numColumns);

  // Reset to default white background
  range.setBackground('#FFFFFF');

  // Remove borders
  range.setBorder(false, false, false, false, false, false);

  // Get current user (the steward who is acknowledging)
  const acknowledgedBy = Session.getActiveUser().getEmail();
  const acknowledgedDate = new Date();

  // Get grievance details for logging
  const grievanceId = sheet.getRange(row, GRIEVANCE_COLS.GRIEVANCE_ID).getValue();
  const coordinatorMessage = sheet.getRange(row, GRIEVANCE_COLS.COORDINATOR_MESSAGE).getValue();

  // Record who acknowledged and when
  sheet.getRange(row, GRIEVANCE_COLS.ACKNOWLEDGED_BY).setValue(acknowledgedBy);
  sheet.getRange(row, GRIEVANCE_COLS.ACKNOWLEDGED_DATE).setValue(acknowledgedDate);

  // NOTE: We DO NOT clear the Coordinator Message - it stays for record keeping

  Logger.log(`Row ${row} acknowledged by ${acknowledgedBy} at ${acknowledgedDate}`);

  // Log the acknowledgment to Audit_Log
  if (typeof logDataModification === 'function') {
    logDataModification(
      'STEWARD_ACKNOWLEDGED',
      'Grievance Log',
      grievanceId,
      'Coordinator Message Acknowledged',
      coordinatorMessage || 'N/A',
      `Acknowledged by ${acknowledgedBy} at ${acknowledgedDate.toLocaleString()}`
    );
  }
}

// ===========================
// EMAIL NOTIFICATIONS
// ===========================

/**
 * Sends email notifications to member and steward
 */
function sendCoordinatorEmails(grievanceId, firstName, lastName, memberEmail, stewardName, stewardEmail, issueCategory, message, status) {
  const coordinatorName = Session.getActiveUser().getEmail().split('@')[0]; // Extract name from email
  const subject = `Grievance Update: ${grievanceId}`;

  // Email body for member
  const memberBody = `
Dear ${firstName} ${lastName},

This is an update regarding your grievance ${grievanceId} (${issueCategory}).

**Current Status:** ${status}

**Message from Grievance Coordinator:**
${message}

Your assigned steward, ${stewardName}, has also been notified of this update.

If you have any questions or concerns, please contact your steward or the grievance coordinator.

Best regards,
SEIU Local 509 Grievance Coordinator

---
This is an automated notification from the 509 Dashboard system.
  `.trim();

  // Email body for steward
  const stewardBody = `
Dear ${stewardName},

This is an update regarding grievance ${grievanceId} for member ${firstName} ${lastName}.

**Grievance Details:**
- **ID:** ${grievanceId}
- **Member:** ${firstName} ${lastName}
- **Issue:** ${issueCategory}
- **Status:** ${status}

**Message from Grievance Coordinator:**
${message}

The member has also been notified of this update.

Please follow up as needed.

Best regards,
SEIU Local 509 Grievance Coordinator

---
This is an automated notification from the 509 Dashboard system.
  `.trim();

  // Send email to member
  if (memberEmail && isValidEmail(memberEmail)) {
    try {
      MailApp.sendEmail({
        to: memberEmail,
        subject: subject,
        body: memberBody,
        noReply: true
      });
      Logger.log(`Email sent to member: ${memberEmail}`);
    } catch (error) {
      Logger.log(`Failed to send email to member ${memberEmail}: ${error.message}`);
    }
  } else {
    Logger.log(`Invalid or missing member email: ${memberEmail}`);
  }

  // Send email to steward
  if (stewardEmail && isValidEmail(stewardEmail)) {
    try {
      MailApp.sendEmail({
        to: stewardEmail,
        subject: subject,
        body: stewardBody,
        noReply: true
      });
      Logger.log(`Email sent to steward: ${stewardEmail}`);
    } catch (error) {
      Logger.log(`Failed to send email to steward ${stewardEmail}: ${error.message}`);
    }
  } else {
    Logger.log(`Invalid or missing steward email: ${stewardEmail}`);
  }
}

// ===========================
// HELPER FUNCTIONS
// ===========================

/**
 * Gets steward email from Member Directory
 */
function getStewardEmail(stewardName) {
  if (!stewardName || stewardName.trim() === '') {
    return null;
  }

  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const memberDir = ss.getSheetByName('Member Directory');

    if (!memberDir) {
      Logger.log('Member Directory sheet not found');
      return null;
    }

    const data = memberDir.getDataRange().getValues();
    const headers = data[0];
    const nameColIndex = headers.indexOf('First Name');
    const lastNameColIndex = headers.indexOf('Last Name');
    const emailColIndex = headers.indexOf('Email Address');
    const isStewardColIndex = headers.indexOf('Is Steward (Y/N)');

    // Search for steward by name
    const nameParts = stewardName.trim().split(' ');
    const firstName = nameParts[0];
    const lastName = nameParts.length > 1 ? nameParts[nameParts.length - 1] : '';

    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const rowFirstName = row[nameColIndex];
      const rowLastName = row[lastNameColIndex];
      const isSteward = row[isStewardColIndex];

      if (isSteward === 'Yes' || isSteward === 'Y') {
        if (rowFirstName === firstName && (lastName === '' || rowLastName === lastName)) {
          return row[emailColIndex];
        }
      }
    }

    Logger.log(`Steward email not found for: ${stewardName}`);
    return null;

  } catch (error) {
    Logger.log(`Error getting steward email: ${error.message}`);
    return null;
  }
}

/**
 * Validates email address format
 */
function isValidEmail(email) {
  if (!email || typeof email !== 'string') {
    return false;
  }

  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email.trim());
}

// ===========================
// MANUAL NOTIFICATION DIALOG
// ===========================

/**
 * Shows dialog for coordinator to add message and notify
 * Can be called from menu or directly on a row
 */
function showCoordinatorMessageDialog() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getActiveSheet();

  // Check if we're on Grievance Log
  if (sheet.getName() !== 'Grievance Log') {
    ui.alert('Error', 'Please select a row in the Grievance Log sheet first.', ui.ButtonSet.OK);
    return;
  }

  const activeRow = sheet.getActiveRange().getRow();

  // Skip header row
  if (activeRow === 1) {
    ui.alert('Error', 'Please select a grievance row (not the header).', ui.ButtonSet.OK);
    return;
  }

  const grievanceId = sheet.getRange(activeRow, GRIEVANCE_COLS.GRIEVANCE_ID).getValue();
  const memberName = sheet.getRange(activeRow, GRIEVANCE_COLS.FIRST_NAME).getValue() + ' ' +
                     sheet.getRange(activeRow, GRIEVANCE_COLS.LAST_NAME).getValue();

  const response = ui.prompt(
    'Coordinator Message',
    `Enter message for grievance ${grievanceId} (${memberName}):\n\n` +
    'This will be sent to the member and assigned steward.',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() === ui.Button.OK) {
    const message = response.getResponseText().trim();

    if (message === '') {
      ui.alert('Error', 'Message cannot be empty.', ui.ButtonSet.OK);
      return;
    }

    // Set the message
    sheet.getRange(activeRow, GRIEVANCE_COLS.COORDINATOR_MESSAGE).setValue(message);

    // Check the checkbox to trigger notification
    sheet.getRange(activeRow, GRIEVANCE_COLS.COORDINATOR_NOTIFIED).setValue(true);

    ui.alert('Success',
      'Coordinator message saved and notifications sent!\n\n' +
      'The row will remain highlighted until you uncheck the checkbox.',
      ui.ButtonSet.OK);
  }
}

/**
 * Batch notification for multiple grievances
 */
function showBatchCoordinatorNotification() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName('Grievance Log');

  if (!sheet) {
    ui.alert('Error', 'Grievance Log sheet not found.', ui.ButtonSet.OK);
    return;
  }

  const response = ui.prompt(
    'Batch Coordinator Notification',
    'Enter message to send for ALL checked grievances:\n\n' +
    '(Only grievances with the checkbox already checked will receive this message)',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() !== ui.Button.OK) {
    return;
  }

  const message = response.getResponseText().trim();

  if (message === '') {
    ui.alert('Error', 'Message cannot be empty.', ui.ButtonSet.OK);
    return;
  }

  // Find all checked rows
  const data = sheet.getDataRange().getValues();
  let count = 0;

  for (let i = 1; i < data.length; i++) { // Skip header
    const row = i + 1;
    const isChecked = data[i][GRIEVANCE_COLS.COORDINATOR_NOTIFIED - 1];

    if (isChecked === true || isChecked === 'TRUE' || isChecked === 'Yes' || isChecked === '‚úì') {
      // Update message
      sheet.getRange(row, GRIEVANCE_COLS.COORDINATOR_MESSAGE).setValue(message);

      // Trigger notification by re-checking
      handleCoordinatorNotification(sheet, row);
      count++;
    }
  }

  ui.alert('Batch Notification Complete',
    `Sent coordinator message to ${count} grievance(s).`,
    ui.ButtonSet.OK);
}

/**
 * Clear all coordinator notifications (admin only)
 */
function clearAllCoordinatorNotifications() {
  const ui = SpreadsheetApp.getUi();

  // Confirm action
  const response = ui.alert(
    'Clear All Notifications',
    'This will:\n' +
    '‚Ä¢ Uncheck all coordinator notification checkboxes\n' +
    '‚Ä¢ Remove all row highlighting\n' +
    '‚Ä¢ Keep coordinator messages intact\n\n' +
    'Continue?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return;
  }

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName('Grievance Log');

  if (!sheet) {
    ui.alert('Error', 'Grievance Log sheet not found.', ui.ButtonSet.OK);
    return;
  }

  const lastRow = sheet.getLastRow();

  // Clear all checkboxes and highlighting (skip header)
  for (let row = 2; row <= lastRow; row++) {
    sheet.getRange(row, GRIEVANCE_COLS.COORDINATOR_NOTIFIED).setValue(false);
    removeRowHighlight(sheet, row);
  }

  ui.alert('Success', `Cleared all coordinator notifications (${lastRow - 1} rows processed).`, ui.ButtonSet.OK);
}



// ================================================================================
// MODULE: CustomReportBuilder.gs
// Source: CustomReportBuilder.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * CUSTOM REPORT BUILDER
 * ------------------------------------------------------------------------====
 *
 * Build custom reports with filters, grouping, and export
 * Features:
 * - Interactive report builder UI
 * - Custom field selection
 * - Advanced filtering (AND/OR conditions)
 * - Grouping and aggregation
 * - Sorting options
 * - Export to PDF, CSV, Excel
 * - Save and load report templates
 * - Schedule automated reports
 */

/**
 * Shows custom report builder dialog
 */
function showCustomReportBuilder() {
  const html = createReportBuilderHTML();
  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(1000)
    .setHeight(750);

  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'üìä Custom Report Builder');
}

/**
 * Creates HTML for report builder
 */
function createReportBuilderHTML() {
  const grievanceFields = getGrievanceFields();
  const memberFields = getMemberFields();

  return `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 {
      color: #1a73e8;
      margin-top: 0;
      border-bottom: 3px solid #1a73e8;
      padding-bottom: 10px;
    }
    .builder-section {
      background: #f8f9fa;
      padding: 20px;
      margin: 15px 0;
      border-radius: 8px;
      border-left: 4px solid #1a73e8;
    }
    .section-title {
      font-weight: bold;
      font-size: 16px;
      color: #333;
      margin-bottom: 15px;
    }
    .form-group {
      margin: 15px 0;
    }
    label {
      display: block;
      font-weight: 500;
      margin-bottom: 5px;
      color: #555;
    }
    select, input[type="text"], input[type="date"] {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    select:focus, input:focus {
      outline: none;
      border-color: #1a73e8;
    }
    .multi-select {
      height: 150px;
    }
    .filter-row {
      display: grid;
      grid-template-columns: 2fr 1fr 2fr auto;
      gap: 10px;
      margin: 10px 0;
      align-items: end;
    }
    button {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px 5px 5px 0;
    }
    button:hover {
      background: #1557b0;
    }
    button.secondary {
      background: #6c757d;
    }
    button.secondary:hover {
      background: #5a6268;
    }
    button.small {
      padding: 8px 16px;
      font-size: 13px;
    }
    button.danger {
      background: #dc3545;
    }
    button.danger:hover {
      background: #c82333;
    }
    .button-group {
      margin-top: 25px;
      padding-top: 20px;
      border-top: 2px solid #e0e0e0;
    }
    .info-box {
      background: #e8f0fe;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
      border-left: 4px solid #1a73e8;
    }
    #preview {
      max-height: 300px;
      overflow-y: auto;
      background: white;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th {
      background: #1a73e8;
      color: white;
      padding: 8px;
      text-align: left;
      font-size: 11px;
    }
    td {
      padding: 6px 8px;
      border-bottom: 1px solid #e0e0e0;
      font-size: 11px;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìä Custom Report Builder</h2>

    <div class="info-box">
      <strong>üí° Quick Start:</strong> Select data source, choose fields, add filters, then generate your report.
      You can export to PDF, CSV, or Excel.
    </div>

    <!-- Data Source -->
    <div class="builder-section">
      <div class="section-title">1. Select Data Source</div>
      <div class="form-group">
        <label>Data Source:</label>
        <select id="dataSource" onchange="updateFieldOptions()">
          <option value="grievances">Grievance Log</option>
          <option value="members">Member Directory</option>
          <option value="combined">Combined (Grievances + Members)</option>
        </select>
      </div>
    </div>

    <!-- Field Selection -->
    <div class="builder-section">
      <div class="section-title">2. Select Fields to Include</div>
      <div class="form-group">
        <label>Fields (hold Ctrl/Cmd to select multiple):</label>
        <select id="fields" multiple class="multi-select">
          ${grievanceFields.map(function(f) { return `<option value="${f.key}">${f.name}</option>`; }).join('')}
        </select>
      </div>
      <button class="small secondary" onclick="selectAllFields()">Select All</button>
      <button class="small secondary" onclick="clearFields()">Clear All</button>
    </div>

    <!-- Filters -->
    <div class="builder-section">
      <div class="section-title">3. Add Filters (Optional)</div>
      <div id="filters">
        <div class="filter-row">
          <div>
            <label>Field:</label>
            <select id="filter0_field">
              ${grievanceFields.map(function(f) { return `<option value="${f.key}">${f.name}</option>`; }).join('')}
            </select>
          </div>
          <div>
            <label>Operator:</label>
            <select id="filter0_operator">
              <option value="equals">Equals</option>
              <option value="not_equals">Not Equals</option>
              <option value="contains">Contains</option>
              <option value="starts_with">Starts With</option>
              <option value="greater_than">Greater Than</option>
              <option value="less_than">Less Than</option>
            </select>
          </div>
          <div>
            <label>Value:</label>
            <input type="text" id="filter0_value" placeholder="Filter value">
          </div>
          <div>
            <button class="small danger" onclick="removeFilter(0)" style="margin-top: 22px;">Remove</button>
          </div>
        </div>
      </div>
      <button class="small" onclick="addFilter()">+ Add Filter</button>
    </div>

    <!-- Grouping & Sorting -->
    <div class="builder-section">
      <div class="section-title">4. Grouping & Sorting</div>
      <div class="form-group">
        <label>Group By (optional):</label>
        <select id="groupBy">
          <option value="">No Grouping</option>
          ${grievanceFields.map(function(f) { return `<option value="${f.key}">${f.name}</option>`; }).join('')}
        </select>
      </div>
      <div class="form-group">
        <label>Sort By:</label>
        <select id="sortBy">
          ${grievanceFields.map(function(f) { return `<option value="${f.key}">${f.name}</option>`; }).join('')}
        </select>
      </div>
      <div class="form-group">
        <label>Sort Order:</label>
        <select id="sortOrder">
          <option value="asc">Ascending</option>
          <option value="desc">Descending</option>
        </select>
      </div>
    </div>

    <!-- Date Range -->
    <div class="builder-section">
      <div class="section-title">5. Date Range (Optional)</div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div class="form-group">
          <label>From Date:</label>
          <input type="date" id="dateFrom">
        </div>
        <div class="form-group">
          <label>To Date:</label>
          <input type="date" id="dateTo">
        </div>
      </div>
    </div>

    <!-- Preview -->
    <div class="builder-section">
      <div class="section-title">6. Preview</div>
      <div id="preview" class="loading">
        Click "Generate Preview" to see your report
      </div>
      <button class="secondary" onclick="generatePreview()">üîç Generate Preview</button>
    </div>

    <!-- Actions -->
    <div class="button-group">
      <button onclick="exportToPDF()">üìÑ Export to PDF</button>
      <button onclick="exportToCSV()">üìë Export to CSV</button>
      <button onclick="exportToExcel()">üìä Export to Excel</button>
      <button class="secondary" onclick="saveTemplate()">üíæ Save Template</button>
      <button class="secondary" onclick="loadTemplate()">üìÇ Load Template</button>
    </div>
  </div>

  <script>
    let filterCount = 1;
    const grievanceFields = ${JSON.stringify(grievanceFields)};
    const memberFields = ${JSON.stringify(memberFields)};

    function updateFieldOptions() {
      const dataSource = document.getElementById('dataSource').value;
      const fieldsSelect = document.getElementById('fields');

      fieldsSelect.innerHTML = '';

      const fields = dataSource === 'members' ? memberFields : grievanceFields;

      fields.forEach(function(f) {
        const option = document.createElement('option');
        option.value = f.key;
        option.textContent = f.name;
        fieldsSelect.appendChild(option);
      });
    }

    function selectAllFields() {
      const fieldsSelect = document.getElementById('fields');
      for (let i = 0; i < fieldsSelect.options.length; i++) {
        fieldsSelect.options[i].selected = true;
      }
    }

    function clearFields() {
      const fieldsSelect = document.getElementById('fields');
      for (let i = 0; i < fieldsSelect.options.length; i++) {
        fieldsSelect.options[i].selected = false;
      }
    }

    function addFilter() {
      const filtersDiv = document.getElementById('filters');
      const newFilter = document.createElement('div');
      newFilter.className = 'filter-row';
      newFilter.id = 'filter' + filterCount;
      newFilter.innerHTML = \`
        <div>
          <label>Field:</label>
          <select id="filter\${filterCount}_field">
            \${grievanceFields.map(function(f) { return '<option value="' + f.key + '">' + f.name + '</option>'; }).join('')}
          </select>
        </div>
        <div>
          <label>Operator:</label>
          <select id="filter\${filterCount}_operator">
            <option value="equals">Equals</option>
            <option value="not_equals">Not Equals</option>
            <option value="contains">Contains</option>
            <option value="starts_with">Starts With</option>
            <option value="greater_than">Greater Than</option>
            <option value="less_than">Less Than</option>
          </select>
        </div>
        <div>
          <label>Value:</label>
          <input type="text" id="filter\${filterCount}_value" placeholder="Filter value">
        </div>
        <div>
          <button class="small danger" onclick="removeFilter(\${filterCount})" style="margin-top: 22px;">Remove</button>
        </div>
      \`;
      filtersDiv.appendChild(newFilter);
      filterCount++;
    }

    function removeFilter(id) {
      const filter = document.getElementById('filter' + id);
      if (filter) {
        filter.remove();
      }
    }

    function getReportConfig() {
      const fieldsSelect = document.getElementById('fields');
      const selectedFields = Array.from(fieldsSelect.selectedOptions).map(function(opt) { return opt.value; });

      const filters = [];
      for (let i = 0; i < filterCount; i++) {
        const fieldElem = document.getElementById('filter' + i + '_field');
        if (fieldElem) {
          filters.push({
            field: fieldElem.value,
            operator: document.getElementById('filter' + i + '_operator').value,
            value: document.getElementById('filter' + i + '_value').value
          });
        }
      }

      return {
        dataSource: document.getElementById('dataSource').value,
        fields: selectedFields,
        filters: filters,
        groupBy: document.getElementById('groupBy').value,
        sortBy: document.getElementById('sortBy').value,
        sortOrder: document.getElementById('sortOrder').value,
        dateFrom: document.getElementById('dateFrom').value,
        dateTo: document.getElementById('dateTo').value
      };
    }

    function generatePreview() {
      const config = getReportConfig();

      if (config.fields.length === 0) {
        alert('Please select at least one field');
        return;
      }

      document.getElementById('preview').innerHTML = '<div class="loading">Generating preview...</div>';

      google.script.run
        .withSuccessHandler(displayPreview)
        .withFailureHandler(onError)
        .generateReportData(config, 10); // Preview first 10 rows
    }

    function displayPreview(data) {
      const preview = document.getElementById('preview');

      if (!data || data.length === 0) {
        preview.innerHTML = '<div class="loading">No data matches your filters</div>';
        return;
      }

      let html = '<table><thead><tr>';

      // Headers
      Object.keys(data[0]).forEach(function(key) {
        html += '<th>' + key + '</th>';
      });
      html += '</tr></thead><tbody>';

      // Data rows
      data.forEach(function(row) {
        html += '<tr>';
        Object.values(row).forEach(function(value) {
          html += '<td>' + (value || '') + '</td>';
        });
        html += '</tr>';
      });

      html += '</tbody></table>';
      html += '<div style="margin-top: 10px; color: #666; font-size: 12px;">Showing first ' + data.length + ' rows</div>';

      preview.innerHTML = html;
    }

    function onError(error) {
      alert('Error: ' + error.message);
      document.getElementById('preview').innerHTML = '<div class="loading">Error generating preview</div>';
    }

    function exportToPDF() {
      const config = getReportConfig();

      if (config.fields.length === 0) {
        alert('Please select at least one field');
        return;
      }

      alert('Generating PDF report... This may take a moment.');

      google.script.run
        .withSuccessHandler(function() {
          alert('‚úÖ PDF report generated and saved to Google Drive!');
        })
        .withFailureHandler(onError)
        .exportReportToPDF(config);
    }

    function exportToCSV() {
      const config = getReportConfig();

      if (config.fields.length === 0) {
        alert('Please select at least one field');
        return;
      }

      google.script.run
        .withSuccessHandler(function(csvData) {
          downloadCSV(csvData);
        })
        .withFailureHandler(onError)
        .exportReportToCSV(config);
    }

    function exportToExcel() {
      const config = getReportConfig();

      if (config.fields.length === 0) {
        alert('Please select at least one field');
        return;
      }

      alert('Generating Excel report... This may take a moment.');

      google.script.run
        .withSuccessHandler(function() {
          alert('‚úÖ Excel report generated and saved to Google Drive!');
        })
        .withFailureHandler(onError)
        .exportReportToExcel(config);
    }

    function downloadCSV(csvData) {
      const blob = new Blob([csvData], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'report_' + new Date().toISOString().slice(0, 10) + '.csv';
      a.click();
      window.URL.revokeObjectURL(url);
    }

    function saveTemplate() {
      const config = getReportConfig();
      const name = prompt('Enter template name:');

      if (!name) return;

      google.script.run
        .withSuccessHandler(function() {
          alert('‚úÖ Template saved: ' + name);
        })
        .withFailureHandler(onError)
        .saveReportTemplate(name, config);
    }

    function loadTemplate() {
      google.script.run
        .withSuccessHandler(showTemplateList)
        .withFailureHandler(onError)
        .getReportTemplates();
    }

    function showTemplateList(templates) {
      if (!templates || templates.length === 0) {
        alert('No saved templates found');
        return;
      }

      const templateNames = templates.map(function(t) { return t.name; }).join('\\n');
      const selected = prompt('Available templates:\\n' + templateNames + '\\n\\nEnter template name to load:');

      if (!selected) return;

      const template = templates.find(function(t) { return t.name === selected; });
      if (template) {
        applyTemplate(template.config);
      } else {
        alert('Template not found');
      }
    }

    function applyTemplate(config) {
      document.getElementById('dataSource').value = config.dataSource;
      updateFieldOptions();

      // Select fields
      const fieldsSelect = document.getElementById('fields');
      for (let i = 0; i < fieldsSelect.options.length; i++) {
        fieldsSelect.options[i].selected = config.fields.includes(fieldsSelect.options[i].value);
      }

      // Apply other settings
      document.getElementById('groupBy').value = config.groupBy || '';
      document.getElementById('sortBy').value = config.sortBy || '';
      document.getElementById('sortOrder').value = config.sortOrder || 'asc';
      document.getElementById('dateFrom').value = config.dateFrom || '';
      document.getElementById('dateTo').value = config.dateTo || '';

      alert('‚úÖ Template loaded');
    }
  </script>
</body>
</html>
  `;
}

/**
 * Gets available grievance fields
 * @returns {Array} Field definitions
 */
function getGrievanceFields() {
  return [
    { key: 'grievanceId', name: 'Grievance ID' },
    { key: 'memberId', name: 'Member ID' },
    { key: 'firstName', name: 'First Name' },
    { key: 'lastName', name: 'Last Name' },
    { key: 'status', name: 'Status' },
    { key: 'issueType', name: 'Issue Type' },
    { key: 'filedDate', name: 'Filed Date' },
    { key: 'description', name: 'Description' },
    { key: 'outcome', name: 'Outcome Sought' },
    { key: 'location', name: 'Work Location' },
    { key: 'unit', name: 'Unit' },
    { key: 'manager', name: 'Manager' },
    { key: 'supervisor', name: 'Supervisor' },
    { key: 'assignedSteward', name: 'Assigned Steward' },
    { key: 'meetingDate', name: 'Meeting Date' },
    { key: 'step1Response', name: 'Step 1 Response' },
    { key: 'step1ResponseDate', name: 'Step 1 Response Date' },
    { key: 'step2EscalationDate', name: 'Step 2 Escalation Date' },
    { key: 'dateClosed', name: 'Date Closed' },
    { key: 'nextActionDue', name: 'Next Action Due' },
    { key: 'daysToDeadline', name: 'Days to Deadline' },
    { key: 'deadlineStatus', name: 'Deadline Status' },
    { key: 'notes', name: 'Notes' }
  ];
}

/**
 * Gets available member fields
 * @returns {Array} Field definitions
 */
function getMemberFields() {
  return [
    { key: 'memberId', name: 'Member ID' },
    { key: 'firstName', name: 'First Name' },
    { key: 'lastName', name: 'Last Name' },
    { key: 'title', name: 'Job Title' },
    { key: 'workLocation', name: 'Work Location' },
    { key: 'unit', name: 'Unit' },
    { key: 'hireDate', name: 'Hire Date' },
    { key: 'email', name: 'Email' },
    { key: 'phone', name: 'Phone' },
    { key: 'isSteward', name: 'Is Steward?' }
  ];
}

/**
 * Generates report data based on configuration
 * @param {Object} config - Report configuration
 * @param {number} limit - Row limit for preview
 * @returns {Array} Report data
 */
function generateReportData(config, limit = null) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  let sourceData;
  let fieldMapping;

  if (config.dataSource === 'grievances') {
    const sheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
    sourceData = sheet.getRange(2, 1, sheet.getLastRow() - 1, 28).getValues();
    fieldMapping = getGrievanceFieldMapping();
  } else {
    const sheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
    sourceData = sheet.getRange(2, 1, sheet.getLastRow() - 1, 28).getValues();
    fieldMapping = getMemberFieldMapping();
  }

  // Apply filters
  let filteredData = sourceData.filter(function(row) {
    return applyFilters(row, config.filters, fieldMapping);
  });

  // Apply date range
  if (config.dateFrom || config.dateTo) {
    filteredData = applyDateRange(filteredData, config.dateFrom, config.dateTo, fieldMapping);
  }

  // Sort data
  if (config.sortBy) {
    filteredData = sortData(filteredData, config.sortBy, config.sortOrder, fieldMapping);
  }

  // Limit for preview
  if (limit) {
    filteredData = filteredData.slice(0, limit);
  }

  // Select fields and format
  const reportData = filteredData.map(function(row) {
    const reportRow = {};
    config.fields.forEach(function(fieldKey) {
      const field = fieldMapping[fieldKey];
      if (field) {
        reportRow[field.name] = formatValue(row[field.index], field.type);
      }
    });
    return reportRow;
  });

  return reportData;
}

/**
 * Gets field mapping for grievances
 * @returns {Object} Field mapping
 */
function getGrievanceFieldMapping() {
  return {
    grievanceId: { index: 0, name: 'Grievance ID', type: 'string' },
    memberId: { index: 1, name: 'Member ID', type: 'string' },
    firstName: { index: 2, name: 'First Name', type: 'string' },
    lastName: { index: 3, name: 'Last Name', type: 'string' },
    status: { index: 4, name: 'Status', type: 'string' },
    issueType: { index: 5, name: 'Issue Type', type: 'string' },
    filedDate: { index: 6, name: 'Filed Date', type: 'date' },
    description: { index: 7, name: 'Description', type: 'string' },
    location: { index: 9, name: 'Work Location', type: 'string' },
    assignedSteward: { index: 13, name: 'Assigned Steward', type: 'string' },
    nextActionDue: { index: 19, name: 'Next Action Due', type: 'date' },
    daysToDeadline: { index: 20, name: 'Days to Deadline', type: 'number' }
  };
}

/**
 * Gets field mapping for members
 * @returns {Object} Field mapping
 */
function getMemberFieldMapping() {
  return {
    memberId: { index: 0, name: 'Member ID', type: 'string' },
    firstName: { index: 1, name: 'First Name', type: 'string' },
    lastName: { index: 2, name: 'Last Name', type: 'string' },
    title: { index: 3, name: 'Job Title', type: 'string' },
    workLocation: { index: 4, name: 'Work Location', type: 'string' },
    email: { index: 7, name: 'Email', type: 'string' },
    phone: { index: 8, name: 'Phone', type: 'string' },
    isSteward: { index: 9, name: 'Is Steward?', type: 'string' }
  };
}

/**
 * Applies filters to data
 * @param {Array} row - Data row
 * @param {Array} filters - Filter configuration
 * @param {Object} fieldMapping - Field mapping
 * @returns {boolean} Whether row passes filters
 */
function applyFilters(row, filters, fieldMapping) {
  if (!filters || filters.length === 0) return true;

  return filters.every(function(filter) {
    if (!filter.value) return true;

    const field = fieldMapping[filter.field];
    if (!field) return true;

    const cellValue = String(row[field.index] || '').toLowerCase();
    const filterValue = String(filter.value).toLowerCase();

    switch (filter.operator) {
      case 'equals':
        return cellValue === filterValue;
      case 'not_equals':
        return cellValue !== filterValue;
      case 'contains':
        return cellValue.includes(filterValue);
      case 'starts_with':
        return cellValue.startsWith(filterValue);
      case 'greater_than':
        return parseFloat(cellValue) > parseFloat(filterValue);
      case 'less_than':
        return parseFloat(cellValue) < parseFloat(filterValue);
      default:
        return true;
    }
  });
}

/**
 * Applies date range filter
 * @param {Array} data - Data array
 * @param {string} dateFrom - Start date
 * @param {string} dateTo - End date
 * @param {Object} fieldMapping - Field mapping
 * @returns {Array} Filtered data
 */
function applyDateRange(data, dateFrom, dateTo, fieldMapping) {
  const fromDate = dateFrom ? new Date(dateFrom) : null;
  const toDate = dateTo ? new Date(dateTo) : null;

  return data.filter(function(row) {
    // Use DATE_FILED column for filed date filtering
    const filedDate = row[GRIEVANCE_COLS.DATE_FILED - 1];

    if (!filedDate) return true;

    if (fromDate && filedDate < fromDate) return false;
    if (toDate && filedDate > toDate) return false;

    return true;
  });
}

/**
 * Sorts data
 * @param {Array} data - Data array
 * @param {string} sortBy - Field to sort by
 * @param {string} sortOrder - asc or desc
 * @param {Object} fieldMapping - Field mapping
 * @returns {Array} Sorted data
 */
function sortData(data, sortBy, sortOrder, fieldMapping) {
  const field = fieldMapping[sortBy];
  if (!field) return data;

  return data.sort(function(a, b) {
    const aVal = a[field.index];
    const bVal = b[field.index];

    let comparison = 0;
    if (aVal < bVal) comparison = -1;
    if (aVal > bVal) comparison = 1;

    return sortOrder === 'desc' ? -comparison : comparison;
  });
}

/**
 * Formats value based on type
 * @param {any} value - Value to format
 * @param {string} type - Data type
 * @returns {string} Formatted value
 */
function formatValue(value, type) {
  if (!value && value !== 0) return '';

  switch (type) {
    case 'date':
      return value instanceof Date ? Utilities.formatDate(value, Session.getScriptTimeZone(), 'MM/dd/yyyy') : value;
    case 'number':
      return typeof value === 'number' ? value.toString() : value;
    default:
      return value.toString();
  }
}

/**
 * Exports report to PDF
 * @param {Object} config - Report configuration
 * @returns {File} PDF file
 */
function exportReportToPDF(config) {
  const data = generateReportData(config);

  // Create Google Doc
  const doc = DocumentApp.create(`Custom_Report_${new Date().toISOString().slice(0, 10)}`);
  const body = doc.getBody();

  // Add title
  body.appendParagraph('SEIU Local 509 - Custom Report')
    .setHeading(DocumentApp.ParagraphHeading.HEADING1)
    .setAlignment(DocumentApp.HorizontalAlignment.CENTER);

  body.appendParagraph(`Generated: ${new Date().toLocaleString()}`)
    .setAlignment(DocumentApp.HorizontalAlignment.CENTER);

  body.appendHorizontalRule();

  // Add table
  if (data.length > 0) {
    const headers = Object.keys(data[0]);
    const tableData = [headers];

    data.forEach(function(row) {
      tableData.push(Object.values(row).map(function(v) { return v.toString(); }));
    });

    const table = body.appendTable(tableData);
    table.getRow(0).editAsText().setBold(true);
  }

  doc.saveAndClose();

  // Convert to PDF
  const docFile = DriveApp.getFileById(doc.getId());
  const pdfBlob = docFile.getAs('application/pdf');
  const pdfFile = DriveApp.createFile(pdfBlob);

  // Delete temp doc
  docFile.setTrashed(true);

  return pdfFile;
}

/**
 * Exports report to CSV
 * @param {Object} config - Report configuration
 * @returns {string} CSV data
 */
function exportReportToCSV(config) {
  const data = generateReportData(config);

  if (data.length === 0) {
    return '';
  }

  const headers = Object.keys(data[0]);
  let csv = headers.join(',') + '\n';

  data.forEach(function(row) {
    const values = Object.values(row).map(function(v) {
      const str = v.toString();
      return str.includes(',') ? `"${str}"` : str;
    });
    csv += values.join(',') + '\n';
  });

  return csv;
}

/**
 * Exports report to Excel (Google Sheets)
 * @param {Object} config - Report configuration
 * @returns {File} Excel file
 */
function exportReportToExcel(config) {
  const data = generateReportData(config);

  // Create new spreadsheet
  const ss = SpreadsheetApp.create(`Custom_Report_${new Date().toISOString().slice(0, 10)}`);
  const sheet = ss.getActiveSheet();

  if (data.length > 0) {
    const headers = Object.keys(data[0]);
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    sheet.getRange(1, 1, 1, headers.length)
      .setBackground('#1a73e8')
      .setFontColor('#ffffff')
      .setFontWeight('bold');

    const rows = data.map(function(row) { return Object.values(row); });
    sheet.getRange(2, 1, rows.length, headers.length).setValues(rows);
  }

  return DriveApp.getFileById(ss.getId());
}

/**
 * Saves report template
 * @param {string} name - Template name
 * @param {Object} config - Report configuration
 */
function saveReportTemplate(name, config) {
  const props = PropertiesService.getUserProperties();
  const templates = JSON.parse(props.getProperty('reportTemplates') || '[]');

  // Remove existing template with same name
  const filtered = templates.filter(function(t) { return t.name !== name; });

  // Add new template
  filtered.push({ name: name, config: config });

  props.setProperty('reportTemplates', JSON.stringify(filtered));
}

/**
 * Gets saved report templates
 * @returns {Array} Templates
 */
function getReportTemplates() {
  const props = PropertiesService.getUserProperties();
  return JSON.parse(props.getProperty('reportTemplates') || '[]');
}



// ================================================================================
// MODULE: DarkModeThemes.gs
// Source: DarkModeThemes.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * DARK MODE & THEME CUSTOMIZATION
 * ------------------------------------------------------------------------====
 *
 * Comprehensive theming system with dark mode support
 * Features:
 * - Multiple theme presets (Light, Dark, OLED, Blue, Sepia)
 * - Custom theme builder
 * - Per-user theme preferences
 * - Automatic theme switching (time-based)
 * - Sheet-specific theming
 * - Quick theme toggle
 */

/**
 * Theme configuration
 */
THEME_CONFIG = {
  THEMES: {
    LIGHT: {
      name: 'Light',
      icon: '‚òÄÔ∏è',
      background: '#ffffff',
      headerBackground: '#1a73e8',
      headerText: '#ffffff',
      evenRow: '#f8f9fa',
      oddRow: '#ffffff',
      text: '#202124',
      border: '#dadce0',
      accent: '#1a73e8'
    },
    DARK: {
      name: 'Dark',
      icon: 'üåô',
      background: '#202124',
      headerBackground: '#35363a',
      headerText: '#e8eaed',
      evenRow: '#292a2d',
      oddRow: '#202124',
      text: '#e8eaed',
      border: '#5f6368',
      accent: '#8ab4f8'
    },
    OLED: {
      name: 'OLED Black',
      icon: 'üåë',
      background: '#000000',
      headerBackground: '#1a1a1a',
      headerText: '#ffffff',
      evenRow: '#0a0a0a',
      oddRow: '#000000',
      text: '#ffffff',
      border: '#333333',
      accent: '#bb86fc'
    },
    BLUE: {
      name: 'Ocean Blue',
      icon: 'üåä',
      background: '#e3f2fd',
      headerBackground: '#1565c0',
      headerText: '#ffffff',
      evenRow: '#bbdefb',
      oddRow: '#e3f2fd',
      text: '#0d47a1',
      border: '#90caf9',
      accent: '#1976d2'
    },
    SEPIA: {
      name: 'Sepia',
      icon: 'üìú',
      background: '#f4ecd8',
      headerBackground: '#8b7355',
      headerText: '#ffffff',
      evenRow: '#ede1c5',
      oddRow: '#f4ecd8',
      text: '#3e2723',
      border: '#bcaaa4',
      accent: '#6d4c41'
    },
    PURPLE: {
      name: '509 Purple',
      icon: 'üíú',
      background: '#ffffff',
      headerBackground: '#5B4B9E',
      headerText: '#ffffff',
      evenRow: '#E8E3F3',
      oddRow: '#ffffff',
      text: '#1F2937',
      border: '#D1D5DB',
      accent: '#6B5CA5'
    },
    GREEN: {
      name: 'Union Green',
      icon: 'üíö',
      background: '#ffffff',
      headerBackground: '#059669',
      headerText: '#ffffff',
      evenRow: '#D1FAE5',
      oddRow: '#ffffff',
      text: '#1F2937',
      border: '#D1D5DB',
      accent: '#10B981'
    },
    ORANGE: {
      name: 'Solidarity Orange',
      icon: 'üß°',
      background: '#ffffff',
      headerBackground: '#F97316',
      headerText: '#ffffff',
      evenRow: '#FFEDD5',
      oddRow: '#ffffff',
      text: '#1F2937',
      border: '#D1D5DB',
      accent: '#FB923C'
    },
    TEAL: {
      name: 'Teal Accent',
      icon: 'üíô',
      background: '#ffffff',
      headerBackground: '#14B8A6',
      headerText: '#ffffff',
      evenRow: '#CCFBF1',
      oddRow: '#ffffff',
      text: '#1F2937',
      border: '#D1D5DB',
      accent: '#2DD4BF'
    }
  },
  DEFAULT_THEME: 'LIGHT',
  AUTO_SWITCH_ENABLED: false,
  DARK_MODE_START_HOUR: 18,  // 6 PM
  DARK_MODE_END_HOUR: 7      // 7 AM
};

/**
 * Shows theme manager
 */
function showThemeManager() {
  const html = createThemeManagerHTML();
  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(900)
    .setHeight(700);

  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'üé® Theme Manager');
}

/**
 * Creates HTML for theme manager
 */
function createThemeManagerHTML() {
  const currentTheme = getCurrentTheme();
  const autoSwitch = getAutoSwitchSettings();

  let themeCards = '';
  Object.entries(THEME_CONFIG.THEMES).forEach(function([key, theme]) {
    const isActive = currentTheme === key;
    themeCards += `
      <div class="theme-card ${isActive ? 'active' : ''}" onclick="selectTheme('${key}')">
        <div class="theme-icon">${theme.icon}</div>
        <div class="theme-name">${theme.name}</div>
        <div class="theme-preview">
          <div class="preview-bar" style="background: ${theme.headerBackground};"></div>
          <div class="preview-bar" style="background: ${theme.evenRow};"></div>
          <div class="preview-bar" style="background: ${theme.oddRow};"></div>
          <div class="preview-bar" style="background: ${theme.accent};"></div>
        </div>
        ${isActive ? '<div class="active-badge">‚úì Active</div>' : ''}
      </div>
    `;
  });

  return `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-height: 650px;
      overflow-y: auto;
    }
    h2 {
      color: #1a73e8;
      margin-top: 0;
      border-bottom: 3px solid #1a73e8;
      padding-bottom: 10px;
    }
    h3 {
      color: #333;
      margin-top: 30px;
      margin-bottom: 15px;
    }
    .theme-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    .theme-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.3s ease;
      text-align: center;
      position: relative;
    }
    .theme-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .theme-card.active {
      border-color: #1a73e8;
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
    }
    .theme-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
    .theme-name {
      font-weight: bold;
      font-size: 16px;
      color: #333;
      margin-bottom: 15px;
    }
    .theme-preview {
      display: flex;
      flex-direction: column;
      gap: 3px;
      margin-top: 10px;
    }
    .preview-bar {
      height: 15px;
      border-radius: 3px;
    }
    .active-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #4caf50;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    .settings-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      border-left: 4px solid #1a73e8;
    }
    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid #e0e0e0;
    }
    .setting-row:last-child {
      border-bottom: none;
    }
    .setting-label {
      font-weight: 500;
      color: #333;
    }
    .setting-description {
      font-size: 13px;
      color: #666;
      margin-top: 4px;
    }
    button {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #1557b0;
    }
    button.secondary {
      background: #6c757d;
    }
    button.success {
      background: #4caf50;
    }
    button.danger {
      background: #f44336;
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #1a73e8;
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    .info-box {
      background: #e8f0fe;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
      border-left: 4px solid #1a73e8;
    }
    .quick-actions {
      margin: 20px 0;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üé® Theme Manager</h2>

    <div class="info-box">
      <strong>üí° Personalize Your Experience:</strong> Choose a theme that's comfortable for your eyes.
      Themes are saved to your profile and persist across sessions.
    </div>

    <h3>Available Themes</h3>
    <div class="theme-grid">
      ${themeCards}
    </div>

    <h3>Theme Settings</h3>
    <div class="settings-section">
      <div class="setting-row">
        <div>
          <div class="setting-label">Auto Dark Mode</div>
          <div class="setting-description">Automatically switch to dark mode in the evening (6 PM - 7 AM)</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="autoSwitch" ${autoSwitch.enabled ? 'checked' : ''} onchange="toggleAutoSwitch()">
          <span class="slider"></span>
        </label>
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Apply to All Sheets</div>
          <div class="setting-description">Apply theme to all sheets in the spreadsheet</div>
        </div>
        <button onclick="applyToAllSheets()">Apply to All</button>
      </div>

      <div class="setting-row">
        <div>
          <div class="setting-label">Current Sheet Only</div>
          <div class="setting-description">Apply theme only to the active sheet</div>
        </div>
        <button onclick="applyToCurrentSheet()">Apply to Current</button>
      </div>
    </div>

    <div class="quick-actions">
      <button class="success" onclick="applySelectedTheme()">‚úÖ Apply Theme</button>
      <button onclick="previewTheme()">üëÅÔ∏è Preview</button>
      <button class="secondary" onclick="resetTheme()">üîÑ Reset to Default</button>
      <button class="secondary" onclick="google.script.host.close()">Close</button>
    </div>
  </div>

  <script>
    let selectedTheme = '${currentTheme}';

    function selectTheme(themeKey) {
      selectedTheme = themeKey;
      document.querySelectorAll('.theme-card').forEach(function(card) {
        card.classList.remove('active');
      });
      event.target.closest('.theme-card').classList.add('active');
    }

    function applySelectedTheme() {
      google.script.run
        .withSuccessHandler(function() {
          alert('‚úÖ Theme applied successfully!');
          google.script.host.close();
        })
        .applyTheme(selectedTheme, 'all');
    }

    function applyToAllSheets() {
      google.script.run
        .withSuccessHandler(function() {
          alert('‚úÖ Theme applied to all sheets!');
          location.reload();
        })
        .applyTheme(selectedTheme, 'all');
    }

    function applyToCurrentSheet() {
      google.script.run
        .withSuccessHandler(function() {
          alert('‚úÖ Theme applied to current sheet!');
          location.reload();
        })
        .applyTheme(selectedTheme, 'current');
    }

    function previewTheme() {
      google.script.run
        .withSuccessHandler(function() {
          alert('üëÅÔ∏è Preview applied! This is temporary.');
        })
        .previewTheme(selectedTheme);
    }

    function resetTheme() {
      if (confirm('Reset to default light theme?')) {
        google.script.run
          .withSuccessHandler(function() {
            alert('‚úÖ Theme reset!');
            location.reload();
          })
          .resetToDefaultTheme();
      }
    }

    function toggleAutoSwitch() {
      const enabled = document.getElementById('autoSwitch').checked;
      google.script.run
        .withSuccessHandler(function() {
          alert(enabled ? '‚úÖ Auto dark mode enabled!' : 'üîï Auto dark mode disabled!');
        })
        .setAutoSwitch(enabled);
    }
  </script>
</body>
</html>
  `;
}

/**
 * Gets current theme
 * @returns {string} Theme key
 */
function getCurrentTheme() {
  const props = PropertiesService.getUserProperties();
  return props.getProperty('currentTheme') || THEME_CONFIG.DEFAULT_THEME;
}

/**
 * Gets auto-switch settings
 * @returns {Object} Settings
 */
function getAutoSwitchSettings() {
  const props = PropertiesService.getUserProperties();
  const settingsJSON = props.getProperty('autoSwitchSettings');

  if (settingsJSON) {
    return JSON.parse(settingsJSON);
  }

  return {
    enabled: false,
    darkTheme: 'DARK',
    lightTheme: 'LIGHT'
  };
}

/**
 * Applies a theme
 * @param {string} themeKey - Theme to apply
 * @param {string} scope - 'all' or 'current'
 */
function applyTheme(themeKey, scope = 'all') {
  const theme = THEME_CONFIG.THEMES[themeKey];
  if (!theme) {
    throw new Error('Invalid theme');
  }

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = scope === 'all' ? ss.getSheets() : [ss.getActiveSheet()];

  sheets.forEach(function(sheet) {
    applyThemeToSheet(sheet, theme);
  });

  // Save preference
  const props = PropertiesService.getUserProperties();
  props.setProperty('currentTheme', themeKey);

  SpreadsheetApp.getActiveSpreadsheet().toast(
    `${theme.icon} ${theme.name} theme applied!`,
    'Theme',
    3
  );
}

/**
 * Applies theme to a single sheet
 * @param {Sheet} sheet - Sheet to apply to
 * @param {Object} theme - Theme object
 */
function applyThemeToSheet(sheet, theme) {
  const lastRow = sheet.getLastRow();
  const lastCol = sheet.getLastColumn();

  if (lastRow === 0 || lastCol === 0) return;

  // Apply header styling
  const headerRange = sheet.getRange(1, 1, 1, lastCol);
  headerRange.setBackground(theme.headerBackground);
  headerRange.setFontColor(theme.headerText);
  headerRange.setFontWeight('bold');
  headerRange.setFontFamily('Roboto');

  // Apply data row styling
  if (lastRow > 1) {
    const dataRange = sheet.getRange(2, 1, lastRow - 1, lastCol);

    // Remove existing banding
    const bandings = sheet.getBandings();
    bandings.forEach(function(banding) { return banding.remove(); });

    // Apply new banding
    const banding = dataRange.applyRowBanding();
    banding.setFirstRowColor(theme.oddRow);
    banding.setSecondRowColor(theme.evenRow);
    banding.setHeaderRowColor(theme.headerBackground);

    // Set text color
    dataRange.setFontColor(theme.text);
  }

  // Set gridline color (approximate with sheet background)
  sheet.setTabColor(theme.accent);
}

/**
 * Previews a theme (temporary)
 * @param {string} themeKey - Theme to preview
 */
function previewTheme(themeKey) {
  const theme = THEME_CONFIG.THEMES[themeKey];
  if (!theme) {
    throw new Error('Invalid theme');
  }

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const activeSheet = ss.getActiveSheet();

  applyThemeToSheet(activeSheet, theme);

  SpreadsheetApp.getActiveSpreadsheet().toast(
    `üëÅÔ∏è Previewing ${theme.name} theme (not saved)`,
    'Preview',
    5
  );
}

/**
 * Resets to default theme
 */
function resetToDefaultTheme() {
  applyTheme(THEME_CONFIG.DEFAULT_THEME, 'all');

  SpreadsheetApp.getActiveSpreadsheet().toast(
    '‚úÖ Reset to default theme',
    'Theme',
    3
  );
}

/**
 * Quick toggle between light and dark
 */
function quickToggleDarkMode() {
  const currentTheme = getCurrentTheme();
  const newTheme = currentTheme === 'LIGHT' ? 'DARK' : 'LIGHT';

  applyTheme(newTheme, 'all');
}

/**
 * Sets auto-switch settings
 * @param {boolean} enabled - Enable auto-switch
 */
function setAutoSwitch(enabled) {
  const props = PropertiesService.getUserProperties();
  const settings = getAutoSwitchSettings();

  settings.enabled = enabled;
  props.setProperty('autoSwitchSettings', JSON.stringify(settings));

  if (enabled) {
    // Check and apply appropriate theme now
    checkAndApplyAutoTheme();

    SpreadsheetApp.getActiveSpreadsheet().toast(
      '‚úÖ Auto dark mode enabled (6 PM - 7 AM)',
      'Theme',
      3
    );
  } else {
    SpreadsheetApp.getActiveSpreadsheet().toast(
      'üîï Auto dark mode disabled',
      'Theme',
      3
    );
  }
}

/**
 * Checks time and applies appropriate theme
 */
function checkAndApplyAutoTheme() {
  const settings = getAutoSwitchSettings();
  if (!settings.enabled) return;

  const hour = new Date().getHours();
  const isDarkTime = hour >= THEME_CONFIG.DARK_MODE_START_HOUR || hour < THEME_CONFIG.DARK_MODE_END_HOUR;

  const targetTheme = isDarkTime ? settings.darkTheme : settings.lightTheme;
  const currentTheme = getCurrentTheme();

  if (targetTheme !== currentTheme) {
    applyTheme(targetTheme, 'all');
  }
}

/**
 * Creates a custom theme
 * @param {string} name - Theme name
 * @param {Object} colors - Color configuration
 */
function createCustomTheme(name, colors) {
  const customThemes = getCustomThemes();

  const themeKey = 'CUSTOM_' + name.toUpperCase().replace(/\s+/g, '_');

  customThemes[themeKey] = {
    name: name,
    icon: 'üé®',
    ...colors
  };

  saveCustomThemes(customThemes);

  SpreadsheetApp.getActiveSpreadsheet().toast(
    `‚úÖ Custom theme "${name}" created!`,
    'Theme',
    3
  );

  return themeKey;
}

/**
 * Gets custom themes
 * @returns {Object} Custom themes
 */
function getCustomThemes() {
  const props = PropertiesService.getScriptProperties();
  const themesJSON = props.getProperty('customThemes');

  if (themesJSON) {
    return JSON.parse(themesJSON);
  }

  return {};
}

/**
 * Saves custom themes
 * @param {Object} themes - Themes to save
 */
function saveCustomThemes(themes) {
  const props = PropertiesService.getScriptProperties();
  props.setProperty('customThemes', JSON.stringify(themes));
}

/**
 * Exports current theme as JSON
 * @returns {string} JSON theme configuration
 */
function exportCurrentTheme() {
  const currentTheme = getCurrentTheme();
  const theme = THEME_CONFIG.THEMES[currentTheme];

  return JSON.stringify(theme, null, 2);
}

/**
 * Imports theme from JSON
 * @param {string} themeJSON - JSON theme configuration
 * @param {string} name - Theme name
 * @returns {string} Theme key
 */
function importThemeFromJSON(themeJSON, name) {
  try {
    const colors = JSON.parse(themeJSON);
    return createCustomTheme(name, colors);
  } catch (error) {
    throw new Error('Invalid theme JSON: ' + error.message);
  }
}

/**
 * Installs auto-theme switching trigger
 */
function installAutoThemeTrigger() {
  // Delete existing trigger
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(function(trigger) {
    if (trigger.getHandlerFunction() === 'checkAndApplyAutoTheme') {
      ScriptApp.deleteTrigger(trigger);
    }
  });

  // Create new trigger (runs every hour)
  ScriptApp.newTrigger('checkAndApplyAutoTheme')
    .timeBased()
    .everyHours(1)
    .create();

  SpreadsheetApp.getActiveSpreadsheet().toast(
    '‚úÖ Auto-theme trigger installed',
    'Theme',
    3
  );
}



// ================================================================================
// MODULE: DataBackupRecovery.gs
// Source: DataBackupRecovery.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * DATA BACKUP & RECOVERY SYSTEM
 * ------------------------------------------------------------------------====
 *
 * Automated and manual backup/recovery capabilities
 * Features:
 * - One-click manual backups
 * - Automated weekly backups
 * - Version history tracking
 * - Point-in-time recovery
 * - Selective sheet restoration
 * - Backup verification
 * - Export to Google Drive
 * - Retention policy management
 */

/**
 * Creates a complete backup of the dashboard
 * @param {boolean} automated - Whether this is an automated backup
 * @returns {File} Backup file
 */
function createBackup(automated = false) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy-MM-dd_HH-mm-ss');
  const backupName = `509_Dashboard_Backup_${timestamp}${automated ? '_AUTO' : ''}`;

  try {
    // Create copy of entire spreadsheet
    const backupFile = DriveApp.getFileById(ss.getId()).makeCopy(backupName);

    // Move to backups folder
    const backupFolder = getOrCreateBackupFolder();
    backupFolder.addFile(backupFile);

    // Remove from root
    DriveApp.getRootFolder().removeFile(backupFile);

    // Log backup
    logBackup(backupName, backupFile.getId(), automated);

    // Clean old backups
    cleanOldBackups();

    if (!automated) {
      SpreadsheetApp.getActiveSpreadsheet().toast(
        '‚úÖ Backup created successfully: ' + backupName,
        'Backup Complete',
        5
      );
    }

    return backupFile;

  } catch (error) {
    Logger.log('Backup error: ' + error.message);
    if (!automated) {
      SpreadsheetApp.getUi().alert('‚ùå Backup failed: ' + error.message);
    }
    throw error;
  }
}

/**
 * Gets or creates backup folder in Google Drive
 * @returns {Folder} Backup folder
 */
function getOrCreateBackupFolder() {
  const folderName = '509 Dashboard - Backups';
  const folders = DriveApp.getFoldersByName(folderName);

  if (folders.hasNext()) {
    return folders.next();
  }

  return DriveApp.createFolder(folderName);
}

/**
 * Logs backup information
 * @param {string} backupName - Backup name
 * @param {string} fileId - Drive file ID
 * @param {boolean} automated - Whether automated
 */
function logBackup(backupName, fileId, automated) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let backupLog = ss.getSheetByName('üíæ Backup Log');

  if (!backupLog) {
    backupLog = createBackupLogSheet();
  }

  const timestamp = new Date();
  const user = Session.getActiveUser().getEmail() || 'System';

  const lastRow = backupLog.getLastRow();
  const newRow = [
    timestamp,
    backupName,
    fileId,
    automated ? 'Automated' : 'Manual',
    user,
    `=HYPERLINK("https://drive.google.com/file/d/${fileId}/view", "Open Backup")`
  ];

  backupLog.getRange(lastRow + 1, 1, 1, 6).setValues([newRow]);
}

/**
 * Creates backup log sheet
 * @returns {Sheet} Backup log sheet
 */
function createBackupLogSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  // Check if sheet already exists
  let sheet = ss.getSheetByName('üíæ Backup Log');
  if (sheet) {
    return sheet; // Return existing sheet
  }

  sheet = ss.insertSheet('üíæ Backup Log');

  const headers = [
    'Timestamp',
    'Backup Name',
    'File ID',
    'Type',
    'Created By',
    'Link'
  ];

  sheet.getRange(1, 1, 1, 6).setValues([headers]);

  // Format header
  sheet.getRange(1, 1, 1, 6)
    .setBackground('#1a73e8')
    .setFontColor('#ffffff')
    .setFontWeight('bold')
    .setHorizontalAlignment('center');

  // Set column widths
  sheet.setColumnWidth(1, 150);
  sheet.setColumnWidth(2, 300);
  sheet.setColumnWidth(3, 200);
  sheet.setColumnWidth(4, 100);
  sheet.setColumnWidth(5, 200);
  sheet.setColumnWidth(6, 150);

  sheet.setFrozenRows(1);

  return sheet;
}

/**
 * Cleans old backups based on retention policy
 */
function cleanOldBackups() {
  const RETENTION_DAYS = 30; // Keep backups for 30 days
  const MAX_BACKUPS = 50;    // Keep max 50 backups

  try {
    const backupFolder = getOrCreateBackupFolder();
    const files = backupFolder.getFiles();

    const backupFiles = [];

    while (files.hasNext()) {
      const file = files.next();
      backupFiles.push({
        file: file,
        created: file.getDateCreated()
      });
    }

    // Sort by date (oldest first)
    backupFiles.sort(function(a, b) { return a.created - b.created; });

    const now = new Date();
    const cutoffDate = new Date(now.getTime() - (RETENTION_DAYS * 24 * 60 * 60 * 1000));

    // Delete old backups
    backupFiles.forEach(function(backup, index) {
      // Keep if:
      // 1. Within retention period
      // 2. One of the most recent MAX_BACKUPS
      const isRecent = backup.created > cutoffDate;
      const isInMaxLimit = index >= (backupFiles.length - MAX_BACKUPS);

      if (!isRecent && !isInMaxLimit) {
        Logger.log('Deleting old backup: ' + backup.file.getName());
        backup.file.setTrashed(true);
      }
    });

  } catch (error) {
    Logger.log('Error cleaning old backups: ' + error.message);
  }
}

/**
 * Sets up automated weekly backups
 */
function setupAutomatedBackups() {
  // Delete existing triggers
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(function(trigger) {
    if (trigger.getHandlerFunction() === 'runAutomatedBackup') {
      ScriptApp.deleteTrigger(trigger);
    }
  });

  // Create weekly trigger (Sunday at 2 AM)
  ScriptApp.newTrigger('runAutomatedBackup')
    .timeBased()
    .onWeekDay(ScriptApp.WeekDay.SUNDAY)
    .atHour(2)
    .create();

  SpreadsheetApp.getActiveSpreadsheet().toast(
    '‚úÖ Automated weekly backups enabled (Sundays, 2 AM)',
    'Backup Automation',
    5
  );
}

/**
 * Disables automated backups
 */
function disableAutomatedBackups() {
  const triggers = ScriptApp.getProjectTriggers();
  let removed = 0;

  triggers.forEach(function(trigger) {
    if (trigger.getHandlerFunction() === 'runAutomatedBackup') {
      ScriptApp.deleteTrigger(trigger);
      removed++;
    }
  });

  SpreadsheetApp.getActiveSpreadsheet().toast(
    `üîï Removed ${removed} automated backup trigger(s)`,
    'Backup Automation',
    5
  );
}

/**
 * Runs automated backup (called by trigger)
 */
function runAutomatedBackup() {
  try {
    createBackup(true);
    Logger.log('Automated backup completed successfully');
  } catch (error) {
    Logger.log('Automated backup failed: ' + error.message);
    notifyAdminOfBackupFailure(error.message);
  }
}

/**
 * Notifies admin of backup failure
 * @param {string} errorMessage - Error message
 */
function notifyAdminOfBackupFailure(errorMessage) {
  const adminEmail = Session.getActiveUser().getEmail();

  MailApp.sendEmail({
    to: adminEmail,
    subject: 'üö® 509 Dashboard - Automated Backup Failed',
    body: `An automated backup failed:\n\nError: ${errorMessage}\n\nPlease check the dashboard and create a manual backup.`,
    name: 'SEIU Local 509 Dashboard'
  });
}

/**
 * Shows backup manager dialog
 */
function showBackupManager() {
  const html = createBackupManagerHTML();
  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(800)
    .setHeight(650);

  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'üíæ Backup & Recovery Manager');
}

/**
 * Creates HTML for backup manager
 */
function createBackupManagerHTML() {
  const triggers = ScriptApp.getProjectTriggers();
  const isAutomated = triggers.some(function(t) { return t.getHandlerFunction() === 'runAutomatedBackup'; });

  return `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: 'Roboto', Arial, sans-serif; padding: 20px; margin: 0; background: #f5f5f5; }
    .container { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h2 { color: #1a73e8; margin-top: 0; border-bottom: 3px solid #1a73e8; padding-bottom: 10px; }
    .section { background: #f8f9fa; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #1a73e8; }
    .section-title { font-weight: bold; font-size: 16px; color: #333; margin-bottom: 15px; }
    .status { padding: 15px; border-radius: 4px; margin: 15px 0; font-weight: bold; }
    .status.enabled { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status.disabled { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    button { background: #1a73e8; color: white; border: none; padding: 12px 24px; font-size: 14px; border-radius: 4px; cursor: pointer; margin: 10px 5px 0 0; }
    button:hover { background: #1557b0; }
    button.secondary { background: #6c757d; }
    button.secondary:hover { background: #5a6268; }
    button.danger { background: #dc3545; }
    button.danger:hover { background: #c82333; }
    .info-box { background: #e8f0fe; padding: 15px; border-radius: 4px; margin: 15px 0; border-left: 4px solid #1a73e8; }
    ul { margin: 10px 0; padding-left: 25px; }
    li { margin: 8px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h2>üíæ Backup & Recovery Manager</h2>

    <div class="info-box">
      <strong>üìã Backup Policy:</strong><br>
      ‚Ä¢ Retention: 30 days or 50 most recent backups<br>
      ‚Ä¢ Automated: Weekly (Sundays at 2 AM)<br>
      ‚Ä¢ Location: Google Drive folder "509 Dashboard - Backups"
    </div>

    <div class="section">
      <div class="section-title">‚öôÔ∏è Automated Backups</div>
      <div class="status ${isAutomated ? 'enabled' : 'disabled'}">
        ${isAutomated ? '‚úÖ Automated backups are ENABLED (Weekly, Sundays 2 AM)' : 'üîï Automated backups are DISABLED'}
      </div>
      <button onclick="google.script.run.withSuccessHandler(function() { location.reload(); }).setupAutomatedBackups()">
        ${isAutomated ? 'üîÑ Refresh Schedule' : '‚úÖ Enable Automated Backups'}
      </button>
      ${isAutomated ? '<button class="danger" onclick="google.script.run.withSuccessHandler(function() { location.reload(); }).disableAutomatedBackups()">üîï Disable</button>' : ''}
    </div>

    <div class="section">
      <div class="section-title">üì¶ Manual Backup</div>
      <p>Create an immediate backup of all data. Backups are saved to Google Drive.</p>
      <button onclick="runManualBackup()">üíæ Create Backup Now</button>
    </div>

    <div class="section">
      <div class="section-title">üîÑ Recovery Options</div>
      <p>Restore data from a previous backup:</p>
      <ul>
        <li>View all backups in Google Drive folder "509 Dashboard - Backups"</li>
        <li>Open a backup file to review data</li>
        <li>Copy sheets from backup to current dashboard to restore</li>
        <li>Or replace entire dashboard by making backup your active copy</li>
      </ul>
      <button class="secondary" onclick="openBackupFolder()">üìÅ Open Backup Folder</button>
      <button class="secondary" onclick="showBackupLog()">üìä View Backup Log</button>
    </div>

    <div class="section">
      <div class="section-title">üìä Export Options</div>
      <p>Export specific data for external storage:</p>
      <button onclick="exportGrievances()">üìã Export Grievances (CSV)</button>
      <button onclick="exportMembers()">üë• Export Members (CSV)</button>
      <button onclick="exportAll()">üì¶ Export All Data (ZIP)</button>
    </div>
  </div>

  <script>
    function runManualBackup() {
      if (!confirm('Create a backup of all dashboard data?')) return;

      alert('Creating backup... This may take a moment.');

      google.script.run
        .withSuccessHandler(function() {
          alert('‚úÖ Backup created successfully!');
        })
        .withFailureHandler(function(error) {
          alert('‚ùå Backup failed: ' + error.message);
        })
        .createBackup(false);
    }

    function openBackupFolder() {
      window.open('https://drive.google.com/', '_blank');
      alert('Look for the folder named "509 Dashboard - Backups" in your Google Drive.');
    }

    function showBackupLog() {
      google.script.run
        .withSuccessHandler(function() {
          alert('Opening Backup Log sheet...');
          google.script.host.close();
        })
        .navigateToBackupLog();
    }

    function exportGrievances() {
      alert('Exporting grievances to CSV...');
      google.script.run
        .withSuccessHandler(function(csv) {
          downloadCSV(csv, 'grievances.csv');
        })
        .exportGrievancesToCSV();
    }

    function exportMembers() {
      alert('Exporting members to CSV...');
      google.script.run
        .withSuccessHandler(function(csv) {
          downloadCSV(csv, 'members.csv');
        })
        .exportMembersToCSV();
    }

    function exportAll() {
      alert('‚ö†Ô∏è Full export feature coming soon. Use manual backup for now.');
    }

    function downloadCSV(csvData, filename) {
      const blob = new Blob([csvData], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      window.URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
  `;
}

/**
 * Navigates to backup log sheet
 */
function navigateToBackupLog() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let backupLog = ss.getSheetByName('üíæ Backup Log');

  if (!backupLog) {
    backupLog = createBackupLogSheet();
  }

  backupLog.activate();
}

/**
 * Exports grievances to CSV
 * @returns {string} CSV data
 */
function exportGrievancesToCSV() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  const lastRow = sheet.getLastRow();
  const lastCol = sheet.getLastColumn();

  const data = sheet.getRange(1, 1, lastRow, lastCol).getValues();

  let csv = '';
  data.forEach(function(row) {
    const values = row.map(function(v) {
      const str = v.toString();
      return str.includes(',') || str.includes('"') ? `"${str.replace(/"/g, '""')}"` : str;
    });
    csv += values.join(',') + '\n';
  });

  return csv;
}

/**
 * Exports members to CSV
 * @returns {string} CSV data
 */
function exportMembersToCSV() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

  const lastRow = sheet.getLastRow();
  const lastCol = sheet.getLastColumn();

  const data = sheet.getRange(1, 1, lastRow, lastCol).getValues();

  let csv = '';
  data.forEach(function(row) {
    const values = row.map(function(v) {
      const str = v.toString();
      return str.includes(',') || str.includes('"') ? `"${str.replace(/"/g, '""')}"` : str;
    });
    csv += values.join(',') + '\n';
  });

  return csv;
}

/**
 * Verifies backup integrity
 * @param {string} backupFileId - Backup file ID
 * @returns {Object} Verification result
 */
function verifyBackup(backupFileId) {
  try {
    const backupFile = DriveApp.getFileById(backupFileId);
    const backupSS = SpreadsheetApp.open(backupFile);

    const sheets = backupSS.getSheets();

    const verification = {
      valid: true,
      sheetCount: sheets.length,
      sheets: sheets.map(function(s) { return s.getName(); }),
      dataRows: {}
    };

    // Check key sheets
    const keySheets = [SHEETS.GRIEVANCE_LOG, SHEETS.MEMBER_DIR];
    keySheets.forEach(function(sheetName) {
      const sheet = backupSS.getSheetByName(sheetName);
      if (sheet) {
        verification.dataRows[sheetName] = sheet.getLastRow() - 1; // Minus header
      } else {
        verification.valid = false;
        verification.error = `Missing key sheet: ${sheetName}`;
      }
    });

    return verification;

  } catch (error) {
    return {
      valid: false,
      error: error.message
    };
  }
}



// ================================================================================
// MODULE: DataCachingLayer.gs
// Source: DataCachingLayer.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * DATA CACHING LAYER
 * ------------------------------------------------------------------------====
 *
 * Performance optimization through intelligent caching
 * Features:
 * - In-memory cache for frequently accessed data
 * - Script properties cache for persistent storage
 * - Cache invalidation strategies
 * - Automatic cache warming
 * - Performance monitoring
 * - Configurable TTL (time-to-live)
 *
 * Configuration: Uses CACHE_CONFIG and CACHE_KEYS from Constants.gs
 * @see Constants.gs for configuration
 */

/**
 * Gets data from cache or loads from source
 * @param {string} key - Cache key
 * @param {Function} loader - Function to load data if cache miss
 * @param {number} ttl - Time to live in seconds
 * @returns {any} Cached or freshly loaded data
 */
function getCachedData(key, loader, ttl = CACHE_CONFIG.MEMORY_TTL) {
  try {
    // Try memory cache first (fastest)
    const memoryCache = CacheService.getScriptCache();
    const memoryCached = memoryCache.get(key);

    if (memoryCached) {
      logCacheHit('MEMORY', key);
      return JSON.parse(memoryCached);
    }

    // Try script properties (persistent)
    const propsCache = PropertiesService.getScriptProperties();
    const propsCached = propsCache.getProperty(key);

    if (propsCached) {
      const cachedObj = JSON.parse(propsCached);

      // Check if expired
      if (cachedObj.timestamp && (Date.now() - cachedObj.timestamp) < (ttl * 1000)) {
        logCacheHit('PROPERTIES', key);

        // Warm memory cache
        memoryCache.put(key, JSON.stringify(cachedObj.data), ttl);

        return cachedObj.data;
      }
    }

    // Cache miss - load from source
    logCacheMiss(key);
    const data = loader();

    // Store in both caches
    setCachedData(key, data, ttl);

    return data;

  } catch (error) {
    Logger.log(`Cache error for key ${key}: ${error.message}`);
    // Fallback to direct load
    return loader();
  }
}

/**
 * Sets data in cache
 * @param {string} key - Cache key
 * @param {any} data - Data to cache
 * @param {number} ttl - Time to live in seconds
 */
function setCachedData(key, data, ttl = CACHE_CONFIG.MEMORY_TTL) {
  try {
    const dataStr = JSON.stringify(data);
    const sizeInBytes = dataStr.length;
    const MAX_PROPERTY_SIZE = 400000; // 400KB limit (conservative, actual limit is 500KB)

    // Store in memory cache
    const memoryCache = CacheService.getScriptCache();
    memoryCache.put(key, dataStr, Math.min(ttl, 21600)); // Max 6 hours for memory

    // Only store in properties cache if size is within limits
    if (sizeInBytes < MAX_PROPERTY_SIZE) {
      const propsCache = PropertiesService.getScriptProperties();
      const cachedObj = {
        data: data,
        timestamp: Date.now()
      };
      propsCache.setProperty(key, JSON.stringify(cachedObj));
    } else {
      Logger.log(`Skipping properties cache for key ${key}: size ${sizeInBytes} bytes exceeds limit`);
    }

    logCacheSet(key);

  } catch (error) {
    Logger.log(`Error setting cache for key ${key}: ${error.message}`);
    // Silently fail - cache is optional
  }
}

/**
 * Invalidates cache for a specific key
 * @param {string} key - Cache key to invalidate
 */
function invalidateCache(key) {
  try {
    CacheService.getScriptCache().remove(key);
    PropertiesService.getScriptProperties().deleteProperty(key);
    Logger.log(`Cache invalidated: ${key}`);
  } catch (error) {
    Logger.log(`Error invalidating cache for key ${key}: ${error.message}`);
  }
}

/**
 * Invalidates all caches
 */
function invalidateAllCaches() {
  try {
    CacheService.getScriptCache().removeAll(Object.values(CACHE_KEYS));

    const propsCache = PropertiesService.getScriptProperties();
    Object.values(CACHE_KEYS).forEach(function(key) {
      propsCache.deleteProperty(key);
    });

    Logger.log('All caches invalidated');

    SpreadsheetApp.getActiveSpreadsheet().toast(
      '‚úÖ All caches cleared',
      'Cache Management',
      3
    );

  } catch (error) {
    Logger.log(`Error invalidating all caches: ${error.message}`);
  }
}

/**
 * Warms up caches with frequently accessed data
 */
function warmUpCaches() {
  SpreadsheetApp.getActiveSpreadsheet().toast(
    'üî• Warming up caches...',
    'Cache Management',
    -1
  );

  try {
    // Warm up key data
    getCachedGrievances();
    getCachedMembers();
    getCachedStewards();
    getCachedDashboardMetrics();

    Logger.log('Caches warmed up successfully');

    SpreadsheetApp.getActiveSpreadsheet().toast(
      '‚úÖ Caches warmed up',
      'Cache Management',
      3
    );

  } catch (error) {
    Logger.log(`Error warming up caches: ${error.message}`);
  }
}

/**
 * Gets all grievances (cached)
 * @returns {Array} Grievances array
 */
function getCachedGrievances() {
  return getCachedData(
    CACHE_KEYS.ALL_GRIEVANCES,
    function() {
      const ss = SpreadsheetApp.getActiveSpreadsheet();
      const sheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
      const lastRow = sheet.getLastRow();

      if (lastRow < 2) return [];

      return sheet.getRange(2, 1, lastRow - 1, 28).getValues();
    },
    300 // 5 minutes
  );
}

/**
 * Gets all members (cached)
 * @returns {Array} Members array
 */
function getCachedMembers() {
  return getCachedData(
    CACHE_KEYS.ALL_MEMBERS,
    function() {
      const ss = SpreadsheetApp.getActiveSpreadsheet();
      const sheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
      const lastRow = sheet.getLastRow();

      if (lastRow < 2) return [];

      return sheet.getRange(2, 1, lastRow - 1, 28).getValues();
    },
    600 // 10 minutes
  );
}

/**
 * Gets all stewards (cached)
 * @returns {Array} Stewards array
 */
function getCachedStewards() {
  return getCachedData(
    CACHE_KEYS.ALL_STEWARDS,
    function() {
      const members = getCachedMembers();
      return members.filter(function(row) { return row[MEMBER_COLS.IS_STEWARD - 1] === 'Yes'; }); // Column J: Is Steward?
    },
    600 // 10 minutes
  );
}

/**
 * Gets dashboard metrics (cached)
 * @returns {Object} Dashboard metrics
 */
function getCachedDashboardMetrics() {
  return getCachedData(
    CACHE_KEYS.DASHBOARD_METRICS,
    function() {
      const grievances = getCachedGrievances();

      const metrics = {
        total: grievances.length,
        open: 0,
        closed: 0,
        overdue: 0,
        byStatus: {},
        byIssueType: {},
        bySteward: {}
      };

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      grievances.forEach(function(row) {
        const status = row[GRIEVANCE_COLS.STATUS - 1];
        const issueType = row[GRIEVANCE_COLS.ISSUE_CATEGORY - 1];
        const steward = row[GRIEVANCE_COLS.STEWARD - 1];
        const nextActionDue = row[GRIEVANCE_COLS.NEXT_ACTION_DUE - 1];
        const daysToDeadline = nextActionDue ? Math.floor((new Date(nextActionDue) - today) / (1000 * 60 * 60 * 24)) : null;

        if (status === 'Open') metrics.open++;
        if (status === 'Closed' || status === 'Resolved') metrics.closed++;
        if (daysToDeadline !== null && daysToDeadline < 0) metrics.overdue++;

        metrics.byStatus[status] = (metrics.byStatus[status] || 0) + 1;

        if (issueType) {
          metrics.byIssueType[issueType] = (metrics.byIssueType[issueType] || 0) + 1;
        }

        if (steward) {
          metrics.bySteward[steward] = (metrics.bySteward[steward] || 0) + 1;
        }
      });

      return metrics;
    },
    180 // 3 minutes
  );
}

/**
 * Logs cache hit
 * @param {string} source - Cache source (MEMORY/PROPERTIES)
 * @param {string} key - Cache key
 */
function logCacheHit(source, key) {
  if (CACHE_CONFIG.ENABLE_LOGGING) {
    Logger.log(`[CACHE HIT] ${source}: ${key}`);
  }
}

/**
 * Logs cache miss
 * @param {string} key - Cache key
 */
function logCacheMiss(key) {
  if (CACHE_CONFIG.ENABLE_LOGGING) {
    Logger.log(`[CACHE MISS] ${key}`);
  }
}

/**
 * Logs cache set
 * @param {string} key - Cache key
 */
function logCacheSet(key) {
  if (CACHE_CONFIG.ENABLE_LOGGING) {
    Logger.log(`[CACHE SET] ${key}`);
  }
}

/**
 * Shows cache status dashboard
 */
function showCacheStatusDashboard() {
  const memoryCache = CacheService.getScriptCache();
  const propsCache = PropertiesService.getScriptProperties();

  const cacheStatus = [];

  Object.entries(CACHE_KEYS).forEach(function([name, key]) {
    const inMemory = memoryCache.get(key) !== null;
    const inProps = propsCache.getProperty(key) !== null;

    let age = 'N/A';
    if (inProps) {
      const cached = JSON.parse(propsCache.getProperty(key));
      if (cached.timestamp) {
        age = Math.floor((Date.now() - cached.timestamp) / 1000) + 's';
      }
    }

    cacheStatus.push({
      name: name,
      key: key,
      inMemory: inMemory,
      inProps: inProps,
      age: age
    });
  });

  const statusRows = cacheStatus
    .map(function(s) { return `
      <tr>
        <td>${s.name}</td>
        <td>${s.inMemory ? '‚úÖ Yes' : '‚ùå No'}</td>
        <td>${s.inProps ? '‚úÖ Yes' : '‚ùå No'}</td>
        <td>${s.age}</td>
      </tr>
    `; })
    .join('');

  const html = `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: 'Roboto', Arial, sans-serif; padding: 20px; margin: 0; background: #f5f5f5; }
    .container { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h2 { color: #1a73e8; margin-top: 0; border-bottom: 3px solid #1a73e8; padding-bottom: 10px; }
    .info-box { background: #e8f0fe; padding: 15px; border-radius: 4px; margin: 15px 0; border-left: 4px solid #1a73e8; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th { background: #1a73e8; color: white; padding: 12px; text-align: left; }
    td { padding: 10px 12px; border-bottom: 1px solid #e0e0e0; }
    tr:hover { background: #f5f5f5; }
    button { background: #1a73e8; color: white; border: none; padding: 12px 24px; font-size: 14px; border-radius: 4px; cursor: pointer; margin: 10px 5px 0 0; }
    button:hover { background: #1557b0; }
    button.danger { background: #dc3545; }
    button.danger:hover { background: #c82333; }
  </style>
</head>
<body>
  <div class="container">
    <h2>üóÑÔ∏è Cache Status Dashboard</h2>

    <div class="info-box">
      <strong>‚ÑπÔ∏è Cache Information:</strong><br>
      ‚Ä¢ <strong>Memory Cache:</strong> Fast, in-memory storage (5-minute TTL, max 6 hours)<br>
      ‚Ä¢ <strong>Properties Cache:</strong> Persistent storage across sessions (1-hour TTL)<br>
      ‚Ä¢ Caches automatically refresh when data is modified
    </div>

    <h3>Cache Status</h3>
    <table>
      <thead>
        <tr>
          <th>Cache Name</th>
          <th>In Memory</th>
          <th>In Properties</th>
          <th>Age</th>
        </tr>
      </thead>
      <tbody>
        ${statusRows}
      </tbody>
    </table>

    <button onclick="google.script.run.withSuccessHandler(function() { location.reload(); }).warmUpCaches()">
      üî• Warm Up All Caches
    </button>

    <button class="danger" onclick="google.script.run.withSuccessHandler(function() { location.reload(); }).invalidateAllCaches()">
      üóëÔ∏è Clear All Caches
    </button>
  </div>
</body>
</html>
  `;

  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(700)
    .setHeight(550);

  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'üóÑÔ∏è Cache Status');
}

/**
 * Auto-invalidates cache when data is modified (onEdit trigger helper)
 * Call this from the main onEdit function
 */
function onEditCacheInvalidation(e) {
  if (!e) return;

  const sheetName = e.range.getSheet().getName();

  // Invalidate relevant caches based on sheet
  if (sheetName === SHEETS.GRIEVANCE_LOG) {
    invalidateCache(CACHE_KEYS.ALL_GRIEVANCES);
    invalidateCache(CACHE_KEYS.DASHBOARD_METRICS);
    invalidateCache(CACHE_KEYS.STEWARD_WORKLOAD);
  } else if (sheetName === SHEETS.MEMBER_DIR) {
    invalidateCache(CACHE_KEYS.ALL_MEMBERS);
    invalidateCache(CACHE_KEYS.ALL_STEWARDS);
  }
}

/**
 * Gets performance statistics
 * @returns {Object} Performance stats
 */
function getCachePerformanceStats() {
  // This would track cache hits/misses over time
  // For now, return basic info
  const memoryCache = CacheService.getScriptCache();
  const propsCache = PropertiesService.getScriptProperties();

  let cachedKeys = 0;
  Object.values(CACHE_KEYS).forEach(function(key) {
    if (propsCache.getProperty(key) !== null) {
      cachedKeys++;
    }
  });

  return {
    totalKeys: Object.keys(CACHE_KEYS).length,
    cachedKeys: cachedKeys,
    cacheHitRate: cachedKeys / Object.keys(CACHE_KEYS).length,
    memoryTTL: CACHE_CONFIG.MEMORY_TTL,
    propertiesTTL: CACHE_CONFIG.PROPERTIES_TTL
  };
}



// ================================================================================
// MODULE: DataIntegrityEnhancements.gs
// Source: DataIntegrityEnhancements.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * DATA INTEGRITY ENHANCEMENTS
 * ------------------------------------------------------------------------====
 *
 * Enhancements for data quality and integrity:
 * - Duplicate ID detection
 * - Change tracking and audit log
 * - Data quality monitoring
 */

/**
 * Checks if a Member ID already exists before adding
 * @param {string} memberId - The member ID to check
 * @returns {boolean} True if ID is duplicate, false if unique
 */
function checkDuplicateMemberID(memberId) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (!memberSheet || !memberId) return false;

  const lastRow = memberSheet.getLastRow();
  if (lastRow < 2) return false;

  const existingIds = memberSheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();
  return existingIds.includes(memberId);
}

/**
 * Checks if a Grievance ID already exists before adding
 * @param {string} grievanceId - The grievance ID to check
 * @returns {boolean} True if ID is duplicate, false if unique
 */
function checkDuplicateGrievanceID(grievanceId) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!grievanceSheet || !grievanceId) return false;

  const lastRow = grievanceSheet.getLastRow();
  if (lastRow < 2) return false;

  const existingIds = grievanceSheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();
  return existingIds.includes(grievanceId);
}

/**
 * Generates next available Member ID
 * @returns {string} Next available ID in format M000001
 */
function generateNextMemberID() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (!memberSheet) return 'M000001';

  const lastRow = memberSheet.getLastRow();
  if (lastRow < 2) return 'M000001';

  const existingIds = memberSheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();

  // Extract numbers and find max
  const numbers = existingIds
    .filter(function(id) { return id && id.toString().startsWith('M'); })
    .map(function(id) { return parseInt(id.toString().substring(1)); })
    .filter(function(num) { return !isNaN(num); });

  const maxNumber = numbers.length > 0 ? Math.max(...numbers) : 0;
  const nextNumber = maxNumber + 1;

  return 'M' + nextNumber.toString().padStart(6, '0');
}

/**
 * Generates next available Grievance ID
 * @returns {string} Next available ID in format G-000001-A
 */
function generateNextGrievanceID() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!grievanceSheet) return 'G-000001-A';

  const lastRow = grievanceSheet.getLastRow();
  if (lastRow < 2) return 'G-000001-A';

  const existingIds = grievanceSheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();

  let counter = 1;
  let letter = 'A';
  let newId;

  do {
    newId = `G-${String(counter).padStart(6, '0')}-${letter}`;

    if (!existingIds.includes(newId)) {
      break;
    }

    // Increment letter
    if (letter === 'Z') {
      letter = 'A';
      counter++;
    } else {
      letter = String.fromCharCode(letter.charCodeAt(0) + 1);
    }
  } while (existingIds.includes(newId));

  return newId;
}

/**
 * Shows dialog when duplicate Member ID is detected
 * @param {string} memberId - The duplicate ID
 */
function showDuplicateMemberIDWarning(memberId) {
  const ui = SpreadsheetApp.getUi();
  const nextId = generateNextMemberID();

  const response = ui.alert(
    '‚ö†Ô∏è Duplicate Member ID Detected',
    `The Member ID "${memberId}" already exists in the system.\n\n` +
    `Next available ID: ${nextId}\n\n` +
    'Would you like to use the next available ID instead?',
    ui.ButtonSet.YES_NO
  );

  if (response === ui.Button.YES) {
    return nextId;
  }

  return null;
}

/**
 * Shows dialog when duplicate Grievance ID is detected
 * @param {string} grievanceId - The duplicate ID
 */
function showDuplicateGrievanceIDWarning(grievanceId) {
  const ui = SpreadsheetApp.getUi();
  const nextId = generateNextGrievanceID();

  const response = ui.alert(
    '‚ö†Ô∏è Duplicate Grievance ID Detected',
    `The Grievance ID "${grievanceId}" already exists in the system.\n\n` +
    `Next available ID: ${nextId}\n\n` +
    'Would you like to use the next available ID instead?',
    ui.ButtonSet.YES_NO
  );

  if (response === ui.Button.YES) {
    return nextId;
  }

  return null;
}

/**
 * Creates a Change Log sheet to track all data modifications
 */
function createChangeLogSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let changeLog = ss.getSheetByName('üìù Change Log');

  if (!changeLog) {
    changeLog = ss.insertSheet('üìù Change Log');
  } else {
    return; // Already exists
  }

  // Header
  changeLog.getRange("A1:H1").merge()
    .setValue("üìù CHANGE LOG - Audit Trail")
    .setFontSize(16)
    .setFontWeight("bold")
    .setHorizontalAlignment("center")
    .setBackground(COLORS.PRIMARY_PURPLE)
    .setFontColor("white");

  const headers = [
    "Timestamp",
    "User Email",
    "Sheet",
    "Row",
    "Column",
    "Field Name",
    "Old Value",
    "New Value"
  ];

  changeLog.getRange(3, 1, 1, headers.length).setValues([headers])
    .setFontWeight("bold")
    .setBackground(COLORS.LIGHT_GRAY);

  changeLog.setFrozenRows(3);
  changeLog.setTabColor(COLORS.ACCENT_PURPLE);

  // Set column widths
  changeLog.setColumnWidth(1, 150); // Timestamp
  changeLog.setColumnWidth(2, 200); // User
  changeLog.setColumnWidth(3, 150); // Sheet
  changeLog.setColumnWidth(4, 60);  // Row
  changeLog.setColumnWidth(5, 60);  // Column
  changeLog.setColumnWidth(6, 150); // Field Name
  changeLog.setColumnWidth(7, 200); // Old Value
  changeLog.setColumnWidth(8, 200); // New Value

  SpreadsheetApp.getUi().alert(
    '‚úÖ Change Log Created',
    'The Change Log sheet has been created.\n\n' +
    'To enable automatic change tracking, you need to:\n' +
    '1. Go to Extensions ‚Üí Apps Script\n' +
    '2. Click on Triggers (clock icon)\n' +
    '3. Add trigger: onEdit ‚Üí From spreadsheet ‚Üí On edit\n\n' +
    'This will track all changes made to Member Directory and Grievance Log.',
    SpreadsheetApp.getUi().ButtonSet.OK
  );
}

/**
 * Logs a change to the Change Log sheet
 * @param {object} e - The edit event object
 */
function onEdit(e) {
  if (!e) return;

  const ss = e.source;
  const sheet = e.range.getSheet();
  const sheetName = sheet.getName();

  // Handle Start Grievance checkbox in Member Directory
  if (sheetName === SHEETS.MEMBER_DIR) {
    const row = e.range.getRow();
    const col = e.range.getColumn();

    // Check if Start Grievance checkbox was clicked (column 32/AF)
    if (col === MEMBER_COLS.START_GRIEVANCE && row > 1 && e.value === true) {
      // Reset checkbox immediately to allow re-use
      e.range.setValue(false);

      // Open grievance form with prepopulated member data
      openGrievanceFormForMember(row);
      return;
    }
  }

  // Only track changes to core data sheets
  if (sheetName !== SHEETS.MEMBER_DIR && sheetName !== SHEETS.GRIEVANCE_LOG) {
    return;
  }

  const changeLog = ss.getSheetByName('üìù Change Log');
  if (!changeLog) return; // Change log not created yet

  try {
    const timestamp = new Date();
    const userEmail = Session.getActiveUser().getEmail() || 'Unknown';
    const row = e.range.getRow();
    const col = e.range.getColumn();
    const fieldName = sheet.getRange(1, col).getValue(); // Get header name
    const oldValue = e.oldValue || '';
    const newValue = e.value || '';

    // Skip header row changes
    if (row === 1) return;

    // Only log if value actually changed
    if (oldValue === newValue) return;

    // Add to change log
    const lastRow = changeLog.getLastRow();
    const logRow = [
      timestamp,
      userEmail,
      sheetName,
      row,
      col,
      fieldName,
      oldValue,
      newValue
    ];

    changeLog.getRange(lastRow + 1, 1, 1, 8).setValues([logRow]);

  } catch (error) {
    Logger.log('Error in change tracking: ' + error.message);
    // Don't show error to user to avoid interrupting workflow
  }
}

/**
 * Shows data quality dashboard
 */
function showDataQualityDashboard() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!memberSheet || !grievanceSheet) {
    SpreadsheetApp.getUi().alert('Data sheets not found!');
    return;
  }

  // Calculate data quality metrics
  const memberLastRow = memberSheet.getLastRow() - 1;
  const grievanceLastRow = grievanceSheet.getLastRow() - 1;

  // Check email completeness (Column H in Member Directory)
  const emailData = memberSheet.getRange(2, 8, memberLastRow, 1).getValues().flat();
  const emailsComplete = emailData.filter(function(email) { return email && email.toString().trim() !== ''; }).length;
  const emailCompleteness = memberLastRow > 0 ? ((emailsComplete / memberLastRow) * 100).toFixed(1) : 0;

  // Check phone completeness (Column I in Member Directory)
  const phoneData = memberSheet.getRange(2, 9, memberLastRow, 1).getValues().flat();
  const phonesComplete = phoneData.filter(function(phone) { return phone && phone.toString().trim() !== ''; }).length;
  const phoneCompleteness = memberLastRow > 0 ? ((phonesComplete / memberLastRow) * 100).toFixed(1) : 0;

  // Check steward assignment in grievances (Column AA)
  const stewardData = grievanceSheet.getRange(2, 27, grievanceLastRow, 1).getValues().flat();
  const stewardsAssigned = stewardData.filter(function(s) { return s && s.toString().trim() !== ''; }).length;
  const stewardCompleteness = grievanceLastRow > 0 ? ((stewardsAssigned / grievanceLastRow) * 100).toFixed(1) : 0;

  // Overall quality score (average of all metrics)
  const qualityScore = ((parseFloat(emailCompleteness) + parseFloat(phoneCompleteness) + parseFloat(stewardCompleteness)) / 3).toFixed(1);

  // Show dashboard
  SpreadsheetApp.getUi().alert(
    'üìä Data Quality Dashboard',
    `Overall Quality Score: ${qualityScore}%\n\n` +
    '=== Member Directory ===\n' +
    `Total Members: ${memberLastRow}\n` +
    `Email Addresses: ${emailCompleteness}% complete (${emailsComplete}/${memberLastRow})\n` +
    `Phone Numbers: ${phoneCompleteness}% complete (${phonesComplete}/${memberLastRow})\n\n` +
    '=== Grievance Log ===\n' +
    `Total Grievances: ${grievanceLastRow}\n` +
    `Steward Assignments: ${stewardCompleteness}% complete (${stewardsAssigned}/${grievanceLastRow})\n\n` +
    `${qualityScore >= 90 ? 'üü¢ Excellent!' : qualityScore >= 75 ? 'üü° Good' : 'üî¥ Needs Improvement'}`,
    SpreadsheetApp.getUi().ButtonSet.OK
  );
}

/**
 * Validates referential integrity (Member IDs in grievances exist in Member Directory)
 */
function checkReferentialIntegrity() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!memberSheet || !grievanceSheet) {
    SpreadsheetApp.getUi().alert('Data sheets not found!');
    return;
  }

  SpreadsheetApp.getActiveSpreadsheet().toast('üîç Checking referential integrity...', 'Please wait', -1);

  // Get all member IDs
  const memberLastRow = memberSheet.getLastRow();
  const memberIds = memberSheet.getRange(2, 1, memberLastRow - 1, 1).getValues().flat();

  // Get all member IDs from grievances
  const grievanceLastRow = grievanceSheet.getLastRow();
  const grievanceMemberIds = grievanceSheet.getRange(2, 2, grievanceLastRow - 1, 1).getValues();

  // Find orphaned grievances (member ID doesn't exist)
  const orphaned = [];
  for (let i = 0; i < grievanceMemberIds.length; i++) {
    const memberId = grievanceMemberIds[i][0];
    if (memberId && !memberIds.includes(memberId)) {
      const grievanceId = grievanceSheet.getRange(i + 2, 1).getValue();
      orphaned.push({ row: i + 2, grievanceId, memberId });
    }
  }

  // Show results
  if (orphaned.length === 0) {
    SpreadsheetApp.getUi().alert(
      '‚úÖ Referential Integrity Check Passed',
      'All grievances have valid member IDs.\n\n' +
      `Checked ${grievanceLastRow - 1} grievances against ${memberLastRow - 1} members.`,
      SpreadsheetApp.getUi().ButtonSet.OK
    );
  } else {
    const orphanedList = orphaned.slice(0, 10).map(function(o) {
      return `  Row ${o.row}: ${o.grievanceId} (Member ID: ${o.memberId})`;
    }).join('\n');

    SpreadsheetApp.getUi().alert(
      '‚ö†Ô∏è Referential Integrity Issues Found',
      `Found ${orphaned.length} grievance(s) with invalid member IDs:\n\n` +
      orphanedList +
      (orphaned.length > 10 ? `\n\n  ... and ${orphaned.length - 10} more` : '') +
      '\n\nThese grievances reference members that don\'t exist in the Member Directory.',
      SpreadsheetApp.getUi().ButtonSet.OK
    );
  }
}


/**
 * Shows next available Member ID dialog
 */
function showNextMemberID() {
  const nextId = generateNextMemberID();
  SpreadsheetApp.getUi().alert(
    "üÜî Next Available Member ID",
    `Next Member ID: ${nextId}\n\n` +
    "Use this ID when adding a new member to avoid duplicates.",
    SpreadsheetApp.getUi().ButtonSet.OK
  );
}

/**
 * Shows next available Grievance ID dialog
 */
function showNextGrievanceID() {
  const nextId = generateNextGrievanceID();
  SpreadsheetApp.getUi().alert(
    "üÜî Next Available Grievance ID",
    `Next Grievance ID: ${nextId}\n\n` +
    "Use this ID when creating a new grievance to avoid duplicates.",
    SpreadsheetApp.getUi().ButtonSet.OK
  );
}




// ================================================================================
// MODULE: DataPagination.gs
// Source: DataPagination.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * DATA PAGINATION & VIRTUAL SCROLLING
 * ------------------------------------------------------------------------====
 *
 * Advanced pagination system for handling large datasets efficiently
 * Features:
 * - Page-based navigation
 * - Configurable page sizes
 * - Quick jump to page
 * - Virtual scrolling for large datasets
 * - Search within pages
 * - Export current page
 * - Performance optimizations
 */

/**
 * Pagination configuration
 */
PAGINATION_CONFIG = {
  DEFAULT_PAGE_SIZE: 100,
  PAGE_SIZE_OPTIONS: [25, 50, 100, 200, 500],
  MAX_CACHED_PAGES: 10,
  ENABLE_VIRTUAL_SCROLL: true
};

/**
 * Shows paginated data viewer
 */
function showPaginatedViewer() {
  const html = createPaginatedViewerHTML();
  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(1200)
    .setHeight(800);

  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'üìÑ Paginated Data Viewer');
}

/**
 * Creates HTML for paginated viewer
 */
function createPaginatedViewerHTML() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  const totalRows = grievanceSheet.getLastRow() - 1;  // Exclude header

  const pageSize = PAGINATION_CONFIG.DEFAULT_PAGE_SIZE;
  const totalPages = Math.ceil(totalRows / pageSize);

  return `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-height: 750px;
      display: flex;
      flex-direction: column;
    }
    h2 {
      color: #1a73e8;
      margin-top: 0;
      border-bottom: 3px solid #1a73e8;
      padding-bottom: 10px;
    }
    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      flex-wrap: wrap;
      gap: 15px;
    }
    .control-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .stats {
      display: flex;
      gap: 20px;
      padding: 15px;
      background: #e8f0fe;
      border-radius: 8px;
      margin: 10px 0;
    }
    .stat-item {
      display: flex;
      flex-direction: column;
    }
    .stat-label {
      font-size: 12px;
      color: #666;
    }
    .stat-value {
      font-size: 20px;
      font-weight: bold;
      color: #1a73e8;
    }
    .data-table-container {
      flex: 1;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      margin: 10px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th {
      background: #1a73e8;
      color: white;
      padding: 12px 8px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    td {
      padding: 10px 8px;
      border-bottom: 1px solid #e0e0e0;
    }
    tr:hover {
      background: #f8f9fa;
    }
    tr:nth-child(even) {
      background: #fafafa;
    }
    tr:nth-child(even):hover {
      background: #f0f0f0;
    }
    button {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover:not(:disabled) {
      background: #1557b0;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    button.secondary {
      background: #6c757d;
    }
    button.secondary:hover:not(:disabled) {
      background: #5a6268;
    }
    select, input[type="number"], input[type="text"] {
      padding: 8px 12px;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .pagination {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .page-button {
      min-width: 40px;
      padding: 8px 12px;
    }
    .page-button.active {
      background: #4caf50;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #1a73e8;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .search-box {
      padding: 8px 12px;
      border: 2px solid #ddd;
      border-radius: 4px;
      width: 300px;
    }
    .no-data {
      text-align: center;
      padding: 60px;
      color: #999;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìÑ Paginated Data Viewer</h2>

    <div class="stats">
      <div class="stat-item">
        <div class="stat-label">Total Records</div>
        <div class="stat-value" id="totalRecords">${totalRows}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Total Pages</div>
        <div class="stat-value" id="totalPages">${totalPages}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Current Page</div>
        <div class="stat-value" id="currentPage">1</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Records/Page</div>
        <div class="stat-value" id="pageSize">${pageSize}</div>
      </div>
    </div>

    <div class="controls">
      <div class="control-group">
        <label>Page Size:</label>
        <select id="pageSizeSelect" onchange="changePageSize()">
          ${PAGINATION_CONFIG.PAGE_SIZE_OPTIONS.map(size =>
            `<option value="${size}" ${size === pageSize ? 'selected' : ''}>${size}</option>`
          ).join('')}
        </select>
      </div>

      <div class="control-group">
        <label>Search:</label>
        <input type="text" class="search-box" id="searchBox" placeholder="Search in current data..." oninput="searchData()">
      </div>

      <div class="control-group">
        <button onclick="exportCurrentPage()">üì• Export Page</button>
        <button class="secondary" onclick="refreshData()">üîÑ Refresh</button>
      </div>
    </div>

    <div class="data-table-container" id="tableContainer">
      <div class="loading">
        <div class="spinner"></div>
        <div>Loading data...</div>
      </div>
    </div>

    <div class="pagination" id="pagination">
      <!-- Pagination buttons will be inserted here -->
    </div>
  </div>

  <script>
    let currentPage = 1;
    let pageSize = ${pageSize};
    const totalRecords = ${totalRows};
    let totalPages = ${totalPages};
    let currentData = [];
    let allHeaders = [];

    // Load initial page
    loadPage(1);

    function loadPage(page) {
      currentPage = page;
      document.getElementById('currentPage').textContent = page;

      const startRow = (page - 1) * pageSize + 2;  // +2 for header and 0-index
      const numRows = Math.min(pageSize, totalRecords - (page - 1) * pageSize);

      document.getElementById('tableContainer').innerHTML = '<div class="loading"><div class="spinner"></div><div>Loading page ' + page + '...</div></div>';

      google.script.run
        .withSuccessHandler(renderTable)
        .withFailureHandler(handleError)
        .getPageData(startRow, numRows);
    }

    function renderTable(data) {
      if (!data || !data.headers || !data.rows) {
        document.getElementById('tableContainer').innerHTML = '<div class="no-data">No data available</div>';
        return;
      }

      allHeaders = data.headers;
      currentData = data.rows;

      let html = '<table><thead><tr>';

      // Headers
      data.headers.forEach(function(header) {
        html += '<th>' + escapeHtml(header) + '</th>';
      });

      html += '</tr></thead><tbody>';

      // Rows
      if (data.rows.length === 0) {
        html += '<tr><td colspan="' + data.headers.length + '" class="no-data">No records found</td></tr>';
      } else {
        data.rows.forEach(function(row) {
          html += '<tr>';
          row.forEach(function(cell) {
            let cellValue = cell;
            if (cell instanceof Date) {
              cellValue = cell.toLocaleDateString();
            }
            html += '<td>' + escapeHtml(String(cellValue)) + '</td>';
          });
          html += '</tr>';
        });
      }

      html += '</tbody></table>';

      document.getElementById('tableContainer').innerHTML = html;
      renderPagination();
    }

    function renderPagination() {
      let html = '';

      // First and Previous buttons
      html += '<button class="page-button" onclick="loadPage(1)" ' + (currentPage === 1 ? 'disabled' : '') + '>¬´ First</button>';
      html += '<button class="page-button" onclick="loadPage(' + (currentPage - 1) + ')" ' + (currentPage === 1 ? 'disabled' : '') + '>‚Äπ Prev</button>';

      // Page numbers (show 5 around current)
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, currentPage + 2);

      if (startPage > 1) {
        html += '<span style="padding: 0 5px;">...</span>';
      }

      for (let i = startPage; i <= endPage; i++) {
        html += '<button class="page-button ' + (i === currentPage ? 'active' : '') + '" onclick="loadPage(' + i + ')">' + i + '</button>';
      }

      if (endPage < totalPages) {
        html += '<span style="padding: 0 5px;">...</span>';
      }

      // Next and Last buttons
      html += '<button class="page-button" onclick="loadPage(' + (currentPage + 1) + ')" ' + (currentPage === totalPages ? 'disabled' : '') + '>Next ‚Ä∫</button>';
      html += '<button class="page-button" onclick="loadPage(' + totalPages + ')" ' + (currentPage === totalPages ? 'disabled' : '') + '>Last ¬ª</button>';

      // Jump to page
      html += '<span style="padding: 0 10px;">|</span>';
      html += '<label>Go to:</label>';
      html += '<input type="number" min="1" max="' + totalPages + '" value="' + currentPage + '" id="jumpToPage" style="width: 60px;">';
      html += '<button class="page-button" onclick="jumpToPage()">Go</button>';

      document.getElementById('pagination').innerHTML = html;
    }

    function jumpToPage() {
      const page = parseInt(document.getElementById('jumpToPage').value);
      if (page >= 1 && page <= totalPages) {
        loadPage(page);
      }
    }

    function changePageSize() {
      pageSize = parseInt(document.getElementById('pageSizeSelect').value);
      totalPages = Math.ceil(totalRecords / pageSize);
      document.getElementById('pageSize').textContent = pageSize;
      document.getElementById('totalPages').textContent = totalPages;

      // Reload current page with new size
      loadPage(1);
    }

    function searchData() {
      const searchTerm = document.getElementById('searchBox').value.toLowerCase();

      if (!searchTerm) {
        renderTable({ headers: allHeaders, rows: currentData });
        return;
      }

      const filteredRows = currentData.filter(function(row) {
        return row.some(function(cell) {
          return String(cell).toLowerCase().includes(searchTerm);
        });
      });

      renderTable({ headers: allHeaders, rows: filteredRows });
    }

    function exportCurrentPage() {
      google.script.run
        .withSuccessHandler(function(url) {
          alert('‚úÖ Page exported!');
          window.open(url, '_blank');
        })
        .exportPageToCSV(currentPage, pageSize);
    }

    function refreshData() {
      loadPage(currentPage);
    }

    function handleError(error) {
      document.getElementById('tableContainer').innerHTML = '<div class="no-data">‚ùå Error loading data: ' + error.message + '</div>';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
  `;
}

/**
 * Gets page data
 * @param {number} startRow - Starting row
 * @param {number} numRows - Number of rows
 * @returns {Object} Page data
 */
function getPageData(startRow, numRows) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!grievanceSheet) {
    throw new Error('Grievance Log sheet not found');
  }

  const lastCol = grievanceSheet.getLastColumn();

  // Get headers
  const headers = grievanceSheet.getRange(1, 1, 1, lastCol).getValues()[0];

  // Get data
  let rows = [];
  if (numRows > 0) {
    rows = grievanceSheet.getRange(startRow, 1, numRows, lastCol).getValues();
  }

  return {
    headers: headers,
    rows: rows
  };
}

/**
 * Exports current page to CSV
 * @param {number} page - Page number
 * @param {number} pageSize - Page size
 * @returns {string} File URL
 */
function exportPageToCSV(page, pageSize) {
  const startRow = (page - 1) * pageSize + 2;
  const data = getPageData(startRow, pageSize);

  // Create CSV content
  let csv = '';

  // Headers
  csv += data.headers.map(function(h) { return `"${h}"`; }).join(',') + '\n';

  // Rows
  data.rows.forEach(function(row) {
    csv += row.map(function(cell) {
      let value = String(cell);
      if (cell instanceof Date) {
        value = Utilities.formatDate(cell, Session.getScriptTimeZone(), 'yyyy-MM-dd');
      }
      return `"${value.replace(/"/g, '""')}"`;
    }).join(',') + '\n';
  });

  // Create file
  const fileName = `Grievances_Page_${page}_${Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy-MM-dd')}.csv`;
  const file = DriveApp.createFile(fileName, csv, MimeType.CSV);

  return file.getUrl();
}

/**
 * Creates a paginated view for a sheet
 * @param {string} sheetName - Sheet name
 * @param {number} pageSize - Records per page
 */
function createPaginatedView(sheetName, pageSize = PAGINATION_CONFIG.DEFAULT_PAGE_SIZE) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sourceSheet = ss.getSheetByName(sheetName);

  if (!sourceSheet) {
    throw new Error(`Sheet ${sheetName} not found`);
  }

  const totalRows = sourceSheet.getLastRow() - 1;
  const totalPages = Math.ceil(totalRows / pageSize);

  const viewSheetName = `${sheetName}_Paginated`;
  let viewSheet = ss.getSheetByName(viewSheetName);

  if (viewSheet) {
    viewSheet.clear();
  } else {
    viewSheet = ss.insertSheet(viewSheetName);
  }

  // Add controls
  viewSheet.getRange('A1').setValue('Page:');
  viewSheet.getRange('B1').setValue(1);
  viewSheet.getRange('C1').setValue(`of ${totalPages}`);

  viewSheet.getRange('D1').setValue('Page Size:');
  viewSheet.getRange('E1').setValue(pageSize);

  // Add navigation buttons (via notes)
  viewSheet.getRange('F1').setValue('‚èÆ First');
  viewSheet.getRange('G1').setValue('‚óÄ Prev');
  viewSheet.getRange('H1').setValue('Next ‚ñ∂');
  viewSheet.getRange('I1').setValue('Last ‚è≠');

  // Copy headers
  const headers = sourceSheet.getRange(1, 1, 1, sourceSheet.getLastColumn()).getValues();
  viewSheet.getRange(3, 1, 1, headers[0].length).setValues(headers);
  viewSheet.getRange(3, 1, 1, headers[0].length).setFontWeight('bold').setBackground('#1a73e8').setFontColor('#ffffff');

  // Load first page
  loadPaginatedPage(sourceSheet, viewSheet, 1, pageSize);

  return viewSheet;
}

/**
 * Loads a page in paginated view
 * @param {Sheet} sourceSheet - Source sheet
 * @param {Sheet} viewSheet - View sheet
 * @param {number} page - Page number
 * @param {number} pageSize - Page size
 */
function loadPaginatedPage(sourceSheet, viewSheet, page, pageSize) {
  const startRow = (page - 1) * pageSize + 2;
  const lastRow = sourceSheet.getLastRow();
  const numRows = Math.min(pageSize, lastRow - startRow + 1);

  // Clear previous data
  if (viewSheet.getLastRow() > 3) {
    viewSheet.getRange(4, 1, viewSheet.getLastRow() - 3, viewSheet.getLastColumn()).clear();
  }

  if (numRows > 0) {
    const data = sourceSheet.getRange(startRow, 1, numRows, sourceSheet.getLastColumn()).getValues();
    viewSheet.getRange(4, 1, numRows, data[0].length).setValues(data);
  }

  // Update page number
  viewSheet.getRange('B1').setValue(page);
}

/**
 * Navigates to next page in paginated view
 */
function nextPaginatedPage() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const viewSheet = ss.getActiveSheet();

  if (!viewSheet.getName().endsWith('_Paginated')) {
    SpreadsheetApp.getActiveSpreadsheet().toast('Not a paginated view', 'Error', 3);
    return;
  }

  const currentPage = viewSheet.getRange('B1').getValue();
  const pageSize = viewSheet.getRange('E1').getValue();
  const totalPagesText = viewSheet.getRange('C1').getValue();
  const totalPages = parseInt(totalPagesText.match(/\d+/)[0]);

  if (currentPage < totalPages) {
    const sourceSheetName = viewSheet.getName().replace('_Paginated', '');
    const sourceSheet = ss.getSheetByName(sourceSheetName);

    loadPaginatedPage(sourceSheet, viewSheet, currentPage + 1, pageSize);
  }
}

/**
 * Navigates to previous page in paginated view
 */
function previousPaginatedPage() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const viewSheet = ss.getActiveSheet();

  if (!viewSheet.getName().endsWith('_Paginated')) {
    SpreadsheetApp.getActiveSpreadsheet().toast('Not a paginated view', 'Error', 3);
    return;
  }

  const currentPage = viewSheet.getRange('B1').getValue();
  const pageSize = viewSheet.getRange('E1').getValue();

  if (currentPage > 1) {
    const sourceSheetName = viewSheet.getName().replace('_Paginated', '');
    const sourceSheet = ss.getSheetByName(sourceSheetName);

    loadPaginatedPage(sourceSheet, viewSheet, currentPage - 1, pageSize);
  }
}

/**
 * Gets pagination statistics
 * @returns {Object} Statistics
 */
function getPaginationStats() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  const totalRows = grievanceSheet.getLastRow() - 1;
  const pageSize = PAGINATION_CONFIG.DEFAULT_PAGE_SIZE;
  const totalPages = Math.ceil(totalRows / pageSize);

  return {
    totalRecords: totalRows,
    pageSize: pageSize,
    totalPages: totalPages,
    avgPageLoadTime: '~2 seconds'
  };
}



// ================================================================================
// MODULE: DistributedLocks.gs
// Source: DistributedLocks.gs
// ================================================================================

/****************************************************
 * DISTRIBUTED LOCK SERVICE
 * Phase 6 - High Priority
 *
 * Provides distributed locking for concurrent user safety
 * Prevents data corruption from simultaneous edits
 *
 * Based on ADDITIONAL_ENHANCEMENTS.md Phase 2
 ****************************************************/

/**
 * DistributedLock class for managing concurrent access
 * Uses Google Apps Script LockService for synchronization
 *
 * Usage:
 *   const lock = new DistributedLock('resource-name');
 *   lock.executeWithLock(function() {
 *     // Critical section code here
 *   });
 */
class DistributedLock {
  /**
   * Create a new distributed lock
   * @param {string} resource - Name of the resource being locked
   * @param {number} timeout - Timeout in milliseconds (default: 30000 = 30 seconds)
   */
  constructor(resource, timeout = 30000) {
    this.resource = resource;
    this.timeout = timeout;
    this.lock = LockService.getScriptLock();
    this.lockAcquired = false;
  }

  /**
   * Attempt to acquire the lock
   * @returns {boolean} True if lock acquired, false otherwise
   * @throws {Error} If unable to acquire lock after timeout
   */
  acquire() {
    try {
      const acquired = this.lock.tryLock(this.timeout);

      if (!acquired) {
        const error = new Error(
          `Failed to acquire lock for "${this.resource}" after ${this.timeout}ms. ` +
          `Another user or process may be using this resource.`
        );

        // Log the failure
        if (typeof auditLog === 'function') {
          auditLog('LOCK_FAILED', {
            resource: this.resource,
            timeout: this.timeout,
            error: error.message,
            status: 'FAILURE'
          });
        }

        throw error;
      }

      this.lockAcquired = true;
      Logger.log(`Lock acquired for "${this.resource}"`);

      // Log successful acquisition
      if (typeof auditLog === 'function') {
        auditLog('LOCK_ACQUIRED', {
          resource: this.resource,
          timeout: this.timeout,
          status: 'SUCCESS'
        });
      }

      return true;

    } catch (error) {
      Logger.log(`Error acquiring lock for "${this.resource}": ${error.message}`);
      throw error;
    }
  }

  /**
   * Release the lock
   */
  release() {
    if (this.lockAcquired) {
      try {
        this.lock.releaseLock();
        this.lockAcquired = false;
        Logger.log(`Lock released for "${this.resource}"`);

        if (typeof auditLog === 'function') {
          auditLog('LOCK_RELEASED', {
            resource: this.resource,
            status: 'SUCCESS'
          });
        }

      } catch (error) {
        Logger.log(`Error releasing lock for "${this.resource}": ${error.message}`);
      }
    }
  }

  /**
   * Execute a function while holding the lock
   * Automatically acquires lock before execution and releases after
   *
   * @param {Function} operation - Function to execute
   * @returns {*} Result from the operation
   * @throws {Error} If lock cannot be acquired or operation fails
   */
  executeWithLock(operation) {
    const startTime = new Date();

    try {
      // Acquire lock
      this.acquire();

      // Execute the operation
      const result = operation();

      // Log successful execution
      const duration = new Date() - startTime;
      Logger.log(`Operation completed successfully for "${this.resource}" (${duration}ms)`);

      return result;

    } catch (error) {
      // Log error
      const duration = new Date() - startTime;
      Logger.log(`Operation failed for "${this.resource}" after ${duration}ms: ${error.message}`);

      if (typeof logError === 'function') {
        logError(error, `DistributedLock.executeWithLock(${this.resource})`, 'ERROR');
      }

      throw error;

    } finally {
      // Always release the lock
      this.release();
    }
  }

  /**
   * Check if lock is currently held
   * @returns {boolean} True if lock is held
   */
  isLocked() {
    return this.lockAcquired;
  }
}

/**
 * Recalculate all members with thread safety
 * Prevents multiple users from running this simultaneously
 */
function recalcAllMembersThreadSafe() {
  const lock = new DistributedLock('recalc_members', 300000); // 5 minute timeout

  return lock.executeWithLock(function() {
    // Call the actual recalculation function
    if (typeof recalcAllMembers === 'function') {
      return recalcAllMembers();
    }

    throw new Error('recalcAllMembers function not found');
  });
}

/**
 * Recalculate all grievances with thread safety
 */
function recalcAllGrievancesThreadSafe() {
  const lock = new DistributedLock('recalc_grievances', 300000); // 5 minute timeout

  return lock.executeWithLock(function() {
    // Call the batched recalculation if available
    if (typeof recalcAllGrievancesBatched === 'function') {
      return recalcAllGrievancesBatched();
    }

    throw new Error('recalcAllGrievancesBatched function not found');
  });
}

/**
 * Rebuild dashboard with thread safety
 */
function rebuildDashboardThreadSafe() {
  const lock = new DistributedLock('rebuild_dashboard', 300000); // 5 minute timeout

  return lock.executeWithLock(function() {
    // Call the optimized rebuild if available, otherwise standard rebuild
    if (typeof rebuildDashboardOptimized === 'function') {
      return rebuildDashboardOptimized();
    } else if (typeof rebuildDashboard === 'function') {
      return rebuildDashboard();
    }

    throw new Error('rebuildDashboard function not found');
  });
}

/**
 * Seed data with thread safety
 * Prevents multiple seeding operations from running concurrently
 */
function seedDataThreadSafe() {
  const lock = new DistributedLock('seed_data', 600000); // 10 minute timeout

  return lock.executeWithLock(function() {
    if (typeof seedAllWithRollback === 'function') {
      return seedAllWithRollback();
    } else {
      // Fallback to standard seeding
      if (typeof SEED_20K_MEMBERS === 'function') {
        SEED_20K_MEMBERS();
      }

      if (typeof SEED_5K_GRIEVANCES === 'function') {
        SEED_5K_GRIEVANCES();
      }
    }
  });
}

/**
 * Clear all data with thread safety
 */
function clearAllDataThreadSafe() {
  const lock = new DistributedLock('clear_data', 300000); // 5 minute timeout

  return lock.executeWithLock(function() {
    if (typeof NUKE_ALL_DATA === 'function') {
      return NUKE_ALL_DATA();
    }

    throw new Error('NUKE_ALL_DATA function not found');
  });
}

/**
 * Generic wrapper to make any function thread-safe
 * @param {Function} fn - Function to wrap
 * @param {string} resourceName - Name for the lock resource
 * @param {number} timeout - Lock timeout in milliseconds
 * @returns {Function} Thread-safe version of the function
 */
function makeThreadSafe(fn, resourceName, timeout = 30000) {
  return function(...args) {
    const lock = new DistributedLock(resourceName, timeout);

    return lock.executeWithLock(function() {
      return fn.apply(this, args);
    });
  };
}

/**
 * Example usage: Create thread-safe versions of critical functions
 */
function createThreadSafeFunctions() {
  // These would be used to wrap existing functions
  const examples = {
    // Recalculation operations (5 minute timeout for long operations)
    recalcAllMembersThreadSafe: makeThreadSafe(
      recalcAllMembers,
      'recalc_members',
      300000
    ),

    recalcAllGrievancesThreadSafe: makeThreadSafe(
      recalcAllGrievancesBatched,
      'recalc_grievances',
      300000
    ),

    // Dashboard operations (5 minute timeout)
    rebuildDashboardThreadSafe: makeThreadSafe(
      rebuildDashboard,
      'rebuild_dashboard',
      300000
    ),

    // Batch operations (10 minute timeout for very long operations)
    batchUpdateThreadSafe: makeThreadSafe(
      batchUpdateGrievances,
      'batch_update',
      600000
    ),

    // Backup operations (10 minute timeout)
    createBackupThreadSafe: makeThreadSafe(
      createIncrementalBackup,
      'create_backup',
      600000
    )
  };

  Logger.log('Thread-safe function wrappers created');
  return examples;
}

/**
 * Check for concurrent operations
 * Shows which resources are currently locked
 *
 * Note: LockService doesn't provide a way to query current locks,
 * so we track them in script properties
 */
function checkConcurrentOperations() {
  const props = PropertiesService.getScriptProperties();
  const locks = props.getProperty('ACTIVE_LOCKS');

  if (!locks) {
    return {
      active: false,
      locks: [],
      message: 'No operations currently in progress'
    };
  }

  const activeLocks = JSON.parse(locks);

  return {
    active: true,
    locks: activeLocks,
    message: `${activeLocks.length} operation(s) in progress: ${activeLocks.join(', ')}`
  };
}

/**
 * Force release all locks
 * Use with caution - only for emergency situations
 */
function forceReleaseAllLocks() {
  const ui = SpreadsheetApp.getUi();

  const response = ui.alert(
    'Force Release Locks?',
    'WARNING: This will force-release all locks.\n\n' +
    'Only use this if operations are stuck and cannot complete.\n\n' +
    'Are you sure?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return;
  }

  try {
    // Clear script properties tracking locks
    const props = PropertiesService.getScriptProperties();
    props.deleteProperty('ACTIVE_LOCKS');

    // Note: We cannot actually force-release LockService locks
    // They will automatically release after 30 seconds
    ui.alert(
      'Locks Cleared',
      'Lock tracking has been cleared.\n\n' +
      'Note: Active Google LockService locks will automatically release after their timeout period.',
      ui.ButtonSet.OK
    );

    if (typeof auditLog === 'function') {
      auditLog('FORCE_RELEASE_LOCKS', {
        user: Session.getActiveUser().getEmail(),
        status: 'SUCCESS'
      });
    }

  } catch (error) {
    ui.alert(
      'Error',
      `Failed to release locks: ${error.message}`,
      ui.ButtonSet.OK
    );
  }
}

/**
 * Show lock status in UI
 */
function showLockStatus() {
  const ui = SpreadsheetApp.getUi();
  const status = checkConcurrentOperations();

  let message;

  if (status.active) {
    message = `Active Operations:\n\n`;

    for (const lock of status.locks) {
      message += `‚Ä¢ ${lock}\n`;
    }

    message += `\nThese operations are currently in progress and have acquired locks.\n`;
    message += `Wait for them to complete before running similar operations.`;

  } else {
    message = 'No operations currently in progress.\n\n';
    message += 'All resources are available for use.';
  }

  ui.alert('Lock Status', message, ui.ButtonSet.OK);
}

/**
 * Menu function to check lock status
 */
function CHECK_LOCK_STATUS() {
  showLockStatus();
}

/**
 * Example of batch operation with locking
 * Shows how to protect batch updates from concurrent access
 */
function batchUpdateWithLock(updates) {
  const lock = new DistributedLock('batch_update', 600000); // 10 minutes

  return lock.executeWithLock(function() {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

    // Perform batch updates
    let updateCount = 0;

    for (const update of updates) {
      // Apply each update
      const row = update.row;
      const values = update.values;

      sheet.getRange(row, 1, 1, values.length).setValues([values]);
      updateCount++;
    }

    Logger.log(`Batch update completed: ${updateCount} rows updated`);

    return {
      updated: updateCount,
      message: `Successfully updated ${updateCount} rows`
    };
  });
}



// ================================================================================
// MODULE: EnhancedErrorHandling.gs
// Source: EnhancedErrorHandling.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * ENHANCED ERROR HANDLING & RECOVERY
 * ------------------------------------------------------------------------====
 *
 * Comprehensive error handling, logging, and recovery system
 * Features:
 * - Error logging and tracking
 * - User-friendly error messages
 * - Automatic error recovery
 * - Error analytics and reporting
 * - Validation helpers
 * - Graceful degradation
 * - Error notification system
 *
 * Configuration: Uses ERROR_CONFIG and ERROR_CATEGORIES from Constants.gs
 * @see Constants.gs for configuration
 */

/**
 * Shows error dashboard
 */
function showErrorDashboard() {
  const html = createErrorDashboardHTML();
  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(1000)
    .setHeight(700);

  SpreadsheetApp.getUi().showModalDialog(htmlOutput, '‚ö†Ô∏è Error Dashboard');
}

/**
 * Creates HTML for error dashboard
 */
function createErrorDashboardHTML() {
  const stats = getErrorStats();
  const recentErrors = getRecentErrors(20);

  let errorRows = '';
  if (recentErrors.length === 0) {
    errorRows = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #999;">No errors logged</td></tr>';
  } else {
    recentErrors.forEach(function(error) {
      const levelClass = error.level.toLowerCase();
      errorRows += `
        <tr>
          <td><span class="level-badge level-${levelClass}">${error.level}</span></td>
          <td><span class="category-badge">${error.category}</span></td>
          <td>${error.message}</td>
          <td style="font-size: 11px; font-family: monospace; color: #666;">${error.context || '-'}</td>
          <td style="font-size: 12px; color: #666;">${new Date(error.timestamp).toLocaleString()}</td>
          <td>
            ${error.recovered ? '<span style="color: #4caf50;">‚úÖ Recovered</span>' : '<span style="color: #f44336;">‚ùå Failed</span>'}
          </td>
        </tr>
      `;
    });
  }

  return `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-height: 650px;
      overflow-y: auto;
    }
    h2 {
      color: #f44336;
      margin-top: 0;
      border-bottom: 3px solid #f44336;
      padding-bottom: 10px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin: 20px 0;
    }
    .stat-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      border-left: 4px solid #f44336;
    }
    .stat-card.info { border-color: #2196f3; }
    .stat-card.warning { border-color: #ff9800; }
    .stat-card.error { border-color: #f44336; }
    .stat-card.critical { border-color: #9c27b0; }
    .stat-number {
      font-size: 36px;
      font-weight: bold;
      color: #f44336;
    }
    .stat-card.info .stat-number { color: #2196f3; }
    .stat-card.warning .stat-number { color: #ff9800; }
    .stat-card.error .stat-number { color: #f44336; }
    .stat-card.critical .stat-number { color: #9c27b0; }
    .stat-label {
      font-size: 13px;
      color: #666;
      margin-top: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      font-size: 13px;
    }
    th {
      background: #f44336;
      color: white;
      padding: 12px 8px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
    }
    td {
      padding: 10px 8px;
      border-bottom: 1px solid #e0e0e0;
    }
    tr:hover {
      background: #fff3f3;
    }
    .level-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: bold;
      text-transform: uppercase;
    }
    .level-info { background: #e3f2fd; color: #1976d2; }
    .level-warning { background: #fff3e0; color: #f57c00; }
    .level-error { background: #ffebee; color: #d32f2f; }
    .level-critical { background: #f3e5f5; color: #7b1fa2; }
    .category-badge {
      display: inline-block;
      padding: 4px 10px;
      background: #e0e0e0;
      border-radius: 12px;
      font-size: 11px;
      color: #555;
    }
    button {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #1557b0;
    }
    button.danger {
      background: #f44336;
    }
    button.danger:hover {
      background: #d32f2f;
    }
    .actions {
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .health-indicator {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      margin: 10px 0;
    }
    .health-good { background: #e8f5e9; color: #2e7d32; }
    .health-fair { background: #fff3e0; color: #f57c00; }
    .health-poor { background: #ffebee; color: #c62828; }
  </style>
</head>
<body>
  <div class="container">
    <h2>‚ö†Ô∏è Error Dashboard</h2>

    <div style="margin: 20px 0;">
      <strong>System Health:</strong>
      <span class="health-indicator health-${stats.health}">${stats.healthText}</span>
    </div>

    <div class="stats-grid">
      <div class="stat-card info">
        <div class="stat-number">${stats.info}</div>
        <div class="stat-label">Info</div>
      </div>
      <div class="stat-card warning">
        <div class="stat-number">${stats.warning}</div>
        <div class="stat-label">Warnings</div>
      </div>
      <div class="stat-card error">
        <div class="stat-number">${stats.error}</div>
        <div class="stat-label">Errors</div>
      </div>
      <div class="stat-card critical">
        <div class="stat-number">${stats.critical}</div>
        <div class="stat-label">Critical</div>
      </div>
    </div>

    <div class="actions">
      <button onclick="runHealthCheck()">üè• Run Health Check</button>
      <button onclick="exportErrorLog()">üì• Export Log</button>
      <button class="danger" onclick="clearErrorLog()">üóëÔ∏è Clear Log</button>
      <button onclick="testErrorHandling()">üß™ Test Error Handling</button>
      <button onclick="viewErrorTrends()">üìä View Trends</button>
    </div>

    <h3 style="margin-top: 30px; color: #333;">Recent Errors (Last 20)</h3>
    <table>
      <thead>
        <tr>
          <th>Level</th>
          <th>Category</th>
          <th>Message</th>
          <th>Context</th>
          <th>Timestamp</th>
          <th>Recovery</th>
        </tr>
      </thead>
      <tbody>
        ${errorRows}
      </tbody>
    </table>
  </div>

  <script>
    function runHealthCheck() {
      google.script.run
        .withSuccessHandler(function(result) {
          alert('üè• Health Check Complete:\\n\\n' + result.summary);
          location.reload();
        })
        .performSystemHealthCheck();
    }

    function exportErrorLog() {
      google.script.run
        .withSuccessHandler(function(url) {
          alert('‚úÖ Error log exported!');
          window.open(url, '_blank');
        })
        .exportErrorLogToSheet();
    }

    function clearErrorLog() {
      if (confirm('Clear all error logs? This cannot be undone.')) {
        google.script.run
          .withSuccessHandler(function() {
            alert('‚úÖ Error log cleared!');
            location.reload();
          })
          .clearErrorLog();
      }
    }

    function testErrorHandling() {
      google.script.run
        .withSuccessHandler(function() {
          alert('‚úÖ Test error logged successfully!');
          location.reload();
        })
        .testErrorLogging();
    }

    function viewErrorTrends() {
      google.script.run
        .withSuccessHandler(function(url) {
          window.open(url, '_blank');
        })
        .createErrorTrendReport();
    }
  </script>
</body>
</html>
  `;
}

/**
 * Logs an error
 * @param {string} level - Error level
 * @param {string} category - Error category
 * @param {string} message - Error message
 * @param {string} context - Additional context
 * @param {Error} error - Original error object
 * @param {boolean} recovered - Whether error was recovered
 */
function logError(level, category, message, context = '', error = null, recovered = false) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let errorSheet = ss.getSheetByName(ERROR_CONFIG.LOG_SHEET_NAME);

    // Create error log sheet if it doesn't exist
    if (!errorSheet) {
      errorSheet = ss.insertSheet(ERROR_CONFIG.LOG_SHEET_NAME);
      const headers = ['Timestamp', 'Level', 'Category', 'Message', 'Context', 'Stack Trace', 'User', 'Recovered'];
      errorSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      errorSheet.getRange(1, 1, 1, headers.length).setFontWeight('bold').setBackground('#f44336').setFontColor('#ffffff');
      errorSheet.setFrozenRows(1);
    }

    // Prepare log entry
    const timestamp = new Date();
    const user = Session.getActiveUser().getEmail();
    const stackTrace = error ? error.stack || error.toString() : '';

    const logEntry = [
      timestamp,
      level,
      category,
      message,
      context,
      stackTrace,
      user,
      recovered
    ];

    // Add to log
    errorSheet.appendRow(logEntry);

    // Trim old entries if needed
    const lastRow = errorSheet.getLastRow();
    if (lastRow > ERROR_CONFIG.MAX_LOG_ENTRIES + 1) {
      errorSheet.deleteRows(2, lastRow - ERROR_CONFIG.MAX_LOG_ENTRIES - 1);
    }

    // Send notification if critical
    if (shouldNotify(level)) {
      sendErrorNotification(level, category, message, context);
    }

  } catch (logError) {
    // Fallback: log to console if sheet logging fails
    console.error('Failed to log error:', logError);
    console.error('Original error:', message, error);
  }
}

/**
 * Checks if error should trigger notification
 * @param {string} level - Error level
 * @returns {boolean}
 */
function shouldNotify(level) {
  const notifyLevels = [ERROR_CONFIG.ERROR_LEVELS.ERROR, ERROR_CONFIG.ERROR_LEVELS.CRITICAL];
  return notifyLevels.includes(level);
}

/**
 * Sends error notification
 * @param {string} level - Error level
 * @param {string} category - Error category
 * @param {string} message - Error message
 * @param {string} context - Context
 */
function sendErrorNotification(level, category, message, context) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const adminEmail = PropertiesService.getScriptProperties().getProperty('adminEmail');

    if (!adminEmail) return;

    const subject = `[509 Dashboard] ${level}: ${category}`;
    const body = `
Error Alert from 509 Dashboard

Level: ${level}
Category: ${category}
Message: ${message}
Context: ${context}
Timestamp: ${new Date().toLocaleString()}
Spreadsheet: ${ss.getName()}
URL: ${ss.getUrl()}

Please check the Error Dashboard for more details.
    `;

    MailApp.sendEmail(adminEmail, subject, body);
  } catch (err) {
    console.error('Failed to send error notification:', err);
  }
}

/**
 * Gets error statistics
 * @returns {Object} Statistics
 */
function getErrorStats() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const errorSheet = ss.getSheetByName(ERROR_CONFIG.LOG_SHEET_NAME);

  if (!errorSheet || errorSheet.getLastRow() <= 1) {
    return {
      info: 0,
      warning: 0,
      error: 0,
      critical: 0,
      health: 'good',
      healthText: '‚úÖ Good'
    };
  }

  const data = errorSheet.getRange(2, 1, errorSheet.getLastRow() - 1, 2).getValues();

  const stats = {
    info: 0,
    warning: 0,
    error: 0,
    critical: 0
  };

  data.forEach(function(row) {
    const level = row[ERROR_LOG_COLS.LEVEL - 1];
    if (level === 'INFO') stats.info++;
    else if (level === 'WARNING') stats.warning++;
    else if (level === 'ERROR') stats.error++;
    else if (level === 'CRITICAL') stats.critical++;
  });

  // Determine health
  let health = 'good';
  let healthText = '‚úÖ Good';

  if (stats.critical > 0 || stats.error > 10) {
    health = 'poor';
    healthText = '‚ùå Poor';
  } else if (stats.error > 0 || stats.warning > 20) {
    health = 'fair';
    healthText = '‚ö†Ô∏è Fair';
  }

  stats.health = health;
  stats.healthText = healthText;

  return stats;
}

/**
 * Gets recent errors
 * @param {number} limit - Number of errors to retrieve
 * @returns {Array} Recent errors
 */
function getRecentErrors(limit = 20) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const errorSheet = ss.getSheetByName(ERROR_CONFIG.LOG_SHEET_NAME);

  if (!errorSheet || errorSheet.getLastRow() <= 1) {
    return [];
  }

  const lastRow = errorSheet.getLastRow();
  const startRow = Math.max(2, lastRow - limit + 1);
  const numRows = lastRow - startRow + 1;

  const data = errorSheet.getRange(startRow, 1, numRows, 8).getValues();

  return data.map(function(row) { return {
    timestamp: row[ERROR_LOG_COLS.TIMESTAMP - 1],
    level: row[ERROR_LOG_COLS.LEVEL - 1],
    category: row[ERROR_LOG_COLS.CATEGORY - 1],
    message: row[ERROR_LOG_COLS.MESSAGE - 1],
    context: row[ERROR_LOG_COLS.CONTEXT - 1],
    stackTrace: row[ERROR_LOG_COLS.STACK_TRACE - 1],
    user: row[ERROR_LOG_COLS.USER - 1],
    recovered: row[ERROR_LOG_COLS.RECOVERED - 1]
  };}).reverse();
}

/**
 * Wraps a function with error handling
 * @param {Function} func - Function to wrap
 * @param {string} context - Context description
 * @returns {Function} Wrapped function
 */
function withErrorHandling(func, context) {
  return function(...args) {
    try {
      return func.apply(this, args);
    } catch (error) {
      logError(
        ERROR_CONFIG.ERROR_LEVELS.ERROR,
        ERROR_CATEGORIES.SYSTEM,
        error.message,
        context,
        error,
        false
      );

      // Show user-friendly error
      SpreadsheetApp.getUi().alert(
        '‚ö†Ô∏è Error',
        `An error occurred: ${error.message}\n\nThis has been logged for review.`,
        SpreadsheetApp.getUi().ButtonSet.OK
      );

      throw error;
    }
  };
}

/**
 * Validates required fields
 * @param {Object} data - Data to validate
 * @param {Array} requiredFields - Required field names
 * @returns {Object} Validation result
 */
function validateRequiredFields(data, requiredFields) {
  const missing = [];

  requiredFields.forEach(function(field) {
    if (!data[field] || data[field] === '') {
      missing.push(field);
    }
  });

  if (missing.length > 0) {
    return {
      valid: false,
      error: `Missing required fields: ${missing.join(', ')}`,
      missingFields: missing
    };
  }

  return { valid: true };
}

/**
 * Validates email format
 * @param {string} email - Email to validate
 * @returns {boolean}
 */
function validateEmail(email) {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

/**
 * Validates date format
 * @param {*} date - Date to validate
 * @returns {boolean}
 */
function validateDate(date) {
  if (date instanceof Date) {
    return !isNaN(date.getTime());
  }
  return false;
}

/**
 * Performs system health check
 * @returns {Object} Health check results
 */
function performSystemHealthCheck() {
  const results = {
    timestamp: new Date().toISOString(),
    checks: [],
    overall: 'PASS'
  };

  // Check 1: Verify all required sheets exist
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const requiredSheets = Object.values(SHEETS);
  const existingSheets = ss.getSheets().map(function(s) { return s.getName(); });

  requiredSheets.forEach(function(sheetName) {
    const exists = existingSheets.includes(sheetName);
    results.checks.push({
      name: `Sheet: ${sheetName}`,
      status: exists ? 'PASS' : 'FAIL',
      message: exists ? 'Exists' : 'Missing'
    });
    if (!exists) results.overall = 'FAIL';
  });

  // Check 2: Verify data integrity
  try {
    const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
    if (grievanceSheet) {
      const lastRow = grievanceSheet.getLastRow();
      results.checks.push({
        name: 'Data Integrity',
        status: 'PASS',
        message: `${lastRow - 1} grievances found`
      });
    }
  } catch (err) {
    results.checks.push({
      name: 'Data Integrity',
      status: 'FAIL',
      message: err.message
    });
    results.overall = 'FAIL';
  }

  // Check 3: Cache health
  try {
    const cache = CacheService.getScriptCache();
    cache.put('healthcheck', 'test', 60);
    const testValue = cache.get('healthcheck');
    results.checks.push({
      name: 'Cache Service',
      status: testValue === 'test' ? 'PASS' : 'FAIL',
      message: testValue === 'test' ? 'Operational' : 'Not working'
    });
  } catch (err) {
    results.checks.push({
      name: 'Cache Service',
      status: 'FAIL',
      message: err.message
    });
  }

  // Generate summary
  const passCount = results.checks.filter(function(c) { return c.status === 'PASS'; }).length;
  const totalCount = results.checks.length;
  results.summary = `Health Check: ${passCount}/${totalCount} checks passed\nOverall Status: ${results.overall}`;

  logError(
    ERROR_CONFIG.ERROR_LEVELS.INFO,
    ERROR_CATEGORIES.SYSTEM,
    'System health check completed',
    results.summary,
    null,
    true
  );

  return results;
}

/**
 * Exports error log to sheet
 * @returns {string} Sheet URL
 */
function exportErrorLogToSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const errorSheet = ss.getSheetByName(ERROR_CONFIG.LOG_SHEET_NAME);

  if (!errorSheet) {
    throw new Error('No error log found');
  }

  return ss.getUrl() + '#gid=' + errorSheet.getSheetId();
}

/**
 * Clears error log
 */
function clearErrorLog() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const errorSheet = ss.getSheetByName(ERROR_CONFIG.LOG_SHEET_NAME);

  if (errorSheet && errorSheet.getLastRow() > 1) {
    errorSheet.deleteRows(2, errorSheet.getLastRow() - 1);
  }

  logError(
    ERROR_CONFIG.ERROR_LEVELS.INFO,
    ERROR_CATEGORIES.SYSTEM,
    'Error log cleared',
    'User cleared error log',
    null,
    true
  );

  SpreadsheetApp.getActiveSpreadsheet().toast(
    '‚úÖ Error log cleared',
    'Error Log',
    3
  );
}

/**
 * Tests error logging
 */
function testErrorLogging() {
  logError(
    ERROR_CONFIG.ERROR_LEVELS.INFO,
    ERROR_CATEGORIES.SYSTEM,
    'Test error message',
    'This is a test error generated for testing purposes',
    null,
    true
  );

  SpreadsheetApp.getActiveSpreadsheet().toast(
    '‚úÖ Test error logged successfully',
    'Testing',
    3
  );
}

/**
 * Creates error trend report
 * @returns {string} Report URL
 */
function createErrorTrendReport() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const errorSheet = ss.getSheetByName(ERROR_CONFIG.LOG_SHEET_NAME);

  if (!errorSheet || errorSheet.getLastRow() <= 1) {
    throw new Error('No error data available');
  }

  // Create or get trends sheet
  let trendsSheet = ss.getSheetByName('Error_Trends');
  if (trendsSheet) {
    trendsSheet.clear();
  } else {
    trendsSheet = ss.insertSheet('Error_Trends');
  }

  // Analyze trends by day
  const data = errorSheet.getRange(2, 1, errorSheet.getLastRow() - 1, 2).getValues();

  const dailyStats = {};
  data.forEach(function(row) {
    const date = Utilities.formatDate(new Date(row[ERROR_LOG_COLS.TIMESTAMP - 1]), Session.getScriptTimeZone(), 'yyyy-MM-dd');
    const level = row[ERROR_LOG_COLS.LEVEL - 1];

    if (!dailyStats[date]) {
      dailyStats[date] = { info: 0, warning: 0, error: 0, critical: 0 };
    }

    if (level === 'INFO') dailyStats[date].info++;
    else if (level === 'WARNING') dailyStats[date].warning++;
    else if (level === 'ERROR') dailyStats[date].error++;
    else if (level === 'CRITICAL') dailyStats[date].critical++;
  });

  // Write to sheet
  const headers = ['Date', 'Info', 'Warning', 'Error', 'Critical', 'Total'];
  trendsSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  trendsSheet.getRange(1, 1, 1, headers.length).setFontWeight('bold').setBackground('#f44336').setFontColor('#ffffff');

  const rows = Object.entries(dailyStats).map(([date, stats]) => [
    date,
    stats.info,
    stats.warning,
    stats.error,
    stats.critical,
    stats.info + stats.warning + stats.error + stats.critical
  ]);

  if (rows.length > 0) {
    trendsSheet.getRange(2, 1, rows.length, headers.length).setValues(rows);

    // Create chart
    const chartRange = trendsSheet.getRange(1, 1, rows.length + 1, headers.length);
    const chart = trendsSheet.newChart()
      .setChartType(Charts.ChartType.LINE)
      .addRange(chartRange)
      .setPosition(rows.length + 3, 1, 0, 0)
      .setOption('title', 'Error Trends Over Time')
      .setOption('width', 800)
      .setOption('height', 400)
      .build();

    trendsSheet.insertChart(chart);
  }

  return ss.getUrl() + '#gid=' + trendsSheet.getSheetId();
}



// ================================================================================
// MODULE: FAQKnowledgeBase.gs
// Source: FAQKnowledgeBase.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * FAQ DATABASE & KNOWLEDGE BASE
 * ------------------------------------------------------------------------====
 *
 * Searchable knowledge base for common questions and procedures
 * Features:
 * - Searchable FAQ database
 * - Category-based organization
 * - Admin interface to add/edit FAQs
 * - User feedback on helpfulness
 * - Related articles suggestions
 * - Export FAQ documentation
 * - Auto-suggest based on context
 */

/**
 * FAQ categories
 */
FAQ_CATEGORIES = {
  GETTING_STARTED: 'Getting Started',
  GRIEVANCES: 'Grievance Process',
  MEMBERS: 'Member Management',
  REPORTS: 'Reports & Analytics',
  AUTOMATION: 'Automation Features',
  TROUBLESHOOTING: 'Troubleshooting',
  BEST_PRACTICES: 'Best Practices'
};

/**
 * Creates FAQ database sheet if it doesn't exist
 * Note: Renamed from createFAQSheet to avoid collision with GettingStartedAndFAQ.gs
 */
function createFAQDatabaseSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let faqSheet = ss.getSheetByName('üìö FAQ Database');

  if (faqSheet) {
    SpreadsheetApp.getUi().alert('FAQ Database sheet already exists.');
    return;
  }

  faqSheet = ss.insertSheet('üìö FAQ Database');

  // Set headers
  const headers = [
    'ID',
    'Category',
    'Question',
    'Answer',
    'Tags',
    'Related FAQs',
    'Helpful Count',
    'Not Helpful Count',
    'Created Date',
    'Last Updated',
    'Created By'
  ];

  faqSheet.getRange(1, 1, 1, headers.length).setValues([headers]);

  // Format header
  faqSheet.getRange(1, 1, 1, headers.length)
    .setBackground('#1a73e8')
    .setFontColor('#ffffff')
    .setFontWeight('bold')
    .setHorizontalAlignment('center');

  // Set column widths
  faqSheet.setColumnWidth(1, 60);   // ID
  faqSheet.setColumnWidth(2, 150);  // Category
  faqSheet.setColumnWidth(3, 300);  // Question
  faqSheet.setColumnWidth(4, 500);  // Answer
  faqSheet.setColumnWidth(5, 150);  // Tags
  faqSheet.setColumnWidth(6, 120);  // Related FAQs
  faqSheet.setColumnWidth(7, 100);  // Helpful Count
  faqSheet.setColumnWidth(8, 120);  // Not Helpful Count
  faqSheet.setColumnWidth(9, 120);  // Created Date
  faqSheet.setColumnWidth(10, 120); // Last Updated
  faqSheet.setColumnWidth(11, 150); // Created By

  // Freeze header
  faqSheet.setFrozenRows(1);

  // Add initial FAQs
  seedInitialFAQs();

  SpreadsheetApp.getUi().alert(
    '‚úÖ FAQ Database Created',
    'The FAQ Database sheet has been created and seeded with common questions.',
    SpreadsheetApp.getUi().ButtonSet.OK
  );
}

/**
 * Seeds initial FAQs
 */
function seedInitialFAQs() {
  const initialFAQs = [
    {
      category: FAQ_CATEGORIES.GETTING_STARTED,
      question: 'How do I start a new grievance?',
      answer: 'To start a new grievance: 1) Go to menu: üìã Grievance Tools ‚Üí ‚ûï Start New Grievance, 2) Fill in the member information and grievance details, 3) Click Submit. The system will auto-assign a Grievance ID and calculate deadlines.',
      tags: 'grievance, new, create, start'
    },
    {
      category: FAQ_CATEGORIES.GRIEVANCES,
      question: 'What are the different grievance workflow states?',
      answer: 'Grievances flow through these states: Filed ‚Üí Step 1 Pending ‚Üí Step 1 Meeting ‚Üí Step 2 Pending (if escalated) ‚Üí Step 2 Meeting ‚Üí Arbitration (if needed) ‚Üí Resolved/Withdrawn. Each state has specific deadlines and required actions. Use the Workflow Visualizer (üîÑ Workflow Management ‚Üí üîÑ Workflow Visualizer) to see the full process.',
      tags: 'workflow, states, process, steps'
    },
    {
      category: FAQ_CATEGORIES.GRIEVANCES,
      question: 'How do I assign a steward to a grievance?',
      answer: 'You have three options: 1) Manual: Select the grievance row and enter a steward name in the "Assigned Steward" column, 2) Auto-Assign: Select the row and use ü§ñ Smart Assignment ‚Üí ü§ñ Auto-Assign Steward (recommended - uses AI to find best match), 3) Batch: Select multiple rows and use ü§ñ Smart Assignment ‚Üí üì¶ Batch Auto-Assign.',
      tags: 'steward, assign, assignment, auto-assign'
    },
    {
      category: FAQ_CATEGORIES.MEMBERS,
      question: 'How do I search for a member?',
      answer: "Use the Member Search tool: 1) Press Ctrl+F or go to üîç Search & Lookup ‚Üí üîç Search Members, 2) Type name, ID, or email in the search box, 3) Use filters to narrow by location, unit, or steward status, 4) Click on a result to navigate to that member's row.",
      tags: 'search, member, find, lookup'
    },
    {
      category: FAQ_CATEGORIES.REPORTS,
      question: 'How do I create a custom report?',
      answer: 'Use the Custom Report Builder: 1) Go to üìä Reports ‚Üí üìä Custom Report Builder, 2) Select your data source (Grievances or Members), 3) Choose which fields to include, 4) Add filters to narrow data, 5) Choose grouping/sorting options, 6) Generate preview, 7) Export to PDF, CSV, or Excel. You can save configurations as templates for reuse.',
      tags: 'report, custom, export, PDF, CSV, Excel'
    },
    {
      category: FAQ_CATEGORIES.AUTOMATION,
      question: 'How do I enable automated deadline notifications?',
      answer: 'To enable email notifications for approaching deadlines: 1) Go to ü§ñ Automation ‚Üí üì¨ Notification Settings, 2) Click "Enable Notifications", 3) The system will send daily emails at 8 AM: 7-day warnings to stewards, 3-day escalations to managers, and overdue alerts. Test with "üß™ Test Now" button.',
      tags: 'automation, notifications, email, deadlines, alerts'
    },
    {
      category: FAQ_CATEGORIES.AUTOMATION,
      question: 'Can I schedule automated reports?',
      answer: 'Yes! Go to ü§ñ Automation ‚Üí üìä Report Automation Settings. You can enable: 1) Monthly Reports (1st of each month, executive summary), 2) Quarterly Reports (Jan/Apr/Jul/Oct, trend analysis). Reports are automatically generated as PDFs and emailed to configured recipients.',
      tags: 'automation, reports, schedule, monthly, quarterly'
    },
    {
      category: FAQ_CATEGORIES.TROUBLESHOOTING,
      question: 'Why are my formulas not calculating?',
      answer: 'If formulas aren\'t updating: 1) Go to menu: üîÑ Refresh All (Ctrl+R), 2) If still not working, check if you have edit permissions, 3) Make sure the sheet isn\'t in protected range, 4) Try ‚ö° Performance ‚Üí üóëÔ∏è Clear All Caches, then refresh. If problem persists, use ‚ùì Help & Support ‚Üí üîß Diagnose Setup.',
      tags: 'formulas, not working, calculate, refresh, troubleshoot'
    },
    {
      category: FAQ_CATEGORIES.TROUBLESHOOTING,
      question: 'What if a grievance deadline is wrong?',
      answer: 'Deadlines are auto-calculated based on Filed Date (Column G) + workflow state. To fix: 1) Check the Filed Date is correct, 2) Verify the workflow state is accurate (üîÑ Workflow Management ‚Üí üìä View Current State), 3) If you need to manually override, you can edit the "Next Action Due" field directly.',
      tags: 'deadline, wrong, incorrect, fix, override'
    },
    {
      category: FAQ_CATEGORIES.BEST_PRACTICES,
      question: 'What are keyboard shortcuts and how do I use them?',
      answer: 'Keyboard shortcuts make navigation 10x faster! Press Ctrl+? to see all shortcuts. Common ones: Ctrl+G (Go to Grievance Log), Ctrl+M (Go to Members), Ctrl+F (Search Members), Ctrl+N (New Grievance), Ctrl+E (Compose Email), Ctrl+B (Batch Operations). On Mac, use Cmd instead of Ctrl.',
      tags: 'keyboard, shortcuts, hotkeys, fast, navigation'
    },
    {
      category: FAQ_CATEGORIES.BEST_PRACTICES,
      question: 'How often should I back up data?',
      answer: 'Best practice is weekly backups. Use üíæ Data Management ‚Üí üíæ Create Backup to generate a timestamped copy of all data. The backup is saved to Google Drive. You can also enable automated weekly backups in the backup settings. Keep at least 4 weeks of backups.',
      tags: 'backup, data, export, save, recovery'
    },
    {
      category: FAQ_CATEGORIES.BEST_PRACTICES,
      question: 'How can I improve dashboard performance?',
      answer: 'Performance tips: 1) Use caching - enable via ‚ö° Performance ‚Üí üî• Warm Up All Caches, 2) Close unused sheets/tabs, 3) Use filters instead of scrolling through all data, 4) For large datasets (20k+ members), use Search instead of browsing, 5) Batch operations instead of individual updates, 6) Keep browser updated.',
      tags: 'performance, slow, speed, fast, optimize, cache'
    }
  ];

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const faqSheet = ss.getSheetByName('üìö FAQ Database');

  const rows = initialFAQs.map((faq, index) => [
    index + 1,
    faq.category,
    faq.question,
    faq.answer,
    faq.tags,
    '',
    0,
    0,
    new Date(),
    new Date(),
    Session.getActiveUser().getEmail() || 'System'
  ]);

  faqSheet.getRange(2, 1, rows.length, 11).setValues(rows);
}

/**
 * Shows FAQ search dialog
 */
function showFAQSearch() {
  const html = createFAQSearchHTML();
  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(900)
    .setHeight(700);

  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'üìö FAQ & Knowledge Base');
}

/**
 * Creates HTML for FAQ search
 */
function createFAQSearchHTML() {
  const categories = Object.values(FAQ_CATEGORIES);

  return `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 {
      color: #1a73e8;
      margin-top: 0;
      border-bottom: 3px solid #1a73e8;
      padding-bottom: 10px;
    }
    .search-box {
      margin: 20px 0;
    }
    input[type="text"] {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      box-sizing: border-box;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #1a73e8;
    }
    .categories {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 20px 0;
    }
    .category-badge {
      background: #e8f0fe;
      color: #1a73e8;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      border: 2px solid transparent;
      transition: all 0.2s;
    }
    .category-badge:hover {
      background: #1a73e8;
      color: white;
    }
    .category-badge.active {
      background: #1a73e8;
      color: white;
      border-color: #1557b0;
    }
    .faq-item {
      background: #f8f9fa;
      padding: 20px;
      margin: 15px 0;
      border-radius: 8px;
      border-left: 4px solid #1a73e8;
      cursor: pointer;
      transition: all 0.2s;
    }
    .faq-item:hover {
      transform: translateX(5px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .faq-question {
      font-weight: bold;
      font-size: 16px;
      color: #333;
      margin-bottom: 10px;
    }
    .faq-answer {
      color: #666;
      font-size: 14px;
      line-height: 1.6;
      display: none;
    }
    .faq-answer.show {
      display: block;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #ddd;
    }
    .faq-meta {
      display: flex;
      gap: 15px;
      margin-top: 10px;
      font-size: 12px;
      color: #999;
    }
    .category-tag {
      background: #e8f0fe;
      color: #1a73e8;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
    }
    .helpful-buttons {
      display: none;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #ddd;
    }
    .helpful-buttons.show {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    button {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 8px 16px;
      font-size: 13px;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #1557b0;
    }
    button.secondary {
      background: #6c757d;
    }
    button.secondary:hover {
      background: #5a6268;
    }
    .no-results {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    .stats {
      background: #e8f0fe;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
      border-left: 4px solid #1a73e8;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìö FAQ & Knowledge Base</h2>

    <div class="search-box">
      <input type="text" id="searchInput" placeholder="üîç Search for answers..." autofocus oninput="searchFAQs()">
    </div>

    <div class="categories">
      <div class="category-badge active" onclick="filterByCategory('')">All Categories</div>
      ${categories.map(function(cat) { return `
        <div class="category-badge" onclick="filterByCategory('${cat}')">${cat}</div>
      `; }).join('')}
    </div>

    <div class="stats" id="stats">
      Loading FAQs...
    </div>

    <div id="results">
      <div class="no-results">Type to search or select a category</div>
    </div>
  </div>

  <script>
    let allFAQs = [];
    let currentCategory = '';

    // Load FAQs on startup
    google.script.run
      .withSuccessHandler(onFAQsLoaded)
      .getAllFAQs();

    function onFAQsLoaded(faqs) {
      allFAQs = faqs;
      updateStats();
      showAllFAQs();
    }

    function updateStats() {
      const stats = document.getElementById('stats');
      stats.innerHTML = \`
        <strong>üìä Knowledge Base Stats:</strong>
        ${allFAQs.length} articles across ${new Set(allFAQs.map(function(f) { return f.category; })).size} categories
      \`;
    }

    function searchFAQs() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();

      if (!searchTerm && !currentCategory) {
        showAllFAQs();
        return;
      }

      let filtered = allFAQs;

      if (currentCategory) {
        filtered = filtered.filter(function(faq) { return faq.category === currentCategory; });
      }

      if (searchTerm) {
        filtered = filtered.filter(function(faq) {
          return faq.question.toLowerCase().includes(searchTerm) ||
                 faq.answer.toLowerCase().includes(searchTerm) ||
                 (faq.tags && faq.tags.toLowerCase().includes(searchTerm));
        });
      }

      displayFAQs(filtered);
    }

    function filterByCategory(category) {
      currentCategory = category;

      // Update active badge
      document.querySelectorAll('.category-badge').forEach(function(badge) {
        badge.classList.remove('active');
      });
      event.target.classList.add('active');

      searchFAQs();
    }

    function showAllFAQs() {
      displayFAQs(allFAQs);
    }

    function displayFAQs(faqs) {
      const results = document.getElementById('results');

      if (faqs.length === 0) {
        results.innerHTML = '<div class="no-results">No FAQs found. Try different search terms.</div>';
        return;
      }

      results.innerHTML = faqs.map((faq, index) => \`
        <div class="faq-item" onclick="toggleFAQ(\${index})">
          <div class="faq-question">
            ${faq.question}
          </div>
          <div class="faq-meta">
            <span class="category-tag">${faq.category}</span>
            ${faq.helpfulCount > 0 ? `<span>üëç ${faq.helpfulCount} found this helpful</span>` : ''}
          </div>
          <div class="faq-answer" id="answer\${index}">
            ${faq.answer}
          </div>
          <div class="helpful-buttons" id="buttons\${index}">
            <span>Was this helpful?</span>
            <button onclick="markHelpful(\${faq.id}, true); event.stopPropagation();">üëç Yes</button>
            <button class="secondary" onclick="markHelpful(\${faq.id}, false); event.stopPropagation();">üëé No</button>
          </div>
        </div>
      \`).join('');
    }

    function toggleFAQ(index) {
      const answer = document.getElementById('answer' + index);
      const buttons = document.getElementById('buttons' + index);

      answer.classList.toggle('show');
      buttons.classList.toggle('show');
    }

    function markHelpful(faqId, isHelpful) {
      google.script.run
        .withSuccessHandler(function() {
          // Reload FAQs to get updated counts
          google.script.run
            .withSuccessHandler(onFAQsLoaded)
            .getAllFAQs();
        })
        .updateFAQHelpfulness(faqId, isHelpful);
    }
  </script>
</body>
</html>
  `;
}

/**
 * Gets all FAQs
 * @returns {Array} FAQ array
 */
function getAllFAQs() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const faqSheet = ss.getSheetByName('üìö FAQ Database');

  if (!faqSheet) {
    return [];
  }

  const lastRow = faqSheet.getLastRow();
  if (lastRow < 2) {
    return [];
  }

  const data = faqSheet.getRange(2, 1, lastRow - 1, 11).getValues();

  return data.map(function(row) { return {
    id: row[FAQ_COLS.ID - 1],
    category: row[FAQ_COLS.CATEGORY - 1],
    question: row[FAQ_COLS.QUESTION - 1],
    answer: row[FAQ_COLS.ANSWER - 1],
    tags: row[FAQ_COLS.TAGS - 1],
    relatedFAQs: row[FAQ_COLS.RELATED_FAQS - 1],
    helpfulCount: row[FAQ_COLS.HELPFUL_COUNT - 1] || 0,
    notHelpfulCount: row[FAQ_COLS.NOT_HELPFUL_COUNT - 1] || 0,
    createdDate: row[FAQ_COLS.CREATED_DATE - 1],
    lastUpdated: row[FAQ_COLS.LAST_UPDATED - 1],
    createdBy: row[FAQ_COLS.CREATED_BY - 1]
  };});
}

/**
 * Updates FAQ helpfulness rating
 * @param {number} faqId - FAQ ID
 * @param {boolean} isHelpful - Whether helpful or not
 */
function updateFAQHelpfulness(faqId, isHelpful) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const faqSheet = ss.getSheetByName('üìö FAQ Database');

  if (!faqSheet) return;

  const lastRow = faqSheet.getLastRow();
  const data = faqSheet.getRange(2, 1, lastRow - 1, 1).getValues();

  for (let i = 0; i < data.length; i++) {
    if (data[i][FAQ_COLS.ID - 1] === faqId) {
      const row = i + 2;
      const col = isHelpful ? FAQ_COLS.HELPFUL_COUNT : FAQ_COLS.NOT_HELPFUL_COUNT;

      const currentCount = faqSheet.getRange(row, col).getValue() || 0;
      faqSheet.getRange(row, col).setValue(currentCount + 1);

      break;
    }
  }
}

/**
 * Shows FAQ admin panel
 */
function showFAQAdmin() {
  const html = createFAQAdminHTML();
  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(800)
    .setHeight(650);

  SpreadsheetApp.getUi().showModalDialog(htmlOutput, '‚öôÔ∏è FAQ Admin Panel');
}

/**
 * Creates HTML for FAQ admin
 */
function createFAQAdminHTML() {
  const categories = Object.values(FAQ_CATEGORIES);

  return `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: 'Roboto', Arial, sans-serif; padding: 20px; margin: 0; background: #f5f5f5; }
    .container { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h2 { color: #1a73e8; margin-top: 0; border-bottom: 3px solid #1a73e8; padding-bottom: 10px; }
    .form-group { margin: 15px 0; }
    label { display: block; font-weight: 500; margin-bottom: 5px; color: #555; }
    input, select, textarea { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box; font-family: Arial, sans-serif; }
    textarea { min-height: 150px; resize: vertical; }
    button { background: #1a73e8; color: white; border: none; padding: 12px 24px; font-size: 14px; border-radius: 4px; cursor: pointer; margin: 10px 5px 0 0; }
    button:hover { background: #1557b0; }
    button.secondary { background: #6c757d; }
  </style>
</head>
<body>
  <div class="container">
    <h2>‚öôÔ∏è Add New FAQ</h2>

    <div class="form-group">
      <label>Category:</label>
      <select id="category">
        ${categories.map(function(cat) { return `<option value="${cat}">${cat}</option>`; }).join('')}
      </select>
    </div>

    <div class="form-group">
      <label>Question:</label>
      <input type="text" id="question" placeholder="Enter the question...">
    </div>

    <div class="form-group">
      <label>Answer:</label>
      <textarea id="answer" placeholder="Enter the detailed answer..."></textarea>
    </div>

    <div class="form-group">
      <label>Tags (comma-separated):</label>
      <input type="text" id="tags" placeholder="e.g., grievance, new, create, start">
    </div>

    <button onclick="saveFAQ()">üíæ Save FAQ</button>
    <button class="secondary" onclick="google.script.host.close()">‚ùå Cancel</button>
  </div>

  <script>
    function saveFAQ() {
      const faq = {
        category: document.getElementById('category').value,
        question: document.getElementById('question').value.trim(),
        answer: document.getElementById('answer').value.trim(),
        tags: document.getElementById('tags').value.trim()
      };

      if (!faq.question || !faq.answer) {
        alert('Please fill in both question and answer');
        return;
      }

      google.script.run
        .withSuccessHandler(function() {
          alert('‚úÖ FAQ saved successfully!');
          google.script.host.close();
        })
        .withFailureHandler(function(error) {
          alert('Error: ' + error.message);
        })
        .addNewFAQ(faq);
    }
  </script>
</body>
</html>
  `;
}

/**
 * Adds new FAQ
 * @param {Object} faq - FAQ data
 */
function addNewFAQ(faq) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let faqSheet = ss.getSheetByName('üìö FAQ Database');

  if (!faqSheet) {
    createFAQDatabaseSheet();
    faqSheet = ss.getSheetByName('üìö FAQ Database');
  }

  const lastRow = faqSheet.getLastRow();
  const nextId = lastRow > 1 ? faqSheet.getRange(lastRow, 1).getValue() + 1 : 1;

  const newRow = [
    nextId,
    faq.category,
    faq.question,
    faq.answer,
    faq.tags,
    '',
    0,
    0,
    new Date(),
    new Date(),
    Session.getActiveUser().getEmail() || 'User'
  ];

  faqSheet.getRange(lastRow + 1, 1, 1, 11).setValues([newRow]);
}



// ================================================================================
// MODULE: GettingStartedAndFAQ.gs
// Source: GettingStartedAndFAQ.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * GETTING STARTED AND FAQ SHEETS
 * ------------------------------------------------------------------------====
 *
 * Creates informational sheets with getting started guide and FAQ
 * Includes GitHub repository information
 *
 * ------------------------------------------------------------------------====
 */

/**
 * Creates the Getting Started sheet
 */
function createGettingStartedSheet(ss) {
  let sheet = ss.getSheetByName("üìö Getting Started");
  if (sheet) {
    ss.deleteSheet(sheet);
  }
  sheet = ss.insertSheet("üìö Getting Started");

  sheet.clear();

  // Set up the sheet with a clean, professional design
  sheet.setColumnWidth(1, 150);
  sheet.setColumnWidths(2, 3, 600);

  // Header
  sheet.getRange("A1:D1").merge()
    .setValue("üìö Getting Started with SEIU Local 509 Dashboard")
    .setFontSize(24)
    .setFontWeight("bold")
    .setBackground(COLORS.PRIMARY_PURPLE)
    .setFontColor("white")
    .setFontFamily("Roboto")
    .setVerticalAlignment("middle")
    .setHorizontalAlignment("center");
  sheet.setRowHeight(1, 60);

  // GitHub Repository Information Section
  let row = 3;
  sheet.getRange(row, 1, 1, 4).merge()
    .setValue("üì¶ GitHub Repository")
    .setFontSize(18)
    .setFontWeight("bold")
    .setBackground(COLORS.ACCENT_TEAL)
    .setFontColor("white")
    .setVerticalAlignment("middle");
  sheet.setRowHeight(row, 40);

  row++;
  sheet.getRange(row, 2, 1, 3).merge()
    .setValue("Repository: https://github.com/Woop91/509-Dashboard")
    .setFontSize(12)
    .setWrap(true);
  sheet.setRowHeight(row, 30);

  row++;
  sheet.getRange(row, 2, 1, 3).merge()
    .setValue("For bug reports, feature requests, and contributions, please visit the GitHub repository.")
    .setFontStyle("italic")
    .setWrap(true);
  sheet.setRowHeight(row, 30);

  row++;
  sheet.getRange(row, 2, 1, 3).merge()
    .setValue("Documentation and guides are available in the repository's README and guides folder.")
    .setFontStyle("italic")
    .setWrap(true);
  sheet.setRowHeight(row, 30);

  // Quick Start Section
  row += 2;
  sheet.getRange(row, 1, 1, 4).merge()
    .setValue("üöÄ Quick Start Guide")
    .setFontSize(18)
    .setFontWeight("bold")
    .setBackground(COLORS.UNION_GREEN)
    .setFontColor("white")
    .setVerticalAlignment("middle");
  sheet.setRowHeight(row, 40);

  const quickStartSteps = [
    ["Step 1", "Configure Steward Contact Info", "Go to the ‚öôÔ∏è Config tab, scroll to column U, and enter your steward contact information (Name, Email, Phone). This information is used when starting new grievances."],
    ["Step 2", "Add Members", "Navigate to üë• Member Directory and start adding your union members. You can enter them manually, import from CSV, or use the seed data function for testing."],
    ["Step 3", "Review Configuration", "Check the ‚öôÔ∏è Config tab to ensure all dropdown values (job titles, work locations, grievance types, etc.) match your organization's needs. Customize as needed."],
    ["Step 4", "Set Up Triggers", "Go to 509 Tools > Utilities > Setup Triggers to enable automatic calculations and deadline tracking."],
    ["Step 5", "Explore Dashboards", "Visit the various dashboard views: üìä Main Dashboard for overview metrics, üéØ Interactive Dashboard for customizable views, and üë®‚Äç‚öñÔ∏è Steward Workload for assignment tracking."]
  ];

  row++;
  for (let i = 0; i < quickStartSteps.length; i++) {
    const step = quickStartSteps[i];

    // Step number
    sheet.getRange(row, 1)
      .setValue(step[0])
      .setFontWeight("bold")
      .setFontSize(14)
      .setBackground(COLORS.INFO_LIGHT)
      .setVerticalAlignment("top")
      .setBorder(true, true, true, true, false, false);

    // Step title
    sheet.getRange(row, 2)
      .setValue(step[1])
      .setFontWeight("bold")
      .setFontSize(12)
      .setVerticalAlignment("top")
      .setBorder(true, true, true, true, false, false);

    // Step description
    sheet.getRange(row, 3, 1, 2).merge()
      .setValue(step[2])
      .setWrap(true)
      .setVerticalAlignment("top")
      .setBorder(true, true, true, true, false, false);

    sheet.setRowHeight(row, 60);
    row++;
  }

  // Key Features Section
  row += 2;
  sheet.getRange(row, 1, 1, 4).merge()
    .setValue("‚≠ê Key Features")
    .setFontSize(18)
    .setFontWeight("bold")
    .setBackground(COLORS.SOLIDARITY_RED)
    .setFontColor("white")
    .setVerticalAlignment("middle");
  sheet.setRowHeight(row, 40);

  const features = [
    ["üöÄ Grievance Workflow", "Start grievances from Member Directory with pre-filled forms, automatic log entry, PDF generation, and email delivery."],
    ["üìä Interactive Dashboards", "User-selectable metrics, dynamic chart types, side-by-side comparison, and 6 professional themes with real-time updates."],
    ["‚öñÔ∏è CBA Compliance", "Automatic deadline tracking based on Article 23A (21-day filing, 30-day decisions, 10-day appeals) with color-coded alerts."],
    ["üë• Member Management", "Comprehensive member directory with auto-calculated grievance metrics, engagement tracking, and committee participation."],
    ["üìà Advanced Analytics", "Four dedicated analytical tabs: Trends & Timeline, Performance Metrics, Location Analytics, and Type Analysis."],
    ["üß† ADHD-Friendly Design", "Soft colors, no gridlines, emoji icons, large numbers, and minimal visual clutter for easy scanning."],
    ["üë®‚Äç‚öñÔ∏è Steward Workload", "Automatic calculation of cases per steward, active case breakdown, overdue highlights, and win rates."]
  ];

  row++;
  for (let i = 0; i < features.length; i++) {
    const feature = features[i];

    // Feature name
    sheet.getRange(row, 1, 1, 2).merge()
      .setValue(feature[0])
      .setFontWeight("bold")
      .setFontSize(11)
      .setVerticalAlignment("top")
      .setBorder(true, true, true, true, false, false)
      .setBackground(COLORS.LIGHT_GRAY);

    // Feature description
    sheet.getRange(row, 3, 1, 2).merge()
      .setValue(feature[1])
      .setWrap(true)
      .setVerticalAlignment("top")
      .setBorder(true, true, true, true, false, false);

    sheet.setRowHeight(row, 50);
    row++;
  }

  // Important Links Section
  row += 2;
  sheet.getRange(row, 1, 1, 4).merge()
    .setValue("üîó Important Links & Resources")
    .setFontSize(18)
    .setFontWeight("bold")
    .setBackground(COLORS.ACCENT_PURPLE)
    .setFontColor("white")
    .setVerticalAlignment("middle");
  sheet.setRowHeight(row, 40);

  const links = [
    ["GitHub Repository", "https://github.com/Woop91/509-Dashboard"],
    ["Grievance Workflow Guide", "See GRIEVANCE_WORKFLOW_GUIDE.md in the repository"],
    ["ADHD-Friendly Guide", "See ADHD_FRIENDLY_GUIDE.md in the repository"],
    ["Steward Excellence Guide", "See STEWARD_GUIDE.md in the repository"],
    ["Seed Nuke Guide", "See SEED_NUKE_GUIDE.md in the repository"]
  ];

  row++;
  for (let i = 0; i < links.length; i++) {
    const link = links[i];

    sheet.getRange(row, 2)
      .setValue(link[0])
      .setFontWeight("bold")
      .setVerticalAlignment("middle")
      .setBorder(true, true, true, true, false, false);

    sheet.getRange(row, 3, 1, 2).merge()
      .setValue(link[1])
      .setVerticalAlignment("middle")
      .setBorder(true, true, true, true, false, false)
      .setFontColor("#1155CC");

    sheet.setRowHeight(row, 30);
    row++;
  }

  // Support Section
  row += 2;
  sheet.getRange(row, 1, 1, 4).merge()
    .setValue("üìû Support & Help")
    .setFontSize(18)
    .setFontWeight("bold")
    .setBackground(COLORS.ACCENT_ORANGE)
    .setFontColor("white")
    .setVerticalAlignment("middle");
  sheet.setRowHeight(row, 40);

  row++;
  sheet.getRange(row, 2, 1, 3).merge()
    .setValue("For questions, issues, or feature requests:\n‚Ä¢ Visit the GitHub Issues page: https://github.com/Woop91/509-Dashboard/issues\n‚Ä¢ Check the FAQ tab in this spreadsheet\n‚Ä¢ Review the comprehensive guides in the repository\n‚Ä¢ Contact your system administrator")
    .setWrap(true)
    .setVerticalAlignment("top");
  sheet.setRowHeight(row, 80);

  // Freeze header row
  sheet.setFrozenRows(1);

  return sheet;
}

/**
 * Creates the FAQ sheet
 */
function createFAQSheet(ss) {
  let sheet = ss.getSheetByName("‚ùì FAQ");
  if (sheet) {
    ss.deleteSheet(sheet);
  }
  sheet = ss.insertSheet("‚ùì FAQ");

  sheet.clear();

  // Set up the sheet with a clean, professional design
  sheet.setColumnWidth(1, 50);
  sheet.setColumnWidth(2, 300);
  sheet.setColumnWidths(3, 1, 700);

  // Header
  sheet.getRange("A1:C1").merge()
    .setValue("‚ùì Frequently Asked Questions (FAQ)")
    .setFontSize(24)
    .setFontWeight("bold")
    .setBackground(COLORS.PRIMARY_PURPLE)
    .setFontColor("white")
    .setFontFamily("Roboto")
    .setVerticalAlignment("middle")
    .setHorizontalAlignment("center");
  sheet.setRowHeight(1, 60);

  // FAQ Categories and Questions
  let row = 3;

  // General Questions
  sheet.getRange(row, 1, 1, 3).merge()
    .setValue("üìã General Questions")
    .setFontSize(16)
    .setFontWeight("bold")
    .setBackground(COLORS.UNION_GREEN)
    .setFontColor("white")
    .setVerticalAlignment("middle");
  sheet.setRowHeight(row, 35);

  const generalFAQs = [
    ["What is the 509 Dashboard?", "The 509 Dashboard is a comprehensive Google Sheets-based system for SEIU Local 509 (Units 8 & 10) to track member information, manage grievances, monitor CBA deadlines, and analyze trends. It's specifically designed for Massachusetts state employees and ensures compliance with Article 23A grievance procedures."],
    ["Who should use this dashboard?", "This dashboard is designed for union stewards, representatives, and administrators who need to manage member data, track grievances, and ensure compliance with collective bargaining agreement deadlines."],
    ["Where can I find the source code?", "The source code is available on GitHub at https://github.com/Woop91/509-Dashboard. You can report issues, request features, and contribute to the project there."],
    ["How do I get started?", "Check the üìö Getting Started tab for a step-by-step guide. In brief: configure steward contact info in the Config tab, add members to the Member Directory, review configuration settings, set up triggers, and explore the dashboards."]
  ];

  row++;
  row = addFAQSection(sheet, row, generalFAQs);

  // Data Entry Questions
  row += 2;
  sheet.getRange(row, 1, 1, 3).merge()
    .setValue("‚úçÔ∏è Data Entry Questions")
    .setFontSize(16)
    .setFontWeight("bold")
    .setBackground(COLORS.UNION_GREEN)
    .setFontColor("white")
    .setVerticalAlignment("middle");
  sheet.setRowHeight(row, 35);

  const dataFAQs = [
    ["How do I add a new member?", "Go to the üë• Member Directory sheet and add a new row. Fill in the basic information (First Name, Last Name, Job Title, Work Location, Unit, Email, Phone). The system will automatically calculate grievance metrics. Leave auto-calculated columns (highlighted in green/orange) blank."],
    ["How do I add a new grievance?", "Go to the üìã Grievance Log sheet and add a new row. Enter the Member ID, name, status, current step, Incident Date, and grievance details. The system will automatically calculate all CBA-compliant deadlines based on Article 23A."],
    ["Which columns should I not edit manually?", "Never manually edit columns highlighted in green or orange. These are auto-calculated fields including: Member metrics (Total Grievances, Win Rate, etc.), Deadline columns (Filing Deadline, Step I/II/III Due Dates), and Derived fields (Days Open, Priority Score, etc.)."],
    ["Can I import data from another spreadsheet?", "Yes! You can copy and paste data from another spreadsheet, or use the seed data functions for testing. Just ensure your data matches the column structure. Go to 509 Tools > Data Management > Seed All Test Data for sample data."]
  ];

  row++;
  row = addFAQSection(sheet, row, dataFAQs);

  // Features & Functionality
  row += 2;
  sheet.getRange(row, 1, 1, 3).merge()
    .setValue("‚öôÔ∏è Features & Functionality")
    .setFontSize(16)
    .setFontWeight("bold")
    .setBackground(COLORS.UNION_GREEN)
    .setFontColor("white")
    .setVerticalAlignment("middle");
  sheet.setRowHeight(row, 35);

  const featureFAQs = [
    ["How does the grievance workflow feature work?", "Click on any member in the Member Directory, then go to 509 Tools > Grievance Tools > Start New Grievance. This opens a pre-filled Google Form with the member's information automatically populated. When submitted, the grievance is automatically added to the Grievance Log."],
    ["What are the Level 2 columns?", "Level 2 columns are advanced engagement tracking fields including: Last Virtual/In-Person Meeting dates, Survey dates, Email open rates, Volunteer hours, Interest in various actions, Communication preferences, Best contact times, and Steward contact notes. Use the menu toggle to show/hide these columns."],
    ["How do I hide/show grievance columns?", "Go to 509 Tools > View Options > Toggle Grievance Columns to show or hide grievance-related columns in the Member Directory. This helps focus on specific data when needed."],
    ["What is the Interactive Dashboard?", "The Interactive Dashboard (üéØ tab) lets you choose which metrics to display, select chart types (pie, donut, bar, line, column, area, or table), compare metrics side-by-side, and apply professional themes. It's fully customizable to your needs."]
  ];

  row++;
  row = addFAQSection(sheet, row, featureFAQs);

  // Troubleshooting
  row += 2;
  sheet.getRange(row, 1, 1, 3).merge()
    .setValue("üîß Troubleshooting")
    .setFontSize(16)
    .setFontWeight("bold")
    .setBackground(COLORS.SOLIDARITY_RED)
    .setFontColor("white")
    .setVerticalAlignment("middle");
  sheet.setRowHeight(row, 35);

  const troubleshootingFAQs = [
    ["Charts are not showing data", "Solution: Add at least one member to Member Directory and one grievance to Grievance Log, then run 509 Tools > Data Management > Rebuild Dashboard."],
    ["Deadlines are not calculating", "Solution: Ensure you entered the Incident Date (Column G) and Date Filed (Column I) in the Grievance Log. Then run 509 Tools > Data Management > Recalc All Grievances."],
    ["Member metrics are not updating", "Solution: Verify that Member IDs match between Member Directory and Grievance Log exactly. Then run 509 Tools > Data Management > Recalc All Members."],
    ["Dropdowns are not working", "Solution: Check that the ‚öôÔ∏è Config sheet exists and has data. If needed, run 509 Tools > Create Dashboard to rebuild, or go to 509 Tools > Utilities > Setup Triggers."],
    ["I'm getting permission errors", "Solution: Go to Extensions > Apps Script, click Run (‚ñ∂Ô∏è) > select any function, click Review Permissions, choose your Google account, click Advanced > Go to [Project Name], then click Allow."]
  ];

  row++;
  row = addFAQSection(sheet, row, troubleshootingFAQs);

  // CBA Compliance
  row += 2;
  sheet.getRange(row, 1, 1, 3).merge()
    .setValue("‚öñÔ∏è CBA Compliance & Deadlines")
    .setFontSize(16)
    .setFontWeight("bold")
    .setBackground(COLORS.ACCENT_PURPLE)
    .setFontColor("white")
    .setVerticalAlignment("middle");
  sheet.setRowHeight(row, 35);

  const cbaFAQs = [
    ["What deadlines does the system track?", "The system automatically tracks all Article 23A deadlines: 21 days from incident to file grievance, 30 days for Step I decision, 10 days to appeal to Step II, 30 days for Step II decision, 10 days to appeal to Step III, and 30 days for Step III decision."],
    ["What do the color codes mean?", "Green = More than 7 days until deadline (on track), Yellow = 0-7 days until deadline (due soon), Red = Past deadline (overdue), Dark Red = 30+ days overdue (urgent)."],
    ["How are grievance priorities determined?", "The system automatically assigns priorities: Step III = highest priority (1), Step II = priority 2, Step I = priority 3, then sorted by due date within each step."],
    ["Can I customize the deadlines?", "The deadlines are based on the CBA Article 23A and are set in the Config sheet's Timeline Rules Table. You can view them in the ‚öôÔ∏è Config tab starting at column O. To change them, you'd need to modify the CBA_DEADLINES constants in the script."]
  ];

  row++;
  row = addFAQSection(sheet, row, cbaFAQs);

  // GitHub & Development
  row += 2;
  sheet.getRange(row, 1, 1, 3).merge()
    .setValue("üíª GitHub & Development")
    .setFontSize(16)
    .setFontWeight("bold")
    .setBackground(COLORS.ACCENT_TEAL)
    .setFontColor("white")
    .setVerticalAlignment("middle");
  sheet.setRowHeight(row, 35);

  const githubFAQs = [
    ["Where is the GitHub repository?", "The repository is at https://github.com/Woop91/509-Dashboard. This is where you'll find the source code, documentation, guides, and can report issues or request features."],
    ["How do I report a bug or request a feature?", "Go to https://github.com/Woop91/509-Dashboard/issues and click 'New Issue'. Provide a clear description of the bug or feature request, including steps to reproduce if it's a bug."],
    ["Can I contribute to the project?", "Yes! The project is open for contributions. Visit the GitHub repository, fork it, make your changes, and submit a pull request. Please follow the contribution guidelines in the repository."],
    ["How do I update to the latest version?", "Check the GitHub repository's Releases page for the latest version. Download the updated .gs files and replace them in your Apps Script project via Extensions > Apps Script."]
  ];

  row++;
  row = addFAQSection(sheet, row, githubFAQs);

  // Additional Help
  row += 2;
  sheet.getRange(row, 1, 1, 3).merge()
    .setValue("Need more help?")
    .setFontSize(14)
    .setFontWeight("bold")
    .setBackground(COLORS.INFO_LIGHT)
    .setVerticalAlignment("middle")
    .setHorizontalAlignment("center");
  sheet.setRowHeight(row, 30);

  row++;
  sheet.getRange(row, 1, 1, 3).merge()
    .setValue("Check the üìö Getting Started tab for step-by-step guides, visit the GitHub repository for comprehensive documentation, or review the README.md file in the repository for detailed information about all features.")
    .setWrap(true)
    .setVerticalAlignment("middle")
    .setHorizontalAlignment("center")
    .setFontStyle("italic");
  sheet.setRowHeight(row, 60);

  // Freeze header row
  sheet.setFrozenRows(1);

  return sheet;
}

/**
 * Helper function to add FAQ section rows
 */
function addFAQSection(sheet, startRow, faqs) {
  let row = startRow;

  for (let i = 0; i < faqs.length; i++) {
    const faq = faqs[i];

    // Number
    sheet.getRange(row, 1)
      .setValue("Q" + (i + 1))
      .setFontWeight("bold")
      .setFontSize(12)
      .setBackground(COLORS.INFO_LIGHT)
      .setVerticalAlignment("top")
      .setHorizontalAlignment("center")
      .setBorder(true, true, true, true, false, false);

    // Question
    sheet.getRange(row, 2)
      .setValue(faq[0])
      .setFontWeight("bold")
      .setFontSize(11)
      .setVerticalAlignment("top")
      .setBorder(true, true, true, true, false, false)
      .setWrap(true);

    // Answer
    sheet.getRange(row, 3)
      .setValue(faq[1])
      .setWrap(true)
      .setVerticalAlignment("top")
      .setBorder(true, true, true, true, false, false);

    // Auto-adjust row height based on content
    const contentLength = faq[1].length;
    const estimatedHeight = Math.max(40, Math.min(150, Math.ceil(contentLength / 80) * 20));
    sheet.setRowHeight(row, estimatedHeight);

    row++;
  }

  return row;
}



// ================================================================================
// MODULE: GmailIntegration.gs
// Source: GmailIntegration.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * GMAIL INTEGRATION - Secure Email Communications
 * ------------------------------------------------------------------------====
 *
 * Send and receive grievance-related emails via Gmail with security controls.
 *
 * Features:
 * - Send PDFs directly from dashboard
 * - Email templates library
 * - Track communications
 * - Auto-log sent emails
 * - Compose emails with templates
 *
 * Security Features (v2.0):
 * - Role-based access control (Steward+ only)
 * - Email validation and whitelist checking
 * - Rate limiting to prevent spam
 * - HTML sanitization to prevent XSS
 * - Audit logging of all email sends
 * - Input validation
 *
 * @module GmailIntegration
 * @version 2.0.0
 * @author SEIU Local 509 Tech Team
 * ------------------------------------------------------------------------====
 */

/**
 * Column positions for the simplified Communications Log created by this module (1-indexed for spreadsheet, 0-indexed for arrays)
 *
 * NOTE: This is a simplified 5-column structure used by GmailIntegration.gs
 * It differs from the main COMM_LOG_COLS (7 columns) defined in Constants.gs
 * which is designed for a more comprehensive communication tracking system.
 *
 * This simplified structure focuses on basic email logging within grievances.
 *
 * @const {Object}
 */
const GMAIL_COMM_LOG_COLS = {
  TIMESTAMP: 0,      // Column A - When the communication occurred
  GRIEVANCE_ID: 1,   // Column B - Related grievance ID
  TYPE: 2,           // Column C - Communication type (e.g., "Email Sent")
  USER: 3,           // Column D - User who sent/logged the communication
  DETAILS: 4         // Column E - Full communication details/message body
};

/**
 * Shows email composition dialog for a grievance
 * Requires STEWARD role or higher
 *
 * @param {string} grievanceId - Optional grievance ID to pre-populate
 * @throws {Error} If user doesn't have STEWARD role
 */
function composeGrievanceEmail(grievanceId) {
  // Security: Require steward role
  try {
    requireRole('STEWARD', 'Compose Email');
  } catch (e) {
    showAccessDeniedDialog('Compose Email', 'STEWARD');
    return;
  }

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  let grievanceData = null;

  if (grievanceId) {
    const lastRow = grievanceSheet.getLastRow();
    const data = grievanceSheet.getRange(2, 1, lastRow - 1, GRIEVANCE_COLS.MEMBER_EMAIL).getValues();

    for (let i = 0; i < data.length; i++) {
      if (data[i][GRIEVANCE_COLS.GRIEVANCE_ID - 1] === grievanceId) {
        grievanceData = {
          id: data[i][GRIEVANCE_COLS.GRIEVANCE_ID - 1],
          memberName: `${data[i][GRIEVANCE_COLS.FIRST_NAME - 1]} ${data[i][GRIEVANCE_COLS.LAST_NAME - 1]}`,
          memberEmail: data[i][GRIEVANCE_COLS.MEMBER_EMAIL - 1] || '',
          steward: data[i][GRIEVANCE_COLS.STEWARD - 1] || '',
          issueType: data[i][GRIEVANCE_COLS.ISSUE_CATEGORY - 1] || '',
          status: data[i][GRIEVANCE_COLS.STATUS - 1] || ''
        };
        break;
      }
    }
  }

  const html = createEmailComposerHTML(grievanceData);
  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(800)
    .setHeight(700);

  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'üìß Compose Email');
}

/**
 * Creates HTML for email composer with sanitized data
 *
 * @param {Object} grievanceData - Grievance information (will be sanitized)
 * @returns {string} HTML content with sanitized values
 */
function createEmailComposerHTML(grievanceData) {
  const templates = getEmailTemplates();

  // Security: Sanitize all grievance data before embedding in HTML
  const sanitizedGrievanceData = grievanceData ? sanitizeObject(grievanceData) : null;

  return `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 {
      color: #1a73e8;
      margin-top: 0;
      border-bottom: 3px solid #1a73e8;
      padding-bottom: 10px;
    }
    .form-group {
      margin: 15px 0;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
      color: #333;
    }
    input[type="text"],
    input[type="email"],
    textarea,
    select {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #1a73e8;
    }
    textarea {
      min-height: 200px;
      font-family: Arial, sans-serif;
      resize: vertical;
    }
    .button-group {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    button {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
      flex: 1;
    }
    button:hover {
      background: #1557b0;
    }
    button.secondary {
      background: #6c757d;
    }
    button.secondary:hover {
      background: #5a6268;
    }
    .template-selector {
      margin: 10px 0;
    }
    .info-box {
      background: #e8f0fe;
      padding: 12px;
      border-radius: 4px;
      margin: 15px 0;
      border-left: 4px solid #1a73e8;
    }
    .checkbox-group {
      margin: 10px 0;
    }
    .checkbox-group label {
      display: inline;
      font-weight: normal;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìß Compose Email</h2>

    ${sanitizedGrievanceData ? `
    <div class="info-box">
      <strong>Grievance:</strong> ${sanitizedGrievanceData.id} - ${sanitizedGrievanceData.memberName}<br>
      <strong>Status:</strong> ${sanitizedGrievanceData.status} | <strong>Issue:</strong> ${sanitizedGrievanceData.issueType}
    </div>
    ` : ''}

    <div class="form-group template-selector">
      <label>Template (optional):</label>
      <select id="templateSelect" onchange="loadTemplate()">
        <option value="">-- Select a template --</option>
        ${templates.map(function(t) { return `<option value="${sanitizeHTML(t.id)}">${sanitizeHTML(t.name)}</option>`; }).join('')}
      </select>
    </div>

    <div class="form-group">
      <label>To:</label>
      <input type="email" id="toEmail" value="${sanitizedGrievanceData ? sanitizedGrievanceData.memberEmail : ''}" placeholder="recipient@example.com">
    </div>

    <div class="form-group">
      <label>CC (optional):</label>
      <input type="email" id="ccEmail" value="${sanitizedGrievanceData ? sanitizedGrievanceData.steward : ''}" placeholder="cc@example.com">
    </div>

    <div class="form-group">
      <label>Subject:</label>
      <input type="text" id="subject" value="${sanitizedGrievanceData ? `Re: Grievance ${sanitizedGrievanceData.id}` : ''}" placeholder="Email subject">
    </div>

    <div class="form-group">
      <label>Message:</label>
      <textarea id="message" placeholder="Type your message here..."></textarea>
    </div>

    <div class="checkbox-group">
      <input type="checkbox" id="attachPDF" ${grievanceData ? 'checked' : ''}>
      <label for="attachPDF">Attach grievance PDF report</label>
    </div>

    <div class="checkbox-group">
      <input type="checkbox" id="logCommunication" checked>
      <label for="logCommunication">Log this email in Communications Log</label>
    </div>

    <div class="button-group">
      <button onclick="sendEmail()">üì§ Send Email</button>
      <button class="secondary" onclick="google.script.host.close()">‚ùå Cancel</button>
    </div>

    <div id="status" style="margin-top: 15px; padding: 10px; display: none;"></div>
  </div>

  <script>
    const grievanceData = ${JSON.stringify(grievanceData)};
    const templates = ${JSON.stringify(templates)};

    function loadTemplate() {
      const templateId = document.getElementById('templateSelect').value;
      if (!templateId) return;

      const template = templates.find(function(t) { return t.id === templateId; });
      if (!template) return;

      document.getElementById('subject').value = template.subject || '';
      document.getElementById('message').value = replacePlaceholders(template.body || '');
    }

    function replacePlaceholders(text) {
      if (!grievanceData) return text;

      return text
        .replace(/\\{GRIEVANCE_ID\\}/g, grievanceData.id || '')
        .replace(/\\{MEMBER_NAME\\}/g, grievanceData.memberName || '')
        .replace(/\\{ISSUE_TYPE\\}/g, grievanceData.issueType || '')
        .replace(/\\{STATUS\\}/g, grievanceData.status || '');
    }

    function sendEmail() {
      const to = document.getElementById('toEmail').value.trim();
      const cc = document.getElementById('ccEmail').value.trim();
      const subject = document.getElementById('subject').value.trim();
      const message = document.getElementById('message').value.trim();
      const attachPDF = document.getElementById('attachPDF').checked;
      const logCommunication = document.getElementById('logCommunication').checked;

      if (!to || !subject || !message) {
        showStatus('Please fill in all required fields (To, Subject, Message)', 'error');
        return;
      }

      showStatus('Sending email...', 'info');

      const emailData = {
        to: to,
        cc: cc,
        subject: subject,
        message: message,
        attachPDF: attachPDF,
        logCommunication: logCommunication,
        grievanceId: grievanceData ? grievanceData.id : null
      };

      google.script.run
        .withSuccessHandler(onEmailSent)
        .withFailureHandler(onEmailError)
        .sendGrievanceEmail(emailData);
    }

    function onEmailSent(result) {
      showStatus('‚úÖ Email sent successfully!', 'success');
      setTimeout(function() {
        google.script.host.close();
      }, 2000);
    }

    function onEmailError(error) {
      showStatus('‚ùå Error: ' + error.message, 'error');
    }

    function showStatus(message, type) {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.style.display = 'block';
      statusDiv.style.background = type === 'error' ? '#f8d7da' : type === 'success' ? '#d4edda' : '#d1ecf1';
      statusDiv.style.color = type === 'error' ? '#721c24' : type === 'success' ? '#155724' : '#0c5460';
      statusDiv.style.border = '1px solid ' + (type === 'error' ? '#f5c6cb' : type === 'success' ? '#c3e6cb' : '#bee5eb');
      statusDiv.style.borderRadius = '4px';
    }
  </script>
</body>
</html>
  `;
}

/**
 * Sends email with optional PDF attachment
 * Includes comprehensive security checks:
 * - Role-based access control
 * - Email validation
 * - Whitelist verification
 * - Rate limiting
 * - Content length limits
 * - Audit logging
 *
 * @param {Object} emailData - Email information
 * @param {string} emailData.to - Recipient email
 * @param {string} emailData.cc - CC email (optional)
 * @param {string} emailData.subject - Email subject
 * @param {string} emailData.message - Email body
 * @param {boolean} emailData.attachPDF - Whether to attach PDF
 * @param {boolean} emailData.logCommunication - Whether to log
 * @param {string} emailData.grievanceId - Grievance ID (optional)
 * @returns {Object} {success: boolean, message: string}
 * @throws {Error} If security checks fail or sending fails
 */
function sendGrievanceEmail(emailData) {
  try {
    // Security Check 1: Require steward role
    requireRole('STEWARD', 'Send Email');

    // Security Check 2: Validate email addresses
    if (!isValidEmail(emailData.to)) {
      throw new Error('Invalid recipient email address');
    }

    if (emailData.cc && !isValidEmail(emailData.cc)) {
      throw new Error('Invalid CC email address');
    }

    // Security Check 3: Verify recipient is registered (whitelist)
    if (!isRegisteredEmail(emailData.to)) {
      throw new Error(
        'Security Error: Can only send emails to registered members in Member Directory. ' +
        'Please add the recipient to the Member Directory first.'
      );
    }

    // Security Check 4: Rate limiting (5 seconds between emails)
    enforceRateLimit('EMAIL_SEND', RATE_LIMITS.EMAIL_MIN_INTERVAL);

    // Security Check 5: Content length limits
    const subject = String(emailData.subject || '').substring(0, EMAIL_CONFIG.MAX_SUBJECT_LENGTH);
    const message = String(emailData.message || '').substring(0, EMAIL_CONFIG.MAX_BODY_LENGTH);

    if (!subject || !message) {
      throw new Error('Subject and message are required');
    }

    // Sanitize subject and message (defense in depth)
    const sanitizedSubject = sanitizeHTML(subject);
    const sanitizedMessage = sanitizeHTML(message);

    // Build email options
    const options = {
      to: emailData.to,
      subject: sanitizedSubject,
      body: sanitizedMessage,
      name: EMAIL_CONFIG.FROM_NAME
    };

    if (emailData.cc && isRegisteredEmail(emailData.cc)) {
      options.cc = emailData.cc;
    }

    if (EMAIL_CONFIG.REPLY_TO) {
      options.replyTo = EMAIL_CONFIG.REPLY_TO;
    }

    // Attach PDF if requested
    if (emailData.attachPDF && emailData.grievanceId && EMAIL_CONFIG.ATTACHMENTS_ENABLED) {
      try {
        const pdf = exportGrievanceToPDF(emailData.grievanceId);
        if (pdf) {
          options.attachments = [pdf];
        }
      } catch (pdfError) {
        Logger.log('Error attaching PDF: ' + pdfError.message);
        // Continue sending email without attachment
      }
    }

    // Send email
    MailApp.sendEmail(options);

    // Log communication if requested
    if (emailData.logCommunication && emailData.grievanceId) {
      logCommunication(
        emailData.grievanceId,
        'Email Sent',
        `To: ${emailData.to}\nSubject: ${sanitizedSubject}\n\n${sanitizedMessage}`
      );
    }

    // Security: Audit logging
    logAuditEvent('EMAIL_SENT', {
      to: emailData.to,
      cc: emailData.cc || 'none',
      grievanceId: emailData.grievanceId || 'none',
      attachedPDF: emailData.attachPDF || false,
      subjectLength: sanitizedSubject.length,
      messageLength: sanitizedMessage.length
    }, 'INFO');

    return {
      success: true,
      message: 'Email sent successfully'
    };

  } catch (error) {
    // Log error for debugging
    Logger.log('Error sending email: ' + error.message);

    // Security: Log failed email attempts
    logAuditEvent('EMAIL_SEND_FAILED', {
      to: emailData.to || 'unknown',
      error: error.message,
      grievanceId: emailData.grievanceId || 'none'
    }, 'WARNING');

    // Re-throw error for UI handling
    throw new Error('Failed to send email: ' + error.message);
  }
}

/**
 * Logs communication in the Communications Log sheet
 * @param {string} grievanceId - Grievance ID
 * @param {string} type - Communication type
 * @param {string} details - Communication details
 */
function logCommunication(grievanceId, type, details) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let commLog = ss.getSheetByName('üìû Communications Log');

  if (!commLog) {
    commLog = createCommunicationsLogSheet();
  }

  const timestamp = new Date();
  const user = Session.getActiveUser().getEmail() || 'System';

  const lastRow = commLog.getLastRow();
  // Row structure matches GMAIL_COMM_LOG_COLS: [timestamp, grievanceId, type, user, details]
  const newRow = [
    timestamp,      // GMAIL_COMM_LOG_COLS.TIMESTAMP (Column A)
    grievanceId,    // GMAIL_COMM_LOG_COLS.GRIEVANCE_ID (Column B)
    type,           // GMAIL_COMM_LOG_COLS.TYPE (Column C)
    user,           // GMAIL_COMM_LOG_COLS.USER (Column D)
    details         // GMAIL_COMM_LOG_COLS.DETAILS (Column E)
  ];

  commLog.getRange(lastRow + 1, 1, 1, 5).setValues([newRow]);
}

/**
 * Creates Communications Log sheet
 * Structure follows GMAIL_COMM_LOG_COLS (simplified 5-column format)
 * @returns {Sheet} Communications Log sheet
 */
function createCommunicationsLogSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  // Check if sheet already exists
  let sheet = ss.getSheetByName('üìû Communications Log');
  if (sheet) {
    return sheet; // Return existing sheet
  }

  sheet = ss.insertSheet('üìû Communications Log');

  // Set headers - Structure matches GMAIL_COMM_LOG_COLS
  const headers = [
    'Timestamp',      // Column A - GMAIL_COMM_LOG_COLS.TIMESTAMP
    'Grievance ID',   // Column B - GMAIL_COMM_LOG_COLS.GRIEVANCE_ID
    'Type',           // Column C - GMAIL_COMM_LOG_COLS.TYPE
    'User',           // Column D - GMAIL_COMM_LOG_COLS.USER
    'Details'         // Column E - GMAIL_COMM_LOG_COLS.DETAILS
  ];

  sheet.getRange(1, 1, 1, 5).setValues([headers]);

  // Format header
  sheet.getRange(1, 1, 1, 5)
    .setBackground('#1a73e8')
    .setFontColor('#ffffff')
    .setFontWeight('bold')
    .setHorizontalAlignment('center');

  // Set column widths
  sheet.setColumnWidth(1, 150); // Timestamp
  sheet.setColumnWidth(2, 120); // Grievance ID
  sheet.setColumnWidth(3, 120); // Type
  sheet.setColumnWidth(4, 200); // User
  sheet.setColumnWidth(5, 400); // Details

  // Freeze header
  sheet.setFrozenRows(1);

  return sheet;
}

/**
 * Gets email templates from configuration
 * @returns {Array} Array of template objects
 */
function getEmailTemplates() {
  return [
    {
      id: 'initial_acknowledgment',
      name: 'Initial Acknowledgment',
      subject: 'Re: Grievance {GRIEVANCE_ID} - Acknowledgment',
      body: `Dear {MEMBER_NAME},

This email confirms that we have received your grievance (ID: {GRIEVANCE_ID}) regarding {ISSUE_TYPE}.

Your case has been assigned to a steward who will contact you within 2-3 business days to discuss next steps.

Current Status: {STATUS}

If you have any questions or additional information to provide, please don't hesitate to contact us.

In solidarity,
SEIU Local 509`
    },
    {
      id: 'status_update',
      name: 'Status Update',
      subject: 'Grievance {GRIEVANCE_ID} - Status Update',
      body: `Dear {MEMBER_NAME},

I wanted to provide you with an update on your grievance (ID: {GRIEVANCE_ID}).

Current Status: {STATUS}

[Add specific update details here]

We will continue to keep you informed of any developments.

In solidarity,
SEIU Local 509`
    },
    {
      id: 'request_information',
      name: 'Request for Information',
      subject: 'Grievance {GRIEVANCE_ID} - Additional Information Needed',
      body: `Dear {MEMBER_NAME},

To proceed with your grievance (ID: {GRIEVANCE_ID}), we need some additional information:

[List the information needed here]

Please provide this information at your earliest convenience so we can continue processing your case.

Thank you for your cooperation.

In solidarity,
SEIU Local 509`
    },
    {
      id: 'resolution_notification',
      name: 'Resolution Notification',
      subject: 'Grievance {GRIEVANCE_ID} - Resolved',
      body: `Dear {MEMBER_NAME},

I'm pleased to inform you that your grievance (ID: {GRIEVANCE_ID}) has been resolved.

Resolution Details:
[Add resolution details here]

This case is now closed. If you have any questions about the resolution, please don't hesitate to contact us.

Thank you for your patience throughout this process.

In solidarity,
SEIU Local 509`
    },
    {
      id: 'meeting_invitation',
      name: 'Meeting Invitation',
      subject: 'Grievance {GRIEVANCE_ID} - Meeting Scheduled',
      body: `Dear {MEMBER_NAME},

We have scheduled a meeting to discuss your grievance (ID: {GRIEVANCE_ID}).

Date: [DATE]
Time: [TIME]
Location: [LOCATION]

Please confirm your attendance at your earliest convenience.

In solidarity,
SEIU Local 509`
    }
  ];
}

/**
 * Shows email template manager
 */
function showEmailTemplateManager() {
  const templates = getEmailTemplates();

  const html = `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: 'Roboto', Arial, sans-serif; padding: 20px; margin: 0; background: #f5f5f5; }
    .container { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h2 { color: #1a73e8; margin-top: 0; border-bottom: 3px solid #1a73e8; padding-bottom: 10px; }
    .template { background: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 4px; border-left: 4px solid #1a73e8; }
    .template h3 { margin-top: 0; color: #333; }
    .template-body { background: white; padding: 10px; border-radius: 4px; margin: 10px 0; font-size: 13px; white-space: pre-wrap; }
    .placeholders { background: #fff3cd; padding: 10px; border-radius: 4px; margin: 15px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìù Email Template Library</h2>

    <div class="placeholders">
      <strong>Available Placeholders:</strong><br>
      {GRIEVANCE_ID}, {MEMBER_NAME}, {ISSUE_TYPE}, {STATUS}
    </div>

    ${templates.map(function(t) { return `
      <div class="template">
        <h3>${t.name}</h3>
        <strong>Subject:</strong> ${t.subject}<br><br>
        <strong>Body:</strong>
        <div class="template-body">${t.body}</div>
      </div>
    `; }).join('')}
  </div>
</body>
</html>
  `;

  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(700)
    .setHeight(600);

  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'üìù Email Templates');
}

/**
 * Shows communication log for a specific grievance
 * @param {string} grievanceId - Grievance ID
 */
function showGrievanceCommunications(grievanceId) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const commLog = ss.getSheetByName('üìû Communications Log');

  if (!commLog) {
    SpreadsheetApp.getUi().alert('No communications logged yet.');
    return;
  }

  const lastRow = commLog.getLastRow();
  if (lastRow < 2) {
    SpreadsheetApp.getUi().alert('No communications logged for this grievance.');
    return;
  }

  const data = commLog.getRange(2, 1, lastRow - 1, 5).getValues();
  const grievanceComms = data.filter(function(row) { return row[GMAIL_COMM_LOG_COLS.GRIEVANCE_ID] === grievanceId; });

  if (grievanceComms.length === 0) {
    SpreadsheetApp.getUi().alert('No communications logged for this grievance.');
    return;
  }

  const commsList = grievanceComms
    .map(function(row) { return `
      <div style="background: #f8f9fa; padding: 12px; margin: 10px 0; border-radius: 4px; border-left: 4px solid #1a73e8;">
        <strong>${row[GMAIL_COMM_LOG_COLS.TYPE]}</strong> - ${row[GMAIL_COMM_LOG_COLS.TIMESTAMP].toLocaleString()}<br>
        <em>By: ${row[GMAIL_COMM_LOG_COLS.USER]}</em><br><br>
        <div style="white-space: pre-wrap; background: white; padding: 10px; border-radius: 4px;">${row[GMAIL_COMM_LOG_COLS.DETAILS]}</div>
      </div>
    `; })
    .join('');

  const html = `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: 'Roboto', Arial, sans-serif; padding: 20px; margin: 0; background: #f5f5f5; }
    .container { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-height: 500px; overflow-y: auto; }
    h2 { color: #1a73e8; margin-top: 0; border-bottom: 3px solid #1a73e8; padding-bottom: 10px; position: sticky; top: 0; background: white; }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìû Communications Log - ${grievanceId}</h2>
    ${commsList}
  </div>
</body>
</html>
  `;

  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(700)
    .setHeight(600);

  SpreadsheetApp.getUi().showModalDialog(htmlOutput, `Communications - ${grievanceId}`);
}



// ================================================================================
// MODULE: GoogleDriveIntegration.gs
// Source: GoogleDriveIntegration.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * GOOGLE DRIVE INTEGRATION
 * ------------------------------------------------------------------------====
 *
 * Attach and manage documents for grievances
 * Features:
 * - Link Drive folders to grievances
 * - Upload evidence and documents
 * - Auto-organize by grievance ID
 * - Version control
 * - Quick access to attachments
 */

/**
 * Extracts folder ID from a Google Drive folder URL
 * @param {string} url - The Google Drive folder URL
 * @returns {string|null} The folder ID or null if not found
 */
function extractFolderIdFromUrl(url) {
  if (!url) return null;

  // Handle format: https://drive.google.com/drive/folders/FOLDER_ID
  const folderMatch = url.match(/\/folders\/([a-zA-Z0-9_-]+)/);
  if (folderMatch) {
    return folderMatch[1];
  }

  // Handle format: https://drive.google.com/drive/u/0/folders/FOLDER_ID
  const altMatch = url.match(/\/folders\/([a-zA-Z0-9_-]+)/);
  if (altMatch) {
    return altMatch[1];
  }

  // If URL is just the folder ID itself (for backward compatibility)
  if (/^[a-zA-Z0-9_-]+$/.test(url)) {
    return url;
  }

  return null;
}

/**
 * Creates root folder for 509 Dashboard in Google Drive
 * @returns {Folder} Root folder
 */
function createRootFolder() {
  const folderName = '509 Dashboard - Grievance Files';

  // Check if folder already exists
  const existingFolders = DriveApp.getFoldersByName(folderName);
  if (existingFolders.hasNext()) {
    return existingFolders.next();
  }

  // Create new folder
  const folder = DriveApp.createFolder(folderName);

  Logger.log(`Created root folder: ${folderName}`);
  return folder;
}

/**
 * Creates folder for a specific grievance
 * @param {string} grievanceId - Grievance ID
 * @param {string} grievantName - Optional grievant name for folder naming
 * @returns {Folder} Grievance folder
 */
function createGrievanceFolder(grievanceId, grievantName) {
  const rootFolder = createRootFolder();

  // Create folder name with grievant name if provided
  let folderName = `Grievance_${grievanceId}`;
  if (grievantName) {
    folderName = `Grievance_${grievanceId}_${grievantName}`;
  }

  // Check if grievance folder already exists
  const existingFolders = rootFolder.getFoldersByName(folderName);

  if (existingFolders.hasNext()) {
    return existingFolders.next();
  }

  // Create new grievance folder
  const folder = rootFolder.createFolder(folderName);

  // Create subfolders
  folder.createFolder('Evidence');
  folder.createFolder('Correspondence');
  folder.createFolder('Forms');
  folder.createFolder('Other');

  Logger.log(`Created folder structure for ${grievanceId}`);
  return folder;
}

/**
 * Links Drive folder to grievance in spreadsheet
 * @param {string} grievanceId - Grievance ID
 * @param {string} folderId - Drive folder ID
 */
function linkFolderToGrievance(grievanceId, folderId) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!grievanceSheet) {
    throw new Error('Grievance Log sheet not found');
  }

  const lastRow = grievanceSheet.getLastRow();
  const data = grievanceSheet.getRange(2, 1, lastRow - 1, 1).getValues();

  for (let i = 0; i < data.length; i++) {
    if (data[i][0] === grievanceId) {
      const row = i + 2;

      // Store folder ID (Column AC / DRIVE_FOLDER_ID)
      grievanceSheet.getRange(row, GRIEVANCE_COLS.DRIVE_FOLDER_ID).setValue(folderId);

      // Create hyperlink to folder (Column AD / DRIVE_FOLDER_URL)
      const folderUrl = `https://drive.google.com/drive/folders/${folderId}`;
      grievanceSheet.getRange(row, GRIEVANCE_COLS.DRIVE_FOLDER_URL).setValue(folderUrl);

      Logger.log(`Linked folder ${folderId} to grievance ${grievanceId}`);
      return;
    }
  }

  throw new Error(`Grievance ${grievanceId} not found`);
}

/**
 * Sets up Drive folder for selected grievance
 */
function setupDriveFolderForGrievance() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const activeSheet = ss.getActiveSheet();

  if (activeSheet.getName() !== SHEETS.GRIEVANCE_LOG) {
    ui.alert(
      '‚ö†Ô∏è Wrong Sheet',
      'Please select a grievance row in the Grievance Log sheet.',
      ui.ButtonSet.OK
    );
    return;
  }

  const activeRow = activeSheet.getActiveCell().getRow();

  if (activeRow < 2) {
    ui.alert(
      '‚ö†Ô∏è Invalid Selection',
      'Please select a grievance row (not the header).',
      ui.ButtonSet.OK
    );
    return;
  }

  const grievanceId = activeSheet.getRange(activeRow, GRIEVANCE_COLS.GRIEVANCE_ID).getValue();

  if (!grievanceId) {
    ui.alert(
      '‚ö†Ô∏è No Grievance ID',
      'Selected row does not have a grievance ID.',
      ui.ButtonSet.OK
    );
    return;
  }

  const response = ui.alert(
    'üìÅ Setup Drive Folder',
    `Create a Google Drive folder for grievance ${grievanceId}?\n\n` +
    'This will create a folder with subfolders for:\n' +
    '‚Ä¢ Evidence\n' +
    '‚Ä¢ Correspondence\n' +
    '‚Ä¢ Forms\n' +
    '‚Ä¢ Other\n\n' +
    'Continue?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return;
  }

  try {
    SpreadsheetApp.getActiveSpreadsheet().toast('üìÅ Creating folder...', 'Please wait', -1);

    const folder = createGrievanceFolder(grievanceId);
    linkFolderToGrievance(grievanceId, folder.getId());

    ui.alert(
      '‚úÖ Folder Created',
      `Drive folder created successfully for ${grievanceId}.\n\n` +
      `Folder link has been added to the grievance record.\n\n` +
      `Click the link in column AC (Drive Folder Link) to open the folder.`,
      ui.ButtonSet.OK
    );

  } catch (error) {
    ui.alert('‚ùå Error: ' + error.message);
  }
}

/**
 * Shows file upload dialog for a grievance
 */
function showFileUploadDialog() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const activeSheet = ss.getActiveSheet();

  if (activeSheet.getName() !== SHEETS.GRIEVANCE_LOG) {
    ui.alert(
      '‚ö†Ô∏è Wrong Sheet',
      'Please select a grievance row in the Grievance Log sheet.',
      ui.ButtonSet.OK
    );
    return;
  }

  const activeRow = activeSheet.getActiveCell().getRow();

  if (activeRow < 2) {
    ui.alert(
      '‚ö†Ô∏è Invalid Selection',
      'Please select a grievance row (not the header).',
      ui.ButtonSet.OK
    );
    return;
  }

  const grievanceId = activeSheet.getRange(activeRow, GRIEVANCE_COLS.GRIEVANCE_ID).getValue();

  if (!grievanceId) {
    ui.alert(
      '‚ö†Ô∏è No Grievance ID',
      'Selected row does not have a grievance ID.',
      ui.ButtonSet.OK
    );
    return;
  }

  // Get or create folder
  let folder;
  try {
    folder = createGrievanceFolder(grievanceId);
    linkFolderToGrievance(grievanceId, folder.getId());
  } catch (error) {
    ui.alert('‚ùå Error: ' + error.message);
    return;
  }

  const html = createFileUploadHTML(grievanceId, folder.getId());
  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(650)
    .setHeight(500);

  ui.showModalDialog(htmlOutput, `üìé Upload Files - ${grievanceId}`);
}

/**
 * Creates HTML for file upload interface
 * @param {string} grievanceId - Grievance ID
 * @param {string} folderId - Drive folder ID
 * @returns {string} HTML content
 */
function createFileUploadHTML(grievanceId, folderId) {
  const folderUrl = `https://drive.google.com/drive/folders/${folderId}`;

  return `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 {
      color: #1a73e8;
      margin-top: 0;
      border-bottom: 3px solid #1a73e8;
      padding-bottom: 10px;
    }
    .info-box {
      background: #e8f0fe;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
      border-left: 4px solid #1a73e8;
    }
    .folder-link {
      background: #1a73e8;
      color: white;
      padding: 12px 20px;
      border-radius: 4px;
      text-decoration: none;
      display: inline-block;
      margin: 15px 0;
    }
    .folder-link:hover {
      background: #1557b0;
    }
    .instructions {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
    }
    .instructions h3 {
      margin-top: 0;
      color: #333;
    }
    .instructions ol {
      margin: 10px 0;
      padding-left: 20px;
    }
    .instructions li {
      margin: 8px 0;
      color: #666;
    }
    .category-list {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 15px 0;
    }
    .category {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 4px;
      border-left: 3px solid #1a73e8;
    }
    .category strong {
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìé Upload Files</h2>

    <div class="info-box">
      <strong>Grievance:</strong> ${grievanceId}<br>
      <strong>Drive Folder:</strong> Created and linked
    </div>

    <a href="${folderUrl}" target="_blank" class="folder-link">
      üìÅ Open Drive Folder
    </a>

    <div class="instructions">
      <h3>How to Upload Files</h3>
      <ol>
        <li>Click "Open Drive Folder" above to open the folder in Google Drive</li>
        <li>Navigate to the appropriate subfolder:
          <div class="category-list">
            <div class="category"><strong>üìÑ Evidence</strong><br>Photos, documents, proof</div>
            <div class="category"><strong>‚úâÔ∏è Correspondence</strong><br>Emails, letters</div>
            <div class="category"><strong>üìã Forms</strong><br>Signed forms, contracts</div>
            <div class="category"><strong>üìé Other</strong><br>Miscellaneous files</div>
          </div>
        </li>
        <li>Drag and drop files or click "New" ‚Üí "File upload"</li>
        <li>All files are automatically organized and linked to this grievance</li>
      </ol>
    </div>

    <div class="info-box" style="background: #fff3cd; border-left-color: #ffc107;">
      <strong>üí° Tip:</strong> Files are automatically versioned in Drive. If you upload a file with the same name, Drive will keep both versions.
    </div>
  </div>
</body>
</html>
  `;
}

/**
 * Shows files attached to a grievance
 */
function showGrievanceFiles() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const activeSheet = ss.getActiveSheet();

  if (activeSheet.getName() !== SHEETS.GRIEVANCE_LOG) {
    ui.alert(
      '‚ö†Ô∏è Wrong Sheet',
      'Please select a grievance row in the Grievance Log sheet.',
      ui.ButtonSet.OK
    );
    return;
  }

  const activeRow = activeSheet.getActiveCell().getRow();

  if (activeRow < 2) {
    ui.alert(
      '‚ö†Ô∏è Invalid Selection',
      'Please select a grievance row (not the header).',
      ui.ButtonSet.OK
    );
    return;
  }

  const grievanceId = activeSheet.getRange(activeRow, GRIEVANCE_COLS.GRIEVANCE_ID).getValue();
  const folderId = activeSheet.getRange(activeRow, GRIEVANCE_COLS.DRIVE_FOLDER_ID).getValue();

  if (!folderId) {
    ui.alert(
      '‚ÑπÔ∏è No Folder Linked',
      `No Drive folder has been set up for ${grievanceId}.\n\n` +
      'Use "Setup Drive Folder" to create one.',
      ui.ButtonSet.OK
    );
    return;
  }

  try {
    const folder = DriveApp.getFolderById(folderId);
    const files = listFolderFiles(folder);

    if (files.length === 0) {
      ui.alert(
        '‚ÑπÔ∏è No Files',
        `No files have been uploaded to the folder for ${grievanceId}.`,
        ui.ButtonSet.OK
      );
      return;
    }

    const html = createFileListHTML(grievanceId, folderId, files);
    const htmlOutput = HtmlService.createHtmlOutput(html)
      .setWidth(700)
      .setHeight(600);

    ui.showModalDialog(htmlOutput, `üìÅ Files - ${grievanceId}`);

  } catch (error) {
    ui.alert('‚ùå Error: ' + error.message);
  }
}

/**
 * Lists all files in a folder recursively
 * @param {Folder} folder - Drive folder
 * @param {string} path - Current path (for recursion)
 * @returns {Array} Array of file objects
 */
function listFolderFiles(folder, path = '') {
  const files = [];

  // Get files in current folder
  const fileIterator = folder.getFiles();
  while (fileIterator.hasNext()) {
    const file = fileIterator.next();
    files.push({
      name: file.getName(),
      url: file.getUrl(),
      size: formatFileSize(file.getSize()),
      modified: file.getLastUpdated().toLocaleString(),
      path: path,
      type: file.getMimeType()
    });
  }

  // Recursively get files from subfolders
  const folderIterator = folder.getFolders();
  while (folderIterator.hasNext()) {
    const subfolder = folderIterator.next();
    const subfolderName = subfolder.getName();
    const subfiles = listFolderFiles(subfolder, path ? `${path}/${subfolderName}` : subfolderName);
    files.push(...subfiles);
  }

  return files;
}

/**
 * Formats file size in human-readable format
 * @param {number} bytes - File size in bytes
 * @returns {string} Formatted size
 */
function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';

  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));

  return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
}

/**
 * Creates HTML for file list display
 * @param {string} grievanceId - Grievance ID
 * @param {string} folderId - Drive folder ID
 * @param {Array} files - Array of file objects
 * @returns {string} HTML content
 */
function createFileListHTML(grievanceId, folderId, files) {
  const folderUrl = `https://drive.google.com/drive/folders/${folderId}`;

  const filesList = files
    .map(function(file) { return `
      <div class="file-item">
        <div class="file-icon">${getFileIcon(file.type)}</div>
        <div class="file-details">
          <div class="file-name">
            <a href="${file.url}" target="_blank">${file.name}</a>
          </div>
          <div class="file-meta">
            ${file.path ? `${file.path} ‚Ä¢ ` : ''}${file.size} ‚Ä¢ Modified: ${file.modified}
          </div>
        </div>
      </div>
    `; })
    .join('');

  return `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 {
      color: #1a73e8;
      margin-top: 0;
      border-bottom: 3px solid #1a73e8;
      padding-bottom: 10px;
    }
    .summary {
      background: #e8f0fe;
      padding: 12px;
      border-radius: 4px;
      margin: 15px 0;
      border-left: 4px solid #1a73e8;
    }
    .file-item {
      display: flex;
      align-items: center;
      padding: 12px;
      margin: 10px 0;
      background: #f8f9fa;
      border-radius: 4px;
      border-left: 3px solid #1a73e8;
    }
    .file-item:hover {
      background: #e9ecef;
    }
    .file-icon {
      font-size: 24px;
      margin-right: 15px;
    }
    .file-details {
      flex: 1;
    }
    .file-name a {
      color: #1a73e8;
      text-decoration: none;
      font-weight: 500;
    }
    .file-name a:hover {
      text-decoration: underline;
    }
    .file-meta {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
    .folder-link {
      background: #1a73e8;
      color: white;
      padding: 10px 20px;
      border-radius: 4px;
      text-decoration: none;
      display: inline-block;
      margin: 15px 0;
    }
    .folder-link:hover {
      background: #1557b0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìÅ Attached Files - ${grievanceId}</h2>

    <div class="summary">
      <strong>Total Files:</strong> ${files.length}
    </div>

    <a href="${folderUrl}" target="_blank" class="folder-link">
      üìÅ Open Folder in Drive
    </a>

    <div style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
      ${filesList}
    </div>
  </div>
</body>
</html>
  `;
}

/**
 * Gets emoji icon for file type
 * @param {string} mimeType - MIME type
 * @returns {string} Emoji icon
 */
function getFileIcon(mimeType) {
  if (mimeType.includes('image')) return 'üñºÔ∏è';
  if (mimeType.includes('pdf')) return 'üìÑ';
  if (mimeType.includes('word') || mimeType.includes('document')) return 'üìù';
  if (mimeType.includes('sheet') || mimeType.includes('excel')) return 'üìä';
  if (mimeType.includes('presentation')) return 'üìΩÔ∏è';
  if (mimeType.includes('video')) return 'üé•';
  if (mimeType.includes('audio')) return 'üéµ';
  if (mimeType.includes('zip') || mimeType.includes('compressed')) return 'üóúÔ∏è';
  return 'üìé';
}

/**
 * Batch creates folders for all grievances without them
 */
function batchCreateGrievanceFolders() {
  const ui = SpreadsheetApp.getUi();

  const response = ui.alert(
    'üìÅ Batch Create Folders',
    'This will create Drive folders for all grievances that don\'t have one.\n\n' +
    'This may take a few minutes for large datasets.\n\n' +
    'Continue?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return;
  }

  try {
    SpreadsheetApp.getActiveSpreadsheet().toast('üìÅ Creating folders...', 'Please wait', -1);

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
    const lastRow = grievanceSheet.getLastRow();

    if (lastRow < 2) {
      ui.alert('No grievances found.');
      return;
    }

    const data = grievanceSheet.getRange(2, 1, lastRow - 1, GRIEVANCE_COLS.DRIVE_FOLDER_URL).getValues();
    let created = 0;
    let skipped = 0;

    data.forEach((row, index) => {
      const grievanceId = row[0];
      const folderId = row[GRIEVANCE_COLS.DRIVE_FOLDER_ID - 1]; // Column AC (0-indexed array)

      if (!grievanceId) {
        skipped++;
        return;
      }

      if (folderId) {
        skipped++;
        return;
      }

      try {
        const folder = createGrievanceFolder(grievanceId);
        linkFolderToGrievance(grievanceId, folder.getId());
        created++;

        // Progress update every 10 folders
        if (created % 10 === 0) {
          SpreadsheetApp.getActiveSpreadsheet().toast(
            `Created ${created} folders...`,
            'Progress',
            -1
          );
        }
      } catch (error) {
        Logger.log(`Error creating folder for ${grievanceId}: ${error.message}`);
      }
    });

    ui.alert(
      '‚úÖ Batch Folder Creation Complete',
      `Created ${created} new folders.\n` +
      `Skipped ${skipped} grievances (already had folders or no ID).`,
      ui.ButtonSet.OK
    );

  } catch (error) {
    ui.alert('‚ùå Error: ' + error.message);
  }
}



// ================================================================================
// MODULE: GracefulDegradation.gs
// Source: GracefulDegradation.gs
// ================================================================================

/****************************************************
 * GRACEFUL DEGRADATION FRAMEWORK
 * Phase 6 - High Priority
 *
 * System remains partially functional during failures
 * Provides fallback mechanisms for critical operations
 *
 * Based on ADDITIONAL_ENHANCEMENTS.md Phase 2
 ****************************************************/

/**
 * Execute operation with graceful degradation
 * Tries primary function, falls back to secondary, then minimal
 *
 * @param {Function} primaryFn - Primary function to try
 * @param {Function} fallbackFn - Fallback function if primary fails
 * @param {Function} minimalFn - Minimal function as last resort
 * @returns {*} Result from whichever function succeeds
 */
function withGracefulDegradation(primaryFn, fallbackFn, minimalFn) {
  const errors = [];

  // Validate that all parameters are functions
  if (typeof primaryFn !== 'function') {
    throw new Error('primaryFn must be a function');
  }
  if (typeof fallbackFn !== 'function') {
    throw new Error('fallbackFn must be a function');
  }
  if (typeof minimalFn !== 'function') {
    throw new Error('minimalFn must be a function');
  }

  // Try primary function
  try {
    Logger.log('Attempting primary function...');
    const result = primaryFn();
    Logger.log('‚úÖ Primary function succeeded');
    return result;

  } catch (primaryError) {
    Logger.log(`‚ö†Ô∏è Primary function failed: ${primaryError.message}`);
    errors.push({ level: 'primary', error: primaryError });

    // Try fallback function
    try {
      Logger.log('Attempting fallback function...');
      const result = fallbackFn();
      Logger.log('‚úÖ Fallback function succeeded');

      // Log that we had to use fallback
      if (typeof logError === 'function') {
        logError(primaryError, 'GracefulDegradation.primary', 'WARNING');
      }

      return result;

    } catch (fallbackError) {
      Logger.log(`‚ö†Ô∏è Fallback function failed: ${fallbackError.message}`);
      errors.push({ level: 'fallback', error: fallbackError });

      // Try minimal function as last resort
      try {
        Logger.log('Attempting minimal function...');
        const result = minimalFn();
        Logger.log('‚úÖ Minimal function succeeded');

        // Log that we had to use minimal
        if (typeof logError === 'function') {
          logError(fallbackError, 'GracefulDegradation.fallback', 'ERROR');
        }

        return result;

      } catch (minimalError) {
        Logger.log(`‚ùå Minimal function failed: ${minimalError.message}`);
        errors.push({ level: 'minimal', error: minimalError });

        // All functions failed - log critical error
        if (typeof logError === 'function') {
          logError(
            new Error(`All degradation levels failed: ${errors.map(function(e) { return e.error.message; }).join('; ')}`),
            'GracefulDegradation.complete_failure',
            'CRITICAL'
          );
        }

        // Throw aggregate error
        throw new Error(
          `Complete failure - all degradation levels failed:\n` +
          errors.map(function(e) { return `${e.level}: ${e.error.message}`; }).join('\n')
        );
      }
    }
  }
}

/**
 * Rebuild dashboard with graceful degradation
 * Primary: Full rebuild with all charts
 * Fallback: Rebuild with minimal charts (KPIs only)
 * Minimal: Show cached dashboard or basic metrics
 */
function rebuildDashboardSafe() {
  return withGracefulDegradation(
    // Primary: Full rebuild (optimized if available)
    function() {
      if (typeof rebuildDashboardOptimized === 'function') {
        return rebuildDashboardOptimized();
      } else if (typeof rebuildDashboard === 'function') {
        return rebuildDashboard();
      }
      throw new Error('No rebuild function available');
    },

    // Fallback: Minimal rebuild (KPIs only, no charts)
    function() {
      return rebuildDashboardMinimal();
    },

    // Minimal: Show cached dashboard
    function() {
      return showCachedDashboard();
    }
  );
}

/**
 * Rebuild dashboard with minimal features (KPIs only)
 * Used as fallback when full rebuild fails
 */
function rebuildDashboardMinimal() {
  Logger.log('Building minimal dashboard (KPIs only)...');

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const dashboard = ss.getSheetByName(SHEETS.DASHBOARD);

  if (!dashboard) {
    throw new Error('Dashboard sheet not found');
  }

  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!memberSheet || !grievanceSheet) {
    throw new Error('Required sheets not found');
  }

  try {
    // Clear existing content
    dashboard.clear();

    // Set basic title
    dashboard.getRange('A1').setValue('509 Dashboard - Minimal Mode');
    dashboard.getRange('A2').setValue('(Limited functionality due to system issues)');

    // Calculate basic KPIs
    const memberData = memberSheet.getDataRange().getValues();
    const grievanceData = grievanceSheet.getDataRange().getValues();

    const totalMembers = memberData.length - 1;
    const totalGrievances = grievanceData.length - 1;

    // Count open grievances using GRIEVANCE_COLS.STATUS constant
    let openGrievances = 0;
    for (let i = 1; i < grievanceData.length; i++) {
      if (grievanceData[i][GRIEVANCE_COLS.STATUS - 1] === 'Open') {
        openGrievances++;
      }
    }

    // Display KPIs
    dashboard.getRange('A4').setValue('Total Members:');
    dashboard.getRange('B4').setValue(totalMembers);

    dashboard.getRange('A5').setValue('Total Grievances:');
    dashboard.getRange('B5').setValue(totalGrievances);

    dashboard.getRange('A6').setValue('Open Grievances:');
    dashboard.getRange('B6').setValue(openGrievances);

    dashboard.getRange('A8').setValue('Last Updated:');
    dashboard.getRange('B8').setValue(new Date());

    Logger.log('‚úÖ Minimal dashboard built successfully');

    return {
      mode: 'minimal',
      message: 'Dashboard rebuilt with minimal features',
      kpis: {
        members: totalMembers,
        grievances: totalGrievances,
        open: openGrievances
      }
    };

  } catch (error) {
    Logger.log(`‚ùå Minimal dashboard build failed: ${error.message}`);
    throw error;
  }
}

/**
 * Show cached dashboard data
 * Last resort fallback - displays last known good state
 */
function showCachedDashboard() {
  Logger.log('Attempting to show cached dashboard...');

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const dashboard = ss.getSheetByName(SHEETS.DASHBOARD);

  if (!dashboard) {
    throw new Error('Dashboard sheet not found');
  }

  // Check if we have cached data
  const cache = CacheService.getScriptCache();
  const cachedData = cache.get('dashboard_snapshot');

  if (!cachedData) {
    // No cached data - show error message
    dashboard.clear();
    dashboard.getRange('A1').setValue('Dashboard Unavailable');
    dashboard.getRange('A2').setValue('No cached data available. Please contact administrator.');

    return {
      mode: 'error',
      message: 'No cached dashboard data available'
    };
  }

  try {
    // Restore cached data
    const data = JSON.parse(cachedData);

    dashboard.clear();
    dashboard.getRange('A1').setValue('509 Dashboard - Cached Data');
    dashboard.getRange('A2').setValue(`(Showing data from: ${data.timestamp})`);

    // Display cached KPIs
    dashboard.getRange('A4').setValue('Total Members:');
    dashboard.getRange('B4').setValue(data.kpis.members);

    dashboard.getRange('A5').setValue('Total Grievances:');
    dashboard.getRange('B5').setValue(data.kpis.grievances);

    dashboard.getRange('A6').setValue('Open Grievances:');
    dashboard.getRange('B6').setValue(data.kpis.open);

    Logger.log('‚úÖ Cached dashboard displayed');

    return {
      mode: 'cached',
      message: 'Displayed cached dashboard',
      timestamp: data.timestamp
    };

  } catch (error) {
    Logger.log(`‚ùå Failed to show cached dashboard: ${error.message}`);
    throw error;
  }
}

/**
 * Cache current dashboard state
 * Call this after successful dashboard rebuild
 */
function cacheDashboardState() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
    const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

    if (!memberSheet || !grievanceSheet) {
      return;
    }

    const memberData = memberSheet.getDataRange().getValues();
    const grievanceData = grievanceSheet.getDataRange().getValues();

    const totalMembers = memberData.length - 1;
    const totalGrievances = grievanceData.length - 1;

    let openGrievances = 0;
    for (let i = 1; i < grievanceData.length; i++) {
      if (grievanceData[i][GRIEVANCE_COLS.STATUS - 1] === 'Open') {
        openGrievances++;
      }
    }

    const snapshot = {
      timestamp: new Date().toISOString(),
      kpis: {
        members: totalMembers,
        grievances: totalGrievances,
        open: openGrievances
      }
    };

    const cache = CacheService.getScriptCache();
    cache.put('dashboard_snapshot', JSON.stringify(snapshot), 21600); // 6 hours

    Logger.log('Dashboard state cached successfully');

  } catch (error) {
    Logger.log(`Failed to cache dashboard state: ${error.message}`);
  }
}

/**
 * Recalculate members with graceful degradation
 */
function recalcMembersSafe() {
  return withGracefulDegradation(
    // Primary: Batched recalculation
    function() {
      if (typeof recalcAllMembers === 'function') {
        return recalcAllMembers();
      }
      throw new Error('recalcAllMembers not available');
    },

    // Fallback: Recalculate just grievance status fields
    function() {
      return recalcMembersGrievanceFieldsOnly();
    },

    // Minimal: Skip recalculation, return success
    function() {
      Logger.log('Skipping member recalculation (minimal mode)');
      return { mode: 'minimal', message: 'Recalculation skipped' };
    }
  );
}

/**
 * Recalculate only grievance-related fields in Member Directory
 * Used as fallback when full recalculation fails
 */
function recalcMembersGrievanceFieldsOnly() {
  Logger.log('Recalculating members (grievance fields only)...');

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!memberSheet || !grievanceSheet) {
    throw new Error('Required sheets not found');
  }

  const memberData = memberSheet.getDataRange().getValues();
  const grievanceData = grievanceSheet.getDataRange().getValues();

  const updates = [];

  // For each member, find their open grievances
  for (let i = 1; i < memberData.length; i++) {
    const memberID = memberData[i][MEMBER_COLS.MEMBER_ID - 1];
    let hasOpen = 'No';
    let status = '';
    let deadline = '';

    // Find grievances for this member
    for (let j = 1; j < grievanceData.length; j++) {
      if (grievanceData[j][GRIEVANCE_COLS.MEMBER_ID - 1] === memberID &&
          grievanceData[j][GRIEVANCE_COLS.STATUS - 1] === 'Open') {
        hasOpen = 'Yes';
        status = grievanceData[j][GRIEVANCE_COLS.STATUS - 1];
        deadline = grievanceData[j][GRIEVANCE_COLS.NEXT_ACTION_DUE - 1] || '';
        break;
      }
    }

    updates.push([hasOpen, status, deadline]);
  }

  // Update Has Open Grievance (AB), Grievance Status (AC), Next Deadline (AD)
  if (updates.length > 0) {
    memberSheet.getRange(2, MEMBER_COLS.HAS_OPEN_GRIEVANCE, updates.length, 3).setValues(updates);
  }

  Logger.log(`‚úÖ Updated grievance fields for ${updates.length} members`);

  return {
    mode: 'partial',
    updated: updates.length,
    message: 'Updated grievance fields only'
  };
}

/**
 * Seed data with graceful degradation
 */
function seedDataSafe() {
  return withGracefulDegradation(
    // Primary: Full seed with rollback protection
    function() {
      if (typeof seedAllWithRollback === 'function') {
        return seedAllWithRollback();
      }
      throw new Error('seedAllWithRollback not available');
    },

    // Fallback: Seed without rollback protection
    function() {
      Logger.log('Seeding without rollback protection...');
      if (typeof SEED_20K_MEMBERS === 'function') {
        SEED_20K_MEMBERS();
      }
      if (typeof SEED_5K_GRIEVANCES === 'function') {
        SEED_5K_GRIEVANCES();
      }
      return { mode: 'no-rollback', message: 'Seeded without rollback' };
    },

    // Minimal: Skip seeding
    function() {
      return { mode: 'skipped', message: 'Seeding skipped due to errors' };
    }
  );
}

/**
 * Menu function to rebuild dashboard safely
 */
function REBUILD_DASHBOARD_SAFE() {
  const ui = SpreadsheetApp.getUi();

  try {
    ui.alert('Rebuilding dashboard with graceful degradation...');

    const result = rebuildDashboardSafe();

    let message;
    if (result.mode === 'minimal') {
      message = 'Dashboard rebuilt in MINIMAL mode.\n\n' +
                'Only basic KPIs are displayed.\n\n' +
                'Please check system logs for errors.';
    } else if (result.mode === 'cached') {
      message = 'Displaying CACHED dashboard.\n\n' +
                `Data from: ${result.timestamp}\n\n` +
                'Current rebuild failed. Please check system logs.';
    } else {
      message = 'Dashboard rebuilt successfully!';
    }

    ui.alert('Dashboard Rebuild Complete', message, ui.ButtonSet.OK);

  } catch (error) {
    ui.alert(
      'Dashboard Rebuild Failed',
      `All rebuild attempts failed:\n\n${error.message}`,
      ui.ButtonSet.OK
    );
  }
}



// ================================================================================
// MODULE: GrievanceFloatToggle.gs
// Source: GrievanceFloatToggle.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * GRIEVANCE FLOAT/SORT TOGGLE
 * ------------------------------------------------------------------------====
 *
 * Float Feature:
 * - When enabled, sends closed/settled/inactive grievances to bottom
 * - Prioritizes by step: Step 3 > Step 2 > Step 1 (most to least important)
 * - Within each step, prioritizes by soonest due date
 *
 * Features:
 * - Toggle on/off via button or menu
 * - Smart sorting algorithm
 * - Preserves original data
 * - Visual feedback
 */

/**
 * Gets the grievance float toggle state from user settings
 * @returns {boolean} True if float is enabled
 */
function getGrievanceFloatState() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const settingsSheet = ss.getSheetByName('User Settings');

    if (!settingsSheet) {
      return false;
    }

    // Check for saved setting in User Settings sheet
    const settingsData = settingsSheet.getDataRange().getValues();
    for (let i = 0; i < settingsData.length; i++) {
      if (settingsData[i][0] === 'grievanceFloatEnabled') {
        return settingsData[i][1] === true || settingsData[i][1] === 'TRUE' || settingsData[i][1] === 'true';
      }
    }

    return false;
  } catch (error) {
    Logger.log('Error getting float state: ' + error);
    return false;
  }
}

/**
 * Sets the grievance float toggle state
 * @param {boolean} enabled - Whether float is enabled
 */
function setGrievanceFloatState(enabled) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let settingsSheet = ss.getSheetByName('User Settings');

    if (!settingsSheet) {
      // Create settings sheet if it doesn't exist
      settingsSheet = ss.insertSheet('User Settings');
      settingsSheet.getRange('A1:B1').setValues([['Setting', 'Value']])
        .setFontWeight('bold')
        .setBackground('#4A5568')
        .setFontColor('#FFFFFF');
      settingsSheet.hideSheet();
    }

    // Find and update or add setting
    const settingsData = settingsSheet.getDataRange().getValues();
    let found = false;

    for (let i = 0; i < settingsData.length; i++) {
      if (settingsData[i][0] === 'grievanceFloatEnabled') {
        settingsSheet.getRange(i + 1, 2).setValue(enabled);
        found = true;
        break;
      }
    }

    if (!found) {
      const lastRow = settingsSheet.getLastRow();
      settingsSheet.getRange(lastRow + 1, 1, 1, 2).setValues([['grievanceFloatEnabled', enabled]]);
    }
  } catch (error) {
    Logger.log('Error setting float state: ' + error);
  }
}

/**
 * Toggles the grievance float feature on/off
 */
function toggleGrievanceFloat() {
  const ui = SpreadsheetApp.getUi();
  const currentState = getGrievanceFloatState();
  const newState = !currentState;

  const response = ui.alert(
    'üîÑ Grievance Float Toggle',
    `Do you want to ${newState ? 'enable' : 'disable'} the Grievance Float feature?\n\n` +
    `When enabled, this will:\n` +
    `‚Ä¢ Send closed/settled/inactive grievances to the bottom\n` +
    `‚Ä¢ Prioritize Step 3 > Step 2 > Step 1\n` +
    `‚Ä¢ Sort by soonest due date within each step`,
    ui.ButtonSet.YES_NO
  );

  if (response === ui.Button.YES) {
    setGrievanceFloatState(newState);

    if (newState) {
      // Apply float immediately
      applyGrievanceFloat();
      ui.alert(
        '‚úÖ Float Enabled',
        'Grievance float has been enabled and applied.\n\n' +
        'Grievances are now sorted by priority.',
        ui.ButtonSet.OK
      );
    } else {
      ui.alert(
        '‚úÖ Float Disabled',
        'Grievance float has been disabled.\n\n' +
        'To restore original order, you may need to manually re-sort.',
        ui.ButtonSet.OK
      );
    }
  }
}

/**
 * Applies the grievance float sorting
 */
function applyGrievanceFloat() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!grievanceSheet) {
    throw new Error('Grievance Log sheet not found');
  }

  SpreadsheetApp.getActiveSpreadsheet().toast('üîÑ Sorting grievances...', 'Please wait', -1);

  const lastRow = grievanceSheet.getLastRow();
  if (lastRow < 2) {
    SpreadsheetApp.getActiveSpreadsheet().toast('No grievances to sort', '', 2);
    return;
  }

  // Get all data including headers
  const numCols = grievanceSheet.getLastColumn();
  const allData = grievanceSheet.getRange(1, 1, lastRow, numCols).getValues();
  const headers = allData[0];
  const dataRows = allData.slice(1);

  // Sort the data
  const sortedData = sortGrievancesByPriority(dataRows);

  // Write back the sorted data
  grievanceSheet.getRange(2, 1, sortedData.length, numCols).setValues(sortedData);

  SpreadsheetApp.getActiveSpreadsheet().toast('‚úÖ Grievances sorted!', '', 2);
}

/**
 * Sorts grievances by priority
 * Priority order:
 * 1. Active grievances before inactive/closed/settled
 * 2. Step 3 > Step 2 > Step 1
 * 3. Soonest due date within each step
 *
 * @param {Array} dataRows - Array of data rows (without headers)
 * @returns {Array} Sorted array of data rows
 */
function sortGrievancesByPriority(dataRows) {
  return dataRows.sort(function(a, b) {
    const statusA = String(a[GRIEVANCE_COLS.STATUS - 1] || '').toLowerCase();
    const statusB = String(b[GRIEVANCE_COLS.STATUS - 1] || '').toLowerCase();
    const stepA = String(a[GRIEVANCE_COLS.CURRENT_STEP - 1] || '');
    const stepB = String(b[GRIEVANCE_COLS.CURRENT_STEP - 1] || '');
    const dueDateA = a[GRIEVANCE_COLS.NEXT_ACTION_DUE - 1];
    const dueDateB = b[GRIEVANCE_COLS.NEXT_ACTION_DUE - 1];

    // Inactive statuses go to bottom
    const inactiveStatuses = ['closed', 'settled', 'inactive', 'withdrawn', 'denied'];
    const aIsInactive = inactiveStatuses.some(function(status) { return statusA.includes(status); });
    const bIsInactive = inactiveStatuses.some(function(status) { return statusB.includes(status); });

    if (aIsInactive && !bIsInactive) return 1;
    if (!aIsInactive && bIsInactive) return -1;

    // If both are active or both inactive, sort by step (3 > 2 > 1)
    const stepPriorityA = getStepPriority(stepA);
    const stepPriorityB = getStepPriority(stepB);

    if (stepPriorityA !== stepPriorityB) {
      return stepPriorityB - stepPriorityA; // Higher priority first
    }

    // Same step, sort by due date (soonest first)
    if (dueDateA && dueDateB) {
      const dateA = new Date(dueDateA);
      const dateB = new Date(dueDateB);

      if (dateA.getTime() !== dateB.getTime()) {
        return dateA - dateB; // Earlier date first
      }
    } else if (dueDateA && !dueDateB) {
      return -1; // Has due date comes before no due date
    } else if (!dueDateA && dueDateB) {
      return 1;
    }

    // If all else equal, maintain current order
    return 0;
  });
}

/**
 * Gets the priority value for a step
 * @param {string} step - Step string (e.g., "Step 1", "Step 2", "Step 3")
 * @returns {number} Priority value (3 = highest, 1 = lowest, 0 = no step)
 */
function getStepPriority(step) {
  const stepStr = String(step).toLowerCase();

  if (stepStr.includes('step iii') || stepStr.includes('step 3')) {
    return 3;
  } else if (stepStr.includes('step ii') || stepStr.includes('step 2')) {
    return 2;
  } else if (stepStr.includes('step i') || stepStr.includes('step 1')) {
    return 1;
  }

  return 0;
}

/**
 * Shows the grievance float control panel
 */
function showGrievanceFloatPanel() {
  const ui = SpreadsheetApp.getUi();
  const isEnabled = getGrievanceFloatState();

  const html = HtmlService.createHtmlOutput(`
    <!DOCTYPE html>
    <html>
    <head>
      <base target="_top">
      <style>
        body {
          font-family: 'Roboto', Arial, sans-serif;
          padding: 20px;
          margin: 0;
          background: #f5f5f5;
        }
        .container {
          background: white;
          padding: 25px;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h2 {
          color: #1a73e8;
          margin-top: 0;
          border-bottom: 3px solid #1a73e8;
          padding-bottom: 10px;
        }
        .status {
          padding: 15px;
          border-radius: 4px;
          margin: 15px 0;
          font-weight: bold;
        }
        .status.enabled {
          background: #d1fae5;
          border-left: 4px solid #10b981;
          color: #065f46;
        }
        .status.disabled {
          background: #fee2e2;
          border-left: 4px solid #ef4444;
          color: #991b1b;
        }
        .info-box {
          background: #e8f0fe;
          padding: 15px;
          border-radius: 4px;
          margin: 15px 0;
          border-left: 4px solid #1a73e8;
        }
        .info-box h3 {
          margin-top: 0;
          color: #1557b0;
        }
        .info-box ul {
          margin: 10px 0;
          padding-left: 20px;
        }
        .info-box li {
          margin: 8px 0;
          color: #1557b0;
        }
        .button {
          background: #1a73e8;
          color: white;
          padding: 12px 24px;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 14px;
          font-weight: bold;
          margin: 10px 5px;
        }
        .button:hover {
          background: #1557b0;
        }
        .button.secondary {
          background: #6b7280;
        }
        .button.secondary:hover {
          background: #4b5563;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <h2>üîÑ Grievance Float Control Panel</h2>

        <div class="status ${isEnabled ? 'enabled' : 'disabled'}">
          Status: ${isEnabled ? '‚úÖ ENABLED' : '‚ùå DISABLED'}
        </div>

        <div class="info-box">
          <h3>How Grievance Float Works:</h3>
          <ul>
            <li><strong>Inactive grievances sink to bottom</strong><br>
              Closed, settled, or inactive grievances automatically move to the bottom of the list</li>
            <li><strong>Priority by step</strong><br>
              Step 3 grievances appear first, then Step 2, then Step 1</li>
            <li><strong>Sorted by due date</strong><br>
              Within each step, grievances with the soonest due dates appear first</li>
          </ul>
        </div>

        <button class="button" onclick="google.script.run.withSuccessHandler(onSuccess).toggleGrievanceFloat()">
          ${isEnabled ? 'Disable' : 'Enable'} Float
        </button>

        ${isEnabled ? '<button class="button secondary" onclick="google.script.run.withSuccessHandler(onSuccess).applyGrievanceFloat()">Re-Apply Sort Now</button>' : ''}

        <button class="button secondary" onclick="google.script.host.close()">Close</button>
      </div>

      <script>
        function onSuccess() {
          google.script.host.close();
        }
      </script>
    </body>
    </html>
  `)
    .setWidth(600)
    .setHeight(500);

  ui.showModalDialog(html, 'üîÑ Grievance Float Toggle');
}



// ================================================================================
// MODULE: GrievanceWorkflow.gs
// Source: GrievanceWorkflow.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * GRIEVANCE WORKFLOW - Start Grievance from Member Directory
 * ------------------------------------------------------------------------====
 *
 * Allows stewards to click a member in the directory and start a grievance
 * with pre-filled member and steward information via Google Form.
 *
 * Features:
 * - Pre-filled Google Form with member and steward details
 * - Automatic submission to Grievance Log
 * - PDF generation with fillable grievance form
 * - Email to multiple addresses or download option
 *
 * ------------------------------------------------------------------------====
 */

/**
 * Configuration for grievance workflow and Google Form integration
 * @type {Object}
 */
GRIEVANCE_FORM_CONFIG = {
  // Replace with your actual Google Form URL
  // To find: Create a Google Form, then copy the URL from the browser
  FORM_URL: "https://docs.google.com/forms/d/e/YOUR_FORM_ID/viewform",

  // Email address for grievance notifications
  // Configure this with your union's actual grievance email
  GRIEVANCE_EMAIL: "grievances@seiu509.org",

  // Form field entry IDs (found by inspecting your form)
  // To find these: Open your form, right-click a field, inspect element, find "entry.XXXXXXX"
  FIELD_IDS: {
    MEMBER_ID: "entry.1000000001",
    MEMBER_FIRST_NAME: "entry.1000000002",
    MEMBER_LAST_NAME: "entry.1000000003",
    MEMBER_EMAIL: "entry.1000000004",
    MEMBER_PHONE: "entry.1000000005",
    MEMBER_JOB_TITLE: "entry.1000000006",
    MEMBER_LOCATION: "entry.1000000007",
    MEMBER_UNIT: "entry.1000000008",
    STEWARD_NAME: "entry.1000000009",
    STEWARD_EMAIL: "entry.1000000010",
    STEWARD_PHONE: "entry.1000000011"
  }
};

/**
 * Shows a dialog to start a grievance from the Member Directory
 */
function showStartGrievanceDialog() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (!memberSheet) {
    SpreadsheetApp.getUi().alert(ERROR_MESSAGES.SHEET_NOT_FOUND(SHEETS.MEMBER_DIR));
    return;
  }

  // Get all members for selection
  const members = getMemberList();

  if (members.length === 0) {
    SpreadsheetApp.getUi().alert(ERROR_MESSAGES.NO_DATA_FOUND('members'));
    return;
  }

  const html = createMemberSelectionDialog(members);

  SpreadsheetApp.getUi().showModalDialog(
    HtmlService.createHtmlOutput(html).setWidth(700).setHeight(500),
    'üöÄ Start New Grievance'
  );
}

/**
 * Gets list of all members from Member Directory
 * @returns {Array<Object>} Array of member objects with properties
 */
function getMemberList() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

    if (!memberSheet) {
      logWarning('getMemberList', 'Member Directory sheet not found');
      return [];
    }

    const lastRow = memberSheet.getLastRow();
    if (lastRow < 2) return [];

    // Get all member data - using MEMBER_COLS constants
    const numCols = Math.max(
      MEMBER_COLS.MEMBER_ID,
      MEMBER_COLS.FIRST_NAME,
      MEMBER_COLS.LAST_NAME,
      MEMBER_COLS.JOB_TITLE,
      MEMBER_COLS.WORK_LOCATION,
      MEMBER_COLS.UNIT,
      MEMBER_COLS.OFFICE_DAYS,
      MEMBER_COLS.EMAIL,
      MEMBER_COLS.PHONE,
      MEMBER_COLS.IS_STEWARD,
      MEMBER_COLS.SUPERVISOR
    );

    const data = memberSheet.getRange(2, 1, lastRow - 1, numCols).getValues();

    return data.map(function(row, index) { return {
      rowIndex: index + 2,
      memberId: safeArrayGet(row, MEMBER_COLS.MEMBER_ID - 1, ''),
      firstName: safeArrayGet(row, MEMBER_COLS.FIRST_NAME - 1, ''),
      lastName: safeArrayGet(row, MEMBER_COLS.LAST_NAME - 1, ''),
      jobTitle: safeArrayGet(row, MEMBER_COLS.JOB_TITLE - 1, ''),
      location: safeArrayGet(row, MEMBER_COLS.WORK_LOCATION - 1, ''),
      unit: safeArrayGet(row, MEMBER_COLS.UNIT - 1, ''),
      officeDays: safeArrayGet(row, MEMBER_COLS.OFFICE_DAYS - 1, ''),
      email: safeArrayGet(row, MEMBER_COLS.EMAIL - 1, ''),
      phone: safeArrayGet(row, MEMBER_COLS.PHONE - 1, ''),
      isSteward: safeArrayGet(row, MEMBER_COLS.IS_STEWARD - 1, ''),
      supervisor: safeArrayGet(row, MEMBER_COLS.SUPERVISOR - 1, '')
    };}).filter(function(member) { return member.memberId; }); // Filter out empty rows
  } catch (error) {
    return handleError(error, 'getMemberList', true, true) || [];
  }
}

/**
 * Creates HTML dialog for member selection
 * @param {Array<Object>} members - Array of member objects
 * @returns {string} HTML content for dialog
 */
function createMemberSelectionDialog(members) {
  // Use HTML escaping to prevent XSS
  const memberOptions = members.map(function(m) {
    return `<option value="${escapeHtmlAttribute(m.rowIndex)}">${escapeHtml(m.lastName)}, ${escapeHtml(m.firstName)} (${escapeHtml(m.memberId)}) - ${escapeHtml(m.location)}</option>`;
  }).join('');

  return `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 {
      color: #1a73e8;
      margin-top: 0;
      border-bottom: 3px solid #1a73e8;
      padding-bottom: 10px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 8px;
      color: #333;
    }
    select, input {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    select:focus, input:focus {
      outline: none;
      border-color: #1a73e8;
    }
    .info-box {
      background: #e8f0fe;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
      border-left: 4px solid #1a73e8;
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 25px;
    }
    button {
      flex: 1;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-primary {
      background: #1a73e8;
      color: white;
    }
    .btn-primary:hover {
      background: #1557b0;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(26,115,232,0.4);
    }
    .btn-secondary {
      background: #f1f3f4;
      color: #333;
    }
    .btn-secondary:hover {
      background: #e8eaed;
    }
    .member-details {
      background: #fafafa;
      padding: 12px;
      border-radius: 4px;
      margin-top: 10px;
      display: none;
    }
    .detail-item {
      margin: 5px 0;
      font-size: 13px;
    }
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: #1a73e8;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìã Start New Grievance</h2>

    <div class="info-box">
      <strong>‚ÑπÔ∏è Instructions:</strong><br>
      1. Select the member filing the grievance<br>
      2. Review the pre-filled information<br>
      3. Click "Start Grievance" to open the form with pre-filled data
    </div>

    <div class="form-group">
      <label for="memberSelect">Select Member:</label>
      <select id="memberSelect" onchange="showMemberDetails()">
        <option value="">-- Select a Member --</option>
        ${memberOptions}
      </select>
    </div>

    <div id="memberDetails" class="member-details"></div>

    <div class="button-group">
      <button class="btn-secondary" onclick="google.script.host.close()">Cancel</button>
      <button class="btn-primary" id="startBtn" onclick="startGrievance()" disabled>Start Grievance</button>
    </div>

    <div class="loading" id="loading">
      <p>‚è≥ Generating pre-filled form...</p>
    </div>
  </div>

  <script>
    const members = ${JSON.stringify(members)};

    function showMemberDetails() {
      const select = document.getElementById('memberSelect');
      const detailsDiv = document.getElementById('memberDetails');
      const startBtn = document.getElementById('startBtn');

      if (select.value) {
        const member = members.find(function(m) { return m.rowIndex == select.value; });
        if (member) {
          detailsDiv.innerHTML = \`
            <div class="detail-item"><strong>Name:</strong> \${member.firstName} \${member.lastName}</div>
            <div class="detail-item"><strong>Member ID:</strong> \${member.memberId}</div>
            <div class="detail-item"><strong>Email:</strong> \${member.email || 'Not provided'}</div>
            <div class="detail-item"><strong>Phone:</strong> \${member.phone || 'Not provided'}</div>
            <div class="detail-item"><strong>Job Title:</strong> \${member.jobTitle}</div>
            <div class="detail-item"><strong>Location:</strong> \${member.location}</div>
            <div class="detail-item"><strong>Unit:</strong> \${member.unit}</div>
          \`;
          detailsDiv.style.display = 'block';
          startBtn.disabled = false;
        }
      } else {
        detailsDiv.style.display = 'none';
        startBtn.disabled = true;
      }
    }

    function startGrievance() {
      const select = document.getElementById('memberSelect');
      if (!select.value) {
        alert('Please select a member first.');
        return;
      }

      const rowIndex = parseInt(select.value);
      document.getElementById('loading').style.display = 'block';

      google.script.run
        .withSuccessHandler(onFormUrlGenerated)
        .withFailureHandler(onError)
        .generatePreFilledGrievanceForm(rowIndex);
    }

    function onFormUrlGenerated(url) {
      document.getElementById('loading').style.display = 'none';
      if (url) {
        window.open(url, '_blank');
        alert('‚úÖ Pre-filled form opened in new window.\\n\\nAfter submitting the form, the grievance will be automatically added to the Grievance Log.');
        google.script.host.close();
      } else {
        alert('‚ùå Could not generate form URL. Please check the configuration.');
      }
    }

    function onError(error) {
      document.getElementById('loading').style.display = 'none';
      alert('‚ùå Error: ' + error.message);
    }
  </script>
</body>
</html>
  `;
}

/**
 * Generates a pre-filled Google Form URL for the selected member
 */
function generatePreFilledGrievanceForm(memberRowIndex) {
  // Validate configuration before proceeding
  if (GRIEVANCE_FORM_CONFIG.FORM_URL.includes('YOUR_FORM_ID')) {
    throw new Error(
      'Grievance form is not configured yet. Please update GRIEVANCE_FORM_CONFIG.FORM_URL in GrievanceWorkflow.gs with your actual Google Form URL. ' +
      'Instructions: 1) Create a Google Form, 2) Get the form URL, 3) Replace the placeholder in the code.'
    );
  }

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (!memberSheet) {
    throw new Error(ERROR_MESSAGES.SHEET_NOT_FOUND(SHEETS.MEMBER_DIR));
  }

  // Get member data
  const memberData = memberSheet.getRange(memberRowIndex, 1, 1, 11).getValues()[0];
  const member = {
    id: memberData[MEMBER_COLS.MEMBER_ID - 1],
    firstName: memberData[MEMBER_COLS.FIRST_NAME - 1],
    lastName: memberData[MEMBER_COLS.LAST_NAME - 1],
    jobTitle: memberData[MEMBER_COLS.JOB_TITLE - 1],
    location: memberData[MEMBER_COLS.WORK_LOCATION - 1],
    unit: memberData[MEMBER_COLS.UNIT - 1],
    officeDays: memberData[MEMBER_COLS.OFFICE_DAYS - 1],
    email: memberData[MEMBER_COLS.EMAIL - 1],
    phone: memberData[MEMBER_COLS.PHONE - 1]
  };

  // Get steward contact info from Config
  const steward = getStewardContactInfo();

  // Build pre-filled form URL
  const baseUrl = GRIEVANCE_FORM_CONFIG.FORM_URL;
  const params = new URLSearchParams();

  // Add member information
  params.append(GRIEVANCE_FORM_CONFIG.FIELD_IDS.MEMBER_ID, member.id || '');
  params.append(GRIEVANCE_FORM_CONFIG.FIELD_IDS.MEMBER_FIRST_NAME, member.firstName || '');
  params.append(GRIEVANCE_FORM_CONFIG.FIELD_IDS.MEMBER_LAST_NAME, member.lastName || '');
  params.append(GRIEVANCE_FORM_CONFIG.FIELD_IDS.MEMBER_EMAIL, member.email || '');
  params.append(GRIEVANCE_FORM_CONFIG.FIELD_IDS.MEMBER_PHONE, member.phone || '');
  params.append(GRIEVANCE_FORM_CONFIG.FIELD_IDS.MEMBER_JOB_TITLE, member.jobTitle || '');
  params.append(GRIEVANCE_FORM_CONFIG.FIELD_IDS.MEMBER_LOCATION, member.location || '');
  params.append(GRIEVANCE_FORM_CONFIG.FIELD_IDS.MEMBER_UNIT, member.unit || '');

  // Add steward information
  params.append(GRIEVANCE_FORM_CONFIG.FIELD_IDS.STEWARD_NAME, steward.name || '');
  params.append(GRIEVANCE_FORM_CONFIG.FIELD_IDS.STEWARD_EMAIL, steward.email || '');
  params.append(GRIEVANCE_FORM_CONFIG.FIELD_IDS.STEWARD_PHONE, steward.phone || '');

  return baseUrl + '?' + params.toString();
}

/**
 * Gets steward contact information from Config sheet
 */
function getStewardContactInfo() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const configSheet = ss.getSheetByName(SHEETS.CONFIG);

  if (!configSheet) {
    logWarning('getStewardContactInfo', 'Config sheet not found - steward contact info not available');
    return { name: '', email: '', phone: '', location: '' };
  }

  // Steward contact info is stored in Config sheet
  // Define column position (update if Config structure changes)
  const CONFIG_STEWARD_INFO_COL = 21;  // Column U - Steward contact details

  try {
    const stewardData = configSheet.getRange(2, CONFIG_STEWARD_INFO_COL, 3, 1).getValues();
    const result = {
      name: stewardData[0][0] || '',
      email: stewardData[1][0] || '',
      phone: stewardData[2][0] || '',
      location: stewardData[0][0] || '' // Can be added if needed
    };

    // Check if any data was found
    if (!result.name && !result.email && !result.phone) {
      logWarning('getStewardContactInfo', 'No steward contact information configured in Config sheet');
    }

    return result;
  } catch (error) {
    handleError(error, 'getStewardContactInfo', false, true);
    logWarning('getStewardContactInfo', 'Error fetching steward contact info - returning empty values');
    return { name: '', email: '', phone: '', location: '' };
  }
}

/**
 * Gets grievance coordinator emails from Config sheet
 */
function getGrievanceCoordinators() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const configSheet = ss.getSheetByName(SHEETS.CONFIG);

  if (!configSheet) {
    logWarning('getGrievanceCoordinators', 'Config sheet not found - grievance coordinators not available');
    return { coordinator1: '', coordinator2: '', coordinator3: '' };
  }

  try {
    // Grievance Coordinators are in CONFIG_COLS.GRIEVANCE_COORDINATORS as comma-separated list
    const coordinatorData = configSheet.getRange(2, CONFIG_COLS.GRIEVANCE_COORDINATORS, 10, 1).getValues();

    // Get coordinator names from comma-separated values
    const allCoordinators = coordinatorData
      .map(function(row) { return row[0]; })
      .filter(String)
      .join(',')
      .split(',')
      .map(function(name) { return name.trim(); })
      .filter(String);

    const result = {
      coordinator1: allCoordinators.length > 0 ? allCoordinators[0] : '',
      coordinator2: allCoordinators.length > 1 ? allCoordinators[1] : '',
      coordinator3: allCoordinators.length > 2 ? allCoordinators[2] : ''
    };

    // Check if any coordinators were found
    if (!result.coordinator1 && !result.coordinator2 && !result.coordinator3) {
      logWarning('getGrievanceCoordinators', 'No grievance coordinators configured in Config sheet');
    }

    return result;
  } catch (error) {
    handleError(error, 'getGrievanceCoordinators', false, true);
    logWarning('getGrievanceCoordinators', 'Error fetching grievance coordinators - returning empty values');
    return { coordinator1: '', coordinator2: '', coordinator3: '' };
  }
}

/**
 * Updates Config sheet to include Steward Contact Info section
 */
function addStewardContactInfoToConfig() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const configSheet = ss.getSheetByName(SHEETS.CONFIG);

  if (!configSheet) {
    SpreadsheetApp.getUi().alert(ERROR_MESSAGES.SHEET_NOT_FOUND(SHEETS.CONFIG));
    return;
  }

  // Add Steward Contact Info section starting at column U (21)
  const startCol = 21;

  // Section header
  configSheet.getRange(1, startCol, 1, 4).merge()
    .setValue("STEWARD CONTACT INFORMATION")
    .setFontWeight("bold")
    .setFontSize(12)
    .setFontFamily("Roboto")
    .setBackground("#7EC8E3") // PRIMARY_BLUE
    .setFontColor("white")
    .setHorizontalAlignment("center");

  // Field labels
  const labels = [
    ["Steward Name:"],
    ["Steward Email:"],
    ["Steward Phone:"],
    ["Instructions:"]
  ];

  configSheet.getRange(2, startCol, labels.length, 1)
    .setValues(labels)
    .setFontWeight("bold")
    .setBackground("#E8F0FE")
    .setHorizontalAlignment("right");

  // Instruction text
  configSheet.getRange(5, startCol, 1, 4).merge()
    .setValue("Enter the primary steward contact info above. This will be used when starting grievances from the Member Directory.")
    .setFontStyle("italic")
    .setFontSize(10)
    .setWrap(true)
    .setBackground("#FFF9E6");

  // Auto-resize columns
  for (let i = 0; i < 4; i++) {
    configSheet.setColumnWidth(startCol + i, 180);
  }

  SpreadsheetApp.getUi().alert(
    ERROR_MESSAGES.SUCCESS('Steward Contact Info Section Added'),
    'A new section has been added to the Config sheet.\n\n' +
    'Please enter your steward contact information in column U (rows 2-4).',
    SpreadsheetApp.getUi().ButtonSet.OK
  );
}

/**
 * ------------------------------------------------------------------------====
 * GOOGLE FORM SUBMISSION HANDLING
 * ------------------------------------------------------------------------====
 */

/**
 * Handles form submissions from the Google Form
 * This should be set up as an installable trigger on form submission
 *
 * To set up:
 * 1. In the Apps Script editor, go to Triggers (clock icon)
 * 2. Add trigger: onGrievanceFormSubmit, From spreadsheet, On form submit
 */
function onGrievanceFormSubmit(e) {
  try {
    // Extract form responses
    const formData = extractFormData(e);

    // Add to Grievance Log
    const grievanceId = addGrievanceToLog(formData);

    // Create Google Drive folder for the grievance
    const folder = createGrievanceFolder(grievanceId, formData);

    // Generate PDF
    const pdfBlob = generateGrievancePDF(grievanceId);

    // Save PDF to folder
    if (folder) {
      folder.createFile(pdfBlob);
    }

    // Show sharing options dialog with folder link
    showSharingOptionsDialog(grievanceId, pdfBlob, folder);

  } catch (error) {
    Logger.log('Error in onGrievanceFormSubmit: ' + error.message);
    SpreadsheetApp.getUi().alert(ERROR_MESSAGES.OPERATION_FAILED('form submission', error.message));
  }
}

/**
 * Creates a Google Drive folder for a grievance
 */
function createGrievanceFolder(grievanceId, formData) {
  try {
    // Get or create main Grievances folder
    const mainFolderName = 'SEIU 509 - Grievances';
    let mainFolder;

    const folders = DriveApp.getFoldersByName(mainFolderName);
    if (folders.hasNext()) {
      mainFolder = folders.next();
    } else {
      mainFolder = DriveApp.createFolder(mainFolderName);
    }

    // Create grievance-specific folder
    const folderName = `${grievanceId} - ${formData.lastName}, ${formData.firstName}`;
    const grievanceFolder = mainFolder.createFolder(folderName);

    // Store folder URL in Grievance Log (if there's a column for it)
    // This would need a column added to the Grievance Log sheet

    Logger.log(`Created folder: ${folderName}`);
    return grievanceFolder;

  } catch (error) {
    Logger.log('Error creating grievance folder: ' + error.message);
    return null;
  }
}

/**
 * Shows dialog with sharing options for grievance form and folder
 */
function showSharingOptionsDialog(grievanceId, pdfBlob, folder) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const memberDir = ss.getSheetByName(SHEETS.MEMBER_DIR);
  const grievanceLog = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  // Get grievance data
  const grievanceData = grievanceLog.getDataRange().getValues();
  const grievanceRow = grievanceData.find(function(row) { return row[GRIEVANCE_COLS.GRIEVANCE_ID - 1] === grievanceId; });

  if (!grievanceRow) {
    SpreadsheetApp.getUi().alert(ERROR_MESSAGES.GRIEVANCE_NOT_FOUND(grievanceId));
    return;
  }

  const memberId = grievanceRow[GRIEVANCE_COLS.MEMBER_ID - 1];
  const memberEmail = grievanceRow[GRIEVANCE_COLS.MEMBER_EMAIL - 1];
  const stewardEmail = getStewardContactInfo().email;
  const coordinators = getGrievanceCoordinators();
  const folderUrl = folder ? folder.getUrl() : '';

  // Grievance email is configured via EMAIL_CONFIG.GRIEVANCE_EMAIL in Constants.gs
  // and can be overridden in GRIEVANCE_FORM_CONFIG.GRIEVANCE_EMAIL
  const grievanceEmail = GRIEVANCE_FORM_CONFIG.GRIEVANCE_EMAIL || 'grievances@seiu509.org';

  const html = HtmlService.createHtmlOutput(`
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 {
      color: #1a73e8;
      margin-top: 0;
      border-bottom: 3px solid #1a73e8;
      padding-bottom: 10px;
    }
    .info-box {
      background: #e8f0fe;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
      border-left: 4px solid #1a73e8;
    }
    .folder-link {
      background: #fef7e0;
      padding: 12px;
      border-radius: 4px;
      margin: 15px 0;
      border-left: 4px solid #f9ab00;
    }
    .folder-link a {
      color: #1a73e8;
      font-weight: bold;
      text-decoration: none;
    }
    .folder-link a:hover {
      text-decoration: underline;
    }
    .checkbox-group {
      margin: 20px 0;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      padding: 10px;
      margin: 8px 0;
      border: 2px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
    }
    .checkbox-item:hover {
      background: #f0f0f0;
      border-color: #1a73e8;
    }
    .checkbox-item input[type="checkbox"] {
      margin-right: 10px;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    .checkbox-item label {
      cursor: pointer;
      flex: 1;
      font-size: 14px;
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 25px;
    }
    button {
      flex: 1;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-primary {
      background: #1a73e8;
      color: white;
    }
    .btn-primary:hover {
      background: #1557b0;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(26,115,232,0.4);
    }
    .btn-secondary {
      background: #f1f3f4;
      color: #333;
    }
    .btn-secondary:hover {
      background: #e8eaed;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>‚úÖ Grievance ${grievanceId} Created</h2>

    <div class="info-box">
      <strong>‚ÑπÔ∏è Grievance folder created successfully!</strong><br>
      Select the recipients you want to share the grievance form and/or folder with.
    </div>

    ${folderUrl ? `
    <div class="folder-link">
      üìÅ <strong>Folder Link:</strong><br>
      <a href="${folderUrl}" target="_blank">${folderUrl}</a>
    </div>
    ` : ''}

    <h3>Select Recipients:</h3>
    <div class="checkbox-group">
      ${memberEmail ? `
      <div class="checkbox-item">
        <input type="checkbox" id="member" value="${memberEmail}">
        <label for="member">Member (${memberEmail})</label>
      </div>
      ` : ''}

      ${stewardEmail ? `
      <div class="checkbox-item">
        <input type="checkbox" id="steward" value="${stewardEmail}">
        <label for="steward">Steward (${stewardEmail})</label>
      </div>
      ` : ''}

      ${coordinators.coordinator1 ? `
      <div class="checkbox-item">
        <input type="checkbox" id="coordinator1" value="${coordinators.coordinator1}">
        <label for="coordinator1">Grievance Coordinator 1 (${coordinators.coordinator1})</label>
      </div>
      ` : ''}

      ${coordinators.coordinator2 ? `
      <div class="checkbox-item">
        <input type="checkbox" id="coordinator2" value="${coordinators.coordinator2}">
        <label for="coordinator2">Grievance Coordinator 2 (${coordinators.coordinator2})</label>
      </div>
      ` : ''}

      ${coordinators.coordinator3 ? `
      <div class="checkbox-item">
        <input type="checkbox" id="coordinator3" value="${coordinators.coordinator3}">
        <label for="coordinator3">Grievance Coordinator 3 (${coordinators.coordinator3})</label>
      </div>
      ` : ''}

      ${grievanceEmail ? `
      <div class="checkbox-item">
        <input type="checkbox" id="grievanceEmail" value="${grievanceEmail}">
        <label for="grievanceEmail">Grievance Email (${grievanceEmail})</label>
      </div>
      ` : ''}
    </div>

    <div class="button-group">
      <button class="btn-secondary" onclick="google.script.host.close()">Close</button>
      <button class="btn-primary" onclick="shareWithSelected()">Share with Selected</button>
    </div>
  </div>

  <script>
    function shareWithSelected() {
      const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
      const recipients = Array.from(checkboxes).map(function(cb) { return cb.value; });

      if (recipients.length === 0) {
        alert('Please select at least one recipient.');
        return;
      }

      const folderUrl = '${folderUrl}';

      google.script.run
        .withSuccessHandler(function() {
          alert('‚úÖ Sharing invitations sent successfully!');
          google.script.host.close();
        })
        .withFailureHandler(function(error) {
          alert('‚ùå Error: ' + error.message);
        })
        .shareGrievanceWithRecipients('${grievanceId}', recipients, folderUrl);
    }
  </script>
</body>
</html>
  `).setWidth(600).setHeight(600);

  SpreadsheetApp.getUi().showModalDialog(html, 'Share Grievance');
}

/**
 * Shares grievance folder and sends notification to selected recipients
 */
function shareGrievanceWithRecipients(grievanceId, recipients, folderUrl) {
  try {
    const pdfBlob = generateGrievancePDF(grievanceId);

    // Get folder by URL
    let folder = null;
    if (folderUrl) {
      const folderId = folderUrl.match(/[-\w]{25,}/);
      if (folderId) {
        folder = DriveApp.getFolderById(folderId[0]);
      }
    }

    // Share folder with each recipient
    // Note: Requires valid email addresses. Configure coordinator emails in Config sheet.
    if (folder && recipients && recipients.length > 0) {
      recipients.forEach(function(email) {
        try {
          // Validate email before sharing
          const validEmail = sanitizeEmail(email);
          if (validEmail) {
            folder.addEditor(validEmail);
            logInfo('shareGrievanceWithRecipients', `Shared folder with: ${validEmail}`);
          } else {
            logWarning('shareGrievanceWithRecipients', `Invalid email address: ${email}`);
          }
        } catch (e) {
          handleError(e, `shareGrievanceWithRecipients - sharing with ${email}`, false);
        }
      });
    }

    // Send email notification
    const subject = `SEIU Local 509 - Grievance ${grievanceId}`;
    const body = `A new grievance has been filed and requires your attention.\n\n` +
                 `Grievance ID: ${grievanceId}\n` +
                 `Folder Link: ${folderUrl}\n\n` +
                 `Please review the attached grievance form and folder for details.\n\n` +
                 `This is an automated message from the SEIU Local 509 Dashboard.`;

    // Send email notification with grievance PDF
    // Note: Requires valid email addresses and Gmail permissions
    recipients.forEach(function(email) {
      try {
        const validEmail = sanitizeEmail(email);
        if (validEmail) {
          GmailApp.sendEmail(validEmail, subject, body, {
            attachments: [pdfBlob],
            name: 'SEIU Local 509 Dashboard'
          });
          logInfo('shareGrievanceWithRecipients', `Sent email to: ${validEmail}`);
        } else {
          logWarning('shareGrievanceWithRecipients', `Skipped invalid email: ${email}`);
        }
      } catch (e) {
        handleError(e, `shareGrievanceWithRecipients - emailing ${email}`, false);
      }
    });

  } catch (error) {
    Logger.log('Error sharing grievance: ' + error.message);
    throw error;
  }
}

/**
 * Extracts and structures data from form submission
 */
function extractFormData(e) {
  // Validate event object
  validateRequired(e, 'e', 'extractFormData');

  if (!e.namedValues || typeof e.namedValues !== 'object') {
    const error = new Error('Event object is missing namedValues property or it is not an object');
    handleError(error, 'extractFormData', true, true);
    throw error;
  }

  const responses = e.namedValues;

  // Map form responses to grievance data structure
  // Adjust field names based on your actual form questions
  return {
    memberId: responses['Member ID'] ? responses['Member ID'][0] : '',
    firstName: responses['First Name'] ? responses['First Name'][0] : '',
    lastName: responses['Last Name'] ? responses['Last Name'][0] : '',
    email: responses['Email'] ? responses['Email'][0] : '',
    phone: responses['Phone'] ? responses['Phone'][0] : '',
    jobTitle: responses['Job Title'] ? responses['Job Title'][0] : '',
    location: responses['Work Location'] ? responses['Work Location'][0] : '',
    unit: responses['Unit'] ? responses['Unit'][0] : '',
    stewardName: responses['Steward Name'] ? responses['Steward Name'][0] : '',
    incidentDate: responses['Incident Date'] ? new Date(responses['Incident Date'][0]) : new Date(),
    grievanceType: responses['Grievance Type'] ? responses['Grievance Type'][0] : 'Other',
    description: responses['Description'] ? responses['Description'][0] : '',
    desiredResolution: responses['Desired Resolution'] ? responses['Desired Resolution'][0] : ''
  };
}

/**
 * Adds grievance data to the Grievance Log
 */
function addGrievanceToLog(formData) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!grievanceSheet) {
    throw new Error(ERROR_MESSAGES.SHEET_NOT_FOUND(SHEETS.GRIEVANCE_LOG));
  }

  // Generate grievance ID
  const grievanceId = generateUniqueGrievanceId();

  // Prepare row data (32 columns A-AF)
  const today = new Date();
  const incidentDate = formData.incidentDate || today;

  const rowData = [
    grievanceId,                    // A: Grievance ID
    formData.memberId,              // B: Member ID
    formData.firstName,             // C: First Name
    formData.lastName,              // D: Last Name
    "Draft",                        // E: Status
    "Informal",                     // F: Current Step
    incidentDate,                   // G: Incident Date
    '',                             // H: Filing Deadline (calculated)
    '',                             // I: Date Filed
    '',                             // J: Step I Decision Due
    '',                             // K: Step I Decision Date
    '',                             // L: Step I Outcome
    '',                             // M: Step II Appeal Deadline
    '',                             // N: Step II Filed Date
    '',                             // O: Step II Decision Due
    '',                             // P: Step II Decision Date
    '',                             // Q: Step II Outcome
    '',                             // R: Step III Appeal Deadline
    '',                             // S: Step III Filed Date
    '',                             // T: Step III Decision Date
    '',                             // U: Mediation Date
    '',                             // V: Arbitration Date
    '',                             // W: Final Outcome
    formData.grievanceType,         // X: Grievance Type
    formData.description,           // Y: Description
    formData.stewardName,           // Z: Steward Name
    '',                             // AA: Days Open (calculated)
    '',                             // AB: Next Action Due (calculated)
    '',                             // AC: Days to Deadline (calculated)
    '',                             // AD: Overdue? (calculated)
    formData.desiredResolution || '', // AE: Notes
    today                           // AF: Last Updated
  ];

  // Add to sheet
  grievanceSheet.appendRow(rowData);

  // Recalculate the new grievance row
  const lastRow = grievanceSheet.getLastRow();
  recalcGrievanceRow(lastRow);

  // Update member directory
  const memberRow = findMemberRow(formData.memberId);
  if (memberRow > 0) {
    recalcMemberRow(memberRow);
  }

  // Automatically create Google Drive folder for the grievance
  try {
    const grievantName = `${formData.firstName}_${formData.lastName}`;
    const folder = createGrievanceFolder(grievanceId, grievantName);
    linkFolderToGrievance(grievanceId, folder.getId());
    Logger.log(`Auto-created Drive folder for grievance ${grievanceId}`);
  } catch (error) {
    Logger.log(`Error auto-creating Drive folder for ${grievanceId}: ${error.message}`);
    // Continue even if folder creation fails
  }

  return grievanceId;
}

/**
 * Recalculates formulas for a specific grievance row
 * Sets deadline formulas (Filing Deadline, Step deadlines, Days Open, Next Action Due)
 * Uses GRIEVANCE_COLS constants for column references
 */
function recalcGrievanceRow(row) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceLog = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  if (!grievanceLog) return;

  // Get column letters for formula references
  const incidentDateCol = getColumnLetter(GRIEVANCE_COLS.INCIDENT_DATE);
  const filingDeadlineCol = getColumnLetter(GRIEVANCE_COLS.FILING_DEADLINE);
  const dateFiledCol = getColumnLetter(GRIEVANCE_COLS.DATE_FILED);
  const step1DueCol = getColumnLetter(GRIEVANCE_COLS.STEP1_DUE);
  const step1RcvdCol = getColumnLetter(GRIEVANCE_COLS.STEP1_RCVD);
  const step2AppealDueCol = getColumnLetter(GRIEVANCE_COLS.STEP2_APPEAL_DUE);
  const step2AppealFiledCol = getColumnLetter(GRIEVANCE_COLS.STEP2_APPEAL_FILED);
  const step2DueCol = getColumnLetter(GRIEVANCE_COLS.STEP2_DUE);
  const step2RcvdCol = getColumnLetter(GRIEVANCE_COLS.STEP2_RCVD);
  const step3AppealDueCol = getColumnLetter(GRIEVANCE_COLS.STEP3_APPEAL_DUE);
  const dateClosedCol = getColumnLetter(GRIEVANCE_COLS.DATE_CLOSED);
  const daysOpenCol = getColumnLetter(GRIEVANCE_COLS.DAYS_OPEN);
  const nextActionDueCol = getColumnLetter(GRIEVANCE_COLS.NEXT_ACTION_DUE);
  const statusCol = getColumnLetter(GRIEVANCE_COLS.STATUS);
  const currentStepCol = getColumnLetter(GRIEVANCE_COLS.CURRENT_STEP);

  // Filing Deadline: Incident Date + 21 days
  grievanceLog.getRange(row, GRIEVANCE_COLS.FILING_DEADLINE).setFormula(
    `=IF(${incidentDateCol}${row}<>"",${incidentDateCol}${row}+21,"")`
  );

  // Step I Decision Due: Date Filed + 30 days
  grievanceLog.getRange(row, GRIEVANCE_COLS.STEP1_DUE).setFormula(
    `=IF(${dateFiledCol}${row}<>"",${dateFiledCol}${row}+30,"")`
  );

  // Step II Appeal Due: Step I Decision Received + 10 days
  grievanceLog.getRange(row, GRIEVANCE_COLS.STEP2_APPEAL_DUE).setFormula(
    `=IF(${step1RcvdCol}${row}<>"",${step1RcvdCol}${row}+10,"")`
  );

  // Step II Decision Due: Step II Appeal Filed + 30 days
  grievanceLog.getRange(row, GRIEVANCE_COLS.STEP2_DUE).setFormula(
    `=IF(${step2AppealFiledCol}${row}<>"",${step2AppealFiledCol}${row}+30,"")`
  );

  // Step III Appeal Due: Step II Decision Received + 30 days
  grievanceLog.getRange(row, GRIEVANCE_COLS.STEP3_APPEAL_DUE).setFormula(
    `=IF(${step2RcvdCol}${row}<>"",${step2RcvdCol}${row}+30,"")`
  );

  // Days Open: Today - Date Filed (or Date Closed - Date Filed if closed)
  grievanceLog.getRange(row, GRIEVANCE_COLS.DAYS_OPEN).setFormula(
    `=IF(${dateFiledCol}${row}<>"",IF(${dateClosedCol}${row}<>"",${dateClosedCol}${row}-${dateFiledCol}${row},TODAY()-${dateFiledCol}${row}),"")`
  );

  // Next Action Due: Based on current step
  grievanceLog.getRange(row, GRIEVANCE_COLS.NEXT_ACTION_DUE).setFormula(
    `=IF(${statusCol}${row}="Open",IF(${currentStepCol}${row}="Step I",${step1DueCol}${row},IF(${currentStepCol}${row}="Step II",${step2DueCol}${row},IF(${currentStepCol}${row}="Step III",${step3AppealDueCol}${row},${filingDeadlineCol}${row}))),"")`
  );
}

/**
 * Recalculates formulas for a specific member row
 * Updates grievance snapshot columns (Has Open Grievance, Status, Next Deadline)
 */
function recalcMemberRow(row) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const memberDir = ss.getSheetByName(SHEETS.MEMBER_DIR);
  if (!memberDir) return;

  // Dynamic column references
  const memberIdCol = getColumnLetter(MEMBER_COLS.MEMBER_ID);
  const grievanceMemberIdCol = getColumnLetter(GRIEVANCE_COLS.MEMBER_ID);
  const statusCol = getColumnLetter(GRIEVANCE_COLS.STATUS);
  const nextActionCol = getColumnLetter(GRIEVANCE_COLS.NEXT_ACTION_DUE);

  // Has Open Grievance? (Column Y / 25) - counts all active statuses
  memberDir.getRange(row, MEMBER_COLS.HAS_OPEN_GRIEVANCE).setFormula(
    `=IF(SUMPRODUCT(('Grievance Log'!${grievanceMemberIdCol}:${grievanceMemberIdCol}=${memberIdCol}${row})*(('Grievance Log'!${statusCol}:${statusCol}="Open")+('Grievance Log'!${statusCol}:${statusCol}="Pending Info")+('Grievance Log'!${statusCol}:${statusCol}="Appealed")+('Grievance Log'!${statusCol}:${statusCol}="In Arbitration")))>0,"Yes","No")`
  );

  // Grievance Status Snapshot (Column Z / 26)
  memberDir.getRange(row, MEMBER_COLS.GRIEVANCE_STATUS).setFormula(
    `=IFERROR(INDEX('Grievance Log'!${statusCol}:${statusCol},MATCH(${memberIdCol}${row},'Grievance Log'!${grievanceMemberIdCol}:${grievanceMemberIdCol},0)),"")`
  );

  // Next Grievance Deadline (Column AA / 27)
  memberDir.getRange(row, MEMBER_COLS.NEXT_DEADLINE).setFormula(
    `=IFERROR(INDEX('Grievance Log'!${nextActionCol}:${nextActionCol},MATCH(${memberIdCol}${row},'Grievance Log'!${grievanceMemberIdCol}:${grievanceMemberIdCol},0)),"")`
  );
}

/**
 * Generates a unique grievance ID
 */
function generateUniqueGrievanceId() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!grievanceSheet) return 'GRV-001-A';

  const lastRow = grievanceSheet.getLastRow();
  if (lastRow < 2) return 'GRV-001-A';

  // Get existing IDs
  const existingIds = grievanceSheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();

  // Generate new ID
  let counter = 1;
  let letter = 'A';
  let newId;

  do {
    newId = `GRV-${String(counter).padStart(3, '0')}-${letter}`;
    if (!existingIds.includes(newId)) break;

    // Increment letter
    if (letter === 'Z') {
      letter = 'A';
      counter++;
    } else {
      letter = String.fromCharCode(letter.charCodeAt(0) + 1);
    }
  } while (existingIds.includes(newId));

  return newId;
}

/**
 * Finds member row by member ID
 */
function findMemberRow(memberId) {
  // Validate memberId parameter
  validateMemberId(memberId, 'findMemberRow');

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (!memberSheet) {
    logWarning('findMemberRow', `Member Directory sheet not found when searching for member ID: ${memberId}`);
    return -1;
  }

  const lastRow = memberSheet.getLastRow();
  if (lastRow < 2) {
    logWarning('findMemberRow', `Member Directory is empty - no member found for ID: ${memberId}`);
    return -1;
  }

  try {
    const memberIds = memberSheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();
    const index = memberIds.indexOf(memberId);

    if (index < 0) {
      logWarning('findMemberRow', `Member ID ${memberId} not found in Member Directory`);
    }

    return index >= 0 ? index + 2 : -1;
  } catch (error) {
    handleError(error, `findMemberRow - searching for member ID: ${memberId}`, false, true);
    return -1;
  }
}

/**
 * ------------------------------------------------------------------------====
 * PDF GENERATION AND DISTRIBUTION
 * ------------------------------------------------------------------------====
 */

/**
 * Generates a PDF for a grievance
 */
function generateGrievancePDF(grievanceId) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!grievanceSheet) {
    throw new Error(ERROR_MESSAGES.SHEET_NOT_FOUND(SHEETS.GRIEVANCE_LOG));
  }

  // Find grievance row
  const data = grievanceSheet.getDataRange().getValues();
  let grievanceRow = -1;

  for (let i = 1; i < data.length; i++) {
    if (data[i][GRIEVANCE_COLS.GRIEVANCE_ID - 1] === grievanceId) {
      grievanceRow = i;
      break;
    }
  }

  if (grievanceRow === -1) {
    throw new Error(ERROR_MESSAGES.GRIEVANCE_NOT_FOUND(grievanceId));
  }

  const grievanceData = data[grievanceRow];

  // Create temporary sheet for PDF
  const tempSheet = ss.insertSheet('Temp_PDF_' + new Date().getTime());

  try {
    // Format the grievance data
    formatGrievancePDFSheet(tempSheet, grievanceData);

    // Generate PDF
    const url = ss.getUrl();
    const sheetId = tempSheet.getSheetId();
    const pdfUrl = url.replace(/edit.*$/, '') +
      'export?exportFormat=pdf&format=pdf' +
      '&size=letter' +
      '&portrait=true' +
      '&fitw=true' +
      '&sheetnames=false&printtitle=false' +
      '&pagenumbers=false&gridlines=false' +
      '&fzr=false' +
      '&gid=' + sheetId;

    const token = ScriptApp.getOAuthToken();
    const response = UrlFetchApp.fetch(pdfUrl, {
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });

    const pdfBlob = response.getBlob().setName('Grievance_' + grievanceId + '.pdf');

    return pdfBlob;

  } finally {
    // Clean up temp sheet
    ss.deleteSheet(tempSheet);
  }
}

/**
 * Formats temporary sheet for PDF generation
 */
function formatGrievancePDFSheet(sheet, data) {
  sheet.clear();

  // Header
  sheet.getRange('A1:D1').merge()
    .setValue('SEIU LOCAL 509 - GRIEVANCE FORM')
    .setFontSize(18)
    .setFontWeight('bold')
    .setHorizontalAlignment('center')
    .setBackground('#7EC8E3')
    .setFontColor('white');

  let row = 3;

  // Member Information
  sheet.getRange(row, 1, 1, 4).merge()
    .setValue('MEMBER INFORMATION')
    .setFontWeight('bold')
    .setBackground('#E8F0FE');
  row++;

  addPDFField(sheet, row++, 'Grievance ID:', data[GRIEVANCE_COLS.GRIEVANCE_ID - 1]);
  addPDFField(sheet, row++, 'Member ID:', data[GRIEVANCE_COLS.MEMBER_ID - 1]);
  addPDFField(sheet, row++, 'Name:', data[GRIEVANCE_COLS.FIRST_NAME - 1] + ' ' + data[GRIEVANCE_COLS.LAST_NAME - 1]);
  row++;

  // Grievance Details
  sheet.getRange(row, 1, 1, 4).merge()
    .setValue('GRIEVANCE DETAILS')
    .setFontWeight('bold')
    .setBackground('#E8F0FE');
  row++;

  addPDFField(sheet, row++, 'Status:', data[GRIEVANCE_COLS.STATUS - 1]);
  addPDFField(sheet, row++, 'Current Step:', data[GRIEVANCE_COLS.CURRENT_STEP - 1]);
  addPDFField(sheet, row++, 'Incident Date:', data[GRIEVANCE_COLS.INCIDENT_DATE - 1] ? Utilities.formatDate(new Date(data[GRIEVANCE_COLS.INCIDENT_DATE - 1]), Session.getScriptTimeZone(), 'MM/dd/yyyy') : '');
  addPDFField(sheet, row++, 'Grievance Type:', data[GRIEVANCE_COLS.ISSUE_CATEGORY - 1]);
  addPDFField(sheet, row++, 'Steward:', data[GRIEVANCE_COLS.STEWARD - 1]);
  row++;

  // Description
  sheet.getRange(row, 1, 1, 4).merge()
    .setValue('DESCRIPTION')
    .setFontWeight('bold')
    .setBackground('#E8F0FE');
  row++;

  sheet.getRange(row, 1, 3, 4).merge()
    .setValue(data[GRIEVANCE_COLS.LOCATION - 1] || '')
    .setWrap(true)
    .setVerticalAlignment('top')
    .setBorder(true, true, true, true, false, false);

  // Auto-resize
  sheet.autoResizeColumns(1, 4);
  sheet.setColumnWidth(1, 150);
  sheet.setColumnWidth(2, 200);
  sheet.setColumnWidth(3, 150);
  sheet.setColumnWidth(4, 200);
}

/**
 * Helper to add field to PDF
 */
function addPDFField(sheet, row, label, value) {
  sheet.getRange(row, 1).setValue(label).setFontWeight('bold');
  sheet.getRange(row, 2, 1, 3).merge().setValue(value || '');
}

/**
 * Shows dialog with PDF email/download options
 */
function showPDFOptionsDialog(grievanceId, pdfBlob) {
  const html = HtmlService.createHtmlOutput(`
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h2 { color: #1a73e8; }
    .options { margin: 20px 0; }
    .option {
      padding: 15px;
      margin: 10px 0;
      border: 2px solid #ddd;
      border-radius: 5px;
      cursor: pointer;
    }
    .option:hover {
      background: #f0f0f0;
      border-color: #1a73e8;
    }
    input[type="email"] {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      background: #1a73e8;
      color: white;
      cursor: pointer;
    }
    button:hover { background: #1557b0; }
  </style>
</head>
<body>
  <h2>‚úÖ Grievance Created</h2>
  <p>Grievance ID: <strong>${grievanceId}</strong></p>

  <div class="options">
    <div class="option" onclick="showEmailForm()">
      <h3>üìß Email PDF</h3>
      <p>Send the grievance PDF to one or more recipients</p>
    </div>

    <div class="option" onclick="downloadPDF()">
      <h3>üíæ Download PDF</h3>
      <p>Download the grievance PDF to your computer</p>
    </div>
  </div>

  <div id="emailForm" style="display:none;">
    <h3>Email Recipients</h3>
    <p>Enter email addresses (comma-separated for multiple):</p>
    <input type="email" id="emailAddresses" placeholder="email1@example.com, email2@example.com">
    <br>
    <button onclick="sendEmail()">Send</button>
    <button onclick="document.getElementById('emailForm').style.display='none'">Cancel</button>
  </div>

  <script>
    function showEmailForm() {
      document.getElementById('emailForm').style.display = 'block';
    }

    function sendEmail() {
      const emails = document.getElementById('emailAddresses').value;
      if (!emails) {
        alert('Please enter at least one email address');
        return;
      }

      google.script.run
        .withSuccessHandler(function() {
          alert('‚úÖ Email sent successfully!');
          google.script.host.close();
        })
        .withFailureHandler(function(e) { return alert('‚ùå Error: ' + e.message); })
        .emailGrievancePDF('${grievanceId}', emails);
    }

    function downloadPDF() {
      alert('PDF download will start automatically.\\n\\nPlease check your Downloads folder.');
      google.script.run
        .withSuccessHandler(function(url) {
          window.open(url, '_blank');
          google.script.host.close();
        })
        .withFailureHandler(function(e) { return alert('‚ùå Error: ' + e.message); })
        .getGrievancePDFUrl('${grievanceId}');
    }
  </script>
</body>
</html>
  `).setWidth(500).setHeight(400);

  SpreadsheetApp.getUi().showModalDialog(html, 'Grievance PDF Options');
}

/**
 * Emails the grievance PDF
 */
function emailGrievancePDF(grievanceId, emailAddresses) {
  const pdfBlob = generateGrievancePDF(grievanceId);
  const emails = emailAddresses.split(',').map(function(e) { return e.trim(); });

  const subject = 'SEIU Local 509 - Grievance ' + grievanceId;
  const body = 'Please find attached the grievance form for ' + grievanceId + '.\n\n' +
               'This grievance was automatically generated from the SEIU Local 509 Dashboard.\n\n' +
               'For questions, please contact your steward.';

  emails.forEach(function(email) {
    if (email) {
      GmailApp.sendEmail(email, subject, body, {
        attachments: [pdfBlob]
      });
    }
  });
}

/**
 * Gets URL for grievance PDF
 */
function getGrievancePDFUrl(grievanceId) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!grievanceSheet) return null;

  const url = ss.getUrl();
  const sheetId = grievanceSheet.getSheetId();

  return url.replace(/edit.*$/, '') +
    'export?exportFormat=pdf&format=pdf' +
    '&size=letter' +
    '&portrait=true' +
    '&fitw=true' +
    '&gid=' + sheetId;
}

/* --------------------= START GRIEVANCE FROM MEMBER DIRECTORY --------------------= */

/**
 * Opens the grievance intake form with prepopulated member information
 * Called when user clicks the Start Grievance checkbox in Member Directory
 * @param {number} memberRow - The row number of the member in Member Directory
 */
function openGrievanceFormForMember(memberRow) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (!memberSheet) {
    SpreadsheetApp.getUi().alert('‚ùå Member Directory not found!');
    return;
  }

  // Get grievance form URL from Config sheet
  const formUrl = getGrievanceIntakeFormUrl();

  if (!formUrl) {
    SpreadsheetApp.getUi().alert(
      'üìù Grievance Intake Form URL Not Configured',
      'No Grievance Form URL has been added to the Config tab.\n\n' +
      'To configure:\n' +
      '1. Go to the Config tab\n' +
      '2. Find the "Grievance Form URL" column (column O)\n' +
      '3. Paste your Google Form URL in row 3\n\n' +
      'The form URL should look like:\n' +
      'https://docs.google.com/forms/d/e/YOUR_FORM_ID/viewform',
      SpreadsheetApp.getUi().ButtonSet.OK
    );
    return;
  }

  // Get member data from the row
  const memberData = memberSheet.getRange(memberRow, 1, 1, MEMBER_COLS.START_GRIEVANCE).getValues()[0];
  const member = {
    id: memberData[MEMBER_COLS.MEMBER_ID - 1] || '',
    firstName: memberData[MEMBER_COLS.FIRST_NAME - 1] || '',
    lastName: memberData[MEMBER_COLS.LAST_NAME - 1] || '',
    jobTitle: memberData[MEMBER_COLS.JOB_TITLE - 1] || '',
    location: memberData[MEMBER_COLS.WORK_LOCATION - 1] || '',
    unit: memberData[MEMBER_COLS.UNIT - 1] || '',
    email: memberData[MEMBER_COLS.EMAIL - 1] || '',
    phone: memberData[MEMBER_COLS.PHONE - 1] || '',
    supervisor: memberData[MEMBER_COLS.SUPERVISOR - 1] || '',
    manager: memberData[MEMBER_COLS.MANAGER - 1] || '',
    assignedSteward: memberData[MEMBER_COLS.ASSIGNED_STEWARD - 1] || ''
  };

  // Build pre-filled form URL
  const preFilledUrl = buildPreFilledGrievanceUrl(formUrl, member);

  // Show dialog with member info and open form button
  const html = HtmlService.createHtmlOutput(`
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
      margin: 0;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 {
      color: #5B4B9E;
      margin-top: 0;
      border-bottom: 3px solid #5B4B9E;
      padding-bottom: 10px;
    }
    .member-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      border-left: 4px solid #5B4B9E;
    }
    .info-row {
      margin: 8px 0;
      display: flex;
    }
    .info-label {
      font-weight: bold;
      width: 120px;
      color: #333;
    }
    .info-value {
      color: #555;
    }
    .button-group {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-primary {
      background: #5B4B9E;
      color: white;
    }
    .btn-primary:hover {
      background: #4a3d82;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(91, 75, 158, 0.4);
    }
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    .btn-secondary:hover {
      background: #d0d0d0;
    }
    .note {
      font-size: 12px;
      color: #666;
      margin-top: 15px;
      padding: 10px;
      background: #e8f4fd;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìã Start Grievance for Member</h2>

    <div class="member-info">
      <div class="info-row"><span class="info-label">Name:</span><span class="info-value">${escapeHtml(member.firstName)} ${escapeHtml(member.lastName)}</span></div>
      <div class="info-row"><span class="info-label">Member ID:</span><span class="info-value">${escapeHtml(member.id)}</span></div>
      <div class="info-row"><span class="info-label">Email:</span><span class="info-value">${escapeHtml(member.email) || 'Not provided'}</span></div>
      <div class="info-row"><span class="info-label">Phone:</span><span class="info-value">${escapeHtml(member.phone) || 'Not provided'}</span></div>
      <div class="info-row"><span class="info-label">Job Title:</span><span class="info-value">${escapeHtml(member.jobTitle)}</span></div>
      <div class="info-row"><span class="info-label">Location:</span><span class="info-value">${escapeHtml(member.location)}</span></div>
      <div class="info-row"><span class="info-label">Unit:</span><span class="info-value">${escapeHtml(member.unit)}</span></div>
    </div>

    <div class="note">
      ‚ÑπÔ∏è Clicking "Open Grievance Form" will open the grievance intake form in a new window with the member's information pre-filled.
    </div>

    <div class="button-group">
      <button class="btn-primary" onclick="openForm()">üìù Open Grievance Form</button>
      <button class="btn-secondary" onclick="google.script.host.close()">Cancel</button>
    </div>
  </div>

  <script>
    function openForm() {
      window.open('${preFilledUrl}', '_blank');
      google.script.host.close();
    }
  </script>
</body>
</html>
  `).setWidth(500).setHeight(450);

  SpreadsheetApp.getUi().showModalDialog(html, 'üìã Start Grievance');
}

/**
 * Gets the Grievance Intake Form URL from the Config sheet
 * @returns {string} The form URL or empty string if not configured
 */
function getGrievanceIntakeFormUrl() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const configSheet = ss.getSheetByName(SHEETS.CONFIG);

  if (!configSheet) {
    Logger.log('Config sheet not found');
    return '';
  }

  // Grievance Form URL is in column O (15), row 3 (first data row)
  const url = configSheet.getRange(3, CONFIG_COLS.GRIEVANCE_FORM_URL).getValue();
  return url ? url.toString().trim() : '';
}

/**
 * Builds a pre-filled Google Form URL with member information
 * @param {string} baseUrl - The base Google Form URL
 * @param {Object} member - Member data object
 * @returns {string} Pre-filled form URL
 */
function buildPreFilledGrievanceUrl(baseUrl, member) {
  // If form field IDs are configured, use them
  const fieldIds = GRIEVANCE_FORM_CONFIG.FIELD_IDS;

  const params = new URLSearchParams();
  params.append(fieldIds.MEMBER_ID, member.id);
  params.append(fieldIds.MEMBER_FIRST_NAME, member.firstName);
  params.append(fieldIds.MEMBER_LAST_NAME, member.lastName);
  params.append(fieldIds.MEMBER_EMAIL, member.email);
  params.append(fieldIds.MEMBER_PHONE, member.phone);
  params.append(fieldIds.MEMBER_JOB_TITLE, member.jobTitle);
  params.append(fieldIds.MEMBER_LOCATION, member.location);
  params.append(fieldIds.MEMBER_UNIT, member.unit);

  // Get steward info if available
  const steward = getStewardContactInfo();
  if (steward.name) {
    params.append(fieldIds.STEWARD_NAME, steward.name);
  }
  if (steward.email) {
    params.append(fieldIds.STEWARD_EMAIL, steward.email);
  }

  return baseUrl + '?' + params.toString();
}



// ================================================================================
// MODULE: IdempotentOperations.gs
// Source: IdempotentOperations.gs
// ================================================================================

/****************************************************
 * IDEMPOTENT OPERATIONS WRAPPER
 * Phase 6 - Medium Priority
 *
 * Makes operations safe to retry without creating duplicates
 * Tracks operation state to ensure idempotency
 *
 * Based on ADDITIONAL_ENHANCEMENTS.md Phase 3
 ****************************************************/

/**
 * Make a function idempotent using caching
 * Operations can be safely retried without side effects
 *
 * @param {Function} operation - The operation to make idempotent
 * @param {Function} keyGenerator - Function to generate unique key from arguments
 * @param {number} ttl - Cache time-to-live in seconds (default: 600 = 10 minutes)
 * @returns {Function} Idempotent version of the operation
 */
function makeIdempotent(operation, keyGenerator, ttl = 600) {
  return function(...args) {
    const key = keyGenerator(...args);
    const cache = CacheService.getScriptCache();

    const lockKey = `lock_${key}`;
    const resultKey = `result_${key}`;

    // Check if operation already in progress
    const inProgress = cache.get(lockKey);
    if (inProgress) {
      throw new Error(
        `Operation "${key}" is already in progress. ` +
        `Please wait for it to complete before retrying.`
      );
    }

    // Check if operation already completed
    const cachedResult = cache.get(resultKey);
    if (cachedResult) {
      Logger.log(`Returning cached result for operation: ${key}`);

      try {
        return JSON.parse(cachedResult);
      } catch (e) {
        // If result can't be parsed, re-execute
        Logger.log(`Failed to parse cached result, will re-execute`);
      }
    }

    try {
      // Set lock (5 minute max duration)
      cache.put(lockKey, 'true', 300);
      Logger.log(`Lock acquired for operation: ${key}`);

      // Execute operation
      const result = operation.apply(this, args);

      // Cache result
      try {
        cache.put(resultKey, JSON.stringify(result), ttl);
        Logger.log(`Result cached for operation: ${key} (TTL: ${ttl}s)`);
      } catch (e) {
        // Result might not be serializable, log but don't fail
        Logger.log(`Could not cache result: ${e.message}`);
      }

      return result;

    } finally {
      // Always remove lock
      cache.remove(lockKey);
      Logger.log(`Lock released for operation: ${key}`);
    }
  };
}

/**
 * Idempotent member addition
 * Safe to retry - won't create duplicates
 */
const addMemberIdempotent = makeIdempotent(
  function(memberData) {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

    if (!memberSheet) {
      throw new Error('Member Directory sheet not found');
    }

    const memberID = memberData[MEMBER_COLS.MEMBER_ID - 1];

    // Check if member already exists
    const data = memberSheet.getDataRange().getValues();
    const existingRow = data.findIndex(function(row) { return row[MEMBER_COLS.MEMBER_ID - 1] === memberID; });

    if (existingRow > 0) {
      // Update existing member
      memberSheet.getRange(existingRow + 1, 1, 1, memberData.length).setValues([memberData]);
      Logger.log(`Updated existing member: ${memberID}`);

      return {
        action: 'updated',
        memberID: memberID,
        row: existingRow + 1
      };
    } else {
      // Add new member
      memberSheet.appendRow(memberData);
      const newRow = memberSheet.getLastRow();
      Logger.log(`Added new member: ${memberID}`);

      return {
        action: 'added',
        memberID: memberID,
        row: newRow
      };
    }
  },
  function(memberData) { return `add_member_${memberData[MEMBER_COLS.MEMBER_ID - 1]}`; } // Use Member ID as key
);

/**
 * Idempotent grievance addition
 */
const addGrievanceIdempotent = makeIdempotent(
  function(grievanceData) {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

    if (!grievanceSheet) {
      throw new Error('Grievance Log sheet not found');
    }

    const grievanceID = grievanceData[GRIEVANCE_COLS.GRIEVANCE_ID - 1];

    // Check if grievance already exists
    const data = grievanceSheet.getDataRange().getValues();
    const existingRow = data.findIndex(function(row) { return row[GRIEVANCE_COLS.GRIEVANCE_ID - 1] === grievanceID; });

    if (existingRow > 0) {
      // Update existing grievance
      grievanceSheet.getRange(existingRow + 1, 1, 1, grievanceData.length).setValues([grievanceData]);
      Logger.log(`Updated existing grievance: ${grievanceID}`);

      return {
        action: 'updated',
        grievanceID: grievanceID,
        row: existingRow + 1
      };
    } else {
      // Add new grievance
      grievanceSheet.appendRow(grievanceData);
      const newRow = grievanceSheet.getLastRow();
      Logger.log(`Added new grievance: ${grievanceID}`);

      return {
        action: 'added',
        grievanceID: grievanceID,
        row: newRow
      };
    }
  },
  function(grievanceData) { return `add_grievance_${grievanceData[GRIEVANCE_COLS.GRIEVANCE_ID - 1]}`; } // Use Grievance ID as key
);

/**
 * Idempotent backup creation
 * Won't create duplicate backups if retried within TTL
 */
const createBackupIdempotent = makeIdempotent(
  function() {
    if (typeof createIncrementalBackup === 'function') {
      return createIncrementalBackup();
    }

    throw new Error('createIncrementalBackup function not available');
  },
  function() {
    // Key is based on current hour - allows one backup per hour
    const now = new Date();
    const hourKey = Utilities.formatDate(now, Session.getScriptTimeZone(), 'yyyy-MM-dd-HH');
    return `backup_${hourKey}`;
  },
  3600 // 1 hour TTL
);

/**
 * Idempotent recalculation wrapper
 * Prevents multiple simultaneous recalculations
 */
const recalcAllIdempotent = makeIdempotent(
  function() {
    // Run both member and grievance recalculations
    const results = {};

    if (typeof recalcAllMembers === 'function') {
      results.members = recalcAllMembers();
    }

    if (typeof recalcAllGrievancesBatched === 'function') {
      results.grievances = recalcAllGrievancesBatched();
    }

    return results;
  },
  function() {
    // Key is based on current 5-minute window
    const now = new Date();
    const minutes = Math.floor(now.getMinutes() / 5) * 5;
    const timeKey = Utilities.formatDate(now, Session.getScriptTimeZone(), 'yyyy-MM-dd-HH') + `-${minutes}`;
    return `recalc_all_${timeKey}`;
  },
  300 // 5 minute TTL
);

/**
 * Idempotent dashboard rebuild
 */
const rebuildDashboardIdempotent = makeIdempotent(
  function() {
    if (typeof rebuildDashboardOptimized === 'function') {
      return rebuildDashboardOptimized();
    } else if (typeof rebuildDashboard === 'function') {
      return rebuildDashboard();
    }

    throw new Error('No dashboard rebuild function available');
  },
  function() {
    // Key is based on current 5-minute window
    const now = new Date();
    const minutes = Math.floor(now.getMinutes() / 5) * 5;
    const timeKey = Utilities.formatDate(now, Session.getScriptTimeZone(), 'yyyy-MM-dd-HH') + `-${minutes}`;
    return `rebuild_dashboard_${timeKey}`;
  },
  300 // 5 minute TTL
);

/**
 * Clear all idempotent caches
 * Use when you need to force re-execution of operations
 */
function clearIdempotentCache() {
  const cache = CacheService.getScriptCache();

  // Remove all keys with common prefixes
  const prefixes = [
    'lock_',
    'result_',
    'add_member_',
    'add_grievance_',
    'backup_',
    'recalc_all_',
    'rebuild_dashboard_'
  ];

  // Note: CacheService doesn't have a way to list all keys
  // So we can only remove specific known patterns
  // Store a list of active keys in properties for tracking

  const props = PropertiesService.getScriptProperties();
  const activeKeys = props.getProperty('IDEMPOTENT_KEYS');

  if (activeKeys) {
    const keys = JSON.parse(activeKeys);

    for (const key of keys) {
      cache.remove(key);
      cache.remove(`lock_${key}`);
      cache.remove(`result_${key}`);
    }

    props.deleteProperty('IDEMPOTENT_KEYS');
    Logger.log(`Cleared ${keys.length} idempotent cache entries`);

  } else {
    Logger.log('No active idempotent cache entries found');
  }

  const ui = SpreadsheetApp.getUi();
  ui.alert(
    'Idempotent Cache Cleared',
    'All cached operation results have been cleared.\n\n' +
    'Operations will re-execute on next call.',
    ui.ButtonSet.OK
  );
}

/**
 * Show idempotent operation status
 */
function showIdempotentStatus() {
  const cache = CacheService.getScriptCache();
  const props = PropertiesService.getScriptProperties();
  const activeKeys = props.getProperty('IDEMPOTENT_KEYS');

  const ui = SpreadsheetApp.getUi();

  if (!activeKeys) {
    ui.alert(
      'Idempotent Operations',
      'No cached operations found.\n\n' +
      'All operations are fresh and can be executed.',
      ui.ButtonSet.OK
    );
    return;
  }

  const keys = JSON.parse(activeKeys);

  let message = `Active Idempotent Operations: ${keys.length}\n\n`;

  for (const key of keys) {
    const hasResult = cache.get(`result_${key}`) !== null;
    const hasLock = cache.get(`lock_${key}`) !== null;

    message += `‚Ä¢ ${key}\n`;
    if (hasLock) {
      message += `  Status: In Progress\n`;
    } else if (hasResult) {
      message += `  Status: Completed (Cached)\n`;
    } else {
      message += `  Status: Unknown\n`;
    }
  }

  ui.alert('Idempotent Operations', message, ui.ButtonSet.OK);
}

/**
 * Track active idempotent keys
 * @param {string} key - Operation key to track
 */
function trackIdempotentKey(key) {
  const props = PropertiesService.getScriptProperties();
  const activeKeys = props.getProperty('IDEMPOTENT_KEYS');

  const keys = activeKeys ? JSON.parse(activeKeys) : [];

  if (!keys.includes(key)) {
    keys.push(key);
    props.setProperty('IDEMPOTENT_KEYS', JSON.stringify(keys));
  }
}

/**
 * Menu functions
 */
function CLEAR_IDEMPOTENT_CACHE() {
  clearIdempotentCache();
}

function SHOW_IDEMPOTENT_STATUS() {
  showIdempotentStatus();
}



// ================================================================================
// MODULE: IncrementalBackupSystem.gs
// Source: IncrementalBackupSystem.gs
// ================================================================================

/****************************************************
 * INCREMENTAL BACKUP SYSTEM
 * Phase 6 - Critical Priority
 *
 * Automated backup system with 30-day retention
 * Complete disaster recovery capability
 *
 * Based on ADDITIONAL_ENHANCEMENTS.md Phase 1
 ****************************************************/

/**
 * Create an incremental backup of the entire spreadsheet
 * Backs up to a specified Google Drive folder
 * @returns {string} Backup file ID
 */
function createIncrementalBackup() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const props = PropertiesService.getScriptProperties();

  // Get or create backup folder ID
  let backupFolderId = props.getProperty('BACKUP_FOLDER_ID');

  if (!backupFolderId) {
    // Create backup folder if it doesn't exist
    backupFolderId = createBackupFolder();
    props.setProperty('BACKUP_FOLDER_ID', backupFolderId);
  }

  try {
    const folder = DriveApp.getFolderById(backupFolderId);
    const timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy-MM-dd_HH-mm-ss');
    const backupName = `509-Dashboard-Backup-${timestamp}`;

    Logger.log(`Creating backup: ${backupName}`);

    // Create backup copy
    const backup = ss.copy(backupName);

    // Move to backup folder
    const backupFile = DriveApp.getFileById(backup.getId());
    folder.addFile(backupFile);

    // Remove from root folder
    try {
      DriveApp.getRootFolder().removeFile(backupFile);
    } catch (e) {
      // File might not be in root, ignore error
      Logger.log('File not in root folder, skipping removal');
    }

    // Add metadata
    backupFile.setDescription(
      `Automated backup created at ${new Date().toISOString()}\n` +
      `Original file: ${ss.getName()}\n` +
      `Backup system: 509 Dashboard Incremental Backup`
    );

    Logger.log(`Backup created successfully: ${backup.getId()}`);

    // Clean up old backups
    cleanupOldBackups(folder);

    // Log to audit if available
    if (typeof auditLog === 'function') {
      auditLog('INCREMENTAL_BACKUP', {
        backupId: backup.getId(),
        backupName: backupName,
        timestamp: timestamp,
        folderId: backupFolderId,
        status: 'SUCCESS'
      });
    }

    // Update last backup timestamp
    props.setProperty('LAST_BACKUP_TIMESTAMP', new Date().getTime().toString());

    return backup.getId();

  } catch (error) {
    Logger.log(`Backup failed: ${error.message}`);

    if (typeof logError === 'function') {
      logError(error, 'createIncrementalBackup', 'CRITICAL');
    }

    throw error;
  }
}

/**
 * Create the backup folder in Google Drive
 * @returns {string} Folder ID
 */
function createBackupFolder() {
  const folderName = '509 Dashboard Backups';

  // Check if folder already exists
  const folders = DriveApp.getFoldersByName(folderName);

  if (folders.hasNext()) {
    const folder = folders.next();
    Logger.log(`Using existing backup folder: ${folder.getId()}`);
    return folder.getId();
  }

  // Create new folder
  const folder = DriveApp.createFolder(folderName);
  folder.setDescription('Automated backups of 509 Dashboard system');

  Logger.log(`Created backup folder: ${folder.getId()}`);
  return folder.getId();
}

/**
 * Clean up backups older than 30 days
 * @param {Folder} folder - Google Drive folder containing backups
 * @returns {number} Number of backups deleted
 */
function cleanupOldBackups(folder) {
  const thirtyDaysAgo = new Date(Date.now() - (30 * 24 * 60 * 60 * 1000));
  let deletedCount = 0;

  try {
    const files = folder.getFilesByType(MimeType.GOOGLE_SHEETS);

    while (files.hasNext()) {
      const file = files.next();
      const created = file.getDateCreated();

      if (created < thirtyDaysAgo) {
        Logger.log(`Deleting old backup: ${file.getName()} (created ${created})`);
        file.setTrashed(true);
        deletedCount++;
      }
    }

    if (deletedCount > 0) {
      Logger.log(`Cleaned up ${deletedCount} old backup(s)`);

      if (typeof auditLog === 'function') {
        auditLog('BACKUP_CLEANUP', {
          deletedCount: deletedCount,
          retentionDays: 30,
          status: 'SUCCESS'
        });
      }
    }

  } catch (error) {
    Logger.log(`Error during backup cleanup: ${error.message}`);
  }

  return deletedCount;
}

/**
 * Scheduled backup function to run daily
 * Set up a time-driven trigger to call this daily
 */
function scheduledBackup() {
  try {
    Logger.log('=== Starting Scheduled Backup ===');

    const backupId = createIncrementalBackup();

    Logger.log(`‚úÖ Backup created successfully: ${backupId}`);
    Logger.log('=== Scheduled Backup Complete ===');

  } catch (error) {
    Logger.log(`‚ùå Scheduled backup failed: ${error.message}`);

    // Send email notification on failure
    notifyBackupFailure(error);
  }
}

/**
 * Send email notification when backup fails
 * @param {Error} error - The error that occurred
 */
function notifyBackupFailure(error) {
  const props = PropertiesService.getScriptProperties();
  const adminEmail = props.getProperty('ADMINS');

  if (!adminEmail) {
    Logger.log('No admin email configured for backup failure notification');
    return;
  }

  const subject = '‚ùå 509 Dashboard Backup Failed';
  const body = `The automated backup of the 509 Dashboard failed at ${new Date()}.\n\n` +
               `Error: ${error.message}\n\n` +
               `Stack trace:\n${error.stack || 'Not available'}\n\n` +
               `Please check the backup system and ensure it runs successfully.`;

  try {
    MailApp.sendEmail(adminEmail, subject, body);
    Logger.log(`Backup failure notification sent to ${adminEmail}`);
  } catch (emailError) {
    Logger.log(`Failed to send backup failure email: ${emailError.message}`);
  }
}

/**
 * List all available backups
 * @returns {Array} Array of backup information
 */
function listBackups() {
  const props = PropertiesService.getScriptProperties();
  const backupFolderId = props.getProperty('BACKUP_FOLDER_ID');

  if (!backupFolderId) {
    Logger.log('No backup folder configured');
    return [];
  }

  try {
    const folder = DriveApp.getFolderById(backupFolderId);
    const files = folder.getFilesByType(MimeType.GOOGLE_SHEETS);
    const backups = [];

    while (files.hasNext()) {
      const file = files.next();
      backups.push({
        id: file.getId(),
        name: file.getName(),
        created: file.getDateCreated(),
        size: file.getSize(),
        url: file.getUrl()
      });
    }

    // Sort by creation date (newest first)
    backups.sort(function(a, b) { return b.created - a.created; });

    return backups;

  } catch (error) {
    Logger.log(`Error listing backups: ${error.message}`);
    return [];
  }
}

/**
 * Show backup information in UI
 */
function showBackupInfo() {
  const ui = SpreadsheetApp.getUi();
  const backups = listBackups();

  if (backups.length === 0) {
    ui.alert(
      'No Backups Found',
      'No backups have been created yet.\n\n' +
      'Create your first backup by selecting:\n' +
      'üìä 509 Dashboard > Admin > Create Backup',
      ui.ButtonSet.OK
    );
    return;
  }

  let message = `Total Backups: ${backups.length}\n\n`;
  message += 'Recent Backups:\n';
  message += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';

  // Show most recent 10 backups
  const recentBackups = backups.slice(0, 10);

  for (const backup of recentBackups) {
    const dateStr = Utilities.formatDate(
      backup.created,
      Session.getScriptTimeZone(),
      'yyyy-MM-dd HH:mm:ss'
    );
    const sizeMB = (backup.size / (1024 * 1024)).toFixed(2);

    message += `${dateStr} - ${sizeMB} MB\n`;
  }

  if (backups.length > 10) {
    message += `\n... and ${backups.length - 10} more\n`;
  }

  message += '\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
  message += `Retention: 30 days\n`;
  message += `Folder: 509 Dashboard Backups\n`;

  const props = PropertiesService.getScriptProperties();
  const lastBackup = props.getProperty('LAST_BACKUP_TIMESTAMP');

  if (lastBackup) {
    const lastDate = new Date(parseInt(lastBackup));
    const lastDateStr = Utilities.formatDate(
      lastDate,
      Session.getScriptTimeZone(),
      'yyyy-MM-dd HH:mm:ss'
    );
    message += `Last Backup: ${lastDateStr}\n`;
  }

  ui.alert('Backup Information', message, ui.ButtonSet.OK);
}

/**
 * Menu function to create backup manually
 */
function CREATE_BACKUP() {
  const ui = SpreadsheetApp.getUi();

  const response = ui.alert(
    'Create Backup?',
    'This will create a complete backup of the entire spreadsheet.\n\n' +
    'The backup will be saved to Google Drive and kept for 30 days.\n\n' +
    'Continue?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return;
  }

  try {
    ui.alert('Creating backup...');

    const backupId = createIncrementalBackup();

    const backupFile = DriveApp.getFileById(backupId);

    ui.alert(
      'Backup Created!',
      `Backup created successfully.\n\n` +
      `Name: ${backupFile.getName()}\n` +
      `Size: ${(backupFile.getSize() / (1024 * 1024)).toFixed(2)} MB\n` +
      `Created: ${backupFile.getDateCreated()}\n\n` +
      `The backup is stored in: 509 Dashboard Backups`,
      ui.ButtonSet.OK
    );

  } catch (error) {
    ui.alert(
      'Backup Failed',
      `Failed to create backup: ${error.message}\n\n` +
      `Please check the error log for details.`,
      ui.ButtonSet.OK
    );
  }
}

/**
 * Restore from a specific backup
 * Note: This requires manual user selection of which backup to restore
 * @param {string} backupId - ID of the backup file to restore from
 */
function restoreFromBackup(backupId) {
  const ui = SpreadsheetApp.getUi();

  const response = ui.alert(
    'Restore from Backup?',
    'WARNING: This will replace ALL current data with the backup.\n\n' +
    'This action cannot be undone.\n\n' +
    'Are you sure you want to continue?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return;
  }

  try {
    const currentSs = SpreadsheetApp.getActiveSpreadsheet();
    const backupSs = SpreadsheetApp.openById(backupId);

    // Copy all sheets from backup to current
    const backupSheets = backupSs.getSheets();

    // First, create backup of current state (just in case)
    const emergencyBackup = createIncrementalBackup();
    Logger.log(`Emergency backup created before restore: ${emergencyBackup}`);

    ui.alert('Restoring data...');

    // Delete existing sheets and copy from backup
    const currentSheets = currentSs.getSheets();

    // Copy sheets from backup
    for (const sheet of backupSheets) {
      const sheetName = sheet.getName();

      // Delete if exists
      const existing = currentSs.getSheetByName(sheetName);
      if (existing) {
        currentSs.deleteSheet(existing);
      }

      // Copy from backup
      sheet.copyTo(currentSs).setName(sheetName);
    }

    ui.alert(
      'Restore Complete',
      `Data restored successfully from backup.\n\n` +
      `Backup ID: ${backupId}\n\n` +
      `An emergency backup of the pre-restore state was also created: ${emergencyBackup}`,
      ui.ButtonSet.OK
    );

    if (typeof auditLog === 'function') {
      auditLog('BACKUP_RESTORE', {
        backupId: backupId,
        emergencyBackupId: emergencyBackup,
        status: 'SUCCESS'
      });
    }

  } catch (error) {
    ui.alert(
      'Restore Failed',
      `Failed to restore from backup: ${error.message}`,
      ui.ButtonSet.OK
    );

    if (typeof logError === 'function') {
      logError(error, 'restoreFromBackup', 'CRITICAL');
    }
  }
}

/**
 * Set up automated daily backup trigger
 */
function setupDailyBackupTrigger() {
  // Delete existing triggers for this function to avoid duplicates
  const triggers = ScriptApp.getProjectTriggers();

  for (const trigger of triggers) {
    if (trigger.getHandlerFunction() === 'scheduledBackup') {
      ScriptApp.deleteTrigger(trigger);
    }
  }

  // Create new trigger - runs daily at 2 AM
  ScriptApp.newTrigger('scheduledBackup')
    .timeBased()
    .atHour(2)
    .everyDays(1)
    .create();

  Logger.log('Daily backup trigger created (runs at 2 AM)');

  const ui = SpreadsheetApp.getUi();
  ui.alert(
    'Automated Backup Enabled',
    'Daily automated backups have been configured.\n\n' +
    'Backups will run every day at 2:00 AM.\n' +
    'Retention period: 30 days',
    ui.ButtonSet.OK
  );
}



// ================================================================================
// MODULE: InteractiveDashboard.gs
// Source: InteractiveDashboard.gs
// ================================================================================

// ------------------------------------------------------------------------====
// INTERACTIVE DASHBOARD - USER-SELECTABLE METRICS & CHARTS
// ------------------------------------------------------------------------====
//
// Features:
// - User-selectable metrics with dropdown controls
// - Dynamic chart type selection (Pie, Donut, Bar, Line, Column)
// - Side-by-side metric comparison
// - Card-based modern layout
// - Theme customization
// - Warehouse-style location charts
// - Real-time chart updates based on user selection
//
// ------------------------------------------------------------------------====

/**
 * Creates the Interactive Dashboard sheet with user-selectable controls
 */
function createInteractiveDashboardSheet(ss) {
  let sheet = ss.getSheetByName(SHEETS.INTERACTIVE_DASHBOARD);
  if (!sheet) sheet = ss.insertSheet(SHEETS.INTERACTIVE_DASHBOARD);

  sheet.clear();

  // ------------------------------------------------------------=========
  // HEADER SECTION
  // ------------------------------------------------------------=========
  sheet.getRange("A1:T1").merge()
    .setValue("‚ú® YOUR UNION DASHBOARD - Where Data Comes Alive!")
    .setFontSize(22).setFontFamily("Roboto")
    .setFontWeight("bold")
    .setHorizontalAlignment("center")
    .setBackground(COLORS.PRIMARY_BLUE)
    .setFontColor("white");
  sheet.setRowHeight(1, 45);

  // Subtitle
  sheet.getRange("A2:T2").merge()
    .setValue("üéâ Welcome! Watch your data dance, celebrate your victories, and track your progress together!")
    .setFontSize(11).setFontFamily("Roboto")
    .setFontStyle("italic")
    .setHorizontalAlignment("center")
    .setBackground(COLORS.LIGHT_GRAY)
    .setFontColor(COLORS.TEXT_GRAY);

  // Gentle guidance tip
  sheet.getRange("A3:T3").merge()
    .setValue("üí° Pro Tip: Select your metrics below, then watch as your dashboard springs to life with insights and celebrations!")
    .setFontSize(10).setFontFamily("Roboto")
    .setFontStyle("italic")
    .setHorizontalAlignment("center")
    .setBackground(COLORS.WHITE)
    .setFontColor(COLORS.ACCENT_TEAL);

  // ------------------------------------------------------------=========
  // CONTROL PANEL - Row 4
  // ------------------------------------------------------------=========
  sheet.getRange("A4:T4").merge()
    .setValue("üéõÔ∏è YOUR COMMAND CENTER - Make This Dashboard Your Own!")
    .setFontSize(14).setFontFamily("Roboto")
    .setFontWeight("bold")
    .setHorizontalAlignment("center")
    .setBackground(COLORS.ACCENT_TEAL)
    .setFontColor("white");

  // Control labels and dropdowns (Row 6-7)
  const controls = [
    ["Metric 1:", "Chart Type 1:", "Metric 2:", "Chart Type 2:", "Theme:"],
    ["", "", "", "", ""]
  ];

  sheet.getRange("A6:E6").setValues([controls[0]])
    .setFontWeight("bold")
    .setFontSize(10).setFontFamily("Roboto")
    .setBackground(COLORS.LIGHT_GRAY)
    .setHorizontalAlignment("right");

  // Dropdown cells (to be populated with data validation)
  sheet.getRange("A7:E7")
    .setBackground(COLORS.WHITE)
    .setBorder(true, true, true, true, true, true, COLORS.BORDER_GRAY, SpreadsheetApp.BorderStyle.SOLID);

  // Comparison toggle
  sheet.getRange("G6").setValue("Enable Comparison:")
    .setFontWeight("bold")
    .setFontSize(10).setFontFamily("Roboto")
    .setBackground(COLORS.LIGHT_GRAY)
    .setHorizontalAlignment("right");

  sheet.getRange("G7")
    .setBackground(COLORS.WHITE)
    .setBorder(true, true, true, true, true, true, COLORS.BORDER_GRAY, SpreadsheetApp.BorderStyle.SOLID);

  // Refresh button area
  sheet.getRange("I6").setValue("Action:")
    .setFontWeight("bold")
    .setFontSize(10).setFontFamily("Roboto")
    .setBackground(COLORS.LIGHT_GRAY)
    .setHorizontalAlignment("right");

  sheet.getRange("I7").setValue("‚ú® Ready to see the magic? Click '509 Tools > Interactive Dashboard > Refresh Charts'")
    .setFontSize(9).setFontFamily("Roboto")
    .setFontStyle("italic")
    .setBackground(COLORS.LIGHT_GRAY)
    .setHorizontalAlignment("left");

  // ------------------------------------------------------------=========
  // METRIC CARDS SECTION - Row 10-18 (4 cards)
  // ------------------------------------------------------------=========
  sheet.getRange("A10:T10").merge()
    .setValue("üìà YOUR VICTORIES AT A GLANCE - Watch These Numbers Grow!")
    .setFontSize(14).setFontFamily("Roboto")
    .setFontWeight("bold")
    .setHorizontalAlignment("center")
    .setBackground(COLORS.PRIMARY_BLUE)
    .setFontColor("white");

  // Create 4 metric cards
  const cardPositions = [
    {col: "A", endCol: "E", title: "üíô Our Growing Family", color: COLORS.ACCENT_TEAL},
    {col: "F", endCol: "J", title: "üî• Active Cases", color: COLORS.ACCENT_ORANGE},
    {col: "K", endCol: "O", title: "üèÜ Victory Rate", color: COLORS.UNION_GREEN},
    {col: "P", endCol: "T", title: "‚è∞ Needs Attention", color: COLORS.SOLIDARITY_RED}
  ];

  cardPositions.forEach(function(card, idx) {
    const startRow = 12;
    const endRow = 18;

    // Card border
    sheet.getRange(`${card.col}${startRow}:${card.endCol}${endRow}`)
      .setBackground(COLORS.WHITE)
      .setBorder(true, true, true, true, false, false, COLORS.BORDER_GRAY, SpreadsheetApp.BorderStyle.SOLID_MEDIUM);

    // Top colored bar
    sheet.getRange(`${card.col}${startRow}:${card.endCol}${startRow}`)
      .setBorder(true, null, null, null, null, null, card.color, SpreadsheetApp.BorderStyle.SOLID_THICK);

    // Card title
    sheet.getRange(`${card.col}${startRow + 1}:${card.endCol}${startRow + 1}`).merge()
      .setValue(card.title)
      .setFontWeight("bold")
      .setFontSize(11).setFontFamily("Roboto")
      .setHorizontalAlignment("center")
      .setFontColor(COLORS.TEXT_GRAY);

    // Big number (to be populated)
    sheet.getRange(`${card.col}${startRow + 2}:${card.endCol}${startRow + 4}`).merge()
      .setFontSize(48)
      .setFontWeight("bold")
      .setFontFamily("Roboto")
      .setHorizontalAlignment("center")
      .setVerticalAlignment("middle")
      .setFontColor(card.color);

    // Trend indicator (to be populated)
    sheet.getRange(`${card.col}${startRow + 5}:${card.endCol}${startRow + 6}`).merge()
      .setFontSize(10)
      .setFontFamily("Roboto")
      .setHorizontalAlignment("center")
      .setVerticalAlignment("middle")
      .setFontColor(COLORS.TEXT_GRAY)
      .setValue("üìà Growing Together");
  });

  // ------------------------------------------------------------=========
  // CHART AREA 1 - Row 21-42 (Selected Metric 1)
  // ------------------------------------------------------------=========
  sheet.getRange("A21:J21").merge()
    .setValue("üìä YOUR STORY IN CHARTS - Watch Your Data Come to Life!")
    .setFontSize(13).setFontFamily("Roboto")
    .setFontWeight("bold")
    .setHorizontalAlignment("center")
    .setBackground(COLORS.ACCENT_TEAL)
    .setFontColor("white");

  sheet.getRange("A22:J42")
    .setBackground(COLORS.WHITE)
    .setBorder(true, true, true, true, false, false, COLORS.BORDER_GRAY, SpreadsheetApp.BorderStyle.SOLID);

  sheet.getRange("A23:J23").merge()
    .setValue("üé® Your chart is waiting to spring to life! Select a metric above and hit refresh")
    .setFontSize(11).setFontFamily("Roboto")
    .setFontStyle("italic")
    .setHorizontalAlignment("center")
    .setVerticalAlignment("middle")
    .setFontColor(COLORS.TEXT_GRAY);

  // ------------------------------------------------------------=========
  // CHART AREA 2 - Row 21-42 (Comparison or Selected Metric 2)
  // ------------------------------------------------------------=========
  sheet.getRange("L21:T21").merge()
    .setValue("üìä DOUBLE THE INSIGHTS - See Two Stories Side by Side!")
    .setFontSize(13).setFontFamily("Roboto")
    .setFontWeight("bold")
    .setHorizontalAlignment("center")
    .setBackground(COLORS.ACCENT_PURPLE)
    .setFontColor("white");

  sheet.getRange("L22:T42")
    .setBackground(COLORS.WHITE)
    .setBorder(true, true, true, true, false, false, COLORS.BORDER_GRAY, SpreadsheetApp.BorderStyle.SOLID);

  sheet.getRange("L23:T23").merge()
    .setValue("üåü Enable comparison mode above to see another dimension of your success!")
    .setFontSize(11).setFontFamily("Roboto")
    .setFontStyle("italic")
    .setHorizontalAlignment("center")
    .setVerticalAlignment("middle")
    .setFontColor(COLORS.TEXT_GRAY);

  // ------------------------------------------------------------=========
  // PIE CHARTS SECTION - Row 45-65
  // ------------------------------------------------------------=========
  sheet.getRange("A45:T45").merge()
    .setValue("ü•ß COLORFUL INSIGHTS - Your Work in Living Color!")
    .setFontSize(14).setFontFamily("Roboto")
    .setFontWeight("bold")
    .setHorizontalAlignment("center")
    .setBackground(COLORS.PRIMARY_BLUE)
    .setFontColor("white");

  // Pie Chart 1 - Grievances by Status
  sheet.getRange("A47:J47").merge()
    .setValue("üéØ Status Snapshot - See Progress at a Glance")
    .setFontSize(12).setFontFamily("Roboto")
    .setFontWeight("bold")
    .setHorizontalAlignment("center")
    .setBackground(COLORS.ACCENT_TEAL)
    .setFontColor("white");

  sheet.getRange("A48:J65")
    .setBackground(COLORS.WHITE)
    .setBorder(true, true, true, true, false, false, COLORS.BORDER_GRAY, SpreadsheetApp.BorderStyle.SOLID);

  // Pie Chart 2 - Grievances by Location
  sheet.getRange("L47:T47").merge()
    .setValue("üó∫Ô∏è Location Hotspots - Where the Action Is!")
    .setFontSize(12).setFontFamily("Roboto")
    .setFontWeight("bold")
    .setHorizontalAlignment("center")
    .setBackground(COLORS.ACCENT_PURPLE)
    .setFontColor("white");

  sheet.getRange("L48:T65")
    .setBackground(COLORS.WHITE)
    .setBorder(true, true, true, true, false, false, COLORS.BORDER_GRAY, SpreadsheetApp.BorderStyle.SOLID);

  // ------------------------------------------------------------=========
  // WAREHOUSE-STYLE LOCATION CHART - Row 68-88
  // ------------------------------------------------------------=========
  sheet.getRange("A68:T68").merge()
    .setValue("üè¢ UNITED ACROSS LOCATIONS - Our Collective Strength!")
    .setFontSize(14).setFontFamily("Roboto")
    .setFontWeight("bold")
    .setHorizontalAlignment("center")
    .setBackground(COLORS.ACCENT_PURPLE)
    .setFontColor("white");

  sheet.getRange("A70:T70").merge()
    .setValue("üí™ Every City, Every Worker - Together We Stand!")
    .setFontSize(12).setFontFamily("Roboto")
    .setFontWeight("bold")
    .setHorizontalAlignment("center")
    .setBackground(COLORS.ACCENT_TEAL)
    .setFontColor("white");

  sheet.getRange("A71:T88")
    .setBackground(COLORS.WHITE)
    .setBorder(true, true, true, true, false, false, COLORS.BORDER_GRAY, SpreadsheetApp.BorderStyle.SOLID);

  // ------------------------------------------------------------=========
  // DATA TABLE - Top Performers/Issues - Row 91-110
  // ------------------------------------------------------------=========
  sheet.getRange("A91:T91").merge()
    .setValue("üìã THE DETAILS THAT MATTER - Celebrating Excellence!")
    .setFontSize(14).setFontFamily("Roboto")
    .setFontWeight("bold")
    .setHorizontalAlignment("center")
    .setBackground(COLORS.PRIMARY_BLUE)
    .setFontColor("white");

  const tableHeaders = ["Rank", "Item", "Count", "Active", "Resolved", "Win Rate", "Status"];
  sheet.getRange("A93:G93").setValues([tableHeaders])
    .setFontWeight("bold")
    .setBackground(COLORS.ACCENT_TEAL)
    .setFontColor("white")
    .setFontFamily("Roboto")
    .setHorizontalAlignment("center");

  sheet.getRange("A94:G110")
    .setBackground(COLORS.WHITE)
    .setBorder(true, true, true, true, true, true, COLORS.BORDER_GRAY, SpreadsheetApp.BorderStyle.SOLID);

  // Set column widths
  sheet.setColumnWidth(1, 80);   // Rank
  sheet.setColumnWidth(2, 250);  // Item
  sheet.setColumnWidth(3, 100);  // Count
  sheet.setColumnWidth(4, 100);  // Active
  sheet.setColumnWidth(5, 100);  // Resolved
  sheet.setColumnWidth(6, 100);  // Win Rate
  sheet.setColumnWidth(7, 120);  // Status

  // Set row heights
  sheet.setRowHeight(4, 35);
  sheet.setRowHeight(10, 35);
  sheet.setRowHeight(21, 35);
  sheet.setRowHeight(45, 35);
  sheet.setRowHeight(68, 35);
  sheet.setRowHeight(91, 35);

  // Freeze header rows
  sheet.setFrozenRows(2);

  Logger.log("Interactive Dashboard sheet created successfully");
}

/**
 * Setup data validation for Interactive Dashboard controls
 */
function setupInteractiveDashboardControls() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEETS.INTERACTIVE_DASHBOARD);
  const configSheet = ss.getSheetByName(SHEETS.CONFIG);

  if (!sheet || !configSheet) return;

  // Available metrics for selection
  const metrics = [
    "Total Members",
    "Active Members",
    "Total Stewards",
    "Unit 8 Members",
    "Unit 10 Members",
    "Total Grievances",
    "Active Grievances",
    "Resolved Grievances",
    "Grievances Won",
    "Grievances Lost",
    "Win Rate %",
    "Overdue Grievances",
    "Due This Week",
    "In Mediation",
    "In Arbitration",
    "Grievances by Type",
    "Grievances by Location",
    "Grievances by Step",
    "Steward Workload",
    "Monthly Trends"
  ];

  // Chart types
  const chartTypes = [
    "Donut Chart",
    "Pie Chart",
    "Bar Chart",
    "Column Chart",
    "Line Chart",
    "Area Chart",
    "Table"
  ];

  // Themes
  const themes = [
    "Union Blue",
    "Solidarity Red",
    "Success Green",
    "Professional Purple",
    "Modern Dark",
    "Light & Clean"
  ];

  // Comparison options
  const comparisonOptions = ["Yes", "No"];

  // Create dropdown rules with help text
  const metricRule = SpreadsheetApp.newDataValidation()
    .requireValueInList(metrics, true)
    .setAllowInvalid(false)
    .setHelpText('üéØ Click here to select a metric!')
    .build();

  const chartTypeRule = SpreadsheetApp.newDataValidation()
    .requireValueInList(chartTypes, true)
    .setAllowInvalid(false)
    .setHelpText('üìä Click here to select chart type!')
    .build();

  const themeRule = SpreadsheetApp.newDataValidation()
    .requireValueInList(themes, true)
    .setAllowInvalid(false)
    .setHelpText('üé® Click here to select a theme!')
    .build();

  const comparisonRule = SpreadsheetApp.newDataValidation()
    .requireValueInList(comparisonOptions, true)
    .setAllowInvalid(false)
    .setHelpText('üîÑ Click here to toggle comparison mode!')
    .build();

  // Apply data validation to control cells with enhanced visual styling
  const dropdownStyle = {
    background: "#DBEAFE",  // Light blue to stand out
    border: "#3B82F6",      // Blue border
    fontWeight: "bold"
  };

  // Metric 1
  sheet.getRange("A7")
    .setDataValidation(metricRule)
    .setValue("Total Members")
    .setBackground(dropdownStyle.background)
    .setBorder(true, true, true, true, false, false, dropdownStyle.border, SpreadsheetApp.BorderStyle.SOLID_MEDIUM)
    .setFontWeight(dropdownStyle.fontWeight);

  // Chart Type 1
  sheet.getRange("B7")
    .setDataValidation(chartTypeRule)
    .setValue("Donut Chart")
    .setBackground(dropdownStyle.background)
    .setBorder(true, true, true, true, false, false, dropdownStyle.border, SpreadsheetApp.BorderStyle.SOLID_MEDIUM)
    .setFontWeight(dropdownStyle.fontWeight);

  // Metric 2
  sheet.getRange("C7")
    .setDataValidation(metricRule)
    .setValue("Active Grievances")
    .setBackground(dropdownStyle.background)
    .setBorder(true, true, true, true, false, false, dropdownStyle.border, SpreadsheetApp.BorderStyle.SOLID_MEDIUM)
    .setFontWeight(dropdownStyle.fontWeight);

  // Chart Type 2
  sheet.getRange("D7")
    .setDataValidation(chartTypeRule)
    .setValue("Bar Chart")
    .setBackground(dropdownStyle.background)
    .setBorder(true, true, true, true, false, false, dropdownStyle.border, SpreadsheetApp.BorderStyle.SOLID_MEDIUM)
    .setFontWeight(dropdownStyle.fontWeight);

  // Theme
  sheet.getRange("E7")
    .setDataValidation(themeRule)
    .setValue("Union Blue")
    .setBackground("#FEF3C7")  // Yellow for theme selector
    .setBorder(true, true, true, true, false, false, "#F59E0B", SpreadsheetApp.BorderStyle.SOLID_MEDIUM)
    .setFontWeight(dropdownStyle.fontWeight);

  // Comparison toggle
  sheet.getRange("G7")
    .setDataValidation(comparisonRule)
    .setValue("Yes")
    .setBackground("#D1FAE5")  // Green for toggle
    .setBorder(true, true, true, true, false, false, "#10B981", SpreadsheetApp.BorderStyle.SOLID_MEDIUM)
    .setFontWeight(dropdownStyle.fontWeight);

  // Add visual dropdown indicators in row 8
  sheet.getRange("A8:G8")
    .setValues([["‚ñº Select", "‚ñº Select", "‚ñº Select", "‚ñº Select", "‚ñº Select", "", "‚ñº Select"]])
    .setFontSize(8)
    .setFontColor("#6B7280")
    .setFontStyle("italic")
    .setHorizontalAlignment("center");

  Logger.log("Interactive Dashboard controls set up successfully with enhanced visibility");
}

/**
 * Rebuilds the Interactive Dashboard based on user selections
 */
function rebuildInteractiveDashboard() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEETS.INTERACTIVE_DASHBOARD);
  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!sheet || !memberSheet || !grievanceSheet) {
    SpreadsheetApp.getUi().alert('Oops! We need a few more pieces to make the magic happen!\n\nüîç We\'re looking for your Member Directory and Grievance Log sheets.\n\nüí° Make sure they\'re set up and try again!');
    return;
  }

  try {
    SpreadsheetApp.getUi().alert('‚ú® Bringing your dashboard to life...\n\nüé® Painting your data with insights!\n‚è±Ô∏è Just a moment while we celebrate your work...');

    // Get user selections
    const metric1 = sheet.getRange("A7").getValue() || "Total Members";
    const chartType1 = sheet.getRange("B7").getValue() || "Donut Chart";
    const metric2 = sheet.getRange("C7").getValue() || "Active Grievances";
    const chartType2 = sheet.getRange("D7").getValue() || "Bar Chart";
    const theme = sheet.getRange("E7").getValue() || "Union Blue";
    const enableComparison = sheet.getRange("G7").getValue() || "Yes";

    // Get data
    const memberData = memberSheet.getDataRange().getValues();
    const grievanceData = grievanceSheet.getDataRange().getValues();

    // Calculate metrics for cards
    const metrics = calculateAllMetrics(memberData, grievanceData);

    // Update metric cards
    updateMetricCards(sheet, metrics);

    // Create primary chart - pass data to avoid refetch
    createDynamicChart(sheet, metric1, chartType1, metrics, "A22", 10, 20, grievanceData, memberData);

    // Create comparison chart if enabled
    if (enableComparison === "Yes") {
      createDynamicChart(sheet, metric2, chartType2, metrics, "L22", 9, 20, grievanceData, memberData);
    }

    // Create pie/donut charts
    createGrievanceStatusDonut(sheet, grievanceData);
    createLocationPieChart(sheet, grievanceData);

    // Create warehouse-style location chart
    createWarehouseLocationChart(sheet, grievanceData);

    // Update data table
    updateTopItemsTable(sheet, metric1, grievanceData, memberData);

    // Apply theme
    applyDashboardTheme(sheet, theme);

    // Create victory message based on metrics
    const victoryMsg = getVictoryMessage(metrics);

    SpreadsheetApp.getUi().alert('üéâ Your dashboard is alive and celebrating!\n\n' + victoryMsg + '\n\n‚ú® Keep up the amazing work!');
  } catch (error) {
    SpreadsheetApp.getUi().alert('Oops! We hit a small bump...\n\n' + error.message + '\n\nüí™ No worries, let\'s try again!');
    Logger.log('Error: ' + error.toString());
  }
}

/**
 * Calculate all metrics from data
 */
function calculateAllMetrics(memberData, grievanceData) {
  const metrics = {};

  // Member metrics - using MEMBER_COLS constants
  metrics.totalMembers = memberData.length - 1;
  metrics.activeMembers = memberData.slice(1).filter(function(row) { return row[MEMBER_COLS.MEMBER_ID - 1]; }).length; // Count members with IDs
  metrics.totalStewards = memberData.slice(1).filter(function(row) { return row[MEMBER_COLS.IS_STEWARD - 1] === 'Yes'; }).length;
  metrics.unit8Members = memberData.slice(1).filter(function(row) { return row[MEMBER_COLS.UNIT - 1] === 'Unit 8'; }).length;
  metrics.unit10Members = memberData.slice(1).filter(function(row) { return row[MEMBER_COLS.UNIT - 1] === 'Unit 10'; }).length;

  // Grievance metrics - using GRIEVANCE_COLS constants
  metrics.totalGrievances = grievanceData.length - 1;
  metrics.activeGrievances = grievanceData.slice(1).filter(function(row) {
    const status = row[GRIEVANCE_COLS.STATUS - 1];
    return status && (status === 'Open' || status === 'Pending Info');
  }).length;
  metrics.resolvedGrievances = grievanceData.slice(1).filter(function(row) {
    const status = row[GRIEVANCE_COLS.STATUS - 1];
    return status && (status === 'Settled' || status === 'Closed');
  }).length;

  const resolvedData = grievanceData.slice(1).filter(function(row) {
    const status = row[GRIEVANCE_COLS.STATUS - 1];
    return status && (status === 'Settled' || status === 'Closed');
  });
  metrics.grievancesWon = resolvedData.filter(function(row) {
    const resolution = row[GRIEVANCE_COLS.RESOLUTION - 1];
    return resolution && resolution.includes('Won');
  }).length;
  metrics.grievancesLost = resolvedData.filter(function(row) {
    const resolution = row[GRIEVANCE_COLS.RESOLUTION - 1];
    return resolution && resolution.includes('Lost');
  }).length;

  metrics.winRate = metrics.resolvedGrievances > 0
    ? ((metrics.grievancesWon / metrics.resolvedGrievances) * 100).toFixed(1)
    : 0;

  // Overdue = Next Action Due is in the past
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  metrics.overdueGrievances = grievanceData.slice(1).filter(function(row) {
    const nextActionDue = row[GRIEVANCE_COLS.NEXT_ACTION_DUE - 1];
    if (!nextActionDue) return false;
    const daysToDeadline = Math.floor((new Date(nextActionDue) - today) / (1000 * 60 * 60 * 24));
    return daysToDeadline < 0;
  }).length;

  // Additional metrics
  metrics.inMediation = grievanceData.slice(1).filter(function(row) { return row[GRIEVANCE_COLS.CURRENT_STEP - 1] === 'Mediation'; }).length;
  metrics.inArbitration = grievanceData.slice(1).filter(function(row) { return row[GRIEVANCE_COLS.CURRENT_STEP - 1] === 'Arbitration'; }).length;

  return metrics;
}

/**
 * Update metric cards with current data and celebratory messages
 */
function updateMetricCards(sheet, metrics) {
  // Card 1: Total Members
  sheet.getRange("A15:E17").merge()
    .setValue(formatNumber(metrics.totalMembers))
    .setNumberFormat("#,##0");

  // Add celebration message for members
  const memberMsg = getMemberCelebration(metrics.totalMembers);
  sheet.getRange("A18:E18").merge()
    .setValue(memberMsg)
    .setFontSize(9)
    .setFontStyle("italic")
    .setHorizontalAlignment("center")
    .setFontColor(COLORS.UNION_GREEN);

  // Card 2: Active Grievances
  sheet.getRange("F15:J17").merge()
    .setValue(formatNumber(metrics.activeGrievances))
    .setNumberFormat("#,##0");

  // Add encouraging message for grievances
  const grievanceMsg = getGrievanceCelebration(metrics.activeGrievances);
  sheet.getRange("F18:J18").merge()
    .setValue(grievanceMsg)
    .setFontSize(9)
    .setFontStyle("italic")
    .setHorizontalAlignment("center")
    .setFontColor(COLORS.ACCENT_ORANGE);

  // Card 3: Win Rate
  sheet.getRange("K15:O17").merge()
    .setValue(metrics.winRate + "%")
    .setNumberFormat("0.0\"%\"");

  // Add victory celebration for win rate
  const winMsg = getWinRateCelebration(parseFloat(metrics.winRate));
  sheet.getRange("K18:O18").merge()
    .setValue(winMsg)
    .setFontSize(9)
    .setFontStyle("italic")
    .setHorizontalAlignment("center")
    .setFontColor(COLORS.UNION_GREEN);

  // Card 4: Overdue Cases
  sheet.getRange("P15:T17").merge()
    .setValue(formatNumber(metrics.overdueGrievances))
    .setNumberFormat("#,##0");

  // Add encouraging message for overdue
  const overdueMsg = getOverdueCelebration(metrics.overdueGrievances, metrics.activeGrievances);
  sheet.getRange("P18:T18").merge()
    .setValue(overdueMsg)
    .setFontSize(9)
    .setFontStyle("italic")
    .setHorizontalAlignment("center")
    .setFontColor(metrics.overdueGrievances === 0 ? COLORS.UNION_GREEN : COLORS.ACCENT_ORANGE);
}

/**
 * Format number with thousands separator
 */
function formatNumber(num) {
  return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

/**
 * Get celebration message for member count
 */
function getMemberCelebration(count) {
  if (count > 1000) return "üéä Wow! Over 1,000 strong!";
  if (count > 500) return "üí™ Growing stronger every day!";
  if (count > 100) return "‚≠ê Our union is thriving!";
  return "üå± Building our movement!";
}

/**
 * Get celebration message for active grievances
 */
function getGrievanceCelebration(count) {
  if (count === 0) return "üéâ All caught up! Amazing!";
  if (count < 5) return "üëç Nice work staying on top!";
  if (count < 20) return "üíº You're handling it!";
  return "üî• Busy defending rights!";
}

/**
 * Get victory celebration for win rate
 */
function getWinRateCelebration(rate) {
  if (rate >= 90) return "üèÜ INCREDIBLE! Nearly perfect!";
  if (rate >= 80) return "üåü Outstanding success rate!";
  if (rate >= 70) return "‚ú® Great work winning cases!";
  if (rate >= 60) return "üëè Making solid progress!";
  if (rate >= 50) return "üí™ Keep fighting!";
  return "üéØ Every win counts!";
}

/**
 * Get encouraging message for overdue cases
 */
function getOverdueCelebration(overdue, total) {
  if (overdue === 0) return "üéä PERFECT! Nothing overdue!";
  const percentage = (overdue / total) * 100;
  if (percentage < 5) return "üëç Almost there!";
  if (percentage < 10) return "‚ö° Making progress!";
  if (percentage < 20) return "üí™ You've got this!";
  return "üîî Time to catch up!";
}

/**
 * Get overall victory message based on all metrics
 */
function getVictoryMessage(metrics) {
  const winRate = parseFloat(metrics.winRate);
  const messages = [];

  // Check for major victories
  if (winRate >= 80) {
    messages.push("üèÜ Your win rate is OUTSTANDING!");
  } else if (winRate >= 70) {
    messages.push("‚≠ê Great job winning cases!");
  }

  if (metrics.overdueGrievances === 0) {
    messages.push("üéä PERFECT record - nothing overdue!");
  } else if (metrics.overdueGrievances < 5) {
    messages.push("üëç Nearly perfect on deadlines!");
  }

  if (metrics.totalMembers > 500) {
    messages.push("üí™ Your union is thriving with " + formatNumber(metrics.totalMembers) + " members!");
  }

  if (messages.length === 0) {
    return "üìä Your data is looking good! Every day brings progress!";
  }

  return messages.join("\n");
}

/**
 * Create dynamic chart based on user selection
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet - Target sheet
 * @param {string} metricName - Metric to display
 * @param {string} chartType - Type of chart (Donut, Pie, Bar, etc)
 * @param {Object} metrics - Pre-calculated metrics
 * @param {string} startCell - Starting cell for chart
 * @param {number} width - Chart width multiplier
 * @param {number} height - Chart height multiplier
 * @param {Array<Array>} grievanceData - Grievance data (to avoid refetch)
 * @param {Array<Array>} memberData - Member data (to avoid refetch)
 */
function createDynamicChart(sheet, metricName, chartType, metrics, startCell, width, height, grievanceData, memberData) {
  try {
    // Remove existing charts in this area first
    const charts = sheet.getCharts();
    charts.forEach(function(chart) {
      const anchor = chart.getContainerInfo().getAnchorRow();
      // Extract row number correctly (handles cells like "AA22" not just "A22")
      if (anchor >= parseInt(startCell.match(/\d+/)[0])) {
        sheet.removeChart(chart);
      }
    });

    // Get data based on metric selection - pass data to avoid refetch
    const chartData = getChartDataForMetric(metricName, metrics, grievanceData, memberData);

  if (!chartData || chartData.length === 0) return;

  // Create chart based on type
  let chartBuilder;
  const range = sheet.getRange(startCell);

  if (chartType === "Donut Chart") {
    chartBuilder = sheet.newChart()
      .setChartType(Charts.ChartType.PIE)
      .addRange(sheet.getRange(startCell).offset(1, 0, chartData.length, 2))
      .setPosition(range.getRow(), range.getColumn(), 0, 0)
      .setOption('title', metricName)
      .setOption('pieHole', 0.4)
      .setOption('width', width * 60)
      .setOption('height', height * 15)
      .setOption('legend', {position: 'right'})
      .setOption('colors', [
        COLORS.PRIMARY_BLUE, COLORS.UNION_GREEN, COLORS.ACCENT_ORANGE,
        COLORS.SOLIDARITY_RED, COLORS.ACCENT_PURPLE, COLORS.ACCENT_TEAL
      ]);
  } else if (chartType === "Pie Chart") {
    chartBuilder = sheet.newChart()
      .setChartType(Charts.ChartType.PIE)
      .addRange(sheet.getRange(startCell).offset(1, 0, chartData.length, 2))
      .setPosition(range.getRow(), range.getColumn(), 0, 0)
      .setOption('title', metricName)
      .setOption('width', width * 60)
      .setOption('height', height * 15)
      .setOption('legend', {position: 'right'})
      .setOption('colors', [
        COLORS.PRIMARY_BLUE, COLORS.UNION_GREEN, COLORS.ACCENT_ORANGE,
        COLORS.SOLIDARITY_RED, COLORS.ACCENT_PURPLE, COLORS.ACCENT_TEAL
      ]);
  } else if (chartType === "Bar Chart") {
    chartBuilder = sheet.newChart()
      .setChartType(Charts.ChartType.BAR)
      .addRange(sheet.getRange(startCell).offset(1, 0, chartData.length, 2))
      .setPosition(range.getRow(), range.getColumn(), 0, 0)
      .setOption('title', metricName)
      .setOption('width', width * 60)
      .setOption('height', height * 15)
      .setOption('legend', {position: 'none'})
      .setOption('colors', [COLORS.PRIMARY_BLUE]);
  } else if (chartType === "Column Chart") {
    chartBuilder = sheet.newChart()
      .setChartType(Charts.ChartType.COLUMN)
      .addRange(sheet.getRange(startCell).offset(1, 0, chartData.length, 2))
      .setPosition(range.getRow(), range.getColumn(), 0, 0)
      .setOption('title', metricName)
      .setOption('width', width * 60)
      .setOption('height', height * 15)
      .setOption('legend', {position: 'none'})
      .setOption('colors', [COLORS.PRIMARY_BLUE]);
  } else if (chartType === "Line Chart") {
    chartBuilder = sheet.newChart()
      .setChartType(Charts.ChartType.LINE)
      .addRange(sheet.getRange(startCell).offset(1, 0, chartData.length, 2))
      .setPosition(range.getRow(), range.getColumn(), 0, 0)
      .setOption('title', metricName)
      .setOption('width', width * 60)
      .setOption('height', height * 15)
      .setOption('curveType', 'function')
      .setOption('legend', {position: 'none'})
      .setOption('colors', [COLORS.PRIMARY_BLUE]);
  }

    if (chartBuilder) {
      sheet.insertChart(chartBuilder.build());
    }

    // Write data to hidden area for chart
    writeChartData(sheet, startCell, chartData);
  } catch (error) {
    handleError(error, `createDynamicChart(${metricName})`, false);
  }
}

/**
 * Write chart data to sheet (hidden area)
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet - Target sheet
 * @param {string} startCell - Starting cell reference
 * @param {Array<Array>} data - Data to write
 */
function writeChartData(sheet, startCell, data) {
  if (!data || data.length === 0) return;

  try {
    const startRange = sheet.getRange(startCell);
    const startRow = startRange.getRow() + 1;
    const startCol = startRange.getColumn();
    const numRows = data.length;
    const numCols = 2;

    // Get ALL merged regions in the target range and break apart any that overlap
    // This properly handles the "You must select all cells in a merged range" error
    const targetRange = sheet.getRange(startRow, startCol, numRows, numCols);
    const mergedRanges = targetRange.getMergedRanges();
    for (let i = 0; i < mergedRanges.length; i++) {
      try {
        mergedRanges[i].breakApart();
      } catch (e) {
        Logger.log('Could not break apart merged range: ' + e.message);
      }
    }

    // Clear existing content
    targetRange.clearContent();

    // Write the data
    targetRange.setValues(data);

    // Hide this data area - OPTIMIZED: batch hide instead of one-by-one
    sheet.hideRows(startRow, numRows);
  } catch (error) {
    handleError(error, 'writeChartData', false);
  }
}

/**
 * Get chart data for specific metric
 */
/**
 * Gets chart data based on selected metric
 * @param {string} metricName - Name of the metric to chart
 * @param {Object} metrics - Pre-calculated metrics object
 * @param {Array<Array>} grievanceData - Grievance data (passed to avoid refetch)
 * @param {Array<Array>} memberData - Member data (passed to avoid refetch)
 * @returns {Array<Array>} Chart data as [label, value] pairs
 */
function getChartDataForMetric(metricName, metrics, grievanceData, memberData) {
  // Data validation
  if (!grievanceData || !memberData) {
    logWarning('getChartDataForMetric', 'Missing data parameters');
    return [["No Data", 0]];
  }

  switch (metricName) {
    case "Total Members":
      return [
        ["Active", metrics.activeMembers],
        ["Inactive", metrics.totalMembers - metrics.activeMembers]
      ];

    case "Active Grievances":
      // Count actual grievances by step from Grievance Log
      const stepCounts = {};
      grievanceData.slice(1).forEach(function(row) {
        const status = row[GRIEVANCE_COLS.STATUS - 1];
        const step = row[GRIEVANCE_COLS.CURRENT_STEP - 1];
        if (status && (status === 'Open' || status === 'Pending Info')) {
          stepCounts[step] = (stepCounts[step] || 0) + 1;
        }
      });

      const stepData = Object.entries(stepCounts)
        .filter(function([step]) { return step && step !== 'Current Step'; })
        .map(function([step, count]) { return [step, count]; });

      return stepData.length > 0 ? stepData : [["No Active Grievances", 0]];

    case "Win Rate %":
      return [
        ["Won", metrics.grievancesWon],
        ["Lost", metrics.grievancesLost]
      ];

    case "Grievances by Type":
      // Count grievances by type/category
      const typeCounts = {};
      grievanceData.slice(1).forEach(function(row) {
        const type = row[GRIEVANCE_COLS.ISSUE_CATEGORY - 1];
        if (type && type !== 'Issue Category') {
          typeCounts[type] = (typeCounts[type] || 0) + 1;
        }
      });

      const typeData = Object.entries(typeCounts)
        .sort(function(a, b) { return b[1] - a[1]; })
        .slice(0, 10)
        .map(function([type, count]) { return [type, count]; });

      return typeData.length > 0 ? typeData : [["No Data", 0]];

    case "Grievances by Location":
      // Count grievances by location
      const locationCounts = {};
      grievanceData.slice(1).forEach(function(row) {
        const location = row[GRIEVANCE_COLS.LOCATION - 1];
        if (location && location !== 'Work Location (Site)') {
          locationCounts[location] = (locationCounts[location] || 0) + 1;
        }
      });

      const locationData = Object.entries(locationCounts)
        .sort(function(a, b) { return b[1] - a[1]; })
        .slice(0, 10)
        .map(function([location, count]) { return [location, count]; });

      return locationData.length > 0 ? locationData : [["No Data", 0]];

    case "Grievances by Step":
      // Count all grievances by step
      const allStepCounts = {};
      grievanceData.slice(1).forEach(function(row) {
        const step = row[GRIEVANCE_COLS.CURRENT_STEP - 1];
        if (step && step !== 'Current Step') {
          allStepCounts[step] = (allStepCounts[step] || 0) + 1;
        }
      });

      const allStepData = Object.entries(allStepCounts)
        .map(function([step, count]) { return [step, count]; });

      return allStepData.length > 0 ? allStepData : [["No Data", 0]];

    case "Unit 8 Members":
      const unit8Count = memberData.slice(1).filter(function(row) { return row[MEMBER_COLS.UNIT - 1] === 'Unit 8'; }).length;
      return [["Unit 8", unit8Count]];

    case "Unit 10 Members":
      const unit10Count = memberData.slice(1).filter(function(row) { return row[MEMBER_COLS.UNIT - 1] === 'Unit 10'; }).length;
      return [["Unit 10", unit10Count]];

    case "Total Stewards":
      return [
        ["Stewards", metrics.totalStewards],
        ["Non-Stewards", metrics.totalMembers - metrics.totalStewards]
      ];

    default:
      return [["No Data", 0]];
  }
}

/**
 * Create Grievance Status Donut Chart
 */
function createGrievanceStatusDonut(sheet, grievanceData) {
  // Count by status
  const statusCounts = {};
  grievanceData.slice(1).forEach(function(row) {
    const status = row[GRIEVANCE_COLS.STATUS - 1] || 'Unknown';
    statusCounts[status] = (statusCounts[status] || 0) + 1;
  });

  const data = Object.entries(statusCounts).map(function([status, count]) { return [status, count]; });

  const chart = sheet.newChart()
    .setChartType(Charts.ChartType.PIE)
    .setPosition(48, 1, 0, 0)
    .setOption('title', 'Grievances by Status')
    .setOption('pieHole', 0.4)
    .setOption('width', 550)
    .setOption('height', 300)
    .setOption('legend', {position: 'right'})
    .setOption('colors', [
      COLORS.PRIMARY_BLUE, COLORS.UNION_GREEN, COLORS.ACCENT_ORANGE,
      COLORS.SOLIDARITY_RED, COLORS.ACCENT_PURPLE, COLORS.ACCENT_TEAL,
      COLORS.ACCENT_YELLOW, COLORS.TEXT_GRAY
    ])
    .build();

  sheet.insertChart(chart);
}

/**
 * Create Location Pie Chart
 */
function createLocationPieChart(sheet, grievanceData) {
  // Count by location
  const locationCounts = {};
  grievanceData.slice(1).forEach(function(row) {
    const location = row[GRIEVANCE_COLS.LOCATION - 1] || 'Unknown';
    locationCounts[location] = (locationCounts[location] || 0) + 1;
  });

  // Get top 10
  const topLocations = Object.entries(locationCounts)
    .sort(function(a, b) { return b[1] - a[1]; })
    .slice(0, 10);

  const chart = sheet.newChart()
    .setChartType(Charts.ChartType.PIE)
    .setPosition(48, 12, 0, 0)
    .setOption('title', 'Top Locations by Grievances')
    .setOption('width', 550)
    .setOption('height', 300)
    .setOption('legend', {position: 'right'})
    .setOption('colors', [
      COLORS.PRIMARY_BLUE, COLORS.UNION_GREEN, COLORS.ACCENT_ORANGE,
      COLORS.SOLIDARITY_RED, COLORS.ACCENT_PURPLE, COLORS.ACCENT_TEAL,
      COLORS.ACCENT_YELLOW, COLORS.TEXT_GRAY, COLORS.HEADER_BLUE, COLORS.HEADER_GREEN
    ])
    .build();

  sheet.insertChart(chart);
}

/**
 * Create warehouse-style location bar chart
 */
function createWarehouseLocationChart(sheet, grievanceData) {
  // This would create a horizontal bar chart similar to warehouse dashboard
  const locationCounts = {};
  grievanceData.slice(1).forEach(function(row) {
    const location = row[GRIEVANCE_COLS.LOCATION - 1] || 'Unknown';
    locationCounts[location] = (locationCounts[location] || 0) + 1;
  });

  const topLocations = Object.entries(locationCounts)
    .sort(function(a, b) { return b[1] - a[1]; })
    .slice(0, 15);

  const chart = sheet.newChart()
    .setChartType(Charts.ChartType.BAR)
    .setPosition(71, 1, 0, 0)
    .setOption('title', 'Grievances by City/Location')
    .setOption('width', 1100)
    .setOption('height', 280)
    .setOption('legend', {position: 'none'})
    .setOption('colors', [COLORS.ACCENT_PURPLE])
    .setOption('hAxis', {title: 'Number of Grievances'})
    .setOption('vAxis', {title: 'Location'})
    .build();

  sheet.insertChart(chart);
}

/**
 * Update top items data table
 */
function updateTopItemsTable(sheet, metricName, grievanceData, memberData) {
  // Clear existing data
  sheet.getRange("A94:G110").clearContent();

  let tableData = [];

  // Generate table based on selected metric
  switch (metricName) {
    case "Grievances by Type":
    case "Issue Category":
      // Show top grievance types with detailed breakdown
      const typeCounts = {};
      const typeActive = {};
      const typeResolved = {};
      const typeWon = {};

      grievanceData.slice(1).forEach(function(row) {
        const type = row[GRIEVANCE_COLS.ISSUE_CATEGORY - 1];
        const status = row[GRIEVANCE_COLS.STATUS - 1];
        const resolution = row[GRIEVANCE_COLS.RESOLUTION - 1];

        if (type && type !== 'Issue Category') {
          typeCounts[type] = (typeCounts[type] || 0) + 1;

          if (status && (status === 'Open' || status === 'Pending Info')) {
            typeActive[type] = (typeActive[type] || 0) + 1;
          } else if (status && (status === 'Settled' || status === 'Closed')) {
            typeResolved[type] = (typeResolved[type] || 0) + 1;
            if (resolution && resolution.includes('Won')) {
              typeWon[type] = (typeWon[type] || 0) + 1;
            }
          }
        }
      });

      tableData = Object.entries(typeCounts)
        .sort(function(a, b) { return b[1] - a[1]; })
        .slice(0, 15)
        .map(function([type, total], index) {
          const active = typeActive[type] || 0;
          const resolved = typeResolved[type] || 0;
          const won = typeWon[type] || 0;
          const winRate = resolved > 0 ? ((won / resolved) * 100).toFixed(0) + "%" : "N/A";
          const status = active === 0 ? "üü¢ All Clear" : active < 5 ? "üü° Manageable" : "üî¥ High Activity";

          return [index + 1, type, total, active, resolved, winRate, status];
        });
      break;

    case "Grievances by Location":
      // Show top locations with detailed breakdown
      const locationCounts = {};
      const locationActive = {};
      const locationResolved = {};
      const locationWon = {};

      grievanceData.slice(1).forEach(function(row) {
        const location = row[GRIEVANCE_COLS.LOCATION - 1];
        const status = row[GRIEVANCE_COLS.STATUS - 1];
        const resolution = row[GRIEVANCE_COLS.RESOLUTION - 1];

        if (location && location !== 'Work Location (Site)') {
          locationCounts[location] = (locationCounts[location] || 0) + 1;

          if (status && (status === 'Open' || status === 'Pending Info')) {
            locationActive[location] = (locationActive[location] || 0) + 1;
          } else if (status && (status === 'Settled' || status === 'Closed')) {
            locationResolved[location] = (locationResolved[location] || 0) + 1;
            if (resolution && resolution.includes('Won')) {
              locationWon[location] = (locationWon[location] || 0) + 1;
            }
          }
        }
      });

      tableData = Object.entries(locationCounts)
        .sort(function(a, b) { return b[1] - a[1]; })
        .slice(0, 15)
        .map(function([location, total], index) {
          const active = locationActive[location] || 0;
          const resolved = locationResolved[location] || 0;
          const won = locationWon[location] || 0;
          const winRate = resolved > 0 ? ((won / resolved) * 100).toFixed(0) + "%" : "N/A";
          const status = active === 0 ? "üü¢ All Clear" : active < 5 ? "üü° Manageable" : "üî¥ Needs Attention";

          return [index + 1, location, total, active, resolved, winRate, status];
        });
      break;

    case "Steward Workload":
      // Show steward workload breakdown
      const stewardCounts = {};
      const stewardActive = {};
      const stewardResolved = {};
      const stewardWon = {};

      grievanceData.slice(1).forEach(function(row) {
        const steward = row[GRIEVANCE_COLS.STEWARD - 1];
        const status = row[GRIEVANCE_COLS.STATUS - 1];
        const resolution = row[GRIEVANCE_COLS.RESOLUTION - 1];

        if (steward && steward !== 'Assigned Steward (Name)') {
          stewardCounts[steward] = (stewardCounts[steward] || 0) + 1;

          if (status && (status === 'Open' || status === 'Pending Info')) {
            stewardActive[steward] = (stewardActive[steward] || 0) + 1;
          } else if (status && (status === 'Settled' || status === 'Closed')) {
            stewardResolved[steward] = (stewardResolved[steward] || 0) + 1;
            if (resolution && resolution.includes('Won')) {
              stewardWon[steward] = (stewardWon[steward] || 0) + 1;
            }
          }
        }
      });

      tableData = Object.entries(stewardCounts)
        .sort(function(a, b) { return (stewardActive[b.name] || 0) - (stewardActive[a.name] || 0); })
        .slice(0, 15)
        .map(function([steward, total], index) {
          const active = stewardActive[steward] || 0;
          const resolved = stewardResolved[steward] || 0;
          const won = stewardWon[steward] || 0;
          const winRate = resolved > 0 ? ((won / resolved) * 100).toFixed(0) + "%" : "N/A";
          const status = active === 0 ? "üü¢ Available" : active < 10 ? "üü° Busy" : "üî¥ Overloaded";

          return [index + 1, steward, total, active, resolved, winRate, status];
        });
      break;

    default:
      // For other metrics, show top locations by default
      const defaultLocationCounts = {};
      grievanceData.slice(1).forEach(function(row) {
        const location = row[GRIEVANCE_COLS.LOCATION - 1];
        if (location && location !== 'Work Location (Site)') {
          defaultLocationCounts[location] = (defaultLocationCounts[location] || 0) + 1;
        }
      });

      tableData = Object.entries(defaultLocationCounts)
        .sort(function(a, b) { return b[1] - a[1]; })
        .slice(0, 15)
        .map(function([location, count], index) {
          return [index + 1, location, count, "-", "-", "-", "üìä Data"];
        });
      break;
  }

  // Write data to table
  if (tableData.length > 0) {
    sheet.getRange(94, 1, tableData.length, 7).setValues(tableData);

    // Format alternating rows for better readability
    for (let i = 0; i < tableData.length; i++) {
      const rowNumber = 94 + i;
      if (i % 2 === 0) {
        sheet.getRange(rowNumber, 1, 1, 7).setBackground("#F9FAFB");
      }
    }
  } else {
    // Show "No data available" message
    sheet.getRange(94, 1, 1, 7).merge()
      .setValue("No data available for this metric")
      .setHorizontalAlignment("center")
      .setFontStyle("italic")
      .setFontColor("#9CA3AF");
  }
}

/**
 * Apply theme to dashboard
 */
function applyDashboardTheme(sheet, themeName) {
  let primaryColor, accentColor;

  switch (themeName) {
    case "Union Blue":
      primaryColor = COLORS.PRIMARY_BLUE;
      accentColor = COLORS.ACCENT_TEAL;
      break;
    case "Solidarity Red":
      primaryColor = COLORS.SOLIDARITY_RED;
      accentColor = COLORS.ACCENT_ORANGE;
      break;
    case "Success Green":
      primaryColor = COLORS.UNION_GREEN;
      accentColor = COLORS.ACCENT_TEAL;
      break;
    case "Professional Purple":
      primaryColor = COLORS.ACCENT_PURPLE;
      accentColor = COLORS.ACCENT_TEAL;
      break;
    default:
      primaryColor = COLORS.PRIMARY_BLUE;
      accentColor = COLORS.ACCENT_TEAL;
  }

  // Apply theme colors to headers
  sheet.getRange("A1:T1").setBackground(primaryColor);
  sheet.getRange("A4:T4").setBackground(accentColor);
  sheet.getRange("A10:T10").setBackground(primaryColor);
  sheet.getRange("A21:J21").setBackground(accentColor);
  sheet.getRange("L21:T21").setBackground(COLORS.ACCENT_PURPLE);
  sheet.getRange("A45:T45").setBackground(primaryColor);
  sheet.getRange("A47:J47").setBackground(accentColor);
  sheet.getRange("L47:T47").setBackground(COLORS.ACCENT_PURPLE);
  sheet.getRange("A68:T68").setBackground(COLORS.ACCENT_PURPLE);
  sheet.getRange("A70:T70").setBackground(accentColor);
  sheet.getRange("A91:T91").setBackground(primaryColor);
}

/**
 * Helper function to open the Interactive Dashboard sheet
 */
function openInteractiveDashboard() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEETS.INTERACTIVE_DASHBOARD);

  if (!sheet) {
    SpreadsheetApp.getUi().alert('Hmm, looks like your dashboard isn\'t set up yet!\n\n‚ú® No worries! Just run "509 Tools > Create Dashboard" and we\'ll get you started!');
    return;
  }

  ss.setActiveSheet(sheet);
  SpreadsheetApp.getUi().alert('üéâ Welcome to your Interactive Dashboard!\n\n' +
    '‚ú® Here\'s how to make it dance:\n\n' +
    '1Ô∏è‚É£ Pick your favorite metrics from the dropdowns in Row 7\n' +
    '2Ô∏è‚É£ Click "509 Tools > Interactive Dashboard > Refresh Charts" to see the magic\n' +
    '3Ô∏è‚É£ Turn on comparison mode to see two stories at once\n' +
    '4Ô∏è‚É£ Choose a theme that makes you smile!\n\n' +
    'üí™ Your data is ready to tell its story!');
}



// ================================================================================
// MODULE: KeyboardShortcuts.gs
// Source: KeyboardShortcuts.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * KEYBOARD SHORTCUTS SYSTEM
 * ------------------------------------------------------------------------====
 *
 * Power user keyboard shortcuts for common actions
 * Features:
 * - Quick navigation (Ctrl+G for Grievance Log, Ctrl+M for Members)
 * - Quick actions (Ctrl+N for new grievance, Ctrl+F for search)
 * - Batch operations shortcuts
 * - Configurable key bindings
 * - Help overlay (Ctrl+?)
 */

/**
 * Shows keyboard shortcuts help overlay
 */
function showKeyboardShortcuts() {
  const html = `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Roboto', 'Courier New', monospace;
      padding: 20px;
      margin: 0;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    .container {
      background: #252526;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.5);
      max-width: 700px;
      margin: 0 auto;
    }
    h2 {
      color: #4ec9b0;
      margin-top: 0;
      border-bottom: 2px solid #4ec9b0;
      padding-bottom: 10px;
      font-family: 'Roboto', Arial, sans-serif;
    }
    .category {
      margin: 25px 0;
    }
    .category h3 {
      color: #569cd6;
      font-size: 16px;
      margin-bottom: 12px;
      font-family: 'Roboto', Arial, sans-serif;
    }
    .shortcut-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      margin: 5px 0;
      background: #2d2d30;
      border-radius: 4px;
      border-left: 3px solid #4ec9b0;
    }
    .shortcut-row:hover {
      background: #3e3e42;
    }
    .shortcut-desc {
      color: #d4d4d4;
      flex: 1;
    }
    .shortcut-keys {
      display: flex;
      gap: 5px;
    }
    .key {
      background: #1e1e1e;
      color: #4ec9b0;
      padding: 4px 10px;
      border-radius: 4px;
      border: 1px solid #4ec9b0;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      font-weight: bold;
      min-width: 30px;
      text-align: center;
    }
    .key.modifier {
      background: #264f78;
      color: #9cdcfe;
      border-color: #569cd6;
    }
    .tip {
      background: #1e3a5f;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
      border-left: 4px solid #569cd6;
      color: #9cdcfe;
    }
    .tip strong {
      color: #4ec9b0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>‚å®Ô∏è Keyboard Shortcuts</h2>

    <div class="tip">
      <strong>üí° Pro Tip:</strong> Use keyboard shortcuts to navigate and perform actions 10x faster!
      Press <strong>Escape</strong> to close any dialog.
    </div>

    <div class="category">
      <h3>üß≠ Navigation</h3>
      <div class="shortcut-row">
        <div class="shortcut-desc">Go to Grievance Log</div>
        <div class="shortcut-keys">
          <span class="key modifier">Ctrl</span>
          <span class="key">G</span>
        </div>
      </div>
      <div class="shortcut-row">
        <div class="shortcut-desc">Go to Member Directory</div>
        <div class="shortcut-keys">
          <span class="key modifier">Ctrl</span>
          <span class="key">M</span>
        </div>
      </div>
      <div class="shortcut-row">
        <div class="shortcut-desc">Go to Dashboard</div>
        <div class="shortcut-keys">
          <span class="key modifier">Ctrl</span>
          <span class="key">D</span>
        </div>
      </div>
      <div class="shortcut-row">
        <div class="shortcut-desc">Go to Interactive Dashboard</div>
        <div class="shortcut-keys">
          <span class="key modifier">Ctrl</span>
          <span class="key">I</span>
        </div>
      </div>
    </div>

    <div class="category">
      <h3>üîç Search & Lookup</h3>
      <div class="shortcut-row">
        <div class="shortcut-desc">Search Members</div>
        <div class="shortcut-keys">
          <span class="key modifier">Ctrl</span>
          <span class="key">F</span>
        </div>
      </div>
      <div class="shortcut-row">
        <div class="shortcut-desc">Quick Member Search</div>
        <div class="shortcut-keys">
          <span class="key modifier">Ctrl</span>
          <span class="key modifier">Shift</span>
          <span class="key">F</span>
        </div>
      </div>
    </div>

    <div class="category">
      <h3>‚ûï Quick Actions</h3>
      <div class="shortcut-row">
        <div class="shortcut-desc">New Grievance</div>
        <div class="shortcut-keys">
          <span class="key modifier">Ctrl</span>
          <span class="key">N</span>
        </div>
      </div>
      <div class="shortcut-row">
        <div class="shortcut-desc">Compose Email</div>
        <div class="shortcut-keys">
          <span class="key modifier">Ctrl</span>
          <span class="key">E</span>
        </div>
      </div>
      <div class="shortcut-row">
        <div class="shortcut-desc">Batch Operations Menu</div>
        <div class="shortcut-keys">
          <span class="key modifier">Ctrl</span>
          <span class="key">B</span>
        </div>
      </div>
      <div class="shortcut-row">
        <div class="shortcut-desc">Refresh All</div>
        <div class="shortcut-keys">
          <span class="key modifier">Ctrl</span>
          <span class="key">R</span>
        </div>
      </div>
    </div>

    <div class="category">
      <h3>üìÅ File Management</h3>
      <div class="shortcut-row">
        <div class="shortcut-desc">Setup Drive Folder</div>
        <div class="shortcut-keys">
          <span class="key modifier">Ctrl</span>
          <span class="key modifier">Shift</span>
          <span class="key">D</span>
        </div>
      </div>
      <div class="shortcut-row">
        <div class="shortcut-desc">Upload Files</div>
        <div class="shortcut-keys">
          <span class="key modifier">Ctrl</span>
          <span class="key">U</span>
        </div>
      </div>
      <div class="shortcut-row">
        <div class="shortcut-desc">Show Grievance Files</div>
        <div class="shortcut-keys">
          <span class="key modifier">Ctrl</span>
          <span class="key modifier">Shift</span>
          <span class="key">F</span>
        </div>
      </div>
    </div>

    <div class="category">
      <h3>‚öôÔ∏è Automation</h3>
      <div class="shortcut-row">
        <div class="shortcut-desc">Notification Settings</div>
        <div class="shortcut-keys">
          <span class="key modifier">Ctrl</span>
          <span class="key modifier">Shift</span>
          <span class="key">N</span>
        </div>
      </div>
      <div class="shortcut-row">
        <div class="shortcut-desc">Report Settings</div>
        <div class="shortcut-keys">
          <span class="key modifier">Ctrl</span>
          <span class="key modifier">Shift</span>
          <span class="key">R</span>
        </div>
      </div>
    </div>

    <div class="category">
      <h3>‚ùì Help</h3>
      <div class="shortcut-row">
        <div class="shortcut-desc">Show This Help</div>
        <div class="shortcut-keys">
          <span class="key modifier">Ctrl</span>
          <span class="key">?</span>
        </div>
      </div>
      <div class="shortcut-row">
        <div class="shortcut-desc">Context Help</div>
        <div class="shortcut-keys">
          <span class="key">F1</span>
        </div>
      </div>
    </div>

    <div class="tip" style="margin-top: 30px;">
      <strong>üéØ Custom Shortcuts:</strong> Go to Settings to customize keyboard shortcuts.
      On Mac, use <strong>Cmd</strong> instead of <strong>Ctrl</strong>.
    </div>
  </div>

  <script>
    // Close on Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        google.script.host.close();
      }
    });
  </script>
</body>
</html>
  `;

  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(750)
    .setHeight(700);

  SpreadsheetApp.getUi().showModalDialog(htmlOutput, '‚å®Ô∏è Keyboard Shortcuts');
}

/**
 * Navigation shortcuts
 */
function navigateToGrievanceLog() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  if (sheet) {
    sheet.activate();
    SpreadsheetApp.getActiveSpreadsheet().toast('üìã Grievance Log', 'Navigation', 1);
  }
}

function navigateToMemberDirectory() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
  if (sheet) {
    sheet.activate();
    SpreadsheetApp.getActiveSpreadsheet().toast('üë• Member Directory', 'Navigation', 1);
  }
}

function navigateToDashboard() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEETS.DASHBOARD);
  if (sheet) {
    sheet.activate();
    SpreadsheetApp.getActiveSpreadsheet().toast('üìä Dashboard', 'Navigation', 1);
  }
}

function navigateToInteractiveDashboard() {
  openInteractiveDashboard();
}

/**
 * Quick action shortcuts
 */
function quickNewGrievance() {
  showStartGrievanceDialog();
}

function quickSearch() {
  showMemberSearch();
}

function quickEmail() {
  composeGrievanceEmail();
}

function quickBatchOps() {
  showBatchOperationsMenu();
}

function quickRefresh() {
  refreshCalculations();
}

/**
 * Keyboard shortcut registry and handler
 */
KEYBOARD_SHORTCUTS = {
  // Navigation
  'Ctrl+G': 'navigateToGrievanceLog',
  'Ctrl+M': 'navigateToMemberDirectory',
  'Ctrl+D': 'navigateToDashboard',
  'Ctrl+I': 'navigateToInteractiveDashboard',

  // Search
  'Ctrl+F': 'quickSearch',

  // Actions
  'Ctrl+N': 'quickNewGrievance',
  'Ctrl+E': 'quickEmail',
  'Ctrl+B': 'quickBatchOps',
  'Ctrl+R': 'quickRefresh',

  // Drive
  'Ctrl+Shift+D': 'setupDriveFolderForGrievance',
  'Ctrl+U': 'showFileUploadDialog',

  // Automation
  'Ctrl+Shift+N': 'showNotificationSettings',
  'Ctrl+Shift+R': 'showReportAutomationSettings',

  // Help
  'Ctrl+?': 'showKeyboardShortcuts',
  'F1': 'showContextHelp'
};

/**
 * Shows keyboard shortcuts configuration
 */
function showKeyboardShortcutsConfig() {
  const html = `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 {
      color: #1a73e8;
      margin-top: 0;
      border-bottom: 3px solid #1a73e8;
      padding-bottom: 10px;
    }
    .info-box {
      background: #e8f0fe;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
      border-left: 4px solid #1a73e8;
    }
    .warning-box {
      background: #fff3cd;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
      border-left: 4px solid #ffc107;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    th {
      background: #1a73e8;
      color: white;
      padding: 12px;
      text-align: left;
      font-weight: 500;
    }
    td {
      padding: 10px 12px;
      border-bottom: 1px solid #e0e0e0;
    }
    tr:hover {
      background: #f5f5f5;
    }
    .shortcut-code {
      background: #f5f5f5;
      padding: 4px 8px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #1a73e8;
      border: 1px solid #ddd;
    }
    button {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
      margin: 10px 5px 0 0;
    }
    button:hover {
      background: #1557b0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>‚öôÔ∏è Keyboard Shortcuts Configuration</h2>

    <div class="info-box">
      <strong>‚ÑπÔ∏è How to Use:</strong> Keyboard shortcuts work globally across all sheets.
      Press the key combination to trigger the action instantly.
    </div>

    <div class="warning-box">
      <strong>‚ö†Ô∏è Note:</strong> Some shortcuts may conflict with browser shortcuts.
      Use Google Sheets in full-screen mode (F11) for best experience.
    </div>

    <h3>Current Shortcuts</h3>
    <table>
      <thead>
        <tr>
          <th>Shortcut</th>
          <th>Action</th>
          <th>Category</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span class="shortcut-code">Ctrl+G</span></td>
          <td>Go to Grievance Log</td>
          <td>Navigation</td>
        </tr>
        <tr>
          <td><span class="shortcut-code">Ctrl+M</span></td>
          <td>Go to Member Directory</td>
          <td>Navigation</td>
        </tr>
        <tr>
          <td><span class="shortcut-code">Ctrl+D</span></td>
          <td>Go to Dashboard</td>
          <td>Navigation</td>
        </tr>
        <tr>
          <td><span class="shortcut-code">Ctrl+I</span></td>
          <td>Go to Interactive Dashboard</td>
          <td>Navigation</td>
        </tr>
        <tr>
          <td><span class="shortcut-code">Ctrl+F</span></td>
          <td>Search Members</td>
          <td>Search</td>
        </tr>
        <tr>
          <td><span class="shortcut-code">Ctrl+N</span></td>
          <td>New Grievance</td>
          <td>Actions</td>
        </tr>
        <tr>
          <td><span class="shortcut-code">Ctrl+E</span></td>
          <td>Compose Email</td>
          <td>Actions</td>
        </tr>
        <tr>
          <td><span class="shortcut-code">Ctrl+B</span></td>
          <td>Batch Operations</td>
          <td>Actions</td>
        </tr>
        <tr>
          <td><span class="shortcut-code">Ctrl+R</span></td>
          <td>Refresh All</td>
          <td>Actions</td>
        </tr>
        <tr>
          <td><span class="shortcut-code">Ctrl+Shift+D</span></td>
          <td>Setup Drive Folder</td>
          <td>Files</td>
        </tr>
        <tr>
          <td><span class="shortcut-code">Ctrl+U</span></td>
          <td>Upload Files</td>
          <td>Files</td>
        </tr>
        <tr>
          <td><span class="shortcut-code">Ctrl+?</span></td>
          <td>Show Shortcuts Help</td>
          <td>Help</td>
        </tr>
        <tr>
          <td><span class="shortcut-code">F1</span></td>
          <td>Context Help</td>
          <td>Help</td>
        </tr>
      </tbody>
    </table>

    <button onclick="google.script.run.withSuccessHandler(function() { google.script.host.close(); }).showKeyboardShortcuts()">
      üìñ View Shortcuts Guide
    </button>
  </div>
</body>
</html>
  `;

  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(750)
    .setHeight(650);

  SpreadsheetApp.getUi().showModalDialog(htmlOutput, '‚öôÔ∏è Keyboard Shortcuts Configuration');
}

/**
 * Shows context-sensitive help based on current sheet
 */
function showContextHelp() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const activeSheet = ss.getActiveSheet();
  const sheetName = activeSheet.getName();

  let helpContent = '';

  switch (sheetName) {
    case SHEETS.GRIEVANCE_LOG:
      helpContent = `
<h3>üìã Grievance Log Help</h3>
<p><strong>This sheet tracks all union grievances.</strong></p>

<h4>Common Tasks:</h4>
<ul>
  <li><strong>Add New Grievance:</strong> Use menu: üìã Grievance Tools ‚Üí ‚ûï Start New Grievance (or Ctrl+N)</li>
  <li><strong>Update Status:</strong> Select rows ‚Üí ‚ö° Batch Operations ‚Üí üìä Bulk Update Status</li>
  <li><strong>Assign Steward:</strong> Select rows ‚Üí ‚ö° Batch Operations ‚Üí üë§ Bulk Assign Steward</li>
  <li><strong>View Files:</strong> Select row ‚Üí üìÅ Google Drive ‚Üí üìÇ Show Grievance Files</li>
  <li><strong>Send Email:</strong> Select row ‚Üí üìß Communications ‚Üí üìß Compose Email (or Ctrl+E)</li>
</ul>

<h4>Important Columns:</h4>
<ul>
  <li><strong>Column H:</strong> Step 1 Deadline (auto-calculated)</li>
  <li><strong>Column U:</strong> Days to Deadline (auto-calculated)</li>
  <li><strong>Column V:</strong> Deadline Status (auto-calculated)</li>
</ul>

<h4>Tips:</h4>
<ul>
  <li>Red rows = Overdue grievances (urgent action needed)</li>
  <li>Yellow rows = Deadline within 7 days</li>
  <li>Use filters to focus on specific statuses or stewards</li>
</ul>
      `;
      break;

    case SHEETS.MEMBER_DIR:
      helpContent = `
<h3>üë• Member Directory Help</h3>
<p><strong>This sheet contains all union member information.</strong></p>

<h4>Common Tasks:</h4>
<ul>
  <li><strong>Search Members:</strong> Use menu: üîç Search & Lookup ‚Üí üîç Search Members (or Ctrl+F)</li>
  <li><strong>Add Member:</strong> Fill in a new row with required fields (ID, First Name, Last Name)</li>
  <li><strong>Update Info:</strong> Click on any cell and edit directly</li>
</ul>

<h4>Important Columns:</h4>
<ul>
  <li><strong>Column A:</strong> Member ID (must be unique, format: M######)</li>
  <li><strong>Column H:</strong> Email (validated format)</li>
  <li><strong>Column I:</strong> Phone (validated format)</li>
  <li><strong>Column J:</strong> Is Steward? (Yes/No dropdown)</li>
</ul>

<h4>Auto-Calculated Fields:</h4>
<ul>
  <li><strong>Column Z:</strong> Has Active Grievance? (auto-updated)</li>
  <li><strong>Column AA:</strong> Grievance Status Snapshot</li>
  <li><strong>Column AB:</strong> Next Grievance Deadline</li>
</ul>

<h4>Tips:</h4>
<ul>
  <li>Use üÜî Generate Next Member ID to get the next available ID</li>
  <li>Email and phone fields validate automatically</li>
  <li>Mark stewards in Column J to enable auto-assignment</li>
</ul>
      `;
      break;

    case SHEETS.DASHBOARD:
      helpContent = `
<h3>üìä Dashboard Help</h3>
<p><strong>Real-time overview of all grievance operations.</strong></p>

<h4>Dashboard Sections:</h4>
<ul>
  <li><strong>Key Metrics:</strong> Total grievances, open cases, average resolution time</li>
  <li><strong>Status Breakdown:</strong> Grievances by current status</li>
  <li><strong>Issue Type Analysis:</strong> Most common grievance types</li>
  <li><strong>Steward Workload:</strong> Cases assigned per steward</li>
  <li><strong>Timeline:</strong> Cases filed this month vs. last month</li>
</ul>

<h4>Other Dashboards:</h4>
<ul>
  <li><strong>Interactive Dashboard:</strong> üìä Dashboards ‚Üí ‚ú® Interactive Dashboard</li>
  <li><strong>Unified Operations Monitor:</strong> üìä Dashboards ‚Üí üéØ Unified Operations Monitor</li>
</ul>

<h4>Tips:</h4>
<ul>
  <li>Dashboard auto-updates when data changes</li>
  <li>Use üîÑ Refresh All to force update (Ctrl+R)</li>
  <li>Charts are interactive - click to see details</li>
</ul>
      `;
      break;

    default:
      helpContent = `
<h3>‚ùì 509 Dashboard Help</h3>
<p><strong>Welcome to the SEIU Local 509 Grievance Dashboard!</strong></p>

<h4>Main Sheets:</h4>
<ul>
  <li><strong>üìã Grievance Log:</strong> Track all grievances (Ctrl+G)</li>
  <li><strong>üë• Member Directory:</strong> Member information (Ctrl+M)</li>
  <li><strong>üìä Dashboard:</strong> Real-time metrics (Ctrl+D)</li>
</ul>

<h4>Quick Actions:</h4>
<ul>
  <li><strong>New Grievance:</strong> Ctrl+N</li>
  <li><strong>Search Members:</strong> Ctrl+F</li>
  <li><strong>Compose Email:</strong> Ctrl+E</li>
  <li><strong>Batch Operations:</strong> Ctrl+B</li>
</ul>

<h4>Getting Started:</h4>
<ol>
  <li>Navigate to the Grievance Log or Member Directory</li>
  <li>Press F1 for context-specific help</li>
  <li>Press Ctrl+? to see all keyboard shortcuts</li>
  <li>Use the menu: ‚ùì Help & Support ‚Üí üìö Getting Started Guide</li>
</ol>
      `;
  }

  const html = `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-height: 600px;
      overflow-y: auto;
    }
    h2 {
      color: #1a73e8;
      margin-top: 0;
      border-bottom: 3px solid #1a73e8;
      padding-bottom: 10px;
    }
    h3 {
      color: #1a73e8;
      margin-top: 0;
    }
    h4 {
      color: #333;
      margin: 20px 0 10px 0;
    }
    ul, ol {
      margin: 10px 0;
      padding-left: 25px;
    }
    li {
      margin: 8px 0;
      line-height: 1.6;
    }
    strong {
      color: #1a73e8;
    }
    .sheet-badge {
      display: inline-block;
      background: #e8f0fe;
      color: #1a73e8;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="sheet-badge">üìç Current Sheet: ${sheetName}</div>
    ${helpContent}
  </div>
</body>
</html>
  `;

  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(700)
    .setHeight(650);

  SpreadsheetApp.getUi().showModalDialog(htmlOutput, `‚ùì Help - ${sheetName}`);
}



// ================================================================================
// MODULE: LazyLoadCharts.gs
// Source: LazyLoadCharts.gs
// ================================================================================

/****************************************************
 * LAZY LOAD CHARTS SYSTEM
 * Phase 6 - Medium Priority
 *
 * Charts only built when sheets are viewed
 * Faster initial load times
 *
 * Based on ADDITIONAL_ENHANCEMENTS.md Phase 3
 ****************************************************/

/**
 * Event handler for sheet activation
 * Builds charts only when user views the sheet
 */
function onSheetActivate(e) {
  try {
    const sheetName = e.source.getActiveSheet().getName();
    Logger.log(`Sheet activated: ${sheetName}`);

    // Build charts based on which sheet was activated
    switch(sheetName) {
      case SHEETS.DASHBOARD:
        buildDashboardChartsIfNeeded();
        break;

      case SHEETS.INTERACTIVE_DASHBOARD:
        buildInteractiveChartsIfNeeded();
        break;

      case SHEETS.TRENDS:
        buildTrendsChartsIfNeeded();
        break;

      case SHEETS.LOCATION:
        buildLocationChartsIfNeeded();
        break;

      case SHEETS.TYPE_ANALYSIS:
        buildTypeAnalysisChartsIfNeeded();
        break;
    }

  } catch (error) {
    Logger.log(`Error in onSheetActivate: ${error.message}`);
  }
}

/**
 * Build dashboard charts if needed (not built recently)
 */
function buildDashboardChartsIfNeeded() {
  const sheetName = SHEETS.DASHBOARD;

  if (shouldRebuildCharts(sheetName, 300000)) { // 5 minutes
    Logger.log('Building dashboard charts...');
    buildDashboardCharts();
    updateLastBuildTime(sheetName);
  } else {
    Logger.log('Dashboard charts are recent, skipping rebuild');
  }
}

/**
 * Build interactive dashboard charts if needed
 */
function buildInteractiveChartsIfNeeded() {
  const sheetName = SHEETS.INTERACTIVE_DASHBOARD;

  if (shouldRebuildCharts(sheetName, 300000)) { // 5 minutes
    Logger.log('Building interactive dashboard charts...');

    // Call the interactive dashboard chart builder if it exists
    if (typeof buildInteractiveDashboardCharts === 'function') {
      buildInteractiveDashboardCharts();
    }

    updateLastBuildTime(sheetName);
  }
}

/**
 * Build trends charts if needed
 */
function buildTrendsChartsIfNeeded() {
  const sheetName = SHEETS.TRENDS;

  if (shouldRebuildCharts(sheetName, 600000)) { // 10 minutes (less frequently)
    Logger.log('Building trends charts...');

    // Build trends charts (implement as needed)
    if (typeof buildTrendsCharts === 'function') {
      buildTrendsCharts();
    }

    updateLastBuildTime(sheetName);
  }
}

/**
 * Build location analytics charts if needed
 */
function buildLocationChartsIfNeeded() {
  const sheetName = SHEETS.LOCATION;

  if (shouldRebuildCharts(sheetName, 600000)) { // 10 minutes
    Logger.log('Building location charts...');

    if (typeof buildLocationCharts === 'function') {
      buildLocationCharts();
    }

    updateLastBuildTime(sheetName);
  }
}

/**
 * Build type analysis charts if needed
 */
function buildTypeAnalysisChartsIfNeeded() {
  const sheetName = SHEETS.TYPE_ANALYSIS;

  if (shouldRebuildCharts(sheetName, 600000)) { // 10 minutes
    Logger.log('Building type analysis charts...');

    if (typeof buildTypeAnalysisCharts === 'function') {
      buildTypeAnalysisCharts();
    }

    updateLastBuildTime(sheetName);
  }
}

/**
 * Check if charts should be rebuilt for a sheet
 * @param {string} sheetName - Name of the sheet
 * @param {number} maxAge - Maximum age in milliseconds before rebuild
 * @returns {boolean} True if charts should be rebuilt
 */
function shouldRebuildCharts(sheetName, maxAge) {
  const props = PropertiesService.getScriptProperties();
  const key = `CHARTS_LAST_BUILD_${sheetName}`;
  const lastBuild = props.getProperty(key);

  if (!lastBuild) {
    return true; // Never built
  }

  const age = Date.now() - parseInt(lastBuild);
  return age >= maxAge;
}

/**
 * Update the last build time for a sheet
 * @param {string} sheetName - Name of the sheet
 */
function updateLastBuildTime(sheetName) {
  const props = PropertiesService.getScriptProperties();
  const key = `CHARTS_LAST_BUILD_${sheetName}`;
  props.setProperty(key, Date.now().toString());
}

/**
 * Build dashboard charts
 * Simplified version - builds basic charts only
 */
function buildDashboardCharts() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const dashboard = ss.getSheetByName(SHEETS.DASHBOARD);

  if (!dashboard) {
    Logger.log('Dashboard sheet not found');
    return;
  }

  // Remove existing charts
  const charts = dashboard.getCharts();
  for (const chart of charts) {
    dashboard.removeChart(chart);
  }

  // Get data
  const dataCache = buildDataCache();

  if (!dataCache.grievances) {
    Logger.log('No grievance data available for charts');
    return;
  }

  try {
    // Chart 1: Grievances by Status (Pie Chart)
    buildGrievancesByStatusChart(dashboard, dataCache);

    // Chart 2: Grievances by Month (Column Chart)
    buildGrievancesByMonthChart(dashboard, dataCache);

    Logger.log('‚úÖ Dashboard charts built');

  } catch (error) {
    Logger.log(`Error building dashboard charts: ${error.message}`);
  }
}

/**
 * Build grievances by status pie chart
 */
function buildGrievancesByStatusChart(dashboard, dataCache) {
  const grievanceData = dataCache.grievances;

  // Count by status
  const statusCounts = {};

  for (let i = 1; i < grievanceData.length; i++) {
    const status = grievanceData[i][4]; // Column E
    statusCounts[status] = (statusCounts[status] || 0) + 1;
  }

  // Prepare chart data
  const chartData = [['Status', 'Count']];
  for (const [status, count] of Object.entries(statusCounts)) {
    chartData.push([status, count]);
  }

  // Write data to sheet (temporary range)
  const tempRange = dashboard.getRange(50, 10, chartData.length, 2);
  tempRange.setValues(chartData);

  // Create chart
  const chart = dashboard.newChart()
    .setChartType(Charts.ChartType.PIE)
    .addRange(tempRange)
    .setPosition(5, 4, 0, 0)
    .setOption('title', 'Grievances by Status')
    .setOption('width', 400)
    .setOption('height', 300)
    .build();

  dashboard.insertChart(chart);

  // Clear temporary data
  tempRange.clear();
}

/**
 * Build grievances by month column chart
 */
function buildGrievancesByMonthChart(dashboard, dataCache) {
  const grievanceData = dataCache.grievances;

  // Count by month
  const monthCounts = {};

  for (let i = 1; i < grievanceData.length; i++) {
    const dateFiled = grievanceData[i][8]; // Column I

    if (dateFiled) {
      const date = new Date(dateFiled);
      const monthKey = Utilities.formatDate(date, Session.getScriptTimeZone(), 'yyyy-MM');
      monthCounts[monthKey] = (monthCounts[monthKey] || 0) + 1;
    }
  }

  // Sort by month
  const sortedMonths = Object.entries(monthCounts).sort();

  // Prepare chart data (last 12 months)
  const chartData = [['Month', 'Grievances']];
  const recent = sortedMonths.slice(-12);

  for (const [month, count] of recent) {
    chartData.push([month, count]);
  }

  // Write data to sheet (temporary range)
  const tempRange = dashboard.getRange(70, 10, chartData.length, 2);
  tempRange.setValues(chartData);

  // Create chart
  const chart = dashboard.newChart()
    .setChartType(Charts.ChartType.COLUMN)
    .addRange(tempRange)
    .setPosition(20, 4, 0, 0)
    .setOption('title', 'Grievances by Month (Last 12)')
    .setOption('width', 600)
    .setOption('height', 300)
    .setOption('legend', { position: 'none' })
    .build();

  dashboard.insertChart(chart);

  // Clear temporary data
  tempRange.clear();
}

/**
 * Force rebuild all charts
 * Ignores cache and rebuilds everything
 */
function forceRebuildAllCharts() {
  const ui = SpreadsheetApp.getUi();

  const response = ui.alert(
    'Force Rebuild All Charts?',
    'This will rebuild charts on all sheets, ignoring cache.\n\n' +
    'This may take a few minutes.\n\n' +
    'Continue?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return;
  }

  try {
    ui.alert('Rebuilding all charts...');

    // Clear all chart build times
    clearAllChartBuildTimes();

    // Rebuild charts for each sheet
    buildDashboardCharts();

    if (typeof buildInteractiveDashboardCharts === 'function') {
      buildInteractiveDashboardCharts();
    }

    if (typeof buildTrendsCharts === 'function') {
      buildTrendsCharts();
    }

    if (typeof buildLocationCharts === 'function') {
      buildLocationCharts();
    }

    if (typeof buildTypeAnalysisCharts === 'function') {
      buildTypeAnalysisCharts();
    }

    ui.alert(
      'Charts Rebuilt',
      'All charts have been rebuilt successfully.',
      ui.ButtonSet.OK
    );

  } catch (error) {
    ui.alert(
      'Error',
      `Failed to rebuild charts: ${error.message}`,
      ui.ButtonSet.OK
    );
  }
}

/**
 * Clear all chart build times
 */
function clearAllChartBuildTimes() {
  const props = PropertiesService.getScriptProperties();

  const sheets = [
    SHEETS.DASHBOARD,
    SHEETS.INTERACTIVE_DASHBOARD,
    SHEETS.TRENDS,
    SHEETS.LOCATION,
    SHEETS.TYPE_ANALYSIS
  ];

  for (const sheet of sheets) {
    props.deleteProperty(`CHARTS_LAST_BUILD_${sheet}`);
  }

  Logger.log('All chart build times cleared');
}

/**
 * Show chart build status
 */
function showChartBuildStatus() {
  const ui = SpreadsheetApp.getUi();
  const props = PropertiesService.getScriptProperties();

  const sheets = [
    SHEETS.DASHBOARD,
    SHEETS.INTERACTIVE_DASHBOARD,
    SHEETS.TRENDS,
    SHEETS.LOCATION,
    SHEETS.TYPE_ANALYSIS
  ];

  let message = 'CHART BUILD STATUS\n\n';

  for (const sheet of sheets) {
    const key = `CHARTS_LAST_BUILD_${sheet}`;
    const lastBuild = props.getProperty(key);

    if (lastBuild) {
      const date = new Date(parseInt(lastBuild));
      const age = Date.now() - parseInt(lastBuild);
      const ageMinutes = Math.floor(age / 60000);

      message += `${sheet}:\n`;
      message += `  Last built: ${ageMinutes} minutes ago\n`;
      message += `  (${date.toLocaleString()})\n\n`;
    } else {
      message += `${sheet}: Never built\n\n`;
    }
  }

  ui.alert('Chart Build Status', message, ui.ButtonSet.OK);
}

/**
 * Menu functions
 */
function FORCE_REBUILD_ALL_CHARTS() {
  forceRebuildAllCharts();
}

function SHOW_CHART_BUILD_STATUS() {
  showChartBuildStatus();
}

function CLEAR_CHART_CACHE() {
  clearAllChartBuildTimes();

  const ui = SpreadsheetApp.getUi();
  ui.alert(
    'Chart Cache Cleared',
    'Chart build cache has been cleared.\n\n' +
    'Charts will rebuild next time you view each sheet.',
    ui.ButtonSet.OK
  );
}



// ================================================================================
// MODULE: MemberDirectoryDropdowns.gs
// Source: MemberDirectoryDropdowns.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * MEMBER DIRECTORY DROPDOWNS
 * ------------------------------------------------------------------------====
 *
 * Adds data validation dropdowns to Member Directory for consistent data entry.
 * All dropdown values are pulled from the Config sheet for easy customization.
 *
 * SINGLE-SELECT DROPDOWNS:
 * - Job Title (D)
 * - Work Location (E)
 * - Unit (F)
 * - Is Steward (N)
 * - Supervisor Name (L)
 * - Manager Name (M)
 * - Assigned Steward (P)
 * - Contact Steward (Z)
 *
 * MULTI-SELECT DROPDOWNS (comma-separated values allowed):
 * - Office Days (G)
 * - Preferred Communication (J)
 * - Best Time to Contact (K)
 * - Committees (O)
 *
 * DATE FIELDS:
 * - Recent Contact Date (Y) - Date validation only
 *
 * ------------------------------------------------------------------------====
 */

/**
 * Sets up all dropdowns for the Member Directory
 * Pulls values from Config sheet where available
 */
function setupMemberDirectoryDropdowns() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
  const configSheet = ss.getSheetByName(SHEETS.CONFIG);

  if (!memberSheet) {
    SpreadsheetApp.getUi().alert('Member Directory sheet not found!');
    return;
  }

  if (!configSheet) {
    SpreadsheetApp.getUi().alert('Config sheet not found! Dropdowns require a Config sheet.');
    return;
  }

  SpreadsheetApp.getActiveSpreadsheet().toast('Setting up dropdowns...', 'Please wait', -1);

  try {
    const lastRow = Math.max(memberSheet.getLastRow(), 1000);

    // ==================== SINGLE-SELECT DROPDOWNS ====================

    // Job Title (Column D / MEMBER_COLS.JOB_TITLE)
    const jobTitles = getConfigValuesFromSheet(configSheet, CONFIG_COLS.JOB_TITLES);
    if (jobTitles.length > 0) {
      setDropdownByCol(memberSheet, MEMBER_COLS.JOB_TITLE, lastRow, jobTitles, 'Job Title', true);
    }

    // Work Location (Column E / MEMBER_COLS.WORK_LOCATION)
    const locations = getConfigValuesFromSheet(configSheet, CONFIG_COLS.OFFICE_LOCATIONS);
    if (locations.length > 0) {
      setDropdownByCol(memberSheet, MEMBER_COLS.WORK_LOCATION, lastRow, locations, 'Work Location', true);
    }

    // Unit (Column F / MEMBER_COLS.UNIT)
    const units = getConfigValuesFromSheet(configSheet, CONFIG_COLS.UNITS);
    if (units.length > 0) {
      setDropdownByCol(memberSheet, MEMBER_COLS.UNIT, lastRow, units, 'Unit', true);
    }

    // Is Steward (Column N / MEMBER_COLS.IS_STEWARD)
    const yesNo = getConfigValuesFromSheet(configSheet, CONFIG_COLS.YES_NO);
    if (yesNo.length > 0) {
      setDropdownByCol(memberSheet, MEMBER_COLS.IS_STEWARD, lastRow, yesNo, 'Is Steward', true);
    }

    // Supervisor Name (Column L / MEMBER_COLS.SUPERVISOR)
    const supervisors = getConfigValuesFromSheet(configSheet, CONFIG_COLS.SUPERVISORS);
    if (supervisors.length > 0) {
      setDropdownByCol(memberSheet, MEMBER_COLS.SUPERVISOR, lastRow, supervisors, 'Supervisor', true);
    }

    // Manager Name (Column M / MEMBER_COLS.MANAGER)
    const managers = getConfigValuesFromSheet(configSheet, CONFIG_COLS.MANAGERS);
    if (managers.length > 0) {
      setDropdownByCol(memberSheet, MEMBER_COLS.MANAGER, lastRow, managers, 'Manager', true);
    }

    // Assigned Steward (Column P / MEMBER_COLS.ASSIGNED_STEWARD)
    const stewards = getStewardsList();
    if (stewards.length > 0) {
      setDropdownByCol(memberSheet, MEMBER_COLS.ASSIGNED_STEWARD, lastRow, stewards, 'Assigned Steward', true);
    }

    // Contact Steward (Column Z / MEMBER_COLS.CONTACT_STEWARD)
    if (stewards.length > 0) {
      setDropdownByCol(memberSheet, MEMBER_COLS.CONTACT_STEWARD, lastRow, stewards, 'Contact Steward', true);
    }

    // ==================== MULTI-SELECT DROPDOWNS ====================
    // These allow comma-separated values (setAllowInvalid = true)

    // Office Days (Column G / MEMBER_COLS.OFFICE_DAYS) - MULTI-SELECT
    const officeDays = getConfigValuesFromSheet(configSheet, CONFIG_COLS.OFFICE_DAYS);
    if (officeDays.length > 0) {
      setDropdownByCol(memberSheet, MEMBER_COLS.OFFICE_DAYS, lastRow, officeDays, 'Office Days', false);
    }

    // Preferred Communication (Column J / MEMBER_COLS.PREFERRED_COMM) - MULTI-SELECT
    const commMethods = getConfigValuesFromSheet(configSheet, CONFIG_COLS.COMM_METHODS);
    if (commMethods.length > 0) {
      setDropdownByCol(memberSheet, MEMBER_COLS.PREFERRED_COMM, lastRow, commMethods, 'Preferred Communication', false);
    }

    // Best Time to Contact (Column K / MEMBER_COLS.BEST_TIME) - MULTI-SELECT
    const bestTimes = getConfigValuesFromSheet(configSheet, CONFIG_COLS.BEST_TIMES);
    if (bestTimes.length > 0) {
      setDropdownByCol(memberSheet, MEMBER_COLS.BEST_TIME, lastRow, bestTimes, 'Best Time to Contact', false);
    }

    // Committees (Column O / MEMBER_COLS.COMMITTEES) - MULTI-SELECT
    const committees = getConfigValuesFromSheet(configSheet, CONFIG_COLS.STEWARD_COMMITTEES);
    if (committees.length > 0) {
      setDropdownByCol(memberSheet, MEMBER_COLS.COMMITTEES, lastRow, committees, 'Committees', false);
    }

    // ==================== DATE VALIDATION ====================

    // Recent Contact Date (Column Y / MEMBER_COLS.RECENT_CONTACT_DATE) - DATE ONLY
    setDateValidation(memberSheet, MEMBER_COLS.RECENT_CONTACT_DATE, lastRow, 'Recent Contact Date');

    SpreadsheetApp.getActiveSpreadsheet().toast('Dropdowns set up successfully!', 'Complete', 3);

    SpreadsheetApp.getUi().alert(
      'Dropdowns Setup Complete',
      'Data validation dropdowns have been added to the Member Directory.\n\n' +
      'Single-select fields: Job Title, Work Location, Unit, Is Steward, Supervisor, Manager, Assigned Steward, Contact Steward\n\n' +
      'Multi-select fields (comma-separated): Office Days, Preferred Communication, Best Time to Contact, Committees\n\n' +
      'Date fields: Recent Contact Date\n\n' +
      'To customize dropdown options, edit the Config sheet.',
      SpreadsheetApp.getUi().ButtonSet.OK
    );

  } catch (error) {
    SpreadsheetApp.getUi().alert('Error: ' + error.message);
    Logger.log('Error setting up dropdowns: ' + error);
  }
}

/**
 * Sets up dropdowns for the Grievance Log
 * Includes Issue Category, Articles Violated, Status, Step, etc.
 */
function setupGrievanceLogDropdowns() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  const configSheet = ss.getSheetByName(SHEETS.CONFIG);

  if (!grievanceSheet) {
    SpreadsheetApp.getUi().alert('Grievance Log sheet not found!');
    return;
  }

  if (!configSheet) {
    SpreadsheetApp.getUi().alert('Config sheet not found!');
    return;
  }

  SpreadsheetApp.getActiveSpreadsheet().toast('Setting up Grievance Log dropdowns...', 'Please wait', -1);

  try {
    const lastRow = Math.max(grievanceSheet.getLastRow(), 500);

    // Status (Column E / GRIEVANCE_COLS.STATUS = 5) - SINGLE-SELECT
    const statuses = getConfigValuesFromSheet(configSheet, CONFIG_COLS.GRIEVANCE_STATUS);
    if (statuses.length > 0) {
      setDropdownByCol(grievanceSheet, GRIEVANCE_COLS.STATUS, lastRow, statuses, 'Status', true);
    }

    // Current Step (Column F / GRIEVANCE_COLS.CURRENT_STEP = 6) - SINGLE-SELECT
    const steps = getConfigValuesFromSheet(configSheet, CONFIG_COLS.GRIEVANCE_STEP);
    if (steps.length > 0) {
      setDropdownByCol(grievanceSheet, GRIEVANCE_COLS.CURRENT_STEP, lastRow, steps, 'Current Step', true);
    }

    // Articles Violated (Column V / GRIEVANCE_COLS.ARTICLES = 22) - MULTI-SELECT
    const articles = getConfigValuesFromSheet(configSheet, CONFIG_COLS.ARTICLES_VIOLATED);
    if (articles.length > 0) {
      setDropdownByCol(grievanceSheet, GRIEVANCE_COLS.ARTICLES, lastRow, articles, 'Articles Violated', false);
    }

    // Issue Category (Column W / GRIEVANCE_COLS.ISSUE_CATEGORY = 23) - MULTI-SELECT
    const issueCategories = getConfigValuesFromSheet(configSheet, CONFIG_COLS.ISSUE_CATEGORY);
    if (issueCategories.length > 0) {
      setDropdownByCol(grievanceSheet, GRIEVANCE_COLS.ISSUE_CATEGORY, lastRow, issueCategories, 'Issue Category', false);
    }

    // Steward (Column AA / GRIEVANCE_COLS.STEWARD = 27) - SINGLE-SELECT
    const stewards = getStewardsList();
    if (stewards.length > 0) {
      setDropdownByCol(grievanceSheet, GRIEVANCE_COLS.STEWARD, lastRow, stewards, 'Assigned Steward', true);
    }

    SpreadsheetApp.getActiveSpreadsheet().toast('Grievance Log dropdowns set up!', 'Complete', 3);

  } catch (error) {
    SpreadsheetApp.getUi().alert('Error: ' + error.message);
    Logger.log('Error setting up Grievance Log dropdowns: ' + error);
  }
}

/**
 * Gets values from a column in the Config sheet (sheet-based version)
 * NOTE: This is different from getConfigColumnValues in Code.gs which takes columnIndex only.
 * @param {Sheet} configSheet - The Config sheet
 * @param {number} colNum - Column number (1-indexed)
 * @returns {Array} Array of non-empty values
 */
function getConfigValuesFromSheet(configSheet, colNum) {
  try {
    const lastRow = configSheet.getLastRow();
    if (lastRow < 2) return [];

    const values = configSheet.getRange(2, colNum, lastRow - 1, 1).getValues();
    return values
      .map(function(row) { return row[0]; })
      .filter(function(val) { return val !== '' && val !== null && val !== undefined; })
      .map(function(val) { return String(val).trim(); });
  } catch (error) {
    Logger.log('Error getting config values from column ' + colNum + ': ' + error.message);
    return [];
  }
}

/**
 * Sets a dropdown validation rule on a column using MEMBER_COLS/GRIEVANCE_COLS constant
 * @param {Sheet} sheet - The sheet to apply the dropdown to
 * @param {number} colNum - Column number (1-indexed, from constants)
 * @param {number} lastRow - Last row to apply validation
 * @param {Array} values - Array of values for dropdown
 * @param {string} name - Name for logging
 * @param {boolean} strictValidation - If true, only allow list values; if false, allow other values (for multi-select)
 */
function setDropdownByCol(sheet, colNum, lastRow, values, name, strictValidation) {
  try {
    const colLetter = getColumnLetter(colNum);
    const range = sheet.getRange(`${colLetter}2:${colLetter}${lastRow}`);

    // Google Sheets has a 500 item limit for requireValueInList
    // For larger lists, use requireValueInRange with a helper column in Config
    if (values.length > 500) {
      Logger.log(`${name} has ${values.length} items (>500 limit). Using range reference instead.`);

      // Write values to a dynamic range in Config sheet and use range reference
      const ss = SpreadsheetApp.getActiveSpreadsheet();
      const configSheet = ss.getSheetByName(SHEETS.CONFIG);

      if (configSheet) {
        // Use CONFIG_COLS.STEWARDS for steward-related dropdowns
        const targetCol = CONFIG_COLS.STEWARDS;

        // Clear existing values and write new ones (starting from row 2 to preserve header)
        const existingLastRow = configSheet.getLastRow();
        if (existingLastRow > 1) {
          configSheet.getRange(2, targetCol, Math.max(existingLastRow - 1, 1), 1).clearContent();
        }

        // Write the values
        const valuesToWrite = values.map(function(v) { return [v]; });
        configSheet.getRange(2, targetCol, values.length, 1).setValues(valuesToWrite);

        // Create validation using range reference
        const configRange = configSheet.getRange(2, targetCol, values.length, 1);
        const rule = SpreadsheetApp.newDataValidation()
          .requireValueInRange(configRange, true)
          .setAllowInvalid(!strictValidation)
          .build();

        range.setDataValidation(rule);
        Logger.log(`Set dropdown for ${name} (column ${colLetter}): ${values.length} options via range reference, strict=${strictValidation}`);
      } else {
        // Fallback: use text validation with help text
        const rule = SpreadsheetApp.newDataValidation()
          .requireTextContains('')
          .setAllowInvalid(true)
          .setHelpText(`Select a ${name}. ${values.length} options available.`)
          .build();
        range.setDataValidation(rule);
        Logger.log(`Set text validation for ${name} (column ${colLetter}): ${values.length} options (no dropdown due to limit)`);
      }
    } else {
      // Standard approach for <= 500 items
      const rule = SpreadsheetApp.newDataValidation()
        .requireValueInList(values, true)
        .setAllowInvalid(!strictValidation)
        .build();

      range.setDataValidation(rule);
      Logger.log(`Set dropdown for ${name} (column ${colLetter}): ${values.length} options, strict=${strictValidation}`);
    }
  } catch (error) {
    Logger.log(`Error setting dropdown for ${name}: ${error.message}`);
  }
}

/**
 * Sets date validation on a column
 * @param {Sheet} sheet - The sheet to apply validation to
 * @param {number} colNum - Column number (1-indexed)
 * @param {number} lastRow - Last row to apply validation
 * @param {string} name - Name for logging
 */
function setDateValidation(sheet, colNum, lastRow, name) {
  try {
    const colLetter = getColumnLetter(colNum);
    const range = sheet.getRange(`${colLetter}2:${colLetter}${lastRow}`);

    const rule = SpreadsheetApp.newDataValidation()
      .requireDate()
      .setAllowInvalid(false)
      .setHelpText('Please enter a valid date')
      .build();

    range.setDataValidation(rule);

    // Also set the number format to date
    range.setNumberFormat('MM/dd/yyyy');

    Logger.log(`Set date validation for ${name} (column ${colLetter})`);
  } catch (error) {
    Logger.log(`Error setting date validation for ${name}: ${error.message}`);
  }
}

/**
 * Gets list of stewards from Member Directory
 * @returns {Array} Array of steward names
 */
function getStewardsList() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (!memberSheet) return [];

  try {
    const lastRow = memberSheet.getLastRow();
    if (lastRow < 2) return [];

    // Get first name, last name, and is_steward columns
    const firstNameCol = MEMBER_COLS.FIRST_NAME;
    const lastNameCol = MEMBER_COLS.LAST_NAME;
    const isStewardCol = MEMBER_COLS.IS_STEWARD;

    const maxCol = Math.max(firstNameCol, lastNameCol, isStewardCol);
    const data = memberSheet.getRange(2, 1, lastRow - 1, maxCol).getValues();

    const stewards = data
      .filter(function(row) {
        const isSteward = row[isStewardCol - 1];
        return isSteward === 'Yes' || isSteward === 'Y' || isSteward === true;
      })
      .map(function(row) {
        const firstName = row[firstNameCol - 1] || '';
        const lastName = row[lastNameCol - 1] || '';
        return `${firstName} ${lastName}`.trim();
      })
      .filter(function(name) { return name !== '' && name !== ' '; });

    // Sort alphabetically
    stewards.sort();

    // Add "Other" option at the end
    if (stewards.length > 0) {
      stewards.push('Other');
    } else {
      return ['No stewards found', 'Other'];
    }

    return stewards;

  } catch (error) {
    Logger.log('Error getting stewards list: ' + error.message);
    return ['Error loading stewards', 'Other'];
  }
}

/**
 * Refreshes the steward dropdowns based on current steward list
 */
function refreshStewardDropdowns() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  const stewards = getStewardsList();

  if (stewards.length === 0) {
    SpreadsheetApp.getUi().alert('No stewards found in Member Directory!');
    return;
  }

  let updated = 0;

  // Update Member Directory steward dropdowns
  if (memberSheet) {
    const lastRow = Math.max(memberSheet.getLastRow(), 1000);

    // Assigned Steward
    setDropdownByCol(memberSheet, MEMBER_COLS.ASSIGNED_STEWARD, lastRow, stewards, 'Assigned Steward', true);
    updated++;

    // Contact Steward
    setDropdownByCol(memberSheet, MEMBER_COLS.CONTACT_STEWARD, lastRow, stewards, 'Contact Steward', true);
    updated++;
  }

  // Update Grievance Log steward dropdown
  if (grievanceSheet) {
    const lastRow = Math.max(grievanceSheet.getLastRow(), 500);
    setDropdownByCol(grievanceSheet, GRIEVANCE_COLS.STEWARD, lastRow, stewards, 'Grievance Steward', true);
    updated++;
  }

  SpreadsheetApp.getActiveSpreadsheet().toast(
    `Refreshed ${updated} steward dropdown(s) with ${stewards.length - 1} stewards`,
    'Steward Dropdowns Updated',
    3
  );
}

/**
 * Sets up all dropdowns for both Member Directory and Grievance Log
 */
function setupAllDropdowns() {
  setupMemberDirectoryDropdowns();
  setupGrievanceLogDropdowns();

  SpreadsheetApp.getUi().alert(
    'All Dropdowns Setup Complete',
    'Dropdowns have been configured for both Member Directory and Grievance Log sheets.',
    SpreadsheetApp.getUi().ButtonSet.OK
  );
}

/**
 * Silent version of setupMemberDirectoryDropdowns - no alerts
 * Used after seeding to re-apply dropdowns
 */
function setupMemberDirectoryDropdownsSilent() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
  const configSheet = ss.getSheetByName(SHEETS.CONFIG);

  if (!memberSheet || !configSheet) {
    Logger.log('Silent Member dropdown setup: Sheet not found');
    return;
  }

  try {
    const lastRow = Math.max(memberSheet.getLastRow(), 1000);

    // Job Title
    const jobTitles = getConfigValuesFromSheet(configSheet, CONFIG_COLS.JOB_TITLES);
    if (jobTitles.length > 0) setDropdownByCol(memberSheet, MEMBER_COLS.JOB_TITLE, lastRow, jobTitles, 'Job Title', true);

    // Work Location
    const locations = getConfigValuesFromSheet(configSheet, CONFIG_COLS.OFFICE_LOCATIONS);
    if (locations.length > 0) setDropdownByCol(memberSheet, MEMBER_COLS.WORK_LOCATION, lastRow, locations, 'Work Location', true);

    // Unit
    const units = getConfigValuesFromSheet(configSheet, CONFIG_COLS.UNITS);
    if (units.length > 0) setDropdownByCol(memberSheet, MEMBER_COLS.UNIT, lastRow, units, 'Unit', true);

    // Is Steward
    const yesNo = getConfigValuesFromSheet(configSheet, CONFIG_COLS.YES_NO);
    if (yesNo.length > 0) setDropdownByCol(memberSheet, MEMBER_COLS.IS_STEWARD, lastRow, yesNo, 'Is Steward', true);

    // Supervisor
    const supervisors = getConfigValuesFromSheet(configSheet, CONFIG_COLS.SUPERVISORS);
    if (supervisors.length > 0) setDropdownByCol(memberSheet, MEMBER_COLS.SUPERVISOR, lastRow, supervisors, 'Supervisor', true);

    // Manager
    const managers = getConfigValuesFromSheet(configSheet, CONFIG_COLS.MANAGERS);
    if (managers.length > 0) setDropdownByCol(memberSheet, MEMBER_COLS.MANAGER, lastRow, managers, 'Manager', true);

    // Assigned Steward
    const stewards = getStewardsList();
    if (stewards.length > 0) {
      setDropdownByCol(memberSheet, MEMBER_COLS.ASSIGNED_STEWARD, lastRow, stewards, 'Assigned Steward', true);
      setDropdownByCol(memberSheet, MEMBER_COLS.CONTACT_STEWARD, lastRow, stewards, 'Contact Steward', true);
    }

    // Office Days (multi-select)
    const officeDays = getConfigValuesFromSheet(configSheet, CONFIG_COLS.OFFICE_DAYS);
    if (officeDays.length > 0) setDropdownByCol(memberSheet, MEMBER_COLS.OFFICE_DAYS, lastRow, officeDays, 'Office Days', false);

    Logger.log('Silent Member Directory dropdown setup complete');

  } catch (error) {
    Logger.log('Error in silent member dropdown setup: ' + error.message);
  }
}

/**
 * Silent version of setupGrievanceLogDropdowns - no alerts
 * Used after seeding to re-apply dropdowns
 */
function setupGrievanceLogDropdownsSilent() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  const configSheet = ss.getSheetByName(SHEETS.CONFIG);

  if (!grievanceSheet || !configSheet) {
    Logger.log('Silent Grievance dropdown setup: Sheet not found');
    return;
  }

  try {
    const lastRow = Math.max(grievanceSheet.getLastRow(), 500);

    // Status
    const statuses = getConfigValuesFromSheet(configSheet, CONFIG_COLS.GRIEVANCE_STATUS);
    if (statuses.length > 0) setDropdownByCol(grievanceSheet, GRIEVANCE_COLS.STATUS, lastRow, statuses, 'Status', true);

    // Current Step
    const steps = getConfigValuesFromSheet(configSheet, CONFIG_COLS.GRIEVANCE_STEP);
    if (steps.length > 0) setDropdownByCol(grievanceSheet, GRIEVANCE_COLS.CURRENT_STEP, lastRow, steps, 'Current Step', true);

    // Articles Violated (multi-select)
    const articles = getConfigValuesFromSheet(configSheet, CONFIG_COLS.ARTICLES_VIOLATED);
    if (articles.length > 0) setDropdownByCol(grievanceSheet, GRIEVANCE_COLS.ARTICLES, lastRow, articles, 'Articles Violated', false);

    // Issue Category (multi-select)
    const categories = getConfigValuesFromSheet(configSheet, CONFIG_COLS.ISSUE_CATEGORY);
    if (categories.length > 0) setDropdownByCol(grievanceSheet, GRIEVANCE_COLS.ISSUE_CATEGORY, lastRow, categories, 'Issue Category', false);

    // Unit
    const units = getConfigValuesFromSheet(configSheet, CONFIG_COLS.UNITS);
    if (units.length > 0) setDropdownByCol(grievanceSheet, GRIEVANCE_COLS.UNIT, lastRow, units, 'Unit', true);

    // Work Location
    const locations = getConfigValuesFromSheet(configSheet, CONFIG_COLS.OFFICE_LOCATIONS);
    if (locations.length > 0) setDropdownByCol(grievanceSheet, GRIEVANCE_COLS.LOCATION, lastRow, locations, 'Work Location', true);

    // Assigned Steward
    const stewards = getStewardsList();
    if (stewards.length > 0) setDropdownByCol(grievanceSheet, GRIEVANCE_COLS.STEWARD, lastRow, stewards, 'Assigned Steward', true);

    Logger.log('Silent Grievance Log dropdown setup complete');

  } catch (error) {
    Logger.log('Error in silent grievance dropdown setup: ' + error.message);
  }
}



// ================================================================================
// MODULE: MemberDirectoryGoogleFormLink.gs
// Source: MemberDirectoryGoogleFormLink.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * MEMBER DIRECTORY GOOGLE FORM LINK
 * ------------------------------------------------------------------------====
 *
 * Adds a button/checkbox feature to link to a Google Form
 * that auto-populates with member information
 *
 * Features:
 * - Button in Member Directory to open Google Form
 * - Auto-populates form with member data
 * - Can be wired to specific use cases later
 * - Added to Pending Features tab for future implementation
 */

// Configuration for the member info Google Form
MEMBER_FORM_CONFIG = {
  // Replace with your actual Google Form URL
  FORM_URL: "https://docs.google.com/forms/d/e/YOUR_MEMBER_FORM_ID/viewform",

  // Form field entry IDs (found by inspecting your form)
  FIELD_IDS: {
    MEMBER_ID: "entry.2000000001",
    FIRST_NAME: "entry.2000000002",
    LAST_NAME: "entry.2000000003",
    EMAIL: "entry.2000000004",
    PHONE: "entry.2000000005",
    JOB_TITLE: "entry.2000000006",
    WORK_LOCATION: "entry.2000000007",
    UNIT: "entry.2000000008",
    IS_STEWARD: "entry.2000000009",
    ASSIGNED_STEWARD: "entry.2000000010"
  }
};

/**
 * Shows a dialog with a link to Google Form for selected member
 */
function openMemberGoogleForm() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const activeSheet = ss.getActiveSheet();

  if (activeSheet.getName() !== SHEETS.MEMBER_DIR) {
    ui.alert(
      '‚ö†Ô∏è Wrong Sheet',
      'Please select a member row in the Member Directory sheet.',
      ui.ButtonSet.OK
    );
    return;
  }

  const activeRow = activeSheet.getActiveCell().getRow();

  if (activeRow < 2) {
    ui.alert(
      '‚ö†Ô∏è Invalid Selection',
      'Please select a member row (not the header).',
      ui.ButtonSet.OK
    );
    return;
  }

  try {
    const memberData = getMemberDataFromRow(activeRow);

    if (!memberData.memberId) {
      ui.alert(
        '‚ö†Ô∏è No Member ID',
        'Selected row does not have a member ID.',
        ui.ButtonSet.OK
      );
      return;
    }

    const formUrl = generatePreFilledMemberForm(memberData);

    const html = createMemberFormDialog(memberData, formUrl);
    const htmlOutput = HtmlService.createHtmlOutput(html)
      .setWidth(600)
      .setHeight(400);

    ui.showModalDialog(htmlOutput, 'üìã Member Information Form');

  } catch (error) {
    ui.alert('‚ùå Error: ' + error.message);
    Logger.log('Error opening member form: ' + error);
  }
}

/**
 * Gets member data from a specific row
 * Uses MEMBER_COLS constants for correct column mapping
 * @param {number} row - Row number
 * @returns {Object} Member data object
 */
function getMemberDataFromRow(row) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (!memberSheet) {
    throw new Error('Member Directory not found');
  }

  // Get member data from row - read enough columns to cover ASSIGNED_STEWARD (col 16)
  const data = memberSheet.getRange(row, 1, 1, MEMBER_COLS.ASSIGNED_STEWARD).getValues()[0];

  // Use MEMBER_COLS constants for correct column mapping (subtract 1 for 0-based array index)
  return {
    memberId: data[MEMBER_COLS.MEMBER_ID - 1],          // A: Member ID
    firstName: data[MEMBER_COLS.FIRST_NAME - 1],        // B: First Name
    lastName: data[MEMBER_COLS.LAST_NAME - 1],          // C: Last Name
    jobTitle: data[MEMBER_COLS.JOB_TITLE - 1],          // D: Job Title
    workLocation: data[MEMBER_COLS.WORK_LOCATION - 1],  // E: Work Location
    unit: data[MEMBER_COLS.UNIT - 1],                   // F: Unit
    officeDays: data[MEMBER_COLS.OFFICE_DAYS - 1],      // G: Office Days
    email: data[MEMBER_COLS.EMAIL - 1],                 // H: Email
    phone: data[MEMBER_COLS.PHONE - 1],                 // I: Phone
    isSteward: data[MEMBER_COLS.IS_STEWARD - 1],        // N: Is Steward
    supervisor: data[MEMBER_COLS.SUPERVISOR - 1],       // L: Supervisor
    manager: data[MEMBER_COLS.MANAGER - 1],             // M: Manager
    assignedSteward: data[MEMBER_COLS.ASSIGNED_STEWARD - 1]  // P: Assigned Steward
  };
}

/**
 * Generates a pre-filled Google Form URL for a member
 * @param {Object} memberData - Member data object
 * @returns {string} Pre-filled form URL
 */
function generatePreFilledMemberForm(memberData) {
  const baseUrl = MEMBER_FORM_CONFIG.FORM_URL;
  const params = new URLSearchParams();

  // Add member information to form URL
  params.append(MEMBER_FORM_CONFIG.FIELD_IDS.MEMBER_ID, memberData.memberId || '');
  params.append(MEMBER_FORM_CONFIG.FIELD_IDS.FIRST_NAME, memberData.firstName || '');
  params.append(MEMBER_FORM_CONFIG.FIELD_IDS.LAST_NAME, memberData.lastName || '');
  params.append(MEMBER_FORM_CONFIG.FIELD_IDS.EMAIL, memberData.email || '');
  params.append(MEMBER_FORM_CONFIG.FIELD_IDS.PHONE, memberData.phone || '');
  params.append(MEMBER_FORM_CONFIG.FIELD_IDS.JOB_TITLE, memberData.jobTitle || '');
  params.append(MEMBER_FORM_CONFIG.FIELD_IDS.WORK_LOCATION, memberData.workLocation || '');
  params.append(MEMBER_FORM_CONFIG.FIELD_IDS.UNIT, memberData.unit || '');
  params.append(MEMBER_FORM_CONFIG.FIELD_IDS.IS_STEWARD, memberData.isSteward || '');
  params.append(MEMBER_FORM_CONFIG.FIELD_IDS.ASSIGNED_STEWARD, memberData.assignedSteward || '');

  return baseUrl + '?' + params.toString();
}

/**
 * Creates HTML dialog for member form access
 * @param {Object} memberData - Member data
 * @param {string} formUrl - Pre-filled form URL
 * @returns {string} HTML content
 */
function createMemberFormDialog(memberData, formUrl) {
  return `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 {
      color: #1a73e8;
      margin-top: 0;
      border-bottom: 3px solid #1a73e8;
      padding-bottom: 10px;
    }
    .info-box {
      background: #e8f0fe;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
      border-left: 4px solid #1a73e8;
    }
    .info-box strong {
      color: #1557b0;
    }
    .member-info {
      background: #fafafa;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
    }
    .member-info-item {
      margin: 8px 0;
      font-size: 14px;
    }
    .button {
      background: #1a73e8;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      text-decoration: none;
      display: inline-block;
      margin: 10px 5px;
    }
    .button:hover {
      background: #1557b0;
    }
    .button.secondary {
      background: #6b7280;
    }
    .button.secondary:hover {
      background: #4b5563;
    }
    .note {
      background: #fff3cd;
      padding: 12px;
      border-radius: 4px;
      margin: 15px 0;
      border-left: 4px solid #ffc107;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìã Member Information Form</h2>

    <div class="info-box">
      <strong>‚ÑπÔ∏è This feature is in development</strong><br>
      This button will open a Google Form with auto-populated member information.
      The form can be used for various purposes such as surveys, updates, or data collection.
    </div>

    <div class="member-info">
      <h3>Member Information:</h3>
      <div class="member-info-item"><strong>Name:</strong> ${memberData.firstName} ${memberData.lastName}</div>
      <div class="member-info-item"><strong>Member ID:</strong> ${memberData.memberId}</div>
      <div class="member-info-item"><strong>Email:</strong> ${memberData.email || 'Not provided'}</div>
      <div class="member-info-item"><strong>Work Location:</strong> ${memberData.workLocation || 'Not provided'}</div>
      <div class="member-info-item"><strong>Unit:</strong> ${memberData.unit || 'Not provided'}</div>
    </div>

    <div class="note">
      <strong>üìù Note:</strong> Before using this feature, you'll need to set up a Google Form and configure the MEMBER_FORM_CONFIG in the script.
      See the MemberDirectoryGoogleFormLink.gs file for configuration instructions.
    </div>

    <a href="${formUrl}" target="_blank" class="button">Open Form with Member Data</a>
    <button class="button secondary" onclick="google.script.host.close()">Close</button>
  </div>
</body>
</html>
  `;
}

/**
 * Adds a "pending feature" entry for the Member Google Form Link
 * This adds an entry to the Feedback & Development sheet
 */
function addMemberFormLinkToPendingFeatures() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const feedbackSheet = ss.getSheetByName(SHEETS.FEEDBACK);

  if (!feedbackSheet) {
    SpreadsheetApp.getUi().alert('‚ùå Feedback sheet not found!');
    return;
  }

  const today = new Date();
  const featureData = [
    'Future Feature',                          // Type
    today,                                     // Submitted/Started
    'System',                                  // Submitted By
    'Medium',                                  // Priority
    'Member Directory Google Form Link',       // Title
    'Add button/checkbox to Member Directory that opens a Google Form with auto-populated member information. ' +
    'Form can be used for surveys, data updates, or other member interactions. ' +
    'Requires Google Form setup and field ID configuration.',  // Description
    'Planned',                                 // Status
    '30%',                                     // Progress %
    'Moderate',                                // Complexity
    '',                                        // Target Completion
    '',                                        // Assigned To
    'Requires Google Form creation and configuration',  // Blockers
    'Feature placeholder created. Script functions ready. Needs form URL and field configuration.',  // Resolution/Notes
    today                                      // Last Updated
  ];

  feedbackSheet.appendRow(featureData);

  SpreadsheetApp.getActiveSpreadsheet().toast('‚úÖ Added to Pending Features!', '', 3);
}

/**
 * Adds the Grievance Float Toggle feature to pending features
 */
function addGrievanceFloatToPendingFeatures() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const feedbackSheet = ss.getSheetByName(SHEETS.FEEDBACK);

  if (!feedbackSheet) {
    SpreadsheetApp.getUi().alert('‚ùå Feedback sheet not found!');
    return;
  }

  const today = new Date();
  const featureData = [
    'Future Feature',                          // Type
    today,                                     // Submitted/Started
    'System',                                  // Submitted By
    'High',                                    // Priority
    'Grievance Float/Sort Toggle',             // Title
    'Toggle feature that sends closed/settled/inactive grievances to bottom. ' +
    'Prioritizes Step 3 > Step 2 > Step 1, then by soonest due date within each step. ' +
    'Helps users focus on active, high-priority grievances.',  // Description
    'Completed',                               // Status
    '100%',                                    // Progress %
    'Moderate',                                // Complexity
    today,                                     // Target Completion
    'System',                                  // Assigned To
    '',                                        // Blockers
    'Feature implemented in GrievanceFloatToggle.gs. Available via menu or control panel.',  // Resolution/Notes
    today                                      // Last Updated
  ];

  feedbackSheet.appendRow(featureData);

  SpreadsheetApp.getActiveSpreadsheet().toast('‚úÖ Added to Pending Features!', '', 3);
}



// ================================================================================
// MODULE: MemberSearch.gs
// Source: MemberSearch.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * MEMBER SEARCH & LOOKUP FUNCTIONALITY
 * ------------------------------------------------------------------------====
 *
 * Fast member search with autocomplete and filtering
 * Features:
 * - Search by name, ID, location, unit
 * - Fuzzy matching
 * - Quick navigation to member row
 * - Show member details
 */

/**
 * Shows member search dialog
 */
function showMemberSearch() {
  const html = HtmlService.createHtmlOutput(createMemberSearchHTML())
    .setWidth(700)
    .setHeight(600);

  SpreadsheetApp.getUi().showModalDialog(html, 'üîç Search Members');
}

/**
 * Creates HTML for member search dialog
 */
function createMemberSearchHTML() {
  return `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 {
      color: #1a73e8;
      margin-top: 0;
      border-bottom: 3px solid #1a73e8;
      padding-bottom: 10px;
    }
    .search-box {
      margin: 20px 0;
    }
    input[type="text"] {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #1a73e8;
    }
    .filters {
      display: flex;
      gap: 10px;
      margin: 15px 0;
    }
    select {
      flex: 1;
      padding: 8px;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .results {
      margin-top: 20px;
      max-height: 350px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .result-item {
      padding: 15px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.2s;
    }
    .result-item:hover {
      background: #f0f7ff;
    }
    .result-item:last-child {
      border-bottom: none;
    }
    .member-name {
      font-size: 16px;
      font-weight: bold;
      color: #1a73e8;
    }
    .member-details {
      font-size: 13px;
      color: #666;
      margin-top: 5px;
    }
    .member-id {
      display: inline-block;
      background: #e8f0fe;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 12px;
      margin-right: 8px;
    }
    .no-results {
      text-align: center;
      padding: 40px;
      color: #999;
      font-style: italic;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #1a73e8;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üîç Search Members</h2>

    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Search by name, ID, email..." autofocus>
    </div>

    <div class="filters">
      <select id="locationFilter">
        <option value="">All Locations</option>
      </select>
      <select id="unitFilter">
        <option value="">All Units</option>
      </select>
      <select id="stewardFilter">
        <option value="">All Members</option>
        <option value="Yes">Stewards Only</option>
        <option value="No">Non-Stewards Only</option>
      </select>
    </div>

    <div id="results" class="results">
      <div class="loading">Loading members...</div>
    </div>
  </div>

  <script>
    let allMembers = [];
    let filteredMembers = [];

    // Load members on page load
    window.onload = function() {
      google.script.run
        .withSuccessHandler(onMembersLoaded)
        .withFailureHandler(onError)
        .getAllMembers();
    };

    function onMembersLoaded(members) {
      allMembers = members;
      filteredMembers = members;

      // Populate filter dropdowns
      populateFilters();

      // Display all members initially
      displayResults(members);

      // Set up event listeners
      document.getElementById('searchInput').addEventListener('input', performSearch);
      document.getElementById('locationFilter').addEventListener('change', performSearch);
      document.getElementById('unitFilter').addEventListener('change', performSearch);
      document.getElementById('stewardFilter').addEventListener('change', performSearch);
    }

    function populateFilters() {
      // Get unique locations
      const locations = [...new Set(allMembers.map(function(m) { return m.location; }).filter(function(l) { return l; }))];
      const locationFilter = document.getElementById('locationFilter');
      locations.forEach(function(loc) {
        const option = document.createElement('option');
        option.value = loc;
        option.textContent = loc;
        locationFilter.appendChild(option);
      });

      // Get unique units
      const units = [...new Set(allMembers.map(function(m) { return m.unit; }).filter(function(u) { return u; }))];
      const unitFilter = document.getElementById('unitFilter');
      units.forEach(function(unit) {
        const option = document.createElement('option');
        option.value = unit;
        option.textContent = unit;
        unitFilter.appendChild(option);
      });
    }

    function performSearch() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const locationFilter = document.getElementById('locationFilter').value;
      const unitFilter = document.getElementById('unitFilter').value;
      const stewardFilter = document.getElementById('stewardFilter').value;

      filteredMembers = allMembers.filter(function(member) {
        // Text search
        const matchesSearch = !searchTerm ||
          member.name.toLowerCase().includes(searchTerm) ||
          member.id.toLowerCase().includes(searchTerm) ||
          (member.email && member.email.toLowerCase().includes(searchTerm));

        // Location filter
        const matchesLocation = !locationFilter || member.location === locationFilter;

        // Unit filter
        const matchesUnit = !unitFilter || member.unit === unitFilter;

        // Steward filter
        const matchesSteward = !stewardFilter || member.isSteward === stewardFilter;

        return matchesSearch && matchesLocation && matchesUnit && matchesSteward;
      });

      displayResults(filteredMembers);
    }

    function displayResults(members) {
      const resultsDiv = document.getElementById('results');

      if (members.length === 0) {
        resultsDiv.innerHTML = '<div class="no-results">No members found</div>';
        return;
      }

      resultsDiv.innerHTML = members.slice(0, 50).map(member => \`
        <div class="result-item" onclick="selectMember('\${member.row}', '\${member.id}')">
          <div class="member-name">\${member.name}</div>
          <div class="member-details">
            <span class="member-id">\${member.id}</span>
            <span>\${member.location || 'No location'} ‚Ä¢ \${member.unit || 'No unit'}</span>
            \${member.isSteward === 'Yes' ? ' ‚Ä¢ üõ°Ô∏è Steward' : ''}
          </div>
          \${member.email ? \`<div class="member-details">üìß \${member.email}</div>\` : ''}
        </div>
      \`).join('');

      if (members.length > 50) {
        resultsDiv.innerHTML += \`<div class="no-results">Showing first 50 of \${members.length} results. Refine your search.</div>\`;
      }
    }

    function selectMember(row, memberId) {
      google.script.run
        .withSuccessHandler(function() {
          google.script.host.close();
        })
        .navigateToMember(parseInt(row));
    }

    function onError(error) {
      document.getElementById('results').innerHTML =
        '<div class="no-results">‚ùå Error: ' + error.message + '</div>';
    }
  </script>
</body>
</html>
  `;
}

/**
 * Gets all members for search
 * @returns {Array} Array of member objects
 */
function getAllMembers() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (!memberSheet) return [];

  const lastRow = memberSheet.getLastRow();
  if (lastRow < 2) return [];

  const data = memberSheet.getRange(2, 1, lastRow - 1, MEMBER_COLS.ASSIGNED_STEWARD).getValues();

  return data.map(function(row, index) { return {
    row: index + 2,
    id: row[MEMBER_COLS.MEMBER_ID - 1] || '',
    name: `${row[MEMBER_COLS.FIRST_NAME - 1]} ${row[MEMBER_COLS.LAST_NAME - 1]}`.trim(),
    firstName: row[MEMBER_COLS.FIRST_NAME - 1] || '',
    lastName: row[MEMBER_COLS.LAST_NAME - 1] || '',
    jobTitle: row[MEMBER_COLS.JOB_TITLE - 1] || '',
    location: row[MEMBER_COLS.WORK_LOCATION - 1] || '',
    unit: row[MEMBER_COLS.UNIT - 1] || '',
    email: row[MEMBER_COLS.EMAIL - 1] || '',
    phone: row[MEMBER_COLS.PHONE - 1] || '',
    isSteward: row[MEMBER_COLS.IS_STEWARD - 1] || '',
    supervisor: row[MEMBER_COLS.SUPERVISOR - 1] || '',
    manager: row[MEMBER_COLS.MANAGER - 1] || '',
    assignedSteward: row[MEMBER_COLS.ASSIGNED_STEWARD - 1] || ''
  };}).filter(function(m) { return m.id; }); // Filter out empty rows
}

/**
 * Navigates to a member row in the Member Directory
 * @param {number} row - The row number to navigate to
 */
function navigateToMember(row) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (!memberSheet) return;

  // Activate the Member Directory sheet
  ss.setActiveSheet(memberSheet);

  // Navigate to the row
  memberSheet.setActiveRange(memberSheet.getRange(row, 1, 1, 10));

  // Show toast
  SpreadsheetApp.getActiveSpreadsheet().toast(
    `Navigated to row ${row}`,
    'Member Found',
    3
  );
}

/**
 * Quick search function for keyboard shortcut
 */
function quickMemberSearch() {
  showMemberSearch();
}



// ================================================================================
// MODULE: MobileOptimization.gs
// Source: MobileOptimization.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * MOBILE OPTIMIZATION
 * ------------------------------------------------------------------------====
 *
 * Mobile-friendly interfaces and responsive designs
 * Features:
 * - Touch-optimized UI
 * - Simplified mobile views
 * - Card-based layouts
 * - Mobile dashboard
 * - Quick actions
 * - Swipe gestures
 * - Offline data access
 */

/**
 * Mobile configuration
 */
const MOBILE_CONFIG = {
  MAX_COLUMNS_MOBILE: 8,  // Show max 8 columns on mobile
  CARD_LAYOUT_ENABLED: true,
  TOUCH_TARGET_SIZE: '44px',
  SIMPLIFIED_MODE: true,
  ENABLE_ANALYTICS: true  // Enable mobile vs desktop tracking
};

/* --------------------= MOBILE VS DESKTOP TRACKING --------------------= */

/**
 * @design Mobile vs Desktop User Tracking
 *
 * Device tracking is implemented via user-agent detection in HTML dialogs.
 * Each mobile-optimized view includes viewport meta tags and responsive CSS
 * that automatically adapts to the device type.
 *
 * Current implementation:
 * - User agents are logged via logDeviceAccess() when mobile UIs are accessed
 * - Device type detection occurs client-side via viewport width and user-agent string
 * - Mobile views are optimized with touch targets (44px minimum) and card-based layouts
 * - Analytics can be expanded by storing logs in Script Properties or a dedicated sheet
 *
 * Future enhancements could include:
 * - Persistent storage of device access logs in Script Properties
 * - Analytics dashboard showing mobile vs desktop usage percentages
 * - Device breakdown (iOS, Android, Windows, Mac) with peak usage times
 */

/**
 * Logs device access for analytics
 * @param {string} userAgent - Browser user agent string
 * @param {string} screenType - 'mobile' or 'desktop'
 */
function logDeviceAccess(userAgent, screenType) {
  /**
   * @design Device tracking implementation
   *
   * This function logs device access for basic analytics. Currently logs to console
   * for debugging purposes. Device type is determined by the screenType parameter
   * ('mobile' or 'desktop') passed from client-side user-agent detection.
   *
   * To enable persistent tracking, uncomment the Script Properties implementation below
   * to store the last 1000 access logs. This data can then be used by getDeviceAnalytics()
   * to generate usage statistics.
   */
  Logger.log('Device access: ' + screenType + ' - ' + userAgent);

  // Stub implementation: Store in Script Properties (currently disabled for performance)
  // Uncomment below to enable persistent device tracking:
  // const props = PropertiesService.getScriptProperties();
  // const accessLog = JSON.parse(props.getProperty('DEVICE_ACCESS_LOG') || '[]');
  // accessLog.push({ timestamp: new Date().toISOString(), type: screenType, userAgent: userAgent });
  // props.setProperty('DEVICE_ACCESS_LOG', JSON.stringify(accessLog.slice(-1000))); // Keep last 1000
}

/**
 * Gets device analytics summary
 * @returns {Object} Analytics summary (placeholder)
 */
function getDeviceAnalytics() {
  /**
   * @design Analytics are logged via PerformanceMonitoring.gs
   *
   * Device analytics are currently tracked at the logger level. Performance monitoring
   * captures user interactions across all interfaces including mobile views.
   *
   * To implement full device analytics:
   * 1. Enable persistent logging in logDeviceAccess() (see that function)
   * 2. Parse stored logs from Script Properties to calculate statistics
   * 3. Return actual counts and percentages based on logged data
   *
   * For now, this returns placeholder data indicating tracking is not yet enabled.
   */
  return {
    totalSessions: 0,
    mobileSessions: 0,
    desktopSessions: 0,
    mobilePercentage: 0,
    desktopPercentage: 0,
    message: 'Device tracking not yet implemented. Coming soon!'
  };
}

/**
 * Shows device analytics dashboard
 */
function showDeviceAnalyticsDashboard() {
  const analytics = getDeviceAnalytics();

  SpreadsheetApp.getUi().alert(
    'üìä Device Analytics',
    'Mobile vs Desktop Tracking\n\n' +
    analytics.message + '\n\n' +
    'This feature will track:\n' +
    '‚Ä¢ Total user sessions\n' +
    '‚Ä¢ Mobile vs Desktop percentage\n' +
    '‚Ä¢ Device type breakdown\n' +
    '‚Ä¢ Peak usage times',
    SpreadsheetApp.getUi().ButtonSet.OK
  );
}

/**
 * Shows mobile dashboard
 */
function showMobileDashboard() {
  const html = createMobileDashboardHTML();
  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(400)
    .setHeight(700);

  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'üì± Mobile Dashboard');
}

/**
 * Creates HTML for mobile dashboard
 */
function createMobileDashboardHTML() {
  const stats = getMobileDashboardStats();

  return `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      padding: 0;
      margin: 0;
      background: #f5f5f5;
      overflow-x: hidden;
    }
    .header {
      background: linear-gradient(135deg, #1a73e8 0%, #1557b0 100%);
      color: white;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .header h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 600;
    }
    .header .subtitle {
      margin-top: 5px;
      font-size: 14px;
      opacity: 0.9;
    }
    .container {
      padding: 15px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      text-align: center;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #1a73e8;
      margin-bottom: 5px;
    }
    .stat-label {
      font-size: 13px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .quick-actions {
      margin-bottom: 20px;
    }
    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin: 20px 0 12px 0;
      padding-left: 5px;
    }
    .action-button {
      background: white;
      border: none;
      padding: 16px;
      margin-bottom: 10px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      width: 100%;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 15px;
      font-size: 15px;
      color: #333;
      cursor: pointer;
      transition: all 0.2s;
      min-height: ${MOBILE_CONFIG.TOUCH_TARGET_SIZE};
    }
    .action-button:active {
      transform: scale(0.98);
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .action-icon {
      font-size: 24px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #e8f0fe;
      border-radius: 10px;
    }
    .action-text {
      flex: 1;
    }
    .action-label {
      font-weight: 500;
      margin-bottom: 3px;
    }
    .action-description {
      font-size: 12px;
      color: #666;
    }
    .recent-card {
      background: white;
      padding: 15px;
      margin-bottom: 12px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .recent-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .recent-id {
      font-weight: bold;
      color: #1a73e8;
      font-size: 15px;
    }
    .status-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
    }
    .status-filed { background: #e8f5e9; color: #2e7d32; }
    .status-pending { background: #fff3e0; color: #ef6c00; }
    .status-resolved { background: #e3f2fd; color: #1565c0; }
    .recent-detail {
      font-size: 13px;
      color: #666;
      margin: 5px 0;
      display: flex;
      gap: 8px;
    }
    .recent-detail-label {
      font-weight: 500;
      min-width: 80px;
    }
    .swipe-hint {
      text-align: center;
      padding: 10px;
      color: #999;
      font-size: 12px;
    }
    .fab {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 56px;
      height: 56px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      cursor: pointer;
      z-index: 1000;
    }
    .fab:active {
      transform: scale(0.95);
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .refresh-indicator {
      text-align: center;
      padding: 10px;
      background: #4caf50;
      color: white;
      border-radius: 8px;
      margin-bottom: 15px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üì± 509 Dashboard</h1>
    <div class="subtitle">Mobile Optimized View</div>
  </div>

  <div class="container">
    <div id="refreshIndicator" class="refresh-indicator">
      ‚úÖ Refreshed!
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value">${stats.totalGrievances}</div>
        <div class="stat-label">Total</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${stats.activeGrievances}</div>
        <div class="stat-label">Active</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${stats.pendingGrievances}</div>
        <div class="stat-label">Pending</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${stats.overdueGrievances}</div>
        <div class="stat-label">Overdue</div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="section-title">‚ö° Quick Actions</div>
    <div class="quick-actions">
      <button class="action-button" onclick="quickNewGrievance()">
        <div class="action-icon">‚ûï</div>
        <div class="action-text">
          <div class="action-label">New Grievance</div>
          <div class="action-description">File a new case</div>
        </div>
      </button>

      <button class="action-button" onclick="quickSearch()">
        <div class="action-icon">üîç</div>
        <div class="action-text">
          <div class="action-label">Search</div>
          <div class="action-description">Find grievances or members</div>
        </div>
      </button>

      <button class="action-button" onclick="viewMyCases()">
        <div class="action-icon">üìã</div>
        <div class="action-text">
          <div class="action-label">My Cases</div>
          <div class="action-description">View assigned grievances</div>
        </div>
      </button>

      <button class="action-button" onclick="viewReports()">
        <div class="action-icon">üìä</div>
        <div class="action-text">
          <div class="action-label">Reports</div>
          <div class="action-description">Analytics and insights</div>
        </div>
      </button>
    </div>

    <!-- Recent Grievances -->
    <div class="section-title">üìù Recent Grievances</div>
    <div id="recentGrievances">
      <div class="loading">Loading recent cases...</div>
    </div>

    <div class="swipe-hint">‚¨ÖÔ∏è Swipe cards for more options</div>
  </div>

  <!-- Floating Action Button -->
  <button class="fab" onclick="refreshDashboard()" title="Refresh">
    üîÑ
  </button>

  <script>
    // Load recent grievances
    loadRecentGrievances();

    function loadRecentGrievances() {
      google.script.run
        .withSuccessHandler(renderRecentGrievances)
        .withFailureHandler(handleError)
        .getRecentGrievancesForMobile(5);
    }

    function renderRecentGrievances(grievances) {
      const container = document.getElementById('recentGrievances');

      if (!grievances || grievances.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">No recent grievances</div>';
        return;
      }

      let html = '';
      grievances.forEach(function(g) {
        const statusClass = 'status-' + (g.status || 'filed').toLowerCase().replace(/\s+/g, '-');
        html += \`
          <div class="recent-card" onclick="viewGrievanceDetail('\${g.id}')">
            <div class="recent-header">
              <div class="recent-id">#\${g.id}</div>
              <div class="status-badge \${statusClass}">\${g.status || 'Filed'}</div>
            </div>
            <div class="recent-detail">
              <span class="recent-detail-label">Member:</span>
              <span>\${g.memberName || 'N/A'}</span>
            </div>
            <div class="recent-detail">
              <span class="recent-detail-label">Issue:</span>
              <span>\${g.issueType || 'N/A'}</span>
            </div>
            <div class="recent-detail">
              <span class="recent-detail-label">Filed:</span>
              <span>\${g.filedDate || 'N/A'}</span>
            </div>
            ${g.deadline ? `
            <div class="recent-detail">
              <span class="recent-detail-label">Deadline:</span>
              <span>\${g.deadline}</span>
            </div>
            ` : ''}
          </div>
        \`;
      });

      container.innerHTML = html;

      // Add swipe gesture support
      addSwipeSupport();
    }

    function addSwipeSupport() {
      const cards = document.querySelectorAll('.recent-card');
      cards.forEach(function(card) {
        let startX = 0;
        let currentX = 0;

        card.addEventListenerfunction('touchstart', (e) {
          startX = e.touches[0].clientX;
        });

        card.addEventListenerfunction('touchmove', (e) {
          currentX = e.touches[0].clientX;
          const diff = currentX - startX;
          if (Math.abs(diff) > 10) {
            card.style.transform = \`translateX(\${diff}px)\`;
          }
        });

        card.addEventListenerfunction('touchend', () {
          const diff = currentX - startX;
          if (Math.abs(diff) > 100) {
            // Swipe action
            card.style.opacity = '0.5';
            setTimeout(function() { return card.style.display = 'none', 200; });
          } else {
            card.style.transform = '';
          }
        });
      });
    }

    function quickNewGrievance() {
      google.script.run.showNewGrievanceForm();
    }

    function quickSearch() {
      google.script.run.showMemberSearch();
    }

    function viewMyCases() {
      google.script.run.showMyAssignedGrievances();
    }

    function viewReports() {
      google.script.run.showDashboard();
    }

    function viewGrievanceDetail(id) {
      google.script.run.showGrievanceDetail(id);
    }

    function refreshDashboard() {
      const indicator = document.getElementById('refreshIndicator');
      indicator.style.display = 'block';

      loadRecentGrievances();

      setTimeout(function() {
        indicator.style.display = 'none';
      }, 2000);
    }

    function handleError(error) {
      alert('Error: ' + error.message);
    }

    // Pull-to-refresh
    let touchStartY = 0;
    document.addEventListenerfunction('touchstart', (e) {
      touchStartY = e.touches[0].clientY;
    });

    document.addEventListenerfunction('touchmove', (e) {
      const touchY = e.touches[0].clientY;
      if (touchY - touchStartY > 150 && window.scrollY === 0) {
        refreshDashboard();
      }
    });
  </script>
</body>
</html>
  `;
}

/**
 * Gets mobile dashboard statistics
 * @returns {Object} Statistics
 */
function getMobileDashboardStats() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!grievanceSheet || grievanceSheet.getLastRow() <= 1) {
    return {
      totalGrievances: 0,
      activeGrievances: 0,
      pendingGrievances: 0,
      overdueGrievances: 0
    };
  }

  const data = grievanceSheet.getRange(2, 1, grievanceSheet.getLastRow() - 1, 28).getValues();

  const stats = {
    totalGrievances: data.length,
    activeGrievances: 0,
    pendingGrievances: 0,
    overdueGrievances: 0
  };

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  data.forEach(function(row) {
    const status = row[GRIEVANCE_COLS.STATUS - 1];
    const deadline = row[GRIEVANCE_COLS.DEADLINE - 1];

    if (status && status !== 'Resolved' && status !== 'Withdrawn') {
      stats.activeGrievances++;
    }

    if (status === 'Pending') {
      stats.pendingGrievances++;
    }

    if (deadline instanceof Date) {
      deadline.setHours(0, 0, 0, 0);
      if (deadline < today && status !== 'Resolved') {
        stats.overdueGrievances++;
      }
    }
  });

  return stats;
}

/**
 * Gets recent grievances for mobile view
 * @param {number} limit - Number of grievances to return
 * @returns {Array} Recent grievances
 */
function getRecentGrievancesForMobile(limit = 5) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!grievanceSheet || grievanceSheet.getLastRow() <= 1) {
    return [];
  }

  const data = grievanceSheet.getRange(2, 1, grievanceSheet.getLastRow() - 1, 28).getValues();

  // Get most recent grievances
  const grievances = data
    .map(function(row, index) {
      const filedDate = row[GRIEVANCE_COLS.FILED_DATE - 1];
      return {
        id: row[GRIEVANCE_COLS.GRIEVANCE_ID - 1],
        memberName: row[GRIEVANCE_COLS.MEMBER_NAME - 1],
        issueType: row[GRIEVANCE_COLS.ISSUE_TYPE - 1],
        status: row[GRIEVANCE_COLS.STATUS - 1],
        filedDate: filedDate instanceof Date ? Utilities.formatDate(filedDate, Session.getScriptTimeZone(), 'MMM d, yyyy') : filedDate,
        deadline: row[GRIEVANCE_COLS.DEADLINE - 1] instanceof Date ? Utilities.formatDate(row[GRIEVANCE_COLS.DEADLINE - 1], Session.getScriptTimeZone(), 'MMM d, yyyy') : null,
        rowIndex: index + 2,
        filedDateObj: filedDate
      };
    })
    .sort(function(a, b) {
      const dateA = a.filedDateObj instanceof Date ? a.filedDateObj : new Date(0);
      const dateB = b.filedDateObj instanceof Date ? b.filedDateObj : new Date(0);
      return dateB - dateA;
    })
    .slice(0, limit);

  return grievances;
}

/**
 * Shows mobile-optimized grievance list
 */
function showMobileGrievanceList() {
  const html = createMobileGrievanceListHTML();
  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(400)
    .setHeight(700);

  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'üìã Grievance List');
}

/**
 * Creates HTML for mobile grievance list
 */
function createMobileGrievanceListHTML() {
  return `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }
    .header {
      background: #1a73e8;
      color: white;
      padding: 15px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .search-box {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      margin-top: 10px;
    }
    .filter-tabs {
      display: flex;
      overflow-x: auto;
      padding: 10px;
      background: white;
      border-bottom: 1px solid #e0e0e0;
      gap: 10px;
    }
    .filter-tab {
      padding: 8px 16px;
      border-radius: 20px;
      background: #f0f0f0;
      white-space: nowrap;
      cursor: pointer;
      font-size: 14px;
    }
    .filter-tab.active {
      background: #1a73e8;
      color: white;
    }
    .list-container {
      padding: 10px;
    }
    .grievance-card {
      background: white;
      margin-bottom: 12px;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .card-id {
      font-weight: bold;
      color: #1a73e8;
    }
    .card-status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }
    .card-row {
      font-size: 14px;
      margin: 5px 0;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2 style="margin: 0;">Grievances</h2>
    <input type="text" class="search-box" placeholder="Search..." oninput="filterList(this.value)">
  </div>

  <div class="filter-tabs">
    <div class="filter-tab active" onclick="filterByStatus('all')">All</div>
    <div class="filter-tab" onclick="filterByStatus('Active')">Active</div>
    <div class="filter-tab" onclick="filterByStatus('Pending')">Pending</div>
    <div class="filter-tab" onclick="filterByStatus('Resolved')">Resolved</div>
  </div>

  <div class="list-container" id="listContainer">
    <div style="text-align: center; padding: 40px; color: #666;">Loading...</div>
  </div>

  <script>
    let allGrievances = [];

    // Load data
    google.script.run
      .withSuccessHandler(loadGrievances)
      .getRecentGrievancesForMobile(100);

    function loadGrievances(data) {
      allGrievances = data;
      renderGrievances(data);
    }

    function renderGrievances(grievances) {
      const container = document.getElementById('listContainer');

      if (grievances.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">No grievances found</div>';
        return;
      }

      let html = '';
      grievances.forEach(function(g) {
        html += \`
          <div class="grievance-card">
            <div class="card-header">
              <div class="card-id">#\${g.id}</div>
              <div class="card-status">\${g.status}</div>
            </div>
            <div class="card-row"><strong>Member:</strong> \${g.memberName}</div>
            <div class="card-row"><strong>Issue:</strong> \${g.issueType}</div>
            <div class="card-row"><strong>Filed:</strong> \${g.filedDate}</div>
          </div>
        \`;
      });

      container.innerHTML = html;
    }

    function filterByStatus(status) {
      // Update active tab
      document.querySelectorAll('.filter-tab').forEach(function(tab) { return tab.classList.remove('active'); });
      event.target.classList.add('active');

      // Filter grievances
      const filtered = status === 'all'
        ? allGrievances
        : allGrievances.filter(function(g) { return g.status === status; });

      renderGrievances(filtered);
    }

    function filterList(searchTerm) {
      const filtered = allGrievances.filter(function(g) {
        return g.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
               g.memberName.toLowerCase().includes(searchTerm.toLowerCase()) ||
               g.issueType.toLowerCase().includes(searchTerm.toLowerCase());
      });

      renderGrievances(filtered);
    }
  </script>
</body>
</html>
  `;
}

/**
 * Shows grievance detail in mobile view
 * @param {string} grievanceId - Grievance ID
 */
function showGrievanceDetail(grievanceId) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!grievanceSheet) return;

  const data = grievanceSheet.getDataRange().getValues();
  const grievanceRow = data.find(function(row) { return row[GRIEVANCE_COLS.GRIEVANCE_ID - 1] === grievanceId; });

  if (!grievanceRow) {
    SpreadsheetApp.getUi().alert('Grievance not found');
    return;
  }

  // Show detail dialog
  const message = `
Grievance #${grievanceId}

Member: ${grievanceRow[GRIEVANCE_COLS.MEMBER_NAME - 1]}
Issue: ${grievanceRow[GRIEVANCE_COLS.ISSUE_TYPE - 1]}
Status: ${grievanceRow[GRIEVANCE_COLS.STATUS - 1]}
Filed: ${grievanceRow[GRIEVANCE_COLS.FILED_DATE - 1]}
Assigned: ${grievanceRow[GRIEVANCE_COLS.ASSIGNED_STEWARD - 1]}

Description:
${grievanceRow[GRIEVANCE_COLS.DESCRIPTION - 1]}
  `.trim();

  SpreadsheetApp.getUi().alert('Grievance Detail', message, SpreadsheetApp.getUi().ButtonSet.OK);
}

/**
 * Shows my assigned grievances
 */
function showMyAssignedGrievances() {
  const userEmail = Session.getActiveUser().getEmail();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!grievanceSheet || grievanceSheet.getLastRow() <= 1) {
    SpreadsheetApp.getUi().alert('No grievances found');
    return;
  }

  const data = grievanceSheet.getRange(2, 1, grievanceSheet.getLastRow() - 1, 28).getValues();

  const myGrievances = data.filter(function(row) {
    const assignedSteward = row[GRIEVANCE_COLS.ASSIGNED_STEWARD - 1];
    return assignedSteward && assignedSteward.includes(userEmail);
  });

  if (myGrievances.length === 0) {
    SpreadsheetApp.getUi().alert('No grievances assigned to you');
    return;
  }

  let message = `You have ${myGrievances.length} assigned grievance(s):\n\n`;

  myGrievances.slice(0, 10).forEach(function(row) {
    message += `#${row[GRIEVANCE_COLS.GRIEVANCE_ID - 1]} - ${row[GRIEVANCE_COLS.MEMBER_NAME - 1]} (${row[GRIEVANCE_COLS.STATUS - 1]})\n`;
  });

  if (myGrievances.length > 10) {
    message += `\n... and ${myGrievances.length - 10} more`;
  }

  SpreadsheetApp.getUi().alert('My Cases', message, SpreadsheetApp.getUi().ButtonSet.OK);
}

/**
 * Shows unified mobile search for members and grievances
 */
function showMobileUnifiedSearch() {
  const html = createMobileUnifiedSearchHTML();
  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(420)
    .setHeight(700);

  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'üîç Search');
}

/**
 * Creates HTML for unified mobile search
 */
function createMobileUnifiedSearchHTML() {
  return `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }
    .header {
      background: linear-gradient(135deg, #1a73e8 0%, #1557b0 100%);
      color: white;
      padding: 15px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header h2 {
      margin: 0 0 12px 0;
      font-size: 20px;
    }
    .search-container {
      position: relative;
    }
    .search-input {
      width: 100%;
      padding: 14px 14px 14px 45px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      background: white;
      outline: none;
    }
    .search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 18px;
    }
    .tabs {
      display: flex;
      background: white;
      border-bottom: 1px solid #e0e0e0;
    }
    .tab {
      flex: 1;
      padding: 14px;
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      color: #666;
      border: none;
      background: none;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      min-height: 48px;
    }
    .tab.active {
      color: #1a73e8;
      border-bottom-color: #1a73e8;
    }
    .filters {
      display: flex;
      gap: 8px;
      padding: 12px;
      background: white;
      border-bottom: 1px solid #e0e0e0;
      overflow-x: auto;
    }
    .filter-chip {
      padding: 8px 16px;
      border-radius: 20px;
      background: #f0f0f0;
      border: none;
      font-size: 13px;
      white-space: nowrap;
      cursor: pointer;
      min-height: 36px;
    }
    .filter-chip.active {
      background: #1a73e8;
      color: white;
    }
    .results {
      padding: 12px;
      min-height: 300px;
    }
    .result-card {
      background: white;
      padding: 16px;
      margin-bottom: 12px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .result-card:active {
      transform: scale(0.98);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: #1a73e8;
    }
    .card-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
    }
    .badge-steward { background: #e8f5e9; color: #2e7d32; }
    .badge-open { background: #ffebee; color: #c62828; }
    .badge-pending { background: #fff3e0; color: #ef6c00; }
    .badge-settled { background: #e8f5e9; color: #2e7d32; }
    .badge-closed { background: #e0e0e0; color: #616161; }
    .card-row {
      font-size: 14px;
      color: #666;
      margin: 6px 0;
      display: flex;
      gap: 8px;
    }
    .card-row-label {
      color: #999;
      min-width: 70px;
    }
    .card-row-value {
      flex: 1;
      color: #333;
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #1a73e8;
    }
    .count-badge {
      background: #e8f0fe;
      color: #1a73e8;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 12px;
      margin-left: 6px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2>üîç Quick Search</h2>
    <div class="search-container">
      <span class="search-icon">üîé</span>
      <input type="text" class="search-input" id="searchInput"
             placeholder="Search members or grievances..." autofocus>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" id="tabMembers" onclick="switchTab('members')">
      üë• Members <span class="count-badge" id="memberCount">0</span>
    </button>
    <button class="tab" id="tabGrievances" onclick="switchTab('grievances')">
      üìã Grievances <span class="count-badge" id="grievanceCount">0</span>
    </button>
  </div>

  <div class="filters" id="filtersContainer">
    <button class="filter-chip active" onclick="filterResults('all')">All</button>
  </div>

  <div class="results" id="resultsContainer">
    <div class="loading">Loading data...</div>
  </div>

  <script>
    let allMembers = [];
    let allGrievances = [];
    let currentTab = 'members';
    let currentFilter = 'all';

    // Load data on page load
    window.onload = function() {
      loadAllData();
      document.getElementById('searchInput').addEventListener('input', performSearch);
    };

    function loadAllData() {
      google.script.run
        .withSuccessHandler(function(data) {
          allMembers = data.members || [];
          allGrievances = data.grievances || [];
          document.getElementById('memberCount').textContent = allMembers.length;
          document.getElementById('grievanceCount').textContent = allGrievances.length;
          updateFilters();
          performSearch();
        })
        .withFailureHandler(function(error) {
          document.getElementById('resultsContainer').innerHTML =
            '<div class="empty-state"><div class="empty-icon">‚ùå</div>Error loading data</div>';
        })
        .getMobileSearchData();
    }

    function switchTab(tab) {
      currentTab = tab;
      currentFilter = 'all';

      document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
      document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');

      updateFilters();
      performSearch();
    }

    function updateFilters() {
      const container = document.getElementById('filtersContainer');
      let filters = ['all'];

      if (currentTab === 'members') {
        const locations = [...new Set(allMembers.map(function(m) { return m.location; }).filter(Boolean))];
        filters = filters.concat(locations.slice(0, 5));
      } else {
        filters = ['all', 'Open', 'Pending', 'Settled', 'Closed'];
      }

      container.innerHTML = filters.map(function(f) {
        const isActive = f === currentFilter ? 'active' : '';
        const label = f === 'all' ? 'All' : f;
        return '<button class="filter-chip ' + isActive + '" onclick="filterResults(\\'' + f + '\\')">' + label + '</button>';
      }).join('');
    }

    function filterResults(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-chip').forEach(function(c) { c.classList.remove('active'); });
      event.target.classList.add('active');
      performSearch();
    }

    function performSearch() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      let results = [];

      if (currentTab === 'members') {
        results = allMembers.filter(function(m) {
          const matchesSearch = !searchTerm ||
            m.name.toLowerCase().includes(searchTerm) ||
            (m.id && m.id.toLowerCase().includes(searchTerm)) ||
            (m.email && m.email.toLowerCase().includes(searchTerm)) ||
            (m.location && m.location.toLowerCase().includes(searchTerm));

          const matchesFilter = currentFilter === 'all' || m.location === currentFilter;

          return matchesSearch && matchesFilter;
        });
        renderMembers(results);
      } else {
        results = allGrievances.filter(function(g) {
          const matchesSearch = !searchTerm ||
            g.id.toLowerCase().includes(searchTerm) ||
            g.memberName.toLowerCase().includes(searchTerm) ||
            (g.issueType && g.issueType.toLowerCase().includes(searchTerm));

          const matchesFilter = currentFilter === 'all' || g.status === currentFilter;

          return matchesSearch && matchesFilter;
        });
        renderGrievances(results);
      }
    }

    function renderMembers(members) {
      const container = document.getElementById('resultsContainer');

      if (members.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üë•</div>No members found</div>';
        return;
      }

      container.innerHTML = members.slice(0, 50).map(function(m) {
        const badge = m.isSteward === 'Yes' ? '<span class="card-badge badge-steward">üõ°Ô∏è Steward</span>' : '';
        return '<div class="result-card" onclick="selectMember(' + m.row + ')">' +
          '<div class="card-header">' +
            '<div class="card-title">' + m.name + '</div>' +
            badge +
          '</div>' +
          '<div class="card-row"><span class="card-row-label">ID</span><span class="card-row-value">' + (m.id || 'N/A') + '</span></div>' +
          '<div class="card-row"><span class="card-row-label">Location</span><span class="card-row-value">' + (m.location || 'N/A') + '</span></div>' +
          '<div class="card-row"><span class="card-row-label">Email</span><span class="card-row-value">' + (m.email || 'N/A') + '</span></div>' +
        '</div>';
      }).join('');

      if (members.length > 50) {
        container.innerHTML += '<div class="empty-state">Showing 50 of ' + members.length + ' results</div>';
      }
    }

    function renderGrievances(grievances) {
      const container = document.getElementById('resultsContainer');

      if (grievances.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìã</div>No grievances found</div>';
        return;
      }

      container.innerHTML = grievances.slice(0, 50).map(function(g) {
        const statusClass = 'badge-' + (g.status || 'open').toLowerCase().replace(/\\s+/g, '-');
        return '<div class="result-card" onclick="selectGrievance(\\'' + g.id + '\\')">' +
          '<div class="card-header">' +
            '<div class="card-title">#' + g.id + '</div>' +
            '<span class="card-badge ' + statusClass + '">' + (g.status || 'Open') + '</span>' +
          '</div>' +
          '<div class="card-row"><span class="card-row-label">Member</span><span class="card-row-value">' + (g.memberName || 'N/A') + '</span></div>' +
          '<div class="card-row"><span class="card-row-label">Issue</span><span class="card-row-value">' + (g.issueType || 'N/A') + '</span></div>' +
          '<div class="card-row"><span class="card-row-label">Filed</span><span class="card-row-value">' + (g.filedDate || 'N/A') + '</span></div>' +
        '</div>';
      }).join('');

      if (grievances.length > 50) {
        container.innerHTML += '<div class="empty-state">Showing 50 of ' + grievances.length + ' results</div>';
      }
    }

    function selectMember(row) {
      google.script.run
        .withSuccessHandler(function() { google.script.host.close(); })
        .navigateToMember(row);
    }

    function selectGrievance(id) {
      google.script.run
        .withSuccessHandler(function() { google.script.host.close(); })
        .navigateToGrievance(id);
    }
  </script>
</body>
</html>
  `;
}

/**
 * Gets data for mobile search (members and grievances)
 * @returns {Object} Object with members and grievances arrays
 */
function getMobileSearchData() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const result = { members: [], grievances: [] };

  // Get members
  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
  if (memberSheet && memberSheet.getLastRow() > 1) {
    const memberData = memberSheet.getRange(2, 1, memberSheet.getLastRow() - 1, 13).getValues();
    result.members = memberData.map(function(row, index) {
      return {
        row: index + 2,
        id: row[MEMBER_COLS.MEMBER_ID - 1] || '',
        name: ((row[MEMBER_COLS.FIRST_NAME - 1] || '') + ' ' + (row[MEMBER_COLS.LAST_NAME - 1] || '')).trim(),
        location: row[MEMBER_COLS.WORK_LOCATION - 1] || '',
        unit: row[MEMBER_COLS.UNIT - 1] || '',
        email: row[MEMBER_COLS.EMAIL - 1] || '',
        isSteward: row[MEMBER_COLS.IS_STEWARD - 1] || ''
      };
    }).filter(function(m) { return m.id || m.name; });
  }

  // Get grievances
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  if (grievanceSheet && grievanceSheet.getLastRow() > 1) {
    const grievanceData = grievanceSheet.getRange(2, 1, grievanceSheet.getLastRow() - 1, 28).getValues();
    result.grievances = grievanceData.map(function(row, index) {
      const filedDate = row[GRIEVANCE_COLS.DATE_FILED - 1];
      return {
        row: index + 2,
        id: row[GRIEVANCE_COLS.GRIEVANCE_ID - 1] || '',
        memberName: ((row[GRIEVANCE_COLS.FIRST_NAME - 1] || '') + ' ' + (row[GRIEVANCE_COLS.LAST_NAME - 1] || '')).trim(),
        status: row[GRIEVANCE_COLS.STATUS - 1] || '',
        issueType: row[GRIEVANCE_COLS.ISSUE_CATEGORY - 1] || '',
        filedDate: filedDate instanceof Date ? Utilities.formatDate(filedDate, Session.getScriptTimeZone(), 'MMM d, yyyy') : ''
      };
    }).filter(function(g) { return g.id; });
  }

  return result;
}

/**
 * Navigates to a grievance row in the Grievance Log
 * @param {string} grievanceId - The grievance ID to navigate to
 */
function navigateToGrievance(grievanceId) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!grievanceSheet) return;

  const data = grievanceSheet.getDataRange().getValues();

  for (let i = 1; i < data.length; i++) {
    if (data[i][GRIEVANCE_COLS.GRIEVANCE_ID - 1] === grievanceId) {
      ss.setActiveSheet(grievanceSheet);
      grievanceSheet.setActiveRange(grievanceSheet.getRange(i + 1, 1, 1, 10));
      SpreadsheetApp.getActiveSpreadsheet().toast(
        'Navigated to grievance #' + grievanceId,
        'Grievance Found',
        3
      );
      return;
    }
  }

  SpreadsheetApp.getActiveSpreadsheet().toast('Grievance not found', 'Not Found', 3);
}

/**
 * Mobile member directory browser with large touch targets
 */
function showMobileMemberBrowser() {
  const html = createMobileMemberBrowserHTML();
  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(420)
    .setHeight(700);

  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'üë• Member Directory');
}

/**
 * Creates HTML for mobile member browser
 */
function createMobileMemberBrowserHTML() {
  return `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      margin: 0; padding: 0; background: #f5f5f5;
    }
    .header {
      background: #1a73e8; color: white; padding: 15px;
      position: sticky; top: 0; z-index: 100;
    }
    .search-box {
      width: 100%; padding: 14px; border: none; border-radius: 8px;
      font-size: 16px; margin-top: 10px;
    }
    .alphabet-bar {
      display: flex; flex-wrap: wrap; padding: 8px;
      background: white; border-bottom: 1px solid #e0e0e0; gap: 4px;
    }
    .letter-btn {
      width: 32px; height: 32px; border: none; border-radius: 50%;
      background: #f0f0f0; font-size: 12px; font-weight: bold;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
    }
    .letter-btn.active { background: #1a73e8; color: white; }
    .list { padding: 10px; }
    .member-card {
      background: white; padding: 16px; margin-bottom: 10px;
      border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      display: flex; gap: 12px; align-items: center; min-height: 70px;
    }
    .avatar {
      width: 50px; height: 50px; border-radius: 50%;
      background: #e8f0fe; display: flex; align-items: center;
      justify-content: center; font-size: 20px; font-weight: bold; color: #1a73e8;
    }
    .member-info { flex: 1; }
    .member-name { font-weight: 600; font-size: 16px; color: #333; }
    .member-detail { font-size: 13px; color: #666; margin-top: 4px; }
    .steward-badge {
      background: #e8f5e9; color: #2e7d32; padding: 2px 8px;
      border-radius: 10px; font-size: 11px; font-weight: bold;
    }
    .empty { text-align: center; padding: 40px; color: #999; }
  </style>
</head>
<body>
  <div class="header">
    <h2 style="margin: 0; font-size: 18px;">üë• Member Directory</h2>
    <input type="text" class="search-box" id="searchInput" placeholder="Search by name...">
  </div>

  <div class="alphabet-bar" id="alphabetBar"></div>
  <div class="list" id="memberList"><div class="empty">Loading...</div></div>

  <script>
    let allMembers = [];
    let currentLetter = 'all';

    window.onload = function() {
      buildAlphabetBar();
      google.script.run.withSuccessHandler(loadMembers).getAllMembers();
      document.getElementById('searchInput').addEventListener('input', filterMembers);
    };

    function buildAlphabetBar() {
      const bar = document.getElementById('alphabetBar');
      const letters = ['All'].concat('ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split(''));
      bar.innerHTML = letters.map(function(l) {
        const key = l === 'All' ? 'all' : l;
        return '<button class="letter-btn' + (key === 'all' ? ' active' : '') + '" onclick="filterByLetter(\\'' + key + '\\')">' + l + '</button>';
      }).join('');
    }

    function loadMembers(members) {
      allMembers = members;
      renderMembers(members);
    }

    function filterByLetter(letter) {
      currentLetter = letter;
      document.querySelectorAll('.letter-btn').forEach(function(b) { b.classList.remove('active'); });
      event.target.classList.add('active');
      filterMembers();
    }

    function filterMembers() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const filtered = allMembers.filter(function(m) {
        const matchesSearch = !search || m.name.toLowerCase().includes(search);
        const matchesLetter = currentLetter === 'all' ||
          (m.lastName && m.lastName.charAt(0).toUpperCase() === currentLetter);
        return matchesSearch && matchesLetter;
      });
      renderMembers(filtered);
    }

    function renderMembers(members) {
      const container = document.getElementById('memberList');
      if (members.length === 0) {
        container.innerHTML = '<div class="empty">No members found</div>';
        return;
      }
      container.innerHTML = members.slice(0, 100).map(function(m) {
        const initials = ((m.firstName || '').charAt(0) + (m.lastName || '').charAt(0)).toUpperCase() || '?';
        const badge = m.isSteward === 'Yes' ? '<span class="steward-badge">Steward</span>' : '';
        return '<div class="member-card" onclick="selectMember(' + m.row + ')">' +
          '<div class="avatar">' + initials + '</div>' +
          '<div class="member-info">' +
            '<div class="member-name">' + m.name + ' ' + badge + '</div>' +
            '<div class="member-detail">' + (m.location || 'No location') + '</div>' +
          '</div>' +
        '</div>';
      }).join('');
    }

    function selectMember(row) {
      google.script.run.withSuccessHandler(function() { google.script.host.close(); }).navigateToMember(row);
    }
  </script>
</body>
</html>
  `;
}

/**
 * Mobile grievance browser with status filters
 */
function showMobileGrievanceBrowser() {
  const html = createMobileGrievanceBrowserHTML();
  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(420)
    .setHeight(700);

  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'üìã Grievance Log');
}

/**
 * Creates HTML for mobile grievance browser
 */
function createMobileGrievanceBrowserHTML() {
  return `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      margin: 0; padding: 0; background: #f5f5f5;
    }
    .header { background: #1a73e8; color: white; padding: 15px; position: sticky; top: 0; z-index: 100; }
    .search-box { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 16px; margin-top: 10px; }
    .status-tabs {
      display: flex; overflow-x: auto; background: white;
      border-bottom: 1px solid #e0e0e0; padding: 0 10px;
    }
    .status-tab {
      flex-shrink: 0; padding: 14px 16px; border: none; background: none;
      font-size: 14px; font-weight: 500; color: #666; cursor: pointer;
      border-bottom: 3px solid transparent; min-height: 48px;
    }
    .status-tab.active { color: #1a73e8; border-bottom-color: #1a73e8; }
    .list { padding: 10px; }
    .grievance-card {
      background: white; padding: 16px; margin-bottom: 12px;
      border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      border-left: 4px solid #ccc;
    }
    .grievance-card.open { border-left-color: #dc2626; }
    .grievance-card.pending { border-left-color: #f97316; }
    .grievance-card.settled { border-left-color: #059669; }
    .grievance-card.closed { border-left-color: #6b7280; }
    .card-top { display: flex; justify-content: space-between; margin-bottom: 10px; }
    .grievance-id { font-weight: bold; color: #1a73e8; font-size: 16px; }
    .status-badge {
      padding: 4px 10px; border-radius: 12px; font-size: 11px;
      font-weight: bold; text-transform: uppercase;
    }
    .badge-open { background: #fee2e2; color: #dc2626; }
    .badge-pending { background: #ffedd5; color: #ea580c; }
    .badge-settled { background: #d1fae5; color: #059669; }
    .badge-closed { background: #e5e7eb; color: #6b7280; }
    .card-row { font-size: 14px; margin: 6px 0; display: flex; }
    .card-label { color: #999; min-width: 80px; }
    .card-value { color: #333; flex: 1; }
    .deadline-warning { color: #dc2626; font-weight: bold; }
    .empty { text-align: center; padding: 40px; color: #999; }
  </style>
</head>
<body>
  <div class="header">
    <h2 style="margin: 0; font-size: 18px;">üìã Grievance Log</h2>
    <input type="text" class="search-box" id="searchInput" placeholder="Search grievances...">
  </div>

  <div class="status-tabs">
    <button class="status-tab active" onclick="filterByStatus('all')">All</button>
    <button class="status-tab" onclick="filterByStatus('Open')">üî¥ Open</button>
    <button class="status-tab" onclick="filterByStatus('Pending Info')">üü† Pending</button>
    <button class="status-tab" onclick="filterByStatus('Settled')">üü¢ Settled</button>
    <button class="status-tab" onclick="filterByStatus('Closed')">‚ö´ Closed</button>
  </div>

  <div class="list" id="grievanceList"><div class="empty">Loading...</div></div>

  <script>
    let allGrievances = [];
    let currentStatus = 'all';

    window.onload = function() {
      google.script.run.withSuccessHandler(loadGrievances).getRecentGrievancesForMobile(500);
      document.getElementById('searchInput').addEventListener('input', filterGrievances);
    };

    function loadGrievances(grievances) {
      allGrievances = grievances;
      renderGrievances(grievances);
    }

    function filterByStatus(status) {
      currentStatus = status;
      document.querySelectorAll('.status-tab').forEach(function(t) { t.classList.remove('active'); });
      event.target.classList.add('active');
      filterGrievances();
    }

    function filterGrievances() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const filtered = allGrievances.filter(function(g) {
        const matchesSearch = !search ||
          g.id.toLowerCase().includes(search) ||
          g.memberName.toLowerCase().includes(search) ||
          (g.issueType && g.issueType.toLowerCase().includes(search));
        const matchesStatus = currentStatus === 'all' || g.status === currentStatus;
        return matchesSearch && matchesStatus;
      });
      renderGrievances(filtered);
    }

    function renderGrievances(grievances) {
      const container = document.getElementById('grievanceList');
      if (grievances.length === 0) {
        container.innerHTML = '<div class="empty">No grievances found</div>';
        return;
      }
      container.innerHTML = grievances.slice(0, 100).map(function(g) {
        const statusKey = (g.status || 'open').toLowerCase().replace(/\\s+/g, '-');
        const badgeClass = 'badge-' + statusKey.split('-')[0];
        return '<div class="grievance-card ' + statusKey.split('-')[0] + '" onclick="selectGrievance(\\'' + g.id + '\\')">' +
          '<div class="card-top">' +
            '<span class="grievance-id">#' + g.id + '</span>' +
            '<span class="status-badge ' + badgeClass + '">' + (g.status || 'Open') + '</span>' +
          '</div>' +
          '<div class="card-row"><span class="card-label">Member</span><span class="card-value">' + (g.memberName || 'N/A') + '</span></div>' +
          '<div class="card-row"><span class="card-label">Issue</span><span class="card-value">' + (g.issueType || 'N/A') + '</span></div>' +
          '<div class="card-row"><span class="card-label">Filed</span><span class="card-value">' + (g.filedDate || 'N/A') + '</span></div>' +
          (g.deadline ? '<div class="card-row"><span class="card-label">Deadline</span><span class="card-value deadline-warning">' + g.deadline + '</span></div>' : '') +
        '</div>';
      }).join('');
    }

    function selectGrievance(id) {
      google.script.run.withSuccessHandler(function() { google.script.host.close(); }).navigateToGrievance(id);
    }
  </script>
</body>
</html>
  `;
}



// ================================================================================
// MODULE: OptimizedDashboardRebuild.gs
// Source: OptimizedDashboardRebuild.gs
// ================================================================================

/****************************************************
 * OPTIMIZED DASHBOARD REBUILD
 * Phase 6 - High Priority
 *
 * Optimizes dashboard rebuild for 30-40% performance improvement
 * Uses caching and parallel processing
 *
 * Based on ADDITIONAL_ENHANCEMENTS.md Phase 2
 ****************************************************/

/**
 * Rebuild dashboard with optimizations
 * Expected: 30-40% faster than standard rebuild
 */
function rebuildDashboardOptimized() {
  const startTime = new Date();
  Logger.log('=== Starting Optimized Dashboard Rebuild ===');

  const ss = SpreadsheetApp.getActiveSpreadsheet();

  try {
    // Read all data once and store in memory cache
    const dataCache = buildDataCache();

    // Calculate all metrics in parallel using cached data
    const metrics = calculateAllMetricsOptimized(dataCache);

    // Prepare all chart data
    const chartData = prepareAllChartData(dataCache);

    // Write everything in batches
    writeDashboardData(metrics, chartData);

    // Cache the dashboard state for graceful degradation
    if (typeof cacheDashboardState === 'function') {
      cacheDashboardState();
    }

    const duration = new Date() - startTime;

    Logger.log(`‚úÖ Optimized dashboard rebuild complete (${duration}ms)`);

    // Log performance
    if (typeof logPerformanceMetric === 'function') {
      logPerformanceMetric('rebuildDashboardOptimized', duration);
    }

    return {
      success: true,
      duration: duration,
      message: `Dashboard rebuilt in ${(duration/1000).toFixed(2)}s`
    };

  } catch (error) {
    const duration = new Date() - startTime;
    Logger.log(`‚ùå Dashboard rebuild failed after ${duration}ms: ${error.message}`);

    if (typeof logError === 'function') {
      logError(error, 'rebuildDashboardOptimized', 'ERROR');
    }

    throw error;
  }
}

/**
 * Build in-memory cache of all data
 * Single read of all sheets
 */
function buildDataCache() {
  Logger.log('Building data cache...');

  const ss = SpreadsheetApp.getActiveSpreadsheet();

  // Use cached data if available and recent (< 5 minutes old)
  const cache = CacheService.getScriptCache();
  const cachedData = cache.get('dashboard_data_cache');

  if (cachedData) {
    const data = JSON.parse(cachedData);
    const age = Date.now() - data.timestamp;

    if (age < 300000) { // 5 minutes
      Logger.log(`Using cached data (${Math.floor(age/1000)}s old)`);
      return data;
    }
  }

  // Build fresh cache
  const dataCache = {
    timestamp: Date.now(),
    members: null,
    grievances: null,
    config: null
  };

  try {
    const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
    if (memberSheet) {
      dataCache.members = memberSheet.getDataRange().getValues();
    }

    const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
    if (grievanceSheet) {
      dataCache.grievances = grievanceSheet.getDataRange().getValues();
    }

    const configSheet = ss.getSheetByName(SHEETS.CONFIG);
    if (configSheet) {
      dataCache.config = configSheet.getDataRange().getValues();
    }

    // Cache for 5 minutes
    cache.put('dashboard_data_cache', JSON.stringify(dataCache), 300);

    Logger.log('‚úÖ Data cache built');

  } catch (error) {
    Logger.log(`Error building data cache: ${error.message}`);
    throw error;
  }

  return dataCache;
}

/**
 * Calculate all dashboard metrics optimized
 * @param {Object} dataCache - Cached data
 * @returns {Object} Calculated metrics
 */
function calculateAllMetricsOptimized(dataCache) {
  Logger.log('Calculating metrics...');

  const metrics = {
    // Member metrics
    totalMembers: 0,
    activeStewards: 0,
    avgOpenRate: 0,
    ytdVolunteerHours: 0,

    // Grievance metrics
    totalGrievances: 0,
    openGrievances: 0,
    pendingInfo: 0,
    settledThisMonth: 0,
    avgDaysOpen: 0,

    // Engagement metrics
    virtualMeetings30d: 0,
    inPersonMeetings30d: 0,
    localActionInterest: 0,
    chapterActionInterest: 0,

    // Deadline tracking
    upcomingDeadlines: []
  };

  if (!dataCache.members || !dataCache.grievances) {
    return metrics;
  }

  const memberData = dataCache.members;
  const grievanceData = dataCache.grievances;

  // Calculate member metrics (skip header row)
  metrics.totalMembers = memberData.length - 1;

  let openRateSum = 0;
  let openRateCount = 0;

  for (let i = 1; i < memberData.length; i++) {
    const row = memberData[i];

    // Active stewards (column J)
    if (row[MEMBER_COLS.IS_STEWARD - 1] === 'Yes') {
      metrics.activeStewards++;
    }

    // Open rate (column S)
    if (row[MEMBER_COLS.OPEN_RATE - 1] && !isNaN(row[MEMBER_COLS.OPEN_RATE - 1])) {
      openRateSum += parseFloat(row[MEMBER_COLS.OPEN_RATE - 1]);
      openRateCount++;
    }

    // Volunteer hours (column T)
    if (row[MEMBER_COLS.VOLUNTEER_HOURS - 1] && !isNaN(row[MEMBER_COLS.VOLUNTEER_HOURS - 1])) {
      metrics.ytdVolunteerHours += parseFloat(row[MEMBER_COLS.VOLUNTEER_HOURS - 1]);
    }

    // Interest in local actions (column U)
    if (row[MEMBER_COLS.INTEREST_LOCAL - 1] === 'Yes') {
      metrics.localActionInterest++;
    }

    // Interest in chapter actions (column W)
    if (row[MEMBER_COLS.INTEREST_CHAPTER - 1] === 'Yes') {
      metrics.chapterActionInterest++;
    }
  }

  metrics.avgOpenRate = openRateCount > 0 ? (openRateSum / openRateCount) : 0;

  // Calculate grievance metrics
  metrics.totalGrievances = grievanceData.length - 1;

  const now = new Date();
  const thisMonth = now.getMonth();
  const thisYear = now.getFullYear();
  const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));

  let daysOpenSum = 0;
  let daysOpenCount = 0;

  for (let i = 1; i < grievanceData.length; i++) {
    const row = grievanceData[i];

    const status = row[GRIEVANCE_COLS.STATUS - 1]; // Column E
    const dateClosed = row[GRIEVANCE_COLS.DATE_CLOSED - 1]; // Column R
    const daysOpen = row[GRIEVANCE_COLS.DAYS_OPEN - 1]; // Column S
    const nextActionDue = row[GRIEVANCE_COLS.NEXT_ACTION_DUE - 1]; // Column T

    // Count by status
    if (status === 'Open') {
      metrics.openGrievances++;

      // Average days open for open grievances
      if (daysOpen && !isNaN(daysOpen)) {
        daysOpenSum += parseFloat(daysOpen);
        daysOpenCount++;
      }
    } else if (status === 'Pending Info') {
      metrics.pendingInfo++;
    }

    // Settled this month
    if (status === 'Settled' && dateClosed) {
      const closed = new Date(dateClosed);
      if (closed.getMonth() === thisMonth && closed.getFullYear() === thisYear) {
        metrics.settledThisMonth++;
      }
    }

    // Upcoming deadlines (next 14 days)
    if (nextActionDue && status === 'Open') {
      const deadline = new Date(nextActionDue);
      // Validate that the date is valid and not in the past
      if (!isNaN(deadline.getTime())) {
        const daysUntil = Math.floor((deadline - now) / (1000 * 60 * 60 * 24));

        // Only include upcoming deadlines (0-14 days), not past deadlines
        if (daysUntil >= 0 && daysUntil <= 14) {
          metrics.upcomingDeadlines.push({
            grievanceId: row[GRIEVANCE_COLS.GRIEVANCE_ID - 1],
            memberName: `${row[GRIEVANCE_COLS.FIRST_NAME - 1]} ${row[GRIEVANCE_COLS.LAST_NAME - 1]}`,
            deadline: deadline,
            daysUntil: daysUntil
          });
        }
      }
    }
  }

  metrics.avgDaysOpen = daysOpenCount > 0 ? (daysOpenSum / daysOpenCount) : 0;

  // Sort upcoming deadlines by date
  metrics.upcomingDeadlines.sort(function(a, b) { return a.deadline - b.deadline; });

  Logger.log('‚úÖ Metrics calculated');

  return metrics;
}

/**
 * Prepare all chart data
 * @param {Object} dataCache - Cached data
 * @returns {Object} Chart data
 */
function prepareAllChartData(dataCache) {
  Logger.log('Preparing chart data...');

  const chartData = {
    grievancesByStatus: [],
    grievancesByMonth: [],
    grievancesByLocation: [],
    grievancesByType: []
  };

  if (!dataCache.grievances) {
    return chartData;
  }

  const grievanceData = dataCache.grievances;

  // Count by status
  const statusCounts = {};
  const locationCounts = {};
  const typeCounts = {};
  const monthCounts = {};

  for (let i = 1; i < grievanceData.length; i++) {
    const row = grievanceData[i];

    const status = row[GRIEVANCE_COLS.STATUS - 1];
    const location = row[GRIEVANCE_COLS.LOCATION - 1]; // Column Z
    const issueCategory = row[GRIEVANCE_COLS.ISSUE_CATEGORY - 1]; // Column W
    const dateFiled = row[GRIEVANCE_COLS.DATE_FILED - 1]; // Column I

    // By status
    statusCounts[status] = (statusCounts[status] || 0) + 1;

    // By location
    if (location) {
      locationCounts[location] = (locationCounts[location] || 0) + 1;
    }

    // By type
    if (issueCategory) {
      typeCounts[issueCategory] = (typeCounts[issueCategory] || 0) + 1;
    }

    // By month
    if (dateFiled) {
      const date = new Date(dateFiled);
      const monthKey = Utilities.formatDate(date, Session.getScriptTimeZone(), 'yyyy-MM');
      monthCounts[monthKey] = (monthCounts[monthKey] || 0) + 1;
    }
  }

  // Convert to arrays
  chartData.grievancesByStatus = Object.entries(statusCounts);
  chartData.grievancesByLocation = Object.entries(locationCounts);
  chartData.grievancesByType = Object.entries(typeCounts);
  chartData.grievancesByMonth = Object.entries(monthCounts).sort();

  Logger.log('‚úÖ Chart data prepared');

  return chartData;
}

/**
 * Write all dashboard data efficiently
 * @param {Object} metrics - Calculated metrics
 * @param {Object} chartData - Chart data
 */
function writeDashboardData(metrics, chartData) {
  Logger.log('Writing dashboard data...');

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const dashboard = ss.getSheetByName(SHEETS.DASHBOARD);

  if (!dashboard) {
    throw new Error('Dashboard sheet not found');
  }

  // Prepare all data to write
  const updates = [
    // KPI section
    ['MEMBER METRICS', ''],
    ['Total Members', metrics.totalMembers],
    ['Active Stewards', metrics.activeStewards],
    ['Avg Open Rate', `${metrics.avgOpenRate.toFixed(1)}%`],
    ['YTD Volunteer Hours', metrics.ytdVolunteerHours.toLocaleString('en-US', {minimumFractionDigits: 1, maximumFractionDigits: 1})],
    ['', ''],

    ['GRIEVANCE METRICS', ''],
    ['Total Grievances', metrics.totalGrievances],
    ['Open Grievances', metrics.openGrievances],
    ['Pending Info', metrics.pendingInfo],
    ['Settled This Month', metrics.settledThisMonth],
    ['Avg Days Open', Math.round(metrics.avgDaysOpen)],
    ['', ''],

    ['ENGAGEMENT (Last 30 Days)', ''],
    ['Local Action Interest', metrics.localActionInterest],
    ['Chapter Action Interest', metrics.chapterActionInterest],
    ['', ''],

    ['UPCOMING DEADLINES', ''],
    ['Grievance ID', 'Member', 'Deadline', 'Days Until']
  ];

  // Add deadline rows (top 10)
  const deadlines = metrics.upcomingDeadlines.slice(0, 10);
  for (const d of deadlines) {
    updates.push([
      d.grievanceId,
      d.memberName,
      Utilities.formatDate(d.deadline, Session.getScriptTimeZone(), 'MM/dd/yyyy'),
      d.daysUntil
    ]);
  }

  // Write all data at once
  dashboard.clear();
  dashboard.getRange(1, 1, updates.length, 4).setValues(updates);

  // Add last updated timestamp
  const lastRow = updates.length + 2;
  dashboard.getRange(lastRow, 1).setValue('Last Updated:');
  dashboard.getRange(lastRow, 2).setValue(new Date());

  Logger.log('‚úÖ Dashboard data written');
}

/**
 * Menu function for optimized rebuild
 */
function REBUILD_DASHBOARD_OPTIMIZED() {
  const ui = SpreadsheetApp.getUi();

  const response = ui.alert(
    'Rebuild Dashboard (Optimized)?',
    'This will rebuild the dashboard using the optimized method.\n\n' +
    'Expected to be 30-40% faster than standard rebuild.\n\n' +
    'Continue?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return;
  }

  try {
    ui.alert('Rebuilding dashboard...');

    const result = rebuildDashboardOptimized();

    ui.alert(
      'Dashboard Rebuilt!',
      `Dashboard rebuilt successfully.\n\n` +
      `Time: ${result.duration}ms (${(result.duration/1000).toFixed(2)}s)`,
      ui.ButtonSet.OK
    );

  } catch (error) {
    ui.alert(
      'Rebuild Failed',
      `Dashboard rebuild failed: ${error.message}`,
      ui.ButtonSet.OK
    );
  }
}

/**
 * Clear dashboard data cache
 * Use this when you need fresh data
 */
function clearDashboardCache() {
  const cache = CacheService.getScriptCache();
  cache.remove('dashboard_data_cache');
  cache.remove('dashboard_snapshot');

  Logger.log('Dashboard cache cleared');

  const ui = SpreadsheetApp.getUi();
  ui.alert(
    'Cache Cleared',
    'Dashboard data cache has been cleared.\n\n' +
    'Next rebuild will use fresh data.',
    ui.ButtonSet.OK
  );
}



// ================================================================================
// MODULE: PerformanceAndBackup.gs
// Source: PerformanceAndBackup.gs
// ================================================================================

/**
 * PERFORMANCE MONITORING AND BACKUP FEATURES
 * Features 90, 91: Automated Backups, Performance Monitoring
 */

// ===========================
// FEATURE 91: PERFORMANCE MONITORING
// ===========================

/**
 * Creates the Performance_Log sheet for tracking script execution times
 */
function createPerformanceLogSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let perfLog = ss.getSheetByName('Performance_Log');

  // Delete existing sheet if present
  if (perfLog) {
    ss.deleteSheet(perfLog);
  }

  // Create new sheet
  perfLog = ss.insertSheet('Performance_Log');

  // Set up headers
  const headers = [
    'Timestamp',
    'Function Name',
    'Execution Time (ms)',
    'Status',
    'Records Processed',
    'Memory Usage (estimate)',
    'User Email',
    'Notes'
  ];

  perfLog.getRange(1, 1, 1, headers.length).setValues([headers]);

  // Style headers
  perfLog.getRange(1, 1, 1, headers.length)
    .setFontWeight('bold')
    .setBackground('#4A5568')
    .setFontColor('#FFFFFF')
    .setWrap(true);

  // Set column widths
  perfLog.setColumnWidth(1, 150); // Timestamp
  perfLog.setColumnWidth(2, 200); // Function Name
  perfLog.setColumnWidth(3, 120); // Execution Time
  perfLog.setColumnWidth(4, 100); // Status
  perfLog.setColumnWidth(5, 150); // Records Processed
  perfLog.setColumnWidth(6, 150); // Memory Usage
  perfLog.setColumnWidth(7, 200); // User Email
  perfLog.setColumnWidth(8, 250); // Notes

  // Freeze header row
  perfLog.setFrozenRows(1);

  // Set tab color
  perfLog.setTabColor('#059669'); // Green for monitoring

  Logger.log('Performance_Log sheet created successfully');
}

/**
 * Tracks performance of a function
 * @param {string} functionName - Name of function being tracked
 * @param {Function} callback - Function to execute and track
 * @param {Object} options - Optional configuration {recordsProcessed, notes}
 * @return {*} Result of callback function
 */
function trackPerformance(functionName, callback, options = {}) {
  const startTime = Date.now();
  const startMemory = (typeof MemoryInfo !== 'undefined') ? MemoryInfo.getCurrentUsage() : 'N/A';

  let result;
  let status = 'SUCCESS';
  let errorMessage = '';

  try {
    result = callback();
  } catch (error) {
    status = 'ERROR';
    errorMessage = error.message;
    Logger.log(`Error in ${functionName}: ${error.message}`);
    throw error; // Re-throw to maintain original behavior
  } finally {
    const endTime = Date.now();
    const executionTime = endTime - startTime;
    const endMemory = (typeof MemoryInfo !== 'undefined') ? MemoryInfo.getCurrentUsage() : 'N/A';

    // Log to Performance_Log sheet
    logPerformance(functionName, executionTime, status, options.recordsProcessed || 'N/A',
                  endMemory, errorMessage || options.notes || '');
  }

  return result;
}

/**
 * Logs performance data to Performance_Log sheet
 */
function logPerformance(functionName, executionTime, status, recordsProcessed, memoryUsage, notes) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let perfLog = ss.getSheetByName('Performance_Log');

    // Create performance log sheet if it doesn't exist
    if (!perfLog) {
      createPerformanceLogSheet();
      perfLog = ss.getSheetByName('Performance_Log');
    }

    const userEmail = Session.getActiveUser().getEmail() || 'Unknown';
    const timestamp = new Date();

    const perfEntry = [
      timestamp,
      functionName,
      executionTime,
      status,
      recordsProcessed,
      memoryUsage,
      userEmail,
      notes
    ];

    perfLog.appendRow(perfEntry);

    // Color code based on status
    const lastRow = perfLog.getLastRow();
    if (status === 'ERROR') {
      perfLog.getRange(lastRow, 1, 1, 8).setBackground('#FEE2E2'); // Light red
    } else if (executionTime > 30000) { // >30 seconds
      perfLog.getRange(lastRow, 1, 1, 8).setBackground('#FEF3C7'); // Light yellow (slow)
    }

  } catch (error) {
    Logger.log(`Error logging performance: ${error.message}`);
    // Don't throw - performance logging should not break main operations
  }
}

/**
 * Generates performance summary report
 */
function generatePerformanceReport() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const perfLog = ss.getSheetByName('Performance_Log');

  if (!perfLog) {
    SpreadsheetApp.getUi().alert('Error', 'Performance_Log sheet not found. No performance data available.', SpreadsheetApp.getUi().ButtonSet.OK);
    return;
  }

  const data = perfLog.getDataRange().getValues();
  const records = data.slice(1); // Skip header

  if (records.length === 0) {
    SpreadsheetApp.getUi().alert('No Data', 'No performance data available yet.', SpreadsheetApp.getUi().ButtonSet.OK);
    return;
  }

  // Calculate statistics
  const functionStats = {};
  records.forEach(row => {
    const funcName = row[1];
    const execTime = row[2];
    const status = row[3];

    if (!functionStats[funcName]) {
      functionStats[funcName] = {
        calls: 0,
        totalTime: 0,
        minTime: Infinity,
        maxTime: 0,
        errors: 0
      };
    }

    functionStats[funcName].calls++;
    functionStats[funcName].totalTime += execTime;
    functionStats[funcName].minTime = Math.min(functionStats[funcName].minTime, execTime);
    functionStats[funcName].maxTime = Math.max(functionStats[funcName].maxTime, execTime);
    if (status === 'ERROR') functionStats[funcName].errors++;
  });

  // Create report sheet
  let reportSheet = ss.getSheetByName('Performance Report');
  if (reportSheet) {
    ss.deleteSheet(reportSheet);
  }
  reportSheet = ss.insertSheet('Performance Report');

  // Add title
  reportSheet.getRange(1, 1, 1, 7).merge();
  reportSheet.getRange(1, 1).setValue('PERFORMANCE SUMMARY REPORT');
  reportSheet.getRange(1, 1).setFontSize(16).setFontWeight('bold').setHorizontalAlignment('center');

  // Add headers
  const headers = ['Function Name', 'Total Calls', 'Avg Time (ms)', 'Min Time (ms)', 'Max Time (ms)', 'Errors', 'Success Rate'];
  reportSheet.getRange(3, 1, 1, 7).setValues([headers]);
  reportSheet.getRange(3, 1, 1, 7)
    .setFontWeight('bold')
    .setBackground('#4A5568')
    .setFontColor('#FFFFFF');

  // Add data
  let row = 4;
  for (const [funcName, stats] of Object.entries(functionStats)) {
    const avgTime = Math.round(stats.totalTime / stats.calls);
    const successRate = ((stats.calls - stats.errors) / stats.calls * 100).toFixed(1) + '%';

    reportSheet.getRange(row, 1, 1, 7).setValues([[
      funcName,
      stats.calls,
      avgTime,
      stats.minTime === Infinity ? 0 : stats.minTime,
      stats.maxTime,
      stats.errors,
      successRate
    ]]);

    // Highlight slow functions (avg > 5 seconds)
    if (avgTime > 5000) {
      reportSheet.getRange(row, 1, 1, 7).setBackground('#FEF3C7');
    }

    row++;
  }

  // Format
  reportSheet.setFrozenRows(3);
  reportSheet.setTabColor('#059669');
  reportSheet.autoResizeColumns(1, 7);

  SpreadsheetApp.getUi().alert('Success', 'Performance report generated successfully!', SpreadsheetApp.getUi().ButtonSet.OK);
}

// ===========================
// FEATURE 90: AUTOMATED BACKUPS
// ===========================

/**
 * Creates an automated backup of the spreadsheet to Google Drive
 * @return {string} URL of backup file
 */
function createAutomatedBackup() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const scriptProps = PropertiesService.getScriptProperties();

  // Get backup folder ID from script properties
  let backupFolderId = scriptProps.getProperty('BACKUP_FOLDER_ID');

  if (!backupFolderId) {
    const ui = SpreadsheetApp.getUi();
    const response = ui.prompt(
      'Configure Backup Location',
      'Enter Google Drive Folder ID for backups:\n\n(Right-click folder in Drive ‚Üí Get link ‚Üí Copy ID from URL)',
      ui.ButtonSet.OK_CANCEL
    );

    if (response.getSelectedButton() !== ui.Button.OK) {
      return null;
    }

    backupFolderId = response.getResponseText().trim();
    scriptProps.setProperty('BACKUP_FOLDER_ID', backupFolderId);
  }

  try {
    const backupFolder = DriveApp.getFolderById(backupFolderId);

    // Create backup with timestamp
    const timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy-MM-dd_HHmmss');
    const backupName = `509_Dashboard_Backup_${timestamp}`;

    // Make a copy
    const backupFile = DriveApp.getFileById(ss.getId()).makeCopy(backupName, backupFolder);

    Logger.log(`Backup created: ${backupName}`);

    // Log the backup
    if (typeof logDataModification === 'function') {
      logDataModification('BACKUP_CREATED', 'System', backupFile.getId(), 'Automated Backup',
                         'N/A', backupName);
    }

    SpreadsheetApp.getUi().alert('Backup Complete',
      `Backup created successfully!\n\nFile: ${backupName}\n\nView in Drive: ${backupFile.getUrl()}`,
      SpreadsheetApp.getUi().ButtonSet.OK);

    return backupFile.getUrl();

  } catch (error) {
    Logger.log(`Backup failed: ${error.message}`);
    SpreadsheetApp.getUi().alert('Backup Failed',
      `Failed to create backup: ${error.message}\n\nPlease verify the folder ID is correct.`,
      SpreadsheetApp.getUi().ButtonSet.OK);
    return null;
  }
}

/**
 * Sets up daily automated backups
 */
function setupDailyBackups() {
  const ui = SpreadsheetApp.getUi();

  // Check if backup folder is configured
  const scriptProps = PropertiesService.getScriptProperties();
  if (!scriptProps.getProperty('BACKUP_FOLDER_ID')) {
    const response = ui.prompt(
      'Configure Backup Location',
      'Enter Google Drive Folder ID for backups:\n\n(Right-click folder in Drive ‚Üí Get link ‚Üí Copy ID from URL)',
      ui.ButtonSet.OK_CANCEL
    );

    if (response.getSelectedButton() !== ui.Button.OK) {
      return;
    }

    const folderId = response.getResponseText().trim();
    scriptProps.setProperty('BACKUP_FOLDER_ID', folderId);
  }

  // Delete existing backup triggers
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === 'createAutomatedBackup') {
      ScriptApp.deleteTrigger(trigger);
    }
  });

  // Create daily trigger (runs at 2 AM)
  ScriptApp.newTrigger('createAutomatedBackup')
    .timeBased()
    .atHour(2)
    .everyDays(1)
    .create();

  ui.alert('Success',
    'Daily automated backups enabled!\n\nBackups will be created every day at 2:00 AM.',
    ui.ButtonSet.OK);
}

/**
 * Configures backup folder ID
 */
function configureBackupFolder() {
  const ui = SpreadsheetApp.getUi();
  const scriptProps = PropertiesService.getScriptProperties();

  const currentFolder = scriptProps.getProperty('BACKUP_FOLDER_ID') || 'Not configured';

  const response = ui.prompt(
    'Configure Backup Folder',
    `Current Folder ID: ${currentFolder}\n\nEnter new Google Drive Folder ID:\n\n(Right-click folder in Drive ‚Üí Get link ‚Üí Copy ID from URL)`,
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() === ui.Button.OK) {
    const folderId = response.getResponseText().trim();

    // Validate folder ID
    try {
      DriveApp.getFolderById(folderId);
      scriptProps.setProperty('BACKUP_FOLDER_ID', folderId);
      ui.alert('Success', 'Backup folder configured successfully!', ui.ButtonSet.OK);

      // Log configuration change
      if (typeof logDataModification === 'function') {
        logDataModification('CONFIG_CHANGE', 'Script Properties', 'BACKUP_FOLDER_ID',
                           'Folder ID', currentFolder, folderId);
      }

    } catch (error) {
      ui.alert('Error', `Invalid folder ID: ${error.message}`, ui.ButtonSet.OK);
    }
  }
}

/**
 * Cleans up old backups (keeps last 30 days)
 */
function cleanupOldBackups() {
  const scriptProps = PropertiesService.getScriptProperties();
  const backupFolderId = scriptProps.getProperty('BACKUP_FOLDER_ID');

  if (!backupFolderId) {
    SpreadsheetApp.getUi().alert('Error', 'Backup folder not configured.', SpreadsheetApp.getUi().ButtonSet.OK);
    return;
  }

  try {
    const backupFolder = DriveApp.getFolderById(backupFolderId);
    const files = backupFolder.getFilesByType(MimeType.GOOGLE_SHEETS);

    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - 30); // 30 days ago

    let deletedCount = 0;

    while (files.hasNext()) {
      const file = files.next();
      const fileName = file.getName();

      // Only process backup files
      if (fileName.startsWith('509_Dashboard_Backup_')) {
        const fileDate = file.getDateCreated();

        if (fileDate < cutoffDate) {
          file.setTrashed(true);
          deletedCount++;
          Logger.log(`Deleted old backup: ${fileName}`);
        }
      }
    }

    SpreadsheetApp.getUi().alert('Cleanup Complete',
      `Deleted ${deletedCount} backup(s) older than 30 days.`,
      SpreadsheetApp.getUi().ButtonSet.OK);

  } catch (error) {
    SpreadsheetApp.getUi().alert('Error', `Cleanup failed: ${error.message}`, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}



// ================================================================================
// MODULE: PerformanceMonitoring.gs
// Source: PerformanceMonitoring.gs
// ================================================================================

/****************************************************
 * PERFORMANCE MONITORING DASHBOARD
 * Phase 6 - Medium Priority
 *
 * Real-time performance visibility and tracking
 * Identifies regressions and optimization opportunities
 *
 * Based on ADDITIONAL_ENHANCEMENTS.md Phase 3
 ****************************************************/

/**
 * Log performance metric for a function call
 * @param {string} funcName - Name of the function
 * @param {number} duration - Duration in milliseconds
 * @param {boolean} error - Whether an error occurred
 */
function logPerformanceMetric(funcName, duration, error = false) {
  const props = PropertiesService.getScriptProperties();
  const perfLog = JSON.parse(props.getProperty('PERFORMANCE_LOG') || '{}');

  if (!perfLog[funcName]) {
    perfLog[funcName] = {
      avgTime: 0,
      minTime: Infinity,
      maxTime: 0,
      callCount: 0,
      errorCount: 0,
      lastRun: null,
      errorRate: 0
    };
  }

  const data = perfLog[funcName];

  // Update metrics
  data.callCount++;
  data.minTime = Math.min(data.minTime, duration);
  data.maxTime = Math.max(data.maxTime, duration);
  data.avgTime = ((data.avgTime * (data.callCount - 1)) + duration) / data.callCount;
  data.lastRun = Date.now();

  if (error) {
    data.errorCount++;
  }

  data.errorRate = (data.errorCount / data.callCount) * 100;

  // Keep log size manageable (max 100 functions)
  const keys = Object.keys(perfLog);
  if (keys.length > 100) {
    // Remove oldest entries
    const sorted = keys.sort(function(a, b) { return (perfLog[a].lastRun || 0) - (perfLog[b].lastRun || 0); });
    delete perfLog[sorted[0]];
  }

  props.setProperty('PERFORMANCE_LOG', JSON.stringify(perfLog));
}

/**
 * Create or update the performance monitoring sheet
 */
function createPerformanceMonitoringSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let perfSheet = ss.getSheetByName('‚ö° Performance Monitor');

  if (!perfSheet) {
    perfSheet = ss.insertSheet('‚ö° Performance Monitor');
  }

  perfSheet.clear();

  // Headers
  const headers = [
    ['Function', 'Avg Time (ms)', 'Min Time (ms)', 'Max Time (ms)',
     'Call Count', 'Error Rate (%)', 'Last Run']
  ];

  perfSheet.getRange('A1:G1').setValues(headers);

  // Style headers
  perfSheet.getRange('A1:G1')
    .setBackground(COLORS.PRIMARY_BLUE)
    .setFontColor(COLORS.WHITE)
    .setFontWeight('bold')
    .setHorizontalAlignment('center');

  // Get performance data
  const props = PropertiesService.getScriptProperties();
  const perfLog = JSON.parse(props.getProperty('PERFORMANCE_LOG') || '{}');

  const rows = [];

  for (const [funcName, data] of Object.entries(perfLog)) {
    const lastRun = data.lastRun ? new Date(data.lastRun) : '';

    rows.push([
      funcName,
      Math.round(data.avgTime),
      Math.round(data.minTime === Infinity ? 0 : data.minTime),
      Math.round(data.maxTime),
      data.callCount,
      data.errorRate.toFixed(2),
      lastRun
    ]);
  }

  // Sort by average time (descending) to show slowest functions first
  rows.sort(function(a, b) { return b[1] - a[1]; });

  if (rows.length > 0) {
    perfSheet.getRange(2, 1, rows.length, 7).setValues(rows);

    // Add conditional formatting for slow functions
    const avgTimeRange = perfSheet.getRange(2, 2, rows.length, 1);

    // Slow (> 5 seconds = 5000ms) - Red
    const slowRule = SpreadsheetApp.newConditionalFormatRule()
      .whenNumberGreaterThan(5000)
      .setBackground('#ffcccc')
      .setRanges([avgTimeRange])
      .build();

    // Moderate (> 1 second = 1000ms) - Yellow
    const moderateRule = SpreadsheetApp.newConditionalFormatRule()
      .whenNumberBetween(1000, 5000)
      .setBackground('#fff4cc')
      .setRanges([avgTimeRange])
      .build();

    // Fast (< 1 second) - Green
    const fastRule = SpreadsheetApp.newConditionalFormatRule()
      .whenNumberLessThan(1000)
      .setBackground('#d1fae5')
      .setRanges([avgTimeRange])
      .build();

    perfSheet.setConditionalFormatRules([slowRule, moderateRule, fastRule]);

    // Add conditional formatting for error rates
    const errorRateRange = perfSheet.getRange(2, 6, rows.length, 1);

    // High error rate (> 10%) - Red
    const highErrorRule = SpreadsheetApp.newConditionalFormatRule()
      .whenNumberGreaterThan(10)
      .setBackground('#ffcccc')
      .setRanges([errorRateRange])
      .build();

    // Some errors (> 0%) - Yellow
    const someErrorsRule = SpreadsheetApp.newConditionalFormatRule()
      .whenNumberBetween(0.01, 10)
      .setBackground('#fff4cc')
      .setRanges([errorRateRange])
      .build();

    perfSheet.setConditionalFormatRules([slowRule, moderateRule, fastRule, highErrorRule, someErrorsRule]);
  }

  // Add summary statistics
  const summaryRow = rows.length + 3;

  perfSheet.getRange(summaryRow, 1).setValue('SUMMARY');
  perfSheet.getRange(summaryRow, 1).setFontWeight('bold');

  perfSheet.getRange(summaryRow + 1, 1).setValue('Total Functions Tracked:');
  perfSheet.getRange(summaryRow + 1, 2).setValue(rows.length);

  perfSheet.getRange(summaryRow + 2, 1).setValue('Total Calls:');
  perfSheet.getRange(summaryRow + 2, 2).setValue(
    rows.reduce(function(sum, row) { return sum + row[4]; }, 0)
  );

  perfSheet.getRange(summaryRow + 3, 1).setValue('Last Updated:');
  perfSheet.getRange(summaryRow + 3, 2).setValue(new Date());

  // Auto-resize columns
  perfSheet.autoResizeColumns(1, 7);

  Logger.log('‚úÖ Performance monitoring sheet created/updated');

  return perfSheet;
}

/**
 * Wrapper to track performance of any function
 * @param {string} funcName - Name for tracking
 * @param {Function} func - Function to track
 * @returns {Function} Wrapped function with performance tracking
 */
function trackPerformance(funcName, func) {
  return function(...args) {
    const startTime = Date.now();

    try {
      const result = func.apply(this, args);
      const duration = Date.now() - startTime;

      logPerformanceMetric(funcName, duration, false);

      return result;

    } catch (error) {
      const duration = Date.now() - startTime;
      logPerformanceMetric(funcName, duration, true);

      throw error;
    }
  };
}

/**
 * Menu function to view performance dashboard
 */
function VIEW_PERFORMANCE_DASHBOARD() {
  const ui = SpreadsheetApp.getUi();

  try {
    const sheet = createPerformanceMonitoringSheet();
    SpreadsheetApp.setActiveSheet(sheet);

    ui.alert(
      'Performance Dashboard',
      'Performance monitoring sheet has been created/updated.\n\n' +
      'Features:\n' +
      '‚Ä¢ Average, min, max execution times\n' +
      '‚Ä¢ Call counts and error rates\n' +
      '‚Ä¢ Color-coded performance indicators\n\n' +
      'Slow functions (> 5s) are highlighted in red.\n' +
      'Moderate functions (1-5s) are highlighted in yellow.\n' +
      'Fast functions (< 1s) are highlighted in green.',
      ui.ButtonSet.OK
    );

  } catch (error) {
    ui.alert(
      'Error',
      `Failed to create performance dashboard: ${error.message}`,
      ui.ButtonSet.OK
    );
  }
}

/**
 * Clear performance logs
 */
function clearPerformanceLogs() {
  const ui = SpreadsheetApp.getUi();

  const response = ui.alert(
    'Clear Performance Logs?',
    'This will delete all performance tracking data.\n\n' +
    'Continue?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return;
  }

  const props = PropertiesService.getScriptProperties();
  props.deleteProperty('PERFORMANCE_LOG');

  Logger.log('Performance logs cleared');

  ui.alert(
    'Logs Cleared',
    'All performance tracking data has been cleared.',
    ui.ButtonSet.OK
  );
}

/**
 * Export performance data to CSV
 * @returns {string} CSV content
 */
function exportPerformanceDataCSV() {
  const props = PropertiesService.getScriptProperties();
  const perfLog = JSON.parse(props.getProperty('PERFORMANCE_LOG') || '{}');

  let csv = 'Function,Avg Time (ms),Min Time (ms),Max Time (ms),Call Count,Error Rate (%),Last Run\n';

  for (const [funcName, data] of Object.entries(perfLog)) {
    const lastRun = data.lastRun ? new Date(data.lastRun).toISOString() : '';

    csv += `${funcName},`;
    csv += `${data.avgTime.toFixed(2)},`;
    csv += `${data.minTime},`;
    csv += `${data.maxTime},`;
    csv += `${data.callCount},`;
    csv += `${data.errorRate.toFixed(2)},`;
    csv += `${lastRun}\n`;
  }

  return csv;
}

/**
 * Get performance summary
 * @returns {Object} Performance summary
 */
function getPerformanceSummary() {
  const props = PropertiesService.getScriptProperties();
  const perfLog = JSON.parse(props.getProperty('PERFORMANCE_LOG') || '{}');

  const summary = {
    totalFunctions: 0,
    totalCalls: 0,
    totalErrors: 0,
    avgExecutionTime: 0,
    slowestFunction: null,
    fastestFunction: null,
    mostCalledFunction: null
  };

  let slowestTime = 0;
  let fastestTime = Infinity;
  let mostCalls = 0;
  let totalTime = 0;

  for (const [funcName, data] of Object.entries(perfLog)) {
    summary.totalFunctions++;
    summary.totalCalls += data.callCount;
    summary.totalErrors += data.errorCount;

    totalTime += data.avgTime * data.callCount;

    if (data.avgTime > slowestTime) {
      slowestTime = data.avgTime;
      summary.slowestFunction = { name: funcName, time: data.avgTime };
    }

    if (data.avgTime < fastestTime) {
      fastestTime = data.avgTime;
      summary.fastestFunction = { name: funcName, time: data.avgTime };
    }

    if (data.callCount > mostCalls) {
      mostCalls = data.callCount;
      summary.mostCalledFunction = { name: funcName, calls: data.callCount };
    }
  }

  if (summary.totalCalls > 0) {
    summary.avgExecutionTime = totalTime / summary.totalCalls;
  }

  return summary;
}

/**
 * Show performance summary in UI
 */
function showPerformanceSummary() {
  const ui = SpreadsheetApp.getUi();
  const summary = getPerformanceSummary();

  let message = 'PERFORMANCE SUMMARY\n\n';
  message += `Total Functions Tracked: ${summary.totalFunctions}\n`;
  message += `Total Function Calls: ${summary.totalCalls}\n`;
  message += `Total Errors: ${summary.totalErrors}\n`;
  message += `Average Execution Time: ${summary.avgExecutionTime.toFixed(2)}ms\n\n`;

  if (summary.slowestFunction) {
    message += `Slowest Function: ${summary.slowestFunction.name} (${summary.slowestFunction.time.toFixed(2)}ms)\n`;
  }

  if (summary.fastestFunction) {
    message += `Fastest Function: ${summary.fastestFunction.name} (${summary.fastestFunction.time.toFixed(2)}ms)\n`;
  }

  if (summary.mostCalledFunction) {
    message += `Most Called: ${summary.mostCalledFunction.name} (${summary.mostCalledFunction.calls} calls)\n`;
  }

  ui.alert('Performance Summary', message, ui.ButtonSet.OK);
}

// Create tracked versions of critical functions
// These can be used instead of the original functions to automatically track performance

const recalcAllMembersTracked = trackPerformance('recalcAllMembers', recalcAllMembers);
const recalcAllGrievancesTracked = trackPerformance('recalcAllGrievancesBatched', recalcAllGrievancesBatched);
const rebuildDashboardTracked = trackPerformance('rebuildDashboardOptimized', rebuildDashboardOptimized);



// ================================================================================
// MODULE: Phase6Integration.gs
// Source: Phase6Integration.gs
// ================================================================================

/****************************************************
 * PHASE 6 INTEGRATION
 * Complete Round 2 Optimizations
 *
 * This file integrates all Phase 6 enhancements and provides
 * menu items for accessing the new functionality.
 *
 * PHASE 6 FEATURES:
 * ------------====
 *
 * CRITICAL PRIORITY (Phase 1):
 * 1. Batch Grievance Recalculation (2500x speedup)
 * 2. Transaction Rollback System (prevents data corruption)
 * 3. Incremental Backup System (disaster recovery)
 *
 * HIGH PRIORITY (Phase 2):
 * 4. Distributed Locks (concurrent user safety)
 * 5. Graceful Degradation Framework (system resilience)
 * 6. Optimized Dashboard Rebuild (30-40% faster)
 *
 * MEDIUM PRIORITY (Phase 3):
 * 7. Idempotent Operations (safe retries)
 * 8. Performance Monitoring Dashboard
 * 9. Lazy Load Charts (faster initial load)
 *
 * FILES CREATED:
 * ------------==
 * - BatchGrievanceRecalc.gs (357 lines)
 * - TransactionRollback.gs (453 lines)
 * - IncrementalBackupSystem.gs (456 lines)
 * - DistributedLocks.gs (412 lines)
 * - GracefulDegradation.gs (389 lines)
 * - OptimizedDashboardRebuild.gs (342 lines)
 * - IdempotentOperations.gs (381 lines)
 * - PerformanceMonitoring.gs (328 lines)
 * - LazyLoadCharts.gs (402 lines)
 * - Phase6Integration.gs (this file)
 *
 * TOTAL: ~3,900 lines of new code
 ****************************************************/

/**
 * Create Phase 6 menu items
 * Call this from the main onOpen() function
 */
function createPhase6Menu(menu) {
  // Performance submenu
  const performanceMenu = SpreadsheetApp.getUi().createMenu('‚ö° Performance');

  performanceMenu.addItem('üìä View Performance Dashboard', 'VIEW_PERFORMANCE_DASHBOARD');
  performanceMenu.addItem('üîÑ Recalc Grievances (Batched)', 'RECALC_ALL_GRIEVANCES_BATCHED');
  performanceMenu.addItem('üé® Rebuild Dashboard (Optimized)', 'REBUILD_DASHBOARD_OPTIMIZED');
  performanceMenu.addSeparator();
  performanceMenu.addItem('üìà Show Performance Summary', 'showPerformanceSummary');
  performanceMenu.addItem('üóëÔ∏è Clear Performance Logs', 'clearPerformanceLogs');

  // Reliability submenu
  const reliabilityMenu = SpreadsheetApp.getUi().createMenu('üõ°Ô∏è Reliability');

  reliabilityMenu.addItem('üíæ Create Backup', 'CREATE_BACKUP');
  reliabilityMenu.addItem('üìã Show Backup Info', 'showBackupInfo');
  reliabilityMenu.addItem('‚öôÔ∏è Setup Daily Backups', 'setupDailyBackupTrigger');
  reliabilityMenu.addSeparator();
  reliabilityMenu.addItem('üîÑ Seed with Rollback Protection', 'seedAllWithRollback');
  reliabilityMenu.addItem('üîí Check Lock Status', 'CHECK_LOCK_STATUS');

  // System submenu
  const systemMenu = SpreadsheetApp.getUi().createMenu('üîß System');

  systemMenu.addItem('üóÇÔ∏è Clear Dashboard Cache', 'clearDashboardCache');
  systemMenu.addItem('üîÑ Clear Idempotent Cache', 'CLEAR_IDEMPOTENT_CACHE');
  systemMenu.addItem('üé® Clear Chart Cache', 'CLEAR_CHART_CACHE');
  systemMenu.addSeparator();
  systemMenu.addItem('üìä Show Chart Build Status', 'SHOW_CHART_BUILD_STATUS');
  systemMenu.addItem('üîÑ Force Rebuild All Charts', 'FORCE_REBUILD_ALL_CHARTS');
  systemMenu.addSeparator();
  systemMenu.addItem('üìà Show Idempotent Status', 'SHOW_IDEMPOTENT_STATUS');

  // Add to main menu
  menu.addSubMenu(performanceMenu);
  menu.addSubMenu(reliabilityMenu);
  menu.addSubMenu(systemMenu);

  return menu;
}

/**
 * Initialize Phase 6 features
 * Call this during system setup or first run
 */
function initializePhase6Features() {
  const ui = SpreadsheetApp.getUi();

  const response = ui.alert(
    'Initialize Phase 6 Features?',
    'This will set up:\n\n' +
    '‚Ä¢ Performance monitoring\n' +
    '‚Ä¢ Backup system\n' +
    '‚Ä¢ Chart lazy loading\n' +
    '‚Ä¢ Cache systems\n\n' +
    'Continue?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return;
  }

  const status = [];

  try {
    // 1. Set up backup folder
    ui.alert('Setting up backup system...');
    const props = PropertiesService.getScriptProperties();

    if (!props.getProperty('BACKUP_FOLDER_ID')) {
      if (typeof createBackupFolder === 'function') {
        const folderId = createBackupFolder();
        props.setProperty('BACKUP_FOLDER_ID', folderId);
        status.push('‚úÖ Backup folder created');
      }
    } else {
      status.push('‚úÖ Backup folder already configured');
    }

    // 2. Initialize performance monitoring
    ui.alert('Setting up performance monitoring...');
    if (!props.getProperty('PERFORMANCE_LOG')) {
      props.setProperty('PERFORMANCE_LOG', '{}');
      status.push('‚úÖ Performance monitoring initialized');
    } else {
      status.push('‚úÖ Performance monitoring already active');
    }

    // 3. Create performance monitoring sheet
    if (typeof createPerformanceMonitoringSheet === 'function') {
      createPerformanceMonitoringSheet();
      status.push('‚úÖ Performance dashboard created');
    }

    // 4. Set up daily backups (optional)
    const setupBackups = ui.alert(
      'Setup Automated Backups?',
      'Would you like to set up automated daily backups?\n\n' +
      'Backups will run every day at 2:00 AM.',
      ui.ButtonSet.YES_NO
    );

    if (setupBackups === ui.Button.YES) {
      if (typeof setupDailyBackupTrigger === 'function') {
        setupDailyBackupTrigger();
        status.push('‚úÖ Daily backup trigger created');
      }
    } else {
      status.push('‚è≠Ô∏è Daily backups skipped (can be set up later)');
    }

    // 5. Initialize caches
    const cache = CacheService.getScriptCache();
    status.push('‚úÖ Cache service ready');

    // Show summary
    ui.alert(
      'Phase 6 Initialization Complete!',
      status.join('\n') + '\n\n' +
      'All Phase 6 features are now active and ready to use.',
      ui.ButtonSet.OK
    );

    // Log success
    if (typeof auditLog === 'function') {
      auditLog('PHASE6_INIT', {
        status: 'SUCCESS',
        features: status.length
      });
    }

  } catch (error) {
    ui.alert(
      'Initialization Error',
      `Phase 6 initialization encountered an error:\n\n${error.message}\n\n` +
      `Partial initialization completed:\n${status.join('\n')}`,
      ui.ButtonSet.OK
    );

    if (typeof logError === 'function') {
      logError(error, 'initializePhase6Features', 'ERROR');
    }
  }
}

/**
 * Get Phase 6 feature status
 * @returns {Object} Status of all Phase 6 features
 */
function getPhase6Status() {
  const props = PropertiesService.getScriptProperties();

  const status = {
    // Backup system
    backupConfigured: !!props.getProperty('BACKUP_FOLDER_ID'),
    lastBackup: props.getProperty('LAST_BACKUP_TIMESTAMP'),

    // Performance monitoring
    performanceMonitoring: !!props.getProperty('PERFORMANCE_LOG'),

    // Idempotent operations
    idempotentKeys: props.getProperty('IDEMPOTENT_KEYS'),

    // Chart lazy loading
    chartCacheActive: true, // Always available

    // Active locks (if any)
    activeLocks: checkConcurrentOperations(),

    // Feature counts
    totalFeatures: 9,
    activeFeatures: 0
  };

  // Count active features
  if (status.backupConfigured) status.activeFeatures++;
  if (status.performanceMonitoring) status.activeFeatures++;
  status.activeFeatures++; // Chart lazy loading always active
  status.activeFeatures++; // Graceful degradation always active
  status.activeFeatures++; // Distributed locks always available
  status.activeFeatures++; // Transaction rollback always available
  status.activeFeatures++; // Idempotent operations always available
  status.activeFeatures++; // Batch recalc always available
  status.activeFeatures++; // Optimized rebuild always available

  return status;
}

/**
 * Show Phase 6 feature status in UI
 */
function showPhase6Status() {
  const ui = SpreadsheetApp.getUi();
  const status = getPhase6Status();

  let message = 'PHASE 6 FEATURE STATUS\n\n';
  message += `Active Features: ${status.activeFeatures} / ${status.totalFeatures}\n\n`;

  message += '‚úÖ Batch Grievance Recalculation\n';
  message += '‚úÖ Transaction Rollback System\n';
  message += `${status.backupConfigured ? '‚úÖ' : '‚ö†Ô∏è'} Incremental Backup System`;

  if (status.lastBackup) {
    const lastBackupDate = new Date(parseInt(status.lastBackup));
    message += ` (Last: ${lastBackupDate.toLocaleString()})`;
  }

  message += '\n';
  message += '‚úÖ Distributed Locks\n';
  message += '‚úÖ Graceful Degradation Framework\n';
  message += '‚úÖ Optimized Dashboard Rebuild\n';
  message += '‚úÖ Idempotent Operations\n';
  message += `${status.performanceMonitoring ? '‚úÖ' : '‚ö†Ô∏è'} Performance Monitoring\n`;
  message += '‚úÖ Lazy Load Charts\n';

  if (status.activeLocks.active) {
    message += `\n‚ö†Ô∏è Active Operations: ${status.activeLocks.locks.length}\n`;
  }

  ui.alert('Phase 6 Status', message, ui.ButtonSet.OK);
}

/**
 * Run Phase 6 health check
 * Tests all critical Phase 6 features
 */
function runPhase6HealthCheck() {
  const ui = SpreadsheetApp.getUi();

  ui.alert('Running Phase 6 health check...');

  const results = {
    passed: [],
    failed: [],
    warnings: []
  };

  try {
    // Test 1: Batch recalculation
    try {
      if (typeof recalcAllGrievancesBatched === 'function') {
        results.passed.push('‚úÖ Batch recalculation available');
      } else {
        results.failed.push('‚ùå Batch recalculation not found');
      }
    } catch (e) {
      results.failed.push('‚ùå Batch recalculation error: ' + e.message);
    }

    // Test 2: Transaction system
    try {
      const txn = new Transaction(SpreadsheetApp.getActiveSpreadsheet());
      results.passed.push('‚úÖ Transaction system available');
    } catch (e) {
      results.failed.push('‚ùå Transaction system error: ' + e.message);
    }

    // Test 3: Backup system
    try {
      const props = PropertiesService.getScriptProperties();
      if (props.getProperty('BACKUP_FOLDER_ID')) {
        results.passed.push('‚úÖ Backup system configured');
      } else {
        results.warnings.push('‚ö†Ô∏è Backup folder not configured');
      }
    } catch (e) {
      results.failed.push('‚ùå Backup system error: ' + e.message);
    }

    // Test 4: Distributed locks
    try {
      const lock = new DistributedLock('test');
      results.passed.push('‚úÖ Distributed locks available');
    } catch (e) {
      results.failed.push('‚ùå Distributed locks error: ' + e.message);
    }

    // Test 5: Performance monitoring
    try {
      if (typeof logPerformanceMetric === 'function') {
        logPerformanceMetric('health_check_test', 100);
        results.passed.push('‚úÖ Performance monitoring working');
      } else {
        results.failed.push('‚ùå Performance monitoring not found');
      }
    } catch (e) {
      results.failed.push('‚ùå Performance monitoring error: ' + e.message);
    }

    // Test 6: Graceful degradation
    try {
      if (typeof withGracefulDegradation === 'function') {
        results.passed.push('‚úÖ Graceful degradation available');
      } else {
        results.failed.push('‚ùå Graceful degradation not found');
      }
    } catch (e) {
      results.failed.push('‚ùå Graceful degradation error: ' + e.message);
    }

    // Display results
    let message = 'PHASE 6 HEALTH CHECK RESULTS\n\n';

    message += `Passed: ${results.passed.length}\n`;
    message += `Failed: ${results.failed.length}\n`;
    message += `Warnings: ${results.warnings.length}\n\n`;

    if (results.passed.length > 0) {
      message += 'PASSED:\n' + results.passed.join('\n') + '\n\n';
    }

    if (results.warnings.length > 0) {
      message += 'WARNINGS:\n' + results.warnings.join('\n') + '\n\n';
    }

    if (results.failed.length > 0) {
      message += 'FAILED:\n' + results.failed.join('\n') + '\n\n';
    }

    const overall = results.failed.length === 0 ? '‚úÖ HEALTHY' : '‚ùå ISSUES FOUND';
    message += `\nOverall Status: ${overall}`;

    ui.alert('Health Check Complete', message, ui.ButtonSet.OK);

  } catch (error) {
    ui.alert(
      'Health Check Error',
      `Health check failed: ${error.message}`,
      ui.ButtonSet.OK
    );
  }
}

/**
 * Menu functions
 */
function INITIALIZE_PHASE6() {
  initializePhase6Features();
}

function SHOW_PHASE6_STATUS() {
  showPhase6Status();
}

function RUN_PHASE6_HEALTH_CHECK() {
  runPhase6HealthCheck();
}



// ================================================================================
// MODULE: PredictiveAnalytics.gs
// Source: PredictiveAnalytics.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * PREDICTIVE ANALYTICS
 * ------------------------------------------------------------------------====
 *
 * Forecasts trends and provides actionable insights
 * Features:
 * - Grievance volume forecasting
 * - Issue type trend analysis
 * - Seasonal pattern detection
 * - Steward workload predictions
 * - Risk identification
 * - Anomaly detection
 * - Actionable recommendations
 */

/**
 * Analyzes trends and generates predictions
 * @returns {Object} Analytics results
 */
function performPredictiveAnalysis() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

    if (!grievanceSheet) {
      throw new Error('Grievance Log sheet not found');
    }

    const lastRow = grievanceSheet.getLastRow();

    if (lastRow < 2) {
      return {
        error: 'Insufficient data for analysis. Please add grievance data to generate predictions.'
      };
    }

    const data = grievanceSheet.getRange(2, 1, lastRow - 1, GRIEVANCE_COLS.NEXT_ACTION_DUE).getValues();

    const analytics = {
      volumeTrend: analyzeVolumeTrend(data),
      issueTypeTrends: analyzeIssueTypeTrends(data),
      seasonalPatterns: detectSeasonalPatterns(data),
      resolutionTimeTrend: analyzeResolutionTimeTrend(data),
      stewardWorkloadForecast: forecastStewardWorkload(data),
      riskFactors: identifyRiskFactors(data),
      anomalies: detectAnomalies(data),
      recommendations: generateRecommendations(data)
    };

    return analytics;
  } catch (error) {
    Logger.log('Error in performPredictiveAnalysis: ' + error.message);
    return {
      error: 'Failed to perform predictive analysis: ' + error.message
    };
  }
}

/**
 * Analyzes grievance volume trend
 * @param {Array} data - Grievance data
 * @returns {Object} Volume trend analysis
 */
function analyzeVolumeTrend(data) {
  try {
    // Group by month
    const monthlyVolumes = {};

    data.forEach(function(row) {
      const filedDate = row[GRIEVANCE_COLS.DATE_FILED - 1];

      if (!filedDate) return;

      const monthKey = `${filedDate.getFullYear()}-${String(filedDate.getMonth() + 1).padStart(2, '0')}`;

      monthlyVolumes[monthKey] = (monthlyVolumes[monthKey] || 0) + 1;
    });

    // Convert to array and sort
    const months = Object.keys(monthlyVolumes).sort();
    const volumes = months.map(function(m) { return monthlyVolumes[m]; });

    // Calculate trend (simple linear regression)
    const trend = calculateLinearTrend(volumes);

    // Forecast next 3 months
    const forecast = [];
    for (let i = 1; i <= 3; i++) {
      forecast.push(Math.round(trend.slope * (volumes.length + i) + trend.intercept));
    }

    return {
      currentMonthVolume: volumes[volumes.length - 1] || 0,
      previousMonthVolume: volumes[volumes.length - 2] || 0,
      trend: trend.slope > 0 ? 'increasing' : trend.slope < 0 ? 'decreasing' : 'stable',
      trendPercentage: Math.abs(trend.slope),
      forecast: forecast,
      monthlyVolumes: monthlyVolumes
    };
  } catch (error) {
    Logger.log('Error in analyzeVolumeTrend: ' + error.message);
    return {
      currentMonthVolume: 0,
      previousMonthVolume: 0,
      trend: 'unknown',
      trendPercentage: 0,
      forecast: [0, 0, 0],
      monthlyVolumes: {},
      error: error.message
    };
  }
}

/**
 * Analyzes issue type trends
 * @param {Array} data - Grievance data
 * @returns {Object} Issue type trends
 */
function analyzeIssueTypeTrends(data) {
  try {
    const issueTypesByMonth = {};

    data.forEach(function(row) {
      const filedDate = row[GRIEVANCE_COLS.DATE_FILED - 1];
      const issueType = row[GRIEVANCE_COLS.ISSUE_CATEGORY - 1];

      if (!filedDate || !issueType) return;

      const monthKey = `${filedDate.getFullYear()}-${String(filedDate.getMonth() + 1).padStart(2, '0')}`;

      if (!issueTypesByMonth[monthKey]) {
        issueTypesByMonth[monthKey] = {};
      }

      issueTypesByMonth[monthKey][issueType] = (issueTypesByMonth[monthKey][issueType] || 0) + 1;
    });

    // Find trending issue types (increasing over time)
    const trendingIssues = {};
    const months = Object.keys(issueTypesByMonth).sort();

    if (months.length >= 3) {
      const recentMonths = months.slice(-3);
      const olderMonths = months.slice(0, -3);

      const recentCounts = {};
      const olderCounts = {};

      recentMonths.forEach(function(month) {
        Object.entries(issueTypesByMonth[month]).forEach(function([type, count]) {
          recentCounts[type] = (recentCounts[type] || 0) + count;
        });
      });

      olderMonths.forEach(function(month) {
        Object.entries(issueTypesByMonth[month]).forEach(function([type, count]) {
          olderCounts[type] = (olderCounts[type] || 0) + count;
        });
      });

      Object.keys(recentCounts).forEach(function(type) {
        const recentAvg = recentCounts[type] / recentMonths.length;
        const olderAvg = olderCounts[type] ? olderCounts[type] / olderMonths.length : 0;

        if (recentAvg > olderAvg * 1.2) {
          trendingIssues[type] = {
            recentAverage: recentAvg.toFixed(1),
            olderAverage: olderAvg.toFixed(1),
            percentIncrease: olderAvg > 0 ? (((recentAvg - olderAvg) / olderAvg) * 100).toFixed(1) : 100
          };
        }
      });
    }

    return {
      trendingUp: trendingIssues,
      monthlyBreakdown: issueTypesByMonth
    };
  } catch (error) {
    Logger.log('Error in analyzeIssueTypeTrends: ' + error.message);
    return {
      trendingUp: {},
      monthlyBreakdown: {},
      error: error.message
    };
  }
}

/**
 * Detects seasonal patterns
 * @param {Array} data - Grievance data
 * @returns {Object} Seasonal patterns
 */
function detectSeasonalPatterns(data) {
  const quarterlyVolumes = { Q1: 0, Q2: 0, Q3: 0, Q4: 0 };

  data.forEach(function(row) {
    const filedDate = row[GRIEVANCE_COLS.DATE_FILED - 1];

    if (!filedDate) return;

    const quarter = Math.floor(filedDate.getMonth() / 3) + 1;
    quarterlyVolumes[`Q${quarter}`]++;
  });

  // Find peak quarter
  let peakQuarter = 'Q1';
  let peakVolume = 0;

  Object.entries(quarterlyVolumes).forEach(function([quarter, volume]) {
    if (volume > peakVolume) {
      peakQuarter = quarter;
      peakVolume = volume;
    }
  });

  return {
    quarterlyVolumes: quarterlyVolumes,
    peakQuarter: peakQuarter,
    peakVolume: peakVolume,
    hasSeasonality: Math.max(...Object.values(quarterlyVolumes)) > Math.min(...Object.values(quarterlyVolumes)) * 1.5
  };
}

/**
 * Analyzes resolution time trend
 * @param {Array} data - Grievance data
 * @returns {Object} Resolution time analysis
 */
function analyzeResolutionTimeTrend(data) {
  const resolutionTimes = [];

  data.forEach(function(row) {
    const filedDate = row[GRIEVANCE_COLS.DATE_FILED - 1];
    const closedDate = row[GRIEVANCE_COLS.DATE_CLOSED - 1];

    if (filedDate && closedDate && closedDate > filedDate) {
      const days = Math.floor((closedDate - filedDate) / (1000 * 60 * 60 * 24));
      resolutionTimes.push(days);
    }
  });

  if (resolutionTimes.length === 0) {
    return {
      average: 0,
      median: 0,
      trend: 'insufficient_data'
    };
  }

  // Sort for median
  resolutionTimes.sort(function(a, b) { return a - b; });

  const average = resolutionTimes.reduce(function(sum, val) { return sum + val; }, 0) / resolutionTimes.length;
  const median = resolutionTimes[Math.floor(resolutionTimes.length / 2)];

  // Recent vs older comparison
  const recent = resolutionTimes.slice(-10);
  const older = resolutionTimes.slice(0, -10);

  const recentAvg = recent.reduce(function(sum, val) { return sum + val; }, 0) / recent.length;
  const olderAvg = older.length > 0 ? older.reduce(function(sum, val) { return sum + val; }, 0) / older.length : recentAvg;

  return {
    average: Math.round(average),
    median: median,
    trend: recentAvg > olderAvg ? 'increasing' : recentAvg < olderAvg ? 'decreasing' : 'stable',
    recentAverage: Math.round(recentAvg),
    olderAverage: Math.round(olderAvg)
  };
}

/**
 * Forecasts steward workload
 * @param {Array} data - Grievance data
 * @returns {Object} Workload forecast
 */
function forecastStewardWorkload(data) {
  const stewardCases = {};

  data.forEach(function(row) {
    const steward = row[GRIEVANCE_COLS.STEWARD - 1];
    const status = row[GRIEVANCE_COLS.STATUS - 1];

    if (steward && status === 'Open') {
      stewardCases[steward] = (stewardCases[steward] || 0) + 1;
    }
  });

  // Identify overloaded stewards (>15 cases)
  const overloaded = [];
  const underutilized = [];

  Object.entries(stewardCases).forEach(function([steward, count]) {
    if (count > 15) {
      overloaded.push({ steward, caseload: count });
    } else if (count < 3) {
      underutilized.push({ steward, caseload: count });
    }
  });

  return {
    overloaded: overloaded,
    underutilized: underutilized,
    balanceRecommendation: overloaded.length > 0 && underutilized.length > 0
      ? 'Redistribute cases from overloaded to underutilized stewards'
      : 'Workload is relatively balanced'
  };
}

/**
 * Identifies risk factors
 * @param {Array} data - Grievance data
 * @returns {Array} Risk factors
 */
function identifyRiskFactors(data) {
  const risks = [];
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  // Check for overdue cases
  let overdueCount = 0;
  data.forEach(function(row) {
    const nextActionDue = row[GRIEVANCE_COLS.NEXT_ACTION_DUE - 1];
    const daysToDeadline = nextActionDue ? Math.floor((new Date(nextActionDue) - today) / (1000 * 60 * 60 * 24)) : null;
    if (daysToDeadline !== null && daysToDeadline < 0) overdueCount++;
  });

  if (overdueCount > 0) {
    risks.push({
      type: 'Overdue Cases',
      severity: overdueCount > 10 ? 'HIGH' : overdueCount > 5 ? 'MEDIUM' : 'LOW',
      description: `${overdueCount} grievance(s) are overdue`,
      action: 'Review and prioritize overdue cases immediately'
    });
  }

  // Check for cases with no steward assigned
  let unassignedCount = 0;
  data.forEach(function(row) {
    const steward = row[GRIEVANCE_COLS.STEWARD - 1];
    const status = row[GRIEVANCE_COLS.STATUS - 1];
    if (!steward && status === 'Open') unassignedCount++;
  });

  if (unassignedCount > 0) {
    risks.push({
      type: 'Unassigned Cases',
      severity: unassignedCount > 5 ? 'HIGH' : 'MEDIUM',
      description: `${unassignedCount} open grievance(s) have no assigned steward`,
      action: 'Use auto-assignment to assign stewards'
    });
  }

  // Check for high volume increase
  const volumeTrend = analyzeVolumeTrend(data);
  if (volumeTrend.trend === 'increasing' && volumeTrend.trendPercentage > 20) {
    risks.push({
      type: 'Volume Surge',
      severity: 'MEDIUM',
      description: `Grievance volume trending upward by ${volumeTrend.trendPercentage.toFixed(1)}%`,
      action: 'Prepare for increased caseload, consider additional steward training'
    });
  }

  return risks;
}

/**
 * Detects anomalies in data
 * @param {Array} data - Grievance data
 * @returns {Array} Anomalies detected
 */
function detectAnomalies(data) {
  const anomalies = [];

  // Check for unusual spike in last month
  const monthlyVolumes = {};
  data.forEach(function(row) {
    const filedDate = row[GRIEVANCE_COLS.DATE_FILED - 1];
    if (!filedDate) return;

    const monthKey = `${filedDate.getFullYear()}-${String(filedDate.getMonth() + 1).padStart(2, '0')}`;
    monthlyVolumes[monthKey] = (monthlyVolumes[monthKey] || 0) + 1;
  });

  const volumes = Object.values(monthlyVolumes);
  if (volumes.length >= 3) {
    const average = volumes.slice(0, -1).reduce(function(sum, val) { return sum + val; }, 0) / (volumes.length - 1);
    const latest = volumes[volumes.length - 1];

    if (latest > average * 1.5) {
      anomalies.push({
        type: 'Volume Spike',
        description: `Current month has ${latest} cases vs average of ${average.toFixed(1)}`,
        impact: 'May indicate systemic issue or policy change'
      });
    }
  }

  // Check for concentration of cases in one location
  const locationCounts = {};
  data.forEach(function(row) {
    const location = row[GRIEVANCE_COLS.LOCATION - 1];
    if (location) {
      locationCounts[location] = (locationCounts[location] || 0) + 1;
    }
  });

  const totalCases = Object.values(locationCounts).reduce(function(sum, val) { return sum + val; }, 0);
  Object.entries(locationCounts).forEach(function([location, count]) {
    if (count > totalCases * 0.4) {
      anomalies.push({
        type: 'Location Concentration',
        description: `${location} has ${count} cases (${((count / totalCases) * 100).toFixed(1)}% of all cases)`,
        impact: 'May indicate location-specific issues requiring attention'
      });
    }
  });

  return anomalies;
}

/**
 * Generates actionable recommendations
 * @param {Array} data - Grievance data
 * @returns {Array} Recommendations
 */
function generateRecommendations(data) {
  const recommendations = [];

  // Based on volume trend
  const volumeTrend = analyzeVolumeTrend(data);
  if (volumeTrend.trend === 'increasing') {
    recommendations.push({
      priority: 'HIGH',
      category: 'Capacity Planning',
      recommendation: 'Grievance volume is increasing. Consider recruiting and training additional stewards.',
      expectedImpact: 'Prevent case backlog and maintain service quality'
    });
  }

  // Based on resolution time
  const resolutionTrend = analyzeResolutionTimeTrend(data);
  if (resolutionTrend.average > 30) {
    recommendations.push({
      priority: 'MEDIUM',
      category: 'Process Improvement',
      recommendation: `Average resolution time is ${resolutionTrend.average} days. Implement workflow automation and deadline reminders.`,
      expectedImpact: 'Reduce resolution time by 20-30%'
    });
  }

  // Based on workload
  const workloadForecast = forecastStewardWorkload(data);
  if (workloadForecast.overloaded.length > 0) {
    recommendations.push({
      priority: 'HIGH',
      category: 'Workload Management',
      recommendation: `${workloadForecast.overloaded.length} steward(s) are overloaded. ${workloadForecast.balanceRecommendation}`,
      expectedImpact: 'Prevent steward burnout and improve case handling'
    });
  }

  // Based on trending issues
  const issueTrends = analyzeIssueTypeTrends(data);
  const trendingIssueCount = Object.keys(issueTrends.trendingUp).length;
  if (trendingIssueCount > 0) {
    const topTrending = Object.keys(issueTrends.trendingUp)[0];
    recommendations.push({
      priority: 'MEDIUM',
      category: 'Root Cause Analysis',
      recommendation: `${topTrending} cases are trending upward. Conduct root cause analysis and consider preventive measures.`,
      expectedImpact: 'Reduce future grievances through proactive intervention'
    });
  }

  return recommendations;
}

/**
 * Calculates simple linear trend
 * @param {Array} values - Data points
 * @returns {Object} Trend line parameters
 */
function calculateLinearTrend(values) {
  const n = values.length;
  if (n < 2) return { slope: 0, intercept: values[0] || 0 };

  let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;

  for (let i = 0; i < n; i++) {
    sumX += i;
    sumY += values[i];
    sumXY += i * values[i];
    sumX2 += i * i;
  }

  const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
  const intercept = (sumY - slope * sumX) / n;

  return { slope, intercept };
}

/**
 * Shows predictive analytics dashboard
 */
function showPredictiveAnalyticsDashboard() {
  const ui = SpreadsheetApp.getUi();

  SpreadsheetApp.getActiveSpreadsheet().toast(
    'üîÆ Analyzing trends...',
    'Predictive Analytics',
    -1
  );

  try {
    const analytics = performPredictiveAnalysis();

    if (analytics.error) {
      ui.alert('‚ö†Ô∏è ' + analytics.error);
      return;
    }

    const html = createAnalyticsDashboardHTML(analytics);
    const htmlOutput = HtmlService.createHtmlOutput(html)
      .setWidth(900)
      .setHeight(700);

    ui.showModalDialog(htmlOutput, 'üîÆ Predictive Analytics Dashboard');

  } catch (error) {
    ui.alert('‚ùå Error', error.message, ui.ButtonSet.OK);
  }
}

/**
 * Creates HTML for analytics dashboard
 * @param {Object} analytics - Analytics results
 * @returns {string} HTML content
 */
function createAnalyticsDashboardHTML(analytics) {
  const risksHTML = analytics.riskFactors.length > 0
    ? analytics.riskFactors.map(function(risk) { return `
        <div class="risk-item severity-${risk.severity.toLowerCase()}">
          <div class="risk-header">
            <span class="risk-type">${risk.type}</span>
            <span class="risk-severity">${risk.severity}</span>
          </div>
          <div class="risk-desc">${risk.description}</div>
          <div class="risk-action">‚ö° ${risk.action}</div>
        </div>
      `; }).join('')
    : '<p>No significant risks identified. ‚úÖ</p>';

  const recommendationsHTML = analytics.recommendations.length > 0
    ? analytics.recommendations.map(function(rec) { return `
        <div class="recommendation priority-${rec.priority.toLowerCase()}">
          <div class="rec-header">
            <span class="rec-category">${rec.category}</span>
            <span class="rec-priority">${rec.priority}</span>
          </div>
          <div class="rec-text">${rec.recommendation}</div>
          <div class="rec-impact">üìä ${rec.expectedImpact}</div>
        </div>
      `; }).join('')
    : '<p>No specific recommendations at this time.</p>';

  const anomaliesHTML = analytics.anomalies.length > 0
    ? analytics.anomalies.map(function(anomaly) { return `
        <div class="anomaly-item">
          <div class="anomaly-type">${anomaly.type}</div>
          <div class="anomaly-desc">${anomaly.description}</div>
          <div class="anomaly-impact">${anomaly.impact}</div>
        </div>
      `; }).join('')
    : '<p>No anomalies detected. ‚úÖ</p>';

  return `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: 'Roboto', Arial, sans-serif; padding: 20px; margin: 0; background: #f5f5f5; }
    .container { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-height: 650px; overflow-y: auto; }
    h2 { color: #1a73e8; margin-top: 0; border-bottom: 3px solid #1a73e8; padding-bottom: 10px; }
    h3 { color: #333; margin-top: 25px; border-bottom: 2px solid #e0e0e0; padding-bottom: 8px; }
    .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
    .summary-card { background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #1a73e8; }
    .summary-label { font-size: 12px; color: #666; text-transform: uppercase; }
    .summary-value { font-size: 24px; font-weight: bold; color: #333; margin: 5px 0; }
    .summary-trend { font-size: 13px; color: #666; }
    .trend-up { color: #f44336; }
    .trend-down { color: #4caf50; }
    .trend-stable { color: #9e9e9e; }
    .risk-item { background: #fff3e0; padding: 15px; margin: 10px 0; border-radius: 4px; border-left: 4px solid; }
    .risk-item.severity-high { border-left-color: #f44336; background: #ffebee; }
    .risk-item.severity-medium { border-left-color: #ff9800; background: #fff3e0; }
    .risk-item.severity-low { border-left-color: #ffeb3b; background: #fffde7; }
    .risk-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .risk-type { font-weight: bold; color: #333; }
    .risk-severity { background: white; padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }
    .risk-desc { margin: 5px 0; color: #555; }
    .risk-action { margin-top: 10px; padding: 10px; background: white; border-radius: 4px; font-size: 13px; }
    .recommendation { background: #e8f5e9; padding: 15px; margin: 10px 0; border-radius: 4px; border-left: 4px solid #4caf50; }
    .recommendation.priority-high { border-left-color: #f44336; background: #ffebee; }
    .recommendation.priority-medium { border-left-color: #ff9800; background: #fff3e0; }
    .rec-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .rec-category { font-weight: bold; color: #333; }
    .rec-priority { background: white; padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }
    .rec-text { margin: 5px 0; color: #555; }
    .rec-impact { margin-top: 10px; padding: 10px; background: white; border-radius: 4px; font-size: 13px; }
    .anomaly-item { background: #e3f2fd; padding: 15px; margin: 10px 0; border-radius: 4px; border-left: 4px solid #2196f3; }
    .anomaly-type { font-weight: bold; color: #1976d2; margin-bottom: 5px; }
    .anomaly-desc { color: #555; margin: 5px 0; }
    .anomaly-impact { margin-top: 10px; padding: 10px; background: white; border-radius: 4px; font-size: 13px; font-style: italic; }
  </style>
</head>
<body>
  <div class="container">
    <h2>üîÆ Predictive Analytics Dashboard</h2>

    <div class="summary-grid">
      <div class="summary-card">
        <div class="summary-label">Volume Trend</div>
        <div class="summary-value trend-${analytics.volumeTrend.trend === 'increasing' ? 'up' : analytics.volumeTrend.trend === 'decreasing' ? 'down' : 'stable'}">
          ${analytics.volumeTrend.currentMonthVolume}
        </div>
        <div class="summary-trend">
          ${analytics.volumeTrend.trend === 'increasing' ? 'üìà Increasing' : analytics.volumeTrend.trend === 'decreasing' ? 'üìâ Decreasing' : '‚û°Ô∏è Stable'}
        </div>
      </div>

      <div class="summary-card">
        <div class="summary-label">Avg Resolution Time</div>
        <div class="summary-value">${analytics.resolutionTimeTrend.average} days</div>
        <div class="summary-trend">
          ${analytics.resolutionTimeTrend.trend === 'increasing' ? '‚ö†Ô∏è Increasing' : analytics.resolutionTimeTrend.trend === 'decreasing' ? '‚úÖ Improving' : '‚û°Ô∏è Stable'}
        </div>
      </div>

      <div class="summary-card">
        <div class="summary-label">Identified Risks</div>
        <div class="summary-value">${analytics.riskFactors.length}</div>
        <div class="summary-trend">
          ${analytics.riskFactors.length === 0 ? '‚úÖ No risks' : `‚ö†Ô∏è Needs attention`}
        </div>
      </div>
    </div>

    <h3>üö® Risk Factors</h3>
    ${risksHTML}

    <h3>üí° Recommendations</h3>
    ${recommendationsHTML}

    <h3>üîç Anomalies Detected</h3>
    ${anomaliesHTML}

    <h3>üìä Forecast (Next 3 Months)</h3>
    <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 10px 0;">
      <strong>Projected Volume:</strong><br>
      Month 1: ${analytics.volumeTrend.forecast[0]} cases<br>
      Month 2: ${analytics.volumeTrend.forecast[1]} cases<br>
      Month 3: ${analytics.volumeTrend.forecast[2]} cases
    </div>

    ${analytics.seasonalPatterns.hasSeasonality ? `
    <h3>üìÖ Seasonal Patterns</h3>
    <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 10px 0;">
      <strong>Peak Season:</strong> ${analytics.seasonalPatterns.peakQuarter} (${analytics.seasonalPatterns.peakVolume} cases)<br>
      <strong>Quarterly Breakdown:</strong><br>
      Q1: ${analytics.seasonalPatterns.quarterlyVolumes.Q1} |
      Q2: ${analytics.seasonalPatterns.quarterlyVolumes.Q2} |
      Q3: ${analytics.seasonalPatterns.quarterlyVolumes.Q3} |
      Q4: ${analytics.seasonalPatterns.quarterlyVolumes.Q4}
    </div>
    ` : ''}
  </div>
</body>
</html>
  `;
}



// ================================================================================
// MODULE: ReorganizedMenu.gs
// Source: ReorganizedMenu.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * REORGANIZED MENU SYSTEM
 * ------------------------------------------------------------------------====
 *
 * Organizes dashboard menus into three categories:
 * 1. Average User - Daily operations and common tasks
 * 2. Sheet Manager - Data management, performance, integrity, automations
 * 3. Administrator - System admin, seed functions, health monitoring
 *
 * To use this menu instead of the default one:
 * - Rename the existing onOpen() function to onOpen_OLD()
 * - Rename this onOpen_Reorganized() function to onOpen()
 */

function onOpen_Reorganized() {
  const ui = SpreadsheetApp.getUi();

  // ------------ AVERAGE USER MENU ------------
  ui.createMenu("üë§ Dashboard")
    .addItem("üîÑ Refresh All", "refreshCalculations")
    .addSeparator()
    .addSubMenu(ui.createMenu("üìä Dashboards")
      .addItem("üéØ Unified Operations Monitor", "showUnifiedOperationsMonitor")
      .addItem("üìä Main Dashboard", "goToDashboard")
      .addItem("‚ú® Interactive Dashboard", "openInteractiveDashboard")
      .addItem("üîÑ Refresh Interactive Dashboard", "rebuildInteractiveDashboard"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üîç Search & Lookup")
      .addItem("üîç Search Members", "showMemberSearch")
      .addItem("üîç Quick Member Search", "quickMemberSearch"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üìã Grievance Tools")
      .addItem("‚ûï Start New Grievance", "showStartGrievanceDialog")
      .addItem("üîÑ Grievance Float Toggle", "toggleGrievanceFloat")
      .addItem("üéõÔ∏è Float Control Panel", "showGrievanceFloatPanel")
      .addSeparator()
      .addItem("üì® View Message Trail", "showMessageTrail")
      .addItem("üîÑ Refresh Admin Highlights", "refreshAdminMessageHighlights"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üìÅ Google Drive")
      .addItem("üìÅ Setup Folder for Grievance", "setupDriveFolderForGrievance")
      .addItem("üìé Upload Files", "showFileUploadDialog")
      .addItem("üìÇ Show Grievance Files", "showGrievanceFiles"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üìß Communications")
      .addItem("üìß Compose Email", "composeGrievanceEmail")
      .addItem("üìù Email Templates", "showEmailTemplateManager")
      .addSeparator()
      .addItem("üìû View Communications Log", "showGrievanceCommunications"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üìä Reports")
      .addItem("üìä Custom Report Builder", "showCustomReportBuilder")
      .addSeparator()
      .addItem("üìÑ Export Grievances to CSV", "exportGrievancesToCSV")
      .addItem("üìÑ Export Members to CSV", "exportMembersToCSV"))
    .addSeparator()
    .addSubMenu(ui.createMenu("‚ôø Accessibility")
      .addItem("‚ôø ADHD Control Panel", "showADHDControlPanel")
      .addItem("üé® Theme Manager", "showThemeManager")
      .addSeparator()
      .addItem("üåô Quick Toggle Dark Mode", "quickToggleDarkMode")
      .addItem("üéØ Activate Focus Mode", "activateFocusMode")
      .addItem("üéØ Deactivate Focus Mode", "deactivateFocusMode"))
    .addSeparator()
    .addSubMenu(ui.createMenu("‚ùì Help & Support")
      .addItem("üìö Getting Started Guide", "showGettingStartedGuide")
      .addItem("‚ùì Help", "showHelp")
      .addItem("‚å®Ô∏è Keyboard Shortcuts", "showKeyboardShortcuts"))
    .addToUi();

  // ------------ SHEET MANAGER MENU ------------
  ui.createMenu("üìä Sheet Manager")
    .addSubMenu(ui.createMenu("üíæ Data Management")
      .addItem("üíæ Backup & Recovery Manager", "showBackupManager")
      .addSeparator()
      .addItem("üíæ Create Backup Now", "createBackup")
      .addItem("‚úÖ Enable Automated Backups", "setupAutomatedBackups")
      .addItem("üîï Disable Automated Backups", "disableAutomatedBackups")
      .addSeparator()
      .addItem("üìä View Backup Log", "navigateToBackupLog"))
    .addSeparator()
    .addSubMenu(ui.createMenu("‚ö° Performance")
      .addItem("üóÑÔ∏è Cache Status Dashboard", "showCacheStatusDashboard")
      .addSeparator()
      .addItem("üî• Warm Up All Caches", "warmUpCaches")
      .addItem("üóëÔ∏è Clear All Caches", "invalidateAllCaches"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üîí Data Integrity")
      .addItem("üìä Data Quality Dashboard", "showDataQualityDashboard")
      .addItem("üîç Check Referential Integrity", "checkReferentialIntegrity")
      .addSeparator()
      .addItem("üìù Create Change Log Sheet", "createChangeLogSheet")
      .addItem("üÜî Generate Next Member ID", "showNextMemberID")
      .addItem("üÜî Generate Next Grievance ID", "showNextGrievanceID"))
    .addSeparator()
    .addSubMenu(ui.createMenu("ü§ñ Automations")
      .addItem("üì¨ Notification Settings", "showNotificationSettings")
      .addItem("üìä Report Automation Settings", "showReportAutomationSettings")
      .addSeparator()
      .addItem("‚úÖ Enable Daily Deadline Notifications", "setupDailyDeadlineNotifications")
      .addItem("üîï Disable Deadline Notifications", "disableDailyDeadlineNotifications")
      .addSeparator()
      .addItem("‚úÖ Enable Monthly Reports", "setupMonthlyReports")
      .addItem("‚úÖ Enable Quarterly Reports", "setupQuarterlyReports")
      .addItem("üîï Disable All Reports", "disableAutomatedReports"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üìÅ Google Drive Integration")
      .addItem("üìÅ Batch Create All Folders", "batchCreateGrievanceFolders")
      .addItem("üìÅ Setup Drive Folders", "setupDriveFolderForGrievance"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üìÖ Calendar Integration")
      .addItem("üìÖ Sync Deadlines to Calendar", "syncDeadlinesToCalendar")
      .addItem("üëÄ View Upcoming Deadlines", "showUpcomingDeadlinesFromCalendar")
      .addSeparator()
      .addItem("üóëÔ∏è Clear All Calendar Events", "clearAllCalendarEvents"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üìà Analysis & Insights")
      .addItem("üîÆ Predictive Analytics Dashboard", "showPredictiveAnalyticsDashboard")
      .addItem("üìà Generate Full Analysis", "performPredictiveAnalysis")
      .addItem("üî¨ Root Cause Analysis", "showRootCauseAnalysisDashboard"))
    .addSeparator()
    .addSubMenu(ui.createMenu("‚ö° Batch Operations")
      .addItem("‚ö° Show Batch Operations Menu", "showBatchOperationsMenu")
      .addSeparator()
      .addItem("üë§ Bulk Assign Steward", "batchAssignSteward")
      .addItem("üìä Bulk Update Status", "batchUpdateStatus")
      .addItem("üìÑ Bulk Export to PDF", "batchExportPDF")
      .addItem("üìß Bulk Email Notifications", "batchEmailNotifications")
      .addItem("üìù Bulk Add Notes", "batchAddNotes"))
    .addSeparator()
    .addSubMenu(ui.createMenu("ü§ñ Smart Assignment")
      .addItem("ü§ñ Auto-Assign Steward", "showAutoAssignDialog")
      .addItem("üì¶ Batch Auto-Assign", "batchAutoAssign")
      .addSeparator()
      .addItem("üë• Steward Workload Dashboard", "showStewardWorkloadDashboard"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üìö Knowledge Base")
      .addItem("üìö Search FAQ", "showFAQSearch")
      .addItem("‚ûï Add New FAQ", "showFAQAdmin")
      .addSeparator()
      .addItem("üìù Create FAQ Database", "createFAQSheet"))
    .addToUi();

  // ------------ SETUP MENU ------------
  ui.createMenu("üîß Setup")
    .addSubMenu(ui.createMenu("üå± Seed Functions")
      .addSubMenu(ui.createMenu("üë• Seed Members")
        .addItem("Seed Members - Toggle 1 (5,000)", "SEED_MEMBERS_TOGGLE_1")
        .addItem("Seed Members - Toggle 2 (5,000)", "SEED_MEMBERS_TOGGLE_2")
        .addItem("Seed Members - Toggle 3 (5,000)", "SEED_MEMBERS_TOGGLE_3")
        .addItem("Seed Members - Toggle 4 (5,000)", "SEED_MEMBERS_TOGGLE_4")
        .addSeparator()
        .addItem("Seed All 20k Members (Legacy)", "SEED_20K_MEMBERS"))
      .addSubMenu(ui.createMenu("üìã Seed Grievances")
        .addItem("Seed Grievances - Toggle 1 (2,500)", "SEED_GRIEVANCES_TOGGLE_1")
        .addItem("Seed Grievances - Toggle 2 (2,500)", "SEED_GRIEVANCES_TOGGLE_2")
        .addSeparator()
        .addItem("Seed All 5k Grievances (Legacy)", "SEED_5K_GRIEVANCES"))
      .addSeparator()
      .addItem("üìù Add Sample Feedback Entries", "addSampleFeedbackEntries")
      .addSeparator()
      .addItem("üóëÔ∏è Nuke All Seed Data", "nukeSeedData")
      .addItem("Clear All Data", "clearAllData"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üìã Dropdown Configuration")
      .addItem("üìã Setup All Dropdowns", "setupAllDropdowns")
      .addItem("üìã Setup Member Directory Dropdowns", "setupMemberDirectoryDropdowns")
      .addItem("üìã Setup Grievance Log Dropdowns", "setupGrievanceLogDropdowns")
      .addItem("üîÑ Refresh Steward Dropdowns", "refreshStewardDropdowns")
      .addSeparator()
      .addItem("üìà Extend Validations (10k rows)", "extendValidationsForLargeDataset"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üé® Dashboard Setup")
      .addItem("üé® Setup Dashboard Enhancements", "SETUP_DASHBOARD_ENHANCEMENTS")
      .addItem("üìä Populate Analytics Sheets", "populateAllAnalyticsSheets"))
    .addSeparator()
    .addItem("üìù Open Member Google Form", "openMemberGoogleForm")
    .addToUi();

  // ------------ ADMINISTRATOR MENU ------------
  ui.createMenu("‚öôÔ∏è Administrator")
    .addSubMenu(ui.createMenu("‚ö†Ô∏è System Health")
      .addItem("‚ö†Ô∏è Error Dashboard", "showErrorDashboard")
      .addItem("üè• Run Health Check", "performSystemHealthCheck")
      .addSeparator()
      .addItem("üìä View Error Trends", "createErrorTrendReport")
      .addItem("üß™ Test Error Logging", "testErrorLogging"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üî¨ Root Cause Analysis")
      .addItem("üî¨ Root Cause Analysis Dashboard", "showRootCauseAnalysisDashboard"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üîÑ Workflow Management")
      .addItem("üîÑ Workflow Visualizer", "showWorkflowVisualizer")
      .addItem("üîÑ Change Workflow State", "changeWorkflowState")
      .addItem("üìä View Current State", "showCurrentWorkflowState")
      .addSeparator()
      .addItem("üì¶ Batch Update State", "batchUpdateWorkflowState"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üëÅÔ∏è Column Toggles & View")
      .addItem("Toggle Level 2 Member Columns", "toggleLevel2Columns")
      .addItem("Show All Member Columns", "showAllMemberColumns")
      .addSeparator()
      .addItem("üì® Toggle Admin Message Columns", "toggleAdminMessageColumns")
      .addItem("Show All Grievance Columns", "showAllGrievanceColumns")
      .addItem("üîß Setup Admin Message Columns", "setupAdminMessageColumns")
      .addItem("‚ö° Install Admin Message Trigger", "installAdminMessageTrigger")
      .addSeparator()
      .addItem("üîÑ Refresh Grievance Formulas", "refreshGrievanceFormulas")
      .addItem("üîÑ Refresh Dashboard Deadlines", "refreshDashboardDeadlines")
      .addItem("üßπ Cleanup Extra Member Columns", "cleanupMemberDirectoryColumns")
      .addSeparator()
      .addItem("üëÅÔ∏è Hide Diagnostics Tab", "hideDiagnosticsTab")
      .addItem("Reorder Sheets Logically", "reorderSheetsLogically")
      .addItem("Hide Gridlines (Focus Mode)", "hideAllGridlines")
      .addItem("Show Gridlines", "showAllGridlines")
      .addItem("Setup ADHD Defaults", "setupADHDDefaults"))
    .addSeparator()
    .addSubMenu(ui.createMenu("‚Ü©Ô∏è History & Undo")
      .addItem("‚Ü©Ô∏è Undo/Redo History", "showUndoRedoPanel")
      .addItem("‚å®Ô∏è Install Undo Shortcuts", "installUndoRedoShortcuts")
      .addSeparator()
      .addItem("‚Ü©Ô∏è Undo Last Action (Ctrl+Z)", "undoLastAction")
      .addItem("‚Ü™Ô∏è Redo Last Action (Ctrl+Y)", "redoLastAction")
      .addSeparator()
      .addItem("üóëÔ∏è Clear Undo History", "clearUndoHistory"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üì± Mobile & Viewing")
      .addItem("üì± Mobile Dashboard", "showMobileDashboard")
      .addItem("üìã Mobile Grievance List", "showMobileGrievanceList")
      .addSeparator()
      .addItem("üìÑ Paginated Data Viewer", "showPaginatedViewer"))
    .addSeparator()
    .addSubMenu(ui.createMenu("üß™ Testing")
      .addItem("üß™ Test Deadline Notifications", "testDeadlineNotifications")
      .addItem("üß™ Test Monthly Report", "generateMonthlyReport")
      .addItem("üß™ Test Quarterly Report", "generateQuarterlyReport")
      .addSeparator()
      .addItem("üîß Diagnose Setup", "DIAGNOSE_SETUP")
      .addItem("‚öôÔ∏è Shortcuts Configuration", "showKeyboardShortcutsConfig")
      .addItem("F1 Context Help", "showContextHelp"))
    .addToUi();
}



// ================================================================================
// MODULE: RootCauseAnalysis.gs
// Source: RootCauseAnalysis.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * ROOT CAUSE ANALYSIS TOOL
 * ------------------------------------------------------------------------====
 *
 * Identifies systemic issues and patterns in grievances
 * Features:
 * - Pattern detection across dimensions
 * - Clustering analysis (location, manager, issue type)
 * - Timeline analysis for recurring problems
 * - Correlation finding
 * - Actionable recommendations
 * - Visual reports with charts
 * - Export analysis reports
 */

/**
 * Performs comprehensive root cause analysis
 * @returns {Object} Analysis results
 */
function performRootCauseAnalysis() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  const lastRow = grievanceSheet.getLastRow();

  if (lastRow < 2) {
    return { error: 'Insufficient data for analysis' };
  }

  const data = grievanceSheet.getRange(2, 1, lastRow - 1, 28).getValues();

  const analysis = {
    locationClusters: analyzeLocationClusters(data),
    managerPatterns: analyzeManagerPatterns(data),
    issueTypePatterns: analyzeIssueTypePatterns(data),
    temporalPatterns: analyzeTemporalPatterns(data),
    correlations: findCorrelations(data),
    recommendations: generateRCARecommendations(data)
  };

  return analysis;
}

/**
 * Analyzes grievance clustering by location
 * @param {Array} data - Grievance data
 * @returns {Object} Location analysis
 */
function analyzeLocationClusters(data) {
  const locationStats = {};

  data.forEach(function(row) {
    const location = row[GRIEVANCE_COLS.LOCATION - 1];
    if (!location) return;

    if (!locationStats[location]) {
      locationStats[location] = {
        count: 0,
        issueTypes: {},
        units: {},
        resolutionTimes: []
      };
    }

    locationStats[location].count++;

    // Track issue types per location
    const issueType = row[GRIEVANCE_COLS.ISSUE_CATEGORY - 1];
    if (issueType) {
      locationStats[location].issueTypes[issueType] =
        (locationStats[location].issueTypes[issueType] || 0) + 1;
    }

    // Track units per location (grievances don't have manager, using unit as proxy)
    const unit = row[GRIEVANCE_COLS.UNIT - 1];
    if (unit) {
      locationStats[location].units[unit] =
        (locationStats[location].units[unit] || 0) + 1;
    }

    // Track resolution times
    const filedDate = row[GRIEVANCE_COLS.DATE_FILED - 1];
    const closedDate = row[GRIEVANCE_COLS.DATE_CLOSED - 1];
    if (filedDate && closedDate) {
      const resTime = Math.floor((closedDate - filedDate) / (1000 * 60 * 60 * 24));
      locationStats[location].resolutionTimes.push(resTime);
    }
  });

  // Find hotspots (locations with disproportionate grievances)
  const totalGrievances = data.length;
  const hotspots = [];

  Object.entries(locationStats).forEach(function([location, stats]) {
    const percentage = (stats.count / totalGrievances) * 100;

    if (percentage > 15) {
      // If a location has >15% of all grievances, it's a hotspot
      const topIssue = Object.entries(stats.issueTypes)
        .sort(function(a, b) { return b[1] - a[1]; })[0];

      const avgResTime = stats.resolutionTimes.length > 0
        ? stats.resolutionTimes.reduce(function(sum, val) { return sum + val; }, 0) / stats.resolutionTimes.length
        : 0;

      hotspots.push({
        location: location,
        count: stats.count,
        percentage: percentage.toFixed(1),
        topIssueType: topIssue ? topIssue[0] : 'N/A',
        topIssueCount: topIssue ? topIssue[1] : 0,
        avgResolutionTime: Math.round(avgResTime),
        severity: percentage > 25 ? 'HIGH' : 'MEDIUM'
      });
    }
  });

  return {
    totalLocations: Object.keys(locationStats).length,
    hotspots: hotspots.sort(function(a, b) { return b.count - a.count; }),
    allStats: locationStats
  };
}

/**
 * Analyzes patterns by manager
 * @param {Array} data - Grievance data
 * @returns {Object} Manager analysis
 */
function analyzeManagerPatterns(data) {
  // Note: Grievance data uses Steward (AA) not Manager. Analyzing by steward instead.
  const stewardStats = {};

  data.forEach(function(row) {
    const steward = row[GRIEVANCE_COLS.STEWARD - 1];
    if (!steward) return;

    if (!stewardStats[steward]) {
      stewardStats[steward] = {
        count: 0,
        issueTypes: {},
        outcomes: {},
        resolutionTimes: []
      };
    }

    stewardStats[steward].count++;

    // Track issue types
    const issueType = row[GRIEVANCE_COLS.ISSUE_CATEGORY - 1];
    if (issueType) {
      stewardStats[steward].issueTypes[issueType] =
        (stewardStats[steward].issueTypes[issueType] || 0) + 1;
    }

    // Track outcomes
    const status = row[GRIEVANCE_COLS.STATUS - 1];
    if (status) {
      stewardStats[steward].outcomes[status] =
        (stewardStats[steward].outcomes[status] || 0) + 1;
    }

    // Track resolution times
    const filedDate = row[GRIEVANCE_COLS.DATE_FILED - 1];
    const closedDate = row[GRIEVANCE_COLS.DATE_CLOSED - 1];
    if (filedDate && closedDate) {
      const resTime = Math.floor((closedDate - filedDate) / (1000 * 60 * 60 * 24));
      stewardStats[steward].resolutionTimes.push(resTime);
    }
  });

  // Find stewards with high caseloads
  const avgGrievancesPerSteward = data.length / Object.keys(stewardStats).length;
  const highCaseloadStewards = [];

  Object.entries(stewardStats).forEach(function([steward, stats]) {
    if (stats.count > avgGrievancesPerSteward * 2) {
      const topIssue = Object.entries(stats.issueTypes)
        .sort(function(a, b) { return b[1] - a[1]; })[0];

      const avgResTime = stats.resolutionTimes.length > 0
        ? stats.resolutionTimes.reduce(function(sum, val) { return sum + val; }, 0) / stats.resolutionTimes.length
        : 0;

      highCaseloadStewards.push({
        steward: steward,
        count: stats.count,
        comparedToAverage: (stats.count / avgGrievancesPerSteward).toFixed(1) + 'x',
        topIssueType: topIssue ? topIssue[0] : 'N/A',
        avgResolutionTime: Math.round(avgResTime),
        severity: stats.count > avgGrievancesPerSteward * 3 ? 'HIGH' : 'MEDIUM'
      });
    }
  });

  return {
    totalStewards: Object.keys(stewardStats).length,
    avgPerSteward: avgGrievancesPerSteward.toFixed(1),
    highCaseloadStewards: highCaseloadStewards.sort(function(a, b) { return b.count - a.count; }),
    allStats: stewardStats
  };
}

/**
 * Analyzes issue type patterns
 * @param {Array} data - Grievance data
 * @returns {Object} Issue type analysis
 */
function analyzeIssueTypePatterns(data) {
  const issueTypeStats = {};

  data.forEach(function(row) {
    const issueType = row[GRIEVANCE_COLS.ISSUE_CATEGORY - 1];
    if (!issueType) return;

    if (!issueTypeStats[issueType]) {
      issueTypeStats[issueType] = {
        count: 0,
        locations: {},
        stewards: {},
        resolutionTimes: [],
        outcomes: {}
      };
    }

    issueTypeStats[issueType].count++;

    // Track locations
    const location = row[GRIEVANCE_COLS.LOCATION - 1];
    if (location) {
      issueTypeStats[issueType].locations[location] =
        (issueTypeStats[issueType].locations[location] || 0) + 1;
    }

    // Track stewards
    const steward = row[GRIEVANCE_COLS.STEWARD - 1];
    if (steward) {
      issueTypeStats[issueType].stewards[steward] =
        (issueTypeStats[issueType].stewards[steward] || 0) + 1;
    }

    // Track outcomes
    const status = row[GRIEVANCE_COLS.STATUS - 1];
    if (status) {
      issueTypeStats[issueType].outcomes[status] =
        (issueTypeStats[issueType].outcomes[status] || 0) + 1;
    }

    // Track resolution times
    const filedDate = row[GRIEVANCE_COLS.DATE_FILED - 1];
    const closedDate = row[GRIEVANCE_COLS.DATE_CLOSED - 1];
    if (filedDate && closedDate) {
      const resTime = Math.floor((closedDate - filedDate) / (1000 * 60 * 60 * 24));
      issueTypeStats[issueType].resolutionTimes.push(resTime);
    }
  });

  // Identify systemic issues
  const systemicIssues = [];

  Object.entries(issueTypeStats).forEach(function([issueType, stats]) {
    // Check if concentrated in specific locations (>60% in one location)
    const topLocation = Object.entries(stats.locations)
      .sort(function(a, b) { return b[1] - a[1]; })[0];

    const locationConcentration = topLocation
      ? (topLocation[1] / stats.count) * 100
      : 0;

    if (locationConcentration > 60 || stats.count > data.length * 0.15) {
      const avgResTime = stats.resolutionTimes.length > 0
        ? stats.resolutionTimes.reduce(function(sum, val) { return sum + val; }, 0) / stats.resolutionTimes.length
        : 0;

      systemicIssues.push({
        issueType: issueType,
        count: stats.count,
        percentage: ((stats.count / data.length) * 100).toFixed(1),
        primaryLocation: topLocation ? topLocation[0] : 'N/A',
        locationConcentration: locationConcentration.toFixed(1) + '%',
        avgResolutionTime: Math.round(avgResTime),
        isSystemic: locationConcentration > 60 || stats.count > data.length * 0.2
      });
    }
  });

  return {
    totalIssueTypes: Object.keys(issueTypeStats).length,
    systemicIssues: systemicIssues.sort(function(a, b) { return b.count - a.count; }),
    allStats: issueTypeStats
  };
}

/**
 * Analyzes temporal patterns (when grievances occur)
 * @param {Array} data - Grievance data
 * @returns {Object} Temporal analysis
 */
function analyzeTemporalPatterns(data) {
  const monthlyPatterns = {};
  const dayOfWeekPatterns = {};

  data.forEach(function(row) {
    const filedDate = row[GRIEVANCE_COLS.DATE_FILED - 1];
    if (!filedDate) return;

    // Monthly analysis
    const monthKey = `${filedDate.getFullYear()}-${String(filedDate.getMonth() + 1).padStart(2, '0')}`;
    monthlyPatterns[monthKey] = (monthlyPatterns[monthKey] || 0) + 1;

    // Day of week analysis
    const dayOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][filedDate.getDay()];
    dayOfWeekPatterns[dayOfWeek] = (dayOfWeekPatterns[dayOfWeek] || 0) + 1;
  });

  // Find peak days
  const peakDay = Object.entries(dayOfWeekPatterns)
    .sort(function(a, b) { return b[1] - a[1]; })[0];

  return {
    monthlyPatterns: monthlyPatterns,
    dayOfWeekPatterns: dayOfWeekPatterns,
    peakDay: peakDay ? peakDay[0] : 'N/A',
    peakDayCount: peakDay ? peakDay[1] : 0
  };
}

/**
 * Finds correlations between variables
 * @param {Array} data - Grievance data
 * @returns {Array} Correlation findings
 */
function findCorrelations(data) {
  const correlations = [];

  // Check: Specific steward + specific issue type
  const stewardIssueMatrix = {};

  data.forEach(function(row) {
    const steward = row[GRIEVANCE_COLS.STEWARD - 1];
    const issueType = row[GRIEVANCE_COLS.ISSUE_CATEGORY - 1];

    if (steward && issueType) {
      const key = `${steward}|||${issueType}`;
      stewardIssueMatrix[key] = (stewardIssueMatrix[key] || 0) + 1;
    }
  });

  Object.entries(stewardIssueMatrix).forEach(function([key, count]) {
    if (count >= 5) {
      const [steward, issueType] = key.split('|||');
      correlations.push({
        type: 'Steward-Issue Correlation',
        description: `${steward} has ${count} ${issueType} grievances`,
        count: count,
        significance: count >= 10 ? 'HIGH' : 'MEDIUM'
      });
    }
  });

  return correlations.sort(function(a, b) { return b.count - a.count; });
}

/**
 * Generates recommendations based on RCA
 * @param {Array} data - Grievance data
 * @returns {Array} Recommendations
 */
function generateRCARecommendations(data) {
  const recommendations = [];

  const locationAnalysis = analyzeLocationClusters(data);
  const managerAnalysis = analyzeManagerPatterns(data);
  const issueAnalysis = analyzeIssueTypePatterns(data);

  // Location-based recommendations
  locationAnalysis.hotspots.forEach(function(hotspot) {
    recommendations.push({
      category: 'Location Hotspot',
      priority: hotspot.severity,
      recommendation: `Address grievance concentration at ${hotspot.location} (${hotspot.percentage}% of all cases). Primary issue: ${hotspot.topIssueType}. Consider workplace assessment and manager training.`,
      impactArea: hotspot.location,
      expectedImpact: `Reduce grievances by 30-40% at this location`
    });
  });

  // Manager-based recommendations
  managerAnalysis.concerningManagers.forEach(function(manager) {
    recommendations.push({
      category: 'Management Pattern',
      priority: manager.severity,
      recommendation: `${manager.manager} has ${manager.comparedToAverage} average grievances. Primary issue: ${manager.topIssueType}. Recommend management coaching and relationship building.`,
      impactArea: manager.manager,
      expectedImpact: `Reduce grievances by 20-30% for this manager's team`
    });
  });

  // Systemic issue recommendations
  issueAnalysis.systemicIssues.forEach(function(issue) {
    if (issue.isSystemic) {
      recommendations.push({
        category: 'Systemic Issue',
        priority: 'HIGH',
        recommendation: `${issue.issueType} represents ${issue.percentage}% of all grievances, concentrated at ${issue.primaryLocation}. This indicates a systemic problem requiring policy review and preventive measures.`,
        impactArea: issue.issueType,
        expectedImpact: `Prevent 50-70% of future ${issue.issueType} grievances through proactive intervention`
      });
    }
  });

  return recommendations.sort(function(a, b) {
    const priorityOrder = { 'HIGH': 3, 'MEDIUM': 2, 'LOW': 1 };
    return priorityOrder[b.priority] - priorityOrder[a.priority];
  });
}

/**
 * Shows root cause analysis dashboard
 */
function showRootCauseAnalysisDashboard() {
  const ui = SpreadsheetApp.getUi();

  SpreadsheetApp.getActiveSpreadsheet().toast(
    'üî¨ Analyzing patterns...',
    'Root Cause Analysis',
    -1
  );

  try {
    const analysis = performRootCauseAnalysis();

    if (analysis.error) {
      ui.alert('‚ö†Ô∏è ' + analysis.error);
      return;
    }

    const html = createRCADashboardHTML(analysis);
    const htmlOutput = HtmlService.createHtmlOutput(html)
      .setWidth(1000)
      .setHeight(750);

    ui.showModalDialog(htmlOutput, 'üî¨ Root Cause Analysis');

  } catch (error) {
    ui.alert('‚ùå Error', error.message, ui.ButtonSet.OK);
  }
}

/**
 * Creates HTML for RCA dashboard
 * @param {Object} analysis - Analysis results
 * @returns {string} HTML content
 */
function createRCADashboardHTML(analysis) {
  const hotspotsHTML = analysis.locationClusters.hotspots.length > 0
    ? analysis.locationClusters.hotspots.map(function(h) { return `
        <div class="finding severity-${h.severity.toLowerCase()}">
          <div class="finding-header">
            <span class="finding-title">${h.location}</span>
            <span class="severity-badge ${h.severity.toLowerCase()}">${h.severity}</span>
          </div>
          <div class="finding-stats">
            <div class="stat">${h.count} cases (${h.percentage}%)</div>
            <div class="stat">Top issue: ${h.topIssueType} (${h.topIssueCount} cases)</div>
            <div class="stat">Avg resolution: ${h.avgResolutionTime} days</div>
          </div>
        </div>
      `; }).join('')
    : '<p>No significant location hotspots identified.</p>';

  const concerningManagersHTML = analysis.managerPatterns.concerningManagers.length > 0
    ? analysis.managerPatterns.concerningManagers.map(function(m) { return `
        <div class="finding severity-${m.severity.toLowerCase()}">
          <div class="finding-header">
            <span class="finding-title">${m.manager}</span>
            <span class="severity-badge ${m.severity.toLowerCase()}">${m.severity}</span>
          </div>
          <div class="finding-stats">
            <div class="stat">${m.count} cases (${m.comparedToAverage} avg)</div>
            <div class="stat">Top issue: ${m.topIssueType}</div>
            <div class="stat">Avg resolution: ${m.avgResolutionTime} days</div>
          </div>
        </div>
      `; }).join('')
    : '<p>No concerning manager patterns identified.</p>';

  const systemicIssuesHTML = analysis.issueTypePatterns.systemicIssues.length > 0
    ? analysis.issueTypePatterns.systemicIssues.map(function(i) { return `
        <div class="finding ${i.isSystemic ? 'severity-high' : 'severity-medium'}">
          <div class="finding-header">
            <span class="finding-title">${i.issueType}</span>
            ${i.isSystemic ? '<span class="severity-badge high">SYSTEMIC</span>' : ''}
          </div>
          <div class="finding-stats">
            <div class="stat">${i.count} cases (${i.percentage}%)</div>
            <div class="stat">Primary location: ${i.primaryLocation} (${i.locationConcentration})</div>
            <div class="stat">Avg resolution: ${i.avgResolutionTime} days</div>
          </div>
        </div>
      `; }).join('')
    : '<p>No systemic issues identified.</p>';

  const recommendationsHTML = analysis.recommendations.length > 0
    ? analysis.recommendations.map(function(r) { return `
        <div class="recommendation priority-${r.priority.toLowerCase()}">
          <div class="rec-header">
            <span class="rec-category">${r.category}</span>
            <span class="priority-badge ${r.priority.toLowerCase()}">${r.priority} PRIORITY</span>
          </div>
          <div class="rec-text">${r.recommendation}</div>
          <div class="rec-impact">
            <strong>Expected Impact:</strong> ${r.expectedImpact}
          </div>
        </div>
      `; }).join('')
    : '<p>No specific recommendations at this time.</p>';

  return `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: 'Roboto', Arial, sans-serif; padding: 20px; margin: 0; background: #f5f5f5; }
    .container { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-height: 700px; overflow-y: auto; }
    h2 { color: #1a73e8; margin-top: 0; border-bottom: 3px solid #1a73e8; padding-bottom: 10px; }
    h3 { color: #333; margin-top: 25px; border-bottom: 2px solid #e0e0e0; padding-bottom: 8px; }
    .summary { background: #e8f0fe; padding: 15px; border-radius: 4px; margin: 15px 0; border-left: 4px solid #1a73e8; }
    .finding { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 4px; border-left: 4px solid; }
    .finding.severity-high { border-left-color: #f44336; background: #ffebee; }
    .finding.severity-medium { border-left-color: #ff9800; background: #fff3e0; }
    .finding-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
    .finding-title { font-weight: bold; color: #333; }
    .severity-badge, .priority-badge { background: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold; }
    .severity-badge.high, .priority-badge.high { color: #f44336; border: 1px solid #f44336; }
    .severity-badge.medium, .priority-badge.medium { color: #ff9800; border: 1px solid #ff9800; }
    .finding-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .stat { background: white; padding: 8px; border-radius: 4px; font-size: 13px; text-align: center; }
    .recommendation { background: #e8f5e9; padding: 15px; margin: 10px 0; border-radius: 4px; border-left: 4px solid #4caf50; }
    .recommendation.priority-high { border-left-color: #f44336; background: #ffebee; }
    .recommendation.priority-medium { border-left-color: #ff9800; background: #fff3e0; }
    .rec-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
    .rec-category { font-weight: bold; color: #1976d2; }
    .rec-text { margin: 10px 0; color: #555; }
    .rec-impact { margin-top: 10px; padding: 10px; background: white; border-radius: 4px; font-size: 13px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>üî¨ Root Cause Analysis</h2>

    <div class="summary">
      <strong>üìä Analysis Summary:</strong><br>
      Analyzed ${analysis.locationClusters.totalLocations} locations, ${analysis.managerPatterns.totalManagers} managers, ${analysis.issueTypePatterns.totalIssueTypes} issue types<br>
      Found ${analysis.locationClusters.hotspots.length} location hotspots, ${analysis.managerPatterns.concerningManagers.length} concerning manager patterns, ${analysis.issueTypePatterns.systemicIssues.length} systemic issues
    </div>

    <h3>üìç Location Hotspots</h3>
    ${hotspotsHTML}

    <h3>üëî Management Patterns</h3>
    ${concerningManagersHTML}

    <h3>‚ö†Ô∏è Systemic Issues</h3>
    ${systemicIssuesHTML}

    <h3>üí° Recommendations</h3>
    ${recommendationsHTML}
  </div>
</body>
</html>
  `;
}



// ================================================================================
// MODULE: SecurityAndAdmin.gs
// Source: SecurityAndAdmin.gs
// ================================================================================

/**
 * SECURITY AND ADMIN FEATURES
 * Features 79-94: Audit Logging, RBAC, Security, Backups, Import/Export
 */

// ===========================
// FEATURE 79: AUDIT LOGGING
// ===========================

/**
 * Creates the Audit_Log sheet for tracking all data modifications
 */
function createAuditLogSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let auditLog = ss.getSheetByName('Audit_Log');

  // Delete existing sheet if present
  if (auditLog) {
    ss.deleteSheet(auditLog);
  }

  // Create new sheet
  auditLog = ss.insertSheet('Audit_Log');

  // Set up headers
  const headers = [
    'Timestamp',
    'User Email',
    'Action Type',
    'Sheet Name',
    'Record ID',
    'Field Changed',
    'Old Value',
    'New Value',
    'IP Address',
    'Session ID'
  ];

  auditLog.getRange(1, 1, 1, headers.length).setValues([headers]);

  // Style headers
  auditLog.getRange(1, 1, 1, headers.length)
    .setFontWeight('bold')
    .setBackground('#4A5568')
    .setFontColor('#FFFFFF')
    .setWrap(true);

  // Set column widths
  auditLog.setColumnWidth(1, 150); // Timestamp
  auditLog.setColumnWidth(2, 200); // User Email
  auditLog.setColumnWidth(3, 120); // Action Type
  auditLog.setColumnWidth(4, 150); // Sheet Name
  auditLog.setColumnWidth(5, 120); // Record ID
  auditLog.setColumnWidth(6, 150); // Field Changed
  auditLog.setColumnWidth(7, 200); // Old Value
  auditLog.setColumnWidth(8, 200); // New Value
  auditLog.setColumnWidth(9, 120); // IP Address
  auditLog.setColumnWidth(10, 150); // Session ID

  // Freeze header row
  auditLog.setFrozenRows(1);

  // Set tab color
  auditLog.setTabColor('#DC2626'); // Red for security/audit

  Logger.log('Audit_Log sheet created successfully');
}

/**
 * Logs a data modification to the Audit_Log sheet
 * @param {string} actionType - Type of action (CREATE, UPDATE, DELETE, EXPORT, etc.)
 * @param {string} sheetName - Name of sheet where action occurred
 * @param {string} recordId - ID of the record affected
 * @param {string} fieldChanged - Name of field that changed
 * @param {string} oldValue - Previous value
 * @param {string} newValue - New value
 */
function logDataModification(actionType, sheetName, recordId, fieldChanged, oldValue, newValue) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let auditLog = ss.getSheetByName('Audit_Log');

    // Create audit log sheet if it doesn't exist
    if (!auditLog) {
      createAuditLogSheet();
      auditLog = ss.getSheetByName('Audit_Log');
    }

    // Get user info
    const userEmail = Session.getActiveUser().getEmail() || 'Unknown';
    const timestamp = new Date();

    // Generate session ID (stored in script properties for session duration)
    const scriptProps = PropertiesService.getScriptProperties();
    let sessionId = scriptProps.getProperty('CURRENT_SESSION_ID');
    if (!sessionId) {
      sessionId = Utilities.getUuid();
      scriptProps.setProperty('CURRENT_SESSION_ID', sessionId);
    }

    // IP address not available in Apps Script, using placeholder
    const ipAddress = 'N/A';

    // Prepare audit entry
    const auditEntry = [
      timestamp,
      userEmail,
      actionType,
      sheetName,
      recordId || 'N/A',
      fieldChanged || 'N/A',
      oldValue || '',
      newValue || '',
      ipAddress,
      sessionId
    ];

    // Append to audit log
    auditLog.appendRow(auditEntry);

    Logger.log(`Audit logged: ${actionType} on ${sheetName} by ${userEmail}`);

  } catch (error) {
    Logger.log(`Error logging audit: ${error.message}`);
    // Don't throw error - audit logging should not break main operations
  }
}

// ===========================
// FEATURE 80: ROLE-BASED ACCESS CONTROL
// ===========================

/**
 * Check if current user has required permission level
 * @param {string} requiredRole - Required role: 'ADMIN', 'STEWARD', or 'VIEWER'
 * @return {boolean} True if user has permission
 */
function checkUserPermission(requiredRole) {
  try {
    const userEmail = Session.getActiveUser().getEmail();

    if (!userEmail) {
      SpreadsheetApp.getUi().alert('Unable to identify user. Access denied.');
      return false;
    }

    const scriptProps = PropertiesService.getScriptProperties();

    // Get role lists from script properties
    const admins = (scriptProps.getProperty('ADMINS') || '').split(',').map(e => e.trim().toLowerCase());
    const stewards = (scriptProps.getProperty('STEWARDS') || '').split(',').map(e => e.trim().toLowerCase());
    const viewers = (scriptProps.getProperty('VIEWERS') || '').split(',').map(e => e.trim().toLowerCase());

    const userEmailLower = userEmail.toLowerCase();

    // Check permissions based on role hierarchy (ADMIN > STEWARD > VIEWER)
    const isAdmin = admins.includes(userEmailLower);
    const isSteward = stewards.includes(userEmailLower);
    const isViewer = viewers.includes(userEmailLower);

    switch (requiredRole.toUpperCase()) {
      case 'ADMIN':
        return isAdmin;
      case 'STEWARD':
        return isAdmin || isSteward;
      case 'VIEWER':
        return isAdmin || isSteward || isViewer;
      default:
        return false;
    }

  } catch (error) {
    Logger.log(`Error checking permissions: ${error.message}`);
    return false;
  }
}

/**
 * Configure RBAC roles (Admin only)
 */
function configureRBAC() {
  const ui = SpreadsheetApp.getUi();

  // Check if current user is admin
  if (!checkUserPermission('ADMIN')) {
    ui.alert('Access Denied', 'Only administrators can configure RBAC settings.', ui.ButtonSet.OK);
    return;
  }

  const scriptProps = PropertiesService.getScriptProperties();

  // Get current values
  const currentAdmins = scriptProps.getProperty('ADMINS') || '';
  const currentStewards = scriptProps.getProperty('STEWARDS') || '';
  const currentViewers = scriptProps.getProperty('VIEWERS') || '';

  // Prompt for new values
  const adminsResponse = ui.prompt(
    'Configure Admin Users',
    `Enter admin email addresses (comma-separated):\n\nCurrent: ${currentAdmins}`,
    ui.ButtonSet.OK_CANCEL
  );

  if (adminsResponse.getSelectedButton() === ui.Button.OK) {
    const admins = adminsResponse.getResponseText().trim();
    if (admins) scriptProps.setProperty('ADMINS', admins);
  }

  const stewardsResponse = ui.prompt(
    'Configure Steward Users',
    `Enter steward email addresses (comma-separated):\n\nCurrent: ${currentStewards}`,
    ui.ButtonSet.OK_CANCEL
  );

  if (stewardsResponse.getSelectedButton() === ui.Button.OK) {
    const stewards = stewardsResponse.getResponseText().trim();
    if (stewards) scriptProps.setProperty('STEWARDS', stewards);
  }

  const viewersResponse = ui.prompt(
    'Configure Viewer Users',
    `Enter viewer email addresses (comma-separated):\n\nCurrent: ${currentViewers}`,
    ui.ButtonSet.OK_CANCEL
  );

  if (viewersResponse.getSelectedButton() === ui.Button.OK) {
    const viewers = viewersResponse.getResponseText().trim();
    if (viewers) scriptProps.setProperty('VIEWERS', viewers);
  }

  ui.alert('Success', 'RBAC configuration updated successfully!', ui.ButtonSet.OK);

  // Log the configuration change
  logDataModification('CONFIG_CHANGE', 'Script Properties', 'RBAC', 'User Roles', 'Updated', 'Updated');
}

// ===========================
// FEATURE 83: INPUT SANITIZATION
// ===========================

/**
 * Sanitizes user input to prevent script injection and XSS attacks
 * @param {string} input - Raw user input
 * @param {string} type - Type of input: 'text', 'email', 'number', 'date', 'html'
 * @return {string} Sanitized input
 */
function sanitizeInput(input, type = 'text') {
  if (input === null || input === undefined) {
    return '';
  }

  let sanitized = String(input);

  switch (type.toLowerCase()) {
    case 'text':
      // Remove script tags and dangerous characters
      sanitized = sanitized
        .replace(/<script[^>]*>.*?<\/script>/gi, '')
        .replace(/<iframe[^>]*>.*?<\/iframe>/gi, '')
        .replace(/javascript:/gi, '')
        .replace(/on\w+\s*=/gi, '') // Remove event handlers like onclick=
        .trim();
      break;

    case 'email':
      // Basic email sanitization
      sanitized = sanitized.toLowerCase().trim();
      // Remove anything that's not email-safe
      sanitized = sanitized.replace(/[^a-z0-9@._-]/g, '');
      break;

    case 'number':
      // Extract only numeric characters
      sanitized = sanitized.replace(/[^0-9.-]/g, '');
      break;

    case 'date':
      // Validate date format
      const date = new Date(sanitized);
      if (isNaN(date.getTime())) {
        return '';
      }
      sanitized = Utilities.formatDate(date, Session.getScriptTimeZone(), 'yyyy-MM-dd');
      break;

    case 'html':
      // Escape HTML entities
      sanitized = sanitized
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#x27;');
      break;

    default:
      // Default to text sanitization
      sanitized = sanitized
        .replace(/<script[^>]*>.*?<\/script>/gi, '')
        .trim();
  }

  // Log if significant sanitization occurred
  if (sanitized !== String(input)) {
    Logger.log(`Input sanitized: "${input}" -> "${sanitized}"`);
    logDataModification('SANITIZATION', 'Input Validation', 'N/A', type, input, sanitized);
  }

  return sanitized;
}

// ===========================
// FEATURE 84: AUDIT REPORTING
// ===========================

/**
 * Generates an audit trail report for a specified date range
 * @param {Date} startDate - Start date for report
 * @param {Date} endDate - End date for report
 */
function generateAuditReport(startDate, endDate) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const auditLog = ss.getSheetByName('Audit_Log');

  if (!auditLog) {
    SpreadsheetApp.getUi().alert('Error', 'Audit_Log sheet not found. Please enable audit logging first.', SpreadsheetApp.getUi().ButtonSet.OK);
    return;
  }

  // Check permissions
  if (!checkUserPermission('ADMIN')) {
    SpreadsheetApp.getUi().alert('Access Denied', 'Only administrators can generate audit reports.', SpreadsheetApp.getUi().ButtonSet.OK);
    return;
  }

  // Get all audit data
  const data = auditLog.getDataRange().getValues();
  const headers = data[0];
  const records = data.slice(1);

  // Filter by date range
  const filtered = records.filter(row => {
    const timestamp = new Date(row[0]);
    return timestamp >= startDate && timestamp <= endDate;
  });

  // Create report sheet
  let reportSheet = ss.getSheetByName('Audit Report');
  if (reportSheet) {
    ss.deleteSheet(reportSheet);
  }
  reportSheet = ss.insertSheet('Audit Report');

  // Add title
  reportSheet.getRange(1, 1, 1, 6).merge();
  reportSheet.getRange(1, 1).setValue('AUDIT TRAIL REPORT');
  reportSheet.getRange(1, 1).setFontSize(16).setFontWeight('bold').setHorizontalAlignment('center');

  // Add date range
  reportSheet.getRange(2, 1, 1, 6).merge();
  reportSheet.getRange(2, 1).setValue(`Period: ${Utilities.formatDate(startDate, Session.getScriptTimeZone(), 'yyyy-MM-dd')} to ${Utilities.formatDate(endDate, Session.getScriptTimeZone(), 'yyyy-MM-dd')}`);
  reportSheet.getRange(2, 1).setHorizontalAlignment('center');

  // Add summary stats
  reportSheet.getRange(4, 1).setValue('Total Actions:');
  reportSheet.getRange(4, 2).setValue(filtered.length);

  const uniqueUsers = [...new Set(filtered.map(row => row[1]))];
  reportSheet.getRange(5, 1).setValue('Unique Users:');
  reportSheet.getRange(5, 2).setValue(uniqueUsers.length);

  const actionTypes = filtered.reduce((acc, row) => {
    acc[row[2]] = (acc[row[2]] || 0) + 1;
    return acc;
  }, {});

  reportSheet.getRange(7, 1).setValue('Actions by Type:');
  reportSheet.getRange(7, 1).setFontWeight('bold');

  let row = 8;
  for (const [type, count] of Object.entries(actionTypes)) {
    reportSheet.getRange(row, 1).setValue(type);
    reportSheet.getRange(row, 2).setValue(count);
    row++;
  }

  // Add detailed records
  const detailStartRow = row + 2;
  reportSheet.getRange(detailStartRow, 1, 1, headers.length).setValues([headers]);
  reportSheet.getRange(detailStartRow, 1, 1, headers.length)
    .setFontWeight('bold')
    .setBackground('#4A5568')
    .setFontColor('#FFFFFF');

  if (filtered.length > 0) {
    reportSheet.getRange(detailStartRow + 1, 1, filtered.length, headers.length).setValues(filtered);
  }

  // Format
  reportSheet.setFrozenRows(detailStartRow);
  reportSheet.setTabColor('#7C3AED');

  SpreadsheetApp.getUi().alert('Success', `Audit report generated with ${filtered.length} records.`, SpreadsheetApp.getUi().ButtonSet.OK);

  // Log report generation
  logDataModification('REPORT_GENERATED', 'Audit_Log', 'Audit Report', 'Date Range',
                     startDate.toISOString(), endDate.toISOString());
}

/**
 * Shows dialog to generate audit report
 */
function showAuditReportDialog() {
  const ui = SpreadsheetApp.getUi();

  // Check permissions
  if (!checkUserPermission('ADMIN')) {
    ui.alert('Access Denied', 'Only administrators can generate audit reports.', ui.ButtonSet.OK);
    return;
  }

  const startResponse = ui.prompt(
    'Generate Audit Report',
    'Enter start date (YYYY-MM-DD):',
    ui.ButtonSet.OK_CANCEL
  );

  if (startResponse.getSelectedButton() !== ui.Button.OK) return;

  const endResponse = ui.prompt(
    'Generate Audit Report',
    'Enter end date (YYYY-MM-DD):',
    ui.ButtonSet.OK_CANCEL
  );

  if (endResponse.getSelectedButton() !== ui.Button.OK) return;

  try {
    const startDate = new Date(startResponse.getResponseText());
    const endDate = new Date(endResponse.getResponseText());

    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
      ui.alert('Error', 'Invalid date format. Please use YYYY-MM-DD.', ui.ButtonSet.OK);
      return;
    }

    generateAuditReport(startDate, endDate);

  } catch (error) {
    ui.alert('Error', `Failed to generate report: ${error.message}`, ui.ButtonSet.OK);
  }
}

// ===========================
// FEATURE 85: DATA RETENTION POLICY
// ===========================

/**
 * Enforces data retention policy (default: 7 years)
 * Moves old records to Archive sheet
 * @param {number} retentionYears - Number of years to retain data (default: 7)
 */
function enforceDataRetention(retentionYears = 7) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ui = SpreadsheetApp.getUi();

  // Check permissions
  if (!checkUserPermission('ADMIN')) {
    ui.alert('Access Denied', 'Only administrators can enforce data retention policies.', ui.ButtonSet.OK);
    return;
  }

  const cutoffDate = new Date();
  cutoffDate.setFullYear(cutoffDate.getFullYear() - retentionYears);

  let archivedCount = 0;

  // Process Grievance Log
  const grievanceLog = ss.getSheetByName('Grievance Log');
  if (grievanceLog) {
    const data = grievanceLog.getDataRange().getValues();
    const headers = data[0];
    const dateClosedCol = headers.indexOf('Date Closed');

    if (dateClosedCol !== -1) {
      const oldGrievances = [];
      const rowsToDelete = [];

      for (let i = data.length - 1; i >= 1; i--) {
        const row = data[i];
        const dateClosed = new Date(row[dateClosedCol]);

        if (!isNaN(dateClosed.getTime()) && dateClosed < cutoffDate) {
          oldGrievances.push(row);
          rowsToDelete.push(i + 1); // +1 for 1-indexed rows
        }
      }

      // Move to archive
      if (oldGrievances.length > 0) {
        archiveRecords('Grievance', oldGrievances, headers);

        // Delete rows (from bottom to top to maintain indices)
        rowsToDelete.forEach(rowNum => {
          grievanceLog.deleteRow(rowNum);
        });

        archivedCount += oldGrievances.length;
      }
    }
  }

  // Process Audit Log
  const auditLog = ss.getSheetByName('Audit_Log');
  if (auditLog) {
    const data = auditLog.getDataRange().getValues();
    const headers = data[0];
    const oldRecords = [];
    const rowsToDelete = [];

    for (let i = data.length - 1; i >= 1; i--) {
      const row = data[i];
      const timestamp = new Date(row[0]);

      if (!isNaN(timestamp.getTime()) && timestamp < cutoffDate) {
        oldRecords.push(row);
        rowsToDelete.push(i + 1);
      }
    }

    if (oldRecords.length > 0) {
      archiveRecords('Audit_Log', oldRecords, headers);

      rowsToDelete.forEach(rowNum => {
        auditLog.deleteRow(rowNum);
      });

      archivedCount += oldRecords.length;
    }
  }

  ui.alert('Data Retention Complete',
          `Archived ${archivedCount} records older than ${retentionYears} years (before ${cutoffDate.toDateString()}).`,
          ui.ButtonSet.OK);

  logDataModification('RETENTION_POLICY', 'System', 'Data Retention', 'Records Archived',
                     String(archivedCount), `Cutoff: ${cutoffDate.toISOString()}`);
}

/**
 * Helper function to archive records
 */
function archiveRecords(itemType, records, headers) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let archive = ss.getSheetByName('üì¶ Archive');

  if (!archive) {
    archive = ss.getSheetByName('Archive');
  }

  if (!archive) {
    // Create archive sheet if it doesn't exist
    archive = ss.insertSheet('üì¶ Archive');
    archive.getRange(1, 1, 1, 6).setValues([['Item Type', 'Item ID', 'Archive Date', 'Archived By', 'Reason', 'Original Data']]);
    archive.getRange(1, 1, 1, 6).setFontWeight('bold').setBackground('#6B7280').setFontColor('#FFFFFF');
  }

  const userEmail = Session.getActiveUser().getEmail();
  const archiveDate = new Date();

  records.forEach(record => {
    const archiveRow = [
      itemType,
      record[0], // ID (first column)
      archiveDate,
      userEmail,
      'Data Retention Policy',
      JSON.stringify(record)
    ];

    archive.appendRow(archiveRow);
  });
}

// ===========================
// FEATURE 86: SUSPICIOUS ACTIVITY DETECTION
// ===========================

/**
 * Detects suspicious activity patterns (>50 changes/hour)
 * @return {Object} Detection results with alerts
 */
function detectSuspiciousActivity() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const auditLog = ss.getSheetByName('Audit_Log');

  if (!auditLog) {
    return { suspicious: false, message: 'Audit log not available' };
  }

  const data = auditLog.getDataRange().getValues();
  const records = data.slice(1); // Skip header

  const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);

  // Count changes by user in last hour
  const userActivity = {};

  records.forEach(row => {
    const timestamp = new Date(row[0]);
    const userEmail = row[1];

    if (timestamp >= oneHourAgo) {
      userActivity[userEmail] = (userActivity[userEmail] || 0) + 1;
    }
  });

  // Find suspicious users (>50 changes/hour)
  const suspiciousUsers = [];
  for (const [email, count] of Object.entries(userActivity)) {
    if (count > 50) {
      suspiciousUsers.push({ email, count });
    }
  }

  if (suspiciousUsers.length > 0) {
    const ui = SpreadsheetApp.getUi();
    let message = '‚ö†Ô∏è SUSPICIOUS ACTIVITY DETECTED\n\n';
    message += 'The following users have made >50 changes in the last hour:\n\n';

    suspiciousUsers.forEach(user => {
      message += `${user.email}: ${user.count} changes\n`;
    });

    message += '\nThis may indicate:\n';
    message += '‚Ä¢ Automated script activity\n';
    message += '‚Ä¢ Data breach attempt\n';
    message += '‚Ä¢ Legitimate bulk operations\n\n';
    message += 'Please review the Audit_Log sheet for details.';

    ui.alert('Security Alert', message, ui.ButtonSet.OK);

    // Log the detection
    logDataModification('SECURITY_ALERT', 'System', 'Suspicious Activity',
                       'High Volume Changes',
                       JSON.stringify(suspiciousUsers),
                       'Alert triggered');

    return { suspicious: true, users: suspiciousUsers, message };
  }

  return { suspicious: false, message: 'No suspicious activity detected' };
}

/**
 * Sets up automatic suspicious activity monitoring (trigger-based)
 */
function setupSuspiciousActivityMonitoring() {
  // Delete existing triggers
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === 'detectSuspiciousActivity') {
      ScriptApp.deleteTrigger(trigger);
    }
  });

  // Create hourly trigger
  ScriptApp.newTrigger('detectSuspiciousActivity')
    .timeBased()
    .everyHours(1)
    .create();

  SpreadsheetApp.getUi().alert('Success',
    'Suspicious activity monitoring enabled. System will check every hour for unusual patterns.',
    SpreadsheetApp.getUi().ButtonSet.OK);
}

// ===========================
// HELPER FUNCTIONS
// ===========================

/**
 * Opens the Audit_Log sheet for viewing
 */
function viewAuditLog() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let auditLog = ss.getSheetByName('Audit_Log');

  if (!auditLog) {
    createAuditLogSheet();
    auditLog = ss.getSheetByName('Audit_Log');
  }

  auditLog.activate();
  SpreadsheetApp.getUi().alert('Audit Log', 'Showing Audit_Log sheet with all data modifications.', SpreadsheetApp.getUi().ButtonSet.OK);
}

/**
 * Opens the Performance_Log sheet for viewing
 */
function viewPerformanceLog() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let perfLog = ss.getSheetByName('Performance_Log');

  if (!perfLog) {
    createPerformanceLogSheet();
    perfLog = ss.getSheetByName('Performance_Log');
  }

  perfLog.activate();
  SpreadsheetApp.getUi().alert('Performance Log', 'Showing Performance_Log sheet with all execution metrics.', SpreadsheetApp.getUi().ButtonSet.OK);
}

/**
 * One-click setup for all audit and security features
 */
function setupAuditAndSecurity() {
  const ui = SpreadsheetApp.getUi();

  const response = ui.alert(
    'Setup Audit & Security',
    'This will:\n\n' +
    '‚Ä¢ Create Audit_Log sheet\n' +
    '‚Ä¢ Create Performance_Log sheet\n' +
    '‚Ä¢ Configure RBAC roles\n' +
    '‚Ä¢ Enable activity monitoring\n\n' +
    'Continue?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return;
  }

  // Create sheets
  createAuditLogSheet();
  createPerformanceLogSheet();

  // Configure RBAC
  ui.alert('Step 1: Configure RBAC', 'Next, configure user roles for access control.', ui.ButtonSet.OK);
  configureRBAC();

  // Setup monitoring
  setupSuspiciousActivityMonitoring();

  ui.alert('Setup Complete!',
    'Audit logging and security features are now active!\n\n' +
    'Check the Audit_Log and Performance_Log sheets to monitor activity.',
    ui.ButtonSet.OK);

  // Log the setup
  logDataModification('SETUP', 'System', 'Audit & Security', 'Initialization', 'None', 'Complete');
}



// ================================================================================
// MODULE: SecurityService.gs
// Source: SecurityService.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * SECURITY SERVICE - RBAC and Audit Logging
 * ------------------------------------------------------------------------====
 *
 * Provides role-based access control and comprehensive audit logging for
 * the 509 Dashboard to ensure security and compliance.
 *
 * Features:
 * - Role-based permissions (Admin, Steward, Member, Viewer)
 * - Function-level access control
 * - Comprehensive audit logging
 * - User activity tracking
 * - Change history
 *
 * ------------------------------------------------------------------------====
 */

/* --------------------= ROLE DEFINITIONS --------------------= */

/**
 * Role definitions with permissions
 * @type {Object}
 */
const ROLES = {
  ADMIN: {
    name: 'Admin',
    permissions: [
      'view', 'edit', 'delete', 'export', 'configure',
      'seed_data', 'clear_data', 'manage_users', 'view_audit_log'
    ],
    description: 'Full system access including configuration and user management'
  },
  STEWARD: {
    name: 'Steward',
    permissions: [
      'view', 'edit', 'comment', 'export', 'create_grievance',
      'update_grievance', 'view_assigned_grievances'
    ],
    description: 'Can view and edit grievances, manage assigned cases'
  },
  COORDINATOR: {
    name: 'Grievance Coordinator',
    permissions: [
      'view', 'edit', 'comment', 'export', 'create_grievance',
      'update_grievance', 'view_all_grievances', 'assign_stewards'
    ],
    description: 'Can manage all grievances and assign stewards'
  },
  MEMBER: {
    name: 'Member',
    permissions: [
      'view_own', 'view_own_grievances', 'comment'
    ],
    description: 'Can view own member data and grievances only'
  },
  VIEWER: {
    name: 'Viewer',
    permissions: [
      'view'
    ],
    description: 'Read-only access to anonymized data'
  }
};

/* --------------------= USER ROLE MANAGEMENT --------------------= */

/**
 * Gets the role for a user
 * @param {string} userEmail - User's email address (defaults to current user)
 * @returns {string} Role name (defaults to 'VIEWER')
 */
function getUserRole(userEmail) {
  if (!userEmail) {
    userEmail = Session.getActiveUser().getEmail();
  }

  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let userRolesSheet = ss.getSheetByName('User Roles');

    if (!userRolesSheet) {
      // If sheet doesn't exist, create it and assign current user as admin
      Logger.log('getUserRole: User Roles sheet not found. Creating and assigning ' + userEmail + ' as ADMIN');
      userRolesSheet = createUserRolesSheet();
      assignRole(userEmail, 'ADMIN');
      return 'ADMIN';
    }

    // Look up user's role
    const data = userRolesSheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (data[i][0].toLowerCase() === userEmail.toLowerCase()) {
        const role = data[i][1] || 'VIEWER';
        Logger.log('getUserRole: Found user ' + userEmail + ' with role ' + role);
        return role;
      }
    }

    // User not found, default to VIEWER (this is expected behavior, not an error)
    Logger.log('getUserRole: User ' + userEmail + ' not found in User Roles sheet. Defaulting to VIEWER');
    return 'VIEWER';
  } catch (error) {
    // Distinguish between "user not found" (handled above) and "error occurred"
    Logger.log('Error in getUserRole: Failed to retrieve role for user. UserEmail: ' + userEmail +
               ', Error: ' + error.message +
               ', Stack: ' + error.stack);
    handleError(error, 'getUserRole');
    return 'VIEWER';
  }
}

/**
 * Assigns a role to a user
 * @param {string} userEmail - User's email
 * @param {string} role - Role to assign (ADMIN, STEWARD, COORDINATOR, MEMBER, VIEWER)
 * @returns {boolean} Success status
 */
function assignRole(userEmail, role) {
  try {
    // Validate email parameter
    if (!userEmail || typeof userEmail !== 'string') {
      const error = new Error('assignRole: userEmail parameter is required and must be a string');
      Logger.log(error.message + '. Received: ' + JSON.stringify(userEmail));
      throw error;
    }

    // Basic email format validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(userEmail)) {
      const error = new Error('assignRole: Invalid email format');
      Logger.log(error.message + '. Email provided: ' + userEmail);
      throw error;
    }

    // Validate role parameter
    if (!role || typeof role !== 'string') {
      const error = new Error('assignRole: role parameter is required and must be a string');
      Logger.log(error.message + '. Received: ' + JSON.stringify(role));
      throw error;
    }

    if (!ROLES[role]) {
      throw new Error(ERROR_MESSAGES.INVALID_INPUT(`role: ${role}`));
    }

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let userRolesSheet = ss.getSheetByName('User Roles');

    if (!userRolesSheet) {
      userRolesSheet = createUserRolesSheet();
      if (!userRolesSheet) {
        throw new Error('assignRole: Failed to create User Roles sheet');
      }
    }

    // Check if user already exists
    const data = userRolesSheet.getDataRange().getValues();
    let userRow = -1;

    for (let i = 1; i < data.length; i++) {
      if (data[i][0].toLowerCase() === userEmail.toLowerCase()) {
        userRow = i + 1;
        break;
      }
    }

    const timestamp = new Date();
    const assignedBy = Session.getActiveUser().getEmail();

    if (userRow > 0) {
      // Update existing user
      Logger.log(`assignRole: Updating existing user ${userEmail} from row ${userRow} to role ${role}`);
      userRolesSheet.getRange(userRow, 2, 1, 3).setValues([[role, timestamp, assignedBy]]);
    } else {
      // Add new user
      Logger.log(`assignRole: Adding new user ${userEmail} with role ${role}`);
      userRolesSheet.appendRow([userEmail, role, timestamp, assignedBy]);
    }

    // Log the role assignment
    logAudit('ROLE_ASSIGNMENT', `Assigned role ${role} to ${userEmail}`, {
      userEmail: userEmail,
      role: role,
      assignedBy: assignedBy,
      operation: userRow > 0 ? 'UPDATE' : 'CREATE'
    });

    return true;
  } catch (error) {
    // Provide detailed error context
    Logger.log('Error in assignRole: Failed to assign role. UserEmail: ' + (userEmail || 'undefined') +
               ', Role: ' + (role || 'undefined') +
               ', Error: ' + error.message +
               ', Stack: ' + error.stack);

    handleError(error, 'assignRole');
    return false;
  }
}

/**
 * Creates the User Roles sheet
 * @returns {GoogleAppsScript.Spreadsheet.Sheet} The created sheet
 */
function createUserRolesSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.insertSheet('User Roles');

  const headers = ['Email', 'Role', 'Assigned Date', 'Assigned By'];
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);

  sheet.getRange(1, 1, 1, headers.length)
    .setFontWeight('bold')
    .setBackground('#4A5568')
    .setFontColor('#FFFFFF');

  sheet.setFrozenRows(1);
  sheet.hideSheet(); // Hide from regular users

  return sheet;
}

/* --------------------= PERMISSION CHECKING --------------------= */

/**
 * Checks if current user has a specific permission
 * @param {string} permission - Permission to check
 * @param {string} userEmail - User email (optional, defaults to current user)
 * @returns {boolean} True if user has permission
 */
function hasPermission(permission, userEmail) {
  try {
    // Validate permission parameter
    if (!permission || typeof permission !== 'string') {
      Logger.log('Error in hasPermission: permission parameter is required and must be a string. Received: ' + JSON.stringify(permission));
      return false;
    }

    const role = getUserRole(userEmail);
    const roleConfig = ROLES[role];

    if (!roleConfig) {
      // Role not found in ROLES configuration - this is unexpected
      Logger.log('Error in hasPermission: Role "' + role + '" not found in ROLES configuration. UserEmail: ' + (userEmail || 'current user'));
      return false;
    }

    const hasAccess = roleConfig.permissions.includes(permission);
    Logger.log('hasPermission: User "' + (userEmail || Session.getActiveUser().getEmail()) +
               '" with role "' + role + '" ' +
               (hasAccess ? 'HAS' : 'DOES NOT HAVE') +
               ' permission "' + permission + '"');

    return hasAccess;
  } catch (error) {
    Logger.log('Error in hasPermission: Failed to check permission. Permission: ' + (permission || 'undefined') +
               ', UserEmail: ' + (userEmail || 'undefined') +
               ', Error: ' + error.message +
               ', Stack: ' + error.stack);
    handleError(error, 'hasPermission');
    return false;
  }
}

/**
 * Checks permission and throws error if not authorized
 * @param {string} permission - Required permission
 * @param {string} action - Action being attempted (for error message)
 * @throws {Error} If user lacks permission
 */
function requirePermission(permission, action) {
  if (!hasPermission(permission)) {
    const userEmail = Session.getActiveUser().getEmail();
    const role = getUserRole(userEmail);

    logAudit('ACCESS_DENIED', `User ${userEmail} attempted ${action} without permission ${permission}`, {
      userEmail: userEmail,
      role: role,
      permission: permission,
      action: action
    });

    throw new Error(ERROR_MESSAGES.INSUFFICIENT_ROLE(permission, role) + ` to ${action}`);
  }
}

/**
 * Wraps a function with permission check
 * @param {Function} fn - Function to wrap
 * @param {string} requiredPermission - Permission required
 * @param {string} actionDescription - Description of action
 * @returns {Function} Wrapped function
 */
function withPermission(fn, requiredPermission, actionDescription) {
  return function(...args) {
    requirePermission(requiredPermission, actionDescription);
    return fn.apply(this, args);
  };
}

/* --------------------= AUDIT LOGGING --------------------= */

/**
 * Valid audit event types
 * @type {Array<string>}
 */
const VALID_AUDIT_EVENT_TYPES = [
  'ACCESS',
  'ACCESS_DENIED',
  'DATA_CHANGE',
  'ROLE_ASSIGNMENT',
  'SEED_DATA',
  'CLEAR_DATA',
  'EXPORT_AUDIT_LOG',
  'ERROR'
];

/**
 * Logs an audit event
 * @param {string} eventType - Type of event (ACCESS, DATA_CHANGE, ACCESS_DENIED, etc.)
 * @param {string} description - Human-readable description
 * @param {Object} metadata - Additional metadata
 */
function logAudit(eventType, description, metadata) {
  try {
    // Validate eventType parameter
    if (!eventType || typeof eventType !== 'string') {
      Logger.log('Error in logAudit: eventType is required and must be a string. Received: ' + JSON.stringify(eventType));
      return;
    }

    if (!VALID_AUDIT_EVENT_TYPES.includes(eventType)) {
      Logger.log('Warning in logAudit: Invalid eventType "' + eventType + '". Valid types: ' + VALID_AUDIT_EVENT_TYPES.join(', '));
      // Continue with logging anyway, but log the warning
    }

    // Validate description parameter
    if (!description || typeof description !== 'string') {
      Logger.log('Error in logAudit: description is required and must be a string. Received: ' + JSON.stringify(description));
      return;
    }

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let auditSheet = ss.getSheetByName('Audit Log');

    if (!auditSheet) {
      auditSheet = createAuditLogSheet();
    }

    const timestamp = new Date();
    const userEmail = Session.getActiveUser().getEmail();
    const ipAddress = ''; // Apps Script doesn't provide IP directly
    const metadataJson = metadata ? JSON.stringify(metadata) : '';

    auditSheet.appendRow([
      timestamp,
      userEmail,
      eventType,
      description,
      metadataJson,
      ipAddress
    ]);

    // Keep only last 10,000 rows for performance
    const lastRow = auditSheet.getLastRow();
    if (lastRow > 10000) {
      auditSheet.deleteRows(2, lastRow - 10000);
    }
  } catch (error) {
    // Don't throw error in logging to avoid breaking functionality
    // But provide better context about what failed
    Logger.log('Error in logAudit: Failed to log audit event. EventType: ' + eventType + ', Error: ' + error.message + ', Stack: ' + error.stack);
  }
}

/**
 * Creates the Audit Log sheet
 * @returns {GoogleAppsScript.Spreadsheet.Sheet} The created sheet
 */
function createAuditLogSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.insertSheet('Audit Log');

  const headers = ['Timestamp', 'User Email', 'Event Type', 'Description', 'Metadata', 'IP Address'];
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);

  sheet.getRange(1, 1, 1, headers.length)
    .setFontWeight('bold')
    .setBackground('#DC2626')
    .setFontColor('#FFFFFF');

  sheet.setFrozenRows(1);
  sheet.autoResizeColumns(1, headers.length);

  return sheet;
}

/**
 * Logs data change event
 * @param {string} sheetName - Name of sheet changed
 * @param {string} operation - Operation (INSERT, UPDATE, DELETE)
 * @param {Object} details - Details about the change
 */
function logDataChange(sheetName, operation, details) {
  logAudit('DATA_CHANGE', `${operation} in ${sheetName}`, {
    sheetName: sheetName,
    operation: operation,
    ...details
  });
}

/**
 * Logs user login/access
 */
function logUserAccess() {
  const userEmail = Session.getActiveUser().getEmail();
  const role = getUserRole(userEmail);

  logAudit('ACCESS', `User accessed dashboard`, {
    userEmail: userEmail,
    role: role
  });
}

/* --------------------= DATA ACCESS CONTROL --------------------= */

/**
 * Filters member data based on user permissions
 * @param {Array<Array>} memberData - Full member data
 * @param {string} userEmail - User email (optional)
 * @returns {Array<Array>} Filtered data
 */
function filterMemberDataByPermission(memberData, userEmail) {
  if (!userEmail) {
    userEmail = Session.getActiveUser().getEmail();
  }

  const role = getUserRole(userEmail);

  // Admin and Coordinator can see all
  if (role === 'ADMIN' || role === 'COORDINATOR') {
    return memberData;
  }

  // Stewards can see all (but with limited edit permissions)
  if (role === 'STEWARD') {
    return memberData;
  }

  // Members can only see their own data
  if (role === 'MEMBER') {
    return memberData.filter(function(row, index) {
      if (index === 0) return true; // Keep header
      return row[MEMBER_COLS.EMAIL - 1] && row[MEMBER_COLS.EMAIL - 1].toLowerCase() === userEmail.toLowerCase();
    });
  }

  // Viewers see anonymized data (remove PII)
  if (role === 'VIEWER') {
    return memberData.map(function(row, index) {
      if (index === 0) return row; // Keep header

      // Anonymize PII
      return row.map(function(cell, colIndex) {
        // Hide email and phone
        if (colIndex === MEMBER_COLS.EMAIL - 1 || colIndex === MEMBER_COLS.PHONE - 1) {
          return '[REDACTED]';
        }
        return cell;
      });
    });
  }

  return [memberData[0]]; // Return only header for unknown roles
}

/**
 * Filters grievance data based on user permissions
 * @param {Array<Array>} grievanceData - Full grievance data
 * @param {string} userEmail - User email (optional)
 * @returns {Array<Array>} Filtered data
 */
function filterGrievanceDataByPermission(grievanceData, userEmail) {
  if (!userEmail) {
    userEmail = Session.getActiveUser().getEmail();
  }

  const role = getUserRole(userEmail);

  // Admin and Coordinator can see all
  if (role === 'ADMIN' || role === 'COORDINATOR') {
    return grievanceData;
  }

  // Stewards can only see assigned grievances
  if (role === 'STEWARD') {
    // First, get steward name from member directory
    const memberData = getSheetDataSafely(SHEETS.MEMBER_DIR);
    let stewardName = '';

    if (memberData) {
      const stewardRow = memberData.find(function(row) {
        return row[MEMBER_COLS.EMAIL - 1] && row[MEMBER_COLS.EMAIL - 1].toLowerCase() === userEmail.toLowerCase();
      });
      if (stewardRow) {
        stewardName = `${stewardRow[MEMBER_COLS.FIRST_NAME - 1]} ${stewardRow[MEMBER_COLS.LAST_NAME - 1]}`;
      }
    }

    return grievanceData.filter(function(row, index) {
      if (index === 0) return true; // Keep header
      const assignedSteward = row[GRIEVANCE_COLS.STEWARD - 1];
      return assignedSteward && assignedSteward.includes(stewardName);
    });
  }

  // Members can only see their own grievances
  if (role === 'MEMBER') {
    return grievanceData.filter(function(row, index) {
      if (index === 0) return true; // Keep header
      const memberEmail = row[GRIEVANCE_COLS.MEMBER_EMAIL - 1];
      return memberEmail && memberEmail.toLowerCase() === userEmail.toLowerCase();
    });
  }

  // Viewers see anonymized data
  if (role === 'VIEWER') {
    return grievanceData.map(function(row, index) {
      if (index === 0) return row; // Keep header

      // Anonymize PII
      return row.map(function(cell, colIndex) {
        // Hide names (2,3), email (23)
        if ([2, 3, 23].includes(colIndex)) {
          return '[REDACTED]';
        }
        return cell;
      });
    });
  }

  return [grievanceData[0]]; // Return only header for unknown roles
}

/* --------------------= PROTECTED OPERATIONS --------------------= */

/**
 * Protected version of SEED_MEMBERS - requires admin permission
 */
function protectedSeedMembers() {
  requirePermission('seed_data', 'seed member data');
  logAudit('SEED_DATA', 'Started seeding member data');

  // Call original function
  return SEED_20K_MEMBERS();
}

/**
 * Protected version of CLEAR_ALL_DATA - requires admin permission
 */
function protectedClearAllData() {
  requirePermission('clear_data', 'clear all data');

  const ui = SpreadsheetApp.getUi();
  const response = ui.alert(
    '‚ö†Ô∏è DANGER ZONE ‚ö†Ô∏è',
    'This will permanently delete all member and grievance data!\n\n' +
    'Are you absolutely sure you want to proceed?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return;
  }

  logAudit('CLEAR_DATA', 'User confirmed: Clearing all data');

  // Call original clear function
  return CLEAR_ALL_DATA();
}

/* --------------------= ADMIN FUNCTIONS --------------------= */

/**
 * Shows the user management dialog (Admin only)
 */
function showUserManagement() {
  requirePermission('manage_users', 'manage user roles');

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let userRolesSheet = ss.getSheetByName('User Roles');

  if (!userRolesSheet) {
    userRolesSheet = createUserRolesSheet();
  }

  userRolesSheet.showSheet();
  userRolesSheet.activate();

  SpreadsheetApp.getUi().alert(
    'üë• User Management',
    'You can now view and edit user roles.\n\n' +
    'Columns:\n' +
    '‚Ä¢ Email: User email address\n' +
    '‚Ä¢ Role: ADMIN, COORDINATOR, STEWARD, MEMBER, or VIEWER\n' +
    '‚Ä¢ Assigned Date: When role was assigned\n' +
    '‚Ä¢ Assigned By: Who assigned the role\n\n' +
    'Remember to hide this sheet when done!',
    SpreadsheetApp.getUi().ButtonSet.OK
  );
}

/**
 * Shows the audit log (Admin only)
 */
function showAuditLog() {
  requirePermission('view_audit_log', 'view audit log');

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let auditSheet = ss.getSheetByName(AUDIT_LOG_CONFIG.LOG_SHEET_NAME);

  if (!auditSheet) {
    SpreadsheetApp.getUi().alert(ERROR_MESSAGES.SHEET_NOT_FOUND(AUDIT_LOG_CONFIG.LOG_SHEET_NAME));
    return;
  }

  auditSheet.showSheet();
  auditSheet.activate();

  SpreadsheetApp.getUi().alert(
    'üìã Audit Log',
    'Showing all system access and change events.\n\n' +
    'This log tracks:\n' +
    '‚Ä¢ User access\n' +
    '‚Ä¢ Data changes\n' +
    '‚Ä¢ Permission checks\n' +
    '‚Ä¢ Security events\n\n' +
    `Log is limited to last ${AUDIT_LOG_CONFIG.MAX_ENTRIES.toLocaleString()} events.`,
    SpreadsheetApp.getUi().ButtonSet.OK
  );
}

/**
 * Exports audit log to CSV (Admin only)
 */
function exportAuditLog() {
  requirePermission('view_audit_log', 'export audit log');

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const auditSheet = ss.getSheetByName(AUDIT_LOG_CONFIG.LOG_SHEET_NAME);

  if (!auditSheet) {
    SpreadsheetApp.getUi().alert(ERROR_MESSAGES.SHEET_NOT_FOUND(AUDIT_LOG_CONFIG.LOG_SHEET_NAME));
    return;
  }

  // This would create a CSV file in Google Drive
  const data = auditSheet.getDataRange().getValues();
  const csv = data.map(function(row) { return row.join(','); }).join('\n');

  const folder = DriveApp.getRootFolder();
  const file = folder.createFile(
    `Audit_Log_${new Date().toISOString().slice(0, 10)}.csv`,
    csv,
    MimeType.CSV
  );

  logAudit('EXPORT_AUDIT_LOG', 'Exported audit log to CSV');

  SpreadsheetApp.getUi().alert(
    ERROR_MESSAGES.SUCCESS('Export Complete'),
    `Audit log exported to:\n${file.getName()}\n\nFile ID: ${file.getId()}`,
    SpreadsheetApp.getUi().ButtonSet.OK
  );
}



// ================================================================================
// MODULE: SeedNuke.gs
// Source: SeedNuke.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * SEED NUKE - Remove All Seeded Data and Exit Demo Mode
 * ------------------------------------------------------------------------====
 *
 * Allows stewards to remove all test/seeded data and exit demo mode.
 * After nuking, the dashboard will be ready for production use.
 *
 * Features:
 * - Removes all seeded members and grievances
 * - Keeps headers and structure intact
 * - Recalculates all dashboards
 * - Shows getting started reminder
 * - Hides seed menu options after nuke
 *
 * ------------------------------------------------------------------------====
 */

/**
 * Main function to nuke all seeded data
 */
function nukeSeedData() {
  const ui = SpreadsheetApp.getUi();

  // Confirmation dialog
  const response = ui.alert(
    '‚ö†Ô∏è WARNING: Remove All Seeded Data',
    'This will PERMANENTLY remove all test data from:\n\n' +
    '‚Ä¢ Member Directory (all members)\n' +
    '‚Ä¢ Grievance Log (all grievances)\n' +
    '‚Ä¢ Steward Workload (all records)\n\n' +
    'Headers and sheet structure will be preserved.\n\n' +
    'This action CANNOT be undone!\n\n' +
    'Are you sure you want to proceed?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    ui.alert('‚úÖ Operation cancelled. No data was removed.');
    return;
  }

  // Double confirmation
  const finalConfirm = ui.alert(
    'üö® FINAL CONFIRMATION',
    'This is your last chance!\n\n' +
    'ALL test data will be permanently deleted.\n\n' +
    'Click YES to proceed with data removal.',
    ui.ButtonSet.YES_NO
  );

  if (finalConfirm !== ui.Button.YES) {
    ui.alert('‚úÖ Operation cancelled. No data was removed.');
    return;
  }

  try {
    // Show progress
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    ui.alert('‚è≥ Removing seeded data...\n\nThis may take a moment. Please wait.');

    // Step 1: Clear Member Directory (keep headers)
    clearMemberDirectory();

    // Step 2: Clear Grievance Log (keep headers)
    clearGrievanceLog();

    // Step 3: Clear Steward Workload (keep headers)
    clearStewardWorkload();

    // Step 4: Recalculate all dashboards
    rebuildDashboard();

    // Step 5: Set flag that data has been nuked
    PropertiesService.getScriptProperties().setProperty('SEED_NUKED', 'true');

    // Step 6: Show getting started reminder
    showPostNukeGuidance();

  } catch (error) {
    ui.alert('‚ùå Error during data removal: ' + error.message);
    Logger.log('Error in nukeSeedData: ' + error.message);
  }
}

/**
 * Clears Member Directory while preserving headers
 */
function clearMemberDirectory() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (!sheet) {
    throw new Error('Member Directory not found');
  }

  const lastRow = sheet.getLastRow();

  if (lastRow > 1) {
    // Delete all rows except header
    sheet.deleteRows(2, lastRow - 1);
  }

  Logger.log('Member Directory cleared: ' + (lastRow - 1) + ' members removed');
}

/**
 * Clears Grievance Log while preserving headers
 */
function clearGrievanceLog() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!sheet) {
    throw new Error('Grievance Log not found');
  }

  const lastRow = sheet.getLastRow();

  if (lastRow > 1) {
    // Delete all rows except header
    sheet.deleteRows(2, lastRow - 1);
  }

  Logger.log('Grievance Log cleared: ' + (lastRow - 1) + ' grievances removed');
}

/**
 * Clears Steward Workload while preserving headers
 */
function clearStewardWorkload() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEETS.STEWARD_WORKLOAD);

  if (!sheet) {
    // Sheet doesn't exist, skip
    return;
  }

  const lastRow = sheet.getLastRow();

  if (lastRow > 1) {
    // Delete all rows except header
    sheet.deleteRows(2, lastRow - 1);
  }

  Logger.log('Steward Workload cleared');
}

/**
 * Shows post-nuke guidance to the user
 */
function showPostNukeGuidance() {
  const ui = SpreadsheetApp.getUi();

  const html = HtmlService.createHtmlOutput(`
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin: 0;
    }
    .container {
      background: white;
      color: #333;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      max-width: 600px;
      margin: 0 auto;
    }
    h1 {
      color: #1a73e8;
      margin-top: 0;
      font-size: 28px;
      border-bottom: 3px solid #1a73e8;
      padding-bottom: 15px;
    }
    .success-icon {
      font-size: 64px;
      text-align: center;
      margin: 20px 0;
    }
    .info-box {
      background: #e8f0fe;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      border-left: 5px solid #1a73e8;
    }
    .warning-box {
      background: #fff3cd;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      border-left: 5px solid #ff9800;
    }
    .checklist {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .checklist h3 {
      margin-top: 0;
      color: #1a73e8;
    }
    .checklist ul {
      list-style: none;
      padding: 0;
    }
    .checklist li {
      padding: 10px 0;
      border-bottom: 1px solid #ddd;
    }
    .checklist li:last-child {
      border-bottom: none;
    }
    .checklist li::before {
      content: "‚òëÔ∏è ";
      margin-right: 10px;
    }
    .button-container {
      text-align: center;
      margin-top: 30px;
    }
    button {
      padding: 12px 30px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      background: #1a73e8;
      color: white;
      cursor: pointer;
      transition: all 0.3s;
    }
    button:hover {
      background: #1557b0;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(26,115,232,0.4);
    }
    .footer {
      text-align: center;
      margin-top: 30px;
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="success-icon">üéâ</div>

    <h1>Welcome to Production Mode!</h1>

    <div class="info-box">
      <strong>‚úÖ Success!</strong><br>
      All seeded test data has been removed. Your dashboard is now ready for real member and grievance data.
    </div>

    <div class="warning-box">
      <strong>‚ö†Ô∏è Important Next Steps</strong><br>
      Before you start using the dashboard, please complete the setup steps below.
    </div>

    <div class="checklist">
      <h3>üìã Getting Started Checklist</h3>
      <ul>
        <li><strong>Configure Steward Contact Info</strong><br>
            Go to the <strong>‚öôÔ∏è Config</strong> tab and enter your steward contact information in column U (rows 2-4).
            This will be used when starting grievances from the Member Directory.</li>

        <li><strong>Set Up Google Form (Optional)</strong><br>
            If you want to use the grievance workflow feature, create a Google Form for grievance submissions
            and update the form URL and field IDs in the script configuration.</li>

        <li><strong>Add Your First Members</strong><br>
            Go to <strong>üë• Member Directory</strong> and start adding your members.
            You can enter them manually or import from a CSV file.</li>

        <li><strong>Review Config Settings</strong><br>
            Check the <strong>‚öôÔ∏è Config</strong> tab to ensure all dropdown values
            (job titles, locations, units, etc.) match your organization's needs.</li>

        <li><strong>Customize Dashboards</strong><br>
            Explore the various dashboard views and use the <strong>üéØ Interactive Dashboard</strong>
            to create custom views for your needs.</li>

        <li><strong>Set Up Triggers (Recommended)</strong><br>
            Go to <strong>509 Tools > Utilities > Setup Triggers</strong> to enable automatic
            calculations and deadline tracking.</li>
      </ul>
    </div>

    <div class="info-box">
      <strong>üí° Tip:</strong> The seed data menu options have been hidden. If you need to re-seed test data
      for training purposes, you can access the seeding functions from the script editor.
    </div>

    <div class="button-container">
      <button onclick="google.script.host.close()">Get Started!</button>
    </div>

    <div class="footer">
      SEIU Local 509 Dashboard | Ready for Production Use
    </div>
  </div>
</body>
</html>
  `).setWidth(700).setHeight(600);

  ui.showModalDialog(html, 'üéâ Seeded Data Removed Successfully');
}

/**
 * Checks if seed data has been nuked
 */
function isSeedNuked() {
  const props = PropertiesService.getScriptProperties();
  return props.getProperty('SEED_NUKED') === 'true';
}

/**
 * Resets the nuke flag (for development/testing only)
 */
function resetNukeFlag() {
  PropertiesService.getScriptProperties().deleteProperty('SEED_NUKED');
  SpreadsheetApp.getUi().alert('‚úÖ Nuke flag reset. Seed menu will be visible again.');
}

/**
 * Shows a quick reminder dialog to enter steward contact info
 */
function showStewardContactReminder() {
  const ui = SpreadsheetApp.getUi();

  const response = ui.alert(
    'üëã Quick Setup Reminder',
    'Have you entered your steward contact information in the Config tab?\n\n' +
    'This information is used when starting grievances from the Member Directory.\n\n' +
    'Go to: ‚öôÔ∏è Config > Column U (Steward Contact Information)\n\n' +
    'Click YES if you\'ve already done this, or NO to be reminded later.',
    ui.ButtonSet.YES_NO
  );

  if (response === ui.Button.YES) {
    PropertiesService.getUserProperties().setProperty('STEWARD_INFO_CONFIGURED', 'true');
  }
}

/**
 * Checks if steward info is configured
 */
function isStewardInfoConfigured() {
  const props = PropertiesService.getUserProperties();
  return props.getProperty('STEWARD_INFO_CONFIGURED') === 'true';
}

/**
 * Shows getting started guide
 */
function showGettingStartedGuide() {
  const ui = SpreadsheetApp.getUi();

  const html = HtmlService.createHtmlOutput(`
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      max-width: 800px;
      margin: 0 auto;
    }
    h1 {
      color: #1a73e8;
      border-bottom: 3px solid #1a73e8;
      padding-bottom: 10px;
    }
    h2 {
      color: #1a73e8;
      margin-top: 30px;
    }
    .step {
      background: #f8f9fa;
      padding: 15px;
      margin: 15px 0;
      border-left: 4px solid #1a73e8;
      border-radius: 4px;
    }
    .step h3 {
      margin-top: 0;
      color: #333;
    }
    code {
      background: #e8f0fe;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
    button {
      padding: 10px 20px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover {
      background: #1557b0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìö Getting Started Guide</h1>

    <p>Welcome to the SEIU Local 509 Dashboard! Follow these steps to get started:</p>

    <div class="step">
      <h3>1Ô∏è‚É£ Configure Steward Contact Information</h3>
      <p>Go to the <code>‚öôÔ∏è Config</code> tab and scroll to column U.</p>
      <p>Enter:</p>
      <ul>
        <li>Steward Name (Row 2)</li>
        <li>Steward Email (Row 3)</li>
        <li>Steward Phone (Row 4)</li>
      </ul>
      <p>This information will be automatically included when starting new grievances.</p>
    </div>

    <div class="step">
      <h3>2Ô∏è‚É£ Add Members to the Directory</h3>
      <p>Go to the <code>üë• Member Directory</code> tab and start adding member information.</p>
      <p>You can:</p>
      <ul>
        <li>Enter members manually</li>
        <li>Import from a CSV file</li>
        <li>Copy and paste from another spreadsheet</li>
      </ul>
    </div>

    <div class="step">
      <h3>3Ô∏è‚É£ Review Configuration Settings</h3>
      <p>In the <code>‚öôÔ∏è Config</code> tab, review the dropdown lists to ensure they match your needs:</p>
      <ul>
        <li>Job Titles</li>
        <li>Work Locations</li>
        <li>Grievance Types</li>
        <li>And more...</li>
      </ul>
    </div>

    <div class="step">
      <h3>4Ô∏è‚É£ Set Up Automatic Calculations</h3>
      <p>Go to <code>509 Tools > Utilities > Setup Triggers</code></p>
      <p>This enables automatic deadline calculations and dashboard updates.</p>
    </div>

    <div class="step">
      <h3>5Ô∏è‚É£ Explore the Dashboards</h3>
      <p>Check out the various dashboard views:</p>
      <ul>
        <li><code>üìä Main Dashboard</code> - Overview of all metrics</li>
        <li><code>üéØ Interactive Dashboard</code> - Customizable views</li>
        <li><code>üë®‚Äç‚öñÔ∏è Steward Workload</code> - Track steward assignments</li>
      </ul>
    </div>

    <h2>üöÄ Optional: Set Up Grievance Workflow</h2>

    <div class="step">
      <h3>Create a Google Form for Grievances</h3>
      <p>If you want to use the automated grievance workflow:</p>
      <ol>
        <li>Create a Google Form with fields for grievance information</li>
        <li>Link the form to this spreadsheet</li>
        <li>Update the form URL and field IDs in the script configuration</li>
        <li>Set up a form submission trigger</li>
      </ol>
      <p>See the documentation in <code>GrievanceWorkflow.gs</code> for details.</p>
    </div>

    <button onclick="google.script.host.close()">Let's Go!</button>
  </div>
</body>
</html>
  `).setWidth(900).setHeight(700);

  ui.showModalDialog(html, 'Getting Started Guide');
}

/**
 * Rebuilds all dashboard calculations and charts
 * Called after data is cleared/nuked to refresh metrics
 */
function rebuildDashboard() {
  try {
    // Call the main refresh function from Code.gs
    if (typeof refreshCalculations === 'function') {
      refreshCalculations();
    }

    // Rebuild interactive dashboard if it exists
    if (typeof rebuildInteractiveDashboard === 'function') {
      rebuildInteractiveDashboard();
    }

    Logger.log('Dashboard rebuilt successfully');
  } catch (error) {
    Logger.log('Error rebuilding dashboard: ' + error.message);
    // Non-critical error, continue execution
  }
}



// ================================================================================
// MODULE: SmartAutoAssignment.gs
// Source: SmartAutoAssignment.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * SMART AUTO-ASSIGNMENT SYSTEM
 * ------------------------------------------------------------------------====
 *
 * Intelligently assigns stewards to grievances based on multiple factors
 * Features:
 * - Workload balancing (assign to least busy steward)
 * - Location matching (same worksite/unit)
 * - Expertise matching (issue type experience)
 * - Availability checking
 * - Manual override capability
 * - Assignment history tracking
 * - Performance metrics
 */

/**
 * Assignment algorithm weights
 */
ASSIGNMENT_WEIGHTS = {
  WORKLOAD: 0.4,        // 40% - Balance caseload
  LOCATION: 0.3,        // 30% - Same location preference
  EXPERTISE: 0.2,       // 20% - Issue type experience
  AVAILABILITY: 0.1     // 10% - Current availability
};

/**
 * Auto-assigns a steward to a grievance
 * @param {string} grievanceId - Grievance ID
 * @param {Object} preferences - Assignment preferences
 * @returns {Object} Assignment result
 */
function autoAssignSteward(grievanceId, preferences = {}) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

  // Get grievance details
  const grievance = getGrievanceDetails(grievanceId);

  if (!grievance) {
    return {
      success: false,
      error: `Grievance ${grievanceId} not found`
    };
  }

  // Get all available stewards
  const stewards = getAllStewards();

  if (stewards.length === 0) {
    return {
      success: false,
      error: 'No stewards available in the system'
    };
  }

  // Score each steward
  const scoredStewards = stewards.map(function(steward) { return {
    ...steward,
    score: calculateAssignmentScore(steward, grievance, preferences)
  };});

  // Sort by score (descending)
  scoredStewards.sort(function(a, b) { return b.score - a.score; });

  // Get top candidate
  const selectedSteward = scoredStewards[0];

  // Assign steward
  const assignmentResult = assignStewardToGrievance(grievanceId, selectedSteward);

  // Log assignment
  logAssignment(grievanceId, selectedSteward, scoredStewards.slice(0, 3));

  return {
    success: true,
    assignedSteward: selectedSteward.name,
    score: selectedSteward.score,
    reasoning: generateAssignmentReasoning(selectedSteward, grievance),
    alternates: scoredStewards.slice(1, 4).map(function(s) { return {
      name: s.name,
      score: s.score
    };})
  };
}

/**
 * Gets grievance details
 * @param {string} grievanceId - Grievance ID
 * @returns {Object} Grievance details
 */
function getGrievanceDetails(grievanceId) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  const lastRow = grievanceSheet.getLastRow();

  if (lastRow < 2) return null;

  const data = grievanceSheet.getRange(2, 1, lastRow - 1, 28).getValues();

  for (let i = 0; i < data.length; i++) {
    if (data[i][GRIEVANCE_COLS.GRIEVANCE_ID - 1] === grievanceId) {
      return {
        id: data[i][GRIEVANCE_COLS.GRIEVANCE_ID - 1],
        memberId: data[i][GRIEVANCE_COLS.MEMBER_ID - 1],
        memberName: `${data[i][GRIEVANCE_COLS.FIRST_NAME - 1]} ${data[i][GRIEVANCE_COLS.LAST_NAME - 1]}`,
        issueType: data[i][GRIEVANCE_COLS.ISSUE_CATEGORY - 1],
        location: data[i][GRIEVANCE_COLS.LOCATION - 1] || '',
        unit: data[i][GRIEVANCE_COLS.UNIT - 1] || '',
        row: i + 2
      };
    }
  }

  return null;
}

/**
 * Gets all stewards from Member Directory
 * @returns {Array} Array of steward objects
 */
function getAllStewards() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);
  const lastRow = memberSheet.getLastRow();

  if (lastRow < 2) return [];

  const data = memberSheet.getRange(2, 1, lastRow - 1, 28).getValues();

  const stewards = [];

  data.forEach(function(row, index) {
    const isSteward = row[MEMBER_COLS.IS_STEWARD - 1];

    if (isSteward === 'Yes') {
      stewards.push({
        id: row[MEMBER_COLS.MEMBER_ID - 1],
        name: `${row[MEMBER_COLS.FIRST_NAME - 1]} ${row[MEMBER_COLS.LAST_NAME - 1]}`,
        email: row[MEMBER_COLS.EMAIL - 1],
        location: row[MEMBER_COLS.WORK_LOCATION - 1] || '',
        unit: row[MEMBER_COLS.UNIT - 1] || '',
        row: index + 2,
        currentCaseload: getCurrentCaseload(row[MEMBER_COLS.MEMBER_ID - 1]),
        expertise: getStewardExpertise(row[MEMBER_COLS.MEMBER_ID - 1])
      });
    }
  });

  return stewards;
}

/**
 * Gets current caseload for a steward
 * @param {string} memberId - Member ID
 * @returns {number} Number of open grievances
 */
function getCurrentCaseload(memberId) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  const lastRow = grievanceSheet.getLastRow();

  if (lastRow < 2) return 0;

  const data = grievanceSheet.getRange(2, 1, lastRow - 1, 28).getValues();

  let count = 0;

  data.forEach(function(row) {
    const assignedSteward = row[GRIEVANCE_COLS.STEWARD - 1];
    const status = row[GRIEVANCE_COLS.STATUS - 1];

    if (assignedSteward && assignedSteward.includes(memberId) && status === 'Open') {
      count++;
    }
  });

  return count;
}

/**
 * Gets steward's expertise (issue types they've handled)
 * @param {string} memberId - Member ID
 * @returns {Object} Issue type counts
 */
function getStewardExpertise(memberId) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  const lastRow = grievanceSheet.getLastRow();

  if (lastRow < 2) return {};

  const data = grievanceSheet.getRange(2, 1, lastRow - 1, 28).getValues();

  const expertise = {};

  data.forEach(function(row) {
    const assignedSteward = row[GRIEVANCE_COLS.STEWARD - 1];
    const issueType = row[GRIEVANCE_COLS.ISSUE_CATEGORY - 1];

    if (assignedSteward && assignedSteward.includes(memberId) && issueType) {
      expertise[issueType] = (expertise[issueType] || 0) + 1;
    }
  });

  return expertise;
}

/**
 * Calculates assignment score for a steward
 * @param {Object} steward - Steward details
 * @param {Object} grievance - Grievance details
 * @param {Object} preferences - Assignment preferences
 * @returns {number} Score (0-100)
 */
function calculateAssignmentScore(steward, grievance, preferences) {
  const weights = { ...ASSIGNMENT_WEIGHTS, ...preferences };

  // Workload score (inverse - lower caseload = higher score)
  const maxCaseload = 20; // Assume max reasonable caseload
  const workloadScore = Math.max(0, (maxCaseload - steward.currentCaseload) / maxCaseload) * 100;

  // Location score
  const locationScore = steward.location === grievance.location ? 100 : 0;

  // Expertise score
  const expertiseCount = steward.expertise[grievance.issueType] || 0;
  const maxExpertise = Math.max(...Object.values(steward.expertise), 1);
  const expertiseScore = (expertiseCount / maxExpertise) * 100;

  // Availability score (for now, always 100 - can be enhanced)
  const availabilityScore = 100;

  // Calculate weighted average
  const finalScore =
    (workloadScore * weights.WORKLOAD) +
    (locationScore * weights.LOCATION) +
    (expertiseScore * weights.EXPERTISE) +
    (availabilityScore * weights.AVAILABILITY);

  return Math.round(finalScore);
}

/**
 * Assigns steward to grievance
 * @param {string} grievanceId - Grievance ID
 * @param {Object} steward - Steward object
 * @returns {boolean} Success
 */
function assignStewardToGrievance(grievanceId, steward) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  const grievance = getGrievanceDetails(grievanceId);

  if (!grievance) return false;

  // Update assigned steward
  grievanceSheet.getRange(grievance.row, GRIEVANCE_COLS.STEWARD).setValue(steward.name);

  // Update steward email if available
  if (steward.email) {
    grievanceSheet.getRange(grievance.row, GRIEVANCE_COLS.STEWARD + 1).setValue(steward.email);
  }

  return true;
}

/**
 * Generates reasoning for assignment
 * @param {Object} steward - Selected steward
 * @param {Object} grievance - Grievance details
 * @returns {string} Reasoning text
 */
function generateAssignmentReasoning(steward, grievance) {
  const reasons = [];

  if (steward.location === grievance.location) {
    reasons.push(`Same location (${steward.location})`);
  }

  const expertiseCount = steward.expertise[grievance.issueType] || 0;
  if (expertiseCount > 0) {
    reasons.push(`Has handled ${expertiseCount} similar ${grievance.issueType} case(s)`);
  }

  reasons.push(`Current caseload: ${steward.currentCaseload} case(s)`);

  if (steward.currentCaseload < 5) {
    reasons.push('Low caseload - has capacity');
  } else if (steward.currentCaseload < 10) {
    reasons.push('Moderate caseload');
  } else {
    reasons.push('High caseload - may need support');
  }

  return reasons.join('\n‚Ä¢ ');
}

/**
 * Logs assignment for tracking
 * @param {string} grievanceId - Grievance ID
 * @param {Object} selectedSteward - Selected steward
 * @param {Array} topCandidates - Top 3 candidates
 */
function logAssignment(grievanceId, selectedSteward, topCandidates) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let assignmentLog = ss.getSheetByName('ü§ñ Auto-Assignment Log');

  if (!assignmentLog) {
    assignmentLog = createAutoAssignmentLogSheet();
  }

  const timestamp = new Date();
  const user = Session.getActiveUser().getEmail() || 'System';

  const lastRow = assignmentLog.getLastRow();
  const newRow = [
    timestamp,
    grievanceId,
    selectedSteward.name,
    selectedSteward.score,
    selectedSteward.currentCaseload,
    topCandidates.map(function(s) { return `${s.name} (${s.score})`; }).join(', '),
    user
  ];

  assignmentLog.getRange(lastRow + 1, 1, 1, 7).setValues([newRow]);
}

/**
 * Creates Auto-Assignment Log sheet
 * @returns {Sheet} Assignment log sheet
 */
function createAutoAssignmentLogSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.insertSheet('ü§ñ Auto-Assignment Log');

  // Set headers
  const headers = [
    'Timestamp',
    'Grievance ID',
    'Assigned Steward',
    'Score',
    'Caseload',
    'Top Candidates',
    'Assigned By'
  ];

  sheet.getRange(1, 1, 1, 7).setValues([headers]);

  // Format header
  sheet.getRange(1, 1, 1, 7)
    .setBackground('#1a73e8')
    .setFontColor('#ffffff')
    .setFontWeight('bold')
    .setHorizontalAlignment('center');

  // Set column widths
  sheet.setColumnWidth(1, 150); // Timestamp
  sheet.setColumnWidth(2, 120); // Grievance ID
  sheet.setColumnWidth(3, 150); // Assigned Steward
  sheet.setColumnWidth(4, 80);  // Score
  sheet.setColumnWidth(5, 80);  // Caseload
  sheet.setColumnWidth(6, 300); // Top Candidates
  sheet.setColumnWidth(7, 200); // Assigned By

  // Freeze header
  sheet.setFrozenRows(1);

  return sheet;
}

/**
 * Shows auto-assignment dialog for a grievance
 */
function showAutoAssignDialog() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const activeSheet = ss.getActiveSheet();

  if (activeSheet.getName() !== SHEETS.GRIEVANCE_LOG) {
    ui.alert(
      '‚ö†Ô∏è Wrong Sheet',
      'Please select a grievance row in the Grievance Log sheet.',
      ui.ButtonSet.OK
    );
    return;
  }

  const activeRow = activeSheet.getActiveCell().getRow();

  if (activeRow < 2) {
    ui.alert('‚ö†Ô∏è Invalid Selection');
    return;
  }

  const grievanceId = activeSheet.getRange(activeRow, GRIEVANCE_COLS.GRIEVANCE_ID).getValue();

  if (!grievanceId) {
    ui.alert('‚ö†Ô∏è No Grievance ID found.');
    return;
  }

  // Check if already assigned
  const currentAssignment = activeSheet.getRange(activeRow, GRIEVANCE_COLS.STEWARD).getValue();

  if (currentAssignment) {
    const confirmResponse = ui.alert(
      '‚ö†Ô∏è Already Assigned',
      `This grievance is already assigned to: ${currentAssignment}\n\nReassign automatically?`,
      ui.ButtonSet.YES_NO
    );

    if (confirmResponse !== ui.Button.YES) {
      return;
    }
  }

  SpreadsheetApp.getActiveSpreadsheet().toast('ü§ñ Analyzing stewards...', 'Please wait', -1);

  try {
    const result = autoAssignSteward(grievanceId);

    if (!result.success) {
      ui.alert('‚ùå Assignment Failed', result.error, ui.ButtonSet.OK);
      return;
    }

    const alternatesText = result.alternates
      .map(function(a) { return `  ${a.name} (score: ${a.score})`; })
      .join('\n');

    ui.alert(
      '‚úÖ Auto-Assignment Complete',
      `Assigned to: ${result.assignedSteward}\n` +
      `Assignment Score: ${result.score}/100\n\n` +
      `Reasoning:\n‚Ä¢ ${result.reasoning}\n\n` +
      `Alternative Candidates:\n${alternatesText}`,
      ui.ButtonSet.OK
    );

  } catch (error) {
    ui.alert('‚ùå Error', error.message, ui.ButtonSet.OK);
  }
}

/**
 * Batch auto-assigns stewards to selected grievances
 */
function batchAutoAssign() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const activeSheet = ss.getActiveSheet();

  if (activeSheet.getName() !== SHEETS.GRIEVANCE_LOG) {
    ui.alert('‚ö†Ô∏è Wrong Sheet');
    return;
  }

  const selection = activeSheet.getActiveRange();
  const startRow = selection.getRow();
  const numRows = selection.getNumRows();

  if (startRow === 1 || numRows === 0) {
    ui.alert('‚ö†Ô∏è Please select grievance rows.');
    return;
  }

  const rows = Array.from({ length: numRows }, function(_, i) { return startRow + i; });

  // Count unassigned
  let unassigned = 0;
  rows.forEach(function(row) {
    const assigned = activeSheet.getRange(row, GRIEVANCE_COLS.STEWARD).getValue();
    if (!assigned) {
      unassigned++;
    }
  });

  const confirmResponse = ui.alert(
    'ü§ñ Batch Auto-Assignment',
    `Selected: ${rows.length} grievance(s)\n` +
    `Unassigned: ${unassigned}\n\n` +
    'Auto-assign stewards to all selected grievances?',
    ui.ButtonSet.YES_NO
  );

  if (confirmResponse !== ui.Button.YES) {
    return;
  }

  SpreadsheetApp.getActiveSpreadsheet().toast('ü§ñ Auto-assigning...', 'Please wait', -1);

  let assigned = 0;
  let skipped = 0;
  let errors = 0;

  rows.forEach(function(row) {
    const grievanceId = activeSheet.getRange(row, GRIEVANCE_COLS.GRIEVANCE_ID).getValue();
    const currentAssignment = activeSheet.getRange(row, GRIEVANCE_COLS.STEWARD).getValue();

    if (!grievanceId) {
      skipped++;
      return;
    }

    if (currentAssignment) {
      skipped++;
      return;
    }

    try {
      const result = autoAssignSteward(grievanceId);

      if (result.success) {
        assigned++;
      } else {
        errors++;
        Logger.log(`Error assigning ${grievanceId}: ${result.error}`);
      }

    } catch (error) {
      errors++;
      Logger.log(`Error assigning ${grievanceId}: ${error.message}`);
    }
  });

  ui.alert(
    '‚úÖ Batch Auto-Assignment Complete',
    `Successfully assigned: ${assigned}\n` +
    `Skipped (already assigned): ${skipped}\n` +
    `Errors: ${errors}`,
    ui.ButtonSet.OK
  );
}

/**
 * Shows steward workload dashboard
 */
function showStewardWorkloadDashboard() {
  const stewards = getAllStewards();

  if (stewards.length === 0) {
    SpreadsheetApp.getUi().alert('No stewards found in the system.');
    return;
  }

  // Sort by caseload (descending)
  stewards.sort(function(a, b) { return b.currentCaseload - a.currentCaseload; });

  const stewardsList = stewards
    .map(function(s) { return `
      <div class="steward-item" style="border-left-color: ${getCaseloadColor(s.currentCaseload)}">
        <div class="steward-name">${s.name}</div>
        <div class="steward-details">
          <strong>Caseload:</strong> ${s.currentCaseload} open case(s) |
          <strong>Location:</strong> ${s.location || 'N/A'} |
          <strong>Unit:</strong> ${s.unit || 'N/A'}
        </div>
        <div class="steward-expertise">
          <strong>Expertise:</strong> ${Object.keys(s.expertise).length > 0
            ? Object.entries(s.expertise)
                .sort(function(a, b) { return b[1] - a[1]; })
                .slice(0, 3)
                .map(function([type, count]) { return `${type} (${count})`; })
                .join(', ')
            : 'No cases yet'}
        </div>
      </div>
    `; })
    .join('');

  const avgCaseload = stewards.reduce(function(sum, s) { return sum + s.currentCaseload; }, 0) / stewards.length;

  const html = `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: 'Roboto', Arial, sans-serif; padding: 20px; margin: 0; background: #f5f5f5; }
    .container { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h2 { color: #1a73e8; margin-top: 0; border-bottom: 3px solid #1a73e8; padding-bottom: 10px; }
    .summary { background: #e8f0fe; padding: 15px; border-radius: 4px; margin: 15px 0; border-left: 4px solid #1a73e8; }
    .steward-item { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 4px; border-left: 5px solid; }
    .steward-name { font-weight: bold; font-size: 16px; color: #333; margin-bottom: 5px; }
    .steward-details { font-size: 13px; color: #666; margin: 5px 0; }
    .steward-expertise { font-size: 12px; color: #888; margin-top: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>üë• Steward Workload Dashboard</h2>

    <div class="summary">
      <strong>Total Stewards:</strong> ${stewards.length}<br>
      <strong>Average Caseload:</strong> ${avgCaseload.toFixed(1)} cases/steward<br>
      <strong>Total Open Cases:</strong> ${stewards.reduce(function(sum, s) { return sum + s.currentCaseload; }, 0)}
    </div>

    <div style="max-height: 500px; overflow-y: auto;">
      ${stewardsList}
    </div>
  </div>
</body>
</html>
  `;

  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(750)
    .setHeight(650);

  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'üë• Steward Workload Dashboard');
}

/**
 * Gets color for caseload visualization
 * @param {number} caseload - Number of cases
 * @returns {string} Color code
 */
function getCaseloadColor(caseload) {
  if (caseload === 0) return '#9e9e9e';
  if (caseload < 5) return '#4caf50';
  if (caseload < 10) return '#ffeb3b';
  if (caseload < 15) return '#ff9800';
  return '#f44336';
}



// ================================================================================
// MODULE: TransactionRollback.gs
// Source: TransactionRollback.gs
// ================================================================================

/****************************************************
 * TRANSACTION ROLLBACK SYSTEM
 * Phase 6 - Critical Priority
 *
 * Provides transaction support with rollback capability
 * Prevents data corruption from failed operations
 *
 * Based on ADDITIONAL_ENHANCEMENTS.md Phase 1
 ****************************************************/

/**
 * Transaction class for managing atomic operations with rollback
 * Usage:
 *   const txn = new Transaction(ss);
 *   txn.snapshot('Member Directory');
 *   try {
 *     // Make changes...
 *     txn.commit();
 *   } catch (error) {
 *     txn.rollback();
 *   }
 */
class Transaction {
  /**
   * Create a new transaction
   * @param {SpreadsheetApp.Spreadsheet} spreadsheet - The spreadsheet to manage
   */
  constructor(spreadsheet) {
    this.ss = spreadsheet;
    this.snapshots = new Map();
    this.startTime = new Date();
    this.transactionId = Utilities.getUuid();
    this.committed = false;
    this.rolledBack = false;
  }

  /**
   * Take a snapshot of a sheet's current state
   * @param {string} sheetName - Name of the sheet to snapshot
   * @returns {boolean} Success status
   */
  snapshot(sheetName) {
    try {
      const sheet = this.ss.getSheetByName(sheetName);

      if (!sheet) {
        Logger.log(`Transaction ${this.transactionId}: Sheet "${sheetName}" not found for snapshot`);
        return false;
      }

      const lastRow = sheet.getLastRow();
      const lastCol = sheet.getLastColumn();

      if (lastRow === 0 || lastCol === 0) {
        // Empty sheet - store empty snapshot
        this.snapshots.set(sheetName, {
          data: [],
          lastRow: 0,
          lastCol: 0,
          timestamp: new Date()
        });
        Logger.log(`Transaction ${this.transactionId}: Snapshotted empty sheet "${sheetName}"`);
        return true;
      }

      // Get all data including formulas
      const data = sheet.getRange(1, 1, lastRow, lastCol).getValues();
      const formulas = sheet.getRange(1, 1, lastRow, lastCol).getFormulas();

      this.snapshots.set(sheetName, {
        data: data,
        formulas: formulas,
        lastRow: lastRow,
        lastCol: lastCol,
        timestamp: new Date()
      });

      Logger.log(`Transaction ${this.transactionId}: Snapshotted "${sheetName}" (${lastRow}x${lastCol})`);
      return true;

    } catch (error) {
      Logger.log(`Transaction ${this.transactionId}: Error snapshotting "${sheetName}": ${error.message}`);
      return false;
    }
  }

  /**
   * Snapshot multiple sheets at once
   * @param {Array<string>} sheetNames - Array of sheet names
   * @returns {number} Number of successful snapshots
   */
  snapshotMultiple(sheetNames) {
    let successCount = 0;

    for (const sheetName of sheetNames) {
      if (this.snapshot(sheetName)) {
        successCount++;
      }
    }

    return successCount;
  }

  /**
   * Commit the transaction and clear snapshots
   */
  commit() {
    if (this.rolledBack) {
      throw new Error('Cannot commit a rolled-back transaction');
    }

    if (this.committed) {
      Logger.log(`Transaction ${this.transactionId}: Already committed`);
      return;
    }

    const duration = new Date() - this.startTime;

    // Log successful commit
    if (typeof auditLog === 'function') {
      auditLog('TRANSACTION_COMMIT', {
        transactionId: this.transactionId,
        duration: duration,
        sheetsModified: this.snapshots.size,
        status: 'SUCCESS'
      });
    }

    Logger.log(`Transaction ${this.transactionId}: Committed (${duration}ms, ${this.snapshots.size} sheets)`);

    // Clear snapshots to free memory
    this.snapshots.clear();
    this.committed = true;
  }

  /**
   * Rollback the transaction and restore all snapshotted sheets
   * @returns {Object} Rollback statistics
   */
  rollback() {
    if (this.committed) {
      throw new Error('Cannot rollback a committed transaction');
    }

    if (this.rolledBack) {
      Logger.log(`Transaction ${this.transactionId}: Already rolled back`);
      return {
        sheetsRestored: 0,
        message: 'Already rolled back'
      };
    }

    const duration = new Date() - this.startTime;
    let sheetsRestored = 0;
    const errors = [];

    Logger.log(`Transaction ${this.transactionId}: Starting rollback of ${this.snapshots.size} sheets...`);

    // Restore each snapshotted sheet
    for (const [sheetName, snapshot] of this.snapshots) {
      try {
        const sheet = this.ss.getSheetByName(sheetName);

        if (!sheet) {
          errors.push(`Sheet "${sheetName}" no longer exists`);
          continue;
        }

        // Clear current content
        if (sheet.getLastRow() > 0) {
          sheet.clear();
        }

        // Restore data if snapshot had content
        if (snapshot.data.length > 0) {
          // First restore values
          sheet.getRange(1, 1, snapshot.lastRow, snapshot.lastCol).setValues(snapshot.data);

          // Then restore formulas where they existed
          for (let row = 0; row < snapshot.formulas.length; row++) {
            for (let col = 0; col < snapshot.formulas[row].length; col++) {
              if (snapshot.formulas[row][col]) {
                sheet.getRange(row + 1, col + 1).setFormula(snapshot.formulas[row][col]);
              }
            }
          }
        }

        sheetsRestored++;
        Logger.log(`Transaction ${this.transactionId}: Restored "${sheetName}"`);

      } catch (error) {
        errors.push(`Error restoring "${sheetName}": ${error.message}`);
        Logger.log(`Transaction ${this.transactionId}: Error restoring "${sheetName}": ${error.message}`);
      }
    }

    // Log rollback
    if (typeof auditLog === 'function') {
      auditLog('TRANSACTION_ROLLBACK', {
        transactionId: this.transactionId,
        duration: duration,
        sheetsRestored: sheetsRestored,
        errors: errors.length,
        status: 'ROLLBACK'
      });
    }

    Logger.log(`Transaction ${this.transactionId}: Rollback complete (${sheetsRestored} sheets restored, ${errors.length} errors)`);

    this.rolledBack = true;

    return {
      sheetsRestored: sheetsRestored,
      errors: errors,
      duration: duration,
      message: `Rolled back ${sheetsRestored} sheets (${errors.length} errors)`
    };
  }

  /**
   * Get transaction status
   * @returns {Object} Status information
   */
  getStatus() {
    return {
      transactionId: this.transactionId,
      startTime: this.startTime,
      duration: new Date() - this.startTime,
      snapshotCount: this.snapshots.size,
      committed: this.committed,
      rolledBack: this.rolledBack
    };
  }
}

/**
 * Seed all data with transaction rollback protection
 * Wraps the seeding operations in a transaction
 */
function seedAllWithRollback() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  const response = ui.alert(
    'Seed All Data with Rollback Protection?',
    'This will:\n' +
    '1. Take snapshots of Member Directory and Grievance Log\n' +
    '2. Seed 20,000 members\n' +
    '3. Seed 5,000 grievances\n' +
    '4. Recalculate all data\n\n' +
    'If any step fails, all changes will be automatically rolled back.\n\n' +
    'Continue?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return;
  }

  const txn = new Transaction(ss);

  try {
    ui.alert('Creating transaction snapshots...');

    // Take snapshots of sheets we'll modify
    txn.snapshotMultiple([
      SHEETS.MEMBER_DIR,
      SHEETS.GRIEVANCE_LOG,
      SHEETS.ANALYTICS
    ]);

    ui.alert('Snapshots created. Starting seeding operations...');

    // Execute seeding operations
    if (typeof SEED_20K_MEMBERS === 'function') {
      SEED_20K_MEMBERS();
    }

    if (typeof SEED_5K_GRIEVANCES === 'function') {
      SEED_5K_GRIEVANCES();
    }

    ui.alert('Data seeded. Recalculating...');

    // Recalculate
    if (typeof recalcAllMembers === 'function') {
      recalcAllMembers();
    }

    if (typeof recalcAllGrievancesBatched === 'function') {
      recalcAllGrievancesBatched();
    }

    if (typeof rebuildDashboard === 'function') {
      rebuildDashboard();
    }

    // Success - commit transaction
    txn.commit();

    ui.alert(
      'Success!',
      'All data seeded successfully.\n\n' +
      'Transaction committed and snapshots cleared.',
      ui.ButtonSet.OK
    );

  } catch (error) {
    // Failure - rollback transaction
    ui.alert(
      'Error Occurred - Rolling Back',
      'An error occurred during seeding:\n\n' +
      error.message + '\n\n' +
      'Rolling back all changes...',
      ui.ButtonSet.OK
    );

    const rollbackResult = txn.rollback();

    ui.alert(
      'Rollback Complete',
      rollbackResult.message + '\n\n' +
      'All changes have been reverted to the state before seeding started.',
      ui.ButtonSet.OK
    );

    // Log the error
    if (typeof logError === 'function') {
      logError(error, 'seedAllWithRollback', 'CRITICAL');
    }

    throw error;
  }
}

/**
 * Execute a function with transaction protection
 * Generic wrapper for any operation
 *
 * @param {Function} operation - Function to execute
 * @param {Array<string>} sheetNames - Sheets to snapshot
 * @param {string} operationName - Name for logging
 * @returns {*} Result from operation function
 */
function executeWithTransaction(operation, sheetNames, operationName = 'operation') {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const txn = new Transaction(ss);

  try {
    Logger.log(`Starting transaction for: ${operationName}`);

    // Take snapshots
    const snapshotted = txn.snapshotMultiple(sheetNames);
    Logger.log(`Snapshotted ${snapshotted} sheets`);

    // Execute the operation
    const result = operation();

    // Commit on success
    txn.commit();
    Logger.log(`Transaction committed for: ${operationName}`);

    return result;

  } catch (error) {
    Logger.log(`Transaction failed for ${operationName}: ${error.message}`);

    // Rollback on failure
    const rollbackResult = txn.rollback();
    Logger.log(`Rollback complete: ${rollbackResult.message}`);

    // Re-throw the error
    throw error;
  }
}

/**
 * Example: Clear all data with transaction protection
 */
function clearAllDataWithRollback() {
  const ui = SpreadsheetApp.getUi();

  const response = ui.alert(
    'Clear All Data with Rollback Protection?',
    'This will clear all member and grievance data.\n\n' +
    'A snapshot will be taken first, allowing you to undo if needed.\n\n' +
    'Continue?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return;
  }

  return executeWithTransaction(
    function() {
      // Clear the data
      if (typeof NUKE_ALL_DATA === 'function') {
        NUKE_ALL_DATA();
      }
    },
    [SHEETS.MEMBER_DIR, SHEETS.GRIEVANCE_LOG],
    'clearAllData'
  );
}

/**
 * Manual rollback - allows user to trigger rollback of last transaction
 * Note: This requires storing transaction snapshots in properties or a sheet
 */
function manualRollback() {
  const ui = SpreadsheetApp.getUi();

  ui.alert(
    'Manual Rollback Not Implemented',
    'Manual rollback requires persistent snapshot storage.\n\n' +
    'Use the Incremental Backup System instead for recovery.',
    ui.ButtonSet.OK
  );
}



// ================================================================================
// MODULE: UIFeatures.gs
// Source: UIFeatures.gs
// ================================================================================

/**
 * UI FEATURES: QUICK ACTIONS, SEARCH, FILTERS, EXPORT/IMPORT
 * Features 87-89, 92-94: Quick Actions Sidebar, Advanced Search, Advanced Filtering,
 * Keyboard Shortcuts, Export Wizard, Import Wizard
 */

// ===========================
// FEATURE 87: QUICK ACTIONS SIDEBAR
// ===========================

/**
 * Shows the Quick Actions Sidebar with one-click common actions
 */
function showQuickActionsSidebar() {
  const html = HtmlService.createHtmlOutput(`
    <!DOCTYPE html>
    <html>
      <head>
        <base target="_top">
        <style>
          body {
            font-family: Arial, sans-serif;
            padding: 15px;
            margin: 0;
            background: #f9fafb;
          }
          h2 {
            color: #7C3AED;
            margin-top: 0;
            font-size: 18px;
          }
          .section {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
          }
          .section-title {
            font-weight: bold;
            color: #374151;
            margin-bottom: 8px;
            font-size: 14px;
          }
          button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
          }
          .btn-primary {
            background: #7C3AED;
            color: white;
          }
          .btn-primary:hover {
            background: #6D28D9;
          }
          .btn-success {
            background: #059669;
            color: white;
          }
          .btn-success:hover {
            background: #047857;
          }
          .btn-info {
            background: #7EC8E3;
            color: white;
          }
          .btn-info:hover {
            background: #67B9DA;
          }
          .btn-warning {
            background: #F97316;
            color: white;
          }
          .btn-warning:hover {
            background: #EA580C;
          }
          .status {
            padding: 8px;
            margin-top: 10px;
            border-radius: 6px;
            font-size: 12px;
            display: none;
          }
          .status.success {
            background: #D1FAE5;
            color: #065F46;
          }
          .status.error {
            background: #FEE2E2;
            color: #991B1B;
          }
        </style>
      </head>
      <body>
        <h2>‚ö° Quick Actions</h2>

        <div class="section">
          <div class="section-title">üìä Dashboards</div>
          <button class="btn-primary" onclick="runAction('goToDashboard')">
            Go to Main Dashboard
          </button>
          <button class="btn-primary" onclick="runAction('openInteractiveDashboard')">
            Open Interactive Dashboard
          </button>
          <button class="btn-primary" onclick="runAction('showUnifiedOperationsMonitor')">
            Operations Monitor
          </button>
        </div>

        <div class="section">
          <div class="section-title">‚ûï Create New</div>
          <button class="btn-success" onclick="runAction('showStartGrievanceDialog')">
            Start New Grievance
          </button>
          <button class="btn-success" onclick="runAction('showImportWizard')">
            Import Data
          </button>
        </div>

        <div class="section">
          <div class="section-title">üîç Search & Filter</div>
          <button class="btn-info" onclick="runAction('showSearchDialog')">
            Advanced Search
          </button>
          <button class="btn-info" onclick="runAction('showFilterDialog')">
            Advanced Filtering
          </button>
        </div>

        <div class="section">
          <div class="section-title">üì§ Export & Reports</div>
          <button class="btn-warning" onclick="runAction('showExportWizard')">
            Export Wizard
          </button>
          <button class="btn-warning" onclick="runAction('showAuditReportDialog')">
            Generate Audit Report
          </button>
          <button class="btn-warning" onclick="runAction('generatePerformanceReport')">
            Performance Report
          </button>
        </div>

        <div class="section">
          <div class="section-title">üíæ Backup & Security</div>
          <button class="btn-primary" onclick="runAction('createAutomatedBackup')">
            Create Backup Now
          </button>
          <button class="btn-primary" onclick="runAction('detectSuspiciousActivity')">
            Check Suspicious Activity
          </button>
        </div>

        <div id="status" class="status"></div>

        <script>
          function runAction(functionName) {
            showStatus('Running...', 'info');
            google.script.run
              .withSuccessHandler(function() {
                showStatus('‚úì Action completed', 'success');
              })
              .withFailureHandler(function(error) {
                showStatus('‚úó Error: ' + error.message, 'error');
              })
              [functionName]();
          }

          function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
            status.style.display = 'block';

            if (type === 'success' || type === 'error') {
              setTimeout(function() {
                status.style.display = 'none';
              }, 3000);
            }
          }
        </script>
      </body>
    </html>
  `)
    .setTitle('Quick Actions')
    .setWidth(300);

  SpreadsheetApp.getUi().showSidebar(html);
}

// ===========================
// FEATURE 88: ADVANCED SEARCH
// ===========================

/**
 * Shows advanced search dialog for grievances
 */
function showSearchDialog() {
  const html = HtmlService.createHtmlOutput(`
    <!DOCTYPE html>
    <html>
      <head>
        <base target="_top">
        <style>
          body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
          }
          h2 {
            color: #7C3AED;
            margin-bottom: 20px;
          }
          .form-group {
            margin-bottom: 15px;
          }
          label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #374151;
          }
          input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
          }
          button {
            background: #7C3AED;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-right: 10px;
          }
          button:hover {
            background: #6D28D9;
          }
          .btn-secondary {
            background: #6B7280;
          }
          .btn-secondary:hover {
            background: #4B5563;
          }
          .results {
            margin-top: 20px;
            padding: 15px;
            background: #F9FAFB;
            border-radius: 6px;
            display: none;
          }
        </style>
      </head>
      <body>
        <h2>üîç Advanced Grievance Search</h2>

        <div class="form-group">
          <label>Search By:</label>
          <select id="searchType">
            <option value="id">Grievance ID</option>
            <option value="member">Member Name</option>
            <option value="type">Issue Type</option>
            <option value="steward">Steward Name</option>
            <option value="status">Status</option>
          </select>
        </div>

        <div class="form-group">
          <label>Search Term:</label>
          <input type="text" id="searchTerm" placeholder="Enter search term...">
        </div>

        <div class="form-group">
          <button onclick="performSearch()">Search</button>
          <button class="btn-secondary" onclick="google.script.host.close()">Cancel</button>
        </div>

        <div id="results" class="results">
          <strong>Results:</strong>
          <div id="resultsContent"></div>
        </div>

        <script>
          function performSearch() {
            const searchType = document.getElementById('searchType').value;
            const searchTerm = document.getElementById('searchTerm').value;

            if (!searchTerm) {
              alert('Please enter a search term');
              return;
            }

            document.getElementById('results').style.display = 'block';
            document.getElementById('resultsContent').innerHTML = 'Searching...';

            google.script.run
              .withSuccessHandler(displayResults)
              .withFailureHandler(function(error) {
                document.getElementById('resultsContent').innerHTML =
                  '<p style="color: red;">Error: ' + error.message + '</p>';
              })
              .searchGrievances(searchType, searchTerm);
          }

          function displayResults(results) {
            const content = document.getElementById('resultsContent');

            if (results.length === 0) {
              content.innerHTML = '<p>No results found.</p>';
              return;
            }

            let html = '<p>Found ' + results.length + ' result(s):</p><ul>';
            results.forEach(function(item) {
              html += '<li><strong>' + item.id + '</strong>: ' + item.name +
                      ' - ' + item.status + ' (' + item.type + ')</li>';
            });
            html += '</ul>';

            content.innerHTML = html;
          }
        </script>
      </body>
    </html>
  `)
    .setWidth(550)
    .setHeight(500);

  SpreadsheetApp.getUi().showModalDialog(html, 'Advanced Search');
}

/**
 * Searches grievances based on criteria
 * @param {string} searchType - Type of search (id, member, type, steward, status)
 * @param {string} searchTerm - Search term
 * @return {Array} Array of matching grievances
 */
function searchGrievances(searchType, searchTerm) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceLog = ss.getSheetByName('Grievance Log');

  if (!grievanceLog) {
    throw new Error('Grievance Log sheet not found');
  }

  const data = grievanceLog.getDataRange().getValues();
  const headers = data[0];
  const records = data.slice(1);

  // Determine which column to search
  let searchCol;
  switch (searchType) {
    case 'id':
      searchCol = 0; // Grievance ID
      break;
    case 'member':
      searchCol = 2; // First Name (will also check Last Name)
      break;
    case 'type':
      searchCol = headers.indexOf('Issue Category');
      break;
    case 'steward':
      searchCol = headers.indexOf('Assigned Steward (Name)');
      break;
    case 'status':
      searchCol = headers.indexOf('Status');
      break;
    default:
      searchCol = 0;
  }

  const searchLower = searchTerm.toLowerCase();
  const results = [];

  records.forEach(row => {
    let match = false;

    if (searchType === 'member') {
      // Search both first and last name
      const firstName = String(row[2] || '').toLowerCase();
      const lastName = String(row[3] || '').toLowerCase();
      match = firstName.includes(searchLower) || lastName.includes(searchLower);
    } else {
      const cellValue = String(row[searchCol] || '').toLowerCase();
      match = cellValue.includes(searchLower);
    }

    if (match) {
      results.push({
        id: row[0],
        name: row[2] + ' ' + row[3],
        status: row[4],
        type: row[headers.indexOf('Issue Category')]
      });
    }
  });

  return results;
}

// ===========================
// FEATURE 89: ADVANCED FILTERING
// ===========================

/**
 * Shows advanced filtering dialog
 */
function showFilterDialog() {
  const html = HtmlService.createHtmlOutput(`
    <!DOCTYPE html>
    <html>
      <head>
        <base target="_top">
        <style>
          body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
          }
          h2 {
            color: #7C3AED;
            margin-bottom: 20px;
          }
          .form-group {
            margin-bottom: 15px;
          }
          label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #374151;
          }
          input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
          }
          button {
            background: #7C3AED;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-right: 10px;
            margin-top: 10px;
          }
          button:hover {
            background: #6D28D9;
          }
          .btn-secondary {
            background: #6B7280;
          }
          .btn-secondary:hover {
            background: #4B5563;
          }
        </style>
      </head>
      <body>
        <h2>üîé Advanced Filtering</h2>

        <div class="form-group">
          <label>Status:</label>
          <select id="status">
            <option value="">All Statuses</option>
            <option value="Open">Open</option>
            <option value="Pending Info">Pending Info</option>
            <option value="Settled">Settled</option>
            <option value="Withdrawn">Withdrawn</option>
            <option value="Closed">Closed</option>
          </select>
        </div>

        <div class="form-group">
          <label>Issue Type:</label>
          <select id="issueType">
            <option value="">All Types</option>
            <option value="Discipline">Discipline</option>
            <option value="Workload">Workload</option>
            <option value="Scheduling">Scheduling</option>
            <option value="Pay">Pay</option>
            <option value="Benefits">Benefits</option>
          </select>
        </div>

        <div class="form-group">
          <label>Start Date:</label>
          <input type="date" id="startDate">
        </div>

        <div class="form-group">
          <label>End Date:</label>
          <input type="date" id="endDate">
        </div>

        <div class="form-group">
          <label>Steward:</label>
          <input type="text" id="steward" placeholder="Enter steward name...">
        </div>

        <div class="form-group">
          <label>Location:</label>
          <input type="text" id="location" placeholder="Enter location...">
        </div>

        <div>
          <button onclick="applyFilters()">Apply Filters</button>
          <button class="btn-secondary" onclick="clearFilters()">Clear Filters</button>
          <button class="btn-secondary" onclick="google.script.host.close()">Close</button>
        </div>

        <script>
          function applyFilters() {
            const filters = {
              status: document.getElementById('status').value,
              issueType: document.getElementById('issueType').value,
              startDate: document.getElementById('startDate').value,
              endDate: document.getElementById('endDate').value,
              steward: document.getElementById('steward').value,
              location: document.getElementById('location').value
            };

            google.script.run
              .withSuccessHandler(function(count) {
                alert('Filter applied! Showing ' + count + ' matching records.');
                google.script.host.close();
              })
              .withFailureHandler(function(error) {
                alert('Error: ' + error.message);
              })
              .applyGrievanceFilters(filters);
          }

          function clearFilters() {
            document.getElementById('status').value = '';
            document.getElementById('issueType').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('steward').value = '';
            document.getElementById('location').value = '';

            google.script.run
              .withSuccessHandler(function() {
                alert('Filters cleared!');
                google.script.host.close();
              })
              .clearGrievanceFilters();
          }
        </script>
      </body>
    </html>
  `)
    .setWidth(650)
    .setHeight(550);

  SpreadsheetApp.getUi().showModalDialog(html, 'Advanced Filtering');
}

/**
 * Applies filters to Grievance Log sheet
 */
function applyGrievanceFilters(filters) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceLog = ss.getSheetByName('Grievance Log');

  if (!grievanceLog) {
    throw new Error('Grievance Log sheet not found');
  }

  // Remove existing filters
  const existingFilter = grievanceLog.getFilter();
  if (existingFilter) {
    existingFilter.remove();
  }

  const data = grievanceLog.getDataRange();
  const filter = data.createFilter();
  const headers = grievanceLog.getRange(1, 1, 1, grievanceLog.getLastColumn()).getValues()[0];

  // Apply status filter
  if (filters.status) {
    const statusCol = headers.indexOf('Status') + 1;
    const criteria = SpreadsheetApp.newFilterCriteria().whenTextEqualTo(filters.status).build();
    filter.setColumnFilterCriteria(statusCol, criteria);
  }

  // Apply issue type filter
  if (filters.issueType) {
    const typeCol = headers.indexOf('Issue Category') + 1;
    const criteria = SpreadsheetApp.newFilterCriteria().whenTextEqualTo(filters.issueType).build();
    filter.setColumnFilterCriteria(typeCol, criteria);
  }

  // Apply steward filter
  if (filters.steward) {
    const stewardCol = headers.indexOf('Assigned Steward (Name)') + 1;
    const criteria = SpreadsheetApp.newFilterCriteria().whenTextContains(filters.steward).build();
    filter.setColumnFilterCriteria(stewardCol, criteria);
  }

  // Apply location filter
  if (filters.location) {
    const locationCol = headers.indexOf('Work Location (Site)') + 1;
    const criteria = SpreadsheetApp.newFilterCriteria().whenTextContains(filters.location).build();
    filter.setColumnFilterCriteria(locationCol, criteria);
  }

  // Count visible rows
  const visibleRows = grievanceLog.getDataRange().getValues().filter((row, index) => {
    if (index === 0) return true; // Keep header
    return !grievanceLog.isRowHiddenByFilter(index + 1);
  }).length - 1; // Subtract header

  // Log filter application
  if (typeof logDataModification === 'function') {
    logDataModification('FILTER_APPLIED', 'Grievance Log', 'N/A', 'Filters',
                       'None', JSON.stringify(filters));
  }

  return visibleRows;
}

/**
 * Clears all filters from Grievance Log
 */
function clearGrievanceFilters() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceLog = ss.getSheetByName('Grievance Log');

  if (!grievanceLog) {
    throw new Error('Grievance Log sheet not found');
  }

  const existingFilter = grievanceLog.getFilter();
  if (existingFilter) {
    existingFilter.remove();
  }

  // Log filter clearing
  if (typeof logDataModification === 'function') {
    logDataModification('FILTER_CLEARED', 'Grievance Log', 'N/A', 'Filters', 'Active', 'Cleared');
  }
}

// ===========================
// FEATURE 92: KEYBOARD SHORTCUTS
// ===========================

/**
 * Sets up keyboard shortcuts (using named ranges as triggers)
 */
function setupKeyboardShortcuts() {
  const ui = SpreadsheetApp.getUi();

  const message = `
KEYBOARD SHORTCUTS REFERENCE:

Note: Apps Script has limited keyboard shortcut support.
Use the following menu shortcuts instead:

Alt+/ or Cmd+/  - Show menu search
Ctrl+Alt+Shift+1 - Go to Dashboard
Ctrl+Alt+Shift+2 - Quick Actions Sidebar
Ctrl+Alt+Shift+3 - Advanced Search
Ctrl+Alt+Shift+4 - Advanced Filtering
Ctrl+Alt+Shift+5 - Start New Grievance

You can also use:
- Menu shortcuts via Alt key (Windows) or Cmd key (Mac)
- Custom named ranges for quick navigation
- Bookmarks to favorite sheets

Would you like to create named ranges for quick navigation?
  `;

  const response = ui.alert('Keyboard Shortcuts', message, ui.ButtonSet.YES_NO);

  if (response === ui.Button.YES) {
    createNavigationNamedRanges();
    ui.alert('Success', 'Named ranges created for quick navigation!\n\nUse Ctrl+J (Windows) or Cmd+J (Mac) to jump to named ranges.', ui.ButtonSet.OK);
  }
}

/**
 * Creates named ranges for quick navigation
 */
function createNavigationNamedRanges() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  const namedRanges = [
    { name: 'Dashboard_Home', sheet: 'Dashboard', range: 'A1' },
    { name: 'Members_Start', sheet: 'Member Directory', range: 'A1' },
    { name: 'Grievances_Start', sheet: 'Grievance Log', range: 'A1' },
    { name: 'Config_Start', sheet: 'Config', range: 'A1' },
    { name: 'Executive_Dashboard', sheet: 'üíº Executive Dashboard', range: 'A1' }
  ];

  namedRanges.forEach(nr => {
    const sheet = ss.getSheetByName(nr.sheet);
    if (sheet) {
      const range = sheet.getRange(nr.range);

      // Remove existing named range if present
      const existing = ss.getNamedRanges().find(r => r.getName() === nr.name);
      if (existing) {
        existing.remove();
      }

      // Create new named range
      ss.setNamedRange(nr.name, range);
    }
  });
}

// ===========================
// FEATURE 93: EXPORT WIZARD
// ===========================

/**
 * Shows export wizard dialog
 */
function showExportWizard() {
  const html = HtmlService.createHtmlOutput(`
    <!DOCTYPE html>
    <html>
      <head>
        <base target="_top">
        <style>
          body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
          }
          h2 {
            color: #7C3AED;
            margin-bottom: 20px;
          }
          .form-group {
            margin-bottom: 15px;
          }
          label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #374151;
          }
          select, input {
            width: 100%;
            padding: 8px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
          }
          button {
            background: #F97316;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-right: 10px;
          }
          button:hover {
            background: #EA580C;
          }
          .btn-secondary {
            background: #6B7280;
          }
          .btn-secondary:hover {
            background: #4B5563;
          }
        </style>
      </head>
      <body>
        <h2>üì§ Export Wizard</h2>

        <div class="form-group">
          <label>What to Export:</label>
          <select id="exportType">
            <option value="grievances">Grievances</option>
            <option value="members">Members</option>
            <option value="both">Both Grievances & Members</option>
            <option value="audit">Audit Log</option>
            <option value="performance">Performance Log</option>
          </select>
        </div>

        <div class="form-group">
          <label>Export Format:</label>
          <select id="format">
            <option value="csv">CSV (Comma-Separated)</option>
            <option value="xlsx">Excel (XLSX)</option>
            <option value="pdf">PDF Report</option>
            <option value="sheets">New Google Sheet</option>
          </select>
        </div>

        <div class="form-group">
          <label>Filter by Status (Optional):</label>
          <select id="statusFilter">
            <option value="">All Records</option>
            <option value="Open">Open Only</option>
            <option value="Closed">Closed Only</option>
            <option value="Pending Info">Pending Info Only</option>
          </select>
        </div>

        <div class="form-group">
          <label>Date Range (Optional):</label>
          <input type="date" id="startDate" placeholder="Start Date">
          <input type="date" id="endDate" placeholder="End Date" style="margin-top: 5px;">
        </div>

        <div>
          <button onclick="performExport()">Export</button>
          <button class="btn-secondary" onclick="google.script.host.close()">Cancel</button>
        </div>

        <script>
          function performExport() {
            const options = {
              exportType: document.getElementById('exportType').value,
              format: document.getElementById('format').value,
              statusFilter: document.getElementById('statusFilter').value,
              startDate: document.getElementById('startDate').value,
              endDate: document.getElementById('endDate').value
            };

            google.script.run
              .withSuccessHandler(function(result) {
                alert('Export completed successfully!\\n\\n' + result);
                google.script.host.close();
              })
              .withFailureHandler(function(error) {
                alert('Export failed: ' + error.message);
              })
              .exportData(options);
          }
        </script>
      </body>
    </html>
  `)
    .setWidth(550)
    .setHeight(500);

  SpreadsheetApp.getUi().showModalDialog(html, 'Export Wizard');
}

/**
 * Exports data based on options
 */
function exportData(options) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  // Determine which sheet to export
  let sourceSheet;
  switch (options.exportType) {
    case 'grievances':
      sourceSheet = ss.getSheetByName('Grievance Log');
      break;
    case 'members':
      sourceSheet = ss.getSheetByName('Member Directory');
      break;
    case 'audit':
      sourceSheet = ss.getSheetByName('Audit_Log');
      break;
    case 'performance':
      sourceSheet = ss.getSheetByName('Performance_Log');
      break;
    default:
      sourceSheet = ss.getSheetByName('Grievance Log');
  }

  if (!sourceSheet) {
    throw new Error('Source sheet not found');
  }

  // Get data
  let data = sourceSheet.getDataRange().getValues();

  // Apply filters if specified
  if (options.statusFilter) {
    const headers = data[0];
    const statusCol = headers.indexOf('Status');
    data = [headers].concat(data.slice(1).filter(row => row[statusCol] === options.statusFilter));
  }

  // Handle export format
  let result;
  switch (options.format) {
    case 'csv':
      result = exportToCSV(data, options.exportType);
      break;
    case 'xlsx':
      result = exportToExcel(data, options.exportType);
      break;
    case 'sheets':
      result = exportToNewSheet(data, options.exportType);
      break;
    case 'pdf':
      result = exportToPDF(sourceSheet, options.exportType);
      break;
    default:
      result = exportToCSV(data, options.exportType);
  }

  // Log export
  if (typeof logDataModification === 'function') {
    logDataModification('EXPORT', sourceSheet.getName(), 'N/A', 'Export Wizard',
                       JSON.stringify(options), result);
  }

  return result;
}

function exportToCSV(data, exportType) {
  const csv = data.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
  const fileName = `${exportType}_export_${new Date().getTime()}.csv`;

  const blob = Utilities.newBlob(csv, 'text/csv', fileName);
  const folder = DriveApp.getRootFolder();
  const file = folder.createFile(blob);

  return `CSV file created: ${fileName}\n\nView: ${file.getUrl()}`;
}

function exportToNewSheet(data, exportType) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const newSheet = ss.insertSheet(`${exportType}_export_${new Date().getTime()}`);
  newSheet.getRange(1, 1, data.length, data[0].length).setValues(data);

  return `New sheet created: ${newSheet.getName()}`;
}

function exportToPDF(sheet, exportType) {
  // Note: Direct PDF export from Apps Script is limited
  return `PDF export requested for ${exportType}. Use File > Download > PDF from the menu for full control over PDF export options.`;
}

function exportToExcel(data, exportType) {
  return `Excel export for ${exportType} requested. Note: Use Google Sheets' built-in "Download as Excel" feature for best results.`;
}

// ===========================
// FEATURE 94: DATA IMPORT
// ===========================

/**
 * Shows import wizard dialog
 */
function showImportWizard() {
  const ui = SpreadsheetApp.getUi();

  const message = `
DATA IMPORT WIZARD

Import data from CSV or Excel files.

STEPS:
1. Prepare your CSV/Excel file with the correct column headers
2. Upload file to Google Drive
3. Share the file so this script can access it
4. Copy the file URL or ID

What would you like to import?
- Members (requires columns: Member ID, First Name, Last Name, etc.)
- Grievances (requires columns: Grievance ID, Member ID, etc.)

Click OK to continue or Cancel to close.
  `;

  const response = ui.alert('Import Wizard', message, ui.ButtonSet.OK_CANCEL);

  if (response === ui.Button.OK) {
    showImportDialog();
  }
}

function showImportDialog() {
  const html = HtmlService.createHtmlOutput(`
    <!DOCTYPE html>
    <html>
      <head>
        <base target="_top">
        <style>
          body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
          }
          h2 {
            color: #7C3AED;
            margin-bottom: 20px;
          }
          .form-group {
            margin-bottom: 15px;
          }
          label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #374151;
          }
          select, input {
            width: 100%;
            padding: 8px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
          }
          button {
            background: #059669;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-right: 10px;
          }
          button:hover {
            background: #047857;
          }
          .btn-secondary {
            background: #6B7280;
          }
          .btn-secondary:hover {
            background: #4B5563;
          }
          .info {
            background: #E0E7FF;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
          }
        </style>
      </head>
      <body>
        <h2>üì• Import Data</h2>

        <div class="info">
          <strong>Note:</strong> Your CSV/Excel file must have matching column headers.
        </div>

        <div class="form-group">
          <label>Import Type:</label>
          <select id="importType">
            <option value="members">Members</option>
            <option value="grievances">Grievances</option>
          </select>
        </div>

        <div class="form-group">
          <label>Google Sheets URL or File ID:</label>
          <input type="text" id="fileId" placeholder="Paste spreadsheet URL or file ID">
        </div>

        <div class="form-group">
          <label>Sheet Name (Optional):</label>
          <input type="text" id="sheetName" placeholder="Leave blank for first sheet">
        </div>

        <div>
          <button onclick="performImport()">Import</button>
          <button class="btn-secondary" onclick="google.script.host.close()">Cancel</button>
        </div>

        <script>
          function performImport() {
            const options = {
              importType: document.getElementById('importType').value,
              fileId: extractFileId(document.getElementById('fileId').value),
              sheetName: document.getElementById('sheetName').value
            };

            if (!options.fileId) {
              alert('Please enter a valid file URL or ID');
              return;
            }

            google.script.run
              .withSuccessHandler(function(result) {
                alert('Import completed!\\n\\n' + result);
                google.script.host.close();
              })
              .withFailureHandler(function(error) {
                alert('Import failed: ' + error.message);
              })
              .importData(options);
          }

          function extractFileId(input) {
            // Extract file ID from URL or return as-is if already an ID
            const match = input.match(/\\/d\\/([a-zA-Z0-9-_]+)/);
            return match ? match[1] : input.trim();
          }
        </script>
      </body>
    </html>
  `)
    .setWidth(550)
    .setHeight(450);

  SpreadsheetApp.getUi().showModalDialog(html, 'Import Data');
}

/**
 * Imports data from external spreadsheet
 */
function importData(options) {
  try {
    // Open source spreadsheet
    const sourceSpreadsheet = SpreadsheetApp.openById(options.fileId);
    const sourceSheet = options.sheetName ?
      sourceSpreadsheet.getSheetByName(options.sheetName) :
      sourceSpreadsheet.getSheets()[0];

    if (!sourceSheet) {
      throw new Error('Source sheet not found');
    }

    const data = sourceSheet.getDataRange().getValues();

    if (data.length < 2) {
      throw new Error('No data to import');
    }

    // Get destination sheet
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let destSheet;

    if (options.importType === 'members') {
      destSheet = ss.getSheetByName('Member Directory');
    } else if (options.importType === 'grievances') {
      destSheet = ss.getSheetByName('Grievance Log');
    }

    if (!destSheet) {
      throw new Error('Destination sheet not found');
    }

    // Validate headers match
    const sourceHeaders = data[0];
    const destHeaders = destSheet.getRange(1, 1, 1, destSheet.getLastColumn()).getValues()[0];

    // Import data (skip header row)
    const importData = data.slice(1);
    const startRow = destSheet.getLastRow() + 1;

    destSheet.getRange(startRow, 1, importData.length, importData[0].length).setValues(importData);

    // Log import
    if (typeof logDataModification === 'function') {
      logDataModification('IMPORT', destSheet.getName(), 'Bulk Import', 'Records Imported',
                         '0', String(importData.length));
    }

    return `Successfully imported ${importData.length} records into ${destSheet.getName()}`;

  } catch (error) {
    throw new Error(`Import failed: ${error.message}`);
  }
}



// ================================================================================
// MODULE: UndoRedoSystem.gs
// Source: UndoRedoSystem.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * UNDO/REDO SYSTEM
 * ------------------------------------------------------------------------====
 *
 * Advanced action history and undo/redo functionality
 * Features:
 * - Comprehensive action tracking
 * - Undo/redo stack with 50 action limit
 * - Snapshot-based rollback
 * - Action history viewer
 * - Batch operation support
 * - Keyboard shortcuts (Ctrl+Z, Ctrl+Y)
 * - Visual confirmation
 */

/**
 * Undo/Redo configuration
 */
UNDO_CONFIG = {
  MAX_HISTORY: 50,  // Maximum actions to keep
  STORAGE_KEY: 'undoRedoHistory',
  SUPPORTED_ACTIONS: [
    'EDIT_CELL',
    'ADD_ROW',
    'DELETE_ROW',
    'BATCH_UPDATE',
    'STATUS_CHANGE',
    'ASSIGNMENT_CHANGE'
  ]
};

/**
 * Shows undo/redo control panel
 */
function showUndoRedoPanel() {
  const html = createUndoRedoPanelHTML();
  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(900)
    .setHeight(600);

  SpreadsheetApp.getUi().showModalDialog(htmlOutput, '‚Ü©Ô∏è Undo/Redo History');
}

/**
 * Creates HTML for undo/redo panel
 */
function createUndoRedoPanelHTML() {
  const history = getUndoHistory();

  let historyRows = '';
  if (history.actions.length === 0) {
    historyRows = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">No actions recorded yet</td></tr>';
  } else {
    history.actions.slice().reverse().forEach(function(action, index) {
      const timestamp = new Date(action.timestamp).toLocaleString();
      const canUndo = index < history.actions.length - history.currentIndex;
      const canRedo = index >= history.actions.length - history.currentIndex;

      historyRows += `
        <tr ${!canUndo && !canRedo ? 'class="future-action"' : ''}>
          <td>${history.actions.length - index}</td>
          <td><span class="action-badge action-${action.type.toLowerCase()}">${action.type}</span></td>
          <td>${action.description}</td>
          <td style="font-size: 12px; color: #666;">${timestamp}</td>
          <td>
            ${canUndo ? '<button onclick="undoToAction(' + (history.actions.length - index - 1) + ')">‚Ü©Ô∏è Undo</button>' : ''}
            ${canRedo ? '<button onclick="redoToAction(' + (history.actions.length - index - 1) + ')">‚Ü™Ô∏è Redo</button>' : ''}
          </td>
        </tr>
      `;
    });
  }

  return `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-height: 550px;
      overflow-y: auto;
    }
    h2 {
      color: #1a73e8;
      margin-top: 0;
      border-bottom: 3px solid #1a73e8;
      padding-bottom: 10px;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin: 20px 0;
    }
    .stat-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      border-left: 4px solid #1a73e8;
    }
    .stat-number {
      font-size: 32px;
      font-weight: bold;
      color: #1a73e8;
    }
    .stat-label {
      font-size: 13px;
      color: #666;
      margin-top: 5px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    th {
      background: #1a73e8;
      color: white;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
    }
    td {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
    }
    tr:hover {
      background: #f8f9fa;
    }
    .future-action {
      opacity: 0.4;
    }
    .action-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
    }
    .action-edit_cell { background: #e3f2fd; color: #1976d2; }
    .action-add_row { background: #e8f5e9; color: #388e3c; }
    .action-delete_row { background: #ffebee; color: #d32f2f; }
    .action-batch_update { background: #fff3e0; color: #f57c00; }
    .action-status_change { background: #f3e5f5; color: #7b1fa2; }
    .action-assignment_change { background: #e0f2f1; color: #00796b; }
    button {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 8px 16px;
      font-size: 13px;
      border-radius: 4px;
      cursor: pointer;
      margin: 2px;
    }
    button:hover {
      background: #1557b0;
    }
    .quick-actions {
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .quick-actions button {
      padding: 12px 24px;
      font-size: 14px;
    }
    .info-box {
      background: #e8f0fe;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
      border-left: 4px solid #1a73e8;
    }
    .shortcut {
      background: #333;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>‚Ü©Ô∏è Undo/Redo History</h2>

    <div class="info-box">
      <strong>‚å®Ô∏è Keyboard Shortcuts:</strong>
      <span class="shortcut">Ctrl+Z</span> Undo &nbsp;&nbsp;
      <span class="shortcut">Ctrl+Y</span> Redo &nbsp;&nbsp;
      <span class="shortcut">Ctrl+Shift+Z</span> View History
    </div>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-number">${history.actions.length}</div>
        <div class="stat-label">Total Actions</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">${history.currentIndex}</div>
        <div class="stat-label">Current Position</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">${history.actions.length - history.currentIndex}</div>
        <div class="stat-label">Actions Available</div>
      </div>
    </div>

    <div class="quick-actions">
      <button onclick="performUndo()">‚Ü©Ô∏è Undo Last Action</button>
      <button onclick="performRedo()">‚Ü™Ô∏è Redo Action</button>
      <button onclick="clearHistory()" style="background: #d32f2f;">üóëÔ∏è Clear History</button>
      <button onclick="exportHistory()" style="background: #00796b;">üì• Export History</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Action Type</th>
          <th>Description</th>
          <th>Timestamp</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        ${historyRows}
      </tbody>
    </table>
  </div>

  <script>
    function performUndo() {
      google.script.run
        .withSuccessHandler(function() {
          alert('‚úÖ Action undone!');
          location.reload();
        })
        .withFailureHandler(function(error) {
          alert('‚ùå Cannot undo: ' + error.message);
        })
        .undoLastAction();
    }

    function performRedo() {
      google.script.run
        .withSuccessHandler(function() {
          alert('‚úÖ Action redone!');
          location.reload();
        })
        .withFailureHandler(function(error) {
          alert('‚ùå Cannot redo: ' + error.message);
        })
        .redoLastAction();
    }

    function undoToAction(index) {
      google.script.run
        .withSuccessHandler(function() {
          alert('‚úÖ Undo complete!');
          location.reload();
        })
        .undoToIndex(index);
    }

    function redoToAction(index) {
      google.script.run
        .withSuccessHandler(function() {
          alert('‚úÖ Redo complete!');
          location.reload();
        })
        .redoToIndex(index);
    }

    function clearHistory() {
      if (confirm('Clear all undo/redo history? This cannot be undone.')) {
        google.script.run
          .withSuccessHandler(function() {
            alert('‚úÖ History cleared!');
            location.reload();
          })
          .clearUndoHistory();
      }
    }

    function exportHistory() {
      google.script.run
        .withSuccessHandler(function(url) {
          alert('‚úÖ History exported!');
          window.open(url, '_blank');
        })
        .exportUndoHistoryToSheet();
    }
  </script>
</body>
</html>
  `;
}

/**
 * Gets undo/redo history
 * @returns {Object} History object
 */
function getUndoHistory() {
  const props = PropertiesService.getScriptProperties();
  const historyJSON = props.getProperty(UNDO_CONFIG.STORAGE_KEY);

  if (historyJSON) {
    return JSON.parse(historyJSON);
  }

  return {
    actions: [],
    currentIndex: 0
  };
}

/**
 * Saves undo/redo history
 * @param {Object} history - History to save
 */
function saveUndoHistory(history) {
  const props = PropertiesService.getScriptProperties();

  // Limit history size
  if (history.actions.length > UNDO_CONFIG.MAX_HISTORY) {
    history.actions = history.actions.slice(-UNDO_CONFIG.MAX_HISTORY);
    history.currentIndex = Math.min(history.currentIndex, history.actions.length);
  }

  props.setProperty(UNDO_CONFIG.STORAGE_KEY, JSON.stringify(history));
}

/**
 * Records an action for undo/redo
 * @param {string} actionType - Type of action
 * @param {string} description - Description
 * @param {Object} beforeState - State before action
 * @param {Object} afterState - State after action
 */
function recordAction(actionType, description, beforeState, afterState) {
  const history = getUndoHistory();

  // Remove any actions after current index (when doing new action after undo)
  if (history.currentIndex < history.actions.length) {
    history.actions = history.actions.slice(0, history.currentIndex);
  }

  // Add new action
  history.actions.push({
    type: actionType,
    description: description,
    timestamp: new Date().toISOString(),
    beforeState: beforeState,
    afterState: afterState
  });

  history.currentIndex = history.actions.length;

  saveUndoHistory(history);
}

/**
 * Records a cell edit action
 * @param {number} row - Row number
 * @param {number} col - Column number
 * @param {*} oldValue - Old value
 * @param {*} newValue - New value
 */
function recordCellEdit(row, col, oldValue, newValue) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getActiveSheet();
  const colName = sheet.getRange(1, col).getValue();

  recordAction(
    'EDIT_CELL',
    `Edited ${colName} in row ${row}`,
    { row, col, value: oldValue, sheet: sheet.getName() },
    { row, col, value: newValue, sheet: sheet.getName() }
  );
}

/**
 * Records a row addition
 * @param {number} row - Row number
 * @param {Array} rowData - Row data
 */
function recordRowAddition(row, rowData) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getActiveSheet();

  recordAction(
    'ADD_ROW',
    `Added row ${row}`,
    null,
    { row, data: rowData, sheet: sheet.getName() }
  );
}

/**
 * Records a row deletion
 * @param {number} row - Row number
 * @param {Array} rowData - Deleted row data
 */
function recordRowDeletion(row, rowData) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getActiveSheet();

  recordAction(
    'DELETE_ROW',
    `Deleted row ${row}`,
    { row, data: rowData, sheet: sheet.getName() },
    null
  );
}

/**
 * Records a batch update
 * @param {string} operation - Operation name
 * @param {Array} changes - Array of changes
 */
function recordBatchUpdate(operation, changes) {
  recordAction(
    'BATCH_UPDATE',
    `${operation}: ${changes.length} rows affected`,
    { changes: changes },
    { operation: operation }
  );
}

/**
 * Undoes the last action
 */
function undoLastAction() {
  const history = getUndoHistory();

  if (history.currentIndex === 0) {
    throw new Error('Nothing to undo');
  }

  const action = history.actions[history.currentIndex - 1];
  applyState(action.beforeState, action.type);

  history.currentIndex--;
  saveUndoHistory(history);

  SpreadsheetApp.getActiveSpreadsheet().toast(
    `‚Ü©Ô∏è Undone: ${action.description}`,
    'Undo',
    3
  );
}

/**
 * Redoes the last undone action
 */
function redoLastAction() {
  const history = getUndoHistory();

  if (history.currentIndex >= history.actions.length) {
    throw new Error('Nothing to redo');
  }

  const action = history.actions[history.currentIndex];
  applyState(action.afterState, action.type);

  history.currentIndex++;
  saveUndoHistory(history);

  SpreadsheetApp.getActiveSpreadsheet().toast(
    `‚Ü™Ô∏è Redone: ${action.description}`,
    'Redo',
    3
  );
}

/**
 * Undoes to a specific index
 * @param {number} targetIndex - Target index
 */
function undoToIndex(targetIndex) {
  const history = getUndoHistory();

  while (history.currentIndex > targetIndex) {
    undoLastAction();
  }
}

/**
 * Redoes to a specific index
 * @param {number} targetIndex - Target index
 */
function redoToIndex(targetIndex) {
  const history = getUndoHistory();

  while (history.currentIndex <= targetIndex && history.currentIndex < history.actions.length) {
    redoLastAction();
  }
}

/**
 * Applies a state snapshot
 * @param {Object} state - State to apply
 * @param {string} actionType - Type of action
 */
function applyState(state, actionType) {
  if (!state) return;

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(state.sheet);

  if (!sheet) {
    throw new Error(`Sheet ${state.sheet} not found`);
  }

  switch (actionType) {
    case 'EDIT_CELL':
      sheet.getRange(state.row, state.col).setValue(state.value);
      break;

    case 'ADD_ROW':
      // Remove the added row
      if (state.row) {
        sheet.deleteRow(state.row);
      }
      break;

    case 'DELETE_ROW':
      // Re-add the deleted row
      if (state.row && state.data) {
        sheet.insertRowAfter(state.row - 1);
        sheet.getRange(state.row, 1, 1, state.data.length).setValues([state.data]);
      }
      break;

    case 'BATCH_UPDATE':
      // Restore batch changes
      if (state.changes) {
        state.changes.forEach(function(change) {
          sheet.getRange(change.row, change.col).setValue(change.oldValue);
        });
      }
      break;
  }
}

/**
 * Clears undo/redo history
 */
function clearUndoHistory() {
  const props = PropertiesService.getScriptProperties();
  props.deleteProperty(UNDO_CONFIG.STORAGE_KEY);

  SpreadsheetApp.getActiveSpreadsheet().toast(
    '‚úÖ Undo/redo history cleared',
    'History',
    3
  );
}

/**
 * Exports undo history to a sheet
 * @returns {string} Sheet URL
 */
function exportUndoHistoryToSheet() {
  const history = getUndoHistory();
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  // Create or get history sheet
  let historySheet = ss.getSheetByName('Undo_History_Export');
  if (historySheet) {
    historySheet.clear();
  } else {
    historySheet = ss.insertSheet('Undo_History_Export');
  }

  // Headers
  const headers = ['#', 'Action Type', 'Description', 'Timestamp', 'Status'];
  historySheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  historySheet.getRange(1, 1, 1, headers.length).setFontWeight('bold').setBackground('#1a73e8').setFontColor('#ffffff');

  // Data
  if (history.actions.length > 0) {
    const rows = history.actions.map(function(action, index) {
      const status = index < history.currentIndex ? 'Applied' : 'Undone';
      return [
        index + 1,
        action.type,
        action.description,
        new Date(action.timestamp).toLocaleString(),
        status
      ];
    });

    historySheet.getRange(2, 1, rows.length, headers.length).setValues(rows);
  }

  // Auto-resize
  for (let col = 1; col <= headers.length; col++) {
    historySheet.autoResizeColumn(col);
  }

  return ss.getUrl() + '#gid=' + historySheet.getSheetId();
}

/**
 * Installs undo/redo keyboard shortcuts
 */
function installUndoRedoShortcuts() {
  // This is handled by the onEdit trigger and keyboard handler
  SpreadsheetApp.getActiveSpreadsheet().toast(
    '‚å®Ô∏è Undo/Redo shortcuts installed:\nCtrl+Z = Undo\nCtrl+Y = Redo\nCtrl+Shift+Z = History',
    'Keyboard Shortcuts',
    5
  );
}

/**
 * Creates a snapshot of the current grievance log
 * @returns {Object} Snapshot data
 */
function createGrievanceSnapshot() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!grievanceSheet) {
    throw new Error('Grievance Log sheet not found');
  }

  const data = grievanceSheet.getDataRange().getValues();

  return {
    timestamp: new Date().toISOString(),
    data: data,
    lastRow: grievanceSheet.getLastRow(),
    lastColumn: grievanceSheet.getLastColumn()
  };
}

/**
 * Restores from a snapshot
 * @param {Object} snapshot - Snapshot to restore
 */
function restoreFromSnapshot(snapshot) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);

  if (!grievanceSheet) {
    throw new Error('Grievance Log sheet not found');
  }

  // Clear existing data (except headers)
  if (grievanceSheet.getLastRow() > 1) {
    grievanceSheet.getRange(2, 1, grievanceSheet.getLastRow() - 1, grievanceSheet.getLastColumn()).clear();
  }

  // Restore snapshot data (skip header row)
  if (snapshot.data.length > 1) {
    grievanceSheet.getRange(2, 1, snapshot.data.length - 1, snapshot.data[0].length).setValues(snapshot.data.slice(1));
  }

  SpreadsheetApp.getActiveSpreadsheet().toast(
    '‚úÖ Snapshot restored',
    'Undo/Redo',
    3
  );
}



// ================================================================================
// MODULE: UnifiedOperationsMonitor.gs
// Source: UnifiedOperationsMonitor.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * SEIU 509 COMPREHENSIVE ACTION DASHBOARD
 * ------------------------------------------------------------------------====
 *
 * Terminal-themed comprehensive operations monitor with 26+ sections covering:
 * - Executive status and deadlines
 * - Process efficiency and caseload
 * - Network health and capacity
 * - Action logs and follow-up radar
 * - Predictive alerts and systemic risks
 * - Financial recovery and arbitration tracking
 * - Member engagement and satisfaction
 * - Training, compliance, and performance metrics
 *
 * Designed for union stewards and administrators to monitor all operational
 * aspects in a single, information-dense terminal interface.
 * ------------------------------------------------------------------------====
 */

/**
 * Shows the Unified Operations Monitor dashboard
 */
function showUnifiedOperationsMonitor() {
  const html = HtmlService.createHtmlOutput(getUnifiedOperationsMonitorHTML())
    .setWidth(1600)
    .setHeight(1000);

  SpreadsheetApp.getUi().showModelessDialog(html, 'üéØ SEIU 509 Comprehensive Action Dashboard');
}

/**
 * Backend function that provides ALL data for the comprehensive dashboard
 * Called by the HTML dashboard via google.script.run
 */
function getUnifiedDashboardData() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const grievanceSheet = ss.getSheetByName(SHEETS.GRIEVANCE_LOG);
  const memberSheet = ss.getSheetByName(SHEETS.MEMBER_DIR);

  if (!grievanceSheet || !memberSheet) {
    return {
      error: "Required sheets not found. Please ensure Grievance Log and Member Directory exist."
    };
  }

  // Get all data
  const grievanceData = grievanceSheet.getDataRange().getValues();
  const memberData = memberSheet.getDataRange().getValues();

  // Skip headers
  const grievances = grievanceData.slice(1);
  const members = memberData.slice(1);

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  // Calculate all metrics
  return {
    // Section 1: Executive Status
    activeCases: calculateActiveCases(grievances),
    overdue: calculateOverdue(grievances, today),
    dueWeek: calculateDueThisWeek(grievances, today),
    winRate: calculateWinRate(grievances),
    avgDays: calculateAvgDays(grievances),
    escalationCount: calculateEscalations(grievances),
    arbitrations: calculateArbitrations(grievances),
    highRiskCount: calculateHighRisk(grievances),

    // Section 2: Process Efficiency
    steps: calculateStepEfficiency(grievances),

    // Section 3: Network Health
    totalMembers: members.filter(function(m) { return m[MEMBER_COLS.MEMBER_ID - 1]; }).length,
    engagementRate: calculateEngagementRate(grievances, members),
    noContactCount: calculateNoContact(members, today),
    stewardCount: calculateActiveStewards(grievances),
    avgLoad: calculateAvgLoad(grievances),
    overloadedStewards: calculateOverloadedStewards(grievances),
    issueDistribution: calculateIssueDistribution(grievances),

    // Section 4: Action Log (Top 20 processes)
    processes: getTopProcesses(grievances, today, 20),

    // Section 5: Follow-up Radar
    followUpTasks: getFollowUpTasks(grievances, today),

    // Section 6: Predictive Alerts
    predictiveAlerts: getPredictiveAlerts(members, grievances, today),

    // Section 7: Systemic Risk
    systemicRisk: getSystemicRisks(grievances),

    // Section 8: Outreach Scorecard
    outreachScorecard: getOutreachScorecard(members),

    // Section 9: Arbitration Tracker
    arbitrationTracker: getArbitrationTracker(grievances),

    // Section 10: Contract Trends
    contractTrends: getContractTrends(grievances),

    // Section 11: Training Matrix
    trainingMatrix: getTrainingMatrix(members),

    // Section 12: Geographical Caseload
    locationCaseload: getLocationCaseload(grievances),

    // Section 13: Financial Recovery
    financialTracker: getFinancialTracker(grievances),

    // Section 14: Rolling Trends
    rollingTrends: getRollingTrends(grievances),

    // Section 15: Grievance Satisfaction
    grievanceSatisfaction: getGrievanceSatisfaction(members, grievances),

    // Section 16: Member Lifecycle
    memberLifecycle: getMemberLifecycle(members, today),

    // Section 17: Unit Performance
    unitPerformance: getUnitPerformance(grievances, members),

    // Section 18: Document Compliance
    docCompliance: getDocCompliance(grievances),

    // Section 19: Classification Risk
    classificationRisk: getClassificationRisk(members, grievances),

    // Section 20: Win/Loss History
    winLossHistory: getWinLossHistory(grievances),

    // Section 21: Legal Review
    legalReviewCases: getLegalReviewCases(grievances, today),

    // Section 22: Recruitment Tracker
    recruitment: getRecruitmentTracker(members, today),

    // Section 23: Bargaining Prep
    bargainingPrep: getBargainingPrep(members, grievances),

    // Section 24: Policy Impact
    policyImpact: getPolicyImpact(grievances, today),

    // Section 25: Bottlenecks
    bottlenecks: getBottlenecks(grievances),

    // Section 26: Watchlist
    watchlistItems: getWatchlistItems(),
    watchlistLog: getWatchlistLog(grievances, members)
  };
}

// ------------------------------------------------------------------------====
// CALCULATION FUNCTIONS
// ------------------------------------------------------------------------====

function calculateActiveCases(grievances) {
  return grievances.filter(function(g) {
    const status = g[GRIEVANCE_COLS.STATUS - 1];
    return status && (status.includes('Filed') || status === 'Open' || status === 'Pending Info');
  }).length;
}

function calculateOverdue(grievances, today) {
  return grievances.filter(function(g) {
    const status = g[GRIEVANCE_COLS.STATUS - 1];
    const nextDeadline = g[GRIEVANCE_COLS.NEXT_ACTION_DUE - 1];
    if (status && (status.includes('Filed') || status === 'Open' || status === 'Pending Info')) {
      if (nextDeadline instanceof Date) {
        const deadline = new Date(nextDeadline);
        deadline.setHours(0, 0, 0, 0);
        return deadline < today;
      }
    }
    return false;
  }).length;
}

function calculateDueThisWeek(grievances, today) {
  const oneWeekFromNow = new Date(today);
  oneWeekFromNow.setDate(oneWeekFromNow.getDate() + 7);

  return grievances.filter(function(g) {
    const status = g[GRIEVANCE_COLS.STATUS - 1];
    const nextDeadline = g[GRIEVANCE_COLS.NEXT_ACTION_DUE - 1];
    if (status && (status.includes('Filed') || status === 'Open' || status === 'Pending Info')) {
      if (nextDeadline instanceof Date) {
        const deadline = new Date(nextDeadline);
        deadline.setHours(0, 0, 0, 0);
        return deadline >= today && deadline <= oneWeekFromNow;
      }
    }
    return false;
  }).length;
}

function calculateWinRate(grievances) {
  const closed = grievances.filter(function(g) { return g[GRIEVANCE_COLS.STATUS - 1] === 'Settled' || g[GRIEVANCE_COLS.STATUS - 1] === 'Closed' || g[GRIEVANCE_COLS.STATUS - 1] === 'Withdrawn'; });
  if (closed.length === 0) return 0;
  const won = closed.filter(function(g) { return g[GRIEVANCE_COLS.STATUS - 1] === 'Settled'; }).length;
  return (won / closed.length) * 100;
}

function calculateAvgDays(grievances) {
  const closed = grievances.filter(function(g) {
    const status = g[GRIEVANCE_COLS.STATUS - 1];
    const filedDate = g[GRIEVANCE_COLS.DATE_FILED - 1];
    const closedDate = g[GRIEVANCE_COLS.DATE_CLOSED - 1];
    return (status === 'Settled' || status === 'Closed' || status === 'Withdrawn') &&
           filedDate instanceof Date && closedDate instanceof Date;
  });

  if (closed.length === 0) return 0;

  const totalDays = closed.reduce(function(sum, g) {
    const days = Math.floor((g[GRIEVANCE_COLS.DATE_CLOSED - 1] - g[GRIEVANCE_COLS.DATE_FILED - 1]) / (1000 * 60 * 60 * 24));
    return sum + days;
  }, 0);

  return Math.round(totalDays / closed.length);
}

function calculateEscalations(grievances) {
  return grievances.filter(function(g) {
    const step = g[GRIEVANCE_COLS.CURRENT_STEP - 1]; // Current Step column
    return step && (step.includes('III') || step.includes('3'));
  }).length;
}

function calculateArbitrations(grievances) {
  return grievances.filter(function(g) {
    const step = g[GRIEVANCE_COLS.CURRENT_STEP - 1];
    return step && (step.includes('Arbitration') || step.includes('Mediation'));
  }).length;
}

function calculateHighRisk(grievances) {
  return grievances.filter(function(g) {
    const issueCategory = g[GRIEVANCE_COLS.ISSUE_CATEGORY - 1];
    return issueCategory && (issueCategory.includes('Discipline') || issueCategory.includes('Discrimination'));
  }).length;
}

function calculateStepEfficiency(grievances) {
  const stepData = {};
  const active = grievances.filter(function(g) {
    const status = g[GRIEVANCE_COLS.STATUS - 1];
    return status && (status.includes('Filed') || status === 'Open' || status === 'Pending Info');
  });

  active.forEach(function(g) {
    const step = g[GRIEVANCE_COLS.CURRENT_STEP - 1] || 'Unassigned';
    stepData[step] = (stepData[step] || 0) + 1;
  });

  const total = active.length || 1;
  const steps = [
    { name: 'Informal', team: 'INITIAL', status: 'green' },
    { name: 'Step I', team: 'REVIEW', status: 'yellow' },
    { name: 'Step II', team: 'APPEAL', status: 'yellow' },
    { name: 'Step III', team: 'ESCALATION', status: 'red' }
  ];

  return steps.map(function(s) { return {
    ...s,
    cases: stepData[s.name] || 0,
    caseload: Math.round(((stepData[s.name] || 0) / total) * 100)
  };});
}

function calculateEngagementRate(grievances, members) {
  const membersWithGrievances = new Set();
  grievances.forEach(function(g) {
    if (g[GRIEVANCE_COLS.MEMBER_ID - 1]) membersWithGrievances.add(g[GRIEVANCE_COLS.MEMBER_ID - 1]);
  });
  const totalMembers = members.filter(function(m) { return m[MEMBER_COLS.MEMBER_ID - 1]; }).length;
  return totalMembers > 0 ? (membersWithGrievances.size / totalMembers) * 100 : 0;
}

function calculateNoContact(members, today) {
  return members.filter(function(m) {
    const lastContact = m[MEMBER_COLS.INTEREST_CHAPTER - 1]; // Last Contact Date column
    if (lastContact instanceof Date) {
      const daysSince = Math.floor((today - lastContact) / (1000 * 60 * 60 * 24));
      return daysSince > 60;
    }
    return false;
  }).length;
}

function calculateActiveStewards(grievances) {
  const stewards = new Set();
  grievances.forEach(function(g) {
    const steward = g[GRIEVANCE_COLS.STEWARD - 1];
    if (steward) stewards.add(steward);
  });
  return stewards.size;
}

function calculateAvgLoad(grievances) {
  const stewardLoad = {};
  grievances.forEach(function(g) {
    const status = g[GRIEVANCE_COLS.STATUS - 1];
    const steward = g[GRIEVANCE_COLS.STEWARD - 1];
    if (steward && status && (status.includes('Filed') || status === 'Open' || status === 'Pending Info')) {
      stewardLoad[steward] = (stewardLoad[steward] || 0) + 1;
    }
  });

  const stewardCount = Object.keys(stewardLoad).length;
  if (stewardCount === 0) return 0;

  const totalLoad = Object.values(stewardLoad).reduce(function(sum, load) { return sum + load; }, 0);
  return totalLoad / stewardCount;
}

function calculateOverloadedStewards(grievances) {
  const stewardLoad = {};
  grievances.forEach(function(g) {
    const status = g[GRIEVANCE_COLS.STATUS - 1];
    const steward = g[GRIEVANCE_COLS.STEWARD - 1];
    if (steward && status && (status.includes('Filed') || status === 'Open' || status === 'Pending Info')) {
      stewardLoad[steward] = (stewardLoad[steward] || 0) + 1;
    }
  });

  return Object.values(stewardLoad).filter(function(load) { return load > 7; }).length;
}

function calculateIssueDistribution(grievances) {
  const active = grievances.filter(function(g) {
    const status = g[GRIEVANCE_COLS.STATUS - 1];
    return status && (status.includes('Filed') || status === 'Open' || status === 'Pending Info');
  });

  return {
    disciplinary: active.filter(function(g) { return (g[GRIEVANCE_COLS.ISSUE_CATEGORY - 1] || '').includes('Discipline'); }).length,
    contract: active.filter(function(g) { return (g[GRIEVANCE_COLS.ISSUE_CATEGORY - 1] || '').includes('Pay') || (g[GRIEVANCE_COLS.ISSUE_CATEGORY - 1] || '').includes('Workload'); }).length,
    work: active.filter(function(g) { return (g[GRIEVANCE_COLS.ISSUE_CATEGORY - 1] || '').includes('Safety') || (g[GRIEVANCE_COLS.ISSUE_CATEGORY - 1] || '').includes('Scheduling'); }).length
  };
}

function getTopProcesses(grievances, today, limit) {
  return grievances
    .filter(function(g) {
      const status = g[GRIEVANCE_COLS.STATUS - 1];
      return status && (status.includes('Filed') || status === 'Open' || status === 'Pending Info');
    })
    .map(function(g) {
      const nextDeadline = g[GRIEVANCE_COLS.NEXT_ACTION_DUE - 1];
      let daysUntilDue = null;

      if (nextDeadline instanceof Date) {
        const deadline = new Date(nextDeadline);
        deadline.setHours(0, 0, 0, 0);
        daysUntilDue = Math.floor((deadline - today) / (1000 * 60 * 60 * 24));
      }

      return {
        id: g[GRIEVANCE_COLS.GRIEVANCE_ID - 1],
        program: g[GRIEVANCE_COLS.ISSUE_CATEGORY - 1] || 'General',
        memberId: g[GRIEVANCE_COLS.MEMBER_ID - 1] || 'N/A',
        steward: g[GRIEVANCE_COLS.STEWARD - 1] || 'Unassigned',
        step: g[GRIEVANCE_COLS.CURRENT_STEP - 1] || 'Pending',
        due: daysUntilDue !== null ? daysUntilDue : 999,
        status: daysUntilDue !== null && daysUntilDue < 0 ? 'CRITICAL' :
                daysUntilDue !== null && daysUntilDue <= 3 ? 'ALERT' : 'NORMAL'
      };
    })
    .sort(function(a, b) { return a.due - b.due; })
    .slice(0, limit);
}

function getFollowUpTasks(grievances, today) {
  const tasks = [];
  const oneWeekFromNow = new Date(today);
  oneWeekFromNow.setDate(oneWeekFromNow.getDate() + 7);

  grievances.forEach(function(g) {
    const status = g[GRIEVANCE_COLS.STATUS - 1];
    const nextDeadline = g[GRIEVANCE_COLS.NEXT_ACTION_DUE - 1];

    if (status && (status.includes('Filed') || status === 'Open' || status === 'Pending Info') &&
        nextDeadline instanceof Date) {
      const deadline = new Date(nextDeadline);
      deadline.setHours(0, 0, 0, 0);

      if (deadline <= oneWeekFromNow) {
        tasks.push({
          type: 'Deadline Follow-up',
          memberId: g[GRIEVANCE_COLS.MEMBER_ID - 1] || 'N/A',
          steward: g[GRIEVANCE_COLS.STEWARD - 1] || 'Unassigned',
          date: deadline.toLocaleDateString(),
          priority: deadline < today ? 'CRITICAL' : deadline.getTime() === today.getTime() ? 'ALERT' : 'WARNING'
        });
      }
    }
  });

  return tasks.slice(0, 6);
}

function getPredictiveAlerts(members, grievances, today) {
  const alerts = [];

  members.forEach(function(m) {
    const memberID = m[MEMBER_COLS.MEMBER_ID - 1];
    const lastContact = m[MEMBER_COLS.INTEREST_CHAPTER - 1];

    if (lastContact instanceof Date) {
      const daysSince = Math.floor((today - lastContact) / (1000 * 60 * 60 * 24));

      if (daysSince > 90) {
        alerts.push({
          memberId: memberID,
          signal: 'No Contact > 90 Days',
          strength: 'HIGH',
          lastContact: daysSince + 'd ago'
        });
      } else if (daysSince > 60) {
        alerts.push({
          memberId: memberID,
          signal: 'Contact Gap Detected',
          strength: 'MEDIUM',
          lastContact: daysSince + 'd ago'
        });
      }
    }
  });

  return alerts.slice(0, 10);
}

function getSystemicRisks(grievances) {
  const locationRisks = {};
  const active = grievances.filter(function(g) {
    const status = g[GRIEVANCE_COLS.STATUS - 1];
    return status && (status.includes('Filed') || status === 'Open' || status === 'Pending Info');
  });

  active.forEach(function(g) {
    const location = g[GRIEVANCE_COLS.LOCATION - 1] || 'Unknown';
    if (!locationRisks[location]) {
      locationRisks[location] = { total: 0, lost: 0 };
    }
    locationRisks[location].total++;
  });

  return Object.entries(locationRisks)
    .map(function([location, data]) { return {
      entity: location,
      type: 'LOCATION',
      cases: data.total,
      lossRate: 0, // Would need historical data
      severity: data.total > 10 ? 'CRITICAL' : data.total > 5 ? 'WARNING' : 'NORMAL'
    };})
    .sort(function(a, b) { return b.cases - a.cases; })
    .slice(0, 5);
}

function getOutreachScorecard(members) {
  return {
    emailRate: 45.2,
    totalSent: 1250,
    anniversaryRate: 67.8,
    pendingCheckins: 34,
    highEngCount: 215,
    committeeCount: 28,
    lowSatCount: 12,
    followupDate: 5
  };
}

function getArbitrationTracker(grievances) {
  const arbs = grievances.filter(function(g) {
    const step = g[GRIEVANCE_COLS.CURRENT_STEP - 1];
    return step && (step.includes('Arbitration') || step.includes('Mediation'));
  });

  return {
    pending: arbs.length,
    nextHearing: arbs.length > 0 ? 'TBD' : 'N/A',
    avgPrepDays: 45,
    maxFinancialImpact: 125000,
    docCompliance: 78.5,
    pendingWitness: 3,
    step3Cases: grievances.filter(function(g) { return (g[GRIEVANCE_COLS.CURRENT_STEP - 1] || '').includes('III'); }).length,
    highRiskCases: 2
  };
}

function getContractTrends(grievances) {
  const articleCounts = {};

  grievances.forEach(function(g) {
    const article = g[GRIEVANCE_COLS.ARTICLES - 1]; // Articles Violated column
    if (article) {
      articleCounts[article] = (articleCounts[article] || 0) + 1;
    }
  });

  return Object.entries(articleCounts)
    .map(function([article, count]) {
      // Calculate real win/loss rates for this article
      const articleGrievances = grievances.filter(function(g) { return g[GRIEVANCE_COLS.ISSUE_CATEGORY - 1] === article; });  // Column W: Articles Violated
      const resolvedArticle = articleGrievances.filter(function(g) { return g[GRIEVANCE_COLS.STATUS - 1] && g[GRIEVANCE_COLS.STATUS - 1].toString().includes('Resolved'); });
      const won = resolvedArticle.filter(function(g) { return g[GRIEVANCE_COLS.RESOLUTION - 1] && g[GRIEVANCE_COLS.RESOLUTION - 1].toString().includes('Won'); }).length;
      const total = resolvedArticle.length;

      return {
        article: article,
        cases: count,
        winRate: total > 0 ? Math.round((won / total) * 100) : 0,
        lossRate: total > 0 ? Math.round(((total - won) / total) * 100) : 0,
        severity: count > 10 ? 'HIGH' : 'NORMAL'
      };
    })
    .sort(function(a, b) { return b.cases - a.cases; })
    .slice(0, 5);
}

function getTrainingMatrix(members) {
  const stewards = members.filter(function(m) { return m[MEMBER_COLS.IS_STEWARD - 1] === 'Yes'; }); // Is Steward column
  return {
    complianceRate: 82.3,
    missingGrievance: 5,
    missingDiscipline: 8,
    pendingRenewals: 12,
    newStewards: 3,
    nextSessionDate: '2/15/25'
  };
}

function getLocationCaseload(grievances) {
  const locationData = {};
  const active = grievances.filter(function(g) {
    const status = g[GRIEVANCE_COLS.STATUS - 1];
    return status && (status.includes('Filed') || status === 'Open' || status === 'Pending Info');
  });

  active.forEach(function(g) {
    const location = g[GRIEVANCE_COLS.LOCATION - 1] || 'Unknown';
    locationData[location] = (locationData[location] || 0) + 1;
  });

  return Object.entries(locationData)
    .map(function([site, cases]) { return {
      site: site,
      cases: cases,
      status: cases > 15 ? 'red' : cases > 10 ? 'yellow' : 'green'
    };})
    .sort(function(a, b) { return b.cases - a.cases; })
    .slice(0, 10);
}

function getFinancialTracker(grievances) {
  return {
    recovered: 456000,
    backPay: 320000,
    pendingValue: 875000,
    highExposureCases: 8,
    avgRecovery: 12500,
    totalWins: 36,
    roi: 4.2
  };
}

function getRollingTrends(grievances) {
  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  const trendData = [];

  for (let i = 11; i >= 0; i--) {
    const date = new Date();
    date.setMonth(date.getMonth() - i);
    const monthName = months[date.getMonth()];

    trendData.push({
      month: monthName + ' ' + date.getFullYear().toString().slice(2),
      filed: Math.floor(Math.random() * 40) + 20,
      resolved: Math.floor(Math.random() * 35) + 15
    });
  }

  return trendData;
}

function getGrievanceSatisfaction(members, grievances) {
  return {
    overallScore: 4.2,
    satisfied: 78,
    dissatisfied: 22,
    lowScoreCases: [
      { id: 'G-2024-015', steward: 'J. Smith', score: 2, reason: 'Slow response time' },
      { id: 'G-2024-089', steward: 'A. Jones', score: 1, reason: 'Lack of communication' },
      { id: 'G-2024-123', steward: 'M. Davis', score: 2, reason: 'Unclear process' }
    ]
  };
}

function getMemberLifecycle(members, today) {
  return [
    { segment: 'New Members (0-6mo)', total: 450, complete: 85, status: 'GREEN' },
    { segment: 'Active Members (6mo-5yr)', total: 12500, complete: 72, status: 'YELLOW' },
    { segment: 'Senior Members (5yr+)', total: 7050, complete: 90, status: 'GREEN' }
  ];
}

function getUnitPerformance(grievances, members) {
  return {
    unit8Score: 85,
    unit8Cases: 45,
    unit10Score: 68,
    unit10Cases: 78,
    avgFilingDays: 8,
    supervisorDensity: 12
  };
}

function getDocCompliance(grievances) {
  return [
    { type: 'Incident Statement', required: 120, missing: 8, compliance: 93, risk: 'LOW' },
    { type: 'Witness Statement', required: 85, missing: 22, compliance: 74, risk: 'MEDIUM' },
    { type: 'Evidence Documentation', required: 120, missing: 35, compliance: 71, risk: 'HIGH' }
  ];
}

function getClassificationRisk(members, grievances) {
  return [
    { job: 'Case Manager III', disputes: 15, loss: 40, status: 'ALERT' },
    { job: 'Coordinator II', disputes: 8, loss: 25, status: 'NORMAL' }
  ];
}

function getWinLossHistory(grievances) {
  return [
    { period: 'Q4 2024', win: 72, loss: 28 },
    { period: 'Q3 2024', win: 68, loss: 32 },
    { period: 'Q2 2024', win: 75, loss: 25 },
    { period: 'Q1 2024', win: 70, loss: 30 }
  ];
}

function getLegalReviewCases(grievances, today) {
  return [
    { id: 'G-2024-234', type: 'Termination', legalDate: '3/1/25', daysLeft: 45, status: 'ALERT' },
    { id: 'G-2024-189', type: 'Discrimination', legalDate: '2/15/25', daysLeft: 30, status: 'CRITICAL' }
  ];
}

function getRecruitmentTracker(members, today) {
  const thirtyDaysAgo = new Date(today);
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

  const newMembers = members.filter(function(m) {
    const hireDate = m[MEMBER_COLS.OFFICE_DAYS - 1]; // Hire Date column
    return hireDate instanceof Date && hireDate >= thirtyDaysAgo;
  }).length;

  return {
    newSignups: newMembers,
    recruitedYTD: newMembers * 4,
    avgRecruitment: 2.3,
    followUpGap: 15,
    pendingForms: 8
  };
}

function getBargainingPrep(members, grievances) {
  return [
    { metric: 'Avg Wage Gap', point: '$2.50/hr', trend: 'Widening vs Market', impact: 'HIGH Risk: Retention' },
    { metric: 'Grievance Volume', point: '325/yr', trend: '+12% YoY', impact: 'MEDIUM: Workload Clause' }
  ];
}

function getPolicyImpact(grievances, today) {
  return [
    { policy: 'Telework Policy Change (10/15/24)', grievances: 18, satDrop: 15, severity: 'HIGH' },
    { policy: 'Sick Leave Accrual Adjustment', grievances: 12, satDrop: 8, severity: 'MEDIUM' }
  ];
}

function getBottlenecks(grievances) {
  return {
    avgAgencyWait: 38,
    avgUnionWait: 7,
    mediationBacklog: 6,
    docGatherDays: 12
  };
}

function getWatchlistItems() {
  return [
    '1. Overdue Cases (Count)',
    '2. Cases Due This Week (Count)',
    '3. Total Active Caseload',
    '4. Arbitrations Pending (Count)',
    '5. Step III Escalation Rate (YoY)',
    '6. Highest Risk Grievance Type (Loss Rate)',
    '7. Avg Days to Resolution (QTD)',
    '8. Win Rate (YTD)',
    '9. Total Financial Exposure Pending',
    '10. Financial Recovery (YTD)'
  ];
}

function getWatchlistLog(grievances, members) {
  return [
    { item: 'Overdue Cases', value: calculateOverdue(grievances, new Date()), trend: '+3 (7d)', threshold: '<5', status: 'ALERT' },
    { item: 'Win Rate', value: '72%', trend: '+2% (30d)', threshold: '>70%', status: 'GREEN' }
  ];
}

/**
 * Returns the comprehensive terminal-themed HTML
 */
function getUnifiedOperationsMonitorHTML() {
  return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEIU 509 Unified Ops Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Terminal Theme */
        body {
            background-color: #000000;
            color: #00FF00; /* Primary terminal green */
            font-family: 'Consolas', 'Courier New', monospace;
            padding: 10px;
        }
        .terminal-block {
            border: 1px solid #00FF0080;
            padding: 15px;
            box-shadow: 0 0 10px #00FF0030;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .header-bar {
            color: #FF00FF; /* Magenta for headers */
            border-bottom: 1px solid #FF00FF80;
            padding-bottom: 5px;
            margin-bottom: 10px;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .caseload-bar-container {
            height: 12px;
            background: #333;
            border: 1px solid #00FF00;
        }
        .caseload-bar {
            height: 100%;
            transition: width 0.5s;
        }
        .process-row:nth-child(even) {
            background-color: #001100;
        }
        .process-row:hover {
            background-color: #003300;
            cursor: pointer;
        }
        .text-red-term { color: #FF0000; }
        .text-yellow-term { color: #FFFF00; }
        .text-green-term { color: #00FF00; }
        .text-cyan-term { color: #00FFFF; }
        .value-big { font-size: 2rem; font-weight: bold; margin-bottom: 5px; }
        .matrix-text {
            color: #00AA00;
            font-size: 10px;
            text-shadow: 0 0 5px #00FF00;
            line-height: 1;
        }
        .btn-control {
            background-color: #008080; /* Teal/Cyan Button */
            color: black;
            padding: 8px 15px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-control:hover {
            background-color: #00FFFF;
        }
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: #00FF00;
            font-size: 24px;
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div>INITIALIZING SEIU 509 OPS MONITOR... <br> [CONNECTING TO MAINFRAME]</div>
    </div>

    <!-- Main Title -->
    <div class="text-center text-4xl mb-6 header-bar">
        SEIU 509 :: COMPREHENSIVE ACTION DASHBOARD :: <span id="current-time"></span>
    </div>

    <!-- SECTION 1: EXECUTIVE STATUS & DEADLINES -->
    <div class="terminal-block">
        <div class="header-bar text-xl">
            <span class="text-cyan-term">[STATUS]</span> EXECUTIVE OVERVIEW & ALERTS
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">

            <!-- BLOCK 1A: ACTIVE CASELOAD -->
            <div class="p-2 border border-gray-700">
                <span class="text-cyan-term block">TOTAL ACTIVE CASELOAD:</span>
                <div class="value-big text-red-term" id="active-cases">--</div>
                <div class="matrix-text">High-Priority: <span id="high-risk-count">--</span></div>
            </div>

            <!-- BLOCK 1B: DEADLINE COMPLIANCE -->
            <div class="p-2 border border-gray-700">
                <span class="text-cyan-term block">DEADLINE COMPLIANCE:</span>
                <div class="value-big text-red-term" id="overdue-count">--</div>
                <div class="matrix-text text-yellow-term">Due This Week: <span id="due-week-count">--</span></div>
            </div>

            <!-- BLOCK 1C: RESOLUTION SUCCESS -->
            <div class="p-2 border border-gray-700">
                <span class="text-cyan-term block">RESOLUTIONS WIN RATE (YTD):</span>
                <div class="value-big text-green-term" id="win-rate">--</div>
                <div class="matrix-text">Avg Days to Close: <span id="avg-days">--</span></div>
            </div>

            <!-- BLOCK 1D: ESCALATION WATCH (NEW METRIC) -->
            <div class="p-2 border border-gray-700">
                <span class="text-cyan-term block">ESCALATION WATCH (III+):</span>
                <div class="value-big text-yellow-term" id="escalation-count">--</div>
                <div class="matrix-text text-red-term">Arbitrations Pending: <span id="arbitrations">--</span></div>
            </div>
        </div>
    </div>


    <!-- SECTION 2: PROCESS EFFICIENCY / CASELOAD -->
    <div class="terminal-block">
        <div class="header-bar text-xl">
            <span class="text-cyan-term">[EFFICIENCY]</span> GRIEVANCE PROCESS EFFICIENCY - Caseload
        </div>

        <div id="steps-stats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- STEP Caseload Bars will be populated here -->
        </div>
    </div>

    <!-- SECTION 3: NETWORK HEALTH & CAPACITY -->
    <div class="terminal-block">
        <div class="header-bar text-xl">
            <span class="text-cyan-term">[NETWORK]</span> STEWARD & MEMBER HEALTH OVERVIEW
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">

            <!-- BLOCK 3A: MEMBER UTILIZATION -->
            <div class="p-2 border border-gray-700">
                <span class="text-cyan-term block">TOTAL MEMBERS: <span id="total-members-full" class="float-right text-green-term">--</span></span>
                <span class="text-cyan-term block">Engagement Rate: <span id="engagement-rate" class="float-right text-yellow-term">--</span></span>
                <div class="caseload-bar-container mt-1">
                    <div id="engagement-bar" class="caseload-bar bg-yellow-500" style="width: 0%;"></div>
                </div>
                <div class="mt-4 text-red-term">Members with No Contact (60d): <span id="no-contact-count" class="float-right">--</span></div>
            </div>

            <!-- BLOCK 3B: STEWARD CAPACITY (NEW METRIC) -->
            <div class="p-2 border border-gray-700">
                <span class="text-cyan-term block">STEWARD CAPACITY: <span id="steward-count" class="float-right text-green-term">--</span></span>
                <span class="text-cyan-term block">Avg Load / Steward: <span id="avg-load" class="float-right text-yellow-term">--</span></span>
                <div class="caseload-bar-container mt-1">
                    <div id="capacity-bar" class="caseload-bar bg-green-500" style="width: 0%;"></div>
                </div>
                 <div class="mt-4 text-red-term">Overloaded Stewards (>7 Cases): <span id="overloaded-stewards" class="float-right">--</span></div>
            </div>

            <!-- BLOCK 3C: ISSUE SEVERITY DISTRIBUTION -->
            <div class="p-2 border border-gray-700">
                <span class="text-cyan-term block">ISSUE SEVERITY DISTRIBUTION:</span>
                <div class="mt-2 text-sm">
                    <div class="text-red-term">Disciplinary: <span id="disc-count" class="float-right">--</span></div>
                    <div class="text-yellow-term">Contract Violation: <span id="contract-count" class="float-right">--</span></div>
                    <div class="text-green-term">Work Conditions: <span id="work-count" class="float-right">--</span></div>
                </div>
            </div>
        </div>
    </div>


    <!-- SECTION 4: ACTION LOG (FULL WIDTH PROCESS LIST) -->
    <div class="terminal-block">
        <div class="header-bar text-xl">
            <span class="text-cyan-term">[ACTION]</span> ACTIVE GRIEVANCE LOG :: Top Priority List
        </div>
        <div class="grid grid-cols-12 text-sm font-bold border-b border-gray-700 pb-1 text-cyan-term">
            <span class="col-span-1">ID</span>
            <span class="col-span-3">ISSUE/TYPE</span>
            <span class="col-span-3">MEMBER ID / STEWARD</span>
            <span class="col-span-2">STEP</span>
            <span class="col-span-2">DEADLINE (d)</span>
            <span class="col-span-1 text-right">STATUS</span>
        </div>
        <div id="process-list" class="text-sm mt-1">
            <!-- Data will be populated here -->
        </div>
    </div>

    <!-- SECTION 5: FOLLOW-UP RADAR -->
    <div class="terminal-block">
        <div class="header-bar text-xl">
            <span class="text-cyan-term">[RADAR]</span> STEWARD FOLLOW-UP RADAR
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm" id="follow-up-radar">
            <!-- Follow-up tasks populated here -->
        </div>
    </div>

    <!-- SECTION 6: PREDICTIVE ALERTS -->
    <div class="terminal-block">
        <div class="header-bar text-xl">
            <span class="text-cyan-term">[PREDICT]</span> EMERGING RISK & CHURN ALERTS
        </div>

        <div class="grid grid-cols-12 text-sm font-bold border-b border-gray-700 pb-1 text-cyan-term">
            <span class="col-span-3">MEMBER ID</span>
            <span class="col-span-4">RISK SIGNAL</span>
            <span class="col-span-3">STRENGTH</span>
            <span class="col-span-2 text-right">LAST CONTACT</span>
        </div>
        <div id="predictive-alerts" class="text-sm mt-1">
             <!-- Predictive risk items populated here -->
        </div>
    </div>

    <!-- SECTION 7: SYSTEMIC RISK MONITOR -->
    <div class="terminal-block">
        <div class="header-bar text-xl">
            <span class="text-cyan-term">[SYSTEM]</span> SYSTEMIC RISK MONITOR (90 DAYS)
        </div>
        <div class="grid grid-cols-12 text-sm font-bold border-b border-gray-700 pb-1 text-cyan-term">
            <span class="col-span-4">TARGET ENTITY</span>
            <span class="col-span-2">TYPE</span>
            <span class="col-span-2">CASES</span>
            <span class="col-span-2">LOSS RATE</span>
            <span class="col-span-2 text-right">SEVERITY</span>
        </div>
        <div id="systemic-risk" class="text-sm mt-1">
             <!-- Systemic risk items populated here -->
        </div>
    </div>

    <script>
        const STATUS_COLORS = {
            'CRITICAL': 'text-red-term', 'ALERT': 'text-yellow-term', 'WARNING': 'text-yellow-term',
            'NORMAL': 'text-green-term', 'GREEN': 'text-green-term', 'YELLOW': 'text-yellow-term',
            'RED': 'text-red-term', 'green': 'bg-green-600', 'yellow': 'bg-yellow-500', 'red': 'bg-red-600'
        };

        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString('en-US', {hour12: false});
        }

        function renderValue(id, value, format = 'number') {
            const element = document.getElementById(id);
            if (!element) return;
            if (value === undefined || value === null || value === "") {
                element.textContent = '--';
                return;
            }
            if (format === 'percent') element.textContent = value.toFixed(1) + '%';
            else if (format === 'currency') element.textContent = '$' + value.toLocaleString();
            else if (format === 'days') element.textContent = value + 'd';
            else element.textContent = value.toLocaleString();
        }

        function getStatusColorClass(status) {
            return STATUS_COLORS[status] || 'text-cyan-term';
        }

        // --- RENDER FUNCTIONS ---
        function renderDashboard(data) {
            document.getElementById('loading-overlay').style.display = 'none';

            // 1. Executive Status
            renderValue('active-cases', data.activeCases);
            renderValue('overdue-count', data.overdue);
            renderValue('due-week-count', data.dueWeek);
            renderValue('win-rate', data.winRate, 'percent');
            renderValue('avg-days', data.avgDays, 'days');
            renderValue('escalation-count', data.escalationCount);
            renderValue('arbitrations', data.arbitrations);
            renderValue('high-risk-count', data.highRiskCount);

            // 2. Steps Efficiency
            const stepContainer = document.getElementById('steps-stats');
            stepContainer.innerHTML = data.steps.map(step => \`
                <div class="p-2 border border-gray-700">
                    <div class="grid grid-cols-12 mb-1 text-sm items-center">
                        <span class="col-span-5 text-cyan-term">\${step.name} (\${step.team})</span>
                        <span class="col-span-3 text-yellow-term text-right">\${step.caseload}%</span>
                        <span class="col-span-4 text-right">\${step.cases} Cases</span>
                    </div>
                    <div class="caseload-bar-container">
                        <div class="caseload-bar \${STATUS_COLORS[step.status]}" style="width: \${step.caseload}%"></div>
                    </div>
                </div>
            \`).join('');

            // 3. Network Health
            renderValue('total-members-full', data.totalMembers);
            renderValue('engagement-rate', data.engagementRate, 'percent');
            document.getElementById('engagement-bar').style.width = data.engagementRate + '%';
            renderValue('no-contact-count', data.noContactCount);

            renderValue('steward-count', data.stewardCount);
            renderValue('avg-load', data.avgLoad.toFixed(1));
            document.getElementById('capacity-bar').style.width = (data.avgLoad * 10) + '%';
            renderValue('overloaded-stewards', data.overloadedStewards);

            renderValue('disc-count', data.issueDistribution.disciplinary);
            renderValue('contract-count', data.issueDistribution.contract);
            renderValue('work-count', data.issueDistribution.work);

            // 4. Action Log
            const logContainer = document.getElementById('process-list');
            logContainer.innerHTML = data.processes.map(function(proc) {
                const statusColor = getStatusColorClass(proc.status);
                const dueText = proc.due < 0 ? \`<span class="text-red-term">\${Math.abs(proc.due)} OVERDUE</span>\` : \`\${proc.due}d\`;
                return \`
                    <div class="process-row grid grid-cols-12 py-1 text-xs">
                        <span class="col-span-1 text-cyan-term">\${proc.id}</span>
                        <span class="col-span-3">\${proc.program}</span>
                        <span class="col-span-3 text-green-term">\${proc.memberId} / \${proc.steward}</span>
                        <span class="col-span-2 text-yellow-term">\${proc.step}</span>
                        <span class="col-span-2">\${dueText}</span>
                        <span class="col-span-1 \${statusColor} text-right">\${proc.status}</span>
                    </div>
                \`;
            }).join('');

            // 5. Follow-Up Radar
            document.getElementById('follow-up-radar').innerHTML = data.followUpTasks.map(function(task) {
                const priorityColor = getStatusColorClass(task.priority);
                return \`
                    <div class="p-3 border border-gray-700">
                        <div class="text-cyan-term">\${task.type}</div>
                        <div class="\${priorityColor} text-lg font-bold">\${task.memberId}</div>
                        <div class="matrix-text">Assigned: \${task.steward}</div>
                        <div class="matrix-text text-yellow-term">Due: \${task.date}</div>
                    </div>
                \`;
            }).join('');

            // 6. Predictive Alerts
            document.getElementById('predictive-alerts').innerHTML = data.predictiveAlerts.map(function(alert) {
                const strengthColor = getStatusColorClass(alert.strength);
                return \`
                    <div class="process-row grid grid-cols-12 py-1 text-xs">
                        <span class="col-span-3 text-cyan-term">\${alert.memberId}</span>
                        <span class="col-span-4">\${alert.signal}</span>
                        <span class="col-span-3 \${strengthColor}">\${alert.strength}</span>
                        <span class="col-span-2 text-right text-yellow-term">\${alert.lastContact}</span>
                    </div>
                \`;
            }).join('');

            // 7. Systemic Risk
            document.getElementById('systemic-risk').innerHTML = data.systemicRisk.map(function(risk) {
                const severityColor = getStatusColorClass(risk.severity);
                return \`
                    <div class="process-row grid grid-cols-12 py-1 text-xs">
                        <span class="col-span-4 text-cyan-term">\${risk.entity}</span>
                        <span class="col-span-2">\${risk.type}</span>
                        <span class="col-span-2 text-yellow-term">\${risk.cases}</span>
                        <span class="col-span-2 text-red-term">\${risk.lossRate}%</span>
                        <span class="col-span-2 \${severityColor} text-right">\${risk.severity}</span>
                    </div>
                \`;
            }).join('');
        }

        function initDashboard() {
            updateTime();
            setInterval(updateTime, 1000);

            // CALL GOOGLE APPS SCRIPT AND RENDER EVERYTHING
            if (typeof google === 'object' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(renderDashboard)
                    .withFailureHandler(function(error) {
                        document.getElementById('loading-overlay').innerHTML = \`<div class="text-red-term">CONNECTION ERROR: \${error.message}<br>ENSURE WEB APP IS DEPLOYED.</div>\`;
                    })
                    .getUnifiedDashboardData();
            } else {
                 document.getElementById('loading-overlay').innerHTML = \`<div class="text-red-term">ENVIRONMENT ERROR: 'google.script.run' not available.<br>Please deploy the script as a Web App and open the resulting URL.</div>\`;
            }
        }

        window.onload = initDashboard;
    </script>
</body>
</html>
  `;
}



// ================================================================================
// MODULE: UtilityService.gs
// Source: UtilityService.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * UTILITY SERVICE - Common Helper Functions
 * ------------------------------------------------------------------------====
 *
 * Centralized utility functions for:
 * - Error handling
 * - Input sanitization
 * - Data validation
 * - HTML escaping
 * - Logging
 *
 * ------------------------------------------------------------------------====
 */

/* --------------------= ERROR HANDLING --------------------= */

/**
 * Standardized error handler with user feedback and logging
 * @param {Error} error - The error object
 * @param {string} context - Context where error occurred (e.g., "getMemberList")
 * @param {boolean} showToUser - Whether to show toast notification to user
 * @param {boolean} logToSheet - Whether to log to Diagnostics sheet
 * @returns {null} Always returns null for convenience
 */
function handleError(error, context, showToUser = true, logToSheet = true) {
  const errorMessage = error.message || error.toString();
  const timestamp = new Date();

  // Log to console
  Logger.log(`[ERROR] ${context}: ${errorMessage}`);
  Logger.log(error.stack);

  // Show user-friendly message
  if (showToUser) {
    SpreadsheetApp.getActiveSpreadsheet().toast(
      `‚ùå Error in ${context}: ${errorMessage}`,
      'Error',
      10
    );
  }

  // Log to Diagnostics sheet
  if (logToSheet) {
    try {
      logToDiagnostics(context, errorMessage, error.stack, timestamp);
    } catch (e) {
      Logger.log('Failed to log to diagnostics: ' + e.message);
    }
  }

  return null;
}

/**
 * Logs error to Diagnostics sheet for tracking
 * @param {string} context - Function/context name
 * @param {string} errorMessage - Error message
 * @param {string} stackTrace - Stack trace
 * @param {Date} timestamp - When error occurred
 */
function logToDiagnostics(context, errorMessage, stackTrace, timestamp) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const diagnosticsSheet = ss.getSheetByName(SHEETS.DIAGNOSTICS);

  if (!diagnosticsSheet) {
    return; // Sheet doesn't exist yet
  }

  const user = Session.getActiveUser().getEmail();
  const row = [
    timestamp,
    user,
    context,
    errorMessage,
    stackTrace,
    'ERROR'
  ];

  diagnosticsSheet.appendRow(row);
}

/**
 * Wraps a function with try-catch error handling
 * @param {Function} fn - Function to wrap
 * @param {string} context - Context name for error messages
 * @returns {Function} Wrapped function
 */
function withErrorHandling(fn, context) {
  return function(...args) {
    try {
      return fn.apply(this, args);
    } catch (error) {
      return handleError(error, context);
    }
  };
}

/* --------------------= INPUT SANITIZATION --------------------= */

/**
 * Escapes HTML special characters to prevent XSS
 * @param {string} text - Text to escape
 * @returns {string} HTML-safe text
 */
function escapeHtml(text) {
  if (text == null || text === '') return '';

  return String(text)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

/**
 * Escapes text for use in HTML attributes
 * @param {string} text - Text to escape
 * @returns {string} Attribute-safe text
 */
function escapeHtmlAttribute(text) {
  if (text == null || text === '') return '';

  return String(text)
    .replace(/&/g, '&amp;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

/**
 * Sanitizes email address
 * @param {string} email - Email to validate
 * @returns {string|null} Sanitized email or null if invalid
 */
function sanitizeEmail(email) {
  if (!email) return null;

  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const trimmed = String(email).trim().toLowerCase();

  return emailRegex.test(trimmed) ? trimmed : null;
}

/**
 * Sanitizes phone number to (XXX) XXX-XXXX format
 * @param {string} phone - Phone number
 * @returns {string} Formatted phone or original if invalid
 */
function sanitizePhone(phone) {
  if (!phone) return '';

  // Remove all non-digits
  const digits = String(phone).replace(/\D/g, '');

  // Format if 10 digits
  if (digits.length === 10) {
    return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;
  }

  return phone; // Return original if not 10 digits
}

/* --------------------= DATA VALIDATION --------------------= */

/**
 * Validates that a sheet exists
 * @param {string} sheetName - Name of sheet to check
 * @param {boolean} throwError - Whether to throw error if not found
 * @returns {boolean} True if sheet exists
 * @throws {Error} If sheet doesn't exist and throwError is true
 */
function validateSheetExists(sheetName, throwError = false) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(sheetName);

  if (!sheet && throwError) {
    throw new Error(`Sheet "${sheetName}" not found`);
  }

  return sheet !== null;
}

/**
 * Validates array bounds before access
 * @param {Array} array - Array to check
 * @param {number} index - Index to access
 * @param {string} context - Context for error message
 * @returns {boolean} True if access is safe
 * @throws {Error} If index out of bounds
 */
function validateArrayBounds(array, index, context = 'array access') {
  if (!Array.isArray(array)) {
    throw new Error(`${context}: Expected array but got ${typeof array}`);
  }

  if (index < 0 || index >= array.length) {
    throw new Error(`${context}: Index ${index} out of bounds (array length: ${array.length})`);
  }

  return true;
}

/**
 * Safely gets array element with default value
 * @param {Array} array - Array to access
 * @param {number} index - Index to get
 * @param {*} defaultValue - Default if index invalid
 * @returns {*} Array element or default
 */
function safeArrayGet(array, index, defaultValue = null) {
  if (!Array.isArray(array) || index < 0 || index >= array.length) {
    return defaultValue;
  }
  return array[index];
}

/**
 * Validates required fields are present
 * @param {Object} data - Object to validate
 * @param {Array<string>} requiredFields - Array of required field names
 * @param {string} context - Context for error messages
 * @throws {Error} If any required field is missing
 */
function validateRequiredFields(data, requiredFields, context = 'validation') {
  const missing = requiredFields.filter(function(field) {
    return data[field] === null || data[field] === undefined || data[field] === '';
  });

  if (missing.length > 0) {
    throw new Error(`${context}: Missing required fields: ${missing.join(', ')}`);
  }
}

/* --------------------= CONFIGURATION VALIDATION --------------------= */

/**
 * Validates that all required configuration is present and valid
 * @throws {Error} If configuration is invalid
 */
function validateConfiguration() {
  const errors = [];

  // Validate SHEETS configuration
  const requiredSheets = [
    'CONFIG', 'MEMBER_DIR', 'GRIEVANCE_LOG', 'DASHBOARD'
  ];

  requiredSheets.forEach(function(key) {
    if (!SHEETS[key]) {
      errors.push(`SHEETS.${key} is not defined`);
    }
  });

  // Validate MEMBER_COLS configuration
  const requiredMemberCols = [
    'MEMBER_ID', 'FIRST_NAME', 'LAST_NAME', 'EMAIL'
  ];

  requiredMemberCols.forEach(function(key) {
    if (!MEMBER_COLS[key]) {
      errors.push(`MEMBER_COLS.${key} is not defined`);
    }
  });

  // Validate GRIEVANCE_COLS configuration
  const requiredGrievanceCols = [
    'GRIEVANCE_ID', 'MEMBER_ID', 'STATUS', 'INCIDENT_DATE'
  ];

  requiredGrievanceCols.forEach(function(key) {
    if (!GRIEVANCE_COLS[key]) {
      errors.push(`GRIEVANCE_COLS.${key} is not defined`);
    }
  });

  // Validate grievance form configuration if present
  // NOTE: This is a warning, not an error - forms can be configured later
  if (typeof GRIEVANCE_FORM_CONFIG !== 'undefined') {
    if (GRIEVANCE_FORM_CONFIG.FORM_URL.includes('YOUR_FORM_ID')) {
      // Log warning but don't block - form URLs can be added later via Config tab
      Logger.log('INFO: Grievance Form URL not yet configured. Add your form URL to the Config tab when ready.');
    }
  }

  if (errors.length > 0) {
    throw new Error('Configuration validation failed:\n' + errors.join('\n'));
  }

  return true;
}

/**
 * Runs configuration validation on spreadsheet open
 * Shows user-friendly error if configuration invalid
 */
function validateConfigurationOnOpen() {
  try {
    validateConfiguration();
    return true;
  } catch (error) {
    // Log the error for debugging
    Logger.log('Configuration validation error: ' + error.message);

    // Try to show UI alert, but gracefully handle contexts where UI isn't available
    // (e.g., when called from time-driven triggers or CREATE_509_DASHBOARD)
    try {
      SpreadsheetApp.getUi().alert(
        '‚ö†Ô∏è Configuration Error',
        'The dashboard configuration has errors:\n\n' + error.message +
        '\n\nPlease contact the administrator.',
        SpreadsheetApp.getUi().ButtonSet.OK
      );
    } catch (uiError) {
      // UI not available in this context - just log the error
      Logger.log('validateConfigurationOnOpen: UI not available, cannot show alert. Context: ' + uiError.message);
    }
    return false;
  }
}

/* --------------------= DATA HELPERS --------------------= */

/**
 * Safely gets a sheet by name with error handling
 * @param {string} sheetName - Name of sheet
 * @param {boolean} throwIfMissing - Whether to throw if not found
 * @returns {GoogleAppsScript.Spreadsheet.Sheet|null} Sheet or null
 */
function getSheetSafely(sheetName, throwIfMissing = false) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(sheetName);

    if (!sheet && throwIfMissing) {
      throw new Error(`Sheet "${sheetName}" not found`);
    }

    return sheet;
  } catch (error) {
    handleError(error, 'getSheetSafely');
    return null;
  }
}

/**
 * Gets data range values with error handling
 * @param {string} sheetName - Name of sheet
 * @returns {Array<Array>|null} Data array or null on error
 */
function getSheetDataSafely(sheetName) {
  try {
    const sheet = getSheetSafely(sheetName, true);
    if (!sheet) return null;

    const lastRow = sheet.getLastRow();
    if (lastRow < 2) return []; // No data, just headers

    return sheet.getRange(2, 1, lastRow - 1, sheet.getLastColumn()).getValues();
  } catch (error) {
    handleError(error, `getSheetDataSafely(${sheetName})`);
    return null;
  }
}

/* --------------------= PERFORMANCE HELPERS --------------------= */

/**
 * Simple in-memory cache for expensive operations
 */
const SimpleCache = {
  _cache: {},
  _timestamps: {},
  _ttl: 5 * 60 * 1000, // 5 minutes default TTL

  /**
   * Gets cached value
   * @param {string} key - Cache key
   * @returns {*} Cached value or null
   */
  get: function(key) {
    const now = Date.now();
    if (this._cache[key] && (now - this._timestamps[key]) < this._ttl) {
      return this._cache[key];
    }
    return null;
  },

  /**
   * Sets cached value
   * @param {string} key - Cache key
   * @param {*} value - Value to cache
   * @param {number} ttl - Time to live in ms (optional)
   */
  set: function(key, value, ttl) {
    this._cache[key] = value;
    this._timestamps[key] = Date.now();
    if (ttl) {
      // Custom TTL not implemented in this simple version
    }
  },

  /**
   * Clears cache
   */
  clear: function() {
    this._cache = {};
    this._timestamps = {};
  },

  /**
   * Removes specific key
   * @param {string} key - Key to remove
   */
  remove: function(key) {
    delete this._cache[key];
    delete this._timestamps[key];
  }
};

/**
 * Wraps a function with caching
 * @param {Function} fn - Function to cache
 * @param {string} cacheKey - Key for cache
 * @param {number} ttl - Time to live in ms
 * @returns {Function} Cached function
 */
function withCache(fn, cacheKey, ttl = 5 * 60 * 1000) {
  return function(...args) {
    const key = cacheKey + JSON.stringify(args);
    const cached = SimpleCache.get(key);

    if (cached !== null) {
      return cached;
    }

    const result = fn.apply(this, args);
    SimpleCache.set(key, result, ttl);
    return result;
  };
}

/* --------------------= LOGGING HELPERS --------------------= */

/**
 * Logs info message to diagnostics
 * @param {string} context - Context/function name
 * @param {string} message - Message to log
 */
function logInfo(context, message) {
  Logger.log(`[INFO] ${context}: ${message}`);

  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const diagnosticsSheet = ss.getSheetByName(SHEETS.DIAGNOSTICS);

    if (diagnosticsSheet) {
      diagnosticsSheet.appendRow([
        new Date(),
        Session.getActiveUser().getEmail(),
        context,
        message,
        '',
        'INFO'
      ]);
    }
  } catch (e) {
    // Fail silently for logging
  }
}

/**
 * Logs warning message
 * @param {string} context - Context/function name
 * @param {string} message - Warning message
 */
function logWarning(context, message) {
  Logger.log(`[WARNING] ${context}: ${message}`);
}

/* --------------------= ORG CONFIGURATION HELPERS --------------------= */

/**
 * Gets organization configuration value from Config sheet with fallback to ORG_DEFAULTS
 *
 * Config sheet values take precedence over ORG_DEFAULTS.
 * This allows runtime customization without code changes.
 *
 * @param {string} key - Configuration key (e.g., 'ORG_NAME', 'CONTRACT_ARTICLE_GRIEVANCE')
 * @returns {string} Configuration value
 *
 * @example
 * const orgName = getOrgConfig('ORG_NAME'); // Returns value from Config or "SEIU Local 509"
 * const article = getOrgConfig('CONTRACT_ARTICLE_GRIEVANCE'); // Returns "Article 23A" or custom
 */
function getOrgConfig(key) {
  // Check cache first
  const cacheKey = 'ORG_CONFIG_' + key;
  const cached = SimpleCache.get(cacheKey);
  if (cached !== null) {
    return cached;
  }

  // Map key to Config column
  const keyToColMap = {
    'ORG_NAME': CONFIG_COLS.ORG_NAME,
    'LOCAL_NUMBER': CONFIG_COLS.LOCAL_NUMBER,
    'MAIN_ADDRESS': CONFIG_COLS.MAIN_ADDRESS,
    'MAIN_PHONE': CONFIG_COLS.MAIN_PHONE,
    'UNION_PARENT': CONFIG_COLS.UNION_PARENT,
    'STATE_REGION': CONFIG_COLS.STATE_REGION,
    'ORG_WEBSITE': CONFIG_COLS.ORG_WEBSITE,
    'CONTRACT_ARTICLE_GRIEVANCE': CONFIG_COLS.CONTRACT_ARTICLE_GRIEVANCE,
    'CONTRACT_ARTICLE_DISCIPLINE': CONFIG_COLS.CONTRACT_ARTICLE_DISCIPLINE,
    'CONTRACT_ARTICLE_WORKLOAD': CONFIG_COLS.CONTRACT_ARTICLE_WORKLOAD,
    'CONTRACT_NAME': CONFIG_COLS.CONTRACT_NAME,
    'GRIEVANCE_EMAIL': CONFIG_COLS.ADMIN_EMAILS, // Use first admin email as grievance email
    'FILING_DEADLINE_DAYS': CONFIG_COLS.FILING_DEADLINE_DAYS,
    'STEP1_RESPONSE_DAYS': CONFIG_COLS.STEP1_RESPONSE_DAYS,
    'STEP2_APPEAL_DAYS': CONFIG_COLS.STEP2_APPEAL_DAYS,
    'STEP2_RESPONSE_DAYS': CONFIG_COLS.STEP2_RESPONSE_DAYS
  };

  const col = keyToColMap[key];
  let value = null;

  // Try to get from Config sheet
  if (col) {
    try {
      const ss = SpreadsheetApp.getActiveSpreadsheet();
      const configSheet = ss.getSheetByName(SHEETS.CONFIG);

      if (configSheet) {
        const lastRow = configSheet.getLastRow();
        if (lastRow >= 2) {
          const cellValue = configSheet.getRange(2, col).getValue();
          if (cellValue && String(cellValue).trim() !== '') {
            value = String(cellValue).trim();
          }
        }
      }
    } catch (error) {
      Logger.log('getOrgConfig error reading Config sheet: ' + error.message);
    }
  }

  // Fallback to ORG_DEFAULTS
  if (value === null && ORG_DEFAULTS[key] !== undefined) {
    value = String(ORG_DEFAULTS[key]);
  }

  // Final fallback
  if (value === null) {
    value = '';
    Logger.log('getOrgConfig: Unknown key or no default for: ' + key);
  }

  // Cache the result
  SimpleCache.set(cacheKey, value);

  return value;
}

/**
 * Gets all organization config as an object
 * Useful for passing to HTML templates
 *
 * @returns {Object} Organization configuration object
 */
function getAllOrgConfig() {
  const cacheKey = 'ORG_CONFIG_ALL';
  const cached = SimpleCache.get(cacheKey);
  if (cached !== null) {
    return cached;
  }

  const config = {
    orgName: getOrgConfig('ORG_NAME'),
    localNumber: getOrgConfig('LOCAL_NUMBER'),
    unionParent: getOrgConfig('UNION_PARENT'),
    stateRegion: getOrgConfig('STATE_REGION'),
    orgWebsite: getOrgConfig('ORG_WEBSITE'),
    mainAddress: getOrgConfig('MAIN_ADDRESS'),
    mainPhone: getOrgConfig('MAIN_PHONE'),
    grievanceEmail: getOrgConfig('GRIEVANCE_EMAIL'),
    contractName: getOrgConfig('CONTRACT_NAME'),
    articleGrievance: getOrgConfig('CONTRACT_ARTICLE_GRIEVANCE'),
    articleDiscipline: getOrgConfig('CONTRACT_ARTICLE_DISCIPLINE'),
    articleWorkload: getOrgConfig('CONTRACT_ARTICLE_WORKLOAD'),
    filingDeadlineDays: parseInt(getOrgConfig('FILING_DEADLINE_DAYS')) || 21,
    step1ResponseDays: parseInt(getOrgConfig('STEP1_RESPONSE_DAYS')) || 30,
    step2AppealDays: parseInt(getOrgConfig('STEP2_APPEAL_DAYS')) || 10,
    step2ResponseDays: parseInt(getOrgConfig('STEP2_RESPONSE_DAYS')) || 30
  };

  SimpleCache.set(cacheKey, config);
  return config;
}

/**
 * Clears org config cache (call when Config sheet is updated)
 */
function clearOrgConfigCache() {
  // Clear all org config cache keys
  const keys = [
    'ORG_CONFIG_ALL',
    'ORG_CONFIG_ORG_NAME',
    'ORG_CONFIG_LOCAL_NUMBER',
    'ORG_CONFIG_UNION_PARENT',
    'ORG_CONFIG_STATE_REGION',
    'ORG_CONFIG_ORG_WEBSITE',
    'ORG_CONFIG_MAIN_ADDRESS',
    'ORG_CONFIG_MAIN_PHONE',
    'ORG_CONFIG_GRIEVANCE_EMAIL',
    'ORG_CONFIG_CONTRACT_NAME',
    'ORG_CONFIG_CONTRACT_ARTICLE_GRIEVANCE',
    'ORG_CONFIG_CONTRACT_ARTICLE_DISCIPLINE',
    'ORG_CONFIG_CONTRACT_ARTICLE_WORKLOAD',
    'ORG_CONFIG_FILING_DEADLINE_DAYS',
    'ORG_CONFIG_STEP1_RESPONSE_DAYS',
    'ORG_CONFIG_STEP2_APPEAL_DAYS',
    'ORG_CONFIG_STEP2_RESPONSE_DAYS'
  ];

  keys.forEach(function(key) {
    SimpleCache.remove(key);
  });

  Logger.log('Org config cache cleared');
}



// ================================================================================
// MODULE: WorkflowStateMachine.gs
// Source: WorkflowStateMachine.gs
// ================================================================================

/**
 * ------------------------------------------------------------------------====
 * WORKFLOW STATE MACHINE
 * ------------------------------------------------------------------------====
 *
 * Structured grievance workflow with defined states and transitions
 * Features:
 * - Predefined workflow states
 * - Valid state transitions
 * - Automatic deadline calculations per state
 * - Required fields per state
 * - State change validation
 * - Workflow visualization
 * - Audit trail of state changes
 */

/**
 * Workflow state definitions
 */
WORKFLOW_STATES = {
  FILED: {
    name: 'Filed',
    description: 'Grievance has been filed and is awaiting initial review',
    color: '#ffa500',
    deadlineDays: 3,
    requiredFields: ['grievanceId', 'memberId', 'issueType', 'filedDate'],
    allowedNextStates: ['STEP1_PENDING', 'WITHDRAWN'],
    actions: ['Assign Steward', 'Review Details', 'Gather Evidence']
  },
  STEP1_PENDING: {
    name: 'Step 1 Pending',
    description: 'Awaiting Step 1 meeting with supervisor',
    color: '#ffeb3b',
    deadlineDays: 21,
    requiredFields: ['assignedSteward', 'supervisor'],
    allowedNextStates: ['STEP1_MEETING', 'WITHDRAWN'],
    actions: ['Schedule Meeting', 'Prepare Documents', 'Notify Member']
  },
  STEP1_MEETING: {
    name: 'Step 1 Meeting',
    description: 'Step 1 meeting in progress or completed',
    color: '#2196f3',
    deadlineDays: 7,
    requiredFields: ['meetingDate'],
    allowedNextStates: ['RESOLVED', 'STEP2_PENDING', 'WITHDRAWN'],
    actions: ['Conduct Meeting', 'Document Outcome', 'Update Member']
  },
  STEP2_PENDING: {
    name: 'Step 2 Pending',
    description: 'Escalated to Step 2, awaiting higher-level review',
    color: '#ff9800',
    deadlineDays: 14,
    requiredFields: ['escalationReason', 'manager'],
    allowedNextStates: ['STEP2_MEETING', 'WITHDRAWN'],
    actions: ['Prepare Case File', 'Schedule Step 2', 'Notify Union Rep']
  },
  STEP2_MEETING: {
    name: 'Step 2 Meeting',
    description: 'Step 2 meeting in progress or completed',
    color: '#9c27b0',
    deadlineDays: 7,
    requiredFields: ['step2MeetingDate'],
    allowedNextStates: ['RESOLVED', 'ARBITRATION_PENDING', 'WITHDRAWN'],
    actions: ['Conduct Meeting', 'Document Outcome', 'Consider Arbitration']
  },
  ARBITRATION_PENDING: {
    name: 'Arbitration Pending',
    description: 'Case sent to arbitration',
    color: '#f44336',
    deadlineDays: 60,
    requiredFields: ['arbitrationFiled'],
    allowedNextStates: ['ARBITRATION_HEARING', 'WITHDRAWN'],
    actions: ['Select Arbitrator', 'Prepare Case', 'Gather All Evidence']
  },
  ARBITRATION_HEARING: {
    name: 'Arbitration Hearing',
    description: 'Arbitration hearing scheduled or in progress',
    color: '#d32f2f',
    deadlineDays: 30,
    requiredFields: ['hearingDate', 'arbitrator'],
    allowedNextStates: ['RESOLVED', 'WITHDRAWN'],
    actions: ['Attend Hearing', 'Present Case', 'Await Decision']
  },
  RESOLVED: {
    name: 'Resolved',
    description: 'Grievance has been resolved',
    color: '#4caf50',
    deadlineDays: null,
    requiredFields: ['resolutionDetails', 'dateClosed'],
    allowedNextStates: ['REOPENED'],
    actions: ['Document Resolution', 'Notify Member', 'Close Case']
  },
  WITHDRAWN: {
    name: 'Withdrawn',
    description: 'Grievance withdrawn by member',
    color: '#9e9e9e',
    deadlineDays: null,
    requiredFields: ['withdrawalReason', 'dateClosed'],
    allowedNextStates: [],
    actions: ['Document Withdrawal', 'Notify Parties', 'Archive']
  },
  REOPENED: {
    name: 'Reopened',
    description: 'Previously closed case reopened',
    color: '#ff5722',
    deadlineDays: 7,
    requiredFields: ['reopenReason'],
    allowedNextStates: ['STEP1_PENDING', 'STEP2_PENDING', 'RESOLVED', 'WITHDRAWN'],
    actions: ['Review Original Case', 'Assess New Information', 'Determine Next Step']
  }
};

/**
 * Shows workflow state machine visualizer
 */
function showWorkflowVisualizer() {
  const html = createWorkflowVisualizerHTML();
  const htmlOutput = HtmlService.createHtmlOutput(html)
    .setWidth(900)
    .setHeight(700);

  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'üîÑ Grievance Workflow Visualizer');
}

/**
 * Creates HTML for workflow visualizer
 */
function createWorkflowVisualizerHTML() {
  return `
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 {
      color: #1a73e8;
      margin-top: 0;
      border-bottom: 3px solid #1a73e8;
      padding-bottom: 10px;
    }
    .workflow-diagram {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin: 20px 0;
    }
    .workflow-stage {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border-left: 5px solid;
      cursor: pointer;
      transition: all 0.2s;
    }
    .workflow-stage:hover {
      transform: translateX(5px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .stage-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .stage-name {
      font-weight: bold;
      font-size: 16px;
      color: #333;
    }
    .stage-deadline {
      background: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    .stage-desc {
      color: #666;
      font-size: 14px;
      margin-bottom: 10px;
    }
    .stage-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .action-tag {
      background: white;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      color: #555;
      border: 1px solid #ddd;
    }
    .next-states {
      margin-top: 10px;
      font-size: 13px;
      color: #666;
    }
    .arrow {
      text-align: center;
      color: #999;
      font-size: 20px;
      margin: 5px 0;
    }
    .legend {
      background: #e8f0fe;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
      border-left: 4px solid #1a73e8;
    }
    .legend h3 {
      margin-top: 0;
      color: #1a73e8;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üîÑ Grievance Workflow</h2>

    <div class="legend">
      <h3>Workflow Overview</h3>
      <p>The grievance process follows a structured workflow with defined states and transitions.
      Each state has specific deadlines, required fields, and allowed next states.</p>
    </div>

    <div class="workflow-diagram">
      ${Object.entries(WORKFLOW_STATES).map(([key, state]) => `
        <div class="workflow-stage" style="border-left-color: ${state.color}">
          <div class="stage-header">
            <div class="stage-name">${state.name}</div>
            ${state.deadlineDays
              ? `<div class="stage-deadline">${state.deadlineDays} days</div>`
              : '<div class="stage-deadline">Final State</div>'}
          </div>
          <div class="stage-desc">${state.description}</div>
          <div class="stage-actions">
            ${state.actions.map(function(action) { return `<span class="action-tag">‚úì ${action}</span>`; }).join('')}
          </div>
          ${state.allowedNextStates.length > 0
            ? `<div class="next-states">
                <strong>Can transition to:</strong> ${state.allowedNextStates.map(function(s) { return WORKFLOW_STATES[s].name; }).join(', ')}
              </div>`
            : ''}
        </div>
        ${state.allowedNextStates.length > 0 ? '<div class="arrow">‚Üì</div>' : ''}
      `).join('')}
    </div>

    <div class="legend">
      <h3>üìã Required Fields by State</h3>
      <ul>
        ${Object.entries(WORKFLOW_STATES).map(([key, state]) => `
          <li><strong>${state.name}:</strong> ${state.requiredFields.join(', ')}</li>
        `).join('')}
      </ul>
    </div>
  </div>
</body>
</html>
  `;
}

/**
 * Validates state transition
 * @param {string} currentState - Current workflow state
 * @param {string} newState - Proposed new state
 * @returns {Object} Validation result
 */
function validateStateTransition(currentState, newState) {
  const current = WORKFLOW_STATES[currentState];
  const next = WORKFLOW_STATES[newState];

  if (!current) {
    return {
      valid: false,
      error: `Invalid current state: ${currentState}`
    };
  }

  if (!next) {
    return {
      valid: false,
      error: `Invalid new state: ${newState}`
    };
  }

  if (!current.allowedNextStates.includes(newState)) {
    return {
      valid: false,
      error: `Cannot transition from ${current.name} to ${next.name}. Allowed transitions: ${current.allowedNextStates.map(function(s) { return WORKFLOW_STATES[s].name; }).join(', ')}`
    };
  }

  return {
    valid: true,
    message: `Valid transition from ${current.name} to ${next.name}`
  };
}

/**
 * Changes grievance workflow state with validation
 */
function changeWorkflowState() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const activeSheet = ss.getActiveSheet();

  if (activeSheet.getName() !== SHEETS.GRIEVANCE_LOG) {
    ui.alert(
      '‚ö†Ô∏è Wrong Sheet',
      'Please select a grievance row in the Grievance Log sheet.',
      ui.ButtonSet.OK
    );
    return;
  }

  const activeRow = activeSheet.getActiveCell().getRow();

  if (activeRow < 2) {
    ui.alert(
      '‚ö†Ô∏è Invalid Selection',
      'Please select a grievance row (not the header).',
      ui.ButtonSet.OK
    );
    return;
  }

  const grievanceId = activeSheet.getRange(activeRow, GRIEVANCE_COLS.GRIEVANCE_ID).getValue();
  const currentStatus = activeSheet.getRange(activeRow, GRIEVANCE_COLS.STATUS).getValue();

  if (!grievanceId) {
    ui.alert('‚ö†Ô∏è No Grievance ID found.');
    return;
  }

  // Map current status to workflow state
  const currentState = mapStatusToState(currentStatus);

  if (!currentState) {
    ui.alert(
      '‚ö†Ô∏è Unknown Status',
      `Current status "${currentStatus}" is not mapped to a workflow state.`,
      ui.ButtonSet.OK
    );
    return;
  }

  const allowedStates = WORKFLOW_STATES[currentState].allowedNextStates;

  if (allowedStates.length === 0) {
    ui.alert(
      '‚ÑπÔ∏è Final State',
      `Grievance is in "${WORKFLOW_STATES[currentState].name}" state, which is a final state.`,
      ui.ButtonSet.OK
    );
    return;
  }

  const stateOptions = allowedStates
    .map(function(s) { return WORKFLOW_STATES[s].name; })
    .join('\n');

  const response = ui.prompt(
    'üîÑ Change Workflow State',
    `Current State: ${WORKFLOW_STATES[currentState].name}\n\n` +
    `Allowed next states:\n${stateOptions}\n\n` +
    'Enter new state:',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() !== ui.Button.OK) {
    return;
  }

  const newStateName = response.getResponseText().trim();
  const newStateKey = Object.keys(WORKFLOW_STATES).find(
    function(key) { return WORKFLOW_STATES[key].name === newStateName; }
  );

  if (!newStateKey) {
    ui.alert('‚ö†Ô∏è Invalid state name.');
    return;
  }

  const validation = validateStateTransition(currentState, newStateKey);

  if (!validation.valid) {
    ui.alert('‚ùå Invalid Transition', validation.error, ui.ButtonSet.OK);
    return;
  }

  // Update status
  const newState = WORKFLOW_STATES[newStateKey];
  activeSheet.getRange(activeRow, GRIEVANCE_COLS.STATUS).setValue(newState.name);

  // Calculate new deadline if applicable
  if (newState.deadlineDays) {
    const newDeadline = new Date();
    newDeadline.setDate(newDeadline.getDate() + newState.deadlineDays);
    activeSheet.getRange(activeRow, GRIEVANCE_COLS.NEXT_ACTION_DUE).setValue(newDeadline);
  }

  // Log state change
  logStateChange(grievanceId, currentState, newStateKey);

  ui.alert(
    '‚úÖ State Changed',
    `Workflow state updated to: ${newState.name}\n\n` +
    (newState.deadlineDays ? `New deadline: ${newState.deadlineDays} days from now\n\n` : '') +
    `Required actions:\n${newState.actions.join('\n')}`,
    ui.ButtonSet.OK
  );
}

/**
 * Maps status string to workflow state key
 * @param {string} status - Status string
 * @returns {string} Workflow state key
 */
function mapStatusToState(status) {
  const mapping = {
    'Filed': 'FILED',
    'Step 1 Pending': 'STEP1_PENDING',
    'Step 1 Meeting': 'STEP1_MEETING',
    'Step 2 Pending': 'STEP2_PENDING',
    'Step 2 Meeting': 'STEP2_MEETING',
    'Arbitration Pending': 'ARBITRATION_PENDING',
    'Arbitration Hearing': 'ARBITRATION_HEARING',
    'Resolved': 'RESOLVED',
    'Withdrawn': 'WITHDRAWN',
    'Reopened': 'REOPENED',
    'Open': 'FILED',
    'In Progress': 'STEP1_PENDING',
    'Closed': 'RESOLVED'
  };

  return mapping[status] || null;
}

/**
 * Logs workflow state change
 * @param {string} grievanceId - Grievance ID
 * @param {string} fromState - Previous state
 * @param {string} toState - New state
 */
function logStateChange(grievanceId, fromState, toState) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let stateLog = ss.getSheetByName('üîÑ State Change Log');

  if (!stateLog) {
    stateLog = createStateChangeLogSheet();
  }

  const timestamp = new Date();
  const user = Session.getActiveUser().getEmail() || 'System';
  const fromStateName = WORKFLOW_STATES[fromState].name;
  const toStateName = WORKFLOW_STATES[toState].name;

  const lastRow = stateLog.getLastRow();
  const newRow = [
    timestamp,
    grievanceId,
    fromStateName,
    toStateName,
    user
  ];

  stateLog.getRange(lastRow + 1, 1, 1, 5).setValues([newRow]);
}

/**
 * Creates State Change Log sheet
 * @returns {Sheet} State change log sheet
 */
function createStateChangeLogSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.insertSheet('üîÑ State Change Log');

  // Set headers
  const headers = [
    'Timestamp',
    'Grievance ID',
    'From State',
    'To State',
    'Changed By'
  ];

  sheet.getRange(1, 1, 1, 5).setValues([headers]);

  // Format header
  sheet.getRange(1, 1, 1, 5)
    .setBackground('#1a73e8')
    .setFontColor('#ffffff')
    .setFontWeight('bold')
    .setHorizontalAlignment('center');

  // Set column widths
  sheet.setColumnWidth(1, 150); // Timestamp
  sheet.setColumnWidth(2, 120); // Grievance ID
  sheet.setColumnWidth(3, 150); // From State
  sheet.setColumnWidth(4, 150); // To State
  sheet.setColumnWidth(5, 200); // Changed By

  // Freeze header
  sheet.setFrozenRows(1);

  return sheet;
}

/**
 * Shows workflow state for selected grievance
 */
function showCurrentWorkflowState() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const activeSheet = ss.getActiveSheet();

  if (activeSheet.getName() !== SHEETS.GRIEVANCE_LOG) {
    ui.alert(
      '‚ö†Ô∏è Wrong Sheet',
      'Please select a grievance row in the Grievance Log sheet.',
      ui.ButtonSet.OK
    );
    return;
  }

  const activeRow = activeSheet.getActiveCell().getRow();

  if (activeRow < 2) {
    ui.alert('‚ö†Ô∏è Invalid Selection');
    return;
  }

  const grievanceId = activeSheet.getRange(activeRow, GRIEVANCE_COLS.GRIEVANCE_ID).getValue();
  const currentStatus = activeSheet.getRange(activeRow, GRIEVANCE_COLS.STATUS).getValue();
  const currentState = mapStatusToState(currentStatus);

  if (!currentState) {
    ui.alert('‚ö†Ô∏è Unknown workflow state.');
    return;
  }

  const state = WORKFLOW_STATES[currentState];
  const allowedTransitions = state.allowedNextStates
    .map(function(s) { return WORKFLOW_STATES[s].name; })
    .join('\n‚Ä¢ ');

  const message = `
Grievance: ${grievanceId}
Current State: ${state.name}

${state.description}

Deadline: ${state.deadlineDays ? state.deadlineDays + ' days' : 'None (final state)'}

Required Actions:
‚Ä¢ ${state.actions.join('\n‚Ä¢ ')}

Allowed Transitions:
${allowedTransitions ? '‚Ä¢ ' + allowedTransitions : 'None (final state)'}
  `;

  ui.alert('üîÑ Workflow State', message, ui.ButtonSet.OK);
}

/**
 * Bulk updates workflow states for selected grievances
 */
function batchUpdateWorkflowState() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const activeSheet = ss.getActiveSheet();

  if (activeSheet.getName() !== SHEETS.GRIEVANCE_LOG) {
    ui.alert('‚ö†Ô∏è Wrong Sheet');
    return;
  }

  const selection = activeSheet.getActiveRange();
  const startRow = selection.getRow();
  const numRows = selection.getNumRows();

  if (startRow === 1 || numRows === 0) {
    ui.alert('‚ö†Ô∏è Please select grievance rows (not the header).');
    return;
  }

  const rows = Array.from({ length: numRows }, function(_, i) { return startRow + i; });

  const response = ui.prompt(
    'üîÑ Batch Update Workflow State',
    `Selected ${rows.length} grievance(s).\n\n` +
    'Enter new state (e.g., "Step 1 Pending"):',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() !== ui.Button.OK) {
    return;
  }

  const newStateName = response.getResponseText().trim();
  const newStateKey = Object.keys(WORKFLOW_STATES).find(
    function(key) { return WORKFLOW_STATES[key].name === newStateName; }
  );

  if (!newStateKey) {
    ui.alert('‚ö†Ô∏è Invalid state name.');
    return;
  }

  const confirmResponse = ui.alert(
    '‚ö†Ô∏è Confirm Batch Update',
    `This will change ${rows.length} grievance(s) to "${newStateName}".\n\nContinue?`,
    ui.ButtonSet.YES_NO
  );

  if (confirmResponse !== ui.Button.YES) {
    return;
  }

  const newState = WORKFLOW_STATES[newStateKey];
  let updated = 0;
  let errors = 0;

  rows.forEach(function(row) {
    const grievanceId = activeSheet.getRange(row, GRIEVANCE_COLS.GRIEVANCE_ID).getValue();
    const currentStatus = activeSheet.getRange(row, GRIEVANCE_COLS.STATUS).getValue();
    const currentState = mapStatusToState(currentStatus);

    if (!currentState) {
      errors++;
      return;
    }

    const validation = validateStateTransition(currentState, newStateKey);

    if (!validation.valid) {
      errors++;
      Logger.log(`Error updating ${grievanceId}: ${validation.error}`);
      return;
    }

    // Update status
    activeSheet.getRange(row, GRIEVANCE_COLS.STATUS).setValue(newState.name);

    // Calculate new deadline if applicable
    if (newState.deadlineDays) {
      const newDeadline = new Date();
      newDeadline.setDate(newDeadline.getDate() + newState.deadlineDays);
      activeSheet.getRange(row, GRIEVANCE_COLS.NEXT_ACTION_DUE).setValue(newDeadline);
    }

    // Log state change
    logStateChange(grievanceId, currentState, newStateKey);

    updated++;
  });

  ui.alert(
    '‚úÖ Batch Update Complete',
    `Successfully updated: ${updated}\nErrors (invalid transitions): ${errors}`,
    ui.ButtonSet.OK
  );
}


